audit:
  id: compliance-governance.regulatory-compliance.pci-dss-compliance
  name: PCI-DSS Compliance Audit
  version: 1.0.0
  last_updated: '2025-01-19'
  status: active
  category: compliance-governance
  category_number: 24
  subcategory: regulatory-compliance
  tier: phd
  estimated_duration: 8-16 hours  # median: 12h
  completeness: requires_discovery
  requires_runtime: false
  destructive: false
execution:
  automatable: partial
  severity: critical
  scope: process
  default_profiles:
  - full
  - security
  - production
  blocks_phase: true
  parallelizable: true
description:
  what: |
    Comprehensive audit of Payment Card Industry Data Security Standard (PCI DSS)
    compliance for organizations that store, process, or transmit cardholder data.
    Evaluates all 12 requirements across 6 goals: secure network (1-2), protect
    cardholder data (3-4), vulnerability management (5-6), access control (7-9),
    monitoring and testing (10-11), and information security policy (12). Assesses
    compliance with PCI DSS v4.0.1 mandatory requirements effective March 2025,
    including continuous monitoring, enhanced MFA, payment page security, and
    automated log review requirements.
  why_it_matters: |
    PCI DSS non-compliance carries severe consequences:
    - Fines from $5,000 to $100,000 per month until compliant
    - Increased transaction fees or loss of payment processing ability
    - Liability for fraudulent charges following a breach
    - Breach notification costs and forensic investigation expenses
    - Reputational damage and customer trust loss
    - PCI DSS 4.0.1 now mandatory (March 31, 2025) with 47 new requirements
    - Focus shifted to continuous compliance, not annual checkbox
    - Requirements 6.4.3 and 11.6.1 mandate payment page script monitoring
  when_to_run:
  - Before processing payment cards
  - Annual compliance assessment
  - After Cardholder Data Environment changes
  - Following security incidents
  - Before QSA assessment
  - After adding payment page scripts or third-party integrations
  - When onboarding new payment service providers
prerequisites:
  required_artifacts:
  - type: network_diagram
    description: Network diagram showing CDE segmentation
    location_hints:
    - docs/architecture/network-diagram.md
    - compliance/pci/network-diagram.vsdx
    - infrastructure/network/
  - type: data_flow_diagram
    description: Cardholder data flow documentation
    location_hints:
    - compliance/pci/data-flow.md
    - docs/architecture/payment-flow.md
  - type: asset_inventory
    description: Inventory of all CDE components
    location_hints:
    - compliance/pci/asset-inventory.xlsx
    - infrastructure/inventory/
  optional_artifacts:
  - type: scan_reports
    description: ASV scan and vulnerability assessment reports
    location_hints:
    - security/scans/
    - compliance/pci/scans/
  - type: penetration_test
    description: Recent penetration test reports
    location_hints:
    - security/pentest/
    - compliance/pci/pentest/
  - type: policies
    description: Security policies and procedures
    location_hints:
    - policies/
    - compliance/pci/policies/
  access_requirements:
  - Access to CDE network documentation
  - Access to security configuration
  - Access to payment page code
  - Access to log management system
  - Access to vulnerability scan reports
discovery:
  file_patterns:
  - glob: '**/pci/**/*'
    purpose: PCI-specific compliance documentation
  - glob: '**/payment*.{ts,js,yaml}'
    purpose: Payment processing code
  - glob: '**/checkout*.{ts,tsx,js,jsx}'
    purpose: Checkout and payment page code
  - glob: '**/card*.{ts,js,py}'
    purpose: Card data handling code
  - glob: '**/encryption*.{yaml,tf,json}'
    purpose: Encryption configuration
  code_patterns:
  - pattern: card.?number|pan|credit.?card|cvv|cvc
    type: regex
    scope: source
    purpose: Identify cardholder data handling
  - pattern: payment|checkout|stripe|braintree|adyen
    type: regex
    scope: source
    purpose: Identify payment integrations
  - pattern: encrypt|tokenize|mask
    type: regex
    scope: source
    purpose: Identify data protection mechanisms
  - pattern: script.*src|iframe.*payment
    type: regex
    scope: source
    purpose: Identify third-party payment scripts
  documents_to_review:
  - type: Network Segmentation Documentation
    purpose: Verify CDE isolation
    analysis_checklist:
    - CDE boundaries clearly defined
    - Segmentation controls documented
    - Firewall rules appropriate
    - Connected systems identified
  - type: Payment Page Inventory
    purpose: Verify script management (6.4.3, 11.6.1)
    analysis_checklist:
    - All scripts inventoried
    - Script authorization documented
    - Integrity monitoring in place
    - Change detection configured
  - type: Access Control Matrix
    purpose: Verify access control implementation
    analysis_checklist:
    - Role-based access implemented
    - Least privilege applied
    - MFA for all CDE access
    - Access reviews documented
knowledge_sources:
  specifications:
  - id: pci-dss-4
    name: PCI DSS v4.0.1 Standard
    url: https://www.pcisecuritystandards.org/document_library/
    offline_cache: true
    priority: required
  - id: pci-saq
    name: PCI DSS Self-Assessment Questionnaires
    url: https://www.pcisecuritystandards.org/document_library/
    offline_cache: true
    priority: required
  guides:
  - id: pci-guidance
    name: PCI SSC Guidance Documents
    url: https://www.pcisecuritystandards.org/document_library/
    offline_cache: true
    priority: recommended
  - id: pci-best-practices
    name: PCI DSS Best Practices
    url: https://www.pcisecuritystandards.org/documents/best_practices_securing_ecommerce.pdf
    offline_cache: true
    priority: recommended
  learning_resources:
  - id: pci-training
    title: PCI Professional (PCIP) Training
    type: course
    reference: PCI Security Standards Council
tooling:
  assessment_tools:
  - tool: PCI DSS v4.0.1 Requirements Checklist
    purpose: Evaluate against all 12 requirements
    description: |
      Assess compliance with PCI DSS requirements:
      1. Install and maintain network security controls
      2. Apply secure configurations
      3. Protect stored account data
      4. Protect cardholder data during transmission
      5. Protect systems from malware
      6. Develop and maintain secure systems
      7. Restrict access to cardholder data
      8. Identify users and authenticate access
      9. Restrict physical access
      10. Log and monitor all access
      11. Test security regularly
      12. Maintain information security policy
  scripts:
  - id: payment-script-inventory
    language: bash
    purpose: Inventory payment page scripts (6.4.3)
    source: inline
    code: |
      #!/bin/bash
      echo "=== Payment Page Script Inventory ==="

      # Find all script tags in payment-related files
      echo "Searching for script tags in payment pages..."
      grep -r "<script" --include="*.html" --include="*.tsx" --include="*.jsx" \
        --include="*.ejs" . 2>/dev/null | grep -i "payment\|checkout\|card" | head -30

      # Find external script sources
      echo ""
      echo "External script sources..."
      grep -r -o 'src="[^"]*"' --include="*.html" --include="*.tsx" --include="*.jsx" . 2>/dev/null | \
        grep -v "node_modules" | head -30

      # Find dynamic script loading
      echo ""
      echo "Dynamic script loading..."
      grep -r "createElement.*script\|appendChild.*script" \
        --include="*.ts" --include="*.js" --include="*.tsx" . 2>/dev/null | head -20
    offline_capable: true
  - id: cardholder-data-scan
    language: bash
    purpose: Scan for potential cardholder data storage
    source: inline
    code: |
      #!/bin/bash
      echo "=== Cardholder Data Pattern Scan ==="

      # Search for card number patterns
      echo "Searching for potential card data patterns..."
      patterns=(
        "card.?number"
        "credit.?card"
        "pan"
        "cvv\|cvc\|cvv2"
        "expir.*date"
        "track.?data"
        "magnetic.?stripe"
      )

      for pattern in "${patterns[@]}"; do
        echo ""
        echo "--- Pattern: $pattern ---"
        grep -r -i -l "$pattern" --include="*.ts" --include="*.js" \
          --include="*.py" --include="*.java" --include="*.go" . 2>/dev/null | \
          grep -v "node_modules" | head -10
      done
    offline_capable: true
  - id: encryption-config-check
    language: bash
    purpose: Verify encryption configuration
    source: inline
    code: |
      #!/bin/bash
      echo "=== PCI Encryption Configuration Check ==="

      # Check for TLS configuration
      echo "TLS configuration..."
      grep -r "tls\|ssl\|https" --include="*.yaml" --include="*.tf" \
        --include="*.json" . 2>/dev/null | grep -v "node_modules" | head -20

      # Check for encryption at rest
      echo ""
      echo "Encryption at rest configuration..."
      grep -r -i "encrypt.*rest\|storage.*encrypt\|kms\|key.?management" \
        --include="*.yaml" --include="*.tf" . 2>/dev/null | head -20

      # Check for tokenization
      echo ""
      echo "Tokenization implementation..."
      grep -r -l "tokenize\|vault\|detokenize" \
        --include="*.ts" --include="*.js" --include="*.py" . 2>/dev/null | head -10
    offline_capable: true
signals:
  critical:
  - id: PCI-CRIT-001
    signal: Cardholder data stored without encryption
    evidence_indicators:
    - Card numbers in database without encryption
    - Full track data stored
    - CVV/CVC stored after authorization
    - No tokenization for stored card data
    explanation: |
      Requirement 3 mandates protection of stored account data.
      CVV/CVC and full track data must never be stored post-authorization.
      PANs must be rendered unreadable when stored using encryption,
      truncation, or tokenization.
    remediation: |
      1. Never store CVV/CVC or full track data after authorization
      2. Implement tokenization for recurring payments
      3. Encrypt all stored PANs using strong cryptography
      4. Minimize storage of cardholder data
      5. Implement secure key management
  - id: PCI-CRIT-002
    signal: Cardholder data transmitted unencrypted
    evidence_indicators:
    - HTTP endpoints handling card data
    - TLS version below 1.2
    - Weak cipher suites enabled
    - Certificate issues
    explanation: |
      Requirement 4 requires encryption of cardholder data
      transmitted over open networks. TLS 1.2+ with strong
      cipher suites is mandatory.
    remediation: |
      1. Enforce HTTPS for all card data transmission
      2. Configure TLS 1.2 minimum (prefer TLS 1.3)
      3. Disable weak cipher suites
      4. Implement HSTS
      5. Regular certificate management
  - id: PCI-CRIT-003
    signal: CDE not properly segmented
    evidence_indicators:
    - No network segmentation for CDE
    - All systems in scope due to flat network
    - Firewall rules too permissive
    - Segmentation not tested
    explanation: |
      Requirement 1 requires network security controls isolating
      the CDE. Proper segmentation reduces scope and risk.
      Segmentation must be tested at least annually.
    remediation: |
      1. Define and document CDE boundaries
      2. Implement firewall rules restricting CDE access
      3. Segment CDE from non-CDE networks
      4. Conduct segmentation penetration testing
      5. Review and update firewall rules regularly
  - id: PCI-CRIT-004
    signal: Payment page scripts not inventoried or monitored
    evidence_indicators:
    - No script inventory for payment pages
    - Unknown third-party scripts present
    - No integrity monitoring on payment pages
    - No change detection mechanism
    explanation: |
      Requirements 6.4.3 and 11.6.1 mandate full script inventory,
      authorization workflows, and change/tamper detection for
      payment pages. These are key 4.0 requirements protecting
      against Magecart-style attacks.
    remediation: |
      1. Inventory all scripts on payment pages
      2. Document business justification for each script
      3. Implement Content Security Policy (CSP)
      4. Deploy change detection with at least weekly evaluation
      5. Alert on unauthorized modifications
      6. Subresource Integrity (SRI) for external scripts
  - id: PCI-CRIT-005
    signal: MFA not implemented for CDE access
    evidence_indicators:
    - Single-factor authentication for CDE
    - Remote access without MFA
    - Administrative access without MFA
    explanation: |
      Requirement 8 now mandates MFA for all access to CDE,
      whether onsite or remote. This is a key v4.0 change
      with no exceptions.
    remediation: |
      1. Implement MFA for all CDE access
      2. Include both remote and local access
      3. Ensure MFA for administrative functions
      4. Document MFA mechanisms
      5. Regular MFA effectiveness testing
  high:
  - id: PCI-HIGH-001
    signal: Audit logs inadequate
    evidence_indicators:
    - Access to CDE not logged
    - Log retention less than 12 months
    - Less than 3 months immediately available
    - No automated log review
    explanation: |
      Requirement 10 mandates logging all access to CDE with
      12-month retention (3 months immediately available).
      v4.0 requires automated log review using SIEM or similar.
    remediation: |
      1. Enable audit logging for all CDE components
      2. Configure 12-month retention
      3. Ensure 3 months immediately accessible
      4. Implement automated log review (SIEM)
      5. Configure alerts for anomalous activity
  - id: PCI-HIGH-002
    signal: Vulnerability management inadequate
    evidence_indicators:
    - No quarterly vulnerability scans
    - No ASV scans for external IPs
    - High/critical vulnerabilities unpatched
    - No penetration testing
    explanation: |
      Requirements 5, 6, and 11 mandate vulnerability management
      including quarterly internal scans, ASV external scans,
      and annual penetration testing.
    remediation: |
      1. Conduct quarterly internal vulnerability scans
      2. Engage PCI ASV for external quarterly scans
      3. Remediate high/critical vulnerabilities promptly
      4. Conduct annual penetration testing
      5. Rescan after significant changes
  - id: PCI-HIGH-003
    signal: Security policies not maintained
    evidence_indicators:
    - Information security policy missing
    - Policies not reviewed annually
    - Policies not covering all requirements
    - Security awareness training lacking
    explanation: |
      Requirement 12 mandates information security policy
      addressing all requirements, annual reviews, and
      security awareness training for all personnel.
    remediation: |
      1. Create comprehensive information security policy
      2. Address all PCI DSS requirements in policy
      3. Conduct annual policy review
      4. Implement security awareness training
      5. Document policy acknowledgment
  - id: PCI-HIGH-004
    signal: Access control inadequate
    evidence_indicators:
    - No role-based access control
    - Excessive privileges granted
    - No access reviews conducted
    - Default credentials in use
    explanation: |
      Requirements 7 and 8 mandate restricting access based
      on need-to-know, unique user IDs, and strong authentication.
    remediation: |
      1. Implement role-based access control
      2. Apply least privilege principle
      3. Conduct quarterly access reviews
      4. Eliminate default and shared credentials
      5. Document access control procedures
  medium:
  - id: PCI-MED-001
    signal: Wireless security inadequate
    evidence_indicators:
    - No quarterly wireless scanning
    - Rogue access point detection lacking
    - Wireless connected to CDE without controls
    explanation: |
      Requirement 11.2.1 requires quarterly wireless analyzer
      scans to identify unauthorized access points.
    remediation: |
      1. Implement quarterly wireless scanning
      2. Deploy rogue AP detection
      3. Isolate wireless from CDE
      4. Document authorized wireless devices
  - id: PCI-MED-002
    signal: Anti-malware inadequate
    evidence_indicators:
    - Anti-malware not on all systems
    - Signatures not current
    - No behavioral monitoring
    explanation: |
      Requirement 5 mandates anti-malware on all systems
      commonly affected by malware with current signatures.
    remediation: |
      1. Deploy anti-malware on all CDE systems
      2. Enable automatic signature updates
      3. Configure behavioral monitoring
      4. Maintain anti-malware logs
  - id: PCI-MED-003
    signal: Change management inadequate
    evidence_indicators:
    - No change control process
    - Changes not documented
    - No security impact assessment
    explanation: |
      Requirement 6.5 mandates change control including
      documentation and security impact assessment.
    remediation: |
      1. Implement formal change control process
      2. Document all changes to CDE
      3. Assess security impact before changes
      4. Separate development and production
  low:
  - id: PCI-LOW-001
    signal: Vendor default credentials still present
    evidence_indicators:
    - Default passwords on systems
    - Default SNMP strings
    - Vendor default configurations
    remediation: |
      Change all vendor-supplied defaults before deployment.
  - id: PCI-LOW-002
    signal: Service provider compliance not verified
    evidence_indicators:
    - No PCI compliance evidence from providers
    - Responsibility matrix not documented
    remediation: |
      Obtain AOC or SAQ from all service providers annually.
  positive:
  - id: PCI-POS-001
    signal: Tokenization fully implemented
    evidence_indicators:
    - PANs tokenized, not stored
    - Vault provider PCI compliant
    - Detokenization controlled
  - id: PCI-POS-002
    signal: Continuous compliance monitoring
    evidence_indicators:
    - Real-time security monitoring
    - Automated compliance checks
    - Proactive vulnerability management
  - id: PCI-POS-003
    signal: Payment page security robust
    evidence_indicators:
    - Full script inventory maintained
    - CSP implemented
    - Change detection active
    - SRI for external scripts
procedure:
  context:
    cognitive_mode: critical
    ensemble_role: auditor
  preparation:
  - step: Determine merchant level and applicable SAQ type
  - step: Obtain CDE network and data flow diagrams
  - step: Identify all systems and personnel in scope
  - step: Gather previous assessment reports
  steps:
  - id: '1'
    name: Scope Assessment
    description: |
      Define and validate the scope of the CDE, including
      all systems, networks, and personnel that store, process,
      or transmit cardholder data.
    duration_estimate: 1-2 hours
    questions:
    - What systems store, process, or transmit CHD?
    - Is the CDE properly segmented?
    - What third parties have CDE access?
    - Are all connected systems identified?
    expected_findings:
    - Complete CDE inventory
    - Segmentation status
    - Scope validation
  - id: '2'
    name: Network Security Review
    description: |
      Evaluate network security controls including firewalls,
      segmentation, and secure configurations.
    duration_estimate: 1-2 hours
    commands:
    - purpose: Check firewall configuration
      command: find . -name '*firewall*' -o -name '*security-group*' | head -10
    - purpose: Check network segmentation
      command: grep -r 'segment\|vlan\|subnet' --include='*.tf' --include='*.yaml' . | head -20
    expected_findings:
    - Firewall rule adequacy
    - Segmentation effectiveness
  - id: '3'
    name: Data Protection Assessment
    description: |
      Verify cardholder data protection including encryption
      at rest and in transit, and prohibited data storage.
    duration_estimate: 2-3 hours
    commands:
    - purpose: Scan for card data patterns
      command: grep -r -i 'card.?number\|cvv\|track.?data' --include='*.ts' --include='*.js' . | head
        -30
    - purpose: Check encryption configuration
      command: grep -r 'encrypt\|tls\|kms' --include='*.yaml' --include='*.tf' . | head -30
    expected_findings:
    - Data storage practices
    - Encryption implementation
  - id: '4'
    name: Payment Page Security Review
    description: |
      Assess payment page script inventory, authorization,
      and change detection mechanisms per 6.4.3 and 11.6.1.
    duration_estimate: 1-2 hours
    commands:
    - purpose: Inventory payment page scripts
      command: grep -r '<script' --include='*.html' --include='*.tsx' . | grep -i 'payment\|checkout'
        | head -20
    expected_findings:
    - Script inventory completeness
    - Change detection status
  - id: '5'
    name: Access Control Review
    description: |
      Evaluate access control including authentication,
      authorization, MFA implementation, and access reviews.
    duration_estimate: 1-2 hours
    questions:
    - Is MFA implemented for all CDE access?
    - Are access reviews conducted?
    - Is least privilege applied?
    - Are unique IDs used for all users?
    expected_findings:
    - MFA implementation status
    - Access control maturity
  - id: '6'
    name: Logging and Monitoring Review
    description: |
      Assess audit logging, log retention, automated
      review, and monitoring capabilities.
    duration_estimate: 1-2 hours
    questions:
    - Are all CDE components logged?
    - Is 12-month retention configured?
    - Is automated log review in place?
    - Are security events alerted?
    expected_findings:
    - Logging completeness
    - Monitoring capability
  - id: '7'
    name: Vulnerability Management Review
    description: |
      Evaluate vulnerability scanning, penetration testing,
      and patch management processes.
    duration_estimate: 1-2 hours
    questions:
    - Are quarterly internal scans conducted?
    - Are ASV external scans current?
    - Is annual penetration testing done?
    - Are vulnerabilities remediated timely?
    expected_findings:
    - Scanning coverage
    - Remediation effectiveness
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: compliance_matrix
    format: table
    description: PCI DSS v4.0.1 requirements compliance
    columns:
    - Requirement
    - Description
    - Status
    - Evidence
    - Gap
    - Remediation
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Scope Definition
    - Critical Findings
    - Requirement Compliance Summary
    - v4.0 Specific Requirements Status
    - Prioritized Remediation Plan
    - SAQ/ROC Readiness Assessment
  confidence_guidance:
    high: Configuration verified and evidence collected
    medium: Documentation reviewed, limited verification
    low: Based on interviews or incomplete documentation
offline:
  capability: partial
  cache_manifest:
    knowledge:
    - source_id: pci-dss-4
      priority: required
    - source_id: pci-saq
      priority: required
    - source_id: pci-guidance
      priority: recommended
  degradation:
  - feature: Live payment page script analysis
    impact: Cannot verify runtime script loading
    mitigation: Review CSP configuration and static analysis
profiles:
  membership:
    quick:
      included: false
      reason: Comprehensive assessment required
    security:
      included: true
      priority: 2
    production:
      included: true
      priority: 3
    full:
      included: true
      priority: 1
closeout_checklist:
- id: pci-001
  item: CDE properly defined and segmented
  level: CRITICAL
  verification: manual
  verification_notes: Network diagram shows CDE isolation with firewall rules
  expected: Confirmed by reviewer
- id: pci-002
  item: Cardholder data encrypted at rest and in transit
  level: CRITICAL
  verification: manual
  verification_notes: Encryption verified for all CHD storage and transmission
  expected: Confirmed by reviewer
- id: pci-003
  item: CVV/CVC and track data not stored post-authorization
  level: CRITICAL
  verification: manual
  verification_notes: No prohibited data stored confirmed through code review
  expected: Confirmed by reviewer
- id: pci-004
  item: Payment page scripts inventoried with change detection
  level: CRITICAL
  verification: manual
  verification_notes: Requirements 6.4.3 and 11.6.1 compliance verified
  expected: Confirmed by reviewer
- id: pci-005
  item: MFA implemented for all CDE access
  level: CRITICAL
  verification: manual
  verification_notes: MFA active for all remote and administrative CDE access
  expected: Confirmed by reviewer
- id: pci-006
  item: Audit logging with 12-month retention and automated review
  level: BLOCKING
  verification: manual
  verification_notes: Logging comprehensive with SIEM or automated review
  expected: Confirmed by reviewer
- id: pci-007
  item: Quarterly vulnerability scanning (internal and ASV)
  level: BLOCKING
  verification: manual
  verification_notes: Current scan reports with passing results
  expected: Confirmed by reviewer
- id: pci-008
  item: Annual penetration testing completed
  level: BLOCKING
  verification: manual
  verification_notes: Penetration test report within 12 months
  expected: Confirmed by reviewer
governance:
  applicable_to:
    archetypes:
    - e-commerce
    - payments
    - retail
    - financial
    maturity:
    - growing
    - mature
    business_scope:
    - payment-processing
    - card-data-handling
  compliance_frameworks:
  - framework: PCI DSS
    controls:
    - All 12 Requirements
  - framework: SOC2
    controls:
    - CC6.1
    - CC6.6
    - CC6.7
    - CC7.1
  - framework: ISO27001
    controls:
    - A.8.2
    - A.10.1
    - A.12.3
    - A.13.1
relationships:
  commonly_combined:
  - compliance-governance.audit-trails.audit-log-completeness
  - compliance-governance.certifications-attestations.soc2-readiness
  - security-trust.data-security.encryption-implementation
  - security-trust.vulnerability-management.vulnerability-scanning
  - security-trust.access-control.authentication-mechanisms
