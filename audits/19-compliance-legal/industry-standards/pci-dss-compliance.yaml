# ============================================================
# AUDIT: PCI-DSS Compliance Audit
# ============================================================
# Evaluates compliance with Payment Card Industry Data Security
# Standard for organizations processing payment card data.

audit:
  id: "compliance-legal.industry-standards.pci-dss-compliance"

  name: "PCI-DSS Compliance Audit"

  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "compliance-legal"
  category_number: 19
  subcategory: "industry-standards"

  tier: "expert"
  estimated_duration: "8-12 hours"  # median: 10h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "codebase"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: true
  parallelizable: false

description:
  what: |
    Comprehensive evaluation of PCI-DSS v4.0 compliance for organizations
    storing, processing, or transmitting cardholder data. Reviews all 12
    requirements including network security, access control, vulnerability
    management, encryption, monitoring, and security policies. Assesses
    cardholder data environment (CDE) scope, data flows, and control
    implementation.

  why_it_matters: |
    PCI-DSS compliance is mandatory for organizations handling payment card
    data. Non-compliance results in fines from payment brands (up to $500,000
    per incident), increased transaction fees, and potential loss of card
    processing privileges. Data breaches involving card data trigger
    mandatory forensic investigations and brand liability. Compliance
    protects both organization and cardholders.

  when_to_run:
    - "Before initiating PCI-DSS assessment"
    - "After changes to cardholder data environment"
    - "During annual compliance validation"
    - "When implementing new payment channels"
    - "After security incidents involving payment data"

prerequisites:
  required_artifacts:
    - type: "network_diagram"
      description: "Network diagram showing CDE boundaries"
    - type: "data_flow_diagram"
      description: "Cardholder data flow documentation"
    - type: "asset_inventory"
      description: "Systems in CDE inventory"

  access_requirements:
    - "Network diagrams and configurations"
    - "System configurations in CDE"
    - "Security policies and procedures"
    - "Vulnerability scan reports"
    - "Penetration test results"
    - "Encryption key management documentation"

discovery:
  code_patterns:
    - pattern: "(card|pan|cvv|track|payment|stripe|braintree)"
      type: "regex"
      scope: "source"
      purpose: "Find cardholder data handling"
    - pattern: "(encrypt|tokenize|mask|truncate)"
      type: "regex"
      scope: "source"
      purpose: "Locate data protection mechanisms"

  file_patterns:
    - glob: "**/payment/**"
      purpose: "Find payment processing code"
    - glob: "**/billing/**"
      purpose: "Locate billing systems"
    - glob: "**/config/*pci*"
      purpose: "Find PCI-related configurations"

  documents_to_review:
    - type: "Network diagrams"
      purpose: "Verify CDE scope and segmentation"
    - type: "Security policies"
      purpose: "Assess policy framework"
    - type: "Scan reports"
      purpose: "Review vulnerability management"

knowledge_sources:
  specifications:
    - id: "pci-dss-v4"
      name: "PCI DSS v4.0"
      url: "https://www.pcisecuritystandards.org/document_library"
      offline_cache: true
      priority: "required"
    - id: "pci-guidance"
      name: "PCI SSC Guidance Documents"
      url: "https://www.pcisecuritystandards.org/document_library"
      offline_cache: true
      priority: "required"

  guides:
    - id: "pci-saq"
      name: "PCI Self-Assessment Questionnaires"
      url: "https://www.pcisecuritystandards.org/document_library"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "PCI scanning tools"
      purpose: "Identify cardholder data in code"

  assessment_tools:
    - tool: "PCI-DSS requirements checklist"
      purpose: "Structured requirement evaluation"
    - tool: "ASV scanning"
      purpose: "External vulnerability scanning"

  scripts:
    - id: "card-data-finder"
      language: "bash"
      purpose: "Find potential cardholder data handling"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Card Data Patterns ==="
        grep -r -E "(card.?number|pan|cvv|track.?data|primary.?account)" \
          --include="*.py" --include="*.ts" --include="*.java" . 2>/dev/null

        echo "=== Payment Processing ==="
        grep -r -E "(stripe|braintree|adyen|payment.?gateway)" \
          --include="*.py" --include="*.ts" --include="*.yaml" . 2>/dev/null

signals:
  critical:
    - id: "PCI-CRIT-001"
      signal: "Unencrypted cardholder data storage"
      evidence_indicators:
        - "PAN stored in clear text"
        - "Full track data stored"
        - "CVV/CVC stored post-authorization"
      explanation: |
        Requirement 3 prohibits storage of sensitive authentication data
        post-authorization and requires encryption of stored PAN. Plain
        text card data storage is critical violation exposing cards to theft.
      remediation: "Implement encryption or tokenization; delete prohibited data"

    - id: "PCI-CRIT-002"
      signal: "No network segmentation of CDE"
      evidence_indicators:
        - "CDE not isolated from other networks"
        - "No firewall between CDE and internet"
        - "Flat network architecture"
      explanation: |
        Requirement 1 requires firewall/network security controls. Without
        segmentation, entire network is in scope and compromise of any
        system endangers card data.
      remediation: "Implement network segmentation with proper firewall rules"

    - id: "PCI-CRIT-003"
      signal: "Default or weak credentials on CDE systems"
      evidence_indicators:
        - "Default passwords in use"
        - "Shared credentials"
        - "No password complexity requirements"
      explanation: |
        Requirement 2 prohibits default credentials. Default passwords are
        publicly known and provide easy unauthorized access to CDE systems.
      remediation: "Change all default passwords; implement strong credential policies"

  high:
    - id: "PCI-HIGH-001"
      signal: "No vulnerability scanning program"
      explanation: "Requirement 11.3 requires quarterly vulnerability scans"
      remediation: "Implement ASV scanning and internal vulnerability scanning"

    - id: "PCI-HIGH-002"
      signal: "No logging and monitoring of CDE"
      explanation: "Requirement 10 requires comprehensive audit logging"
      remediation: "Implement centralized logging for all CDE components"

    - id: "PCI-HIGH-003"
      signal: "No annual penetration testing"
      explanation: "Requirement 11.4 requires annual penetration testing"
      remediation: "Conduct annual penetration test of CDE"

  medium:
    - id: "PCI-MED-001"
      signal: "Security awareness training not conducted"
      remediation: "Implement annual security awareness training (Req 12.6)"

    - id: "PCI-MED-002"
      signal: "Incident response plan not tested"
      remediation: "Test incident response plan annually (Req 12.10)"

    - id: "PCI-MED-003"
      signal: "Third-party service provider compliance not verified"
      remediation: "Verify service provider PCI compliance (Req 12.8)"

  low:
    - id: "PCI-LOW-001"
      signal: "Network diagrams not current"
      remediation: "Update network diagrams and data flows"

  positive:
    - id: "PCI-POS-001"
      signal: "Tokenization implemented to minimize CDE scope"
    - id: "PCI-POS-002"
      signal: "Comprehensive logging with SIEM integration"
    - id: "PCI-POS-003"
      signal: "Point-to-point encryption (P2PE) deployed"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Define CDE scope"
      description: |
        Identify all systems, people, and processes that store, process,
        or transmit cardholder data. Document CDE boundaries.
      duration_estimate: "60 min"
      questions:
        - "Where is cardholder data stored?"
        - "What systems process card data?"
        - "What is the data flow?"
        - "Is segmentation effective?"
      expected_findings:
        - "CDE scope definition"
        - "Data flow documentation"

    - id: "2"
      name: "Assess network security (Req 1-2)"
      description: |
        Review firewall configurations, network segmentation, and
        system hardening.
      duration_estimate: "90 min"
      commands:
        - purpose: "Find network configurations"
          command: "grep -r -E '(firewall|iptables|security.?group|acl)' --include='*.yaml' --include='*.tf' --include='*.conf' ."
      expected_findings:
        - "Network security status"
        - "Segmentation assessment"

    - id: "3"
      name: "Evaluate data protection (Req 3-4)"
      description: |
        Review cardholder data storage, encryption, and transmission
        security.
      duration_estimate: "90 min"
      commands:
        - purpose: "Find encryption implementations"
          command: "grep -r -E '(encrypt|aes|tls|ssl|tokenize)' --include='*.py' --include='*.ts' --include='*.java' ."
      expected_findings:
        - "Data protection status"
        - "Encryption implementation"

    - id: "4"
      name: "Review access controls (Req 7-9)"
      description: |
        Evaluate logical and physical access controls to CDE.
      duration_estimate: "60 min"
      expected_findings:
        - "Access control status"
        - "Authentication mechanisms"

    - id: "5"
      name: "Assess monitoring and testing (Req 10-11)"
      description: |
        Review logging, monitoring, vulnerability management, and
        penetration testing.
      duration_estimate: "60 min"
      expected_findings:
        - "Logging status"
        - "Vulnerability management assessment"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "pci_assessment"
      format: "structured"
      sections:
        - "CDE Scope"
        - "Network Security (Req 1-2)"
        - "Protect Account Data (Req 3-4)"
        - "Vulnerability Management (Req 5-6)"
        - "Access Control (Req 7-9)"
        - "Monitoring (Req 10-11)"
        - "Policy (Req 12)"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Compliance Status"
        - "Recommendations"

  confidence_guidance:
    high: "Full CDE access and documentation reviewed"
    medium: "Key systems reviewed, some access limitations"
    low: "Limited access to CDE systems"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "pci-dss-v4"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive requirement evaluation"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "pci-001"
    item: "CDE scope documented"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Network diagram and data flow documented"
    expected: "Confirmed by reviewer"

  - id: "pci-002"
    item: "Cardholder data encrypted or tokenized"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "No plain text storage of PAN"
    expected: "Confirmed by reviewer"

  - id: "pci-003"
    item: "Network segmentation implemented"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "CDE isolated with firewall controls"
    expected: "Confirmed by reviewer"

  - id: "pci-004"
    item: "Vulnerability scanning and penetration testing current"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Quarterly scans and annual pentest completed"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["payment-processing", "e-commerce", "retail"]

  compliance_frameworks:
    - framework: "PCI DSS"
      controls: ["Requirements 1-12"]
    - framework: "PA-DSS"
      controls: ["Payment application requirements"]

relationships:
  commonly_combined:
    - "compliance-legal.industry-standards.soc2-compliance"
    - "compliance-legal.audit-trail.audit-log-completeness"
    - "compliance-legal.data-protection.data-breach-notification"
