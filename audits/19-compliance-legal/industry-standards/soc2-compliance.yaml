# ============================================================
# AUDIT: SOC 2 Compliance Audit
# ============================================================
# Evaluates compliance with AICPA SOC 2 Trust Services Criteria
# across security, availability, processing integrity, confidentiality,
# and privacy principles.

audit:
  id: "compliance-legal.industry-standards.soc2-compliance"

  name: "SOC 2 Compliance Audit"

  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "compliance-legal"
  category_number: 19
  subcategory: "industry-standards"

  tier: "expert"
  estimated_duration: "8-12 hours"  # median: 10h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "organizational"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: false

description:
  what: |
    Evaluates organizational controls against SOC 2 Trust Services Criteria (TSC)
    including Security (common criteria), Availability, Processing Integrity,
    Confidentiality, and Privacy principles. Reviews control design, implementation,
    and operating effectiveness. Assesses readiness for SOC 2 Type I or Type II
    examination by independent auditors.

  why_it_matters: |
    SOC 2 is the primary trust framework for service organizations, particularly
    SaaS providers. Enterprise customers increasingly require SOC 2 reports as
    prerequisite for vendor selection. SOC 2 demonstrates commitment to security
    and operational excellence. Lack of SOC 2 may exclude organizations from
    enterprise sales opportunities.

  when_to_run:
    - "Before initiating SOC 2 examination"
    - "As part of SOC 2 readiness assessment"
    - "During annual control environment review"
    - "After significant organizational or system changes"
    - "When onboarding enterprise customers"

prerequisites:
  required_artifacts:
    - type: "control_matrix"
      description: "Documented controls mapped to TSC"
    - type: "policies"
      description: "Security and operational policies"
    - type: "system_description"
      description: "Description of system and boundaries"

  access_requirements:
    - "Security policies and procedures"
    - "Control documentation"
    - "System architecture and boundaries"
    - "Risk assessment documentation"
    - "Incident and change management records"

discovery:
  code_patterns:
    - pattern: "(audit|log|monitor|alert|access.?control)"
      type: "regex"
      scope: "source"
      purpose: "Find control implementations"
    - pattern: "(encrypt|auth|rbac|mfa)"
      type: "regex"
      scope: "source"
      purpose: "Locate security controls"

  file_patterns:
    - glob: "**/policies/**"
      purpose: "Find policy documents"
    - glob: "**/controls/**"
      purpose: "Locate control documentation"
    - glob: "**/security/**"
      purpose: "Find security implementations"

  documents_to_review:
    - type: "Control matrix"
      purpose: "Evaluate control coverage"
    - type: "Security policies"
      purpose: "Assess policy framework"
    - type: "Risk assessment"
      purpose: "Review risk management"

  interviews:
    - role: "Security/Compliance"
      questions:
        - "What controls are documented?"
        - "How is control effectiveness monitored?"
        - "What was the last audit scope?"
      purpose: "Understand control environment"
    - role: "Engineering"
      questions:
        - "How are access controls enforced?"
        - "What logging and monitoring exists?"
        - "How is change management implemented?"
      purpose: "Assess technical controls"

knowledge_sources:
  specifications:
    - id: "soc2-tsc"
      name: "AICPA Trust Services Criteria (2017)"
      url: "https://www.aicpa.org/resources/download/trust-services-criteria"
      offline_cache: true
      priority: "required"
    - id: "soc2-guide"
      name: "SOC 2 Examination Guide"
      url: "https://www.aicpa.org/resources/download/soc-2-reporting-on-an-examination-of-controls-at-a-service-organization"
      offline_cache: true
      priority: "required"

  guides:
    - id: "soc2-common"
      name: "Common Criteria and Point of Focus"
      url: "https://www.aicpa.org/interestareas/frc/assuranceadvisoryservices/sorhome"
      offline_cache: true

tooling:
  assessment_tools:
    - tool: "SOC 2 readiness checklist"
      purpose: "Structured TSC evaluation"
    - tool: "Control testing workpaper"
      purpose: "Document control testing"

  scripts:
    - id: "control-finder"
      language: "bash"
      purpose: "Find control implementations"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Access Control Patterns ==="
        grep -r -E "(rbac|role|permission|access.?control)" \
          --include="*.py" --include="*.ts" --include="*.java" . 2>/dev/null

        echo "=== Logging Patterns ==="
        grep -r -E "(audit.?log|security.?log|access.?log)" \
          --include="*.py" --include="*.ts" --include="*.yaml" . 2>/dev/null

signals:
  critical:
    - id: "SOC2-CRIT-001"
      signal: "No documented security policies"
      evidence_indicators:
        - "No information security policy"
        - "No acceptable use policy"
        - "No access control policy"
      explanation: |
        SOC 2 Common Criteria require documented policies as foundation
        for control environment. Without policies, controls lack authority
        and cannot be consistently applied.
      remediation: "Develop comprehensive security policy framework"

    - id: "SOC2-CRIT-002"
      signal: "No access controls or identity management"
      evidence_indicators:
        - "No authentication system"
        - "No role-based access control"
        - "Shared credentials in use"
      explanation: |
        CC6.1-CC6.3 require logical access controls. Without identity
        management and access controls, organizations cannot demonstrate
        security principle compliance.
      remediation: "Implement identity management with RBAC"

    - id: "SOC2-CRIT-003"
      signal: "No security monitoring or logging"
      evidence_indicators:
        - "No security event logging"
        - "No monitoring or alerting"
        - "No incident detection capability"
      explanation: |
        CC7.1-CC7.3 require monitoring and incident management. Without
        logging and monitoring, security incidents go undetected.
      remediation: "Implement comprehensive security monitoring"

  high:
    - id: "SOC2-HIGH-001"
      signal: "No risk assessment process"
      explanation: "CC3.1-CC3.4 require risk assessment and management"
      remediation: "Implement formal risk assessment process"

    - id: "SOC2-HIGH-002"
      signal: "No change management process"
      explanation: "CC8.1 requires change management controls"
      remediation: "Implement documented change management process"

    - id: "SOC2-HIGH-003"
      signal: "No vendor management program"
      explanation: "CC9.2 requires vendor and third-party management"
      remediation: "Implement vendor risk management program"

  medium:
    - id: "SOC2-MED-001"
      signal: "Controls not formally documented"
      remediation: "Create control documentation and evidence collection"

    - id: "SOC2-MED-002"
      signal: "No system description"
      remediation: "Document system boundaries, components, and data flows"

    - id: "SOC2-MED-003"
      signal: "Evidence retention insufficient"
      remediation: "Implement 12-month evidence retention for Type II"

  low:
    - id: "SOC2-LOW-001"
      signal: "Control owners not formally assigned"
      remediation: "Assign and document control ownership"

  positive:
    - id: "SOC2-POS-001"
      signal: "Comprehensive control matrix with TSC mapping"
    - id: "SOC2-POS-002"
      signal: "Automated control testing"
    - id: "SOC2-POS-003"
      signal: "Continuous compliance monitoring"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Define scope and boundaries"
      description: |
        Identify systems in scope, trust services criteria selected,
        and system boundaries for examination.
      duration_estimate: "60 min"
      questions:
        - "What systems are in scope?"
        - "Which TSC categories apply?"
        - "What are the system boundaries?"
      expected_findings:
        - "Scope definition"
        - "TSC selection rationale"

    - id: "2"
      name: "Evaluate control environment"
      description: |
        Review organizational controls including governance, risk
        management, and communication (CC1-CC5).
      duration_estimate: "90 min"
      questions:
        - "Is there a security governance structure?"
        - "Are policies documented and communicated?"
        - "Is there a risk assessment process?"
      expected_findings:
        - "Control environment assessment"
        - "Governance gaps"

    - id: "3"
      name: "Assess logical and physical access"
      description: |
        Evaluate access controls, authentication, and authorization
        mechanisms (CC6).
      duration_estimate: "90 min"
      commands:
        - purpose: "Find access control implementations"
          command: "grep -r -E '(rbac|permission|auth|access)' --include='*.py' --include='*.ts' --include='*.yaml' ."
      expected_findings:
        - "Access control status"
        - "Authentication assessment"

    - id: "4"
      name: "Review system operations"
      description: |
        Evaluate monitoring, incident management, and change
        management controls (CC7-CC8).
      duration_estimate: "90 min"
      expected_findings:
        - "Operations control status"
        - "Incident management assessment"

    - id: "5"
      name: "Evaluate risk mitigation"
      description: |
        Review risk assessment, vendor management, and business
        continuity controls (CC9).
      duration_estimate: "60 min"
      expected_findings:
        - "Risk management assessment"
        - "Vendor management status"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "soc2_readiness"
      format: "structured"
      sections:
        - "Scope Definition"
        - "Control Environment (CC1-CC5)"
        - "Access Controls (CC6)"
        - "System Operations (CC7-CC8)"
        - "Risk Mitigation (CC9)"
        - "Readiness Summary"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Readiness Status"
        - "Gap Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Full control documentation and testing completed"
    medium: "Key controls evaluated, some gaps in documentation"
    low: "Limited control documentation available"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "soc2-tsc"
        priority: "required"
      - source_id: "soc2-guide"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive control evaluation"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "soc2-001"
    item: "Scope and system boundaries defined"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "System description documented"
    expected: "Confirmed by reviewer"

  - id: "soc2-002"
    item: "Security policies documented"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Required policies exist and are current"
    expected: "Confirmed by reviewer"

  - id: "soc2-003"
    item: "Access controls implemented"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Authentication and authorization verified"
    expected: "Confirmed by reviewer"

  - id: "soc2-004"
    item: "Monitoring and incident management operational"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Logging, alerting, and incident response verified"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["saas", "service-provider", "cloud-services"]

  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["Trust Services Criteria (all)"]
    - framework: "ISO 27001"
      controls: ["Annex A (mapped)"]

relationships:
  commonly_combined:
    - "compliance-legal.industry-standards.iso27001-compliance"
    - "compliance-legal.audit-trail.audit-log-completeness"
    - "compliance-legal.data-protection.data-breach-notification"
