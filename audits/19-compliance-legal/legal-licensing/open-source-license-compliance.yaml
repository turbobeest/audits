# ============================================================
# AUDIT: Open Source License Compliance Audit
# ============================================================
# Evaluates compliance with open source software licenses
# including copyleft, permissive, and attribution requirements.

audit:
  id: "compliance-legal.legal-licensing.open-source-license-compliance"

  name: "Open Source License Compliance Audit"

  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "compliance-legal"
  category_number: 19
  subcategory: "legal-licensing"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates open source license compliance across all dependencies and
    incorporated code. Reviews license identification, compatibility analysis,
    attribution requirements, copyleft obligations (GPL, LGPL, AGPL), and
    license policy enforcement. Assesses SBOM generation and license tracking
    processes.

  why_it_matters: |
    Open source license violations expose organizations to litigation,
    injunctions, forced source disclosure, and reputational damage. GPL/AGPL
    copyleft licenses can require releasing proprietary code. Attribution
    failures violate even permissive licenses. Increasing enforcement by
    license compliance organizations and courts.

  when_to_run:
    - "Before product releases"
    - "During M&A due diligence"
    - "When adding new dependencies"
    - "As part of compliance audits"
    - "When distributing software externally"

prerequisites:
  required_artifacts:
    - type: "dependency_manifest"
      description: "Package manifests (package.json, requirements.txt, etc.)"
    - type: "sbom"
      description: "Software Bill of Materials"
    - type: "license_policy"
      description: "Organizational license policy"

  access_requirements:
    - "Source code access"
    - "Dependency manifests"
    - "Build configurations"
    - "SBOM or dependency scanner"

discovery:
  code_patterns:
    - pattern: "(license|copyright|gpl|mit|apache|bsd)"
      type: "regex"
      scope: "source"
      purpose: "Find license references"
    - pattern: "(SPDX|license-identifier)"
      type: "regex"
      scope: "source"
      purpose: "Locate SPDX identifiers"

  file_patterns:
    - glob: "**/LICENSE*"
      purpose: "Find license files"
    - glob: "**/COPYING*"
      purpose: "Locate GPL-style license files"
    - glob: "**/package.json"
      purpose: "Find npm dependencies"
    - glob: "**/requirements*.txt"
      purpose: "Find Python dependencies"
    - glob: "**/go.mod"
      purpose: "Find Go dependencies"

  documents_to_review:
    - type: "License policy"
      purpose: "Verify organizational requirements"
    - type: "SBOM"
      purpose: "Review dependency licenses"

knowledge_sources:
  specifications:
    - id: "spdx"
      name: "SPDX License List"
      url: "https://spdx.org/licenses/"
      offline_cache: true
      priority: "required"
    - id: "osi-licenses"
      name: "OSI Approved Licenses"
      url: "https://opensource.org/licenses"
      offline_cache: true
      priority: "required"

  guides:
    - id: "gpl-guide"
      name: "GNU GPL Compliance Guide"
      url: "https://www.gnu.org/licenses/gpl-compliance.html"
      offline_cache: true
    - id: "fossa-guide"
      name: "Open Source License Compliance Guide"
      url: "https://fossa.com/blog/open-source-license-compliance/"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "scancode-toolkit"
      purpose: "License detection and analysis"
      offline_capable: true
    - tool: "fossa"
      purpose: "License compliance scanning"
    - tool: "snyk"
      purpose: "Dependency and license scanning"

  scripts:
    - id: "license-finder"
      language: "bash"
      purpose: "Find license files and references"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== License Files ==="
        find . -name "LICENSE*" -o -name "COPYING*" -o -name "NOTICE*" 2>/dev/null | head -30

        echo "=== Dependency Licenses ==="
        if [ -f package.json ]; then
          npm list --json 2>/dev/null | grep -E '"license"' | head -20
        fi

signals:
  critical:
    - id: "OSS-CRIT-001"
      signal: "GPL/AGPL code in proprietary product"
      evidence_indicators:
        - "GPL-licensed dependencies"
        - "AGPL code in SaaS product"
        - "Copyleft code without compliance"
      explanation: |
        GPL requires derivative works to be released under GPL. AGPL extends
        this to network use. Using copyleft code without compliance may
        require releasing proprietary source code.
      remediation: "Replace copyleft components or comply with license terms"

    - id: "OSS-CRIT-002"
      signal: "License-incompatible dependencies combined"
      evidence_indicators:
        - "GPL and proprietary code combined"
        - "Incompatible copyleft licenses mixed"
        - "License conflicts in dependency tree"
      explanation: |
        Some licenses are incompatible and cannot be combined in same work.
        GPLv2-only and Apache 2.0 are incompatible. Combining incompatible
        licenses violates at least one license.
      remediation: "Resolve license conflicts by replacement or separation"

    - id: "OSS-CRIT-003"
      signal: "Required attribution missing"
      evidence_indicators:
        - "No NOTICE file for Apache licensed code"
        - "Copyright notices removed"
        - "License text not included"
      explanation: |
        Even permissive licenses require attribution. MIT, Apache, BSD all
        require including license and copyright notice. Missing attribution
        violates license terms.
      remediation: "Add required attribution for all open source components"

  high:
    - id: "OSS-HIGH-001"
      signal: "No dependency license tracking"
      explanation: "Cannot demonstrate compliance without tracking"
      remediation: "Implement SBOM generation and license tracking"

    - id: "OSS-HIGH-002"
      signal: "Unknown licenses in dependencies"
      explanation: "Cannot determine compliance for unknown licenses"
      remediation: "Identify all licenses and evaluate compliance"

  medium:
    - id: "OSS-MED-001"
      signal: "No license policy documented"
      remediation: "Create organizational open source license policy"

    - id: "OSS-MED-002"
      signal: "License review not in development workflow"
      remediation: "Integrate license scanning in CI/CD"

  low:
    - id: "OSS-LOW-001"
      signal: "SBOM not in standard format"
      remediation: "Generate SPDX or CycloneDX format SBOM"

  positive:
    - id: "OSS-POS-001"
      signal: "Complete SBOM with all licenses identified"
    - id: "OSS-POS-002"
      signal: "Automated license compliance in CI/CD"
    - id: "OSS-POS-003"
      signal: "Clear license policy with approved list"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Generate dependency inventory"
      description: |
        Create complete inventory of all dependencies including
        transitive dependencies across all package managers.
      duration_estimate: "45 min"
      commands:
        - purpose: "List npm dependencies"
          command: "npm list --all --json 2>/dev/null | head -100"
        - purpose: "Find dependency files"
          command: "find . -name 'package.json' -o -name 'requirements*.txt' -o -name 'go.mod' -o -name 'Cargo.toml'"
      expected_findings:
        - "Complete dependency inventory"
        - "Transitive dependency map"

    - id: "2"
      name: "Identify licenses"
      description: |
        Identify licenses for all dependencies using SPDX identifiers
        where possible.
      duration_estimate: "60 min"
      expected_findings:
        - "License inventory"
        - "Unknown license identification"

    - id: "3"
      name: "Analyze license compatibility"
      description: |
        Review license compatibility for all combinations in the
        dependency tree.
      duration_estimate: "60 min"
      questions:
        - "Are any copyleft licenses present?"
        - "Are there license conflicts?"
        - "What attribution is required?"
      expected_findings:
        - "Compatibility analysis"
        - "Conflict identification"

    - id: "4"
      name: "Verify attribution compliance"
      description: |
        Check that all required attribution is present including
        license texts, copyright notices, and NOTICE files.
      duration_estimate: "45 min"
      commands:
        - purpose: "Find license and attribution files"
          command: "find . -name 'LICENSE*' -o -name 'NOTICE*' -o -name 'COPYING*'"
      expected_findings:
        - "Attribution status"
        - "Missing attributions"

    - id: "5"
      name: "Review copyleft obligations"
      description: |
        For any copyleft licenses, verify compliance with source
        distribution requirements.
      duration_estimate: "30 min"
      expected_findings:
        - "Copyleft compliance status"
        - "Source distribution requirements"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "license_assessment"
      format: "structured"
      sections:
        - "Dependency Inventory"
        - "License Identification"
        - "Compatibility Analysis"
        - "Attribution Review"
        - "Copyleft Compliance"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Compliance Status"
        - "Recommendations"

  confidence_guidance:
    high: "Full dependency scan with license verification"
    medium: "Direct dependencies reviewed"
    low: "Limited dependency visibility"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "spdx"
        priority: "required"
      - source_id: "osi-licenses"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires thorough license analysis"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "oss-001"
    item: "All dependency licenses identified"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Complete license inventory exists"
    expected: "Confirmed by reviewer"

  - id: "oss-002"
    item: "No license conflicts present"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "All licenses compatible"
    expected: "Confirmed by reviewer"

  - id: "oss-003"
    item: "Required attribution present"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "License and copyright notices included"
    expected: "Confirmed by reviewer"

  - id: "oss-004"
    item: "Copyleft obligations addressed"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "GPL/AGPL compliance verified or code replaced"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "NTIA SBOM"
      controls: ["Minimum elements"]
    - framework: "OpenChain"
      controls: ["ISO 5230"]

relationships:
  commonly_combined:
    - "compliance-legal.legal-licensing.software-license-management"
    - "compliance-legal.legal-licensing.intellectual-property"
