# ============================================================
# AUDIT: Audit Log Retention Audit
# ============================================================
# Evaluates audit log retention policies and implementation
# against regulatory and operational requirements.

audit:
  id: "compliance-legal.audit-trail.audit-log-retention"

  name: "Audit Log Retention Audit"

  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "compliance-legal"
  category_number: 19
  subcategory: "audit-trail"

  tier: "expert"
  estimated_duration: "3-4 hours"  # median: 3h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates audit log retention policies against regulatory requirements
    and operational needs. Reviews retention periods for different log types,
    automated archival processes, storage capacity planning, and retrieval
    capabilities. Assesses compliance with PCI-DSS (1 year), SOC 2, HIPAA
    (6 years), and other framework requirements.

  why_it_matters: |
    Regulatory frameworks mandate specific log retention periods: PCI-DSS
    requires 1 year with 3 months immediately available, HIPAA requires
    6 years, SOX requires 7 years. Insufficient retention prevents
    investigation of past incidents and compliance evidence. Excessive
    retention increases storage costs and breach exposure.

  when_to_run:
    - "During compliance audit preparation"
    - "When reviewing storage costs"
    - "After regulatory requirement changes"
    - "During logging infrastructure planning"
    - "Following capacity incidents"

prerequisites:
  required_artifacts:
    - type: "retention_policy"
      description: "Log retention policy documentation"
    - type: "storage_configuration"
      description: "Log storage and archival configuration"
    - type: "compliance_requirements"
      description: "Applicable retention requirements"

  access_requirements:
    - "Log retention policies"
    - "Storage configurations"
    - "Archival settings"
    - "Historical log samples"

discovery:
  code_patterns:
    - pattern: "(retention|expire|ttl|archive|purge)"
      type: "regex"
      scope: "config"
      purpose: "Find retention configurations"

  file_patterns:
    - glob: "**/config/*log*"
      purpose: "Find log configurations"
    - glob: "**/policies/*retention*"
      purpose: "Locate retention policies"

  documents_to_review:
    - type: "Log retention policy"
      purpose: "Evaluate policy coverage"
    - type: "Storage configuration"
      purpose: "Verify implementation"

knowledge_sources:
  specifications:
    - id: "pci-req10"
      name: "PCI-DSS Requirement 10.7"
      url: "https://www.pcisecuritystandards.org/document_library"
      offline_cache: true
      priority: "required"
    - id: "nist-au-11"
      name: "NIST SP 800-53 AU-11 Audit Record Retention"
      url: "https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final"
      offline_cache: true
      priority: "required"

  guides:
    - id: "hipaa-retention"
      name: "HIPAA Retention Requirements"
      url: "https://www.hhs.gov/hipaa/for-professionals/faq/580/retention-period-medical-records.html"
      offline_cache: true

tooling:
  scripts:
    - id: "retention-check"
      language: "bash"
      purpose: "Check log retention settings"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Log Rotation Settings ==="
        cat /etc/logrotate.conf 2>/dev/null
        ls -la /etc/logrotate.d/ 2>/dev/null

        echo "=== Oldest Logs ==="
        find /var/log -type f -name "*.log*" -mtime +30 2>/dev/null | head -10

signals:
  critical:
    - id: "LOGR-CRIT-001"
      signal: "Logs deleted before retention period"
      evidence_indicators:
        - "Logs older than 1 year unavailable"
        - "Premature log rotation"
        - "Storage capacity causing early deletion"
      explanation: |
        PCI-DSS requires 1 year retention with 3 months immediately available.
        HIPAA requires 6 years. Premature deletion violates compliance and
        prevents investigation of past incidents.
      remediation: "Implement retention meeting longest applicable requirement"

    - id: "LOGR-CRIT-002"
      signal: "No log archival process"
      evidence_indicators:
        - "Logs only on active storage"
        - "No archival system"
        - "Logs purged when disk full"
      explanation: |
        Without archival, logs are lost when active storage fills.
        Archival enables long-term retention without active storage costs.
      remediation: "Implement automated log archival to long-term storage"

  high:
    - id: "LOGR-HIGH-001"
      signal: "Cannot retrieve archived logs"
      explanation: "Logs retained but not accessible for investigation"
      remediation: "Test and document log retrieval procedures"

    - id: "LOGR-HIGH-002"
      signal: "Retention periods not documented"
      explanation: "Cannot demonstrate compliance without documentation"
      remediation: "Document retention periods for each log type"

  medium:
    - id: "LOGR-MED-001"
      signal: "Storage capacity not planned"
      remediation: "Plan storage capacity for retention requirements"

    - id: "LOGR-MED-002"
      signal: "Different retention for similar logs"
      remediation: "Standardize retention based on compliance requirements"

  low:
    - id: "LOGR-LOW-001"
      signal: "Archival not compressed"
      remediation: "Implement compression for archived logs"

  positive:
    - id: "LOGR-POS-001"
      signal: "Retention exceeds all compliance requirements"
    - id: "LOGR-POS-002"
      signal: "Automated archival with verified retrieval"
    - id: "LOGR-POS-003"
      signal: "Tiered storage optimizing cost and access"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Map retention requirements"
      description: |
        Identify all applicable log retention requirements from
        regulations, contracts, and operational needs.
      duration_estimate: "30 min"
      questions:
        - "What compliance frameworks apply?"
        - "What are contractual requirements?"
        - "What operational needs exist?"
      expected_findings:
        - "Requirements mapping"
        - "Longest retention requirement"

    - id: "2"
      name: "Review retention policy"
      description: |
        Evaluate documented retention policy against requirements
        and verify completeness.
      duration_estimate: "30 min"
      expected_findings:
        - "Policy coverage"
        - "Requirement alignment"

    - id: "3"
      name: "Verify implementation"
      description: |
        Review technical implementation of retention including
        rotation, archival, and purging configurations.
      duration_estimate: "45 min"
      commands:
        - purpose: "Check retention configurations"
          command: "grep -r -E '(retention|expire|ttl|rotate)' --include='*.yaml' --include='*.conf' --include='*.json' ."
      expected_findings:
        - "Implementation status"
        - "Configuration verification"

    - id: "4"
      name: "Test retrieval capability"
      description: |
        Verify ability to retrieve archived logs for investigation
        purposes.
      duration_estimate: "30 min"
      expected_findings:
        - "Retrieval capability"
        - "Access time assessment"

    - id: "5"
      name: "Assess storage capacity"
      description: |
        Review storage planning and capacity for retention
        requirements.
      duration_estimate: "30 min"
      expected_findings:
        - "Capacity assessment"
        - "Growth planning"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "retention_assessment"
      format: "structured"
      sections:
        - "Requirements Mapping"
        - "Policy Review"
        - "Implementation Verification"
        - "Retrieval Testing"
        - "Capacity Assessment"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Compliance Status"
        - "Recommendations"

  confidence_guidance:
    high: "Full implementation reviewed with retrieval tested"
    medium: "Policy and configuration reviewed"
    low: "Limited access to configurations"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "pci-req10"
        priority: "required"
      - source_id: "nist-au-11"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires retention verification"
    full:
      included: true
      priority: 2

closeout_checklist:
  - id: "logr-001"
    item: "Retention meets compliance requirements"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Logs retained for required periods"
    expected: "Confirmed by reviewer"

  - id: "logr-002"
    item: "Archival process operational"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Automated archival functioning"
    expected: "Confirmed by reviewer"

  - id: "logr-003"
    item: "Log retrieval verified"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Can retrieve archived logs when needed"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "PCI-DSS"
      controls: ["Requirement 10.7"]
    - framework: "HIPAA"
      controls: ["6-year retention"]
    - framework: "SOX"
      controls: ["7-year retention"]
    - framework: "NIST SP 800-53"
      controls: ["AU-11"]

relationships:
  commonly_combined:
    - "compliance-legal.audit-trail.audit-log-completeness"
    - "compliance-legal.audit-trail.audit-log-integrity"
    - "compliance-legal.data-protection.data-retention-compliance"
