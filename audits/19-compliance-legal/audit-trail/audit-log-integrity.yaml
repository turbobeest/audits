# ============================================================
# AUDIT: Audit Log Integrity Audit
# ============================================================
# Evaluates protections against unauthorized modification,
# deletion, or tampering with audit logs.

audit:
  id: "compliance-legal.audit-trail.audit-log-integrity"

  name: "Audit Log Integrity Audit"

  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "compliance-legal"
  category_number: 19
  subcategory: "audit-trail"

  tier: "expert"
  estimated_duration: "3-5 hours"  # median: 4h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates audit log integrity protections including access controls on
    log storage, tamper detection mechanisms, write-once storage, centralized
    collection, and chain of custody. Reviews protection against modification,
    deletion, and unauthorized access by administrators or attackers.

  why_it_matters: |
    Audit logs are only valuable if their integrity can be trusted. Attackers
    routinely attempt to delete or modify logs to cover their tracks. Insider
    threats may alter logs to hide unauthorized activity. Compliance frameworks
    require log integrity protection. Tampered logs cannot support forensic
    investigation or legal proceedings.

  when_to_run:
    - "During security architecture reviews"
    - "After logging infrastructure changes"
    - "As part of compliance audits"
    - "Following security incidents"
    - "During forensic readiness assessments"

prerequisites:
  required_artifacts:
    - type: "logging_architecture"
      description: "Logging infrastructure documentation"
    - type: "access_controls"
      description: "Log storage access control configuration"
    - type: "integrity_mechanisms"
      description: "Tamper detection implementations"

  access_requirements:
    - "Logging infrastructure access"
    - "Log storage configurations"
    - "Access control settings"
    - "Integrity mechanism documentation"

discovery:
  code_patterns:
    - pattern: "(immutable|tamper|integrity|hash|signature)"
      type: "regex"
      scope: "source"
      purpose: "Find integrity mechanisms"
    - pattern: "(worm|write.?once|append.?only)"
      type: "regex"
      scope: "config"
      purpose: "Locate immutable storage"

  file_patterns:
    - glob: "**/logging/**"
      purpose: "Find logging infrastructure"
    - glob: "**/config/*log*"
      purpose: "Locate log configurations"

  documents_to_review:
    - type: "Logging architecture"
      purpose: "Understand log flow and storage"
    - type: "Access control policies"
      purpose: "Evaluate log access restrictions"

knowledge_sources:
  specifications:
    - id: "nist-au-9"
      name: "NIST SP 800-53 AU-9 Protection of Audit Information"
      url: "https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final"
      offline_cache: true
      priority: "required"

  guides:
    - id: "cis-logging"
      name: "CIS Logging Best Practices"
      url: "https://www.cisecurity.org/controls"
      offline_cache: true

tooling:
  scripts:
    - id: "log-integrity-check"
      language: "bash"
      purpose: "Check log storage permissions"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Log File Permissions ==="
        find /var/log -type f -name "*.log" -exec ls -la {} \; 2>/dev/null | head -20

        echo "=== Immutable Attributes ==="
        lsattr /var/log/*.log 2>/dev/null | head -10

signals:
  critical:
    - id: "LOGI-CRIT-001"
      signal: "Logs stored locally without central collection"
      evidence_indicators:
        - "No centralized log management"
        - "Logs only on source systems"
        - "No log forwarding"
      explanation: |
        Locally stored logs can be deleted or modified by attackers who
        compromise the system. Centralized collection to protected storage
        is essential for integrity and availability.
      remediation: "Implement centralized log collection to protected storage"

    - id: "LOGI-CRIT-002"
      signal: "Administrators can delete or modify logs"
      evidence_indicators:
        - "Full admin access to log storage"
        - "No separation of duties"
        - "Logs modifiable by system admins"
      explanation: |
        Separation of duties requires log storage be protected from
        modification even by system administrators. Without separation,
        insider threats can manipulate logs.
      remediation: "Implement write-once storage or separate log admin role"

    - id: "LOGI-CRIT-003"
      signal: "No tamper detection mechanisms"
      evidence_indicators:
        - "No log hashing or signatures"
        - "No integrity verification"
        - "Modifications undetectable"
      explanation: |
        Without tamper detection, log modifications cannot be detected.
        Integrity verification through hashing or digital signatures
        ensures tampering is evident.
      remediation: "Implement log integrity verification (hashing, signatures)"

  high:
    - id: "LOGI-HIGH-001"
      signal: "Log storage access not restricted"
      explanation: "Broad access to log storage enables unauthorized access"
      remediation: "Implement least privilege access to log storage"

    - id: "LOGI-HIGH-002"
      signal: "No audit of log access"
      explanation: "Cannot detect unauthorized access to logs"
      remediation: "Enable audit logging for log storage access"

  medium:
    - id: "LOGI-MED-001"
      signal: "Logs transmitted without encryption"
      remediation: "Implement TLS for log transmission"

    - id: "LOGI-MED-002"
      signal: "Log collection failures not alerted"
      remediation: "Implement alerting for log collection failures"

  low:
    - id: "LOGI-LOW-001"
      signal: "Log chain of custody not documented"
      remediation: "Document log handling procedures"

  positive:
    - id: "LOGI-POS-001"
      signal: "Write-once/WORM log storage"
    - id: "LOGI-POS-002"
      signal: "Cryptographic integrity verification"
    - id: "LOGI-POS-003"
      signal: "Separated log administration role"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Review logging architecture"
      description: |
        Evaluate log collection, transmission, and storage architecture
        for integrity considerations.
      duration_estimate: "45 min"
      questions:
        - "How are logs collected and transmitted?"
        - "Where are logs stored?"
        - "What is the log retention chain?"
      expected_findings:
        - "Architecture assessment"
        - "Integrity points"

    - id: "2"
      name: "Assess access controls"
      description: |
        Review access controls on log storage and transmission
        infrastructure.
      duration_estimate: "45 min"
      expected_findings:
        - "Access control assessment"
        - "Privilege separation status"

    - id: "3"
      name: "Evaluate tamper detection"
      description: |
        Review mechanisms for detecting log modification including
        hashing, signatures, and immutable storage.
      duration_estimate: "45 min"
      commands:
        - purpose: "Check for integrity mechanisms"
          command: "grep -r -E '(hash|signature|checksum|integrity)' --include='*.py' --include='*.ts' --include='*.yaml' ."
      expected_findings:
        - "Tamper detection status"
        - "Integrity mechanism coverage"

    - id: "4"
      name: "Review transmission security"
      description: |
        Assess security of log transmission including encryption
        and authentication.
      duration_estimate: "30 min"
      expected_findings:
        - "Transmission security status"
        - "Encryption coverage"

    - id: "5"
      name: "Test integrity mechanisms"
      description: |
        Verify tamper detection mechanisms function as intended
        through controlled testing.
      duration_estimate: "30 min"
      expected_findings:
        - "Mechanism effectiveness"
        - "Detection capability"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "integrity_assessment"
      format: "structured"
      sections:
        - "Architecture Review"
        - "Access Control Assessment"
        - "Tamper Detection"
        - "Transmission Security"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Integrity Status"
        - "Recommendations"

  confidence_guidance:
    high: "Full architecture reviewed with testing"
    medium: "Configuration reviewed without testing"
    low: "Limited access to infrastructure"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "nist-au-9"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires thorough integrity assessment"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "logi-001"
    item: "Centralized log collection implemented"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Logs forwarded to protected central storage"
    expected: "Confirmed by reviewer"

  - id: "logi-002"
    item: "Separation of duties for log access"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "System admins cannot modify logs"
    expected: "Confirmed by reviewer"

  - id: "logi-003"
    item: "Tamper detection mechanisms operational"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Hashing, signatures, or WORM storage in place"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["CC7.3"]
    - framework: "PCI-DSS"
      controls: ["Requirement 10.5"]
    - framework: "NIST SP 800-53"
      controls: ["AU-9"]

relationships:
  commonly_combined:
    - "compliance-legal.audit-trail.audit-log-completeness"
    - "compliance-legal.audit-trail.audit-log-retention"
    - "compliance-legal.audit-trail.audit-log-monitoring"
