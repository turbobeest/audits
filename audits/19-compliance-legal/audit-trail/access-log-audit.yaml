# ============================================================
# AUDIT: Access Log Audit
# ============================================================
# Evaluates access logging for user and system access events
# including authentication, authorization, and resource access.

audit:
  id: "compliance-legal.audit-trail.access-log-audit"

  name: "Access Log Audit"

  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "compliance-legal"
  category_number: 19
  subcategory: "audit-trail"

  tier: "expert"
  estimated_duration: "3-5 hours"  # median: 4h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates access logging coverage and quality for authentication events,
    authorization decisions, and resource access. Reviews logging of successful
    and failed access attempts, user identification, source attribution, and
    access context. Assesses compliance with access logging requirements across
    regulatory frameworks.

  why_it_matters: |
    Access logs are essential for detecting unauthorized access, investigating
    security incidents, and demonstrating compliance. They enable identification
    of compromised accounts, privilege abuse, and policy violations. Without
    comprehensive access logging, organizations cannot detect or investigate
    unauthorized access to systems and data.

  when_to_run:
    - "During security architecture reviews"
    - "After implementing access control changes"
    - "As part of compliance audits"
    - "Following access-related security incidents"
    - "When onboarding new applications"

prerequisites:
  required_artifacts:
    - type: "access_log_samples"
      description: "Sample access logs for review"
    - type: "access_policy"
      description: "Access logging requirements"
    - type: "system_inventory"
      description: "Systems requiring access logging"

  access_requirements:
    - "Access to authentication systems"
    - "Sample access logs"
    - "Application access logging configurations"
    - "Identity provider logs"

discovery:
  code_patterns:
    - pattern: "(access|login|auth|session)"
      type: "regex"
      scope: "source"
      purpose: "Find access-related code"
    - pattern: "(log|audit|track|record)"
      type: "regex"
      scope: "source"
      purpose: "Locate logging calls"

  file_patterns:
    - glob: "**/auth/**"
      purpose: "Find authentication modules"
    - glob: "**/access/**"
      purpose: "Locate access control code"
    - glob: "**/logs/*access*"
      purpose: "Find access logs"

  documents_to_review:
    - type: "Access logging standards"
      purpose: "Verify requirements"
    - type: "Sample access logs"
      purpose: "Assess log quality"

knowledge_sources:
  specifications:
    - id: "nist-ac-17"
      name: "NIST SP 800-53 AC-17 Remote Access"
      url: "https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final"
      offline_cache: true
      priority: "required"

  guides:
    - id: "owasp-logging"
      name: "OWASP Logging Guide"
      url: "https://cheatsheetseries.owasp.org/cheatsheets/Logging_Cheat_Sheet.html"
      offline_cache: true

tooling:
  scripts:
    - id: "access-log-check"
      language: "bash"
      purpose: "Review access logging patterns"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Authentication Logging ==="
        grep -r -E "(login|auth|session).*log" \
          --include="*.py" --include="*.ts" --include="*.java" . 2>/dev/null | head -30

        echo "=== Access Denied Logging ==="
        grep -r -E "(denied|unauthorized|forbidden).*log" \
          --include="*.py" --include="*.ts" --include="*.java" . 2>/dev/null | head -20

signals:
  critical:
    - id: "ACCL-CRIT-001"
      signal: "Failed login attempts not logged"
      evidence_indicators:
        - "Authentication failures not recorded"
        - "Brute force attacks not visible"
        - "Account lockouts not tracked"
      explanation: |
        Failed login attempts are primary indicators of attack activity.
        Without logging failures, credential attacks go undetected.
        Compliance frameworks require logging all authentication events.
      remediation: "Log all authentication attempts including failures"

    - id: "ACCL-CRIT-002"
      signal: "Access denials not logged"
      evidence_indicators:
        - "Authorization failures not recorded"
        - "Privilege escalation attempts not visible"
        - "Forbidden resource access not tracked"
      explanation: |
        Access denials indicate unauthorized access attempts. Failure to
        log denials prevents detection of privilege abuse and policy
        violations.
      remediation: "Log all authorization decisions including denials"

    - id: "ACCL-CRIT-003"
      signal: "User identity not captured in access logs"
      evidence_indicators:
        - "Anonymous access events"
        - "No user identification in logs"
        - "Cannot attribute access to users"
      explanation: |
        Access logs without user identity cannot support investigation
        or accountability. Must capture authenticated identity for all
        access events.
      remediation: "Include user identity in all access log entries"

  high:
    - id: "ACCL-HIGH-001"
      signal: "Source IP not logged"
      explanation: "Cannot trace access to origin without IP"
      remediation: "Include source IP in access logs"

    - id: "ACCL-HIGH-002"
      signal: "Session management events not logged"
      explanation: "Session creation, termination, timeout not tracked"
      remediation: "Log all session lifecycle events"

  medium:
    - id: "ACCL-MED-001"
      signal: "Access context incomplete"
      remediation: "Include accessed resource, action, and timestamp"

    - id: "ACCL-MED-002"
      signal: "Administrative access not distinguished"
      remediation: "Flag privileged access in logs"

  low:
    - id: "ACCL-LOW-001"
      signal: "Access logs not correlated"
      remediation: "Implement correlation IDs for request tracing"

  positive:
    - id: "ACCL-POS-001"
      signal: "Comprehensive access logging with full context"
    - id: "ACCL-POS-002"
      signal: "Real-time access log analysis"
    - id: "ACCL-POS-003"
      signal: "Behavioral anomaly detection on access patterns"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory access points"
      description: |
        Identify all access points requiring logging including
        applications, APIs, infrastructure, and data stores.
      duration_estimate: "45 min"
      questions:
        - "What authentication mechanisms exist?"
        - "What resources require access logging?"
        - "What privileged access paths exist?"
      expected_findings:
        - "Access point inventory"
        - "Logging coverage map"

    - id: "2"
      name: "Review authentication logging"
      description: |
        Evaluate logging of authentication events including success,
        failure, and session management.
      duration_estimate: "45 min"
      commands:
        - purpose: "Find authentication logging"
          command: "grep -r -E '(login|auth|session).*log' --include='*.py' --include='*.ts' --include='*.java' ."
      expected_findings:
        - "Authentication logging status"
        - "Event coverage"

    - id: "3"
      name: "Assess authorization logging"
      description: |
        Review logging of authorization decisions including grants
        and denials.
      duration_estimate: "45 min"
      expected_findings:
        - "Authorization logging status"
        - "Denial logging coverage"

    - id: "4"
      name: "Evaluate log content"
      description: |
        Review sample access logs for required fields including
        user, source, timestamp, resource, and action.
      duration_estimate: "45 min"
      expected_findings:
        - "Log content assessment"
        - "Missing field identification"

    - id: "5"
      name: "Test log completeness"
      description: |
        Verify all access events are captured through controlled
        testing.
      duration_estimate: "30 min"
      expected_findings:
        - "Completeness verification"
        - "Gap identification"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "access_log_assessment"
      format: "structured"
      sections:
        - "Access Point Inventory"
        - "Authentication Logging"
        - "Authorization Logging"
        - "Log Content Analysis"
        - "Completeness Testing"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Coverage Status"
        - "Recommendations"

  confidence_guidance:
    high: "All access points reviewed with testing"
    medium: "Key systems reviewed"
    low: "Limited access to systems"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "nist-ac-17"
        priority: "required"
      - source_id: "owasp-logging"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive access review"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "accl-001"
    item: "Authentication events logged"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "All auth success and failure logged"
    expected: "Confirmed by reviewer"

  - id: "accl-002"
    item: "Authorization denials logged"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Access denials captured with context"
    expected: "Confirmed by reviewer"

  - id: "accl-003"
    item: "User identity captured"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "All access attributable to users"
    expected: "Confirmed by reviewer"

  - id: "accl-004"
    item: "Source IP included"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Access traceable to source"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["CC6.1", "CC7.2"]
    - framework: "PCI-DSS"
      controls: ["Requirement 10.2"]
    - framework: "HIPAA"
      controls: ["164.312(b)"]
    - framework: "NIST SP 800-53"
      controls: ["AU-2", "AU-3", "AC-17"]

relationships:
  commonly_combined:
    - "compliance-legal.audit-trail.audit-log-completeness"
    - "compliance-legal.audit-trail.audit-log-monitoring"
    - "compliance-legal.audit-trail.change-audit-trail"
