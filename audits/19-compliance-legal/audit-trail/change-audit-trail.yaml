# ============================================================
# AUDIT: Change Audit Trail Audit
# ============================================================
# Evaluates audit logging for configuration changes, code
# deployments, and system modifications.

audit:
  id: "compliance-legal.audit-trail.change-audit-trail"

  name: "Change Audit Trail Audit"

  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "compliance-legal"
  category_number: 19
  subcategory: "audit-trail"

  tier: "expert"
  estimated_duration: "3-5 hours"  # median: 4h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates audit trail for system changes including configuration
    modifications, code deployments, infrastructure changes, and data
    modifications. Reviews change attribution, before/after state capture,
    approval workflow logging, and rollback capability. Assesses compliance
    with change management audit requirements.

  why_it_matters: |
    Change audit trails are essential for troubleshooting, security
    investigation, and compliance. Unauthorized changes can introduce
    vulnerabilities or cause outages. Without change logging, root cause
    analysis is impossible. Compliance frameworks require documented change
    management with audit trails.

  when_to_run:
    - "During change management reviews"
    - "After implementing CI/CD pipelines"
    - "As part of compliance audits"
    - "Following incidents caused by changes"
    - "When reviewing deployment processes"

prerequisites:
  required_artifacts:
    - type: "change_logs"
      description: "Sample change audit logs"
    - type: "deployment_records"
      description: "Deployment history and logs"
    - type: "cm_policy"
      description: "Change management policy"

  access_requirements:
    - "Change management system"
    - "CI/CD pipeline logs"
    - "Configuration management tools"
    - "Deployment automation"

discovery:
  code_patterns:
    - pattern: "(change|deploy|config|update|modify)"
      type: "regex"
      scope: "source"
      purpose: "Find change-related code"
    - pattern: "(audit|log|track|history)"
      type: "regex"
      scope: "source"
      purpose: "Locate audit logging"

  file_patterns:
    - glob: "**/.github/workflows/**"
      purpose: "Find CI/CD workflows"
    - glob: "**/deploy/**"
      purpose: "Locate deployment scripts"
    - glob: "**/terraform/**"
      purpose: "Find infrastructure code"

  documents_to_review:
    - type: "Change management policy"
      purpose: "Verify requirements"
    - type: "Deployment logs"
      purpose: "Assess change tracking"

knowledge_sources:
  specifications:
    - id: "nist-cm-3"
      name: "NIST SP 800-53 CM-3 Configuration Change Control"
      url: "https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final"
      offline_cache: true
      priority: "required"

  guides:
    - id: "itil-change"
      name: "ITIL Change Management"
      url: "https://www.axelos.com/best-practice-solutions/itil"
      offline_cache: true

tooling:
  scripts:
    - id: "change-audit-check"
      language: "bash"
      purpose: "Review change audit patterns"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Git History ==="
        git log --oneline -20 2>/dev/null

        echo "=== Deployment Logs ==="
        grep -r -E "(deploy|release|rollout)" \
          --include="*.log" --include="*.yaml" . 2>/dev/null | head -20

signals:
  critical:
    - id: "CHNG-CRIT-001"
      signal: "Configuration changes not logged"
      evidence_indicators:
        - "Config changes not tracked"
        - "No before/after state capture"
        - "Cannot identify who made changes"
      explanation: |
        Configuration changes can introduce vulnerabilities or outages.
        Without logging, unauthorized changes go undetected and root
        cause analysis is impossible.
      remediation: "Implement comprehensive configuration change logging"

    - id: "CHNG-CRIT-002"
      signal: "Deployments not audited"
      evidence_indicators:
        - "No deployment records"
        - "Cannot track what was deployed when"
        - "No deployment approval trail"
      explanation: |
        Deployment audit trails are essential for security and
        troubleshooting. Cannot correlate incidents with deployments
        without records.
      remediation: "Implement deployment audit logging with full context"

    - id: "CHNG-CRIT-003"
      signal: "Database changes not tracked"
      evidence_indicators:
        - "Schema changes not logged"
        - "Data modifications not audited"
        - "No DDL change history"
      explanation: |
        Database changes affect data integrity and availability.
        Untracked database changes prevent investigation of data
        issues.
      remediation: "Implement database change auditing"

  high:
    - id: "CHNG-HIGH-001"
      signal: "No change attribution"
      explanation: "Cannot identify who made changes"
      remediation: "Capture user identity for all changes"

    - id: "CHNG-HIGH-002"
      signal: "Change approval not logged"
      explanation: "Cannot verify change was authorized"
      remediation: "Log change approval workflow"

  medium:
    - id: "CHNG-MED-001"
      signal: "Previous state not captured"
      remediation: "Log before/after state for changes"

    - id: "CHNG-MED-002"
      signal: "Infrastructure changes not tracked"
      remediation: "Implement infrastructure change logging"

  low:
    - id: "CHNG-LOW-001"
      signal: "Change logs not searchable"
      remediation: "Implement structured, searchable change logs"

  positive:
    - id: "CHNG-POS-001"
      signal: "Comprehensive change audit trail with full context"
    - id: "CHNG-POS-002"
      signal: "Automated change detection and alerting"
    - id: "CHNG-POS-003"
      signal: "Infrastructure as code with version control"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory change vectors"
      description: |
        Identify all ways systems can be changed including deployments,
        configuration, infrastructure, and data.
      duration_estimate: "45 min"
      questions:
        - "What deployment mechanisms exist?"
        - "How is configuration managed?"
        - "How are infrastructure changes made?"
        - "How are database changes applied?"
      expected_findings:
        - "Change vector inventory"
        - "Logging coverage map"

    - id: "2"
      name: "Review deployment audit trails"
      description: |
        Evaluate logging of code deployments including CI/CD
        pipelines and manual deployments.
      duration_estimate: "45 min"
      commands:
        - purpose: "Find deployment logging"
          command: "grep -r -E '(deploy|release|rollout)' --include='*.yaml' --include='*.yml' ."
      expected_findings:
        - "Deployment logging status"
        - "Pipeline audit coverage"

    - id: "3"
      name: "Assess configuration change logging"
      description: |
        Review logging of configuration changes including application
        config and system settings.
      duration_estimate: "45 min"
      expected_findings:
        - "Config change logging status"
        - "State capture assessment"

    - id: "4"
      name: "Evaluate infrastructure change tracking"
      description: |
        Review audit trails for infrastructure changes including
        cloud resources and network configuration.
      duration_estimate: "45 min"
      expected_findings:
        - "Infrastructure logging status"
        - "IaC audit trail"

    - id: "5"
      name: "Review change attribution"
      description: |
        Verify changes can be attributed to users including
        approval workflow logging.
      duration_estimate: "30 min"
      expected_findings:
        - "Attribution assessment"
        - "Approval trail status"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "change_audit_assessment"
      format: "structured"
      sections:
        - "Change Vector Inventory"
        - "Deployment Audit Trail"
        - "Configuration Change Logging"
        - "Infrastructure Change Tracking"
        - "Attribution Assessment"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Coverage Status"
        - "Recommendations"

  confidence_guidance:
    high: "All change vectors reviewed with sample verification"
    medium: "Key change mechanisms reviewed"
    low: "Limited access to change systems"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "nist-cm-3"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires thorough change trail review"
    full:
      included: true
      priority: 2

closeout_checklist:
  - id: "chng-001"
    item: "Deployment changes audited"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "All deployments logged with context"
    expected: "Confirmed by reviewer"

  - id: "chng-002"
    item: "Configuration changes logged"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Config changes tracked with before/after"
    expected: "Confirmed by reviewer"

  - id: "chng-003"
    item: "Change attribution captured"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "All changes attributable to users"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["CC8.1"]
    - framework: "PCI-DSS"
      controls: ["Requirement 10.2.7"]
    - framework: "NIST SP 800-53"
      controls: ["CM-3", "AU-12"]

relationships:
  commonly_combined:
    - "compliance-legal.audit-trail.audit-log-completeness"
    - "compliance-legal.audit-trail.access-log-audit"
    - "compliance-legal.audit-trail.audit-log-monitoring"
