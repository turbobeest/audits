# ============================================================
# AUDIT: Audit Log Completeness Audit
# ============================================================
# Evaluates whether audit logging captures all required events
# across systems, applications, and security controls.

audit:
  id: "compliance-legal.audit-trail.audit-log-completeness"

  name: "Audit Log Completeness Audit"

  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "compliance-legal"
  category_number: 19
  subcategory: "audit-trail"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates audit logging coverage to ensure all security-relevant events
    are captured. Reviews authentication events, authorization decisions,
    data access, administrative actions, system events, and application-level
    activity. Assesses log content completeness including timestamps, user
    identity, source IP, and event details.

  why_it_matters: |
    Comprehensive audit logs are essential for security monitoring, incident
    investigation, and compliance evidence. Incomplete logging creates blind
    spots where malicious activity goes undetected. Regulatory frameworks
    (SOC 2, PCI-DSS, HIPAA, GDPR) require comprehensive audit trails.
    Insufficient logging makes incident investigation impossible and may
    result in regulatory findings.

  when_to_run:
    - "During security architecture reviews"
    - "After deploying new systems or applications"
    - "As part of compliance audits"
    - "Following security incidents"
    - "During logging infrastructure updates"

prerequisites:
  required_artifacts:
    - type: "logging_configuration"
      description: "Logging configuration files"
    - type: "audit_requirements"
      description: "Audit logging requirements documentation"
    - type: "system_inventory"
      description: "Inventory of systems requiring logging"

  access_requirements:
    - "Logging configurations"
    - "Sample audit logs"
    - "Application code for logging calls"
    - "Security event definitions"
    - "Compliance requirements documentation"

discovery:
  code_patterns:
    - pattern: "(audit|log|logger|logging|event)"
      type: "regex"
      scope: "source"
      purpose: "Find logging implementations"
    - pattern: "(info|warn|error|debug|trace)"
      type: "regex"
      scope: "source"
      purpose: "Locate log level usage"

  file_patterns:
    - glob: "**/logging/**"
      purpose: "Find logging modules"
    - glob: "**/config/*log*"
      purpose: "Locate logging configurations"
    - glob: "**/audit/**"
      purpose: "Find audit implementations"

  documents_to_review:
    - type: "Logging standards"
      purpose: "Verify logging requirements"
    - type: "Security event definitions"
      purpose: "Assess event coverage"
    - type: "Compliance requirements"
      purpose: "Map regulatory requirements"

knowledge_sources:
  specifications:
    - id: "nist-800-53"
      name: "NIST SP 800-53 Rev 5"
      url: "https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r5.pdf"
      offline_cache: true
      priority: "required"
    - id: "nist-au"
      name: "NIST SP 800-53 AU Control Family"
      url: "https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final"
      offline_cache: true
      priority: "required"
    - id: "owasp-logging"
      name: "OWASP Logging Cheat Sheet"
      url: "https://cheatsheetseries.owasp.org/cheatsheets/Logging_Cheat_Sheet.html"
      offline_cache: true
      priority: "recommended"

  guides:
    - id: "soc2-cc7"
      name: "SOC 2 CC7 System Operations"
      url: "https://www.aicpa.org/resources/download/trust-services-criteria"
      offline_cache: true

tooling:
  scripts:
    - id: "logging-finder"
      language: "bash"
      purpose: "Find logging implementations"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Logging Calls ==="
        grep -r -E "(logger\.|logging\.|log\.(info|warn|error|debug))" \
          --include="*.py" --include="*.ts" --include="*.java" . 2>/dev/null | head -50

        echo "=== Audit Events ==="
        grep -r -E "(audit|security.?event|access.?log)" \
          --include="*.py" --include="*.ts" --include="*.java" . 2>/dev/null | head -30

signals:
  critical:
    - id: "LOGC-CRIT-001"
      signal: "Authentication events not logged"
      evidence_indicators:
        - "Login attempts not recorded"
        - "Failed authentications not logged"
        - "Logout events missing"
      explanation: |
        Authentication events are fundamental security logs required by
        virtually all compliance frameworks. Without authentication logging,
        account compromise cannot be detected or investigated.
      remediation: "Implement comprehensive authentication event logging"

    - id: "LOGC-CRIT-002"
      signal: "Administrative actions not logged"
      evidence_indicators:
        - "Privilege changes not recorded"
        - "Configuration changes not logged"
        - "User management not tracked"
      explanation: |
        Administrative actions are high-risk activities that must be logged.
        Unlogged admin actions cannot be audited for abuse or errors.
      remediation: "Log all administrative and privileged actions"

    - id: "LOGC-CRIT-003"
      signal: "Data access not logged for sensitive data"
      evidence_indicators:
        - "PHI/PII access not recorded"
        - "Financial data access not tracked"
        - "No data access audit trail"
      explanation: |
        HIPAA, PCI-DSS, and GDPR require data access logging for sensitive
        data. Without access logs, data breaches cannot be investigated
        and access cannot be verified.
      remediation: "Implement data access logging for sensitive data"

  high:
    - id: "LOGC-HIGH-001"
      signal: "Logs missing required fields"
      explanation: "Logs lack timestamp, user, IP, or event details"
      remediation: "Standardize log format with all required fields"

    - id: "LOGC-HIGH-002"
      signal: "Authorization decisions not logged"
      explanation: "Access grants and denials not recorded"
      remediation: "Log authorization decisions including denials"

    - id: "LOGC-HIGH-003"
      signal: "System events not logged"
      explanation: "Startup, shutdown, errors not recorded"
      remediation: "Implement system event logging"

  medium:
    - id: "LOGC-MED-001"
      signal: "Application errors not logged"
      remediation: "Implement error and exception logging"

    - id: "LOGC-MED-002"
      signal: "Log levels inconsistently applied"
      remediation: "Standardize log level usage across applications"

  low:
    - id: "LOGC-LOW-001"
      signal: "Debug logging disabled in production"
      remediation: "Ensure appropriate logging level for production"

  positive:
    - id: "LOGC-POS-001"
      signal: "Comprehensive event coverage with structured logging"
    - id: "LOGC-POS-002"
      signal: "Standardized log format across all applications"
    - id: "LOGC-POS-003"
      signal: "Correlation IDs enable request tracing"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify logging requirements"
      description: |
        Map applicable compliance and security requirements for audit
        logging to determine required event coverage.
      duration_estimate: "45 min"
      questions:
        - "What compliance frameworks apply?"
        - "What events must be logged?"
        - "What log fields are required?"
      expected_findings:
        - "Requirements mapping"
        - "Event coverage requirements"

    - id: "2"
      name: "Inventory systems and applications"
      description: |
        Identify all systems and applications requiring audit logging
        and their current logging status.
      duration_estimate: "45 min"
      expected_findings:
        - "System inventory"
        - "Logging coverage map"

    - id: "3"
      name: "Evaluate authentication logging"
      description: |
        Review logging of authentication events including logins,
        failures, lockouts, and session management.
      duration_estimate: "45 min"
      commands:
        - purpose: "Find authentication logging"
          command: "grep -r -E '(login|auth|session|logout).*log' --include='*.py' --include='*.ts' --include='*.java' ."
      expected_findings:
        - "Authentication logging status"
        - "Event coverage gaps"

    - id: "4"
      name: "Assess authorization logging"
      description: |
        Evaluate logging of authorization decisions, access grants,
        and access denials.
      duration_estimate: "30 min"
      expected_findings:
        - "Authorization logging status"
        - "Coverage gaps"

    - id: "5"
      name: "Review data access logging"
      description: |
        Evaluate logging of access to sensitive data including reads,
        writes, and exports.
      duration_estimate: "45 min"
      expected_findings:
        - "Data access logging status"
        - "Sensitive data coverage"

    - id: "6"
      name: "Verify log content"
      description: |
        Review sample logs to verify required fields are captured
        including timestamp, user, source, and details.
      duration_estimate: "30 min"
      expected_findings:
        - "Log content assessment"
        - "Missing field identification"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "logging_assessment"
      format: "structured"
      sections:
        - "Requirements Mapping"
        - "Event Coverage"
        - "Log Content Analysis"
        - "Gap Analysis"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Coverage Status"
        - "Recommendations"

  confidence_guidance:
    high: "All systems reviewed with sample log analysis"
    medium: "Key systems reviewed"
    low: "Limited system access"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "nist-au"
        priority: "required"
      - source_id: "owasp-logging"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive logging review"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "logc-001"
    item: "Authentication events logged"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Login, logout, and failure events captured"
    expected: "Confirmed by reviewer"

  - id: "logc-002"
    item: "Administrative actions logged"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Privilege and config changes recorded"
    expected: "Confirmed by reviewer"

  - id: "logc-003"
    item: "Sensitive data access logged"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "PHI/PII/financial data access recorded"
    expected: "Confirmed by reviewer"

  - id: "logc-004"
    item: "Logs contain required fields"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Timestamp, user, IP, event details present"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["CC7.2"]
    - framework: "PCI-DSS"
      controls: ["Requirement 10"]
    - framework: "HIPAA"
      controls: ["164.312(b)"]
    - framework: "NIST SP 800-53"
      controls: ["AU-2", "AU-3", "AU-12"]

relationships:
  commonly_combined:
    - "compliance-legal.audit-trail.audit-log-integrity"
    - "compliance-legal.audit-trail.audit-log-retention"
    - "compliance-legal.audit-trail.audit-log-monitoring"
