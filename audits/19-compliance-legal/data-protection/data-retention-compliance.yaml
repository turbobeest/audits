# ============================================================
# AUDIT: Data Retention Compliance Audit
# ============================================================
# Evaluates data retention policies, implementation, and compliance
# with legal requirements and minimization principles.

audit:
  id: "compliance-legal.data-protection.data-retention-compliance"

  name: "Data Retention Compliance Audit"

  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "compliance-legal"
  category_number: 19
  subcategory: "data-protection"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates data retention policies, schedules, and technical implementation
    against regulatory requirements and data minimization principles. Reviews
    retention period justifications, automated purging mechanisms, legal holds,
    backup retention, and compliance with sector-specific retention requirements.
    Assesses both over-retention (privacy risk) and under-retention (legal risk).

  why_it_matters: |
    GDPR storage limitation principle (Article 5(1)(e)) requires data kept no
    longer than necessary. Over-retention increases breach impact and may violate
    minimization requirements. Under-retention risks non-compliance with legal
    holds, tax records, and sector-specific requirements. Proper retention
    balances privacy protection with legal obligations.

  when_to_run:
    - "During data governance reviews"
    - "When implementing new data stores"
    - "After regulatory changes affecting retention"
    - "During incident response (to assess breach scope)"
    - "When receiving legal hold requests"

prerequisites:
  required_artifacts:
    - type: "retention_policy"
      description: "Documented data retention policy"
    - type: "data_inventory"
      description: "Inventory of data stores and types"
    - type: "retention_schedules"
      description: "Retention periods by data category"

  access_requirements:
    - "Data retention policy documentation"
    - "Database and storage configurations"
    - "Backup retention settings"
    - "Legal hold procedures"
    - "Data classification system"

discovery:
  code_patterns:
    - pattern: "(retention|ttl|expir|purge|delete.?after)"
      type: "regex"
      scope: "source"
      purpose: "Find retention implementation code"
    - pattern: "(cleanup|archive|prune)"
      type: "regex"
      scope: "source"
      purpose: "Locate data lifecycle management"

  file_patterns:
    - glob: "**/config/*retention*"
      purpose: "Find retention configurations"
    - glob: "**/jobs/*cleanup*"
      purpose: "Locate cleanup jobs"
    - glob: "**/policies/*retention*"
      purpose: "Find retention policy documents"

  documents_to_review:
    - type: "Data retention policy"
      purpose: "Evaluate policy completeness"
    - type: "Retention schedule"
      purpose: "Verify retention periods"
    - type: "Legal hold procedures"
      purpose: "Assess hold capability"

knowledge_sources:
  specifications:
    - id: "gdpr-art5"
      name: "GDPR Article 5 - Principles Relating to Processing"
      url: "https://gdpr-info.eu/art-5-gdpr/"
      offline_cache: true
      priority: "required"
    - id: "gdpr-art17"
      name: "GDPR Article 17 - Right to Erasure"
      url: "https://gdpr-info.eu/art-17-gdpr/"
      offline_cache: true
      priority: "required"

  guides:
    - id: "ico-retention"
      name: "ICO Storage Limitation Guidance"
      url: "https://ico.org.uk/for-organisations/uk-gdpr-guidance-and-resources/data-protection-principles/a-guide-to-the-data-protection-principles/the-principles/storage-limitation/"
      offline_cache: true
    - id: "nist-retention"
      name: "NIST SP 800-53 Data Retention Controls"
      url: "https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final"
      offline_cache: true

tooling:
  assessment_tools:
    - tool: "Retention schedule template"
      purpose: "Document retention periods by data category"
    - tool: "Data lifecycle mapping"
      purpose: "Visualize data retention flows"

  scripts:
    - id: "retention-finder"
      language: "bash"
      purpose: "Find retention configuration patterns"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Retention Settings ==="
        grep -r -E "(retention|ttl|expir|days|months|years)" \
          --include="*.yaml" --include="*.json" --include="*.conf" . 2>/dev/null

        echo "=== Cleanup Jobs ==="
        grep -r -E "(cleanup|purge|delete|prune)" \
          --include="*.py" --include="*.ts" --include="*.sql" . 2>/dev/null

signals:
  critical:
    - id: "RET-CRIT-001"
      signal: "No data retention policy exists"
      evidence_indicators:
        - "No documented retention policy"
        - "No retention periods defined"
        - "Data kept indefinitely"
      explanation: |
        GDPR storage limitation requires retention only for necessary period.
        Without policy, organization cannot demonstrate compliance and likely
        retains data beyond necessity, increasing breach impact.
      remediation: "Develop comprehensive data retention policy with schedules"

    - id: "RET-CRIT-002"
      signal: "Personal data retained indefinitely"
      evidence_indicators:
        - "No automated deletion"
        - "No retention limits configured"
        - "Data accumulates without review"
      explanation: |
        Indefinite retention violates storage limitation principle. Older data
        is less useful operationally but equally risky if breached.
      remediation: "Implement retention limits and automated deletion"

    - id: "RET-CRIT-003"
      signal: "No legal hold capability"
      evidence_indicators:
        - "Cannot suspend deletion for litigation"
        - "No hold process documented"
        - "Automated deletion continues despite holds"
      explanation: |
        Deleting data subject to litigation hold constitutes spoliation and
        exposes organization to severe sanctions. Must be able to preserve
        data when legally required.
      remediation: "Implement legal hold capability that suspends automated deletion"

  high:
    - id: "RET-HIGH-001"
      signal: "Backup retention exceeds primary retention"
      explanation: "Data effectively retained in backups beyond policy period"
      remediation: "Align backup retention with data retention requirements"

    - id: "RET-HIGH-002"
      signal: "Retention periods not justified"
      explanation: "Cannot demonstrate necessity for chosen retention periods"
      remediation: "Document business/legal justification for each retention period"

    - id: "RET-HIGH-003"
      signal: "Deletion not verified"
      explanation: "No confirmation data is actually deleted per policy"
      remediation: "Implement deletion verification and logging"

  medium:
    - id: "RET-MED-001"
      signal: "Retention policy not regularly reviewed"
      remediation: "Establish annual retention policy review"

    - id: "RET-MED-002"
      signal: "Sector-specific retention requirements not mapped"
      remediation: "Identify and document applicable legal retention requirements"

  low:
    - id: "RET-LOW-001"
      signal: "Retention metrics not tracked"
      remediation: "Track data volumes and deletion effectiveness"

  positive:
    - id: "RET-POS-001"
      signal: "Automated retention enforcement"
    - id: "RET-POS-002"
      signal: "Documented retention justifications for all data types"
    - id: "RET-POS-003"
      signal: "Regular retention compliance auditing"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Review retention policy"
      description: |
        Evaluate documented retention policy for completeness,
        clarity, and coverage of all data categories.
      duration_estimate: "45 min"
      questions:
        - "Does a formal retention policy exist?"
        - "Are retention periods specified by data category?"
        - "Are exceptions and legal holds addressed?"
      expected_findings:
        - "Policy completeness assessment"
        - "Coverage gaps identified"

    - id: "2"
      name: "Map retention requirements"
      description: |
        Identify applicable legal and regulatory retention requirements
        and verify policy alignment.
      duration_estimate: "45 min"
      questions:
        - "What legal retention requirements apply?"
        - "Does policy meet minimum requirements?"
        - "Does policy avoid over-retention?"
      expected_findings:
        - "Legal requirement mapping"
        - "Compliance gap analysis"

    - id: "3"
      name: "Assess technical implementation"
      description: |
        Review technical mechanisms for enforcing retention policy
        including TTLs, cleanup jobs, and archival processes.
      duration_estimate: "60 min"
      commands:
        - purpose: "Find retention configurations"
          command: "grep -r -E '(retention|ttl|expir)' --include='*.yaml' --include='*.json' --include='*.conf' ."
        - purpose: "Find cleanup implementations"
          command: "grep -r -E '(cleanup|purge|delete|prune)' --include='*.py' --include='*.ts' ."
      expected_findings:
        - "Implementation coverage"
        - "Technical gaps"

    - id: "4"
      name: "Evaluate backup retention"
      description: |
        Review backup retention settings and verify alignment with
        data retention policy.
      duration_estimate: "30 min"
      expected_findings:
        - "Backup retention assessment"
        - "Policy alignment status"

    - id: "5"
      name: "Test legal hold capability"
      description: |
        Verify ability to suspend automated deletion when legal
        hold is required.
      duration_estimate: "45 min"
      questions:
        - "Can deletion be suspended for specific data?"
        - "Is there a documented hold process?"
        - "Who can initiate and release holds?"
      expected_findings:
        - "Legal hold capability status"
        - "Process assessment"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "retention_assessment"
      format: "structured"
      sections:
        - "Policy Review"
        - "Legal Requirements Mapping"
        - "Technical Implementation"
        - "Backup Retention"
        - "Legal Hold Capability"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Compliance Status"
        - "Recommendations"

  confidence_guidance:
    high: "Policy, implementation, and operations verified"
    medium: "Policy and key systems reviewed"
    low: "Limited documentation access"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "gdpr-art5"
        priority: "required"
      - source_id: "ico-retention"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive retention review"
    full:
      included: true
      priority: 2

closeout_checklist:
  - id: "ret-001"
    item: "Data retention policy documented"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Formal policy with retention schedules exists"
    expected: "Confirmed by reviewer"

  - id: "ret-002"
    item: "Retention periods justified"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Business/legal rationale documented"
    expected: "Confirmed by reviewer"

  - id: "ret-003"
    item: "Automated retention enforcement implemented"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Technical mechanisms enforce policy"
    expected: "Confirmed by reviewer"

  - id: "ret-004"
    item: "Legal hold capability verified"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Can suspend deletion when required"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "GDPR"
      controls: ["Article 5(1)(e)", "Article 17"]
    - framework: "CCPA"
      controls: ["Data minimization"]
    - framework: "SOC 2"
      controls: ["CC6.5"]

relationships:
  commonly_combined:
    - "compliance-legal.data-protection.gdpr-compliance"
    - "compliance-legal.audit-trail.audit-log-retention"
    - "compliance-legal.legal-licensing.legal-hold-capability"
