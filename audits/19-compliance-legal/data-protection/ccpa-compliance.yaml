# ============================================================
# AUDIT: CCPA Compliance Audit
# ============================================================
# Evaluates California Consumer Privacy Act (CCPA/CPRA) compliance
# for organizations handling California residents' personal information.

audit:
  id: "compliance-legal.data-protection.ccpa-compliance"

  name: "CCPA Compliance Audit"

  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "compliance-legal"
  category_number: 19
  subcategory: "data-protection"

  tier: "expert"
  estimated_duration: "6-8 hours"  # median: 7h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "organizational"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: true
  parallelizable: false

description:
  what: |
    Comprehensive evaluation of CCPA/CPRA compliance including consumer rights
    implementation (right to know, delete, opt-out, correct, limit), privacy
    notice requirements, service provider agreements, "Do Not Sell/Share"
    mechanisms, and data minimization requirements. Includes assessment of
    sensitive personal information handling under CPRA.

  why_it_matters: |
    CCPA/CPRA applies to businesses meeting threshold criteria that collect
    California residents' personal information. Non-compliance exposes organizations
    to enforcement actions by the California Privacy Protection Agency (CPPA),
    civil penalties up to $7,500 per intentional violation, and private right
    of action for data breaches. California sets privacy standards often
    adopted by other states.

  when_to_run:
    - "Before launching services targeting California consumers"
    - "During annual compliance reviews"
    - "When processing practices change significantly"
    - "After receiving consumer rights requests or complaints"
    - "When CPPA issues new regulations"

prerequisites:
  required_artifacts:
    - type: "privacy_notice"
      description: "Privacy policy compliant with CCPA disclosure requirements"
    - type: "data_inventory"
      description: "Inventory of personal information collected and processed"
    - type: "service_provider_agreements"
      description: "Agreements with vendors receiving personal information"

  access_requirements:
    - "Access to privacy notices and policies"
    - "Data flow documentation"
    - "Consumer rights fulfillment systems"
    - "Service provider/contractor agreements"
    - "Opt-out mechanisms and tracking"

discovery:
  code_patterns:
    - pattern: "(ccpa|cpra|california|do.?not.?sell)"
      type: "regex"
      scope: "source"
      purpose: "Find CCPA-specific implementations"
    - pattern: "(opt.?out|consumer.?right|privacy.?request)"
      type: "regex"
      scope: "source"
      purpose: "Locate consumer rights mechanisms"
    - pattern: "(sensitive.?personal|spi|financial.?account)"
      type: "regex"
      scope: "source"
      purpose: "Find sensitive data handling"

  file_patterns:
    - glob: "**/privacy/**"
      purpose: "Find privacy-related modules"
    - glob: "**/ccpa/**"
      purpose: "Locate CCPA-specific implementations"
    - glob: "**/opt-out/**"
      purpose: "Find opt-out mechanisms"

  documents_to_review:
    - type: "Privacy Policy"
      purpose: "Verify CCPA disclosure requirements"
    - type: "Notice at Collection"
      purpose: "Assess point-of-collection notices"
    - type: "Service Provider Agreements"
      purpose: "Evaluate contractual protections"

knowledge_sources:
  specifications:
    - id: "ccpa-statute"
      name: "California Consumer Privacy Act (Civil Code 1798.100-199)"
      url: "https://leginfo.legislature.ca.gov/faces/codes_displayText.xhtml?division=3.&part=4.&lawCode=CIV&title=1.81.5"
      offline_cache: true
      priority: "required"
    - id: "cpra-statute"
      name: "California Privacy Rights Act (Proposition 24)"
      url: "https://vig.cdn.sos.ca.gov/2020/general/pdf/topl-prop24.pdf"
      offline_cache: true
      priority: "required"
    - id: "cppa-regulations"
      name: "CPPA Regulations (Title 11, Division 6)"
      url: "https://cppa.ca.gov/regulations/"
      offline_cache: true
      priority: "required"

  guides:
    - id: "cppa-guidance"
      name: "CPPA Guidance Documents"
      url: "https://cppa.ca.gov/guidance/"
      offline_cache: true
    - id: "oag-ccpa"
      name: "California AG CCPA Resources"
      url: "https://oag.ca.gov/privacy/ccpa"
      offline_cache: true

tooling:
  assessment_tools:
    - tool: "CCPA compliance checklist"
      purpose: "Structured evaluation of compliance requirements"

  scripts:
    - id: "ccpa-finder"
      language: "bash"
      purpose: "Find CCPA implementation patterns"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== CCPA Opt-Out Patterns ==="
        grep -r -E "(do.?not.?sell|opt.?out|ccpa)" \
          --include="*.tsx" --include="*.jsx" --include="*.html" . 2>/dev/null

        echo "=== Consumer Rights Handlers ==="
        grep -r -E "(consumer.?request|privacy.?request|data.?request)" \
          --include="*.py" --include="*.ts" --include="*.java" . 2>/dev/null

signals:
  critical:
    - id: "CCPA-CRIT-001"
      signal: "No 'Do Not Sell/Share My Personal Information' link"
      evidence_indicators:
        - "Website lacks required opt-out link"
        - "Opt-out mechanism not functional"
      explanation: |
        CCPA requires a clear and conspicuous "Do Not Sell or Share My Personal
        Information" link on the homepage. Absence violates Section 1798.135 and
        exposes organization to enforcement action.
      remediation: "Implement required opt-out link and functional mechanism"

    - id: "CCPA-CRIT-002"
      signal: "Consumer rights requests not fulfilled within 45 days"
      evidence_indicators:
        - "No system for tracking request deadlines"
        - "Documented failures to meet timelines"
      explanation: |
        CCPA mandates response within 45 days (extendable to 90). Failure to
        respond constitutes violation with potential penalties per incident.
      remediation: "Implement request tracking and fulfillment system"

    - id: "CCPA-CRIT-003"
      signal: "Privacy policy missing required disclosures"
      evidence_indicators:
        - "No categories of PI collected"
        - "No sources or purposes disclosed"
        - "No third-party sharing information"
      explanation: |
        CCPA Section 1798.100(a) requires specific disclosures. Incomplete
        privacy policy violates notice requirements and undermines consumer rights.
      remediation: "Update privacy policy with all required CCPA disclosures"

  high:
    - id: "CCPA-HIGH-001"
      signal: "Service provider agreements lack required clauses"
      explanation: "Contracts must prohibit selling/sharing and limit use purposes"
      remediation: "Update agreements with CCPA-compliant provisions"

    - id: "CCPA-HIGH-002"
      signal: "No verification process for consumer requests"
      explanation: "Must verify requestor identity to reasonable degree of certainty"
      remediation: "Implement appropriate verification procedures"

    - id: "CCPA-HIGH-003"
      signal: "Sensitive personal information processed without limits"
      explanation: "CPRA requires limiting use of sensitive PI to disclosed purposes"
      remediation: "Implement 'Limit Use' mechanism for sensitive PI"

  medium:
    - id: "CCPA-MED-001"
      signal: "Notice at collection incomplete"
      remediation: "Update collection notices with required categories and purposes"

    - id: "CCPA-MED-002"
      signal: "Financial incentive programs not properly disclosed"
      remediation: "Add required financial incentive disclosures and consent"

    - id: "CCPA-MED-003"
      signal: "No Global Privacy Control (GPC) recognition"
      remediation: "Implement recognition of GPC browser signal"

  low:
    - id: "CCPA-LOW-001"
      signal: "Privacy policy not updated within 12 months"
      remediation: "Establish annual privacy policy review process"

  positive:
    - id: "CCPA-POS-001"
      signal: "Automated consumer rights fulfillment system"
    - id: "CCPA-POS-002"
      signal: "GPC signal automatically honored"
    - id: "CCPA-POS-003"
      signal: "Comprehensive data inventory maintained"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Assess threshold applicability"
      description: |
        Verify CCPA applies to the organization based on revenue,
        data volume, or data sale thresholds.
      duration_estimate: "30 min"
      questions:
        - "Does organization meet $25M revenue threshold?"
        - "Does organization process 100,000+ consumers' PI?"
        - "Does organization derive 50%+ revenue from selling PI?"
      expected_findings:
        - "CCPA applicability determination"

    - id: "2"
      name: "Review privacy notices"
      description: |
        Evaluate privacy policy and notices at collection against
        CCPA disclosure requirements.
      duration_estimate: "60 min"
      questions:
        - "Are all PI categories disclosed?"
        - "Are collection purposes explained?"
        - "Are third-party sharing practices disclosed?"
        - "Are consumer rights explained?"
      expected_findings:
        - "Notice compliance status"
        - "Disclosure gaps identified"

    - id: "3"
      name: "Test consumer rights mechanisms"
      description: |
        Evaluate implementation of all consumer rights: know, delete,
        correct, opt-out, and limit sensitive PI.
      duration_estimate: "90 min"
      commands:
        - purpose: "Find rights implementation"
          command: "grep -r -E '(consumer.?right|privacy.?request|deletion.?request)' --include='*.py' --include='*.ts' ."
      expected_findings:
        - "Rights implementation completeness"
        - "Process functionality assessment"

    - id: "4"
      name: "Verify opt-out mechanisms"
      description: |
        Test "Do Not Sell/Share" link functionality, GPC recognition,
        and opt-out preference persistence.
      duration_estimate: "45 min"
      expected_findings:
        - "Opt-out mechanism functionality"
        - "GPC compliance status"

    - id: "5"
      name: "Review service provider agreements"
      description: |
        Evaluate contracts with vendors and partners for required
        CCPA provisions and restrictions.
      duration_estimate: "60 min"
      expected_findings:
        - "Contract compliance status"
        - "Missing provisions identified"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "compliance_assessment"
      format: "structured"
      sections:
        - "Applicability Analysis"
        - "Privacy Notice Review"
        - "Consumer Rights Assessment"
        - "Opt-Out Mechanism Evaluation"
        - "Service Provider Review"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Compliance Status"
        - "Recommendations"

  confidence_guidance:
    high: "Full documentation and system access, rights tested"
    medium: "Documentation reviewed, limited testing"
    low: "Partial documentation available"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "ccpa-statute"
        priority: "required"
      - source_id: "cppa-regulations"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Comprehensive compliance review required"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "ccpa-001"
    item: "Privacy policy contains all required disclosures"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "All CCPA Section 1798.100 elements present"
    expected: "Confirmed by reviewer"

  - id: "ccpa-002"
    item: "Do Not Sell/Share link present and functional"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Link on homepage, mechanism works"
    expected: "Confirmed by reviewer"

  - id: "ccpa-003"
    item: "Consumer rights request fulfillment within 45 days"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Tracking and fulfillment process verified"
    expected: "Confirmed by reviewer"

  - id: "ccpa-004"
    item: "Service provider agreements contain required clauses"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "CCPA provisions in all vendor contracts"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["consumer-facing", "data-intensive"]

  compliance_frameworks:
    - framework: "CCPA"
      controls: ["Civil Code 1798.100-199"]
    - framework: "CPRA"
      controls: ["Proposition 24 amendments"]

relationships:
  commonly_combined:
    - "compliance-legal.data-protection.gdpr-compliance"
    - "compliance-legal.data-protection.data-retention-compliance"
    - "compliance-legal.audit-trail.access-log-audit"
