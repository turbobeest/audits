# ============================================================
# AUDIT FILE: Artifact Vulnerability Scanning
# ============================================================
# Evaluates vulnerability scanning practices for artifacts
# including containers, packages, and dependencies.
# ============================================================

audit:
  id: "devops-ci-cd.artifact-management.artifact-vulnerability-scanning"
  name: "Artifact Vulnerability Scanning Assessment"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "devops-ci-cd"
  category_number: 11
  subcategory: "artifact-management"

  tier: "expert"
  estimated_duration: "3 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "security"

  default_profiles:
    - "full"
    - "security"
    - "production"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit examines vulnerability scanning practices for build artifacts
    including container images, packages, and dependencies. It evaluates
    scanning coverage, severity thresholds, remediation workflows, and
    integration with deployment gates.

  why_it_matters: |
    Deploying artifacts with known vulnerabilities exposes systems to
    exploitation. Automated scanning catches vulnerabilities before
    production, reducing security risk and enabling proactive remediation
    rather than emergency patching.

  when_to_run:
    - "When establishing security baselines"
    - "After security incidents involving known vulnerabilities"
    - "During compliance audits"
    - "Quarterly security reviews"

prerequisites:
  required_artifacts:
    - type: "ci_cd_config"
      description: "CI/CD pipeline configurations"
    - type: "scanning_results"
      description: "Historical vulnerability scan results"

  access_requirements:
    - "Read access to scanning tool configurations"
    - "Access to vulnerability scan results"
    - "Permission to view security dashboards"

discovery:
  file_patterns:
    - glob: "**/.github/workflows/*.yaml"
      purpose: "CI/CD workflow configurations"
    - glob: "**/trivy*"
      purpose: "Trivy configurations"
    - glob: "**/grype*"
      purpose: "Grype configurations"
    - glob: "**/.snyk"
      purpose: "Snyk configurations"
    - glob: "**/clair*"
      purpose: "Clair configurations"

  code_patterns:
    - pattern: "trivy|grype|snyk|clair|anchore|scan"
      type: "keyword"
      scope: "config"
      purpose: "Vulnerability scanner references"
    - pattern: "CVE|vulnerability|severity"
      type: "keyword"
      scope: "config"
      purpose: "Vulnerability handling patterns"
    - pattern: "CRITICAL|HIGH|MEDIUM"
      type: "keyword"
      scope: "config"
      purpose: "Severity threshold configurations"

knowledge_sources:
  specifications:
    - id: "cve"
      name: "CVE Program"
      url: "https://www.cve.org/"
      offline_cache: true
      priority: "required"
    - id: "cvss"
      name: "Common Vulnerability Scoring System"
      url: "https://www.first.org/cvss/"
      offline_cache: true
      priority: "required"
    - id: "nsa-supply-chain"
      name: "NSA: Securing the Software Supply Chain"
      url: "https://media.defense.gov/2022/Sep/01/2003068942/-1/-1/0/ESF_SECURING_THE_SOFTWARE_SUPPLY_CHAIN_DEVELOPERS.PDF"
      offline_cache: true
      priority: "required"

  guides:
    - id: "trivy"
      name: "Trivy Documentation"
      url: "https://aquasecurity.github.io/trivy/"
      offline_cache: true
    - id: "snyk"
      name: "Snyk Container Security"
      url: "https://snyk.io/product/container-vulnerability-management/"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "trivy"
      purpose: "Scan container images and filesystems"
      offline_capable: true
    - tool: "grype"
      purpose: "Scan container images"
      offline_capable: true
    - tool: "snyk"
      purpose: "Scan dependencies and containers"
      offline_capable: false

  infrastructure_tools:
    - tool: "trivy"
      purpose: "Scan container image"
      command: "trivy image --severity CRITICAL,HIGH image:tag"
    - tool: "grype"
      purpose: "Scan container image"
      command: "grype image:tag --fail-on high"

  scripts:
    - id: "scan-check"
      language: "bash"
      purpose: "Find scanning configurations"
      source: "inline"
      code: |
        #!/bin/bash
        # Check for vulnerability scanning
        echo "=== Scanning Configurations ==="
        grep -ri 'trivy\|grype\|snyk\|scan\|vulnerability' \
          --include='*.yaml' --include='*.yml' \
          .github/workflows/ 2>/dev/null | head -20

signals:
  critical:
    - id: "ARTVUL-CRIT-001"
      signal: "No vulnerability scanning in build pipeline"
      evidence_indicators:
        - "No scanning tools configured in CI/CD"
        - "Artifacts deployed without security scanning"
      explanation: |
        Without scanning, known vulnerabilities reach production,
        creating exploitable attack surface.
      remediation: "Implement vulnerability scanning as mandatory pipeline step"

    - id: "ARTVUL-CRIT-002"
      signal: "Critical vulnerabilities deployed to production"
      evidence_indicators:
        - "Scan results show critical CVEs but pipeline succeeds"
        - "No failure threshold configured"
      explanation: |
        Deploying critical vulnerabilities exposes systems to
        known exploits that may already have public attack code.
      remediation: "Configure pipeline to fail on critical/high severity vulnerabilities"

  high:
    - id: "ARTVUL-HIGH-001"
      signal: "Scanning results not blocking deployment"
      evidence_pattern: "fail.*on|exit.*code|threshold"
      explanation: |
        Scanning without enforcement is informational only -
        vulnerabilities are still deployed.
      remediation: "Configure scanning to fail pipeline on severity threshold breach"

    - id: "ARTVUL-HIGH-002"
      signal: "No remediation workflow for discovered vulnerabilities"
      evidence_indicators:
        - "Scan findings not tracked"
        - "No process for addressing vulnerabilities"
      explanation: |
        Without remediation tracking, vulnerabilities accumulate
        and remain exploitable indefinitely.
      remediation: "Implement vulnerability tracking with SLA-based remediation"

  medium:
    - id: "ARTVUL-MED-001"
      signal: "Base images not regularly scanned and updated"
      evidence_pattern: "base.*image|FROM"
      remediation: "Implement automated base image scanning and update process"

    - id: "ARTVUL-MED-002"
      signal: "Scanning database not kept current"
      remediation: "Configure automatic vulnerability database updates"

  low:
    - id: "ARTVUL-LOW-001"
      signal: "Scan results not retained for compliance audit"

  positive:
    - id: "ARTVUL-POS-001"
      signal: "Multi-scanner approach with consolidated reporting"
    - id: "ARTVUL-POS-002"
      signal: "Automated remediation with base image updates"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Assess scanning coverage"
      description: |
        Determine which artifact types are scanned and identify
        gaps in scanning coverage.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find scanning configurations"
          command: "grep -ri 'trivy\\|grype\\|snyk\\|scan' --include='*.yaml' --include='*.yml' . 2>/dev/null | head -25"
        - purpose: "Check workflow for scanning steps"
          command: "grep -rA5 'scan' --include='*.yaml' .github/workflows/ 2>/dev/null | head -30"
      expected_findings:
        - "Scanning tool inventory"
        - "Coverage assessment"

    - id: "2"
      name: "Review severity thresholds"
      description: |
        Evaluate configured severity thresholds and ensure
        appropriate failures are triggered.
      duration_estimate: "30 min"
      commands:
        - purpose: "Check for severity configurations"
          command: "grep -ri 'severity\\|critical\\|high\\|fail' --include='*.yaml' . 2>/dev/null | grep -i scan | head -15"
      expected_findings:
        - "Threshold configuration assessment"
        - "Enforcement status"

    - id: "3"
      name: "Evaluate database freshness"
      description: |
        Verify that vulnerability databases are kept current
        to detect recently disclosed CVEs.
      duration_estimate: "20 min"
      commands:
        - purpose: "Check for database update configs"
          command: "grep -ri 'update\\|refresh\\|database' --include='*.yaml' . 2>/dev/null | grep -i vuln | head -10"
      expected_findings:
        - "Database update frequency"
        - "Currency assessment"

    - id: "4"
      name: "Review remediation process"
      description: |
        Examine how discovered vulnerabilities are tracked
        and remediated.
      duration_estimate: "30 min"
      questions:
        - "How are vulnerability findings tracked?"
        - "What are SLAs for remediation by severity?"
        - "Is there a process for exceptions?"
      expected_findings:
        - "Remediation process documentation"
        - "SLA compliance"

    - id: "5"
      name: "Test scanning enforcement"
      description: |
        Verify that scanning actually blocks deployment when
        thresholds are breached.
      duration_estimate: "30 min"
      questions:
        - "Would a critical vulnerability block deployment?"
        - "Can scanning be bypassed?"
        - "Are bypass events logged and alerted?"
      expected_findings:
        - "Enforcement verification"
        - "Bypass vulnerability assessment"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Scanning Coverage Analysis"
        - "Vulnerability Statistics"
        - "Recommendations"

  confidence_guidance:
    high: "Direct testing of scanning enforcement with results review"
    medium: "Configuration analysis with sample scan review"
    low: "Documentation review only"

offline:
  capability: "partial"
  cache_manifest:
    knowledge:
      - source_id: "cve"
        priority: "required"
      - source_id: "cvss"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive security review"
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1

closeout_checklist:
  - id: "artvul-001"
    item: "Vulnerability scanning in all build pipelines"
    level: "CRITICAL"
    verification: "grep -ri 'trivy\\|grype\\|snyk\\|scan' --include='*.yaml' .github/workflows/ 2>/dev/null && echo 'PASS' || echo 'FAIL'"
    expected: "PASS"

  - id: "artvul-002"
    item: "Pipeline fails on critical/high vulnerabilities"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify severity threshold configured to fail pipeline"
    expected: "Confirmed by reviewer"

  - id: "artvul-003"
    item: "Vulnerability remediation process defined"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Verify tracking and SLA-based remediation process exists"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC2"
      controls: ["CC6.1", "CC7.1"]
    - framework: "PCI-DSS"
      controls: ["6.2", "6.5"]
    - framework: "NIST-CSF"
      controls: ["ID.RA-1", "PR.IP-12"]

relationships:
  commonly_combined:
    - "devops-ci-cd.artifact-management.artifact-signing"
    - "devops-ci-cd.pipeline-security.supply-chain-security"
