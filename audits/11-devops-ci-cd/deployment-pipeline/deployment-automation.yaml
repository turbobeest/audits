# ============================================================
# AUDIT: Deployment Automation
# ============================================================
# Evaluates the level and quality of deployment automation

audit:
  id: "devops-ci-cd.deployment-pipeline.deployment-automation"
  name: "Deployment Automation"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "devops-ci-cd"
  category_number: 11
  subcategory: "deployment-pipeline"

  tier: "expert"
  estimated_duration: "3 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "deployment"

  default_profiles:
    - "full"
    - "production"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Assesses the level of automation in deployment processes including
    continuous deployment pipelines, approval workflows, environment
    promotion, and deployment triggering mechanisms. Evaluates whether
    deployments are repeatable, auditable, and require minimal manual
    intervention.

  why_it_matters: |
    Manual deployments are slow, error-prone, and create bottlenecks.
    DORA research shows that elite teams deploy on demand with full
    automation. Lack of deployment automation leads to deployment fear,
    batch-size inflation, longer lead times, and higher change failure
    rates. Full automation enables frequent, reliable releases.

  when_to_run:
    - "Initial CI/CD maturity assessment"
    - "Before scaling deployment frequency"
    - "After deployment incidents"
    - "When planning automation improvements"

prerequisites:
  required_artifacts:
    - type: "ci_configuration"
      description: "CI/CD pipeline configuration files"
    - type: "deployment_scripts"
      description: "Deployment automation scripts and configurations"

  access_requirements:
    - "CI/CD system access"
    - "Deployment target access"
    - "Approval workflow configuration"

discovery:
  code_patterns:
    - pattern: "deploy|release|publish|promote"
      type: "keyword"
      scope: "config"
      purpose: "Identify deployment-related configurations"

    - pattern: "environment:|environments:|deploy.*to"
      type: "regex"
      scope: "config"
      purpose: "Environment-specific deployment config"

  file_patterns:
    - glob: "**/.github/workflows/*deploy*.yml"
      purpose: "GitHub Actions deployment workflows"

    - glob: "**/.gitlab-ci.yml"
      purpose: "GitLab CI deployment configuration"

    - glob: "**/deploy/**"
      purpose: "Deployment scripts directory"

    - glob: "**/k8s/**"
      purpose: "Kubernetes deployment manifests"

    - glob: "**/helm/**"
      purpose: "Helm charts for Kubernetes deployments"

knowledge_sources:
  guides:
    - id: "dora-research"
      name: "DORA State of DevOps"
      url: "https://dora.dev/research/"
      offline_cache: true

    - id: "cd-patterns"
      name: "Continuous Delivery Patterns"
      url: "https://continuousdelivery.com/"
      offline_cache: true

  learning_resources:
    - id: "accelerate"
      title: "Accelerate: Building High Performing Technology Organizations"
      type: "book"
      reference: "ISBN 978-1942788331"

tooling:
  infrastructure_tools:
    - tool: "kubectl"
      purpose: "Kubernetes deployment operations"
      command: "kubectl rollout status deployment/NAME"

    - tool: "helm"
      purpose: "Helm chart deployments"
      command: "helm list -A"

    - tool: "argocd"
      purpose: "GitOps deployment status"
      command: "argocd app list"

  monitoring_queries:
    - system: "CI/CD Platform"
      query: "Deployment frequency over time"
      purpose: "Measure deployment automation adoption"

  scripts:
    - id: "check-deployment-automation"
      language: "bash"
      purpose: "Verify deployment automation exists"
      source: "inline"
      code: |
        #!/bin/bash
        if find .github/workflows/ -name '*deploy*' 2>/dev/null | grep -q .; then
          echo "PASS: Deployment workflows found"
        elif [[ -f .gitlab-ci.yml ]] && grep -q 'deploy' .gitlab-ci.yml; then
          echo "PASS: GitLab deployment stages found"
        else
          echo "WARN: No deployment automation found"
        fi

signals:
  critical:
    - id: "CICD-DEPLOY-CRIT-001"
      signal: "No automated deployment pipeline exists"
      evidence_pattern: "No deployment workflows, scripts, or CI/CD deployment stages"
      explanation: |
        Without automated deployment, releases require manual intervention,
        leading to inconsistent deployments, human error, and deployment
        fear. This is the most significant barrier to deployment frequency.
      remediation: "Implement automated deployment pipeline with proper gates"

    - id: "CICD-DEPLOY-CRIT-002"
      signal: "Production deployments require SSH access and manual commands"
      evidence_pattern: "Direct SSH access used for deployments"
      explanation: |
        Manual SSH deployments are unauditable, unrepeatable, and prone
        to human error. They bypass all safety mechanisms and create
        single points of failure.
      remediation: "Replace manual deployments with automated pipelines"

  high:
    - id: "CICD-DEPLOY-HIGH-001"
      signal: "Deployment steps not idempotent"
      evidence_pattern: "Deployment scripts fail on re-run"
      explanation: |
        Non-idempotent deployments cannot be safely retried on failure,
        leading to inconsistent states and manual recovery.
      remediation: "Design all deployment steps to be safely re-runnable"

    - id: "CICD-DEPLOY-HIGH-002"
      signal: "No deployment approval workflow for production"
      evidence_pattern: "No environment protection rules or approval requirements"
      explanation: |
        Direct deployment to production without approval bypasses
        review processes and increases risk of unauthorized changes.
      remediation: "Implement approval gates for production deployments"

  medium:
    - id: "CICD-DEPLOY-MED-001"
      signal: "Deployment artifacts manually copied between environments"
      evidence_pattern: "Different artifact sources for different environments"
      remediation: "Promote same artifacts through environments"

    - id: "CICD-DEPLOY-MED-002"
      signal: "No deployment notifications configured"
      remediation: "Add notifications for deployment events"

  low:
    - id: "CICD-DEPLOY-LOW-001"
      signal: "Deployment documentation not maintained"

    - id: "CICD-DEPLOY-LOW-002"
      signal: "No deployment runbook for manual fallback"

  positive:
    - id: "CICD-DEPLOY-POS-001"
      signal: "Fully automated deployment pipeline with appropriate gates"

    - id: "CICD-DEPLOY-POS-002"
      signal: "GitOps-style deployment with infrastructure as code"

    - id: "CICD-DEPLOY-POS-003"
      signal: "Deployment frequency metrics tracked and improving"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory deployment mechanisms"
      description: |
        Document all methods used to deploy to each environment.
        Identify automated vs manual processes.
      duration_estimate: "30 min"

      commands:
        - purpose: "Find deployment workflows"
          command: |
            find . -name '*deploy*' -o -name '*release*' 2>/dev/null | head -50

        - purpose: "Check for GitOps configuration"
          command: |
            ls -la argocd/ fluxcd/ .flux* 2>/dev/null || echo "No GitOps config"

      expected_findings:
        - "Complete inventory of deployment mechanisms"

    - id: "2"
      name: "Assess automation level"
      description: |
        For each deployment target, determine what percentage of the
        deployment process is automated vs manual.
      duration_estimate: "30 min"

      questions:
        - "What triggers deployments to each environment?"
        - "How much manual intervention is required?"
        - "Are deployments idempotent and repeatable?"

      expected_findings:
        - "Automation level per environment"

    - id: "3"
      name: "Review approval workflows"
      description: |
        Analyze approval requirements for each environment.
        Check if they're enforced technically vs just policy.
      duration_estimate: "20 min"

      commands:
        - purpose: "Check GitHub environment protection"
          command: |
            gh api repos/:owner/:repo/environments 2>/dev/null | jq '.environments[] | {name, protection_rules}' || echo "Unable to query"

      expected_findings:
        - "Approval workflow configuration per environment"

    - id: "4"
      name: "Evaluate deployment pipeline robustness"
      description: |
        Check for error handling, rollback capability, and
        recovery from partial failures.
      duration_estimate: "30 min"

      commands:
        - purpose: "Check for rollback configuration"
          command: |
            grep -rE 'rollback|revert|undo' .github/workflows/ deploy/ 2>/dev/null || echo "No rollback config found"

      expected_findings:
        - "Error handling and recovery assessment"

    - id: "5"
      name: "Measure deployment frequency"
      description: |
        Gather metrics on how often deployments occur to each
        environment. Compare against industry benchmarks.
      duration_estimate: "30 min"

      commands:
        - purpose: "Count recent deployment events"
          command: |
            gh run list --workflow deploy.yml --limit 100 2>/dev/null | wc -l || echo "Unable to query"

      expected_findings:
        - "Deployment frequency metrics"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Deployment Automation Assessment"
        - "Maturity Level"
        - "Recommendations"

  confidence_guidance:
    high: "Full deployment pipeline reviewed with metrics"
    medium: "Configuration reviewed, limited runtime observation"
    low: "Based on configuration and documentation review only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "dora-research"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed pipeline analysis"
    full:
      included: true
      priority: 1
    production:
      included: true
      priority: 1

closeout_checklist:
  - id: "deployment-automation-001"
    item: "Automated deployment pipeline exists"
    level: "CRITICAL"
    verification: |
      find .github/workflows/ -name '*deploy*' -o -name '*release*' 2>/dev/null | grep -q . && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "deployment-automation-002"
    item: "Production requires approval before deployment"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify environment protection rules require approval"
    expected: "Confirmed by reviewer"

  - id: "deployment-automation-003"
    item: "Deployments are idempotent"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Verify deployment can be safely re-run without side effects"
    expected: "Confirmed by reviewer"

  - id: "deployment-automation-004"
    item: "Deployment notifications configured"
    level: "WARNING"
    verification: |
      grep -rE 'slack|discord|teams|notify|webhook' .github/workflows/*deploy* 2>/dev/null && echo "PASS" || echo "FAIL"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "DORA"
      controls: ["Deployment Frequency", "Lead Time for Changes"]
    - framework: "SOC2"
      controls: ["CC6.6", "CC7.1"]

relationships:
  commonly_combined:
    - "devops-ci-cd.deployment-pipeline.deployment-strategy"
    - "devops-ci-cd.deployment-pipeline.rollback-capability"
