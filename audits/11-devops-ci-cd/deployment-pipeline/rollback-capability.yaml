# ============================================================
# AUDIT: Rollback Capability
# ============================================================
# Evaluates ability to safely revert deployments

audit:
  id: "devops-ci-cd.deployment-pipeline.rollback-capability"
  name: "Rollback Capability"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "devops-ci-cd"
  category_number: 11
  subcategory: "deployment-pipeline"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "deployment"

  default_profiles:
    - "full"
    - "production"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Assesses the ability to quickly and safely rollback deployments
    when issues are discovered. Includes evaluation of rollback
    automation, artifact retention, database migration reversibility,
    configuration rollback, and rollback testing procedures.

  why_it_matters: |
    Rollback capability is the safety net for deployments. Without
    reliable rollback, teams hesitate to deploy, leading to larger
    batches and higher risk. MTTR (mean time to recovery) depends
    heavily on rollback speed. A deployment without a tested rollback
    plan is a deployment without a safety net.

  when_to_run:
    - "Pre-deployment readiness checks"
    - "After deployment incidents"
    - "Quarterly reliability reviews"
    - "Before major releases"

prerequisites:
  required_artifacts:
    - type: "deployment_configuration"
      description: "Deployment automation and configuration"
    - type: "artifact_repository"
      description: "Access to historical deployment artifacts"

  access_requirements:
    - "Deployment system access"
    - "Artifact repository access"
    - "Database migration history"

discovery:
  code_patterns:
    - pattern: "rollback|revert|undo|previous.*version"
      type: "regex"
      scope: "config"
      purpose: "Identify rollback procedures"

    - pattern: "revision.*history|history.*limit"
      type: "regex"
      scope: "config"
      purpose: "Kubernetes revision history settings"

  file_patterns:
    - glob: "**/migrations/**"
      purpose: "Database migration files"

    - glob: "**/rollback*"
      purpose: "Rollback scripts"

    - glob: "**/runbooks/**"
      purpose: "Operational runbooks including rollback"

knowledge_sources:
  guides:
    - id: "k8s-rollback"
      name: "Kubernetes Rollback"
      url: "https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#rolling-back-a-deployment"
      offline_cache: true

    - id: "database-migrations"
      name: "Database Migration Best Practices"
      url: "https://www.prisma.io/dataguide/types/relational/data-migrations"
      offline_cache: true

tooling:
  infrastructure_tools:
    - tool: "kubectl"
      purpose: "Kubernetes rollback operations"
      command: "kubectl rollout undo deployment/NAME"

    - tool: "helm"
      purpose: "Helm release rollback"
      command: "helm rollback RELEASE REVISION"

  scripts:
    - id: "check-rollback-capability"
      language: "bash"
      purpose: "Verify rollback artifacts available"
      source: "inline"
      code: |
        #!/bin/bash
        # Check if previous deployment artifacts exist
        if kubectl rollout history deployment/app 2>/dev/null | grep -q REVISION; then
          echo "PASS: Rollback history available"
        else
          echo "WARN: No rollback history found"
        fi

signals:
  critical:
    - id: "CICD-ROLLBACK-CRIT-001"
      signal: "No rollback procedure exists"
      evidence_pattern: "No documented or automated rollback capability"
      explanation: |
        Without rollback capability, the only recovery options are
        forward-fix (under pressure) or extended outage. This creates
        deployment fear and extends incident duration.
      remediation: "Implement and test automated rollback procedures"

    - id: "CICD-ROLLBACK-CRIT-002"
      signal: "Database migrations are not reversible"
      evidence_pattern: "Missing down migrations or destructive migrations"
      explanation: |
        Irreversible database migrations prevent application rollback
        since the old code cannot work with the new schema. This
        turns every deployment into a one-way door.
      remediation: "Ensure all migrations have tested down migrations"

  high:
    - id: "CICD-ROLLBACK-HIGH-001"
      signal: "Previous deployment artifacts not retained"
      evidence_pattern: "revisionHistoryLimit: 0 or single artifact retention"
      explanation: |
        Without retained artifacts, rollback requires rebuilding the
        previous version, which may not be possible or may take too
        long during an incident.
      remediation: "Retain at least 5 previous deployment versions"

    - id: "CICD-ROLLBACK-HIGH-002"
      signal: "Rollback procedure not tested"
      evidence_pattern: "No evidence of rollback testing or drills"
      explanation: |
        Untested rollback procedures fail when needed most. Teams
        discover issues during actual incidents, extending outages.
      remediation: "Regularly test rollback procedures in non-production"

  medium:
    - id: "CICD-ROLLBACK-MED-001"
      signal: "Rollback requires manual steps"
      evidence_pattern: "Runbook with manual procedures instead of automation"
      remediation: "Automate rollback to single command or button click"

    - id: "CICD-ROLLBACK-MED-002"
      signal: "Configuration changes not versioned for rollback"
      remediation: "Version configuration alongside code deployments"

  low:
    - id: "CICD-ROLLBACK-LOW-001"
      signal: "Rollback time not measured or tracked"

    - id: "CICD-ROLLBACK-LOW-002"
      signal: "No automatic rollback on health check failure"

  positive:
    - id: "CICD-ROLLBACK-POS-001"
      signal: "One-click or automatic rollback capability"

    - id: "CICD-ROLLBACK-POS-002"
      signal: "Rollback tested regularly in drills"

    - id: "CICD-ROLLBACK-POS-003"
      signal: "All database migrations are reversible"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Assess rollback automation"
      description: |
        Evaluate the available rollback mechanisms and their
        level of automation.
      duration_estimate: "20 min"

      commands:
        - purpose: "Check Kubernetes revision history"
          command: |
            kubectl get deployment -o yaml | grep -A 2 'revisionHistoryLimit' 2>/dev/null || echo "Not Kubernetes or no access"

        - purpose: "Check for rollback scripts"
          command: |
            find . -name '*rollback*' -o -name '*revert*' 2>/dev/null | head -10

      expected_findings:
        - "Available rollback mechanisms"

    - id: "2"
      name: "Verify artifact retention"
      description: |
        Check that previous deployment artifacts are retained
        and accessible for rollback.
      duration_estimate: "20 min"

      commands:
        - purpose: "Check Docker image retention"
          command: |
            # Example: check container registry retention
            echo "Check container registry for image retention policy"

        - purpose: "Check Helm release history"
          command: |
            helm history RELEASE 2>/dev/null || echo "No Helm releases"

      expected_findings:
        - "Artifact retention status"

    - id: "3"
      name: "Analyze database migration reversibility"
      description: |
        Check that database migrations can be reversed without
        data loss or schema incompatibility.
      duration_estimate: "30 min"

      commands:
        - purpose: "Find migration files"
          command: |
            find . -path '*/migrations/*' -name '*.sql' -o -path '*/migrations/*' -name '*.py' 2>/dev/null | head -20

        - purpose: "Check for down migrations"
          command: |
            find . -path '*/migrations/*' -name '*down*' 2>/dev/null | head -10

      expected_findings:
        - "Migration reversibility assessment"

    - id: "4"
      name: "Review rollback testing"
      description: |
        Determine if rollback procedures are regularly tested
        and what the results were.
      duration_estimate: "20 min"

      questions:
        - "When was rollback last tested?"
        - "What is the documented rollback time?"
        - "Have there been rollback failures in the past?"

      expected_findings:
        - "Rollback testing status and history"

    - id: "5"
      name: "Evaluate configuration rollback"
      description: |
        Assess whether configuration changes can be rolled back
        along with code changes.
      duration_estimate: "15 min"

      commands:
        - purpose: "Check for ConfigMap/Secret versioning"
          command: |
            grep -r 'ConfigMap\|Secret' k8s/ helm/ --include='*.yaml' 2>/dev/null | head -10

      expected_findings:
        - "Configuration rollback capability"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Rollback Capability Assessment"
        - "Migration Reversibility"
        - "Recommendations"

  confidence_guidance:
    high: "Rollback tested during audit with full migration analysis"
    medium: "Configuration reviewed, rollback not actually tested"
    low: "Based on documentation review only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "k8s-rollback"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires testing and detailed analysis"
    full:
      included: true
      priority: 1
    production:
      included: true
      priority: 1

closeout_checklist:
  - id: "rollback-capability-001"
    item: "Rollback procedure documented and automated"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify rollback can be executed with single command"
    expected: "Confirmed by reviewer"

  - id: "rollback-capability-002"
    item: "Previous versions retained for rollback"
    level: "CRITICAL"
    verification: |
      kubectl get deployment -o yaml 2>/dev/null | grep 'revisionHistoryLimit' | grep -v ': 0' && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "rollback-capability-003"
    item: "Database migrations are reversible"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify down migrations exist and are tested"
    expected: "Confirmed by reviewer"

  - id: "rollback-capability-004"
    item: "Rollback tested within last quarter"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Check for evidence of rollback testing"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "DORA"
      controls: ["Time to Restore Service"]
    - framework: "SOC2"
      controls: ["CC7.4", "CC7.5"]

relationships:
  commonly_combined:
    - "devops-ci-cd.deployment-pipeline.deployment-strategy"
    - "devops-ci-cd.deployment-pipeline.deployment-verification"
