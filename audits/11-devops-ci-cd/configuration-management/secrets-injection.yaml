# ============================================================
# AUDIT: Secrets Injection
# ============================================================
# Evaluates how secrets are provided to applications

audit:
  id: "devops-ci-cd.configuration-management.secrets-injection"
  name: "Secrets Injection"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "devops-ci-cd"
  category_number: 11
  subcategory: "configuration-management"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "security"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Assesses how secrets (passwords, API keys, tokens, certificates)
    are provided to applications at runtime. Evaluates secret storage
    mechanisms, injection methods, rotation capabilities, and access
    controls. Includes assessment of secrets management tools and
    integration with deployment pipelines.

  why_it_matters: |
    Poorly managed secrets are a leading cause of security breaches.
    Secrets in environment variables may leak via debugging, logging,
    or error messages. Secrets in ConfigMaps or files may have overly
    broad access. Proper secrets management provides encryption,
    access control, audit logging, and rotation capability.

  when_to_run:
    - "Initial security audit"
    - "When implementing secrets management"
    - "After security incidents"
    - "Quarterly security reviews"

prerequisites:
  required_artifacts:
    - type: "deployment_configuration"
      description: "Kubernetes manifests or deployment config"
    - type: "secrets_configuration"
      description: "Secrets management tool configuration"

  access_requirements:
    - "Deployment configuration access"
    - "Secrets management system access (read-only)"

discovery:
  code_patterns:
    - pattern: "vault|secretsmanager|keyvault|sealed-secrets"
      type: "regex"
      scope: "config"
      purpose: "Identify secrets management tools"

    - pattern: "secretKeyRef|secretRef|ExternalSecret"
      type: "regex"
      scope: "config"
      purpose: "Kubernetes secret references"

  file_patterns:
    - glob: "**/k8s/**/secret*.yaml"
      purpose: "Kubernetes Secret definitions"

    - glob: "**/*vault*.yaml"
      purpose: "HashiCorp Vault configuration"

    - glob: "**/external-secrets*.yaml"
      purpose: "External Secrets Operator configuration"

knowledge_sources:
  guides:
    - id: "vault"
      name: "HashiCorp Vault Documentation"
      url: "https://developer.hashicorp.com/vault/docs"
      offline_cache: true

    - id: "k8s-secrets"
      name: "Kubernetes Secrets Management"
      url: "https://kubernetes.io/docs/concepts/configuration/secret/"
      offline_cache: true

    - id: "external-secrets"
      name: "External Secrets Operator"
      url: "https://external-secrets.io/"
      offline_cache: true

tooling:
  infrastructure_tools:
    - tool: "kubectl"
      purpose: "Inspect secret references"
      command: "kubectl get pods -o yaml | grep -A5 secretKeyRef"

    - tool: "vault"
      purpose: "Vault secret management"
      command: "vault secrets list"

  scripts:
    - id: "check-secrets-injection"
      language: "bash"
      purpose: "Identify secrets injection patterns"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Secret References in Deployments ==="
        grep -r 'secretKeyRef\|secretRef' k8s/ helm/ --include='*.yaml' 2>/dev/null | head -20
        echo "=== External Secrets ==="
        grep -r 'ExternalSecret' k8s/ --include='*.yaml' 2>/dev/null | head -10

signals:
  critical:
    - id: "CICD-SECRET-CRIT-001"
      signal: "Secrets stored in plain text ConfigMaps"
      evidence_pattern: "Passwords or API keys in ConfigMap instead of Secret"
      explanation: |
        ConfigMaps are not encrypted and have different access controls
        than Secrets. Storing secrets in ConfigMaps exposes them to
        anyone with ConfigMap read access.
      remediation: "Move sensitive values to Kubernetes Secrets or external secrets manager"

    - id: "CICD-SECRET-CRIT-002"
      signal: "Secrets hardcoded in Kubernetes manifests"
      evidence_pattern: "Base64 encoded secrets in YAML files committed to git"
      explanation: |
        Base64 is encoding, not encryption. Secrets in manifests are
        exposed to anyone with repository access and persist in git
        history.
      remediation: "Use sealed-secrets, external-secrets-operator, or Vault"

  high:
    - id: "CICD-SECRET-HIGH-001"
      signal: "No secrets management system in use"
      evidence_pattern: "All secrets stored directly in Kubernetes Secrets"
      explanation: |
        Native Kubernetes Secrets have limited features: no rotation,
        no dynamic secrets, no audit logging, and etcd storage may
        not be encrypted.
      remediation: "Implement secrets management (Vault, AWS Secrets Manager, etc.)"

    - id: "CICD-SECRET-HIGH-002"
      signal: "Secrets passed as environment variables"
      evidence_pattern: "Sensitive values in env: instead of envFrom with secretKeyRef"
      explanation: |
        Environment variables may leak through logs, debugging endpoints,
        or error messages. They're also visible in process listings.
      remediation: "Use file-based secret mounting or secure injection methods"

  medium:
    - id: "CICD-SECRET-MED-001"
      signal: "No secret rotation mechanism"
      evidence_pattern: "Static secrets without rotation capability"
      remediation: "Implement secret rotation with minimal application changes"

    - id: "CICD-SECRET-MED-002"
      signal: "Broad secret access - not least privilege"
      evidence_pattern: "All pods can access all secrets"
      remediation: "Restrict secret access to only pods that need them"

  low:
    - id: "CICD-SECRET-LOW-001"
      signal: "No secret access auditing"

    - id: "CICD-SECRET-LOW-002"
      signal: "Secret names reveal purpose"

  positive:
    - id: "CICD-SECRET-POS-001"
      signal: "External secrets management with dynamic secrets"

    - id: "CICD-SECRET-POS-002"
      signal: "Automatic secret rotation configured"

    - id: "CICD-SECRET-POS-003"
      signal: "Secrets mounted as files, not environment variables"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify secrets management approach"
      description: |
        Determine what tools and methods are used for
        secrets management.
      duration_estimate: "15 min"

      commands:
        - purpose: "Check for secrets management tools"
          command: |
            grep -rE 'vault|secretsmanager|keyvault|sealed-secrets|external-secrets' . --include='*.yaml' 2>/dev/null | head -20

        - purpose: "Find Kubernetes Secret definitions"
          command: |
            grep -rn 'kind: Secret' k8s/ helm/ --include='*.yaml' 2>/dev/null | head -10

      expected_findings:
        - "Secrets management approach"

    - id: "2"
      name: "Check for hardcoded secrets"
      description: |
        Scan for secrets that may be hardcoded in
        configuration files or manifests.
      duration_estimate: "20 min"

      commands:
        - purpose: "Find inline secret data"
          command: |
            grep -rB 5 -A 10 'kind: Secret' k8s/ helm/ --include='*.yaml' 2>/dev/null | grep -E 'data:|stringData:' | head -10

        - purpose: "Check for base64 in manifests"
          command: |
            grep -rn '^[A-Za-z0-9+/]\{20,\}=*$' k8s/ helm/ --include='*.yaml' 2>/dev/null | head -10

      expected_findings:
        - "Potential hardcoded secrets"

    - id: "3"
      name: "Review secrets injection methods"
      description: |
        Examine how secrets are injected into running
        containers (env vars, files, init containers).
      duration_estimate: "20 min"

      commands:
        - purpose: "Find secret references in pods"
          command: |
            grep -rA 5 'secretKeyRef\|secretRef' k8s/ helm/ --include='*.yaml' 2>/dev/null | head -30

        - purpose: "Check for volume mounts"
          command: |
            grep -rB 2 -A 5 'secret:' k8s/ helm/ --include='*.yaml' 2>/dev/null | head -30

      expected_findings:
        - "Secrets injection patterns"

    - id: "4"
      name: "Assess access controls"
      description: |
        Review who has access to secrets and whether
        access follows least privilege.
      duration_estimate: "20 min"

      questions:
        - "Can all pods access all secrets?"
        - "Who can read secrets in the namespace?"
        - "Is secret access audited?"

      expected_findings:
        - "Secrets access control assessment"

    - id: "5"
      name: "Check rotation capability"
      description: |
        Determine if secrets can be rotated without
        application changes or restarts.
      duration_estimate: "15 min"

      questions:
        - "How are secrets rotated?"
        - "Do applications reload secrets automatically?"
        - "What is the rotation frequency?"

      expected_findings:
        - "Secrets rotation capability"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Secrets Management Assessment"
        - "Injection Method Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Full secrets configuration reviewed with access control analysis"
    medium: "Configuration reviewed, access controls not fully verified"
    low: "Based on configuration file review only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "vault"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed security analysis"
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1

closeout_checklist:
  - id: "secrets-injection-001"
    item: "No secrets hardcoded in manifests"
    level: "CRITICAL"
    verification: |
      grep -rn 'stringData:' k8s/ helm/ --include='*.yaml' 2>/dev/null && echo "FAIL: stringData found" || echo "PASS"
    expected: "PASS"

  - id: "secrets-injection-002"
    item: "Secrets management tool in use"
    level: "CRITICAL"
    verification: |
      grep -rE 'vault|ExternalSecret|sealed-secret' . --include='*.yaml' 2>/dev/null && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "secrets-injection-003"
    item: "Secrets not stored in ConfigMaps"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify sensitive values are not in ConfigMaps"
    expected: "Confirmed by reviewer"

  - id: "secrets-injection-004"
    item: "Secret rotation mechanism exists"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Verify secrets can be rotated without app changes"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC2"
      controls: ["CC6.1", "CC6.7"]
    - framework: "CIS"
      controls: ["Kubernetes Benchmark 5.4"]
    - framework: "PCI-DSS"
      controls: ["3.4", "3.5"]

relationships:
  commonly_combined:
    - "devops-ci-cd.configuration-management.config-externalization"
    - "devops-ci-cd.configuration-management.config-encryption"
