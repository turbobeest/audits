# ============================================================
# AUDIT: Config Validation
# ============================================================
# Evaluates configuration validation and error prevention

audit:
  id: "devops-ci-cd.configuration-management.config-validation"
  name: "Config Validation"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "devops-ci-cd"
  category_number: 11
  subcategory: "configuration-management"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "yes"
  severity: "high"
  scope: "config"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Assesses how configuration is validated before deployment including
    schema validation, type checking, value constraints, cross-field
    validation, and integration testing. Evaluates whether invalid
    configuration is caught in CI before reaching production.

  why_it_matters: |
    Invalid configuration can cause application startup failures,
    runtime crashes, security vulnerabilities, or subtle bugs.
    Validation in CI catches typos, missing required fields, invalid
    values, and inconsistencies before deployment, preventing outages
    and reducing debugging time.

  when_to_run:
    - "Initial configuration audit"
    - "When implementing config validation"
    - "After configuration-related incidents"
    - "Quarterly reliability reviews"

prerequisites:
  required_artifacts:
    - type: "configuration_files"
      description: "Application and deployment configuration"
    - type: "ci_configuration"
      description: "CI/CD pipeline configuration"

  access_requirements:
    - "Configuration repository access"
    - "CI/CD configuration access"

discovery:
  code_patterns:
    - pattern: "schema|validate|zod|joi|ajv|jsonschema"
      type: "regex"
      scope: "source"
      purpose: "Identify validation library usage"

    - pattern: "kubeval|kubeconform|conftest"
      type: "regex"
      scope: "config"
      purpose: "Kubernetes manifest validation"

  file_patterns:
    - glob: "**/*schema*.json"
      purpose: "JSON Schema definitions"

    - glob: "**/*.schema.ts"
      purpose: "TypeScript schema definitions"

    - glob: "**/config.schema*"
      purpose: "Configuration schema files"

knowledge_sources:
  guides:
    - id: "json-schema"
      name: "JSON Schema Specification"
      url: "https://json-schema.org/"
      offline_cache: true

    - id: "kubeconform"
      name: "Kubeconform Documentation"
      url: "https://github.com/yannh/kubeconform"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "kubeconform"
      purpose: "Kubernetes manifest validation"
      offline_capable: true

    - tool: "kubeval"
      purpose: "Kubernetes manifest validation"
      offline_capable: true

    - tool: "ajv"
      purpose: "JSON Schema validation"
      offline_capable: true

    - tool: "yamllint"
      purpose: "YAML syntax validation"
      offline_capable: true

  scripts:
    - id: "check-config-validation"
      language: "bash"
      purpose: "Check for config validation in CI"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Config validation in CI ==="
        grep -rE 'kubeval|kubeconform|validate|schema' .github/workflows/ .gitlab-ci.yml 2>/dev/null | head -20
        echo "=== Schema files ==="
        find . -name '*schema*' 2>/dev/null | head -10

signals:
  critical:
    - id: "CICD-CONFIGVAL-CRIT-001"
      signal: "No configuration validation in CI pipeline"
      evidence_pattern: "No kubeval, kubeconform, or schema validation steps"
      explanation: |
        Without CI validation, invalid configuration deploys to production.
        Syntax errors, missing fields, and type mismatches are discovered
        at runtime, causing outages.
      remediation: "Add configuration validation to CI pipeline"

    - id: "CICD-CONFIGVAL-CRIT-002"
      signal: "Application accepts invalid configuration silently"
      evidence_pattern: "No startup validation or schema checking"
      explanation: |
        Applications that silently accept invalid config may run with
        wrong settings, causing subtle bugs or security issues that
        are hard to diagnose.
      remediation: "Implement fail-fast configuration validation at startup"

  high:
    - id: "CICD-CONFIGVAL-HIGH-001"
      signal: "Kubernetes manifests not validated against schemas"
      evidence_pattern: "No kubeconform or kubeval in CI"
      explanation: |
        Invalid Kubernetes manifests may be rejected by the API server,
        causing deployment failures. Validation catches this earlier.
      remediation: "Add kubeconform or similar to validate K8s manifests"

    - id: "CICD-CONFIGVAL-HIGH-002"
      signal: "No validation of required environment variables"
      evidence_pattern: "App crashes when env vars missing instead of validating"
      explanation: |
        Missing environment variables discovered at runtime cause
        startup failures that could be caught during deployment.
      remediation: "Validate required configuration at application startup"

  medium:
    - id: "CICD-CONFIGVAL-MED-001"
      signal: "No cross-field validation"
      evidence_pattern: "Fields validated independently, combinations not checked"
      remediation: "Add validation for interdependent configuration fields"

    - id: "CICD-CONFIGVAL-MED-002"
      signal: "Config validation errors not descriptive"
      evidence_pattern: "Generic 'invalid config' without specifics"
      remediation: "Provide clear error messages indicating what's wrong"

  low:
    - id: "CICD-CONFIGVAL-LOW-001"
      signal: "No config validation documentation"

    - id: "CICD-CONFIGVAL-LOW-002"
      signal: "Schema definitions not versioned with config"

  positive:
    - id: "CICD-CONFIGVAL-POS-001"
      signal: "Comprehensive schema validation in CI"

    - id: "CICD-CONFIGVAL-POS-002"
      signal: "Application validates all config at startup"

    - id: "CICD-CONFIGVAL-POS-003"
      signal: "Clear error messages for invalid configuration"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Check CI validation"
      description: |
        Identify configuration validation steps in
        CI/CD pipeline.
      duration_estimate: "15 min"

      commands:
        - purpose: "Find validation in CI"
          command: |
            grep -rE 'kubeval|kubeconform|validate|lint|schema' .github/workflows/ .gitlab-ci.yml 2>/dev/null | head -20

      expected_findings:
        - "CI validation configuration"

    - id: "2"
      name: "Identify schema definitions"
      description: |
        Find any schema definitions used for
        configuration validation.
      duration_estimate: "15 min"

      commands:
        - purpose: "Find schema files"
          command: |
            find . -name '*schema*' -o -name '*.schema.ts' -o -name '*.schema.json' 2>/dev/null | head -20

        - purpose: "Check for validation libraries"
          command: |
            grep -rE 'zod|joi|ajv|yup|class-validator' package.json requirements.txt 2>/dev/null

      expected_findings:
        - "Schema definitions and validation libraries"

    - id: "3"
      name: "Review application startup validation"
      description: |
        Check if the application validates configuration
        at startup and fails fast on errors.
      duration_estimate: "25 min"

      commands:
        - purpose: "Find config validation code"
          command: |
            grep -rn 'validate.*config\|config.*validate\|required.*env' src/ app/ --include='*.ts' --include='*.js' --include='*.py' 2>/dev/null | head -20

      expected_findings:
        - "Application startup validation"

    - id: "4"
      name: "Test validation behavior"
      description: |
        If possible, test what happens when invalid
        configuration is provided.
      duration_estimate: "20 min"

      questions:
        - "What happens with missing required fields?"
        - "What happens with wrong types?"
        - "Are error messages helpful?"

      expected_findings:
        - "Validation behavior assessment"

    - id: "5"
      name: "Assess validation coverage"
      description: |
        Evaluate what percentage of configuration
        is covered by validation.
      duration_estimate: "15 min"

      questions:
        - "Are all required fields validated?"
        - "Are value ranges checked?"
        - "Are cross-field dependencies validated?"

      expected_findings:
        - "Validation coverage assessment"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "CI Validation Assessment"
        - "Application Validation Review"
        - "Recommendations"

  confidence_guidance:
    high: "Full validation pipeline tested with invalid inputs"
    medium: "Configuration reviewed, validation not tested"
    low: "Based on file presence only"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "json-schema"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: true
      priority: 2
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "config-validation-001"
    item: "Config validation in CI pipeline"
    level: "CRITICAL"
    verification: |
      grep -rE 'kubeval|kubeconform|validate|schema' .github/workflows/ .gitlab-ci.yml 2>/dev/null && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "config-validation-002"
    item: "Application validates config at startup"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify app fails fast on invalid configuration"
    expected: "Confirmed by reviewer"

  - id: "config-validation-003"
    item: "Kubernetes manifests validated"
    level: "BLOCKING"
    verification: |
      grep -rE 'kubeconform|kubeval' .github/workflows/ 2>/dev/null && echo "PASS" || echo "FAIL"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC2"
      controls: ["CC6.1"]

relationships:
  commonly_combined:
    - "devops-ci-cd.configuration-management.config-versioning"
    - "devops-ci-cd.configuration-management.config-externalization"
