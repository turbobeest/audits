# ============================================================
# AUDIT FILE: Pipeline Audit Logging
# ============================================================
# Evaluates audit logging practices for CI/CD pipelines
# to support security monitoring and incident investigation.
# ============================================================

audit:
  id: "devops-ci-cd.pipeline-security.pipeline-audit-logging"
  name: "Pipeline Audit Logging Assessment"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "devops-ci-cd"
  category_number: 11
  subcategory: "pipeline-security"

  tier: "expert"
  estimated_duration: "3 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "security"

  default_profiles:
    - "full"
    - "security"
    - "production"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit examines audit logging practices for CI/CD pipelines
    including what events are logged, log retention, log integrity,
    and monitoring/alerting. It evaluates whether logs support
    security monitoring and incident investigation.

  why_it_matters: |
    Inadequate pipeline logging leaves security incidents undetected
    and makes forensic investigation impossible. Comprehensive audit
    logging is essential for detecting attacks, demonstrating compliance,
    and understanding pipeline behavior.

  when_to_run:
    - "When establishing security monitoring"
    - "After security incidents"
    - "During compliance audits"
    - "Quarterly security reviews"

prerequisites:
  required_artifacts:
    - type: "logging_config"
      description: "Logging configurations and policies"
    - type: "audit_logs"
      description: "Sample audit logs"

  access_requirements:
    - "Read access to logging configurations"
    - "Access to audit log storage"
    - "Permission to view monitoring dashboards"

discovery:
  file_patterns:
    - glob: "**/.github/workflows/*.yaml"
      purpose: "CI/CD workflow configurations"
    - glob: "**/logging*"
      purpose: "Logging configurations"
    - glob: "**/audit*"
      purpose: "Audit configurations"

  code_patterns:
    - pattern: "audit|log|trace|monitor"
      type: "keyword"
      scope: "config"
      purpose: "Logging-related configurations"
    - pattern: "retention|expire|ttl"
      type: "keyword"
      scope: "config"
      purpose: "Log retention patterns"

knowledge_sources:
  guides:
    - id: "github-audit-log"
      name: "GitHub Audit Log"
      url: "https://docs.github.com/en/organizations/keeping-your-organization-secure/managing-security-settings-for-your-organization/reviewing-the-audit-log-for-your-organization"
      offline_cache: true
    - id: "gitlab-audit"
      name: "GitLab Audit Events"
      url: "https://docs.gitlab.com/ee/administration/audit_events.html"
      offline_cache: true

  specifications:
    - id: "nist-audit"
      name: "NIST Audit and Accountability"
      url: "https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final"
      offline_cache: true
      priority: "required"
    - id: "nsa-cicd-security"
      name: "NSA/CISA: Defending CI/CD Environments"
      url: "https://media.defense.gov/2023/Jun/28/2003249466/-1/-1/0/CSI_DEFENDING_CI_CD_ENVIRONMENTS.PDF"
      offline_cache: true
      priority: "required"
    - id: "nsa-supply-chain"
      name: "NSA: Securing the Software Supply Chain"
      url: "https://media.defense.gov/2022/Sep/01/2003068942/-1/-1/0/ESF_SECURING_THE_SOFTWARE_SUPPLY_CHAIN_DEVELOPERS.PDF"
      offline_cache: true
      priority: "required"
    - id: "nist-800-218"
      name: "NIST SP 800-218: SSDF"
      url: "https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-218.pdf"
      offline_cache: true
      priority: "required"

tooling:
  infrastructure_tools:
    - tool: "gh"
      purpose: "Access GitHub audit logs"
      command: "gh api orgs/{org}/audit-log --paginate"
    - tool: "glab"
      purpose: "Access GitLab audit logs"
      command: "glab api audit_events"

  scripts:
    - id: "audit-log-check"
      language: "bash"
      purpose: "Check for audit logging configuration"
      source: "inline"
      code: |
        #!/bin/bash
        # Check for audit logging patterns
        echo "=== Audit Logging Configurations ==="
        grep -ri 'audit\|log\|monitor' \
          --include='*.yaml' --include='*.yml' \
          . 2>/dev/null | head -20

signals:
  critical:
    - id: "PIPLOG-CRIT-001"
      signal: "Pipeline executions not logged"
      evidence_indicators:
        - "No audit trail of pipeline runs"
        - "Build history retention disabled"
      explanation: |
        Without execution logs, unauthorized or malicious pipeline
        runs cannot be detected or investigated.
      remediation: "Enable comprehensive pipeline execution logging with retention"

    - id: "PIPLOG-CRIT-002"
      signal: "Audit logs can be modified or deleted"
      evidence_indicators:
        - "Logs stored without integrity protection"
        - "Pipeline runners can delete their own logs"
      explanation: |
        Mutable logs enable attackers to cover their tracks,
        undermining security monitoring and forensics.
      remediation: "Implement immutable log storage with integrity verification"

  high:
    - id: "PIPLOG-HIGH-001"
      signal: "Secret access not logged"
      evidence_indicators:
        - "Secret retrieval events not captured"
        - "No audit trail for credential usage"
      explanation: |
        Unlogged secret access makes credential abuse undetectable
        and complicates incident investigation.
      remediation: "Log all secret access events with actor and context"

    - id: "PIPLOG-HIGH-002"
      signal: "Log retention too short for compliance"
      evidence_indicators:
        - "Logs deleted before required retention period"
        - "No long-term log archival"
      explanation: |
        Short retention prevents forensic investigation of older
        incidents and violates compliance requirements.
      remediation: "Implement retention meeting compliance requirements (typically 1+ years)"

  medium:
    - id: "PIPLOG-MED-001"
      signal: "No alerting on suspicious pipeline activity"
      remediation: "Implement alerting for failed deployments, unusual patterns, and security events"

    - id: "PIPLOG-MED-002"
      signal: "Logs not centralized for analysis"
      remediation: "Centralize logs in SIEM or log management platform"

  low:
    - id: "PIPLOG-LOW-001"
      signal: "Log format not standardized"

  positive:
    - id: "PIPLOG-POS-001"
      signal: "Comprehensive audit logging with SIEM integration"
    - id: "PIPLOG-POS-002"
      signal: "Real-time alerting on security events"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory logged events"
      description: |
        Determine what pipeline events are currently logged
        and identify gaps.
      duration_estimate: "30 min"
      commands:
        - purpose: "Check for logging configurations"
          command: "find . -name '*log*' -o -name '*audit*' 2>/dev/null | head -15"
      expected_findings:
        - "Logged event inventory"
        - "Coverage gaps"

    - id: "2"
      name: "Evaluate log completeness"
      description: |
        Review sample logs to assess whether sufficient
        detail is captured for security purposes.
      duration_estimate: "30 min"
      questions:
        - "Are all pipeline runs logged?"
        - "Are secret access events captured?"
        - "Is actor identity included in logs?"
      expected_findings:
        - "Log completeness assessment"
        - "Missing information identification"

    - id: "3"
      name: "Review log integrity"
      description: |
        Assess how logs are protected against tampering
        and unauthorized deletion.
      duration_estimate: "30 min"
      questions:
        - "Are logs stored in immutable storage?"
        - "Can pipeline runners delete their own logs?"
        - "Is log integrity verified?"
      expected_findings:
        - "Integrity mechanism assessment"
        - "Tampering vulnerability identification"

    - id: "4"
      name: "Verify retention policies"
      description: |
        Confirm log retention meets operational and compliance
        requirements.
      duration_estimate: "30 min"
      questions:
        - "What is the current log retention period?"
        - "Does retention meet compliance requirements?"
        - "Is long-term archival configured?"
      expected_findings:
        - "Retention policy assessment"
        - "Compliance alignment"

    - id: "5"
      name: "Assess monitoring and alerting"
      description: |
        Evaluate whether logs are actively monitored with
        appropriate alerting for security events.
      duration_estimate: "30 min"
      questions:
        - "Are logs forwarded to SIEM?"
        - "What alerts are configured for pipeline security?"
        - "How are alerts triaged and responded to?"
      expected_findings:
        - "Monitoring coverage"
        - "Alert effectiveness"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Logging Coverage Analysis"
        - "Integrity Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Direct log analysis with integrity verification"
    medium: "Configuration review with sample log inspection"
    low: "Documentation review only"

offline:
  capability: "partial"
  cache_manifest:
    knowledge:
      - source_id: "nist-audit"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive security review"
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1

closeout_checklist:
  - id: "piplog-001"
    item: "All pipeline executions are logged"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify pipeline execution audit trail exists"
    expected: "Confirmed by reviewer"

  - id: "piplog-002"
    item: "Logs stored with integrity protection"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify logs cannot be modified or deleted by pipeline actors"
    expected: "Confirmed by reviewer"

  - id: "piplog-003"
    item: "Log retention meets compliance requirements"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Verify retention period is documented and compliant"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC2"
      controls: ["CC7.2", "CC7.3"]
    - framework: "ISO27001"
      controls: ["A.12.4.1", "A.12.4.2", "A.12.4.3"]
    - framework: "PCI-DSS"
      controls: ["10.1", "10.2", "10.5"]

relationships:
  commonly_combined:
    - "devops-ci-cd.pipeline-security.pipeline-access-control"
    - "devops-ci-cd.pipeline-security.secrets-in-pipeline"
