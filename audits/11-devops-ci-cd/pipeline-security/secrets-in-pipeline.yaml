# ============================================================
# AUDIT FILE: Secrets in Pipeline
# ============================================================
# Evaluates secret management practices within CI/CD pipelines
# to prevent exposure and ensure secure handling.
# ============================================================

audit:
  id: "devops-ci-cd.pipeline-security.secrets-in-pipeline"
  name: "Secrets in Pipeline Assessment"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "devops-ci-cd"
  category_number: 11
  subcategory: "pipeline-security"

  tier: "expert"
  estimated_duration: "3 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "security"

  default_profiles:
    - "full"
    - "security"
    - "production"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit examines how secrets (API keys, credentials, certificates)
    are managed within CI/CD pipelines including storage, injection,
    rotation, and exposure prevention. It evaluates whether secrets
    are protected throughout the pipeline lifecycle.

  why_it_matters: |
    Improperly managed secrets in pipelines lead to credential exposure,
    unauthorized access, and breach of production systems. Leaked secrets
    are a leading cause of security incidents and often have long-lasting
    impact.

  when_to_run:
    - "When establishing pipeline security"
    - "After credential leak incidents"
    - "During security audits"
    - "Quarterly security reviews"

prerequisites:
  required_artifacts:
    - type: "ci_cd_config"
      description: "CI/CD pipeline configurations"
    - type: "secret_management"
      description: "Secret management configurations"

  access_requirements:
    - "Read access to pipeline configurations"
    - "Access to secret management system"
    - "Permission to review audit logs"

discovery:
  file_patterns:
    - glob: "**/.github/workflows/*.yaml"
      purpose: "GitHub Actions workflows"
    - glob: "**/.env*"
      purpose: "Environment files"
    - glob: "**/docker-compose*.yaml"
      purpose: "Docker Compose with environment"
    - glob: "**/*.tfvars"
      purpose: "Terraform variable files"

  code_patterns:
    - pattern: "secrets\\.|\\$\\{\\{.*secrets"
      type: "regex"
      scope: "config"
      purpose: "Secret references"
    - pattern: "password|api_key|secret|token|credential"
      type: "keyword"
      scope: "config"
      purpose: "Potential hardcoded secrets"
    - pattern: "AWS_ACCESS_KEY|GITHUB_TOKEN|API_KEY"
      type: "keyword"
      scope: "config"
      purpose: "Common secret environment variables"

knowledge_sources:
  guides:
    - id: "github-secrets"
      name: "GitHub Encrypted Secrets"
      url: "https://docs.github.com/en/actions/security-guides/encrypted-secrets"
      offline_cache: true
    - id: "vault"
      name: "HashiCorp Vault"
      url: "https://www.vaultproject.io/docs"
      offline_cache: true

  specifications:
    - id: "nist-secrets"
      name: "NIST Cryptographic Key Management"
      url: "https://csrc.nist.gov/publications/detail/sp/800-57-part-1/rev-5/final"
      offline_cache: true
      priority: "required"
    - id: "nsa-cicd-security"
      name: "NSA/CISA: Defending CI/CD Environments"
      url: "https://media.defense.gov/2023/Jun/28/2003249466/-1/-1/0/CSI_DEFENDING_CI_CD_ENVIRONMENTS.PDF"
      offline_cache: true
      priority: "required"
    - id: "nsa-supply-chain"
      name: "NSA: Securing the Software Supply Chain"
      url: "https://media.defense.gov/2022/Sep/01/2003068942/-1/-1/0/ESF_SECURING_THE_SOFTWARE_SUPPLY_CHAIN_DEVELOPERS.PDF"
      offline_cache: true
      priority: "required"
    - id: "nist-800-218"
      name: "NIST SP 800-218: SSDF"
      url: "https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-218.pdf"
      offline_cache: true
      priority: "required"

tooling:
  static_analysis:
    - tool: "gitleaks"
      purpose: "Detect secrets in code"
      offline_capable: true
    - tool: "truffleHog"
      purpose: "Scan for secrets"
      offline_capable: true
    - tool: "detect-secrets"
      purpose: "Secret detection"
      offline_capable: true

  scripts:
    - id: "secret-check"
      language: "bash"
      purpose: "Find potential secret exposure"
      source: "inline"
      code: |
        #!/bin/bash
        # Check for potential hardcoded secrets
        echo "=== Checking for potential secrets ==="
        grep -riE 'password\s*=|api_key\s*=|secret\s*=' \
          --include='*.yaml' --include='*.yml' --include='*.env' \
          . 2>/dev/null | grep -v 'secrets\.' | head -20

signals:
  critical:
    - id: "PIPSEC-CRIT-001"
      signal: "Secrets hardcoded in pipeline configuration"
      evidence_pattern: "password:\\s*[\"'][^$]|api_key:\\s*[\"'][^$]"
      explanation: |
        Hardcoded secrets in configuration files are exposed in version
        control history and can be extracted by anyone with repository access.
      remediation: "Move all secrets to secret management system; rotate exposed secrets immediately"

    - id: "PIPSEC-CRIT-002"
      signal: "Secrets logged or echoed in pipeline output"
      evidence_pattern: "echo.*\\$\\{\\{.*secrets|print.*secret"
      explanation: |
        Secrets in logs are visible to anyone with log access and may
        be retained indefinitely, creating long-term exposure.
      remediation: "Mask all secrets in output; audit logs for exposure"

  high:
    - id: "PIPSEC-HIGH-001"
      signal: "No secret rotation policy or automation"
      evidence_indicators:
        - "Secrets unchanged for extended periods"
        - "No rotation automation configured"
      explanation: |
        Unrotated secrets have extended exposure window if leaked
        and may violate compliance requirements.
      remediation: "Implement automated secret rotation with defined schedules"

    - id: "PIPSEC-HIGH-002"
      signal: "Secrets passed through environment variables to untrusted code"
      evidence_pattern: "env:|environment:"
      explanation: |
        Environment variables are accessible to all processes in the
        execution context, potentially exposing secrets to malicious code.
      remediation: "Use secret injection at runtime; avoid passing to untrusted dependencies"

  medium:
    - id: "PIPSEC-MED-001"
      signal: "No secret scanning in repository"
      evidence_pattern: "gitleaks|trufflehog|detect-secrets"
      remediation: "Implement pre-commit and CI secret scanning"

    - id: "PIPSEC-MED-002"
      signal: "Secrets not scoped to required environments only"
      remediation: "Scope secrets to specific environments with least privilege"

  low:
    - id: "PIPSEC-LOW-001"
      signal: "Secret naming conventions inconsistent"

  positive:
    - id: "PIPSEC-POS-001"
      signal: "Dynamic secret injection with Vault or similar"
    - id: "PIPSEC-POS-002"
      signal: "Automated secret rotation with zero-downtime"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Scan for exposed secrets"
      description: |
        Scan repository and pipeline configurations for hardcoded
        or exposed secrets.
      duration_estimate: "30 min"
      commands:
        - purpose: "Check for potential hardcoded secrets"
          command: "grep -riE 'password|secret|api_key|token' --include='*.yaml' --include='*.yml' . 2>/dev/null | grep -v 'secrets\\.' | head -25"
        - purpose: "Find .env files"
          command: "find . -name '.env*' -type f 2>/dev/null | head -10"
      expected_findings:
        - "Exposure assessment"
        - "Hardcoded secret identification"

    - id: "2"
      name: "Review secret management approach"
      description: |
        Evaluate how secrets are stored, accessed, and managed
        within the pipeline.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find secret references"
          command: "grep -rE 'secrets\\.|vault|aws.*secret' --include='*.yaml' . 2>/dev/null | head -20"
      expected_findings:
        - "Secret management approach"
        - "Storage mechanism"

    - id: "3"
      name: "Evaluate secret exposure in logs"
      description: |
        Check for potential secret exposure in pipeline outputs
        and logs.
      duration_estimate: "30 min"
      commands:
        - purpose: "Check for echo/print of secrets"
          command: "grep -rE 'echo|print|log' --include='*.yaml' .github/workflows/ 2>/dev/null | head -20"
      expected_findings:
        - "Log exposure risk assessment"
        - "Masking configuration"

    - id: "4"
      name: "Review rotation policies"
      description: |
        Examine secret rotation policies and automation.
      duration_estimate: "30 min"
      questions:
        - "How often are secrets rotated?"
        - "Is rotation automated?"
        - "What is the process for compromised secrets?"
      expected_findings:
        - "Rotation policy assessment"
        - "Automation status"

    - id: "5"
      name: "Verify secret scanning"
      description: |
        Confirm that secret scanning is implemented to prevent
        future exposure.
      duration_estimate: "30 min"
      commands:
        - purpose: "Check for secret scanning config"
          command: "find . -name '.gitleaks*' -o -name '.pre-commit-config.yaml' 2>/dev/null | head -5"
      expected_findings:
        - "Secret scanning coverage"
        - "Prevention mechanisms"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Secret Exposure Assessment"
        - "Management Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Automated scanning with manual verification"
    medium: "Configuration analysis with sample inspection"
    low: "Documentation review only"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "github-secrets"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive security review"
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1

closeout_checklist:
  - id: "pipsec-001"
    item: "No hardcoded secrets in configuration"
    level: "CRITICAL"
    verification: "grep -riE 'password\\s*=\\s*[\"'][a-z]|api_key\\s*=\\s*[\"'][a-z]' --include='*.yaml' . 2>/dev/null && echo 'FAIL' || echo 'PASS'"
    expected: "PASS"

  - id: "pipsec-002"
    item: "Secret scanning enabled in repository"
    level: "CRITICAL"
    verification: "find . -name '.gitleaks*' -o -name '*secret*scan*' 2>/dev/null | head -1 && echo 'PASS' || echo 'FAIL'"
    expected: "PASS"

  - id: "pipsec-003"
    item: "Secrets masked in pipeline outputs"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Verify secrets are not visible in pipeline logs"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC2"
      controls: ["CC6.1", "CC6.7"]
    - framework: "PCI-DSS"
      controls: ["3.4", "8.2.1"]
    - framework: "ISO27001"
      controls: ["A.9.4.3"]

relationships:
  commonly_combined:
    - "devops-ci-cd.pipeline-security.pipeline-access-control"
    - "devops-ci-cd.pipeline-security.pipeline-audit-logging"
