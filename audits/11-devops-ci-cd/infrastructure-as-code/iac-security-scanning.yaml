# ============================================================
# AUDIT: IaC Security Scanning
# ============================================================
# Evaluates security analysis of infrastructure as code

audit:
  id: "devops-ci-cd.infrastructure-as-code.iac-security-scanning"
  name: "IaC Security Scanning"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "devops-ci-cd"
  category_number: 11
  subcategory: "infrastructure-as-code"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "yes"
  severity: "critical"
  scope: "security"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Assesses security scanning practices for infrastructure as code
    including static security analysis, compliance checking, secrets
    detection, and policy enforcement. Evaluates tool coverage, finding
    management, and integration with development workflows.

  why_it_matters: |
    IaC misconfigurations are a leading cause of cloud security breaches.
    Publicly accessible storage buckets, overly permissive security groups,
    missing encryption, and hardcoded secrets can all be detected before
    deployment through IaC scanning. Shifting security left catches issues
    when they're cheap to fix.

  when_to_run:
    - "Initial security audit"
    - "When implementing IaC security"
    - "After security incidents"
    - "Quarterly security reviews"

prerequisites:
  required_artifacts:
    - type: "iac_repository"
      description: "Infrastructure as code repository"
    - type: "ci_configuration"
      description: "CI/CD pipeline configuration"

  access_requirements:
    - "IaC repository access"
    - "CI/CD configuration access"

discovery:
  code_patterns:
    - pattern: "checkov|tfsec|terrascan|snyk.*iac|trivy.*config"
      type: "regex"
      scope: "config"
      purpose: "IaC security scanning tools"

    - pattern: "policy.*rego|sentinel"
      type: "regex"
      scope: "config"
      purpose: "Policy-as-code files"

  file_patterns:
    - glob: "**/.checkov.yaml"
      purpose: "Checkov configuration"

    - glob: "**/.tfsec/**"
      purpose: "TFSec configuration"

    - glob: "**/policy/**/*.rego"
      purpose: "OPA Rego policies"

    - glob: "**/*.sentinel"
      purpose: "HashiCorp Sentinel policies"

knowledge_sources:
  guides:
    - id: "checkov"
      name: "Checkov Documentation"
      url: "https://www.checkov.io/"
      offline_cache: true

    - id: "tfsec"
      name: "TFSec Documentation"
      url: "https://aquasecurity.github.io/tfsec/"
      offline_cache: true

    - id: "terrascan"
      name: "Terrascan Documentation"
      url: "https://runterrascan.io/"
      offline_cache: true

  specifications:
    - id: "cis-aws"
      name: "CIS AWS Foundations Benchmark"
      url: "https://www.cisecurity.org/benchmark/amazon_web_services"
      offline_cache: true
      priority: "required"

tooling:
  static_analysis:
    - tool: "checkov"
      purpose: "Comprehensive IaC security and compliance"
      offline_capable: true

    - tool: "tfsec"
      purpose: "Terraform-focused security scanning"
      offline_capable: true

    - tool: "terrascan"
      purpose: "Multi-IaC security scanner"
      offline_capable: true

    - tool: "trivy"
      purpose: "Misconfiguration scanning"
      offline_capable: true

    - tool: "kics"
      purpose: "Keeping Infrastructure as Code Secure"
      offline_capable: true

  scripts:
    - id: "run-iac-security-scan"
      language: "bash"
      purpose: "Run comprehensive IaC security scan"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Checkov Scan ==="
        checkov -d . --framework terraform 2>/dev/null | tail -20
        echo "=== TFSec Scan ==="
        tfsec . 2>/dev/null | tail -20

signals:
  critical:
    - id: "CICD-IACSEC-CRIT-001"
      signal: "No IaC security scanning in CI/CD"
      evidence_pattern: "No checkov, tfsec, or similar in CI pipeline"
      explanation: |
        Without security scanning, misconfigurations like public S3 buckets,
        unencrypted databases, or overly permissive security groups deploy
        directly to production.
      remediation: "Add IaC security scanning to CI/CD pipeline"

    - id: "CICD-IACSEC-CRIT-002"
      signal: "Critical security findings not blocking deployment"
      evidence_pattern: "Security scan runs but pipeline continues on failure"
      explanation: |
        If security findings don't block deployment, they are effectively
        advisory and may be ignored, defeating the purpose of scanning.
      remediation: "Configure critical findings to fail the pipeline"

  high:
    - id: "CICD-IACSEC-HIGH-001"
      signal: "Secrets detected in IaC files"
      evidence_pattern: "Hardcoded passwords, API keys, or credentials"
      explanation: |
        Secrets in IaC are exposed to anyone with repository access
        and persist in git history even after removal.
      remediation: "Remove secrets, rotate exposed credentials, use secret managers"

    - id: "CICD-IACSEC-HIGH-002"
      signal: "High-severity CIS benchmark violations"
      evidence_pattern: "CIS benchmark failures in scan results"
      explanation: |
        CIS benchmark violations indicate configurations that don't
        meet industry-standard security baselines.
      remediation: "Address CIS benchmark findings before deployment"

  medium:
    - id: "CICD-IACSEC-MED-001"
      signal: "Security findings not tracked or managed"
      evidence_pattern: "No baseline or exception management"
      remediation: "Implement finding tracking and exception process"

    - id: "CICD-IACSEC-MED-002"
      signal: "Only one security tool used"
      evidence_pattern: "Single scanner may miss findings"
      remediation: "Consider multiple complementary security tools"

  low:
    - id: "CICD-IACSEC-LOW-001"
      signal: "Security scan results not visible in PR"

    - id: "CICD-IACSEC-LOW-002"
      signal: "No trend tracking for security findings"

  positive:
    - id: "CICD-IACSEC-POS-001"
      signal: "Multiple security scanners integrated in CI"

    - id: "CICD-IACSEC-POS-002"
      signal: "Custom policies enforce organizational standards"

    - id: "CICD-IACSEC-POS-003"
      signal: "Security findings block PR merge"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify security scanning tools"
      description: |
        Determine what IaC security scanning tools are
        configured in the repository and CI/CD pipeline.
      duration_estimate: "15 min"

      commands:
        - purpose: "Find security tool configuration"
          command: |
            ls -la .checkov.yaml .tfsec/ .terrascan* 2>/dev/null || echo "No tool configs found"

        - purpose: "Check CI for security scans"
          command: |
            grep -rE 'checkov|tfsec|terrascan|trivy|kics|snyk' .github/workflows/ .gitlab-ci.yml 2>/dev/null | head -20

      expected_findings:
        - "Security scanning tool inventory"

    - id: "2"
      name: "Run security scans"
      description: |
        Execute IaC security scans to identify current
        security posture.
      duration_estimate: "30 min"

      commands:
        - purpose: "Run Checkov scan"
          command: |
            checkov -d . --framework terraform --compact 2>/dev/null | tail -30 || echo "Checkov not installed"

        - purpose: "Run TFSec scan"
          command: |
            tfsec . --format lovely 2>/dev/null | tail -30 || echo "TFSec not installed"

      expected_findings:
        - "Current security findings"

    - id: "3"
      name: "Check for secrets"
      description: |
        Scan IaC for hardcoded secrets or sensitive data.
      duration_estimate: "15 min"

      commands:
        - purpose: "Search for potential secrets"
          command: |
            grep -rE 'password|secret|api_key|access_key|private_key' --include='*.tf' 2>/dev/null | grep -v '#' | head -20

      expected_findings:
        - "Potential hardcoded secrets"

    - id: "4"
      name: "Review finding management"
      description: |
        Assess how security findings are tracked, triaged,
        and remediated.
      duration_estimate: "20 min"

      questions:
        - "How are findings prioritized?"
        - "Is there a baseline for accepted risks?"
        - "Who is responsible for remediation?"

      expected_findings:
        - "Finding management process assessment"

    - id: "5"
      name: "Verify blocking configuration"
      description: |
        Confirm that critical findings block pipeline
        progression.
      duration_estimate: "15 min"

      commands:
        - purpose: "Check if scans fail pipeline"
          command: |
            grep -rE 'soft-fail|hard-fail|exit-code' .github/workflows/ 2>/dev/null

      expected_findings:
        - "Pipeline blocking configuration"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Security Scanning Assessment"
        - "Current Findings Summary"
        - "Recommendations"

  confidence_guidance:
    high: "Full security scan executed with finding analysis"
    medium: "Configuration reviewed with partial scan"
    low: "Based on configuration review only"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "checkov"
        priority: "required"
      - source_id: "cis-aws"
        priority: "required"

profiles:
  membership:
    quick:
      included: true
      priority: 1
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1

closeout_checklist:
  - id: "iac-security-scanning-001"
    item: "Security scanning integrated in CI"
    level: "CRITICAL"
    verification: |
      grep -rE 'checkov|tfsec|terrascan|trivy|kics' .github/workflows/ .gitlab-ci.yml 2>/dev/null && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "iac-security-scanning-002"
    item: "No hardcoded secrets in IaC"
    level: "CRITICAL"
    verification: |
      grep -rE '^[^#]*password\s*=\s*"[^"]+"' --include='*.tf' 2>/dev/null && echo "FAIL" || echo "PASS"
    expected: "PASS"

  - id: "iac-security-scanning-003"
    item: "Critical findings block deployment"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify pipeline fails on critical security findings"
    expected: "Confirmed by reviewer"

  - id: "iac-security-scanning-004"
    item: "No critical or high findings outstanding"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Run scan and verify no critical/high findings"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "CIS"
      controls: ["AWS Foundations", "Azure Foundations", "GCP Foundations"]
    - framework: "SOC2"
      controls: ["CC6.1"]
    - framework: "NIST"
      controls: ["SC-7", "SC-8", "SC-13"]

relationships:
  commonly_combined:
    - "devops-ci-cd.infrastructure-as-code.iac-testing"
    - "devops-ci-cd.infrastructure-as-code.state-management"

  # Multi-tool IaC security scanning:
  # Terraform:
  #   tflint --recursive
  #   checkov -d . --framework terraform
  #   tfsec .
  #   terrascan scan -i terraform
  # Pulumi:
  #   pulumi preview --json | jq '.steps[].diagnostics'
  # CloudFormation:
  #   cfn-lint template.yaml
  #   cfn_nag_scan --input-path template.yaml
  # CDK:
  #   cdk synth && checkov -f cdk.out/*.template.json
  # Ansible:
  #   ansible-lint playbook.yaml
  # Generic:
  #   snyk iac test
  #   trivy config .
