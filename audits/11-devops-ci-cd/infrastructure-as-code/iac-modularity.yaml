# ============================================================
# AUDIT: IaC Modularity
# ============================================================
# Evaluates infrastructure code organization and reusability

audit:
  id: "devops-ci-cd.infrastructure-as-code.iac-modularity"
  name: "IaC Modularity"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "devops-ci-cd"
  category_number: 11
  subcategory: "infrastructure-as-code"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "infrastructure"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Assesses how infrastructure code is organized into reusable modules,
    components, and layers. Evaluates module boundaries, interface design,
    versioning practices, and code reuse patterns. Reviews whether IaC
    follows DRY principles while maintaining clarity and maintainability.

  why_it_matters: |
    Poorly organized IaC becomes unmaintainable as infrastructure grows.
    Copy-paste infrastructure leads to inconsistency, makes updates risky,
    and creates technical debt. Well-modularized IaC enables standardization,
    reduces errors, speeds up provisioning, and ensures consistent security
    configurations across the organization.

  when_to_run:
    - "Initial IaC maturity assessment"
    - "Before major infrastructure expansion"
    - "When onboarding new teams to IaC"
    - "Quarterly code quality reviews"

prerequisites:
  required_artifacts:
    - type: "iac_repository"
      description: "Infrastructure as code repository"

  access_requirements:
    - "IaC repository access"
    - "Module registry access if applicable"

discovery:
  code_patterns:
    - pattern: "module\\s+\"|source\\s*="
      type: "regex"
      scope: "config"
      purpose: "Identify Terraform module usage"

    - pattern: "component:|template:"
      type: "regex"
      scope: "config"
      purpose: "Pulumi/CloudFormation component patterns"

  file_patterns:
    - glob: "**/modules/**"
      purpose: "Terraform module directories"

    - glob: "**/components/**"
      purpose: "Pulumi component directories"

    - glob: "**/templates/**"
      purpose: "CloudFormation nested stacks"

knowledge_sources:
  guides:
    - id: "terraform-modules"
      name: "Terraform Module Best Practices"
      url: "https://developer.hashicorp.com/terraform/language/modules/develop"
      offline_cache: true

    - id: "pulumi-components"
      name: "Pulumi Component Resources"
      url: "https://www.pulumi.com/docs/concepts/resources/components/"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "tflint"
      purpose: "Terraform linting including module issues"
      offline_capable: true

    - tool: "checkov"
      purpose: "IaC security and best practices scanning"
      offline_capable: true

  scripts:
    - id: "analyze-module-structure"
      language: "bash"
      purpose: "Analyze IaC module organization"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Module directories ==="
        find . -type d -name 'modules' -o -name 'components' 2>/dev/null
        echo "=== Module usage ==="
        grep -rn 'module "' --include='*.tf' 2>/dev/null | wc -l
        echo " module declarations found"

signals:
  critical:
    - id: "CICD-IACMOD-CRIT-001"
      signal: "Entire infrastructure in single monolithic file"
      evidence_pattern: "Single .tf file with >1000 lines managing all resources"
      explanation: |
        Monolithic IaC files are impossible to maintain, review, or test
        in isolation. Changes affect all infrastructure, increasing blast
        radius and making reviews impractical.
      remediation: "Break down into logical modules with clear boundaries"

    - id: "CICD-IACMOD-CRIT-002"
      signal: "Security configurations duplicated without module"
      evidence_pattern: "Same IAM policies or security groups copy-pasted"
      explanation: |
        Duplicated security configurations drift over time, leading to
        inconsistent security posture. Changes must be made in multiple
        places, increasing the chance of missing locations.
      remediation: "Create security modules that enforce consistent policies"

  high:
    - id: "CICD-IACMOD-HIGH-001"
      signal: "No reusable modules - all resources defined inline"
      evidence_pattern: "No module directories, all resources in root"
      explanation: |
        Without modules, every environment or service duplicates
        infrastructure code, leading to inconsistency and maintenance
        burden.
      remediation: "Extract common patterns into reusable modules"

    - id: "CICD-IACMOD-HIGH-002"
      signal: "Modules not versioned or pinned"
      evidence_pattern: "source = '../modules/...' without version"
      explanation: |
        Unversioned modules can change unexpectedly, breaking consumers.
        Module changes should be explicit and opt-in through versioning.
      remediation: "Publish modules with semantic versioning, pin in consumers"

  medium:
    - id: "CICD-IACMOD-MED-001"
      signal: "Module interfaces too large or complex"
      evidence_pattern: "Modules with >20 input variables"
      remediation: "Simplify module interfaces, provide sensible defaults"

    - id: "CICD-IACMOD-MED-002"
      signal: "Deep module nesting (>3 levels)"
      evidence_pattern: "Module calling module calling module"
      remediation: "Flatten module hierarchy for clarity"

  low:
    - id: "CICD-IACMOD-LOW-001"
      signal: "Inconsistent module naming conventions"

    - id: "CICD-IACMOD-LOW-002"
      signal: "No module documentation or README"

  positive:
    - id: "CICD-IACMOD-POS-001"
      signal: "Well-defined modules with clear interfaces"

    - id: "CICD-IACMOD-POS-002"
      signal: "Modules versioned and published to registry"

    - id: "CICD-IACMOD-POS-003"
      signal: "Consistent module structure across organization"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Analyze code organization"
      description: |
        Review the overall structure of IaC repositories.
        Identify module boundaries and organization patterns.
      duration_estimate: "20 min"

      commands:
        - purpose: "Show directory structure"
          command: |
            find . -type d -name 'modules' -o -name 'components' -o -name 'terraform' 2>/dev/null | head -20

        - purpose: "Count resources by file"
          command: |
            for f in *.tf */*.tf; do
              [[ -f "$f" ]] && echo "$(grep -c 'resource "' "$f" 2>/dev/null) $f"
            done 2>/dev/null | sort -rn | head -20

      expected_findings:
        - "Overall code organization assessment"

    - id: "2"
      name: "Evaluate module usage"
      description: |
        Identify which modules exist and how they are used.
        Check for code duplication that should be modularized.
      duration_estimate: "25 min"

      commands:
        - purpose: "Find module declarations"
          command: |
            grep -rn 'module "' --include='*.tf' 2>/dev/null | head -20

        - purpose: "Find module source locations"
          command: |
            grep -r 'source\s*=' --include='*.tf' 2>/dev/null | head -20

      expected_findings:
        - "Module usage patterns"

    - id: "3"
      name: "Check module versioning"
      description: |
        Verify that modules are versioned and consumers
        pin to specific versions.
      duration_estimate: "15 min"

      commands:
        - purpose: "Check for version constraints"
          command: |
            grep -rE 'version\s*=' --include='*.tf' 2>/dev/null | head -10

      expected_findings:
        - "Module versioning status"

    - id: "4"
      name: "Assess module interfaces"
      description: |
        Review module input variables and outputs for
        clarity and appropriate complexity.
      duration_estimate: "20 min"

      commands:
        - purpose: "Count variables per module"
          command: |
            for d in modules/*/; do
              if [[ -f "${d}variables.tf" ]]; then
                echo "$(grep -c 'variable "' "${d}variables.tf" 2>/dev/null) $d"
              fi
            done 2>/dev/null | sort -rn | head -10

      expected_findings:
        - "Module interface complexity assessment"

    - id: "5"
      name: "Identify duplication"
      description: |
        Look for code duplication that indicates missing
        modules or poor reuse.
      duration_estimate: "20 min"

      questions:
        - "Are similar resources copy-pasted across files?"
        - "Do multiple environments have diverged configurations?"
        - "Are security configurations consistent?"

      expected_findings:
        - "Code duplication patterns"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Module Architecture"
        - "Duplication Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Full codebase analysis with duplication detection"
    medium: "Structure and module usage reviewed"
    low: "Based on high-level directory review only"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "terraform-modules"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed code analysis"
    full:
      included: true
      priority: 2

closeout_checklist:
  - id: "iac-modularity-001"
    item: "Reusable modules exist"
    level: "CRITICAL"
    verification: |
      find . -type d -name 'modules' 2>/dev/null | head -1 && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "iac-modularity-002"
    item: "No single file >500 lines"
    level: "BLOCKING"
    verification: |
      find . -name '*.tf' -exec wc -l {} + 2>/dev/null | awk '$1 > 500 {print}' | grep -v total && echo "FAIL" || echo "PASS"
    expected: "PASS"

  - id: "iac-modularity-003"
    item: "Modules are versioned"
    level: "WARNING"
    verification: |
      grep -rE 'version\s*=' --include='*.tf' modules/ 2>/dev/null && echo "PASS" || echo "FAIL"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "Internal"
      controls: ["Code Quality"]

relationships:
  commonly_combined:
    - "devops-ci-cd.infrastructure-as-code.iac-testing"
    - "devops-ci-cd.infrastructure-as-code.iac-coverage"
