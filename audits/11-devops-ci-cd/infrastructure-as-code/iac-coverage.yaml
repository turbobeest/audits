# ============================================================
# AUDIT: IaC Coverage
# ============================================================
# Evaluates how much infrastructure is managed as code

audit:
  id: "devops-ci-cd.infrastructure-as-code.iac-coverage"
  name: "IaC Coverage"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "devops-ci-cd"
  category_number: 11
  subcategory: "infrastructure-as-code"

  tier: "expert"
  estimated_duration: "3 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "infrastructure"

  default_profiles:
    - "full"
    - "production"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Measures the percentage of infrastructure resources that are defined
    and managed through infrastructure as code (IaC) tools such as
    Terraform, Pulumi, CloudFormation, or Kubernetes manifests. Identifies
    manually created resources and assesses the completeness of IaC
    adoption.

  why_it_matters: |
    Infrastructure not managed as code cannot be version controlled,
    audited, or reliably reproduced. Manual infrastructure creates
    configuration drift, undocumented dependencies, and single points
    of failure. Full IaC coverage enables disaster recovery, environment
    parity, and compliance auditing.

  when_to_run:
    - "Initial infrastructure audit"
    - "Quarterly compliance reviews"
    - "After infrastructure incidents"
    - "Before disaster recovery testing"

prerequisites:
  required_artifacts:
    - type: "iac_repository"
      description: "Infrastructure as code repository"
    - type: "cloud_account"
      description: "Access to cloud provider accounts"

  access_requirements:
    - "IaC repository access"
    - "Cloud provider read access"
    - "Terraform/Pulumi state access"

discovery:
  file_patterns:
    - glob: "**/*.tf"
      purpose: "Terraform configurations"

    - glob: "**/Pulumi.yaml"
      purpose: "Pulumi project files"

    - glob: "**/cloudformation*.yaml"
      purpose: "CloudFormation templates"

    - glob: "**/terraform.tfstate*"
      purpose: "Terraform state files"

    - glob: "**/k8s/**/*.yaml"
      purpose: "Kubernetes manifests"

knowledge_sources:
  guides:
    - id: "terraform-best-practices"
      name: "Terraform Best Practices"
      url: "https://www.terraform-best-practices.com/"
      offline_cache: true

    - id: "aws-iac"
      name: "AWS Infrastructure as Code"
      url: "https://docs.aws.amazon.com/whitepapers/latest/introduction-devops-aws/infrastructure-as-code.html"
      offline_cache: true

tooling:
  infrastructure_tools:
    - tool: "terraform"
      purpose: "List managed resources"
      command: "terraform state list"

    - tool: "aws"
      purpose: "List all AWS resources"
      command: "aws resourcegroupstaggingapi get-resources"

    - tool: "kubectl"
      purpose: "List Kubernetes resources"
      command: "kubectl get all -A"

  scripts:
    - id: "compare-iac-to-cloud"
      language: "bash"
      purpose: "Compare IaC-managed resources to actual cloud resources"
      source: "inline"
      code: |
        #!/bin/bash
        # Get resources from Terraform state
        terraform state list > /tmp/tf-resources.txt
        # Compare with actual cloud inventory
        # This is simplified - real implementation would query cloud APIs
        echo "Terraform manages $(wc -l < /tmp/tf-resources.txt) resources"

signals:
  critical:
    - id: "CICD-IAC-CRIT-001"
      signal: "Production infrastructure not managed by IaC"
      evidence_pattern: "Manually created VPCs, databases, or core networking"
      explanation: |
        Production infrastructure not in IaC cannot be recreated in disaster
        recovery, audited for compliance, or consistently replicated across
        environments.
      remediation: "Import existing resources into IaC or recreate through IaC"

    - id: "CICD-IAC-CRIT-002"
      signal: "Security-critical resources manually managed"
      evidence_pattern: "IAM policies, security groups, or KMS keys not in IaC"
      explanation: |
        Manually managed security resources create audit gaps, cannot be
        reviewed in PRs, and may drift to insecure configurations without
        detection.
      remediation: "Manage all security resources through version-controlled IaC"

  high:
    - id: "CICD-IAC-HIGH-001"
      signal: "IaC coverage below 80% of infrastructure"
      evidence_threshold: "iac_coverage < 80%"
      explanation: |
        Low IaC coverage means significant infrastructure is undocumented
        and cannot be reliably reproduced. This creates operational risk
        and technical debt.
      remediation: "Prioritize importing or recreating high-value resources in IaC"

    - id: "CICD-IAC-HIGH-002"
      signal: "Database infrastructure not in IaC"
      evidence_pattern: "RDS, DynamoDB, or similar manually configured"
      explanation: |
        Database configuration is critical for disaster recovery and
        compliance. Manual database setup cannot be reproduced accurately.
      remediation: "Define database infrastructure in IaC with proper secret handling"

  medium:
    - id: "CICD-IAC-MED-001"
      signal: "Development environments differ from IaC-defined production"
      evidence_pattern: "Dev manually created while prod uses IaC"
      remediation: "Use same IaC for all environments with variable parameterization"

    - id: "CICD-IAC-MED-002"
      signal: "Networking resources partially in IaC"
      remediation: "Complete networking IaC coverage for reproducibility"

  low:
    - id: "CICD-IAC-LOW-001"
      signal: "Non-critical resources like tags not managed in IaC"

    - id: "CICD-IAC-LOW-002"
      signal: "No inventory of resources outside IaC"

  positive:
    - id: "CICD-IAC-POS-001"
      signal: "100% production infrastructure managed by IaC"

    - id: "CICD-IAC-POS-002"
      signal: "All environments created from same IaC with parameterization"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory IaC-managed resources"
      description: |
        List all resources managed by IaC tools by examining
        state files and configurations.
      duration_estimate: "30 min"

      commands:
        - purpose: "List Terraform-managed resources"
          command: "terraform state list 2>/dev/null | wc -l"

        - purpose: "Find all Terraform configurations"
          command: "find . -name '*.tf' | wc -l"

      expected_findings:
        - "Count of IaC-managed resources"

    - id: "2"
      name: "Inventory cloud resources"
      description: |
        List all resources in cloud accounts to compare
        against IaC-managed resources.
      duration_estimate: "45 min"

      commands:
        - purpose: "List AWS resources"
          command: |
            aws resourcegroupstaggingapi get-resources --query 'ResourceTagMappingList[].ResourceARN' 2>/dev/null | wc -l

      expected_findings:
        - "Count of actual cloud resources"

    - id: "3"
      name: "Identify gaps"
      description: |
        Compare IaC inventory to cloud inventory to identify
        resources not managed by code.
      duration_estimate: "30 min"

      questions:
        - "What resources exist in cloud but not in IaC?"
        - "Are these critical production resources?"
        - "Why were they created manually?"

      expected_findings:
        - "List of resources not in IaC"

    - id: "4"
      name: "Assess criticality of gaps"
      description: |
        Determine which unmanaged resources are critical
        and should be prioritized for IaC adoption.
      duration_estimate: "30 min"

      questions:
        - "Are security resources covered?"
        - "Are production databases covered?"
        - "Are networking fundamentals covered?"

      expected_findings:
        - "Prioritized list of IaC gaps"

    - id: "5"
      name: "Calculate coverage metrics"
      description: |
        Calculate overall IaC coverage percentage and
        coverage by resource category.
      duration_estimate: "15 min"

      expected_findings:
        - "IaC coverage percentage"
        - "Coverage by resource type"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Coverage Metrics"
        - "Gap Analysis"
        - "Remediation Priorities"

  confidence_guidance:
    high: "Full cloud inventory compared to IaC state"
    medium: "IaC inventory complete, cloud inventory sampled"
    low: "Based on IaC configuration review only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "terraform-best-practices"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires cloud inventory analysis"
    full:
      included: true
      priority: 1
    production:
      included: true
      priority: 1

closeout_checklist:
  - id: "iac-coverage-001"
    item: "IaC files exist for infrastructure"
    level: "CRITICAL"
    verification: |
      find . -name '*.tf' -o -name 'Pulumi.yaml' -o -name '*cloudformation*.yaml' 2>/dev/null | head -1 && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "iac-coverage-002"
    item: "Production infrastructure in IaC"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify production VPCs, databases, and compute in IaC"
    expected: "Confirmed by reviewer"

  - id: "iac-coverage-003"
    item: "Security resources managed by IaC"
    level: "CRITICAL"
    verification: |
      grep -rE 'aws_iam|aws_security_group|aws_kms' *.tf */*.tf 2>/dev/null && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "iac-coverage-004"
    item: "IaC coverage above 80%"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Calculate and verify IaC coverage percentage"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC2"
      controls: ["CC6.1", "CC6.6"]
    - framework: "CIS"
      controls: ["Benchmark"]

relationships:
  commonly_combined:
    - "devops-ci-cd.infrastructure-as-code.drift-detection"
    - "devops-ci-cd.infrastructure-as-code.state-management"
