# ============================================================
# AUDIT: IaC Testing
# ============================================================
# Evaluates testing practices for infrastructure as code

audit:
  id: "devops-ci-cd.infrastructure-as-code.iac-testing"
  name: "IaC Testing"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "devops-ci-cd"
  category_number: 11
  subcategory: "infrastructure-as-code"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "infrastructure"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Assesses testing practices for infrastructure as code including
    static analysis, policy testing, plan validation, integration testing,
    and compliance checking. Evaluates whether IaC changes are validated
    before application to production infrastructure.

  why_it_matters: |
    IaC bugs can destroy production infrastructure or create security
    vulnerabilities. Unlike application bugs that might affect users,
    IaC bugs can delete databases, expose secrets, or disable security
    controls. Testing IaC before apply catches these issues when they
    are cheap to fix rather than during incident response.

  when_to_run:
    - "Initial IaC maturity assessment"
    - "When establishing CI/CD for IaC"
    - "After IaC-related incidents"
    - "Quarterly security reviews"

prerequisites:
  required_artifacts:
    - type: "iac_repository"
      description: "Infrastructure as code repository"
    - type: "ci_configuration"
      description: "CI/CD pipeline configuration"

  access_requirements:
    - "IaC repository access"
    - "CI/CD configuration access"

discovery:
  code_patterns:
    - pattern: "terraform validate|terraform plan|tflint|checkov"
      type: "regex"
      scope: "config"
      purpose: "Identify IaC validation in CI"

    - pattern: "terratest|kitchen-terraform|pytest.*terraform"
      type: "regex"
      scope: "config"
      purpose: "IaC integration testing frameworks"

  file_patterns:
    - glob: "**/*_test.go"
      purpose: "Terratest Go test files"

    - glob: "**/.tflint.hcl"
      purpose: "TFLint configuration"

    - glob: "**/.checkov.yaml"
      purpose: "Checkov configuration"

    - glob: "**/policy/**/*.rego"
      purpose: "OPA/Conftest policy files"

knowledge_sources:
  guides:
    - id: "terratest"
      name: "Terratest Documentation"
      url: "https://terratest.gruntwork.io/"
      offline_cache: true

    - id: "checkov"
      name: "Checkov Documentation"
      url: "https://www.checkov.io/1.Welcome/What%20is%20Checkov.html"
      offline_cache: true

    - id: "tflint"
      name: "TFLint Documentation"
      url: "https://github.com/terraform-linters/tflint"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "terraform validate"
      purpose: "Syntax and basic validation"
      offline_capable: true

    - tool: "tflint"
      purpose: "Terraform linting and best practices"
      offline_capable: true

    - tool: "checkov"
      purpose: "Security and compliance scanning"
      offline_capable: true

    - tool: "tfsec"
      purpose: "Security-focused static analysis"
      offline_capable: true

    - tool: "conftest"
      purpose: "Custom policy testing with OPA"
      offline_capable: true

  scripts:
    - id: "check-iac-testing"
      language: "bash"
      purpose: "Verify IaC testing in CI"
      source: "inline"
      code: |
        #!/bin/bash
        if grep -rE 'terraform validate|tflint|checkov|tfsec' .github/workflows/ .gitlab-ci.yml 2>/dev/null; then
          echo "PASS: IaC testing found in CI"
        else
          echo "WARN: No IaC testing found in CI"
        fi

signals:
  critical:
    - id: "CICD-IACTEST-CRIT-001"
      signal: "No validation before terraform apply in production"
      evidence_pattern: "terraform apply without validate or plan in CI"
      explanation: |
        Applying IaC without validation can destroy infrastructure or
        create security vulnerabilities. Even syntax errors can cause
        partial applies that leave infrastructure in inconsistent state.
      remediation: "Always run validate and plan before apply in CI"

    - id: "CICD-IACTEST-CRIT-002"
      signal: "No security scanning of IaC"
      evidence_pattern: "No checkov, tfsec, or similar in CI pipeline"
      explanation: |
        Without security scanning, IaC may create misconfigured resources
        with public access, missing encryption, or overly permissive
        security groups.
      remediation: "Add checkov, tfsec, or similar to CI pipeline"

  high:
    - id: "CICD-IACTEST-HIGH-001"
      signal: "Plan output not reviewed before apply"
      evidence_pattern: "Automatic apply without plan approval"
      explanation: |
        Terraform plan shows what will change. Without review, destructive
        changes may be applied accidentally.
      remediation: "Require plan review before apply, especially for production"

    - id: "CICD-IACTEST-HIGH-002"
      signal: "No policy-as-code for compliance requirements"
      evidence_pattern: "Missing OPA/Sentinel/Checkov custom policies"
      explanation: |
        Generic security tools may not catch organization-specific
        compliance requirements like tagging standards or approved
        instance types.
      remediation: "Implement custom policies for organizational requirements"

  medium:
    - id: "CICD-IACTEST-MED-001"
      signal: "No integration testing of IaC modules"
      evidence_pattern: "Missing terratest or similar integration tests"
      remediation: "Add integration tests for critical modules"

    - id: "CICD-IACTEST-MED-002"
      signal: "Security tool findings not blocking"
      evidence_pattern: "Security scan runs but does not fail pipeline"
      remediation: "Configure security findings to block pipeline"

  low:
    - id: "CICD-IACTEST-LOW-001"
      signal: "No cost estimation in plan review"

    - id: "CICD-IACTEST-LOW-002"
      signal: "Test coverage not measured for IaC modules"

  positive:
    - id: "CICD-IACTEST-POS-001"
      signal: "Comprehensive validation pipeline with security scanning"

    - id: "CICD-IACTEST-POS-002"
      signal: "Policy-as-code enforcing organizational standards"

    - id: "CICD-IACTEST-POS-003"
      signal: "Integration tests verify module functionality"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify IaC testing in CI"
      description: |
        Review CI/CD configuration for IaC validation,
        security scanning, and testing steps.
      duration_estimate: "20 min"

      commands:
        - purpose: "Find IaC testing in CI"
          command: |
            grep -rE 'terraform|tflint|checkov|tfsec|validate|plan' .github/workflows/ .gitlab-ci.yml 2>/dev/null | head -30

      expected_findings:
        - "IaC testing configuration in CI"

    - id: "2"
      name: "Assess security scanning"
      description: |
        Check if security scanning tools are configured
        and running on IaC changes.
      duration_estimate: "20 min"

      commands:
        - purpose: "Check for security scan configuration"
          command: |
            ls .checkov.yaml .tfsec/ .tflint.hcl 2>/dev/null || echo "No security config found"

        - purpose: "Check for security scan in CI"
          command: |
            grep -rE 'checkov|tfsec|snyk.*iac' .github/workflows/ .gitlab-ci.yml 2>/dev/null

      expected_findings:
        - "Security scanning coverage"

    - id: "3"
      name: "Review plan approval process"
      description: |
        Determine if terraform plan output is reviewed
        before apply, especially for production.
      duration_estimate: "15 min"

      commands:
        - purpose: "Check for manual approval gates"
          command: |
            grep -rE 'environment:|approval|manual' .github/workflows/ .gitlab-ci.yml 2>/dev/null | head -10

      expected_findings:
        - "Plan approval process assessment"

    - id: "4"
      name: "Check for policy-as-code"
      description: |
        Identify custom policies enforcing organizational
        standards beyond generic security rules.
      duration_estimate: "20 min"

      commands:
        - purpose: "Find OPA/Rego policies"
          command: |
            find . -name '*.rego' 2>/dev/null | head -10

        - purpose: "Find Sentinel policies"
          command: |
            find . -name '*.sentinel' 2>/dev/null | head -10

      expected_findings:
        - "Policy-as-code implementation status"

    - id: "5"
      name: "Assess integration testing"
      description: |
        Check if modules have integration tests that
        verify actual infrastructure behavior.
      duration_estimate: "15 min"

      commands:
        - purpose: "Find Terratest files"
          command: |
            find . -name '*_test.go' -path '*/terraform/*' -o -name '*_test.go' -path '*/modules/*' 2>/dev/null | head -10

      expected_findings:
        - "Integration testing coverage"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Testing Pipeline Analysis"
        - "Security Scanning Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Full CI configuration reviewed with test execution verified"
    medium: "CI configuration reviewed, test execution not verified"
    low: "Based on file presence only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "checkov"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires CI pipeline analysis"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "iac-testing-001"
    item: "terraform validate runs in CI"
    level: "CRITICAL"
    verification: |
      grep -rE 'terraform validate' .github/workflows/ .gitlab-ci.yml 2>/dev/null && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "iac-testing-002"
    item: "Security scanning runs on IaC changes"
    level: "CRITICAL"
    verification: |
      grep -rE 'checkov|tfsec|snyk' .github/workflows/ .gitlab-ci.yml 2>/dev/null && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "iac-testing-003"
    item: "Plan reviewed before production apply"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Verify production applies require plan approval"
    expected: "Confirmed by reviewer"

  - id: "iac-testing-004"
    item: "Security findings block pipeline"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Verify security scan failures prevent deployment"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC2"
      controls: ["CC6.1"]
    - framework: "CIS"
      controls: ["Benchmark"]

relationships:
  commonly_combined:
    - "devops-ci-cd.infrastructure-as-code.iac-security-scanning"
    - "devops-ci-cd.infrastructure-as-code.iac-modularity"
