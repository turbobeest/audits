# ============================================================
# AUDIT: Drift Detection
# ============================================================
# Evaluates infrastructure drift detection and remediation

audit:
  id: "devops-ci-cd.infrastructure-as-code.drift-detection"
  name: "Drift Detection"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "devops-ci-cd"
  category_number: 11
  subcategory: "infrastructure-as-code"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "infrastructure"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Assesses the ability to detect when actual infrastructure state
    diverges from the desired state defined in IaC. Evaluates drift
    detection mechanisms, alerting, remediation workflows, and prevention
    of manual changes that cause drift.

  why_it_matters: |
    Infrastructure drift undermines the benefits of IaC. Manual changes
    create undocumented configurations, security vulnerabilities, and
    make disaster recovery unreliable. Drift detection identifies when
    reality diverges from code, enabling teams to either update IaC to
    match or revert infrastructure to the defined state.

  when_to_run:
    - "Initial IaC maturity assessment"
    - "After infrastructure incidents"
    - "When implementing drift detection"
    - "Quarterly compliance reviews"

prerequisites:
  required_artifacts:
    - type: "iac_repository"
      description: "Infrastructure as code repository"
    - type: "cloud_account"
      description: "Access to actual infrastructure state"

  access_requirements:
    - "IaC state access"
    - "Cloud provider read access"
    - "Drift detection tool configuration"

discovery:
  code_patterns:
    - pattern: "terraform plan|drift|refresh|sync"
      type: "regex"
      scope: "config"
      purpose: "Drift detection commands in automation"

    - pattern: "driftctl|cloudquery|steampipe"
      type: "regex"
      scope: "config"
      purpose: "Dedicated drift detection tools"

  file_patterns:
    - glob: "**/.driftignore"
      purpose: "Driftctl ignore configuration"

    - glob: "**/cloudquery*.yaml"
      purpose: "CloudQuery configuration"

knowledge_sources:
  guides:
    - id: "driftctl"
      name: "Driftctl Documentation"
      url: "https://docs.driftctl.com/"
      offline_cache: true

    - id: "terraform-drift"
      name: "Managing Terraform State"
      url: "https://developer.hashicorp.com/terraform/language/state"
      offline_cache: true

tooling:
  infrastructure_tools:
    - tool: "terraform plan"
      purpose: "Detect drift via plan output"
      command: "terraform plan -detailed-exitcode"

    - tool: "driftctl"
      purpose: "Comprehensive drift detection"
      command: "driftctl scan"

    - tool: "cloudquery"
      purpose: "Cloud asset inventory"
      command: "cloudquery sync"

  scripts:
    - id: "check-drift"
      language: "bash"
      purpose: "Run drift detection"
      source: "inline"
      code: |
        #!/bin/bash
        terraform plan -detailed-exitcode
        exit_code=$?
        if [[ $exit_code -eq 0 ]]; then
          echo "PASS: No drift detected"
        elif [[ $exit_code -eq 2 ]]; then
          echo "FAIL: Drift detected - changes pending"
        else
          echo "ERROR: Plan failed"
        fi

signals:
  critical:
    - id: "CICD-DRIFT-CRIT-001"
      signal: "No drift detection in place"
      evidence_pattern: "No scheduled drift detection or monitoring"
      explanation: |
        Without drift detection, manual changes accumulate silently.
        The IaC state becomes increasingly disconnected from reality,
        making it useless for disaster recovery or auditing.
      remediation: "Implement scheduled drift detection with alerting"

    - id: "CICD-DRIFT-CRIT-002"
      signal: "Security-critical resources have drifted"
      evidence_pattern: "Security groups, IAM, or encryption settings differ from IaC"
      explanation: |
        Drifted security configurations may have weakened security
        posture without audit trail. This creates compliance gaps
        and potential vulnerabilities.
      remediation: "Immediately investigate and remediate security drift"

  high:
    - id: "CICD-DRIFT-HIGH-001"
      signal: "Drift detected but not remediated"
      evidence_pattern: "Known drift persisting without action"
      explanation: |
        Known drift that isn't remediated indicates IaC is not being
        treated as the source of truth. This undermines the entire
        IaC practice.
      remediation: "Either update IaC to match or revert infrastructure to IaC state"

    - id: "CICD-DRIFT-HIGH-002"
      signal: "Manual console access not restricted"
      evidence_pattern: "Wide console access enabling manual changes"
      explanation: |
        If anyone can make manual changes through the console,
        drift is inevitable. Access controls should prevent most
        manual modifications.
      remediation: "Restrict console access, require changes through IaC"

  medium:
    - id: "CICD-DRIFT-MED-001"
      signal: "Drift detection runs infrequently (>weekly)"
      evidence_pattern: "Drift scans scheduled weekly or less"
      remediation: "Run drift detection daily for production"

    - id: "CICD-DRIFT-MED-002"
      signal: "No alerting on drift detection"
      evidence_pattern: "Drift detection runs but results not monitored"
      remediation: "Configure alerts for drift detection findings"

  low:
    - id: "CICD-DRIFT-LOW-001"
      signal: "Drift metrics not tracked over time"

    - id: "CICD-DRIFT-LOW-002"
      signal: "No process to import drifted resources"

  positive:
    - id: "CICD-DRIFT-POS-001"
      signal: "Automated daily drift detection with alerting"

    - id: "CICD-DRIFT-POS-002"
      signal: "Drift remediation workflow documented and followed"

    - id: "CICD-DRIFT-POS-003"
      signal: "Console access restricted to break-glass scenarios"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Assess current drift detection"
      description: |
        Identify what drift detection mechanisms are in place,
        if any, and how they are configured.
      duration_estimate: "20 min"

      commands:
        - purpose: "Check for drift detection in CI/scheduled jobs"
          command: |
            grep -rE 'drift|terraform plan|driftctl' .github/workflows/ .gitlab-ci.yml cron/ 2>/dev/null | head -20

        - purpose: "Look for driftctl configuration"
          command: |
            ls -la .driftignore .driftctl.yaml 2>/dev/null || echo "No driftctl config"

      expected_findings:
        - "Current drift detection implementation"

    - id: "2"
      name: "Run drift detection"
      description: |
        Execute drift detection to identify current
        infrastructure drift.
      duration_estimate: "30 min"

      commands:
        - purpose: "Run terraform plan to detect drift"
          command: |
            terraform plan -detailed-exitcode 2>&1 | head -50

      expected_findings:
        - "Current drift status"

    - id: "3"
      name: "Review console access controls"
      description: |
        Assess who has console access that could make
        manual infrastructure changes.
      duration_estimate: "20 min"

      questions:
        - "Who can access the cloud console?"
        - "Is there a break-glass procedure for emergency access?"
        - "Are console changes audited?"

      expected_findings:
        - "Console access control assessment"

    - id: "4"
      name: "Assess remediation workflow"
      description: |
        Determine what happens when drift is detected.
        Is there a documented workflow for remediation?
      duration_estimate: "15 min"

      questions:
        - "What is the process when drift is detected?"
        - "How quickly is drift remediated?"
        - "Who is responsible for drift remediation?"

      expected_findings:
        - "Drift remediation process assessment"

    - id: "5"
      name: "Check alerting configuration"
      description: |
        Verify that drift detection results are alerted
        appropriately to responsible parties.
      duration_estimate: "15 min"

      commands:
        - purpose: "Check for drift alerting"
          command: |
            grep -rE 'slack|pagerduty|email|alert' .github/workflows/*drift* 2>/dev/null

      expected_findings:
        - "Drift alerting configuration"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Current Drift Status"
        - "Detection Mechanism Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Drift detection executed with infrastructure comparison"
    medium: "Detection mechanism reviewed without execution"
    low: "Based on configuration review only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "driftctl"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires infrastructure access"
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1

closeout_checklist:
  - id: "drift-detection-001"
    item: "Drift detection mechanism in place"
    level: "CRITICAL"
    verification: |
      grep -rE 'drift|terraform plan' .github/workflows/ cron/ 2>/dev/null && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "drift-detection-002"
    item: "No current critical drift"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Run terraform plan and verify no unexpected changes"
    expected: "Confirmed by reviewer"

  - id: "drift-detection-003"
    item: "Drift detection runs at least daily"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Verify scheduled drift detection frequency"
    expected: "Confirmed by reviewer"

  - id: "drift-detection-004"
    item: "Alerting configured for drift findings"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Verify alerts are sent when drift is detected"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC2"
      controls: ["CC6.1", "CC6.6"]
    - framework: "CIS"
      controls: ["Benchmark"]

relationships:
  commonly_combined:
    - "devops-ci-cd.infrastructure-as-code.iac-coverage"
    - "devops-ci-cd.infrastructure-as-code.state-management"
