# ============================================================
# AUDIT: Test Environment Provisioning
# ============================================================
# Evaluates practices for provisioning and managing test
# environments for automated testing.
# ============================================================

audit:
  id: "testing-quality-assurance.test-automation.test-environment-provisioning"
  name: "Test Environment Provisioning"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 10
  subcategory: "test-automation"

  tier: "expert"
  estimated_duration: "4 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "testing"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Examines test environment provisioning practices including automated
    environment creation, configuration management, isolation strategies,
    and cleanup procedures. Reviews infrastructure-as-code, containerization,
    and ephemeral environment capabilities.

  why_it_matters: |
    Inconsistent or unavailable test environments cause false positives,
    delayed testing, and unreliable results. Automated provisioning ensures
    reproducible, isolated environments that accurately represent production
    while enabling parallel test execution.

  when_to_run:
    - "Initial test infrastructure setup"
    - "After infrastructure changes"
    - "When test reliability issues arise"
    - "During cost optimization reviews"

prerequisites:
  required_artifacts:
    - type: "infrastructure-config"
      description: "Environment provisioning configurations"
    - type: "docker-config"
      description: "Container configurations for test environments"

  access_requirements:
    - "Infrastructure provisioning system access"
    - "Container registry access"
    - "Cloud provider access for ephemeral environments"

discovery:
  file_patterns:
    - glob: "**/docker-compose*.yml"
      purpose: "Docker Compose test environments"
    - glob: "**/Dockerfile.test*"
      purpose: "Test container definitions"
    - glob: "**/terraform/**"
      purpose: "Infrastructure as code"
    - glob: "**/.devcontainer/**"
      purpose: "Development container configurations"

  code_patterns:
    - pattern: "docker-compose|testcontainers|localstack"
      type: "keyword"
      scope: "config"
      purpose: "Test environment tools"
    - pattern: "ephemeral|temporary|disposable"
      type: "keyword"
      scope: "config"
      purpose: "Ephemeral environment configuration"
    - pattern: "provision|setup.*env|create.*env"
      type: "regex"
      scope: "config"
      purpose: "Provisioning configuration"

knowledge_sources:
  guides:
    - id: "testcontainers"
      name: "Testcontainers Documentation"
      url: "https://www.testcontainers.org/"
      offline_cache: true
    - id: "localstack"
      name: "LocalStack Documentation"
      url: "https://docs.localstack.cloud/"
      offline_cache: true

  learning_resources:
    - id: "docker-testing"
      title: "Docker for Test Automation"
      type: "article"
      reference: "https://docs.docker.com/develop/develop-images/best-practices/"

tooling:
  infrastructure_tools:
    - tool: "Docker Compose"
      purpose: "Multi-container test environments"
      command: "docker-compose -f docker-compose.test.yml up -d"
    - tool: "Testcontainers"
      purpose: "Programmatic container management"
      command: "Built into test framework"
    - tool: "LocalStack"
      purpose: "AWS service emulation"
      command: "localstack start"
    - tool: "Kind"
      purpose: "Kubernetes in Docker for testing"
      command: "kind create cluster --name test"

  scripts:
    - id: "provision-env"
      language: "bash"
      purpose: "Provision test environment"
      source: "inline"
      code: |
        #!/bin/bash
        # Provision test environment
        docker-compose -f docker-compose.test.yml up -d

        # Wait for services
        ./scripts/wait-for-services.sh

        # Run database migrations
        docker-compose exec -T app ./migrate.sh

        echo "Test environment ready"

signals:
  critical:
    - id: "ENVPROV-CRIT-001"
      signal: "No automated environment provisioning"
      evidence_pattern: "Manual environment setup required for tests"
      explanation: |
        Manual environment setup is slow, error-prone, and blocks testing.
        Tests may run in inconsistent environments, producing unreliable
        results. Developers avoid running tests due to setup complexity.
      remediation: "Implement automated environment provisioning with containers or IaC"

    - id: "ENVPROV-CRIT-002"
      signal: "Test environments not isolated"
      evidence_pattern: "Tests sharing environments or databases with conflicts"
      explanation: |
        Non-isolated environments cause test interference, race conditions,
        and false failures. Tests modifying shared state corrupt results
        for concurrent executions.
      remediation: "Ensure complete isolation between test environment instances"

  high:
    - id: "ENVPROV-HIGH-001"
      signal: "Environment cleanup not automated"
      evidence_pattern: "Manual cleanup required or resources left running"
      explanation: |
        Missing cleanup wastes resources and costs money. Leftover
        environments may interfere with future tests or exhaust
        resource quotas.
      remediation: "Implement automatic cleanup after test completion"

    - id: "ENVPROV-HIGH-002"
      signal: "Environment differs significantly from production"
      evidence_pattern: "Different services, versions, or configurations in test"
      explanation: |
        Test environments that don't mirror production may pass tests
        that fail in production. Configuration differences mask real
        bugs and create false confidence.
      remediation: "Ensure test environment parity with production"

  medium:
    - id: "ENVPROV-MED-001"
      signal: "Slow environment provisioning"
      evidence_pattern: "Environment setup >5 minutes"
      remediation: "Optimize provisioning with caching and pre-built images"

    - id: "ENVPROV-MED-002"
      signal: "No environment versioning"
      evidence_pattern: "Environment configurations not version controlled"
      remediation: "Version control all environment configurations"

  low:
    - id: "ENVPROV-LOW-001"
      signal: "Environment provisioning not documented"
      remediation: "Document environment setup and troubleshooting"

  positive:
    - id: "ENVPROV-POS-001"
      signal: "Fully automated ephemeral environment provisioning"
    - id: "ENVPROV-POS-002"
      signal: "Production-like isolated environments with fast startup"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify provisioning infrastructure"
      description: |
        Search for environment provisioning configurations and tools.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find Docker Compose files"
          command: "find . -name 'docker-compose*.yml' -o -name 'docker-compose*.yaml' 2>/dev/null"
        - purpose: "Find Testcontainers usage"
          command: "grep -r 'testcontainers\\|TestContainers' . --include='*.java' --include='*.py' --include='*.js' 2>/dev/null | head -15"
        - purpose: "Check for IaC"
          command: "find . -type d \\( -name 'terraform' -o -name 'pulumi' \\) 2>/dev/null"
      expected_findings:
        - "Provisioning configuration files"
        - "Container and IaC tools in use"

    - id: "2"
      name: "Review isolation mechanisms"
      description: |
        Examine how test environments are isolated from each other
        and from production.
      duration_estimate: "35 min"
      commands:
        - purpose: "Check network isolation"
          command: "grep -r 'network\\|subnet\\|isolated' . --include='docker-compose*.yml' 2>/dev/null"
        - purpose: "Check for dynamic naming"
          command: "grep -r 'unique\\|uuid\\|random\\|\\${' . --include='docker-compose*.yml' 2>/dev/null"
      expected_findings:
        - "Isolation configurations"
        - "Dynamic resource naming"

    - id: "3"
      name: "Verify cleanup procedures"
      description: |
        Check that environments are properly cleaned up after
        test execution.
      duration_estimate: "25 min"
      commands:
        - purpose: "Check for cleanup scripts"
          command: "find . -name '*cleanup*' -o -name '*teardown*' 2>/dev/null"
        - purpose: "Check CI for cleanup steps"
          command: "grep -r 'down\\|destroy\\|cleanup\\|after' .github/workflows/ 2>/dev/null | head -20"
      expected_findings:
        - "Cleanup scripts"
        - "CI cleanup stages"

    - id: "4"
      name: "Assess environment parity"
      description: |
        Compare test environment configuration with production to
        identify differences.
      duration_estimate: "30 min"
      commands:
        - purpose: "Compare configurations"
          command: "diff docker-compose.yml docker-compose.test.yml 2>/dev/null | head -30 || echo 'Files not found'"
      expected_findings:
        - "Configuration differences"
        - "Parity assessment"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Provisioning Analysis"
        - "Isolation Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Provisioning verified, isolation confirmed, cleanup validated"
    medium: "Configuration reviewed but execution not observed"
    low: "Limited visibility into provisioning practices"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "testcontainers"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires infrastructure analysis"
    full:
      included: true
      priority: 2

closeout_checklist:
  - id: "env-provisioning-001"
    item: "Automated environment provisioning exists"
    level: "CRITICAL"
    verification: "find . -name 'docker-compose*.yml' 2>/dev/null | head -1 | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "env-provisioning-002"
    item: "Test environments are isolated"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Reviewer confirms environments do not share state"
    expected: "Confirmed by reviewer"

  - id: "env-provisioning-003"
    item: "Automatic cleanup configured"
    level: "WARNING"
    verification: "grep -r 'down\\|cleanup\\|destroy' .github/workflows/ 2>/dev/null | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "Internal"
      controls: ["DEV-003"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.test-automation.ci-integration"
    - "testing-quality-assurance.test-data-management.test-fixture-management"
    - "testing-quality-assurance.test-data-management.database-seeding"
