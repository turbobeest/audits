# ============================================================
# AUDIT: CI Integration
# ============================================================
# Evaluates test automation integration with continuous
# integration pipelines.
# ============================================================

audit:
  id: "testing-quality-assurance.test-automation.ci-integration"
  name: "CI Integration"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 10
  subcategory: "test-automation"

  tier: "expert"
  estimated_duration: "3 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "yes"
  severity: "critical"
  scope: "testing"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: true
  parallelizable: true

description:
  what: |
    Examines the integration of automated tests with CI/CD pipelines including
    test execution triggers, failure handling, reporting, and deployment
    gates. Reviews pipeline configuration, test stage sequencing, and
    feedback mechanisms for test results.

  why_it_matters: |
    Tests that don't run automatically provide no protection. CI integration
    ensures tests execute on every change, catching regressions immediately.
    Proper CI integration transforms tests from documentation into an active
    safety net that prevents broken code from reaching production.

  when_to_run:
    - "Initial CI/CD setup"
    - "After pipeline modifications"
    - "When test execution time changes"
    - "After test suite restructuring"

prerequisites:
  required_artifacts:
    - type: "ci-configuration"
      description: "CI/CD pipeline configuration files"
    - type: "test-suite"
      description: "Automated test suite"

  access_requirements:
    - "CI/CD system access"
    - "Pipeline execution logs"
    - "Test result dashboards"

discovery:
  file_patterns:
    - glob: "**/.github/workflows/**"
      purpose: "GitHub Actions workflows"
    - glob: "**/.gitlab-ci.yml"
      purpose: "GitLab CI configuration"
    - glob: "**/Jenkinsfile*"
      purpose: "Jenkins pipeline"
    - glob: "**/.circleci/**"
      purpose: "CircleCI configuration"
    - glob: "**/azure-pipelines.yml"
      purpose: "Azure Pipelines"

  code_patterns:
    - pattern: "test|npm test|pytest|jest|mocha|rspec"
      type: "keyword"
      scope: "config"
      purpose: "Test execution commands"
    - pattern: "on:\\s*push|on:\\s*pull_request"
      type: "regex"
      scope: "config"
      purpose: "CI triggers"
    - pattern: "needs:|depends_on|require"
      type: "keyword"
      scope: "config"
      purpose: "Job dependencies"

knowledge_sources:
  guides:
    - id: "github-actions"
      name: "GitHub Actions Documentation"
      url: "https://docs.github.com/en/actions"
      offline_cache: true
    - id: "gitlab-ci"
      name: "GitLab CI/CD Documentation"
      url: "https://docs.gitlab.com/ee/ci/"
      offline_cache: true

  learning_resources:
    - id: "ci-book"
      title: "Continuous Integration"
      type: "book"
      reference: "Paul Duvall, Addison-Wesley"

tooling:
  static_analysis:
    - tool: "actionlint"
      purpose: "GitHub Actions linter"
      offline_capable: true
    - tool: "yamllint"
      purpose: "YAML syntax validation"
      offline_capable: true

signals:
  critical:
    - id: "CI-CRIT-001"
      signal: "Tests not executed in CI/CD pipeline"
      evidence_pattern: "CI configuration without test execution stages"
      explanation: |
        Tests that don't run in CI provide no protection against regressions.
        Developers must remember to run tests manually, which is unreliable.
        Broken code reaches production without detection.
      remediation: "Configure test execution in CI pipeline for all branches"

    - id: "CI-CRIT-002"
      signal: "Test failures don't block deployments"
      evidence_pattern: "continue-on-error or allow_failure for test stages"
      explanation: |
        Non-blocking test failures allow broken code to deploy. The test suite
        becomes advisory rather than protective. Known bugs reach production
        because failures are ignored.
      remediation: "Configure test failures as blocking deployment gates"

  high:
    - id: "CI-HIGH-001"
      signal: "Tests only run on main branch"
      evidence_pattern: "CI triggers exclude pull requests and feature branches"
      explanation: |
        Restricting tests to main branch means failures are discovered too late.
        Pull requests should be validated before merge. Feature branches need
        feedback before they become problems.
      remediation: "Enable test execution on pull requests and all branches"

    - id: "CI-HIGH-002"
      signal: "Test results not reported in pull requests"
      evidence_pattern: "No status checks or PR comments with test results"
      explanation: |
        Without visible test results, reviewers may approve broken code.
        Test status should be immediately visible in the PR interface to
        inform review decisions.
      remediation: "Configure test result reporting as PR status checks"

  medium:
    - id: "CI-MED-001"
      signal: "Test execution time excessive"
      evidence_pattern: "Test stages running >30 minutes"
      remediation: "Optimize test execution with parallelization and selective testing"

    - id: "CI-MED-002"
      signal: "No test result caching"
      evidence_pattern: "Dependencies downloaded on every run"
      remediation: "Implement dependency and artifact caching"

  low:
    - id: "CI-LOW-001"
      signal: "Test stage naming unclear"
      remediation: "Use descriptive names for test stages"

  positive:
    - id: "CI-POS-001"
      signal: "Comprehensive test execution with blocking gates"
    - id: "CI-POS-002"
      signal: "Fast feedback with optimized test execution"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify CI configuration"
      description: |
        Locate CI/CD configuration files and identify the CI platform in use.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find CI configuration files"
          command: "find . -type f \\( -name '*.yml' -o -name '*.yaml' -o -name 'Jenkinsfile*' \\) -path '*/.github/*' -o -path '*/.gitlab*' -o -path '*/.circleci/*' 2>/dev/null"
        - purpose: "List GitHub Actions workflows"
          command: "ls -la .github/workflows/ 2>/dev/null"
      expected_findings:
        - "CI platform identification"
        - "Configuration file locations"

    - id: "2"
      name: "Review test execution stages"
      description: |
        Examine CI configuration for test execution commands, stages,
        and triggers.
      duration_estimate: "35 min"
      commands:
        - purpose: "Check for test commands"
          command: "grep -r 'npm test\\|pytest\\|jest\\|go test\\|cargo test' .github/workflows/ 2>/dev/null"
        - purpose: "Check triggers"
          command: "grep -r 'on:' .github/workflows/ -A5 2>/dev/null | head -40"
      expected_findings:
        - "Test execution commands"
        - "Trigger configuration"

    - id: "3"
      name: "Verify blocking behavior"
      description: |
        Check that test failures block downstream stages and deployments.
      duration_estimate: "25 min"
      commands:
        - purpose: "Check for error handling"
          command: "grep -r 'continue-on-error\\|allow_failure\\|if:.*failure' .github/workflows/ 2>/dev/null"
        - purpose: "Check job dependencies"
          command: "grep -r 'needs:' .github/workflows/ 2>/dev/null"
      expected_findings:
        - "Error handling configuration"
        - "Job dependency chains"

    - id: "4"
      name: "Review test reporting"
      description: |
        Verify test results are reported as status checks and visible
        in pull requests.
      duration_estimate: "20 min"
      commands:
        - purpose: "Check for test reporters"
          command: "grep -r 'test-reporter\\|junit\\|coverage\\|upload.*artifact' .github/workflows/ 2>/dev/null"
      expected_findings:
        - "Test result reporting"
        - "Artifact uploads"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "CI Configuration Analysis"
        - "Test Execution Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "CI configuration verified, test execution confirmed, blocking behavior validated"
    medium: "Configuration reviewed but execution not observed"
    low: "Limited visibility into CI configuration"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "github-actions"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: true
      priority: 1
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "ci-integration-001"
    item: "Tests configured to run in CI"
    level: "CRITICAL"
    verification: "grep -r 'test\\|pytest\\|jest' .github/workflows/ 2>/dev/null | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "ci-integration-002"
    item: "Tests run on pull requests"
    level: "BLOCKING"
    verification: "grep -r 'pull_request' .github/workflows/ 2>/dev/null | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "ci-integration-003"
    item: "Test failures block deployment"
    level: "WARNING"
    verification: "grep -r 'needs:' .github/workflows/ 2>/dev/null | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "Internal"
      controls: ["DEV-001"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.test-automation.test-parallelization"
    - "testing-quality-assurance.test-automation.test-reporting"
    - "testing-quality-assurance.performance-testing.performance-regression"
