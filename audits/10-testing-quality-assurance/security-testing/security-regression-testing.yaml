# ============================================================
# AUDIT: Security Regression Testing
# ============================================================
# Evaluates testing practices for preventing reintroduction of
# previously fixed security vulnerabilities.
# ============================================================

audit:
  id: "testing-quality-assurance.security-testing.security-regression-testing"
  name: "Security Regression Testing"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 10
  subcategory: "security-testing"

  tier: "expert"
  estimated_duration: "3 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "yes"
  severity: "critical"
  scope: "security"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: true
  parallelizable: true

description:
  what: |
    Examines security regression testing practices to ensure previously
    identified and fixed vulnerabilities are not reintroduced. Reviews
    test coverage for historical vulnerabilities, integration with CI/CD,
    and processes for converting security findings into regression tests.

  why_it_matters: |
    Security vulnerabilities frequently reappear after being fixed, often
    through code refactoring, dependency updates, or incomplete patches.
    Regression tests for known vulnerabilities prevent embarrassing and
    dangerous reintroduction of previously exploited weaknesses.

  when_to_run:
    - "Every CI/CD pipeline run"
    - "After vulnerability remediation"
    - "After code refactoring"
    - "After dependency updates"

prerequisites:
  required_artifacts:
    - type: "security-test-suite"
      description: "Automated security test suite"
    - type: "vulnerability-history"
      description: "Historical vulnerability records"

  access_requirements:
    - "Security test suite access"
    - "Vulnerability tracking system"
    - "CI/CD pipeline logs"

discovery:
  file_patterns:
    - glob: "**/security-tests/**"
      purpose: "Security test directories"
    - glob: "**/test/**/*security*.{js,py,java}"
      purpose: "Security test files"
    - glob: "**/regression/**/*security*"
      purpose: "Security regression tests"

  code_patterns:
    - pattern: "CVE-|GHSA-|vulnerability|injection|xss"
      type: "keyword"
      scope: "source"
      purpose: "Security vulnerability tests"
    - pattern: "regression|should.*not.*allow|must.*fail"
      type: "regex"
      scope: "source"
      purpose: "Regression test assertions"
    - pattern: "security.*test|test.*security|pentest"
      type: "regex"
      scope: "config"
      purpose: "Security test configuration"

knowledge_sources:
  specifications:
    - id: "owasp-asvs"
      name: "OWASP ASVS"
      url: "https://owasp.org/www-project-application-security-verification-standard/"
      offline_cache: true
      priority: "required"

  guides:
    - id: "owasp-testing"
      name: "OWASP Testing Guide"
      url: "https://owasp.org/www-project-web-security-testing-guide/"
      offline_cache: true

  learning_resources:
    - id: "secure-sdlc"
      title: "Building Secure Software"
      type: "book"
      reference: "Gary McGraw, Addison-Wesley"

tooling:
  static_analysis:
    - tool: "OWASP ZAP"
      purpose: "Security regression testing automation"
      offline_capable: true
    - tool: "pytest-security"
      purpose: "Security testing with pytest"
      offline_capable: true
    - tool: "jest"
      purpose: "JavaScript security test framework"
      offline_capable: true

  scripts:
    - id: "security-regression"
      language: "python"
      purpose: "Run security regression test suite"
      source: "inline"
      code: |
        #!/usr/bin/env python3
        import pytest
        import sys

        # Run security-tagged tests
        result = pytest.main([
            '-v',
            '-m', 'security',
            '--tb=short',
            'tests/security/'
        ])
        sys.exit(result)

signals:
  critical:
    - id: "SECREG-CRIT-001"
      signal: "No security regression tests exist"
      evidence_pattern: "Absence of security-specific test files or markers"
      explanation: |
        Without security regression tests, fixed vulnerabilities may be
        reintroduced without detection. The same vulnerability could be
        exploited multiple times across different releases.
      remediation: "Create regression tests for all identified security vulnerabilities"

    - id: "SECREG-CRIT-002"
      signal: "Security regression tests not executed in CI/CD"
      evidence_pattern: "Security tests exist but not run in pipeline"
      explanation: |
        Security tests that don't run automatically provide no protection.
        Manual-only security testing misses regressions until exploitation
        or audit discovery.
      remediation: "Integrate security regression tests into CI/CD pipeline"

  high:
    - id: "SECREG-HIGH-001"
      signal: "Historical vulnerabilities not converted to tests"
      evidence_pattern: "Vulnerability records without corresponding regression tests"
      explanation: |
        Vulnerabilities fixed without regression tests may reappear.
        Every identified vulnerability should have a corresponding test
        to prevent reintroduction.
      remediation: "Create regression tests for all historical vulnerabilities"

    - id: "SECREG-HIGH-002"
      signal: "Security test failures don't block releases"
      evidence_pattern: "Security tests run but failures allow deployment"
      explanation: |
        Non-blocking security tests allow vulnerable code into production.
        Security regression failures should be treated as critical blockers.
      remediation: "Configure security test failures to block deployments"

  medium:
    - id: "SECREG-MED-001"
      signal: "Security tests not clearly labeled"
      evidence_pattern: "Security tests mixed with functional tests without markers"
      remediation: "Use clear markers/tags to identify security regression tests"

    - id: "SECREG-MED-002"
      signal: "Test coverage for security controls incomplete"
      evidence_pattern: "Authentication/authorization not tested"
      remediation: "Ensure security tests cover authentication, authorization, and input validation"

  low:
    - id: "SECREG-LOW-001"
      signal: "Security test documentation incomplete"
      remediation: "Document security tests with vulnerability references"

  positive:
    - id: "SECREG-POS-001"
      signal: "Comprehensive security regression suite linked to vulnerability history"
    - id: "SECREG-POS-002"
      signal: "Security tests block deployment on failure"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify security test suite"
      description: |
        Search for security-specific tests, test markers, and
        security testing configurations.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find security test files"
          command: "find . -type f \\( -name '*security*test*' -o -name '*test*security*' \\) -not -path '*/node_modules/*' 2>/dev/null"
        - purpose: "Check for security test markers"
          command: "grep -r '@security\\|mark\\.security\\|describe.*security' . --include='*.py' --include='*.js' --include='*.ts' 2>/dev/null | head -20"
      expected_findings:
        - "Security test files"
        - "Security test markers"

    - id: "2"
      name: "Review test coverage"
      description: |
        Examine security tests for coverage of common vulnerability
        categories (injection, XSS, auth bypass, etc.).
      duration_estimate: "40 min"
      commands:
        - purpose: "Check for injection tests"
          command: "grep -r 'injection\\|sql.*inject\\|command.*inject' . --include='*test*' 2>/dev/null | head -15"
        - purpose: "Check for XSS tests"
          command: "grep -r 'xss\\|cross.*site\\|script.*inject' . --include='*test*' 2>/dev/null | head -15"
        - purpose: "Check for auth tests"
          command: "grep -r 'auth.*bypass\\|unauthorized\\|forbidden' . --include='*test*' 2>/dev/null | head -15"
      expected_findings:
        - "Injection prevention tests"
        - "XSS prevention tests"
        - "Authorization tests"

    - id: "3"
      name: "Verify CI/CD integration"
      description: |
        Check that security regression tests are integrated into
        the CI/CD pipeline and failures block deployment.
      duration_estimate: "25 min"
      commands:
        - purpose: "Check CI/CD for security tests"
          command: "grep -r 'security.*test\\|test.*security' .github/workflows/ 2>/dev/null"
        - purpose: "Check for blocking behavior"
          command: "grep -r 'fail-fast\\|needs:' .github/workflows/ 2>/dev/null | head -20"
      expected_findings:
        - "Security test stages in CI/CD"
        - "Deployment dependencies on security tests"

    - id: "4"
      name: "Review vulnerability-to-test mapping"
      description: |
        Verify that historical vulnerabilities are mapped to
        regression tests with references.
      duration_estimate: "30 min"
      commands:
        - purpose: "Check for CVE references in tests"
          command: "grep -r 'CVE-\\|GHSA-\\|vulnerability' . --include='*test*' 2>/dev/null | head -15"
      expected_findings:
        - "CVE/vulnerability references in tests"
        - "Vulnerability-to-test mapping"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Security Test Coverage Analysis"
        - "CI/CD Integration Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Security tests verified, CI/CD integration confirmed, vulnerability mapping reviewed"
    medium: "Tests exist but integration or coverage unclear"
    low: "Limited visibility into security testing"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "owasp-testing"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed test analysis"
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1

closeout_checklist:
  - id: "security-regression-001"
    item: "Security regression tests exist"
    level: "CRITICAL"
    verification: "find . -type f -name '*security*test*' -not -path '*/node_modules/*' 2>/dev/null | head -1 | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "security-regression-002"
    item: "Security tests integrated into CI/CD"
    level: "BLOCKING"
    verification: "grep -r 'security.*test\\|test.*security' .github/workflows/ 2>/dev/null | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "security-regression-003"
    item: "Tests cover common vulnerability categories"
    level: "WARNING"
    verification: "grep -r 'injection\\|xss\\|auth' --include='*test*' 2>/dev/null | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["web-application", "api-service", "financial-system"]

  compliance_frameworks:
    - framework: "PCI-DSS"
      controls: ["6.5"]
    - framework: "SOC2"
      controls: ["CC6.1"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.security-testing.penetration-testing"
    - "testing-quality-assurance.security-testing.static-security-analysis"
    - "testing-quality-assurance.test-automation.ci-integration"
