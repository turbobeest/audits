# ============================================================
# AUDIT: Vulnerability Scanning
# ============================================================
# Evaluates automated vulnerability scanning practices for
# identifying known security weaknesses.
# ============================================================

audit:
  id: "testing-quality-assurance.security-testing.vulnerability-scanning"
  name: "Vulnerability Scanning"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 10
  subcategory: "security-testing"

  tier: "expert"
  estimated_duration: "3 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "yes"
  severity: "critical"
  scope: "security"

  default_profiles:
    - "full"
    - "security"
    - "quick"

  blocks_phase: true
  parallelizable: true

description:
  what: |
    Examines vulnerability scanning practices including tool configuration,
    scan frequency, coverage scope, finding prioritization, and integration
    with vulnerability management workflows. Reviews both infrastructure
    and application-level scanning capabilities.

  why_it_matters: |
    Vulnerability scanning identifies known security weaknesses before attackers
    exploit them. Without regular scanning, systems accumulate unpatched
    vulnerabilities and misconfigurations. Automated scanning provides
    continuous visibility into security posture and enables proactive
    remediation.

  when_to_run:
    - "Continuous (integrated into CI/CD)"
    - "Weekly infrastructure scans"
    - "Before deployments"
    - "After infrastructure changes"

prerequisites:
  required_artifacts:
    - type: "scanner-configuration"
      description: "Vulnerability scanner configurations and policies"
    - type: "asset-inventory"
      description: "Inventory of systems to scan"

  access_requirements:
    - "Vulnerability scanner access"
    - "Scan result dashboards"
    - "Vulnerability management system"

discovery:
  file_patterns:
    - glob: "**/.trivyrc*"
      purpose: "Trivy scanner configuration"
    - glob: "**/snyk*"
      purpose: "Snyk configuration files"
    - glob: "**/.grype*"
      purpose: "Grype scanner configuration"
    - glob: "**/security/**"
      purpose: "Security configuration directories"

  code_patterns:
    - pattern: "trivy|snyk|grype|clair|anchore"
      type: "keyword"
      scope: "config"
      purpose: "Vulnerability scanner usage"
    - pattern: "CVE-|GHSA-|vulnerability"
      type: "keyword"
      scope: "config"
      purpose: "Vulnerability references"
    - pattern: "scan|audit|check"
      type: "keyword"
      scope: "config"
      purpose: "Security scan commands"

knowledge_sources:
  specifications:
    - id: "cve-program"
      name: "CVE Program"
      url: "https://cve.mitre.org/"
      offline_cache: true
      priority: "required"
    - id: "nvd"
      name: "National Vulnerability Database"
      url: "https://nvd.nist.gov/"
      offline_cache: true
      priority: "required"
    - id: "owasp-asvs"
      name: "OWASP ASVS"
      url: "https://owasp.org/www-project-application-security-verification-standard/"
      offline_cache: true
      priority: "recommended"

  guides:
    - id: "owasp-vuln"
      name: "OWASP Vulnerability Management Guide"
      url: "https://owasp.org/www-project-vulnerability-management-guide/"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "Trivy"
      purpose: "Container and filesystem vulnerability scanning"
      offline_capable: true
    - tool: "Snyk"
      purpose: "Dependency and container scanning"
      offline_capable: false
    - tool: "Grype"
      purpose: "Container image vulnerability scanning"
      offline_capable: true
    - tool: "OWASP Dependency-Check"
      purpose: "Dependency vulnerability analysis"
      offline_capable: true

  infrastructure_tools:
    - tool: "Nessus"
      purpose: "Infrastructure vulnerability scanning"
      command: "nessus-cli scan --target 192.168.1.0/24"
    - tool: "OpenVAS"
      purpose: "Open-source vulnerability scanner"
      command: "openvas-start && omp -u admin -w admin --xml '<start_task task_id=\"...\"/>'"

  scripts:
    - id: "scan-containers"
      language: "bash"
      purpose: "Scan container images for vulnerabilities"
      source: "inline"
      code: |
        #!/bin/bash
        for image in $(docker images --format '{{.Repository}}:{{.Tag}}'); do
          echo "Scanning $image"
          trivy image --severity HIGH,CRITICAL "$image"
        done

signals:
  critical:
    - id: "VULNSCAN-CRIT-001"
      signal: "No vulnerability scanning implemented"
      evidence_pattern: "Absence of scanner configurations or scan results"
      explanation: |
        Without vulnerability scanning, known vulnerabilities accumulate
        undetected. Systems remain exposed to attacks targeting publicly
        disclosed vulnerabilities with available exploits.
      remediation: "Implement automated vulnerability scanning in CI/CD and infrastructure"

    - id: "VULNSCAN-CRIT-002"
      signal: "Critical vulnerabilities not blocking deployments"
      evidence_pattern: "Scanner runs but critical findings don't prevent deployment"
      explanation: |
        Non-blocking scans allow known critical vulnerabilities into production.
        This exposes the organization to attacks that could have been prevented
        by enforcing vulnerability gates.
      remediation: "Configure vulnerability scanners to block on critical/high findings"

  high:
    - id: "VULNSCAN-HIGH-001"
      signal: "Vulnerability scanning not continuous"
      evidence_pattern: "Manual or infrequent scanning only"
      explanation: |
        New vulnerabilities are disclosed daily. Infrequent scanning leaves
        windows of exposure between scans. Continuous scanning catches new
        vulnerabilities quickly.
      remediation: "Integrate vulnerability scanning into CI/CD for continuous coverage"

    - id: "VULNSCAN-HIGH-002"
      signal: "Scan coverage incomplete"
      evidence_pattern: "Scanning limited to containers without dependencies or infrastructure"
      explanation: |
        Partial coverage leaves attack surfaces unprotected. Vulnerabilities
        in dependencies, infrastructure, or application code remain undetected
        if not included in scanning scope.
      remediation: "Expand scanning to cover containers, dependencies, infrastructure, and code"

  medium:
    - id: "VULNSCAN-MED-001"
      signal: "No vulnerability prioritization process"
      evidence_pattern: "All findings treated equally without risk-based prioritization"
      remediation: "Implement risk-based vulnerability prioritization (CVSS, exploitability)"

    - id: "VULNSCAN-MED-002"
      signal: "Scanner databases not updated"
      evidence_pattern: "Vulnerability database older than 7 days"
      remediation: "Configure automatic database updates for vulnerability scanners"

  low:
    - id: "VULNSCAN-LOW-001"
      signal: "Scan results not archived for trending"
      remediation: "Archive scan results for historical trend analysis"

  positive:
    - id: "VULNSCAN-POS-001"
      signal: "Comprehensive vulnerability scanning with CI/CD integration"
    - id: "VULNSCAN-POS-002"
      signal: "Risk-based prioritization with blocking thresholds"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify scanning infrastructure"
      description: |
        Search for vulnerability scanner configurations and integrations
        in the codebase and CI/CD pipelines.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find scanner configurations"
          command: "find . -type f \\( -name '*trivy*' -o -name '*snyk*' -o -name '*grype*' \\) 2>/dev/null"
        - purpose: "Check CI/CD for scanning"
          command: "grep -r 'trivy\\|snyk\\|grype\\|scan\\|vulnerability' .github/workflows/ 2>/dev/null | head -20"
      expected_findings:
        - "Scanner configuration files"
        - "CI/CD scanning stages"

    - id: "2"
      name: "Review scanner configuration"
      description: |
        Examine scanner configurations for appropriate severity thresholds,
        exclusions, and blocking behavior.
      duration_estimate: "35 min"
      commands:
        - purpose: "Check severity configuration"
          command: "grep -r 'severity\\|CRITICAL\\|HIGH' --include='*trivy*' --include='*.yaml' 2>/dev/null | head -20"
        - purpose: "Check for blocking behavior"
          command: "grep -r 'exit-code\\|fail-on\\|block' --include='*.yaml' --include='*.yml' 2>/dev/null | head -20"
      expected_findings:
        - "Severity threshold configuration"
        - "Blocking/failure conditions"

    - id: "3"
      name: "Verify scanning coverage"
      description: |
        Confirm that scanning covers all relevant asset types including
        containers, dependencies, and infrastructure.
      duration_estimate: "30 min"
      commands:
        - purpose: "Check for dependency scanning"
          command: "grep -r 'npm audit\\|pip-audit\\|dependency.*check' . 2>/dev/null | head -10"
        - purpose: "Check for container scanning"
          command: "grep -r 'docker.*scan\\|image.*scan\\|trivy image' . 2>/dev/null | head -10"
      expected_findings:
        - "Dependency scanning configuration"
        - "Container scanning configuration"

    - id: "4"
      name: "Review vulnerability management integration"
      description: |
        Verify that scan results integrate with vulnerability management
        and tracking systems.
      duration_estimate: "25 min"
      commands:
        - purpose: "Check for SARIF or result exports"
          command: "grep -r 'sarif\\|output.*json\\|upload.*result' . --include='*.yaml' 2>/dev/null"
      expected_findings:
        - "Result export configuration"
        - "Integration with tracking systems"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Scanning Coverage Assessment"
        - "Configuration Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Scanner configurations verified, blocking behavior confirmed, coverage validated"
    medium: "Configuration reviewed but execution not observed"
    low: "Limited visibility into scanning practices"

offline:
  capability: "partial"
  cache_manifest:
    knowledge:
      - source_id: "nvd"
        priority: "required"

profiles:
  membership:
    quick:
      included: true
      priority: 1
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1

closeout_checklist:
  - id: "vulnerability-scanning-001"
    item: "Vulnerability scanning configured"
    level: "CRITICAL"
    verification: "grep -r 'trivy\\|snyk\\|grype' . 2>/dev/null | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "vulnerability-scanning-002"
    item: "Scanning integrated into CI/CD"
    level: "BLOCKING"
    verification: "grep -r 'scan\\|trivy\\|snyk' .github/workflows/ 2>/dev/null | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "vulnerability-scanning-003"
    item: "Critical findings block deployment"
    level: "WARNING"
    verification: "grep -r 'exit-code\\|fail-on' --include='*.yaml' 2>/dev/null | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "PCI-DSS"
      controls: ["6.1", "11.2"]
    - framework: "SOC2"
      controls: ["CC6.1", "CC7.1"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.security-testing.penetration-testing"
    - "testing-quality-assurance.security-testing.static-security-analysis"
    - "testing-quality-assurance.test-automation.ci-integration"
