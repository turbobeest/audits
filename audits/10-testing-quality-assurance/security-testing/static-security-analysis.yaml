# ============================================================
# AUDIT: Static Security Analysis
# ============================================================
# Evaluates static application security testing (SAST) practices
# for identifying vulnerabilities in source code.
# ============================================================

audit:
  id: "testing-quality-assurance.security-testing.static-security-analysis"
  name: "Static Security Analysis"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 10
  subcategory: "security-testing"

  tier: "expert"
  estimated_duration: "3 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "yes"
  severity: "critical"
  scope: "security"

  default_profiles:
    - "full"
    - "security"
    - "quick"

  blocks_phase: true
  parallelizable: true

description:
  what: |
    Examines static application security testing (SAST) practices including
    tool selection, rule configuration, CI/CD integration, and finding
    management. Reviews coverage of security vulnerability patterns,
    custom rule development, and false positive handling.

  why_it_matters: |
    SAST identifies security vulnerabilities early in development, when fixes
    are cheapest. Static analysis catches injection flaws, hardcoded secrets,
    insecure configurations, and dangerous patterns before code reaches
    production. Early detection prevents costly post-release security patches.

  when_to_run:
    - "Every commit and pull request"
    - "Pre-merge validation"
    - "Security review phases"
    - "Continuous monitoring"

prerequisites:
  required_artifacts:
    - type: "sast-configuration"
      description: "SAST tool configurations and rulesets"
    - type: "source-code"
      description: "Application source code"

  access_requirements:
    - "SAST tool access"
    - "Code repository access"
    - "CI/CD pipeline access"

discovery:
  file_patterns:
    - glob: "**/.semgrep/**"
      purpose: "Semgrep configuration"
    - glob: "**/semgrep.yml"
      purpose: "Semgrep rules"
    - glob: "**/.codeql/**"
      purpose: "CodeQL configuration"
    - glob: "**/bandit.yaml"
      purpose: "Bandit configuration"
    - glob: "**/.brakeman*"
      purpose: "Brakeman configuration"

  code_patterns:
    - pattern: "semgrep|codeql|bandit|brakeman|sonar"
      type: "keyword"
      scope: "config"
      purpose: "SAST tool references"
    - pattern: "security.*scan|sast|static.*analysis"
      type: "regex"
      scope: "config"
      purpose: "Security scanning configuration"
    - pattern: "CWE-|OWASP"
      type: "keyword"
      scope: "config"
      purpose: "Security standard references"

knowledge_sources:
  specifications:
    - id: "cwe"
      name: "Common Weakness Enumeration"
      url: "https://cwe.mitre.org/"
      offline_cache: true
      priority: "required"
    - id: "owasp-top10"
      name: "OWASP Top 10"
      url: "https://owasp.org/www-project-top-ten/"
      offline_cache: true
      priority: "required"
    - id: "owasp-asvs"
      name: "OWASP ASVS"
      url: "https://owasp.org/www-project-application-security-verification-standard/"
      offline_cache: true
      priority: "required"

  guides:
    - id: "semgrep-docs"
      name: "Semgrep Documentation"
      url: "https://semgrep.dev/docs/"
      offline_cache: true
    - id: "codeql-docs"
      name: "CodeQL Documentation"
      url: "https://codeql.github.com/docs/"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "Semgrep"
      purpose: "Multi-language static analysis"
      offline_capable: true
    - tool: "CodeQL"
      purpose: "Semantic code analysis"
      offline_capable: true
    - tool: "Bandit"
      purpose: "Python security linter"
      offline_capable: true
    - tool: "Brakeman"
      purpose: "Ruby on Rails security scanner"
      offline_capable: true
    - tool: "ESLint security plugins"
      purpose: "JavaScript security linting"
      offline_capable: true
    - tool: "gosec"
      purpose: "Go security checker"
      offline_capable: true

  scripts:
    - id: "run-sast"
      language: "bash"
      purpose: "Run SAST tools"
      source: "inline"
      code: |
        #!/bin/bash
        # Run multiple SAST tools
        echo "Running Semgrep..."
        semgrep --config auto --error .

        echo "Running language-specific tools..."
        if [ -f "requirements.txt" ]; then
          bandit -r . -f json
        fi
        if [ -f "package.json" ]; then
          npm audit
        fi

signals:
  critical:
    - id: "SAST-CRIT-001"
      signal: "No static security analysis configured"
      evidence_pattern: "Absence of SAST tool configurations"
      explanation: |
        Without SAST, code vulnerabilities are not detected until runtime
        or penetration testing. This allows security bugs to accumulate
        and reach production, increasing breach risk and remediation cost.
      remediation: "Implement SAST tools appropriate for the technology stack"

    - id: "SAST-CRIT-002"
      signal: "SAST findings don't block merges"
      evidence_pattern: "SAST runs but failures allow merge/deployment"
      explanation: |
        Non-blocking SAST provides information without protection. Known
        vulnerabilities still reach production, exposing the organization
        to preventable security incidents.
      remediation: "Configure SAST to block merges on high/critical findings"

  high:
    - id: "SAST-HIGH-001"
      signal: "SAST rules not customized for application context"
      evidence_pattern: "Default rulesets only, no custom rules"
      explanation: |
        Default rules miss application-specific vulnerabilities. Custom rules
        for internal frameworks, APIs, and patterns catch issues that
        generic rules cannot detect.
      remediation: "Develop custom SAST rules for application-specific security patterns"

    - id: "SAST-HIGH-002"
      signal: "SAST coverage incomplete across languages"
      evidence_pattern: "SAST configured for some languages but not others"
      explanation: |
        Partial language coverage leaves code unscanned. Vulnerabilities
        in uncovered languages go undetected while giving false confidence
        from partial scanning.
      remediation: "Configure SAST for all languages in the codebase"

  medium:
    - id: "SAST-MED-001"
      signal: "High false positive rate without suppression management"
      evidence_pattern: "Many findings suppressed without documentation"
      remediation: "Document and review false positive suppressions"

    - id: "SAST-MED-002"
      signal: "SAST not run on dependencies"
      evidence_pattern: "Application code scanned but dependencies excluded"
      remediation: "Include dependency scanning in SAST coverage"

  low:
    - id: "SAST-LOW-001"
      signal: "SAST findings not tracked for trending"
      remediation: "Track SAST finding trends over time"

  positive:
    - id: "SAST-POS-001"
      signal: "Comprehensive SAST with custom rules and blocking thresholds"
    - id: "SAST-POS-002"
      signal: "Low false positive rate with managed suppressions"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify SAST tooling"
      description: |
        Search for SAST tool configurations and CI/CD integration.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find SAST configurations"
          command: "find . -type f \\( -name '*semgrep*' -o -name '*codeql*' -o -name '*bandit*' -o -name '*brakeman*' \\) 2>/dev/null"
        - purpose: "Check CI/CD for SAST"
          command: "grep -r 'semgrep\\|codeql\\|bandit\\|sast\\|security.*scan' .github/workflows/ 2>/dev/null | head -20"
      expected_findings:
        - "SAST configuration files"
        - "CI/CD SAST stages"

    - id: "2"
      name: "Review rule configuration"
      description: |
        Examine SAST rulesets for appropriate security coverage and
        custom rules.
      duration_estimate: "35 min"
      commands:
        - purpose: "Check Semgrep rules"
          command: "cat .semgrep.yml 2>/dev/null || find . -name 'semgrep*.yml' -exec cat {} \\; 2>/dev/null | head -50"
        - purpose: "Check for custom rules"
          command: "find . -path '*rules*' -name '*.yml' -o -path '*rules*' -name '*.yaml' 2>/dev/null"
      expected_findings:
        - "Ruleset configuration"
        - "Custom security rules"

    - id: "3"
      name: "Verify blocking behavior"
      description: |
        Check that SAST failures block merges and deployments for
        high-severity findings.
      duration_estimate: "25 min"
      commands:
        - purpose: "Check for blocking configuration"
          command: "grep -r 'error\\|fail\\|block\\|required' --include='*semgrep*' --include='*.yml' 2>/dev/null | head -20"
        - purpose: "Check GitHub required checks"
          command: "cat .github/workflows/*.yml 2>/dev/null | grep -A10 'needs:' | head -30"
      expected_findings:
        - "Blocking configuration"
        - "Required check configuration"

    - id: "4"
      name: "Assess language coverage"
      description: |
        Verify SAST covers all languages in the codebase.
      duration_estimate: "20 min"
      commands:
        - purpose: "Identify languages in codebase"
          command: "find . -type f \\( -name '*.py' -o -name '*.js' -o -name '*.ts' -o -name '*.java' -o -name '*.go' -o -name '*.rb' \\) -not -path '*/node_modules/*' 2>/dev/null | head -20"
      expected_findings:
        - "Languages in use"
        - "SAST coverage per language"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "SAST Coverage Analysis"
        - "Rule Configuration Review"
        - "Recommendations"

  confidence_guidance:
    high: "SAST configuration verified, blocking behavior confirmed, coverage validated"
    medium: "Configuration reviewed but behavior not observed"
    low: "Limited visibility into SAST practices"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "cwe"
        priority: "required"

profiles:
  membership:
    quick:
      included: true
      priority: 1
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1

closeout_checklist:
  - id: "static-security-001"
    item: "SAST tools configured"
    level: "CRITICAL"
    verification: "find . -type f \\( -name '*semgrep*' -o -name '*codeql*' -o -name '*bandit*' \\) 2>/dev/null | head -1 | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "static-security-002"
    item: "SAST integrated into CI/CD"
    level: "BLOCKING"
    verification: "grep -r 'semgrep\\|codeql\\|sast' .github/workflows/ 2>/dev/null | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "static-security-003"
    item: "SAST blocks on high severity findings"
    level: "WARNING"
    verification: "grep -r 'error\\|fail' --include='*semgrep*' 2>/dev/null | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "PCI-DSS"
      controls: ["6.3.2"]
    - framework: "SOC2"
      controls: ["CC6.1"]
    - framework: "NIST"
      controls: ["SA-11"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.security-testing.dynamic-security-analysis"
    - "testing-quality-assurance.security-testing.vulnerability-scanning"
    - "testing-quality-assurance.test-automation.ci-integration"
