# ============================================================
# AUDIT: Test Maintainability
# ============================================================
# Evaluates how maintainable and sustainable the test suite
# is over time as the codebase evolves.
# ============================================================

audit:
  id: "testing-quality-assurance.unit-testing.test-maintainability"
  name: "Test Maintainability"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 10
  subcategory: "unit-testing"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "testing"

  default_profiles:
    - "full"
    - "quality"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Assesses the maintainability of the test suite including test code
    quality, use of helper functions and fixtures, DRY principles,
    test organization, and how easily tests can be updated when
    production code changes.

  why_it_matters: |
    Unmaintainable tests become a burden rather than an asset. When tests
    are fragile, duplicated, or poorly organized, developers avoid updating
    them or skip writing new tests. A maintainable test suite enables
    confident refactoring and sustainable development velocity.

  when_to_run:
    - "Test suite health assessments"
    - "Before major refactoring"
    - "When test maintenance is becoming burdensome"
    - "New team member onboarding"

prerequisites:
  required_artifacts:
    - type: "test_suite"
      description: "Unit test files to analyze"

  access_requirements:
    - "Source code repository access"

discovery:
  file_patterns:
    - glob: "**/*.test.{js,ts,jsx,tsx}"
      purpose: "JavaScript/TypeScript unit tests"
    - glob: "**/test-utils/**"
      purpose: "Test utilities"
    - glob: "**/fixtures/**"
      purpose: "Test fixtures"
    - glob: "**/helpers/**"
      purpose: "Test helpers"
    - glob: "**/factories/**"
      purpose: "Test data factories"

  code_patterns:
    - pattern: "beforeEach|beforeAll|afterEach|afterAll"
      type: "regex"
      scope: "source"
      purpose: "Identify setup/teardown patterns"
    - pattern: "\\bfactory\\b|\\bfixture\\b|\\bhelper\\b"
      type: "regex"
      scope: "source"
      purpose: "Identify helper utilities"
    - pattern: "import.*from.*test-utils|import.*from.*helpers"
      type: "regex"
      scope: "source"
      purpose: "Identify shared test utilities"

knowledge_sources:
  specifications:
    - id: "xunit-patterns"
      name: "xUnit Test Patterns"
      url: "http://xunitpatterns.com/"
      offline_cache: true
      priority: "required"
    - id: "working-effectively-legacy"
      name: "Working Effectively with Legacy Code"
      url: "https://www.oreilly.com/library/view/working-effectively-with/0131177052/"
      offline_cache: true
      priority: "recommended"

  guides:
    - id: "maintainable-tests"
      name: "Writing Maintainable Unit Tests"
      url: "https://www.artofunittesting.com/"
      offline_cache: true
    - id: "tdd-by-example"
      name: "Kent Beck - Test Driven Development"
      url: "https://www.oreilly.com/library/view/test-driven-development/0321146530/"
      offline_cache: true

  learning_resources:
    - id: "xunit-patterns-book"
      title: "xUnit Test Patterns: Refactoring Test Code"
      type: "book"
      reference: "ISBN 978-0131495050"

tooling:
  static_analysis:
    - tool: "eslint"
      purpose: "Detect code quality issues in tests"
      offline_capable: true
    - tool: "sonarqube"
      purpose: "Test code duplication detection"
      offline_capable: true

  scripts:
    - id: "maintainability-analyzer"
      language: "bash"
      purpose: "Analyze test maintainability factors"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Test Maintainability Analysis ==="
        echo "Test helper files:"
        find . \( -path '*test-utils*' -o -path '*helpers*' -o -path '*fixtures*' \) -type f 2>/dev/null | head -20
        echo ""
        echo "Lines per test file (avg):"
        find . -name '*.test.*' 2>/dev/null | grep -v node_modules | head -20 | xargs wc -l 2>/dev/null | tail -1
        echo ""
        echo "Duplicate code patterns (similar describes):"
        grep -r -h "describe(" --include='*.test.*' . 2>/dev/null | sort | uniq -c | sort -rn | head -10

signals:
  critical:
    - id: "MAINT-CRIT-001"
      signal: "Massive test files (>1000 lines)"
      evidence_pattern: "Test files with >1000 lines of code"
      explanation: |
        Huge test files are difficult to navigate, understand, and
        maintain. They often indicate lack of modularization.
      remediation: "Split into smaller, focused test files"

    - id: "MAINT-CRIT-002"
      signal: "Extensive copy-paste duplication in tests"
      evidence_pattern: "Identical test setups repeated many times"
      explanation: |
        Duplicated code means changes require updates in multiple places.
        This leads to inconsistencies and increased maintenance burden.
      remediation: "Extract common setup to fixtures or factories"

  high:
    - id: "MAINT-HIGH-001"
      signal: "No test utilities or helpers"
      evidence_pattern: "No test-utils directory or shared helpers"
      explanation: |
        Without shared utilities, each test reinvents common patterns,
        leading to duplication and inconsistency.
      remediation: "Create test-utils module with common helpers"

    - id: "MAINT-HIGH-002"
      signal: "Tests coupled to implementation details"
      evidence_pattern: "Tests break with every refactor"
      explanation: |
        Tests that test internal details rather than behavior break
        frequently, creating maintenance burden and slowing development.
      remediation: "Refactor tests to focus on public API and behavior"

  medium:
    - id: "MAINT-MED-001"
      signal: "Complex setup in individual tests"
      evidence_pattern: ">10 lines of setup before action"
      remediation: "Extract setup to beforeEach or helper functions"

    - id: "MAINT-MED-002"
      signal: "Hard-coded test data throughout"
      evidence_pattern: "Literal values instead of factories/fixtures"
      remediation: "Create data factories or fixtures"

  low:
    - id: "MAINT-LOW-001"
      signal: "Inconsistent test file organization"
      evidence_pattern: "Mixed patterns for test placement"

  positive:
    - id: "MAINT-POS-001"
      signal: "Well-organized test utility library"
      evidence_pattern: "test-utils with documented helpers"
    - id: "MAINT-POS-002"
      signal: "Factory pattern for test data"
      evidence_pattern: "Data factories for complex objects"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Analyze test code organization"
      description: |
        Review how test code is organized including directory
        structure, file sizes, and use of shared utilities.
      duration_estimate: "25 min"
      commands:
        - purpose: "Check test file sizes"
          command: "find . -name '*.test.*' 2>/dev/null | grep -v node_modules | xargs wc -l 2>/dev/null | sort -rn | head -20"
        - purpose: "Find test utilities"
          command: "find . \\( -name 'test-utils*' -o -path '*/helpers/*' -o -path '*/fixtures/*' \\) -type f 2>/dev/null | head -20"
      expected_findings:
        - "Test file size distribution"
        - "Utility organization"

    - id: "2"
      name: "Evaluate code reuse"
      description: |
        Assess the extent to which test code is reused through
        helpers, factories, and shared setup.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find helper imports"
          command: "grep -r 'import.*from.*test\\|import.*from.*helper\\|import.*from.*fixture' --include='*.test.*' . 2>/dev/null | head -20"
        - purpose: "Check for factories"
          command: "find . -name '*factory*' -type f 2>/dev/null | head -10"
      expected_findings:
        - "Shared utility usage"
        - "Factory/fixture patterns"

    - id: "3"
      name: "Check for duplication"
      description: |
        Identify duplicated test code that could be refactored
        into shared utilities.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find similar setup patterns"
          command: "grep -r -h 'beforeEach' --include='*.test.*' . 2>/dev/null | sort | uniq -c | sort -rn | head -10"
        - purpose: "Find repeated describe blocks"
          command: "grep -r -h 'describe(' --include='*.test.*' . 2>/dev/null | sort | uniq -c | sort -rn | head -10"
      expected_findings:
        - "Duplication patterns"
        - "Refactoring opportunities"

    - id: "4"
      name: "Assess coupling"
      description: |
        Evaluate whether tests are coupled to implementation
        details or focused on behavior.
      duration_estimate: "20 min"
      questions:
        - "Do tests reference internal methods/variables?"
        - "How often do tests break during refactoring?"
        - "Are tests focused on public API?"
      expected_findings:
        - "Coupling assessment"
        - "Fragility indicators"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "maintainability_report"
      format: "table"
      sections:
        - "Organization Assessment"
        - "Code Reuse Analysis"
        - "Duplication Report"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Maintainability Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Full codebase analysis with metrics"
    medium: "Representative sample reviewed"
    low: "Based on structure patterns only"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "maintainable-tests"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Maintainability requires thorough assessment"
    full:
      included: true
      priority: 2

closeout_checklist:
  - id: "maint-001"
    item: "Test organization assessed"
    level: "CRITICAL"
    verification: "find . -name '*.test.*' | wc -l"
    expected: "PASS (organization documented)"

  - id: "maint-002"
    item: "Code reuse patterns documented"
    level: "BLOCKING"
    verification: "find . -name '*test-utils*' -o -name '*fixture*' 2>/dev/null | wc -l"
    expected: "PASS (patterns documented)"

  - id: "maint-003"
    item: "Duplication identified"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Document duplication patterns found"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.unit-testing.test-naming-convention"
    - "testing-quality-assurance.unit-testing.arrange-act-assert"
    - "code-quality.code-review.code-review-effectiveness"
