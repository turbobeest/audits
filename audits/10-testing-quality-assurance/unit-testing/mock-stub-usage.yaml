# ============================================================
# AUDIT: Mock and Stub Usage
# ============================================================
# Evaluates the proper use of test doubles including mocks,
# stubs, spies, and fakes in unit tests.
# ============================================================

audit:
  id: "testing-quality-assurance.unit-testing.mock-stub-usage"
  name: "Mock and Stub Usage"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 10
  subcategory: "unit-testing"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "testing"

  default_profiles:
    - "full"
    - "quality"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Reviews how test doubles (mocks, stubs, spies, fakes) are used in
    unit tests. Evaluates whether the right type of double is used for
    each scenario, whether mocks are over-used leading to brittle tests,
    and whether mock implementations accurately reflect real behavior.

  why_it_matters: |
    Improper use of mocks leads to tests that pass but don't verify real
    behavior. Over-mocking creates brittle tests that break with every
    refactor. Under-mocking leads to tests that are slow or depend on
    external systems. The right balance ensures tests are both fast and
    meaningful.

  when_to_run:
    - "Test quality assessment"
    - "After test refactoring"
    - "When tests pass but bugs reach production"
    - "Test suite maintenance reviews"

prerequisites:
  required_artifacts:
    - type: "test_suite"
      description: "Unit test files using mocks/stubs"
    - type: "source_code"
      description: "Source code to understand what's being mocked"

  access_requirements:
    - "Source code repository access"

discovery:
  file_patterns:
    - glob: "**/__mocks__/**"
      purpose: "Jest manual mocks"
    - glob: "**/mocks/**"
      purpose: "Mock implementation directories"
    - glob: "**/*.mock.{js,ts}"
      purpose: "Mock files"
    - glob: "**/fixtures/**"
      purpose: "Test fixtures"

  code_patterns:
    - pattern: "jest\\.mock\\(|vi\\.mock\\("
      type: "regex"
      scope: "source"
      purpose: "Module mocking"
    - pattern: "jest\\.spyOn\\(|vi\\.spyOn\\("
      type: "regex"
      scope: "source"
      purpose: "Spy usage"
    - pattern: "mockImplementation|mockReturnValue|mockResolvedValue"
      type: "regex"
      scope: "source"
      purpose: "Mock configuration"
    - pattern: "@Mock|@InjectMocks|when\\("
      type: "regex"
      scope: "source"
      purpose: "Mockito patterns (Java)"

knowledge_sources:
  specifications:
    - id: "xunit-patterns"
      name: "xUnit Test Patterns"
      url: "http://xunitpatterns.com/"
      offline_cache: true
      priority: "required"

  guides:
    - id: "test-doubles"
      name: "Test Doubles - Mocks, Stubs, and More"
      url: "https://martinfowler.com/bliki/TestDouble.html"
      offline_cache: true
    - id: "mocks-arent-stubs"
      name: "Mocks Aren't Stubs"
      url: "https://martinfowler.com/articles/mocksArentStubs.html"
      offline_cache: true
    - id: "tdd-by-example"
      name: "Kent Beck - Test Driven Development"
      url: "https://www.oreilly.com/library/view/test-driven-development/0321146530/"
      offline_cache: true

  learning_resources:
    - id: "xunit-patterns-book"
      title: "xUnit Test Patterns: Refactoring Test Code"
      type: "book"
      reference: "ISBN 978-0131495050"

tooling:
  static_analysis:
    - tool: "eslint-plugin-jest"
      purpose: "Detect mock-related issues"
      offline_capable: true

  scripts:
    - id: "mock-analyzer"
      language: "bash"
      purpose: "Analyze mock usage patterns"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Mock Usage Analysis ==="
        echo "Mock calls count:"
        grep -r -c 'jest\.mock\|vi\.mock' --include='*.test.*' . 2>/dev/null | awk -F: '{sum += $2} END {print sum}'
        echo ""
        echo "Spy usage count:"
        grep -r -c 'spyOn' --include='*.test.*' . 2>/dev/null | awk -F: '{sum += $2} END {print sum}'
        echo ""
        echo "Files with many mocks (>5):"
        grep -r -c 'jest\.mock\|mockImplementation' --include='*.test.*' . 2>/dev/null | awk -F: '$2 > 5 {print}' | head -10

signals:
  critical:
    - id: "MOCK-CRIT-001"
      signal: "Mocking the unit under test"
      evidence_pattern: "Mock on the module being tested itself"
      explanation: |
        Mocking the system under test means you're not testing real
        behavior at all. The test verifies mock behavior, not the code.
      remediation: "Remove mocks on the unit under test; mock only dependencies"

    - id: "MOCK-CRIT-002"
      signal: "Mock implementations don't match real behavior"
      evidence_pattern: "Mocks return success when real code can fail"
      explanation: |
        Mocks that don't reflect real behavior create false confidence.
        Tests pass but the code may fail with actual dependencies.
      remediation: "Ensure mocks accurately simulate real dependency behavior"

  high:
    - id: "MOCK-HIGH-001"
      signal: "Excessive mocking in single test (>5 mocks)"
      evidence_pattern: "Many jest.mock() calls in one test file"
      explanation: |
        Excessive mocking indicates the code has too many dependencies
        or the test is testing too much at once. It also makes tests brittle.
      remediation: "Refactor code to reduce dependencies or split tests"

    - id: "MOCK-HIGH-002"
      signal: "Mock assertions verify implementation details"
      evidence_pattern: "expect(mock).toHaveBeenCalledWith(exact.internal.args)"
      explanation: |
        Testing implementation details causes tests to break with every
        refactor, even when behavior is unchanged.
      remediation: "Test behavior/outcomes rather than internal method calls"

  medium:
    - id: "MOCK-MED-001"
      signal: "Inconsistent mock reset between tests"
      evidence_pattern: "mockReset/mockClear not called consistently"
      remediation: "Add jest.clearAllMocks() or equivalent in afterEach"

    - id: "MOCK-MED-002"
      signal: "Inline mock implementations are complex"
      evidence_pattern: "Multi-line mockImplementation with logic"
      remediation: "Extract complex mocks to __mocks__ directory or fixtures"

  low:
    - id: "MOCK-LOW-001"
      signal: "Inconsistent mock naming conventions"
      evidence_pattern: "Mixed mock file naming patterns"

  positive:
    - id: "MOCK-POS-001"
      signal: "Clear separation of mocks and fixtures"
      evidence_pattern: "__mocks__ and fixtures directories well organized"
    - id: "MOCK-POS-002"
      signal: "Appropriate use of spies for verification"
      evidence_pattern: "Spies used to verify calls without changing behavior"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory mock usage"
      description: |
        Catalog all mocking patterns used in the test suite
        including mocks, stubs, spies, and fakes.
      duration_estimate: "25 min"
      commands:
        - purpose: "Count mock calls"
          command: "grep -r -c 'jest\\.mock\\|vi\\.mock' --include='*.test.*' --include='*.spec.*' . 2>/dev/null | grep -v node_modules | head -30"
        - purpose: "Find mock directories"
          command: "find . -type d \\( -name '__mocks__' -o -name 'mocks' -o -name 'fixtures' \\) 2>/dev/null | head -10"
      expected_findings:
        - "Mock usage inventory"
        - "Mocking patterns in use"

    - id: "2"
      name: "Analyze mock complexity"
      description: |
        Evaluate the complexity of mock implementations and
        identify tests with excessive mocking.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find files with many mocks"
          command: "grep -r -c 'jest\\.mock\\|mockImplementation' --include='*.test.*' . 2>/dev/null | awk -F: '$2 > 3 {print}' | head -20"
        - purpose: "Find complex mock implementations"
          command: "grep -r -B2 -A5 'mockImplementation' --include='*.test.*' . 2>/dev/null | head -40"
      expected_findings:
        - "Complex mock implementations"
        - "Over-mocked test files"

    - id: "3"
      name: "Review mock-real parity"
      description: |
        Check whether mock implementations accurately reflect
        the behavior of real dependencies.
      duration_estimate: "25 min"
      commands:
        - purpose: "Sample mock implementations"
          command: "find . -path '*__mocks__*' -type f 2>/dev/null | head -10 | xargs head -30 2>/dev/null"
      expected_findings:
        - "Mock accuracy assessment"
        - "Gaps between mock and real behavior"

    - id: "4"
      name: "Check assertion patterns"
      description: |
        Evaluate whether mock assertions test behavior or
        implementation details.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find mock assertions"
          command: "grep -r 'toHaveBeenCalled\\|toHaveBeenCalledWith' --include='*.test.*' . 2>/dev/null | head -20"
      expected_findings:
        - "Assertion quality assessment"
        - "Implementation detail testing"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "mock_analysis"
      format: "table"
      sections:
        - "Mock Inventory"
        - "Complexity Assessment"
        - "Parity Analysis"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Mock Usage Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "All mock files reviewed with source comparison"
    medium: "Mock patterns analyzed without full source review"
    low: "Based on grep patterns only"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "test-doubles"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Mock analysis requires thorough code review"
    full:
      included: true
      priority: 2

closeout_checklist:
  - id: "mock-001"
    item: "Mock usage inventoried"
    level: "CRITICAL"
    verification: "find . -name '__mocks__' 2>/dev/null | wc -l"
    expected: "PASS (inventory documented)"

  - id: "mock-002"
    item: "Over-mocked tests identified"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "List tests with >5 mocks"
    expected: "Confirmed by reviewer"

  - id: "mock-003"
    item: "Mock-real parity assessed"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Document mock accuracy concerns"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Testability"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.unit-testing.test-isolation"
    - "testing-quality-assurance.unit-testing.test-maintainability"
    - "testing-quality-assurance.unit-testing.assertion-quality"
