# ============================================================
# AUDIT: Test Fixture Management
# ============================================================
# Evaluates practices for managing test fixtures and test data
# setup for automated testing.
# ============================================================

audit:
  id: "testing-quality-assurance.test-data-management.test-fixture-management"
  name: "Test Fixture Management"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 10
  subcategory: "test-data-management"

  tier: "expert"
  estimated_duration: "3 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "testing"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Examines test fixture management practices including fixture design,
    organization, reuse patterns, and lifecycle management. Reviews how
    test data dependencies are structured, shared fixtures are managed,
    and fixtures evolve with the application.

  why_it_matters: |
    Poor fixture management leads to brittle tests, slow execution, and
    maintenance burden. Well-organized fixtures enable fast test setup,
    clear dependencies, and easy updates when data models change. Good
    fixtures make tests readable and maintainable.

  when_to_run:
    - "Test infrastructure setup"
    - "After significant model changes"
    - "When fixture complexity increases"
    - "During test maintenance reviews"

prerequisites:
  required_artifacts:
    - type: "fixture-files"
      description: "Test fixture configurations and data"
    - type: "test-suite"
      description: "Automated test suite using fixtures"

  access_requirements:
    - "Test code repository access"
    - "Fixture file locations"

discovery:
  file_patterns:
    - glob: "**/fixtures/**"
      purpose: "Fixture directories"
    - glob: "**/conftest.py"
      purpose: "pytest fixtures"
    - glob: "**/__fixtures__/**"
      purpose: "Jest fixtures"
    - glob: "**/*.fixture.*"
      purpose: "Fixture files"

  code_patterns:
    - pattern: "@fixture|@pytest.fixture|fixture\\("
      type: "regex"
      scope: "source"
      purpose: "Fixture decorators"
    - pattern: "beforeAll|beforeEach|setUp"
      type: "keyword"
      scope: "source"
      purpose: "Setup hooks"
    - pattern: "scope.*session|scope.*module|scope.*function"
      type: "regex"
      scope: "source"
      purpose: "Fixture scoping"

knowledge_sources:
  guides:
    - id: "pytest-fixtures"
      name: "pytest Fixtures Documentation"
      url: "https://docs.pytest.org/en/stable/fixture.html"
      offline_cache: true
    - id: "jest-setup"
      name: "Jest Setup and Teardown"
      url: "https://jestjs.io/docs/setup-teardown"
      offline_cache: true

  learning_resources:
    - id: "fixture-patterns"
      title: "xUnit Test Patterns - Test Fixtures"
      type: "book"
      reference: "Gerard Meszaros"

tooling:
  static_analysis:
    - tool: "pytest"
      purpose: "Python fixture management"
      offline_capable: true
    - tool: "jest"
      purpose: "JavaScript fixture and setup"
      offline_capable: true
    - tool: "RSpec"
      purpose: "Ruby fixture management"
      offline_capable: true

signals:
  critical:
    - id: "FIXTURE-CRIT-001"
      signal: "Fixtures create global mutable state"
      evidence_pattern: "Global variables modified by fixtures without cleanup"
      explanation: |
        Global mutable fixtures cause test order dependencies and interference.
        Tests pass individually but fail when run together, making debugging
        extremely difficult and undermining test reliability.
      remediation: "Use isolated fixtures with proper scope and cleanup"

    - id: "FIXTURE-CRIT-002"
      signal: "Fixtures couple tests to database state"
      evidence_pattern: "Tests depending on pre-existing database records"
      explanation: |
        Database-coupled fixtures make tests fragile and environment-dependent.
        Tests fail when databases change, and running tests requires specific
        setup that may not be documented.
      remediation: "Create all test data within fixtures, don't rely on existing state"

  high:
    - id: "FIXTURE-HIGH-001"
      signal: "Excessive fixture complexity"
      evidence_pattern: "Deep fixture hierarchies or large setup code"
      explanation: |
        Complex fixtures are hard to understand and maintain. When fixtures
        are more complex than the tests themselves, something is wrong.
        This indicates either over-shared fixtures or poorly designed tests.
      remediation: "Simplify fixtures using composition and smaller, focused setups"

    - id: "FIXTURE-HIGH-002"
      signal: "No fixture isolation between tests"
      evidence_pattern: "Tests modifying shared fixtures without reset"
      explanation: |
        Non-isolated fixtures cause test interference. One test's modifications
        affect subsequent tests, leading to flaky behavior and difficult
        debugging.
      remediation: "Ensure fixture isolation through proper scoping and cleanup"

  medium:
    - id: "FIXTURE-MED-001"
      signal: "Fixtures not organized by domain"
      evidence_pattern: "All fixtures in single file or random locations"
      remediation: "Organize fixtures by domain or feature"

    - id: "FIXTURE-MED-002"
      signal: "Fixture reuse causing unnecessary coupling"
      evidence_pattern: "Tests using shared fixtures they don't need"
      remediation: "Create focused fixtures used only by relevant tests"

  low:
    - id: "FIXTURE-LOW-001"
      signal: "Fixture documentation missing"
      remediation: "Document fixture purpose and usage"

  positive:
    - id: "FIXTURE-POS-001"
      signal: "Well-organized isolated fixtures with clear scoping"
    - id: "FIXTURE-POS-002"
      signal: "Fixtures documented and composed modularly"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify fixture infrastructure"
      description: |
        Search for fixture configurations, fixture files, and setup
        patterns in the test suite.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find fixture files"
          command: "find . -type f \\( -name '*fixture*' -o -name 'conftest.py' \\) -not -path '*/node_modules/*' 2>/dev/null"
        - purpose: "Check for fixture decorators"
          command: "grep -r '@fixture\\|@pytest.fixture' . --include='*.py' 2>/dev/null | head -20"
      expected_findings:
        - "Fixture file locations"
        - "Fixture definition patterns"

    - id: "2"
      name: "Review fixture scoping"
      description: |
        Examine fixture scoping to understand lifecycle and potential
        for interference.
      duration_estimate: "30 min"
      commands:
        - purpose: "Check fixture scopes"
          command: "grep -r 'scope.*=\\|beforeAll\\|beforeEach' . --include='*.py' --include='*.ts' --include='*.js' 2>/dev/null | head -30"
        - purpose: "Check cleanup patterns"
          command: "grep -r 'afterEach\\|tearDown\\|cleanup\\|yield' . --include='*.py' --include='*.ts' --include='*.js' 2>/dev/null | head -20"
      expected_findings:
        - "Fixture scoping patterns"
        - "Cleanup implementations"

    - id: "3"
      name: "Assess fixture organization"
      description: |
        Review how fixtures are organized and whether they follow
        domain boundaries.
      duration_estimate: "25 min"
      commands:
        - purpose: "Check fixture directory structure"
          command: "find . -type d -name 'fixture*' -o -type d -name '__fixtures__' 2>/dev/null"
        - purpose: "Count fixtures per file"
          command: "for f in $(find . -name 'conftest.py' 2>/dev/null); do echo \"$f: $(grep -c '@fixture' \"$f\" 2>/dev/null || echo 0)\"; done | head -10"
      expected_findings:
        - "Fixture organization"
        - "Fixture distribution"

    - id: "4"
      name: "Check for global state issues"
      description: |
        Look for patterns that indicate global mutable state in fixtures.
      duration_estimate: "20 min"
      commands:
        - purpose: "Check for global modifications"
          command: "grep -r 'global\\|os.environ\\|monkeypatch' . --include='conftest.py' --include='*fixture*' 2>/dev/null | head -20"
      expected_findings:
        - "Global state usage"
        - "Environment modifications"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Fixture Organization Analysis"
        - "Isolation Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Fixtures reviewed, scoping verified, isolation confirmed"
    medium: "Structure reviewed but isolation not fully tested"
    low: "Limited visibility into fixture management"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "pytest-fixtures"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed fixture analysis"
    full:
      included: true
      priority: 2

closeout_checklist:
  - id: "fixture-management-001"
    item: "Fixture infrastructure exists"
    level: "CRITICAL"
    verification: "find . -name '*fixture*' -o -name 'conftest.py' 2>/dev/null | head -1 | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "fixture-management-002"
    item: "Fixtures properly scoped and isolated"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Reviewer confirms fixtures have appropriate scope and cleanup"
    expected: "Confirmed by reviewer"

  - id: "fixture-management-003"
    item: "No global mutable state in fixtures"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Reviewer confirms fixtures don't create global state"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "Internal"
      controls: ["QA-004"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.test-data-management.test-data-generation"
    - "testing-quality-assurance.test-automation.automated-test-maintenance"
    - "testing-quality-assurance.test-data-management.database-seeding"
