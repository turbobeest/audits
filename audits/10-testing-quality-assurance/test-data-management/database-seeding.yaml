# ============================================================
# AUDIT: Database Seeding
# ============================================================
# Evaluates database seeding practices for initializing test
# databases with appropriate data.
# ============================================================

audit:
  id: "testing-quality-assurance.test-data-management.database-seeding"
  name: "Database Seeding"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 10
  subcategory: "test-data-management"

  tier: "expert"
  estimated_duration: "3 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "yes"
  severity: "high"
  scope: "testing"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Examines database seeding practices for test environments including
    seed data design, migration management, reproducibility, and
    reset strategies. Reviews how databases are initialized, maintained,
    and cleaned between test runs.

  why_it_matters: |
    Inconsistent database state causes flaky tests and false failures.
    Proper seeding ensures tests start from a known state, execute
    reproducibly, and don't interfere with each other. Good seeding
    practices enable parallel test execution and fast feedback.

  when_to_run:
    - "Test infrastructure setup"
    - "After schema changes"
    - "When database-related test flakiness occurs"
    - "During test performance optimization"

prerequisites:
  required_artifacts:
    - type: "seed-scripts"
      description: "Database seeding scripts and migrations"
    - type: "database-schema"
      description: "Database schema definitions"

  access_requirements:
    - "Database access"
    - "Migration tools access"
    - "Seed script repository"

discovery:
  file_patterns:
    - glob: "**/seeds/**"
      purpose: "Seed data directories"
    - glob: "**/db/seeds*"
      purpose: "Rails-style seeds"
    - glob: "**/migrations/**"
      purpose: "Database migrations"
    - glob: "**/*seed*.{sql,js,py}"
      purpose: "Seed scripts"

  code_patterns:
    - pattern: "seed|Seed|seeder|Seeder"
      type: "keyword"
      scope: "source"
      purpose: "Seeding functions"
    - pattern: "migrate|migration|schema"
      type: "keyword"
      scope: "source"
      purpose: "Migration patterns"
    - pattern: "truncate|reset|clean"
      type: "keyword"
      scope: "source"
      purpose: "Database reset patterns"

knowledge_sources:
  guides:
    - id: "rails-seeds"
      name: "Rails Database Seeding"
      url: "https://guides.rubyonrails.org/active_record_migrations.html#migrations-and-seed-data"
      offline_cache: true
    - id: "knex-seeds"
      name: "Knex.js Seeds"
      url: "http://knexjs.org/guide/migrations.html#seed-files"
      offline_cache: true

tooling:
  infrastructure_tools:
    - tool: "Rails db:seed"
      purpose: "Ruby on Rails database seeding"
      command: "rails db:seed"
    - tool: "Knex"
      purpose: "JavaScript database seeding"
      command: "knex seed:run"
    - tool: "Alembic"
      purpose: "Python database migrations"
      command: "alembic upgrade head"
    - tool: "Flyway"
      purpose: "Java database migrations"
      command: "flyway migrate"

  scripts:
    - id: "seed-db"
      language: "bash"
      purpose: "Reset and seed database"
      source: "inline"
      code: |
        #!/bin/bash
        # Reset and seed test database
        echo "Resetting database..."
        DATABASE_URL=$TEST_DATABASE_URL npx prisma migrate reset --force

        echo "Running seeds..."
        DATABASE_URL=$TEST_DATABASE_URL npm run db:seed

        echo "Database ready for tests"

signals:
  critical:
    - id: "SEED-CRIT-001"
      signal: "No database seeding strategy"
      evidence_pattern: "Tests rely on manual database setup"
      explanation: |
        Without automated seeding, tests require manual database preparation.
        This makes tests environment-dependent, non-reproducible, and
        impossible to run in CI/CD pipelines.
      remediation: "Implement automated database seeding for test environments"

    - id: "SEED-CRIT-002"
      signal: "Seeding not idempotent"
      evidence_pattern: "Seeds fail on second run or create duplicates"
      explanation: |
        Non-idempotent seeds cause inconsistent test states. Running seeds
        multiple times should produce the same result. Duplicates or
        failures break test reproducibility.
      remediation: "Make seeding scripts idempotent with upserts or truncation"

  high:
    - id: "SEED-HIGH-001"
      signal: "Seeds not version controlled with migrations"
      evidence_pattern: "Seeds out of sync with schema changes"
      explanation: |
        Seeds that don't evolve with schema changes break after migrations.
        Seeds should be version controlled and updated alongside schema
        changes to maintain compatibility.
      remediation: "Version control seeds and update with schema changes"

    - id: "SEED-HIGH-002"
      signal: "No database reset between test suites"
      evidence_pattern: "Test data accumulating across runs"
      explanation: |
        Accumulating data causes test interference and growing test times.
        Each test suite should start from a known clean state to ensure
        reproducibility.
      remediation: "Implement database reset strategy between test runs"

  medium:
    - id: "SEED-MED-001"
      signal: "Seeding is slow"
      evidence_pattern: "Seed execution >30 seconds"
      remediation: "Optimize seeding with bulk inserts and minimal data"

    - id: "SEED-MED-002"
      signal: "Seeds contain hardcoded dates/times"
      evidence_pattern: "Absolute dates that become stale"
      remediation: "Use relative dates or configurable time in seeds"

  low:
    - id: "SEED-LOW-001"
      signal: "Seeding process not documented"
      remediation: "Document seeding process and troubleshooting"

  positive:
    - id: "SEED-POS-001"
      signal: "Automated idempotent seeding with CI/CD integration"
    - id: "SEED-POS-002"
      signal: "Fast reproducible database initialization"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify seeding infrastructure"
      description: |
        Search for database seeding scripts, migration tools, and
        seed configurations.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find seed files"
          command: "find . -type f \\( -name '*seed*' -o -path '*/seeds/*' \\) -not -path '*/node_modules/*' 2>/dev/null"
        - purpose: "Find migration files"
          command: "find . -type d -name 'migrations' -o -type d -name 'migrate' 2>/dev/null"
        - purpose: "Check package scripts"
          command: "grep -r 'seed\\|migrate' package.json 2>/dev/null"
      expected_findings:
        - "Seed script locations"
        - "Migration infrastructure"

    - id: "2"
      name: "Review seeding process"
      description: |
        Examine seeding scripts for idempotency, performance, and
        completeness.
      duration_estimate: "35 min"
      commands:
        - purpose: "Check for idempotency patterns"
          command: "grep -r 'upsert\\|ON CONFLICT\\|INSERT.*IGNORE\\|TRUNCATE' . --include='*seed*' --include='*.sql' 2>/dev/null | head -20"
        - purpose: "Check for cleanup"
          command: "grep -r 'truncate\\|delete.*from\\|reset' . --include='*seed*' 2>/dev/null | head -15"
      expected_findings:
        - "Idempotency mechanisms"
        - "Cleanup patterns"

    - id: "3"
      name: "Verify CI/CD integration"
      description: |
        Check that seeding is integrated into CI/CD test setup.
      duration_estimate: "20 min"
      commands:
        - purpose: "Check CI for seeding"
          command: "grep -r 'seed\\|migrate\\|db:setup' .github/workflows/ 2>/dev/null"
      expected_findings:
        - "CI seeding configuration"
        - "Database setup stages"

    - id: "4"
      name: "Assess seeding performance"
      description: |
        Review seeding execution time and optimization opportunities.
      duration_estimate: "20 min"
      questions:
        - "How long does seeding take?"
        - "Are bulk operations used for performance?"
        - "Is seeding parallelizable?"
      expected_findings:
        - "Seeding performance characteristics"
        - "Optimization opportunities"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Seeding Process Analysis"
        - "CI/CD Integration Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Seeding verified, idempotency confirmed, CI/CD integration validated"
    medium: "Scripts reviewed but execution not observed"
    low: "Limited visibility into seeding practices"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "rails-seeds"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires database and execution analysis"
    full:
      included: true
      priority: 2

closeout_checklist:
  - id: "database-seeding-001"
    item: "Database seeding scripts exist"
    level: "CRITICAL"
    verification: "find . -type f -name '*seed*' -not -path '*/node_modules/*' 2>/dev/null | head -1 | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "database-seeding-002"
    item: "Seeding is idempotent"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Reviewer confirms seeds can run multiple times without error"
    expected: "Confirmed by reviewer"

  - id: "database-seeding-003"
    item: "Seeding integrated into CI/CD"
    level: "WARNING"
    verification: "grep -r 'seed\\|migrate' .github/workflows/ 2>/dev/null | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["web-application", "api-service", "data-platform"]

  compliance_frameworks:
    - framework: "Internal"
      controls: ["QA-005"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.test-data-management.test-fixture-management"
    - "testing-quality-assurance.test-data-management.test-data-cleanup"
    - "testing-quality-assurance.test-automation.test-environment-provisioning"
