# ============================================================
# AUDIT: API Integration Testing
# ============================================================
# Evaluates the quality and coverage of API integration tests
# for both internal and external API interactions.
# ============================================================

audit:
  id: "testing-quality-assurance.integration-testing.api-integration-testing"
  name: "API Integration Testing"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 10
  subcategory: "integration-testing"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "testing"

  default_profiles:
    - "full"
    - "quality"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Assesses API integration testing practices including REST/GraphQL
    endpoint testing, request/response validation, authentication flows,
    error handling, API versioning, and contract testing. Covers both
    APIs the system exposes and APIs the system consumes.

  why_it_matters: |
    APIs are the primary integration points between services. Untested
    APIs lead to broken integrations, security vulnerabilities, and
    poor user experience. API integration tests catch issues before
    they affect other services or end users.

  when_to_run:
    - "Before API releases"
    - "After API changes"
    - "Service integration reviews"
    - "Contract negotiation with consumers"

prerequisites:
  required_artifacts:
    - type: "api_endpoints"
      description: "API route definitions and handlers"
    - type: "api_specs"
      description: "OpenAPI/GraphQL schemas (if available)"

  access_requirements:
    - "Source code repository access"
    - "Test environment access"
    - "API documentation access"

discovery:
  file_patterns:
    - glob: "**/*.api.test.{js,ts}"
      purpose: "API test files"
    - glob: "**/routes/*.test.{js,ts}"
      purpose: "Route tests"
    - glob: "**/controllers/*.test.{js,ts}"
      purpose: "Controller tests"
    - glob: "**/__tests__/api/**"
      purpose: "API test directories"

  code_patterns:
    - pattern: "supertest|request\\(app\\)"
      type: "regex"
      scope: "source"
      purpose: "Identify HTTP testing libraries"
    - pattern: "\\.get\\(|\\. post\\(|\\. put\\(|\\. delete\\("
      type: "regex"
      scope: "source"
      purpose: "Identify HTTP method tests"
    - pattern: "expect.*status|res\\.status"
      type: "regex"
      scope: "source"
      purpose: "Identify status code assertions"

knowledge_sources:
  guides:
    - id: "api-testing"
      name: "API Testing Best Practices"
      url: "https://www.postman.com/api-platform/api-testing/"
      offline_cache: true
    - id: "contract-testing"
      name: "Contract Testing Introduction"
      url: "https://docs.pact.io/"
      offline_cache: true

  learning_resources:
    - id: "api-design"
      title: "Design and Build Great Web APIs"
      type: "book"
      reference: "ISBN 978-1680506808"

tooling:
  static_analysis:
    - tool: "supertest"
      purpose: "HTTP assertions"
      offline_capable: true
    - tool: "pact"
      purpose: "Consumer-driven contract testing"
      offline_capable: true

  scripts:
    - id: "api-test-analyzer"
      language: "bash"
      purpose: "Analyze API test coverage"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== API Integration Testing Analysis ==="
        echo "API test files:"
        find . \( -name '*.api.test.*' -o -path '*routes*/*.test.*' -o -path '*controllers*/*.test.*' \) 2>/dev/null | grep -v node_modules | head -20
        echo ""
        echo "HTTP method coverage:"
        grep -r -h '\.get(\|\.post(\|\.put(\|\.delete(\|\.patch(' --include='*.test.*' . 2>/dev/null | grep -v node_modules | wc -l
        echo ""
        echo "Status code assertions:"
        grep -r 'expect.*status\|\.status(2\|\.status(4\|\.status(5' --include='*.test.*' . 2>/dev/null | grep -v node_modules | head -15

signals:
  critical:
    - id: "API-CRIT-001"
      signal: "No API integration tests exist"
      evidence_pattern: "Zero tests for API endpoints"
      explanation: |
        Without API tests, endpoint changes can break consumers without
        detection, leading to production incidents and broken integrations.
      remediation: "Add integration tests for all public API endpoints"

    - id: "API-CRIT-002"
      signal: "Authentication endpoints not tested"
      evidence_pattern: "No tests for login/auth flows"
      explanation: |
        Authentication is critical for security. Untested auth endpoints
        can have vulnerabilities that compromise the entire system.
      remediation: "Add comprehensive tests for all authentication flows"

  high:
    - id: "API-HIGH-001"
      signal: "Error responses not tested"
      evidence_pattern: "Only happy path (2xx) tests exist"
      explanation: |
        Untested error paths lead to poor error messages, information
        leakage, or unhandled exceptions in production.
      remediation: "Add tests for 4xx and 5xx error scenarios"

    - id: "API-HIGH-002"
      signal: "No contract tests with consumers"
      evidence_pattern: "No Pact or similar contract testing"
      explanation: |
        Without contract tests, API changes may break consumers without
        warning, leading to integration failures.
      remediation: "Implement consumer-driven contract testing"

  medium:
    - id: "API-MED-001"
      signal: "Request validation not tested"
      evidence_pattern: "No tests for invalid request handling"
      remediation: "Add tests for malformed requests and invalid inputs"

    - id: "API-MED-002"
      signal: "API versioning not tested"
      evidence_pattern: "Version header/path handling untested"
      remediation: "Add tests for API version negotiation"

  low:
    - id: "API-LOW-001"
      signal: "Response time assertions missing"
      evidence_pattern: "No performance expectations in tests"

  positive:
    - id: "API-POS-001"
      signal: "Comprehensive endpoint coverage"
      evidence_pattern: "All public endpoints have tests"
    - id: "API-POS-002"
      signal: "Contract testing implemented"
      evidence_pattern: "Pact or similar contracts maintained"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory API tests"
      description: |
        Locate all API-related tests and map them to the
        endpoints they cover.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find API test files"
          command: "find . \\( -name '*api*' -o -path '*routes*' -o -path '*controller*' \\) -name '*.test.*' 2>/dev/null | grep -v node_modules | head -25"
        - purpose: "Find supertest usage"
          command: "grep -r -l 'supertest\\|request(app)' --include='*.test.*' . 2>/dev/null | head -15"
      expected_findings:
        - "API test inventory"
        - "Testing library usage"

    - id: "2"
      name: "Analyze endpoint coverage"
      description: |
        Determine what percentage of API endpoints have
        corresponding integration tests.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find route definitions"
          command: "grep -r 'app\\.get\\|app\\.post\\|router\\.' --include='*.ts' --include='*.js' . 2>/dev/null | grep -v test | grep -v node_modules | head -20"
        - purpose: "Count tested methods"
          command: "grep -r -c '\\.get(\\|\\.post(\\|\\.put(\\|\\.delete(' --include='*.test.*' . 2>/dev/null | grep -v ':0' | head -20"
      expected_findings:
        - "Endpoint coverage estimate"
        - "HTTP method coverage"

    - id: "3"
      name: "Review error handling tests"
      description: |
        Check whether API tests cover error scenarios including
        validation errors, authentication failures, and server errors.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find error status tests"
          command: "grep -r 'status(4\\|status(5\\|expect.*4\\|expect.*5' --include='*.test.*' . 2>/dev/null | head -20"
        - purpose: "Find auth failure tests"
          command: "grep -r '401\\|403\\|unauthorized' --include='*.test.*' . 2>/dev/null | head -10"
      expected_findings:
        - "Error scenario coverage"
        - "Auth failure testing"

    - id: "4"
      name: "Check for contract testing"
      description: |
        Determine if consumer-driven contract testing is
        implemented for API consumers.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find Pact or contract tests"
          command: "find . -name 'pact*' -o -name '*contract*' 2>/dev/null | head -10; grep -r 'pact\\|contract' --include='*.json' . 2>/dev/null | head -10"
      expected_findings:
        - "Contract testing presence"
        - "Consumer contracts"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "api_coverage_report"
      format: "table"
      sections:
        - "Endpoint Inventory"
        - "Coverage Analysis"
        - "Error Handling Coverage"
        - "Contract Testing Status"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "API Testing Assessment"
        - "Risk Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "API tests executed against running service"
    medium: "Test files reviewed without execution"
    low: "Based on file patterns only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "api-testing"
        priority: "required"

profiles:
  membership:
    quick:
      included: true
      reason: "Quick endpoint coverage check"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "api-001"
    item: "API tests inventoried"
    level: "CRITICAL"
    verification: "grep -r 'supertest' --include='*.test.*' . | wc -l"
    expected: "PASS (count documented)"

  - id: "api-002"
    item: "Endpoint coverage assessed"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Document tested vs untested endpoints"
    expected: "Confirmed by reviewer"

  - id: "api-003"
    item: "Error handling tests verified"
    level: "BLOCKING"
    verification: "grep -r 'status(4\\|status(5' --include='*.test.*' . | wc -l"
    expected: "PASS (count > 0)"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Interoperability"]

relationships:
  commonly_combined:
    - "api-integration.api-design.rest-api-design"
    - "testing-quality-assurance.integration-testing.external-service-testing"
    - "security-trust.authentication.authentication-implementation"
