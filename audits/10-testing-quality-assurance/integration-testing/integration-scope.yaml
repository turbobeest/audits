# ============================================================
# AUDIT: Integration Test Scope
# ============================================================
# Evaluates the appropriate scope and boundaries of integration
# tests within the testing strategy.
# ============================================================

audit:
  id: "testing-quality-assurance.integration-testing.integration-scope"
  name: "Integration Test Scope"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 10
  subcategory: "integration-testing"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "testing"

  default_profiles:
    - "full"
    - "quality"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates whether integration tests have appropriate scope - testing
    interactions between components without becoming full E2E tests.
    Assesses the boundaries between unit tests, integration tests, and
    E2E tests, ensuring each layer tests what it's designed to verify.

  why_it_matters: |
    Improperly scoped integration tests either duplicate unit tests (wasted
    effort) or become slow, flaky E2E tests in disguise. Well-scoped
    integration tests efficiently verify that components work together
    while remaining fast and reliable enough for frequent execution.

  when_to_run:
    - "Test strategy reviews"
    - "When integration tests become slow or flaky"
    - "After microservice architecture changes"
    - "CI pipeline optimization"

prerequisites:
  required_artifacts:
    - type: "test_suite"
      description: "Integration test files to analyze"
    - type: "architecture_docs"
      description: "System architecture showing component boundaries"

  access_requirements:
    - "Source code repository access"
    - "Architecture documentation access"

discovery:
  file_patterns:
    - glob: "**/integration/**/*.test.{js,ts}"
      purpose: "Integration test directories"
    - glob: "**/*.integration.test.{js,ts}"
      purpose: "Integration test naming convention"
    - glob: "**/tests/integration/**"
      purpose: "Integration test organization"

  code_patterns:
    - pattern: "supertest|request\\(app\\)"
      type: "regex"
      scope: "source"
      purpose: "Identify API integration tests"
    - pattern: "testcontainers|TestContainers"
      type: "keyword"
      scope: "source"
      purpose: "Identify container-based integration tests"
    - pattern: "beforeAll.*connect|afterAll.*disconnect"
      type: "regex"
      scope: "source"
      purpose: "Identify database integration tests"

knowledge_sources:
  guides:
    - id: "integration-testing"
      name: "Integration Testing Best Practices"
      url: "https://martinfowler.com/bliki/IntegrationTest.html"
      offline_cache: true
    - id: "testing-pyramid"
      name: "The Practical Test Pyramid"
      url: "https://martinfowler.com/articles/practical-test-pyramid.html"
      offline_cache: true

  learning_resources:
    - id: "continuous-delivery"
      title: "Continuous Delivery"
      type: "book"
      reference: "ISBN 978-0321601919"

tooling:
  static_analysis:
    - tool: "test-analyzer"
      purpose: "Analyze test scope and dependencies"
      offline_capable: true

  scripts:
    - id: "scope-analyzer"
      language: "bash"
      purpose: "Analyze integration test scope"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Integration Test Scope Analysis ==="
        echo "Integration test files:"
        find . \( -path '*integration*' -o -name '*integration*' \) -name '*.test.*' 2>/dev/null | grep -v node_modules | head -20
        echo ""
        echo "External dependencies in integration tests:"
        grep -r 'supertest\|testcontainers\|mongoose\|sequelize\|redis' --include='*.test.*' . 2>/dev/null | grep -v node_modules | head -20

signals:
  critical:
    - id: "SCOPE-CRIT-001"
      signal: "Integration tests test single units in isolation"
      evidence_pattern: "Tests labeled 'integration' with no component interaction"
      explanation: |
        Integration tests that don't test integration are mislabeled unit tests.
        This wastes time and confuses the testing strategy.
      remediation: "Reclassify as unit tests or add actual integration points"

    - id: "SCOPE-CRIT-002"
      signal: "Integration tests are actually E2E tests"
      evidence_pattern: "Tests spin up entire system with UI interaction"
      explanation: |
        E2E tests masquerading as integration tests cause slow pipelines
        and flakiness in what should be stable integration verification.
      remediation: "Move to E2E suite or reduce scope to true integration"

  high:
    - id: "SCOPE-HIGH-001"
      signal: "Integration tests cross too many boundaries"
      evidence_pattern: "Single test touches >3 services/databases"
      explanation: |
        Tests with excessive scope are slow, hard to debug, and prone
        to failure from any of many components.
      remediation: "Split into smaller integration tests focused on specific boundaries"

    - id: "SCOPE-HIGH-002"
      signal: "No clear integration test boundary definition"
      evidence_pattern: "Mixed scope tests in integration directory"
      explanation: |
        Without clear scope definition, tests accumulate with inconsistent
        purposes, making the suite hard to maintain.
      remediation: "Define and document integration test scope guidelines"

  medium:
    - id: "SCOPE-MED-001"
      signal: "Integration tests duplicate unit test coverage"
      evidence_pattern: "Same logic tested in both layers"
      remediation: "Remove duplicated tests from integration layer"

    - id: "SCOPE-MED-002"
      signal: "Integration tests don't test real integration points"
      evidence_pattern: "All external services mocked"
      remediation: "Ensure at least one real integration point per test"

  low:
    - id: "SCOPE-LOW-001"
      signal: "Integration test naming doesn't indicate scope"
      evidence_pattern: "Generic test names without component indication"

  positive:
    - id: "SCOPE-POS-001"
      signal: "Clear integration test scope documented"
      evidence_pattern: "Guidelines define what integration tests should cover"
    - id: "SCOPE-POS-002"
      signal: "Tests focused on specific integration points"
      evidence_pattern: "Each test verifies one component interaction"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify integration tests"
      description: |
        Locate all tests classified as integration tests and understand
        how they're organized.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find integration test files"
          command: "find . \\( -path '*integration*' -o -name '*integration*' \\) -name '*.test.*' 2>/dev/null | grep -v node_modules | head -30"
        - purpose: "Count integration vs unit tests"
          command: "echo 'Integration:' && find . -path '*integration*' -name '*.test.*' 2>/dev/null | wc -l && echo 'Unit:' && find . -path '*unit*' -name '*.test.*' 2>/dev/null | wc -l"
      expected_findings:
        - "Integration test inventory"
        - "Test organization patterns"

    - id: "2"
      name: "Analyze test scope"
      description: |
        Review integration tests to understand what boundaries and
        interactions they're testing.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find external dependencies"
          command: "grep -r -l 'supertest\\|testcontainers\\|mongoose\\|redis' --include='*.test.*' . 2>/dev/null | head -20"
        - purpose: "Sample integration test structure"
          command: "find . -path '*integration*' -name '*.test.*' 2>/dev/null | head -3 | xargs head -50 2>/dev/null"
      expected_findings:
        - "Integration points tested"
        - "Scope of each test"

    - id: "3"
      name: "Check for scope issues"
      description: |
        Identify tests with inappropriate scope - too narrow (unit)
        or too broad (E2E).
      duration_estimate: "25 min"
      commands:
        - purpose: "Find tests without external deps"
          command: "for f in $(find . -path '*integration*' -name '*.test.*' 2>/dev/null | head -10); do grep -L 'supertest\\|database\\|connect' \"$f\" 2>/dev/null; done"
      expected_findings:
        - "Mislabeled tests"
        - "Scope violations"

    - id: "4"
      name: "Assess scope documentation"
      description: |
        Check for documentation defining what integration tests
        should and shouldn't cover.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find testing documentation"
          command: "find . -name '*test*' -name '*.md' 2>/dev/null | head -5"
      questions:
        - "Is integration test scope documented?"
        - "Are guidelines being followed?"
      expected_findings:
        - "Documentation presence"
        - "Guideline adherence"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "scope_analysis"
      format: "table"
      sections:
        - "Integration Test Inventory"
        - "Scope Assessment"
        - "Boundary Analysis"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Scope Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "All integration tests reviewed for scope"
    medium: "Representative sample reviewed"
    low: "Based on file patterns only"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "integration-testing"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Scope analysis requires thorough review"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "scope-001"
    item: "Integration tests inventoried"
    level: "CRITICAL"
    verification: "find . -path '*integration*' -name '*.test.*' | wc -l"
    expected: "PASS (count documented)"

  - id: "scope-002"
    item: "Scope appropriateness assessed"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Document tests with inappropriate scope"
    expected: "Confirmed by reviewer"

  - id: "scope-003"
    item: "Scope guidelines reviewed"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Check for scope documentation"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Testability"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.test-strategy.test-pyramid-balance"
    - "testing-quality-assurance.integration-testing.integration-test-isolation"
    - "testing-quality-assurance.e2e-testing.e2e-coverage"
