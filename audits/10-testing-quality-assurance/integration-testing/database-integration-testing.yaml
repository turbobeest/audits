# ============================================================
# AUDIT: Database Integration Testing
# ============================================================
# Evaluates the quality and coverage of database integration
# tests including schema, queries, and transactions.
# ============================================================

audit:
  id: "testing-quality-assurance.integration-testing.database-integration-testing"
  name: "Database Integration Testing"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 10
  subcategory: "integration-testing"

  tier: "expert"
  estimated_duration: "2.5 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "testing"

  default_profiles:
    - "full"
    - "quality"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Assesses database integration testing practices including testing
    database connections, query correctness, transaction handling,
    migration testing, data integrity constraints, and performance
    under load. Evaluates use of test databases and data isolation.

  why_it_matters: |
    Database issues are among the most severe production incidents.
    Untested database code can corrupt data, cause data loss, or
    create security vulnerabilities. Database integration tests ensure
    data layer code works correctly with real database behavior.

  when_to_run:
    - "Before database migrations"
    - "When adding new database operations"
    - "Data layer security reviews"
    - "Performance optimization efforts"

prerequisites:
  required_artifacts:
    - type: "database_layer"
      description: "Database access code (repositories, models, queries)"
    - type: "test_database"
      description: "Test database configuration"

  access_requirements:
    - "Source code repository access"
    - "Test database access"
    - "Database schema documentation"

discovery:
  file_patterns:
    - glob: "**/*.repository.{js,ts}"
      purpose: "Repository pattern files"
    - glob: "**/models/**"
      purpose: "Database models"
    - glob: "**/migrations/**"
      purpose: "Database migrations"
    - glob: "**/*database*.test.{js,ts}"
      purpose: "Database tests"

  code_patterns:
    - pattern: "prisma|sequelize|mongoose|knex|typeorm"
      type: "keyword"
      scope: "source"
      purpose: "Identify ORM/database libraries"
    - pattern: "testcontainers|TestContainer"
      type: "keyword"
      scope: "source"
      purpose: "Identify container-based database testing"
    - pattern: "BEGIN|COMMIT|ROLLBACK|transaction"
      type: "keyword"
      scope: "source"
      purpose: "Identify transaction handling"

knowledge_sources:
  guides:
    - id: "testcontainers"
      name: "Testcontainers Database Testing"
      url: "https://www.testcontainers.org/modules/databases/"
      offline_cache: true
    - id: "database-testing"
      name: "Database Testing Best Practices"
      url: "https://www.guru99.com/database-testing.html"
      offline_cache: true

  learning_resources:
    - id: "sql-antipatterns"
      title: "SQL Antipatterns"
      type: "book"
      reference: "ISBN 978-1934356555"

tooling:
  infrastructure_tools:
    - tool: "testcontainers"
      purpose: "Spin up real databases for testing"
      command: "npm test -- --testcontainers"
    - tool: "docker"
      purpose: "Database containers"
      command: "docker-compose -f docker-compose.test.yml up db"

  scripts:
    - id: "db-test-analyzer"
      language: "bash"
      purpose: "Analyze database testing"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Database Integration Testing Analysis ==="
        echo "Database test files:"
        find . -name '*database*.test.*' -o -name '*repository*.test.*' 2>/dev/null | grep -v node_modules | head -15
        echo ""
        echo "ORM/database library usage:"
        grep -r -l 'prisma\|sequelize\|mongoose\|typeorm' --include='*.test.*' . 2>/dev/null | grep -v node_modules | wc -l
        echo ""
        echo "Transaction tests:"
        grep -r 'transaction\|BEGIN\|COMMIT\|ROLLBACK' --include='*.test.*' . 2>/dev/null | grep -v node_modules | head -10

signals:
  critical:
    - id: "DB-CRIT-001"
      signal: "No database integration tests exist"
      evidence_pattern: "Zero tests using actual database connection"
      explanation: |
        Without database integration tests, SQL/query bugs only appear in
        production, risking data corruption and outages.
      remediation: "Add database integration tests for all data access patterns"

    - id: "DB-CRIT-002"
      signal: "Tests run against production database"
      evidence_pattern: "Production database credentials in test config"
      explanation: |
        Testing against production risks data corruption, privacy violations,
        and potential outages from test load.
      remediation: "Configure isolated test database immediately"

  high:
    - id: "DB-HIGH-001"
      signal: "Transaction handling not tested"
      evidence_pattern: "No tests for commit/rollback behavior"
      explanation: |
        Untested transaction handling leads to partial updates, data
        inconsistency, and difficult-to-debug production issues.
      remediation: "Add tests for transaction commit and rollback scenarios"

    - id: "DB-HIGH-002"
      signal: "Migration tests missing"
      evidence_pattern: "No tests verifying migrations apply correctly"
      explanation: |
        Failed migrations can cause outages and data loss. Testing
        migrations before deployment prevents production incidents.
      remediation: "Add migration testing to deployment pipeline"

  medium:
    - id: "DB-MED-001"
      signal: "Constraint violation handling not tested"
      evidence_pattern: "No tests for unique/foreign key violations"
      remediation: "Add tests for all database constraint violations"

    - id: "DB-MED-002"
      signal: "Connection pool exhaustion not tested"
      evidence_pattern: "No tests for high-concurrency scenarios"
      remediation: "Add stress tests for connection pool behavior"

  low:
    - id: "DB-LOW-001"
      signal: "Test data cleanup inconsistent"
      evidence_pattern: "Data persists between test runs"

  positive:
    - id: "DB-POS-001"
      signal: "Testcontainers or equivalent in use"
      evidence_pattern: "Real database containers for testing"
    - id: "DB-POS-002"
      signal: "Migration tests in CI pipeline"
      evidence_pattern: "Migrations tested before deployment"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify database tests"
      description: |
        Locate all database-related tests and understand the
        database testing infrastructure.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find database test files"
          command: "find . \\( -name '*database*' -o -name '*repository*' -o -name '*model*' \\) -name '*.test.*' 2>/dev/null | grep -v node_modules | head -20"
        - purpose: "Check for test database config"
          command: "find . -name '*.test.*' -name '*config*' 2>/dev/null | head -5; grep -r 'TEST.*DATABASE\\|database.*test' . 2>/dev/null | head -10"
      expected_findings:
        - "Database test inventory"
        - "Test database configuration"

    - id: "2"
      name: "Assess database isolation"
      description: |
        Verify test database is isolated from production and
        tests are isolated from each other.
      duration_estimate: "25 min"
      commands:
        - purpose: "Check for testcontainers"
          command: "grep -r 'testcontainers\\|TestContainer' --include='*.test.*' --include='*.json' . 2>/dev/null | head -10"
        - purpose: "Check database URLs"
          command: "grep -r 'DATABASE_URL\\|mongodb://\\|postgres://' --include='*.test.*' --include='.env.test*' . 2>/dev/null | head -10"
      expected_findings:
        - "Database isolation mechanism"
        - "Production data protection"

    - id: "3"
      name: "Review transaction testing"
      description: |
        Check whether transaction behavior is properly tested
        including commits, rollbacks, and error scenarios.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find transaction tests"
          command: "grep -r -B5 -A10 'transaction\\|COMMIT\\|ROLLBACK' --include='*.test.*' . 2>/dev/null | head -50"
      expected_findings:
        - "Transaction test coverage"
        - "Error handling tests"

    - id: "4"
      name: "Check migration testing"
      description: |
        Assess whether database migrations are tested before
        deployment.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find migration tests"
          command: "find . -path '*migration*' -name '*.test.*' 2>/dev/null | head -10"
        - purpose: "Check CI for migration testing"
          command: "grep -r 'migrate\\|migration' .github/workflows/*.yml 2>/dev/null | head -10"
      expected_findings:
        - "Migration testing presence"
        - "CI migration verification"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "database_test_report"
      format: "table"
      sections:
        - "Test Inventory"
        - "Isolation Assessment"
        - "Transaction Coverage"
        - "Migration Testing"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Database Testing Assessment"
        - "Risk Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Database tests executed and verified"
    medium: "Test configuration reviewed"
    low: "Based on file patterns only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "testcontainers"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Database testing requires runtime verification"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "db-001"
    item: "Database tests identified"
    level: "CRITICAL"
    verification: "find . -name '*database*.test.*' -o -name '*repository*.test.*' | wc -l"
    expected: "PASS (count documented)"

  - id: "db-002"
    item: "Production database isolation verified"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Confirm tests do not use production database"
    expected: "Confirmed by reviewer"

  - id: "db-003"
    item: "Transaction testing assessed"
    level: "BLOCKING"
    verification: "grep -r 'transaction' --include='*.test.*' . | wc -l"
    expected: "PASS (coverage documented)"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["Data Integrity"]
    - framework: "GDPR"
      controls: ["Data Protection"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.integration-testing.integration-test-isolation"
    - "data-state-management.data-integrity.data-validation"
    - "reliability-resilience.backup-recovery.database-backup"
