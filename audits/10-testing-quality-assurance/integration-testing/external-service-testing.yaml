# ============================================================
# AUDIT: External Service Testing
# ============================================================
# Evaluates testing practices for integrations with external
# third-party services and APIs.
# ============================================================

audit:
  id: "testing-quality-assurance.integration-testing.external-service-testing"
  name: "External Service Testing"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 10
  subcategory: "integration-testing"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "testing"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Assesses testing practices for integrations with external third-party
    services including payment gateways, email providers, cloud services,
    and partner APIs. Evaluates mocking strategies, contract testing,
    fallback behavior, and error handling for external dependencies.

  why_it_matters: |
    External service failures are outside your control but affect your
    users directly. Without proper testing, external service issues cause
    cascading failures, poor error messages, and degraded user experience.
    Proper testing ensures graceful degradation and correct error handling.

  when_to_run:
    - "When adding new external integrations"
    - "Before production deployments"
    - "After external service updates"
    - "Reliability reviews"

prerequisites:
  required_artifacts:
    - type: "service_clients"
      description: "External service client implementations"
    - type: "service_mocks"
      description: "Mock implementations for testing"

  access_requirements:
    - "Source code repository access"
    - "External service documentation"

discovery:
  file_patterns:
    - glob: "**/clients/**"
      purpose: "Service client code"
    - glob: "**/integrations/**"
      purpose: "Integration modules"
    - glob: "**/services/**"
      purpose: "Service wrappers"
    - glob: "**/__mocks__/**"
      purpose: "Mock implementations"

  code_patterns:
    - pattern: "stripe|paypal|twilio|sendgrid|aws-sdk"
      type: "keyword"
      scope: "source"
      purpose: "Identify third-party service libraries"
    - pattern: "nock|msw|polly|vcr"
      type: "keyword"
      scope: "source"
      purpose: "Identify HTTP mocking libraries"
    - pattern: "timeout|retry|fallback|circuit"
      type: "keyword"
      scope: "source"
      purpose: "Identify resilience patterns"

knowledge_sources:
  guides:
    - id: "external-service-testing"
      name: "Testing External Services"
      url: "https://mswjs.io/docs/basics/mocking-responses"
      offline_cache: true
    - id: "resilience-patterns"
      name: "Resilience Patterns"
      url: "https://docs.microsoft.com/en-us/azure/architecture/patterns/category/resiliency"
      offline_cache: true

  learning_resources:
    - id: "release-it"
      title: "Release It! Design and Deploy Production-Ready Software"
      type: "book"
      reference: "ISBN 978-1680502398"

tooling:
  static_analysis:
    - tool: "nock"
      purpose: "HTTP request mocking for Node.js"
      offline_capable: true
    - tool: "msw"
      purpose: "API mocking for tests"
      offline_capable: true
    - tool: "wiremock"
      purpose: "HTTP mock server"
      offline_capable: true

  scripts:
    - id: "external-service-analyzer"
      language: "bash"
      purpose: "Analyze external service testing"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== External Service Testing Analysis ==="
        echo "Third-party service usage:"
        grep -r -l 'stripe\|paypal\|twilio\|sendgrid\|aws-sdk\|axios' --include='*.ts' --include='*.js' . 2>/dev/null | grep -v node_modules | grep -v test | head -15
        echo ""
        echo "HTTP mocking in tests:"
        grep -r 'nock\|msw\|polly\|jest.mock.*axios' --include='*.test.*' . 2>/dev/null | grep -v node_modules | head -15
        echo ""
        echo "Timeout/retry tests:"
        grep -r 'timeout\|retry\|fallback' --include='*.test.*' . 2>/dev/null | grep -v node_modules | head -10

signals:
  critical:
    - id: "EXT-CRIT-001"
      signal: "External services called in tests without mocking"
      evidence_pattern: "Real API calls in unit/integration tests"
      explanation: |
        Real external calls make tests slow, flaky, and dependent on
        third-party availability. They may also incur costs or rate limits.
      remediation: "Mock all external service calls in tests"

    - id: "EXT-CRIT-002"
      signal: "External service errors not tested"
      evidence_pattern: "No tests for API failures, timeouts, or errors"
      explanation: |
        External services fail in production. Without error testing,
        failures cause unhandled exceptions and poor user experience.
      remediation: "Add tests for all external service error scenarios"

  high:
    - id: "EXT-HIGH-001"
      signal: "Timeout handling not tested"
      evidence_pattern: "No tests for service timeout behavior"
      explanation: |
        Slow external services can block application threads and cause
        cascading failures. Timeout behavior must be verified.
      remediation: "Add tests verifying timeout handling"

    - id: "EXT-HIGH-002"
      signal: "Retry logic not tested"
      evidence_pattern: "Retry implementation without corresponding tests"
      explanation: |
        Incorrect retry logic can cause infinite loops, amplify failures,
        or fail to recover from transient errors.
      remediation: "Add tests for retry behavior and limits"

  medium:
    - id: "EXT-MED-001"
      signal: "Mock responses don't match real API"
      evidence_pattern: "Mocks return simplified/incorrect responses"
      remediation: "Update mocks to match actual API responses"

    - id: "EXT-MED-002"
      signal: "Circuit breaker not tested"
      evidence_pattern: "Circuit breaker implemented without tests"
      remediation: "Add tests for circuit breaker state transitions"

  low:
    - id: "EXT-LOW-001"
      signal: "Rate limiting handling not tested"
      evidence_pattern: "No tests for 429 responses"

  positive:
    - id: "EXT-POS-001"
      signal: "Comprehensive external service mocking"
      evidence_pattern: "All external calls mocked with realistic responses"
    - id: "EXT-POS-002"
      signal: "Resilience patterns fully tested"
      evidence_pattern: "Timeout, retry, and circuit breaker tests exist"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify external services"
      description: |
        Locate all external service integrations and understand
        the dependencies.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find external service usage"
          command: "grep -r -l 'stripe\\|paypal\\|twilio\\|sendgrid\\|aws-sdk' --include='*.ts' --include='*.js' . 2>/dev/null | grep -v node_modules | head -20"
        - purpose: "Find HTTP client usage"
          command: "grep -r -l 'axios\\|fetch\\|got\\|request' --include='*.ts' --include='*.js' . 2>/dev/null | grep -v node_modules | grep -v test | head -15"
      expected_findings:
        - "External service inventory"
        - "HTTP client patterns"

    - id: "2"
      name: "Analyze mocking strategy"
      description: |
        Review how external services are mocked in tests and
        assess mock quality.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find mocking libraries"
          command: "grep -r 'nock\\|msw\\|polly\\|jest.mock' --include='*.test.*' . 2>/dev/null | grep -v node_modules | head -20"
        - purpose: "Check mock directory"
          command: "find . -path '*__mocks__*' -type f 2>/dev/null | head -15"
      expected_findings:
        - "Mocking approach"
        - "Mock coverage"

    - id: "3"
      name: "Review error handling tests"
      description: |
        Check whether external service error scenarios are
        properly tested.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find error tests"
          command: "grep -r 'timeout\\|error\\|fail\\|reject\\|catch' --include='*client*.test.*' --include='*service*.test.*' . 2>/dev/null | head -20"
        - purpose: "Find status code tests"
          command: "grep -r '500\\|503\\|429\\|timeout' --include='*.test.*' . 2>/dev/null | head -15"
      expected_findings:
        - "Error scenario coverage"
        - "Timeout testing"

    - id: "4"
      name: "Check resilience testing"
      description: |
        Verify that resilience patterns (retry, circuit breaker)
        are properly tested.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find resilience tests"
          command: "grep -r 'retry\\|circuit.*breaker\\|fallback' --include='*.test.*' . 2>/dev/null | head -15"
      expected_findings:
        - "Resilience pattern testing"
        - "Fallback behavior tests"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "external_service_report"
      format: "table"
      sections:
        - "Service Inventory"
        - "Mocking Assessment"
        - "Error Handling Coverage"
        - "Resilience Testing"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "External Service Testing Assessment"
        - "Risk Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "All external services mapped with test coverage"
    medium: "Service inventory with partial test review"
    low: "Based on grep patterns only"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "external-service-testing"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "External service analysis requires thorough review"
    full:
      included: true
      priority: 2

closeout_checklist:
  - id: "ext-001"
    item: "External services identified"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Document all external service dependencies"
    expected: "Confirmed by reviewer"

  - id: "ext-002"
    item: "Mocking strategy assessed"
    level: "BLOCKING"
    verification: "grep -r 'nock\\|msw' --include='*.test.*' . | wc -l"
    expected: "PASS (mocking documented)"

  - id: "ext-003"
    item: "Error handling tests verified"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Document error scenario test coverage"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Reliability", "Fault Tolerance"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.integration-testing.api-integration-testing"
    - "reliability-resilience.fault-tolerance.circuit-breaker-pattern"
    - "reliability-resilience.fault-tolerance.retry-strategies"
