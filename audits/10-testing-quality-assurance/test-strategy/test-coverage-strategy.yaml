# ============================================================
# AUDIT: Test Coverage Strategy
# ============================================================
# Evaluates the organization's approach to measuring and
# managing test coverage across the codebase.
# ============================================================

audit:
  id: "testing-quality-assurance.test-strategy.test-coverage-strategy"
  name: "Test Coverage Strategy"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 10
  subcategory: "test-strategy"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "testing"

  default_profiles:
    - "full"
    - "quality"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Assesses the test coverage strategy including coverage metrics tracked,
    coverage thresholds enforced, coverage reporting mechanisms, and how
    coverage data informs development decisions. Evaluates both line/branch
    coverage and more sophisticated metrics like mutation testing.

  why_it_matters: |
    Without a clear coverage strategy, teams may have false confidence in
    low-value coverage metrics or neglect critical code paths. A well-defined
    coverage strategy ensures testing effort is directed at high-risk areas
    and provides meaningful quality gates for deployments.

  when_to_run:
    - "Setting up new CI/CD pipelines"
    - "Establishing quality gates"
    - "Test suite health assessments"
    - "After significant codebase growth"

prerequisites:
  required_artifacts:
    - type: "coverage_configuration"
      description: "Coverage tool configuration (jest.config, .nycrc, etc.)"
    - type: "ci_configuration"
      description: "CI pipeline configuration with coverage steps"

  access_requirements:
    - "Source code repository access"
    - "CI/CD configuration access"
    - "Historical coverage reports (if available)"

discovery:
  file_patterns:
    - glob: "**/jest.config.{js,ts,json}"
      purpose: "Jest coverage configuration"
    - glob: "**/.nycrc*"
      purpose: "NYC/Istanbul coverage configuration"
    - glob: "**/coverage/**"
      purpose: "Coverage report directories"
    - glob: "**/.coveragerc"
      purpose: "Python coverage configuration"
    - glob: "**/codecov.yml"
      purpose: "Codecov configuration"
    - glob: "**/.github/workflows/*.yml"
      purpose: "GitHub Actions workflow files"

  code_patterns:
    - pattern: "coverageThreshold|coverage.*threshold"
      type: "regex"
      scope: "config"
      purpose: "Identify coverage threshold settings"
    - pattern: "collectCoverage|coverageDirectory"
      type: "regex"
      scope: "config"
      purpose: "Identify coverage collection settings"
    - pattern: "--coverage|--cov"
      type: "regex"
      scope: "config"
      purpose: "Identify coverage flags in scripts"

knowledge_sources:
  guides:
    - id: "coverage-best-practices"
      name: "Code Coverage Best Practices"
      url: "https://testing.googleblog.com/2020/08/code-coverage-best-practices.html"
      offline_cache: true
    - id: "mutation-testing"
      name: "Introduction to Mutation Testing"
      url: "https://pitest.org/quickstart/mutators/"
      offline_cache: true

  learning_resources:
    - id: "coverage-analysis"
      title: "Software Testing and Analysis"
      type: "book"
      reference: "ISBN 978-0471455936"

tooling:
  static_analysis:
    - tool: "istanbul/nyc"
      purpose: "JavaScript coverage analysis"
      offline_capable: true
    - tool: "coverage.py"
      purpose: "Python coverage analysis"
      offline_capable: true
    - tool: "jacoco"
      purpose: "Java coverage analysis"
      offline_capable: true
    - tool: "stryker"
      purpose: "Mutation testing for JavaScript"
      offline_capable: true

  scripts:
    - id: "coverage-config-checker"
      language: "bash"
      purpose: "Check for coverage configuration"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Coverage Configuration Analysis ==="
        echo "Checking for coverage configs..."
        find . -name "jest.config.*" -o -name ".nycrc*" -o -name ".coveragerc" -o -name "codecov.yml" 2>/dev/null | head -20
        echo "Checking for coverage thresholds..."
        grep -r "coverageThreshold" --include="*.json" --include="*.js" . 2>/dev/null | head -10

signals:
  critical:
    - id: "COVERAGE-CRIT-001"
      signal: "No coverage tooling configured in the project"
      evidence_pattern: "No coverage configuration files found"
      explanation: |
        Without coverage tooling, there's no way to measure test effectiveness
        or identify untested code paths. This makes quality assurance arbitrary.
      remediation: "Configure coverage tooling appropriate for the language/framework"

    - id: "COVERAGE-CRIT-002"
      signal: "Coverage reports not generated in CI pipeline"
      evidence_pattern: "CI config missing coverage flags/steps"
      explanation: |
        Coverage that isn't tracked in CI provides no enforcement or visibility.
        Teams lose the ability to detect coverage regressions.
      remediation: "Add coverage collection and reporting to CI pipeline"

  high:
    - id: "COVERAGE-HIGH-001"
      signal: "No coverage thresholds enforced"
      evidence_pattern: "coverageThreshold not set or all zeros"
      explanation: |
        Without thresholds, coverage can decline over time as new code is added
        without corresponding tests. Thresholds provide quality gates.
      remediation: "Set meaningful coverage thresholds based on current baseline"

    - id: "COVERAGE-HIGH-002"
      signal: "Only line coverage tracked, branch coverage ignored"
      evidence_pattern: "Branch/statement coverage not configured"
      explanation: |
        Line coverage alone can be misleading. Branch coverage ensures all
        conditional paths are tested, catching more edge cases.
      remediation: "Enable and enforce branch coverage metrics"

  medium:
    - id: "COVERAGE-MED-001"
      signal: "Coverage exclusions too broad"
      evidence_pattern: "Large portions of codebase excluded from coverage"
      remediation: "Review exclusions and limit to genuinely untestable code"

    - id: "COVERAGE-MED-002"
      signal: "No per-file or per-directory coverage requirements"
      evidence_pattern: "Only global thresholds, no targeted requirements"
      remediation: "Add per-file minimums to prevent low-coverage pockets"

  low:
    - id: "COVERAGE-LOW-001"
      signal: "Coverage reports not published to PR comments"
      evidence_pattern: "No coverage bot/reporting integration"

  positive:
    - id: "COVERAGE-POS-001"
      signal: "Mutation testing integrated for quality validation"
      evidence_pattern: "Stryker/PIT/mutmut configuration present"
    - id: "COVERAGE-POS-002"
      signal: "Coverage trends tracked over time"
      evidence_pattern: "Historical coverage data maintained"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify coverage tooling"
      description: |
        Locate all coverage-related configuration files and understand
        which tools are in use across the project.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find coverage configuration files"
          command: "find . -type f \\( -name '*coverage*' -o -name '.nycrc*' -o -name 'jest.config.*' \\) | grep -v node_modules | head -20"
        - purpose: "Check package.json for coverage scripts"
          command: "grep -l 'coverage' package.json 2>/dev/null && cat package.json | grep -A2 -B2 coverage || echo 'No package.json coverage scripts'"
      expected_findings:
        - "List of coverage tools configured"
        - "Coverage-related npm scripts"

    - id: "2"
      name: "Review coverage thresholds"
      description: |
        Extract and evaluate coverage threshold settings to understand
        the minimum quality bar being enforced.
      duration_estimate: "20 min"
      commands:
        - purpose: "Extract threshold configuration"
          command: "grep -r 'coverageThreshold\\|threshold\\|fail_under' --include='*.json' --include='*.js' --include='*.yaml' . 2>/dev/null | grep -v node_modules | head -20"
      expected_findings:
        - "Current threshold values"
        - "Scope of threshold enforcement"

    - id: "3"
      name: "Analyze CI integration"
      description: |
        Review CI configuration to understand how coverage is collected,
        reported, and enforced during the build process.
      duration_estimate: "20 min"
      commands:
        - purpose: "Check CI workflows for coverage steps"
          command: "find . -path '*/.github/workflows/*' -name '*.yml' -exec grep -l coverage {} \\; 2>/dev/null"
      expected_findings:
        - "Coverage collection in CI"
        - "Coverage reporting integrations"
        - "Threshold enforcement in CI"

    - id: "4"
      name: "Evaluate coverage exclusions"
      description: |
        Review what code is excluded from coverage and assess whether
        exclusions are appropriate.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find coverage ignore patterns"
          command: "grep -r 'coveragePathIgnorePatterns\\|omit\\|exclude' --include='*.json' --include='.coveragerc' . 2>/dev/null | grep -v node_modules"
      expected_findings:
        - "List of excluded paths/patterns"
        - "Assessment of exclusion appropriateness"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "configuration_review"
      format: "table"
      sections:
        - "Coverage Tools"
        - "Threshold Configuration"
        - "CI Integration Status"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Coverage Strategy Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Coverage configuration directly inspected and verified"
    medium: "Configuration found but thresholds unverified"
    low: "Inferred from partial evidence"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "coverage-best-practices"
        priority: "required"

profiles:
  membership:
    quick:
      included: true
      reason: "Quick check for coverage configuration presence"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "coverage-001"
    item: "Coverage tooling identified and documented"
    level: "CRITICAL"
    verification: "find . -name '*coverage*' -o -name '.nycrc*' | grep -v node_modules | wc -l"
    expected: "PASS (count > 0)"

  - id: "coverage-002"
    item: "Coverage thresholds evaluated"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Document current threshold values and enforcement"
    expected: "Confirmed by reviewer"

  - id: "coverage-003"
    item: "CI coverage integration verified"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Confirm coverage runs in CI pipeline"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Testability"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.test-strategy.test-pyramid-balance"
    - "testing-quality-assurance.unit-testing.unit-test-coverage"
