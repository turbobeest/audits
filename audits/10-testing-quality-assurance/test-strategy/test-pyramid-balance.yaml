# ============================================================
# AUDIT: Test Pyramid Balance
# ============================================================
# Evaluates the distribution of tests across unit, integration,
# and end-to-end layers to ensure optimal cost-effectiveness.
# ============================================================

audit:
  id: "testing-quality-assurance.test-strategy.test-pyramid-balance"
  name: "Test Pyramid Balance"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 10
  subcategory: "test-strategy"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "testing"

  default_profiles:
    - "full"
    - "quality"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Analyzes the distribution of tests across the testing pyramid layers:
    unit tests, integration tests, and end-to-end tests. Evaluates whether
    the test suite follows the recommended pyramid shape with many fast
    unit tests at the base, fewer integration tests in the middle, and
    minimal end-to-end tests at the top.

  why_it_matters: |
    An inverted test pyramid (ice cream cone anti-pattern) leads to slow
    feedback loops, flaky tests, and expensive maintenance. Proper test
    distribution ensures fast feedback during development while maintaining
    confidence through strategic integration and E2E coverage.

  when_to_run:
    - "Initial codebase quality assessment"
    - "CI/CD pipeline optimization"
    - "Test suite maintenance planning"
    - "Before major refactoring efforts"

prerequisites:
  required_artifacts:
    - type: "test_suite"
      description: "Existing test files organized by type"
    - type: "ci_configuration"
      description: "CI/CD pipeline configuration showing test execution"

  access_requirements:
    - "Source code repository access"
    - "Test execution metrics/reports"

discovery:
  file_patterns:
    - glob: "**/*.test.{js,ts,jsx,tsx}"
      purpose: "Identify JavaScript/TypeScript test files"
    - glob: "**/*.spec.{js,ts,jsx,tsx}"
      purpose: "Identify spec-style test files"
    - glob: "**/test_*.py"
      purpose: "Identify Python test files"
    - glob: "**/*_test.go"
      purpose: "Identify Go test files"
    - glob: "**/tests/**"
      purpose: "Identify test directories"
    - glob: "**/e2e/**"
      purpose: "Identify E2E test directories"
    - glob: "**/integration/**"
      purpose: "Identify integration test directories"

  code_patterns:
    - pattern: "describe\\s*\\("
      type: "regex"
      scope: "source"
      purpose: "Identify Jest/Mocha test suites"
    - pattern: "@Test|@ParameterizedTest"
      type: "regex"
      scope: "source"
      purpose: "Identify JUnit tests"
    - pattern: "def test_"
      type: "regex"
      scope: "source"
      purpose: "Identify pytest tests"

knowledge_sources:
  guides:
    - id: "testing-pyramid"
      name: "The Practical Test Pyramid"
      url: "https://martinfowler.com/articles/practical-test-pyramid.html"
      offline_cache: true
    - id: "google-testing"
      name: "Google Testing Blog - Just Say No to More End-to-End Tests"
      url: "https://testing.googleblog.com/2015/04/just-say-no-to-more-end-to-end-tests.html"
      offline_cache: true

  learning_resources:
    - id: "growing-oo-software"
      title: "Growing Object-Oriented Software, Guided by Tests"
      type: "book"
      reference: "ISBN 978-0321503626"

tooling:
  static_analysis:
    - tool: "test-count-analyzer"
      purpose: "Count tests by type and layer"
      offline_capable: true

  scripts:
    - id: "pyramid-analyzer"
      language: "bash"
      purpose: "Analyze test distribution across layers"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Test Pyramid Analysis ==="
        echo "Unit tests:"
        find . -path ./node_modules -prune -o -type f \( -name "*.test.*" -o -name "*.spec.*" \) -print | grep -v -E "(e2e|integration|cypress)" | wc -l
        echo "Integration tests:"
        find . -path ./node_modules -prune -o -type f \( -name "*.test.*" -o -name "*.spec.*" \) -print | grep -E "integration" | wc -l
        echo "E2E tests:"
        find . -path ./node_modules -prune -o -type f \( -name "*.test.*" -o -name "*.spec.*" \) -print | grep -E "(e2e|cypress)" | wc -l

signals:
  critical:
    - id: "PYRAMID-CRIT-001"
      signal: "Inverted test pyramid - E2E tests exceed unit tests"
      evidence_pattern: "E2E test count > unit test count"
      explanation: |
        An inverted pyramid indicates over-reliance on slow, expensive E2E
        tests. This leads to slow CI pipelines, flaky tests, and difficult
        debugging when tests fail.
      remediation: "Refactor to increase unit test coverage and reduce E2E dependency"

    - id: "PYRAMID-CRIT-002"
      signal: "No unit tests exist in the codebase"
      evidence_pattern: "Unit test count = 0"
      explanation: |
        Complete absence of unit tests indicates a critical gap in the testing
        strategy, making it impossible to validate individual components in isolation.
      remediation: "Establish unit testing practices and add tests for critical components"

  high:
    - id: "PYRAMID-HIGH-001"
      signal: "Integration tests dominate the test suite (>50%)"
      evidence_pattern: "Integration tests > 50% of total tests"
      explanation: |
        Over-reliance on integration tests leads to slower feedback and
        more complex test maintenance without the benefits of isolated unit testing.
      remediation: "Identify integration tests that could be unit tests and refactor"

    - id: "PYRAMID-HIGH-002"
      signal: "E2E tests comprise more than 20% of total tests"
      evidence_pattern: "E2E tests > 20% of total tests"
      explanation: |
        Excessive E2E testing creates slow pipelines and maintenance burden.
        E2E should be reserved for critical user journeys only.
      remediation: "Review E2E tests and push testing down to lower pyramid levels"

  medium:
    - id: "PYRAMID-MED-001"
      signal: "Test categorization is unclear or inconsistent"
      evidence_pattern: "Mixed test types in same directories without clear naming"
      remediation: "Establish clear conventions for test organization and naming"

    - id: "PYRAMID-MED-002"
      signal: "Missing integration test layer entirely"
      evidence_pattern: "Integration test count = 0"
      remediation: "Add integration tests for component interactions and API boundaries"

  low:
    - id: "PYRAMID-LOW-001"
      signal: "Test execution order suggests pyramid imbalance"
      evidence_pattern: "CI runs E2E before unit tests"

  positive:
    - id: "PYRAMID-POS-001"
      signal: "Healthy pyramid ratio: ~70% unit, ~20% integration, ~10% E2E"
      evidence_pattern: "Test distribution follows recommended ratios"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory test files by type"
      description: |
        Scan the codebase to identify all test files and categorize them
        by testing layer (unit, integration, E2E).
      duration_estimate: "20 min"
      commands:
        - purpose: "Count test files by directory pattern"
          command: "find . -type f \\( -name '*.test.*' -o -name '*.spec.*' -o -name 'test_*' -o -name '*_test.*' \\) | head -100"
        - purpose: "Identify E2E test locations"
          command: "find . -type d \\( -name 'e2e' -o -name 'cypress' -o -name 'playwright' \\) 2>/dev/null"
      expected_findings:
        - "Count of tests at each pyramid layer"
        - "Test file organization patterns"

    - id: "2"
      name: "Calculate pyramid ratios"
      description: |
        Compute the percentage distribution of tests across layers and
        compare against recommended pyramid ratios.
      duration_estimate: "15 min"
      commands:
        - purpose: "Calculate test distribution"
          command: "echo 'Unit:Integration:E2E ratio analysis'"
      expected_findings:
        - "Percentage breakdown by test type"
        - "Comparison against ideal ratios"

    - id: "3"
      name: "Analyze test execution times"
      description: |
        Review CI/CD pipeline metrics to understand execution time
        contribution from each test layer.
      duration_estimate: "20 min"
      questions:
        - "What percentage of CI time is spent on each test type?"
        - "Are there bottlenecks in specific test layers?"
      expected_findings:
        - "Time distribution across test layers"
        - "Correlation between test count and execution time"

    - id: "4"
      name: "Assess test categorization clarity"
      description: |
        Evaluate whether tests are clearly organized and categorized
        to enable targeted test execution.
      duration_estimate: "15 min"
      expected_findings:
        - "Clarity of test organization"
        - "Ability to run tests by layer"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "metrics_report"
      format: "table"
      sections:
        - "Test Count by Layer"
        - "Pyramid Ratio Analysis"
        - "Execution Time Distribution"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Pyramid Health Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Automated test count with clear categorization"
    medium: "Test counts with some ambiguous categorization"
    low: "Estimates based on file patterns only"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "testing-pyramid"
        priority: "required"

profiles:
  membership:
    quick:
      included: true
      reason: "Quick ratio check provides valuable insight"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "pyramid-001"
    item: "Test files inventoried and categorized"
    level: "CRITICAL"
    verification: "find . -type f \\( -name '*.test.*' -o -name '*.spec.*' \\) | wc -l"
    expected: "PASS (count > 0)"

  - id: "pyramid-002"
    item: "Pyramid ratios calculated"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Verify unit > integration > E2E test counts"
    expected: "Confirmed by reviewer"

  - id: "pyramid-003"
    item: "Recommendations documented for imbalances"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Check that specific remediation steps are provided"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Testability"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.test-strategy.test-coverage-strategy"
    - "testing-quality-assurance.unit-testing.unit-test-coverage"
    - "testing-quality-assurance.e2e-testing.e2e-coverage"
