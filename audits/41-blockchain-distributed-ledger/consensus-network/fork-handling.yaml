audit:
  id: blockchain-distributed-ledger.consensus-network.fork-handling
  name: Fork Handling Audit
  version: 1.0.0
  last_updated: '2026-01-22'
  status: active
  category: blockchain-distributed-ledger
  category_number: 41
  subcategory: consensus-network
  tier: expert
  estimated_duration: 1-2 hours  # median: 1h
  completeness: complete
  requires_runtime: false
  destructive: false
execution:
  automatable: partial
  severity: high
  scope: software
  default_profiles:
  - full
  - blockchain
  blocks_phase: false
  parallelizable: true
description:
  what: |
    This audit evaluates how applications handle blockchain forks
    and chain reorganizations. It examines:
    - Fork detection mechanisms
    - Chain selection rules
    - State rollback procedures
    - Transaction replay handling
    - Fork communication to users
    - Hard fork upgrade procedures
  why_it_matters: |
    Forks are inherent to blockchain operation:
    - Natural forks occur during propagation
    - Reorgs change canonical chain
    - Hard forks require coordinated upgrades
    - Improper handling causes data loss
    - Users need clear fork communication

    Robust fork handling maintains data consistency.
  when_to_run:
  - Application development
  - Hard fork preparation
  - Consistency review
  - Reorg handling verification
prerequisites:
  required_artifacts:
  - type: source_code
    description: Application source code
  - type: documentation
    description: Fork handling documentation
  access_requirements:
  - Application source code
  - Chain event handling code
discovery:
  code_patterns:
  - pattern: (fork|reorg|reorganization)
    type: regex
    scope: source
    purpose: Detect fork handling
  - pattern: (uncle|ommer|orphan)
    type: regex
    scope: source
    purpose: Detect orphan block handling
  - pattern: (chainId|networkId)
    type: regex
    scope: source
    purpose: Detect chain identification
  file_patterns:
  - glob: '**/*.{js,ts,sol,py}'
    purpose: Application code
signals:
  critical:
  - id: FORK-CRIT-001
    signal: No reorg detection
    evidence_indicators:
    - Block changes not monitored
    - Parent hash not verified
    - Chain tip changes ignored
    explanation: |
      Without reorg detection, applications maintain stale or
      incorrect state after chain reorganizations.
    remediation: |
      - Subscribe to chain head changes
      - Verify block parent hashes
      - Detect and handle reorgs
      - Re-process affected blocks
    cwe: CWE-20
  - id: FORK-CRIT-002
    signal: State not rolled back on reorg
    evidence_indicators:
    - Reverted transactions kept
    - State inconsistent with chain
    - No rollback mechanism
    explanation: |
      Failure to rollback state on reorg causes application state
      to diverge from blockchain state.
    remediation: |
      - Implement state rollback
      - Track reorg-affected transactions
      - Re-sync state after reorg
      - Notify affected users
  high:
  - id: FORK-HIGH-001
    signal: Hard fork upgrade not planned
    evidence_indicators:
    - No upgrade procedure
    - Fork block not monitored
    - Client upgrade not scheduled
    explanation: |
      Hard forks require coordinated upgrades. Missing upgrades
      cause nodes to follow wrong chain.
    remediation: |
      - Monitor for announced forks
      - Plan upgrade procedures
      - Test on fork testnets
      - Coordinate upgrade timing
  - id: FORK-HIGH-002
    signal: Chain ID not verified
    evidence_indicators:
    - Transactions accepted from wrong chain
    - No chain ID validation
    - Cross-chain replay possible
    explanation: |
      Without chain ID verification, transactions from forked
      chains may be accepted, enabling replay attacks.
    remediation: |
      - Verify chain ID in transactions
      - Validate RPC chain ID
      - Reject wrong-chain transactions
      - Monitor for chain ID changes
  medium:
  - id: FORK-MED-001
    signal: Fork notifications missing
    evidence_indicators:
    - Users unaware of reorgs
    - No fork event alerts
    - Silent state changes
    explanation: |
      Users affected by forks should be notified of changes
      to their transactions.
    remediation: |
      - Notify users of affected transactions
      - Show reorg warnings
      - Log fork events
      - Provide status updates
  - id: FORK-MED-002
    signal: Transaction replay not handled
    evidence_indicators:
    - Reverted transactions not replayed
    - User must resubmit manually
    - Transactions lost on reorg
    explanation: |
      Valid transactions reverted by reorg should be replayed
      or users should be notified to resubmit.
    remediation: |
      - Queue transactions for replay
      - Notify users of reverted transactions
      - Implement automatic resubmission
      - Track transaction finality
  low:
  - id: FORK-LOW-001
    signal: Fork handling not tested
    evidence_indicators:
    - No reorg test cases
    - Fork scenarios not covered
    - Behavior untested
    explanation: |
      Untested fork handling may fail in production when
      actual forks occur.
    remediation: |
      - Add reorg test cases
      - Simulate fork scenarios
      - Test on reorg testnets
      - Document expected behavior
  positive:
  - id: FORK-POS-001
    signal: Comprehensive fork handling
    evidence_indicators:
    - Reorg detection implemented
    - State rollback working
    - User notifications in place
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: blockchain-developer
  steps:
  - id: '1'
    name: Fork Handling Analysis
    description: |
      Analyze fork and reorg handling.
    duration_estimate: 30 min
    commands:
    - purpose: Find fork handling
      command: |
        grep -rniE "(fork|reorg|reorgani)" \
          --include="*.js" --include="*.ts" --include="*.py" . 2>/dev/null | head -30
    - purpose: Find chain ID handling
      command: |
        grep -rniE "(chainId|networkId)" \
          --include="*.js" --include="*.ts" --include="*.py" --include="*.sol" . 2>/dev/null | head -20
    expected_findings:
    - Fork handling
    - Chain verification
    - Reorg response
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Fork Analysis
    - Handling Assessment
    - Recommendations
profiles:
  membership:
    quick:
      included: false
    full:
      included: true
      priority: 2
    blockchain:
      included: true
      priority: 2
closeout_checklist:
- id: fork-001
  item: Reorg detection implemented
  level: CRITICAL
  verification: manual
  verification_notes: Verify reorg detection works
  expected: Confirmed by reviewer
- id: fork-002
  item: Chain ID verified
  level: BLOCKING
  verification: |
    grep -rniE "chainId" \
      --include="*.js" --include="*.ts" --include="*.sol" . 2>/dev/null | \
      wc -l | xargs -I{} test {} -gt 0 && echo "PASS" || echo "CHECK"
  expected: PASS
governance:
  applicable_to:
    archetypes:
    - blockchain
    - exchange
    - payment
    - defi
relationships:
  commonly_combined:
  - blockchain.consensus-network.finality-guarantee
  - blockchain.consensus-network.network-partition
  - blockchain.integration.indexer-reliability
