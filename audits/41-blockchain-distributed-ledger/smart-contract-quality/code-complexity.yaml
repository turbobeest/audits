audit:
  id: blockchain-distributed-ledger.smart-contract-quality.code-complexity
  name: Code Complexity Audit
  version: 1.0.0
  last_updated: '2026-01-22'
  status: active
  category: blockchain-distributed-ledger
  category_number: 41
  subcategory: smart-contract-quality
  tier: expert
  estimated_duration: 1-2 hours  # median: 1h
  completeness: complete
  requires_runtime: false
  destructive: false
execution:
  automatable: partial
  severity: medium
  scope: software
  default_profiles:
  - full
  - blockchain
  blocks_phase: false
  parallelizable: true
description:
  what: |
    This audit evaluates smart contract code complexity to ensure
    maintainability and auditability. It examines:
    - Cyclomatic complexity of functions
    - Inheritance depth and diamond problems
    - Function length and parameter counts
    - Code duplication
    - Coupling between contracts
    - Readability and documentation
  why_it_matters: |
    Code complexity directly impacts security:
    - Complex code harbors more bugs
    - Deep inheritance obscures behavior
    - Hard-to-audit code misses vulnerabilities
    - Complex logic leads to unexpected interactions
    - Immutable contracts cannot be easily fixed

    Simple, well-structured contracts are more secure.
  when_to_run:
  - Smart contract development
  - Code review
  - Pre-deployment audit
  - Maintainability assessment
prerequisites:
  required_artifacts:
  - type: source_code
    description: Smart contract source code
  access_requirements:
  - Access to contract source
  - Full inheritance tree
discovery:
  code_patterns:
  - pattern: contract.*is.*,.*,
    type: regex
    scope: source
    purpose: Detect multiple inheritance
  - pattern: function.*\(.*,.*,.*,.*\)
    type: regex
    scope: source
    purpose: Detect many parameters
  - pattern: (if|else|while|for)
    type: regex
    scope: source
    purpose: Detect control flow
  file_patterns:
  - glob: '**/*.sol'
    purpose: Solidity contracts
signals:
  high:
  - id: COMPLEX-HIGH-001
    signal: Excessive inheritance depth
    evidence_indicators:
    - More than 4 levels of inheritance
    - Diamond inheritance pattern
    - Unclear method resolution
    explanation: |
      Deep inheritance makes behavior hard to predict and audit.
      Method resolution order can surprise developers and auditors.
    remediation: |
      - Flatten inheritance where possible
      - Use composition over inheritance
      - Document inheritance tree
      - Simplify diamond patterns
  - id: COMPLEX-HIGH-002
    signal: Function too complex
    evidence_indicators:
    - Cyclomatic complexity > 10
    - Function over 50 lines
    - Deeply nested conditionals
    explanation: |
      Complex functions are error-prone and hard to test.
      Each branch multiplies test cases needed.
    remediation: |
      - Break into smaller functions
      - Reduce nesting depth
      - Extract repeated patterns
      - Simplify control flow
  medium:
  - id: COMPLEX-MED-001
    signal: Significant code duplication
    evidence_indicators:
    - Repeated code blocks
    - Copy-paste patterns
    - Similar functions with minor differences
    explanation: |
      Code duplication multiplies bug risk. A fix in one place
      may be missed in duplicates.
    remediation: |
      - Extract common code to functions
      - Use libraries for shared logic
      - Apply DRY principle
      - Review for duplication
  - id: COMPLEX-MED-002
    signal: Excessive function parameters
    evidence_indicators:
    - More than 7 parameters
    - Boolean flag parameters
    - Order-dependent parameters
    explanation: |
      Many parameters increase error likelihood and make
      function calls hard to understand.
    remediation: |
      - Group parameters in structs
      - Split into multiple functions
      - Use named parameters
      - Reduce parameter count
  low:
  - id: COMPLEX-LOW-001
    signal: Inconsistent naming conventions
    evidence_indicators:
    - Mixed camelCase and snake_case
    - Unclear abbreviations
    - Misleading names
    explanation: |
      Inconsistent naming reduces readability and increases
      cognitive load during review.
    remediation: |
      - Apply consistent naming
      - Follow Solidity style guide
      - Use descriptive names
      - Document conventions
  - id: COMPLEX-LOW-002
    signal: Missing documentation
    evidence_indicators:
    - No NatSpec comments
    - Undocumented parameters
    - Unclear function purpose
    explanation: |
      Undocumented code is harder to audit and maintain.
      Documentation aids understanding and review.
    remediation: |
      - Add NatSpec comments
      - Document all public functions
      - Explain complex logic
      - Include usage examples
  positive:
  - id: COMPLEX-POS-001
    signal: Well-structured codebase
    evidence_indicators:
    - Simple functions
    - Clear inheritance
    - Good documentation
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: code-reviewer
  steps:
  - id: '1'
    name: Complexity Analysis
    description: |
      Analyze code complexity metrics.
    duration_estimate: 45 min
    commands:
    - purpose: Find inheritance patterns
      command: |
        grep -rniE "contract.*is" \
          --include="*.sol" . 2>/dev/null | head -30
    - purpose: Count functions
      command: |
        grep -rniE "function\s+\w+" \
          --include="*.sol" . 2>/dev/null | wc -l
    expected_findings:
    - Inheritance structure
    - Function count
    - Complexity indicators
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Complexity Analysis
    - Structure Assessment
    - Recommendations
profiles:
  membership:
    quick:
      included: false
    full:
      included: true
      priority: 3
    blockchain:
      included: true
      priority: 3
closeout_checklist:
- id: complex-001
  item: No excessively complex functions
  level: WARNING
  verification: manual
  verification_notes: Verify function complexity is reasonable
  expected: Confirmed by reviewer
- id: complex-002
  item: Inheritance depth reasonable
  level: WARNING
  verification: manual
  verification_notes: Verify inheritance is not too deep
  expected: Confirmed by reviewer
governance:
  applicable_to:
    archetypes:
    - blockchain
    - defi
    - enterprise
relationships:
  commonly_combined:
  - blockchain.smart-contract-quality.gas-optimization
  - blockchain.smart-contract-quality.upgradeability-pattern
  - code-quality.maintainability.code-organization
