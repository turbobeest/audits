audit:
  id: blockchain-distributed-ledger.smart-contract-security.oracle-manipulation
  name: Oracle Manipulation Audit
  version: 1.0.0
  last_updated: '2026-01-22'
  status: active
  category: blockchain-distributed-ledger
  category_number: 41
  subcategory: smart-contract-security
  tier: expert
  estimated_duration: 2-3 hours  # median: 2h
  completeness: complete
  requires_runtime: false
  destructive: false
execution:
  automatable: partial
  severity: critical
  scope: software
  default_profiles:
  - full
  - blockchain
  - defi
  blocks_phase: true
  parallelizable: true
description:
  what: |
    This audit evaluates smart contracts for oracle manipulation
    vulnerabilities affecting price feeds and external data. It examines:
    - Oracle source security and decentralization
    - Price feed freshness validation
    - Manipulation resistance mechanisms
    - Fallback oracle implementation
    - Price deviation detection
    - Multi-oracle aggregation
  why_it_matters: |
    Oracle manipulation enables massive DeFi exploits:
    - Manipulated prices enable unfair liquidations
    - Stale prices can be exploited
    - Single oracle failures cascade
    - AMM-based oracles are easily manipulated
    - Oracle attacks have caused billions in losses

    Robust oracle security is fundamental to DeFi protocols.
  when_to_run:
  - DeFi protocol development
  - Oracle integration
  - Pre-deployment audit
  - Price-dependent operations
prerequisites:
  required_artifacts:
  - type: source_code
    description: Smart contract source code
  - type: documentation
    description: Oracle integration documentation
  access_requirements:
  - Access to contract source
  - Oracle configuration details
discovery:
  code_patterns:
  - pattern: (oracle|priceFeed|latestAnswer)
    type: regex
    scope: source
    purpose: Detect oracle usage
  - pattern: (chainlink|aggregator|AggregatorV3)
    type: regex
    scope: source
    purpose: Detect Chainlink integration
  - pattern: (getReserves|uniswap|twap)
    type: regex
    scope: source
    purpose: Detect AMM oracle patterns
  file_patterns:
  - glob: '**/*.sol'
    purpose: Solidity contracts
  - glob: '**/oracle/**/*.sol'
    purpose: Oracle contracts
knowledge_sources:
  specifications:
  - id: chainlink-docs
    name: Chainlink Price Feeds Documentation
    url: https://docs.chain.link/data-feeds
    offline_cache: true
    priority: required
signals:
  critical:
  - id: ORACLE-CRIT-001
    signal: Single manipulable price source
    evidence_indicators:
    - AMM spot price as only source
    - No oracle aggregation
    - Single reporter oracle
    explanation: |
      Single price sources can be manipulated, especially AMM
      spot prices which can be moved with flash loans in a
      single transaction.
    remediation: |
      - Use decentralized oracle networks (Chainlink)
      - Aggregate multiple oracle sources
      - Implement TWAP for AMM prices
      - Add price deviation checks
    cwe: CWE-20
  - id: ORACLE-CRIT-002
    signal: Stale price feed used
    evidence_indicators:
    - No timestamp validation
    - Price accepted regardless of age
    - updatedAt not checked
    explanation: |
      Stale prices can differ significantly from current market,
      enabling exploitation through outdated valuations.
    remediation: |
      - Check oracle updatedAt timestamp
      - Define maximum staleness threshold
      - Implement fallback for stale feeds
      - Monitor price feed health
  high:
  - id: ORACLE-HIGH-001
    signal: No fallback oracle
    evidence_indicators:
    - Single oracle dependency
    - No backup price source
    - Failure causes protocol halt
    explanation: |
      Oracle outages can halt protocols or force use of stale
      prices. Fallback oracles provide resilience.
    remediation: |
      - Implement fallback oracle
      - Design graceful degradation
      - Add circuit breakers
      - Monitor primary oracle health
  - id: ORACLE-HIGH-002
    signal: Price deviation not bounded
    evidence_indicators:
    - Large price changes accepted
    - No circuit breaker
    - Manipulation-sized moves allowed
    explanation: |
      Unbounded price acceptance allows manipulation-sized price
      moves to be used before detection.
    remediation: |
      - Add price deviation limits
      - Implement circuit breakers
      - Require gradual price updates
      - Monitor for anomalies
  medium:
  - id: ORACLE-MED-001
    signal: Oracle decimals not handled
    evidence_indicators:
    - Hardcoded decimal assumptions
    - decimals() not called
    - Cross-feed decimal mismatch
    explanation: |
      Different oracles use different decimal precisions.
      Incorrect handling corrupts price calculations.
    remediation: |
      - Query decimals() dynamically
      - Normalize all prices
      - Validate decimal assumptions
      - Test with various feeds
  - id: ORACLE-MED-002
    signal: Round ID not validated
    evidence_indicators:
    - answeredInRound not checked
    - Round ID ignored
    - Stale round data possible
    explanation: |
      Chainlink rounds can return stale data if not validated.
      answeredInRound should match roundId.
    remediation: |
      - Verify answeredInRound >= roundId
      - Check round completeness
      - Handle incomplete rounds
      - Follow Chainlink best practices
  low:
  - id: ORACLE-LOW-001
    signal: Oracle configuration not documented
    evidence_indicators:
    - Feed addresses hardcoded
    - Staleness thresholds unclear
    - Fallback behavior undocumented
    explanation: |
      Undocumented oracle configuration makes auditing and
      maintenance difficult.
    remediation: |
      - Document all oracle feeds used
      - Specify staleness thresholds
      - Document fallback behavior
      - Include in security documentation
  positive:
  - id: ORACLE-POS-001
    signal: Robust oracle implementation
    evidence_indicators:
    - Decentralized oracle network
    - Staleness validation
    - Fallback mechanisms
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: security-auditor
  steps:
  - id: '1'
    name: Oracle Security Analysis
    description: |
      Analyze oracle integration and manipulation resistance.
    duration_estimate: 60 min
    commands:
    - purpose: Find oracle usage
      command: |
        grep -rniE "(oracle|priceFeed|latestAnswer|latestRoundData)" \
          --include="*.sol" . 2>/dev/null | head -30
    - purpose: Find staleness checks
      command: |
        grep -rniE "(updatedAt|answeredInRound|block\.timestamp)" \
          --include="*.sol" . 2>/dev/null | head -20
    expected_findings:
    - Oracle integration
    - Validation patterns
    - Staleness handling
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Oracle Analysis
    - Manipulation Resistance
    - Recommendations
profiles:
  membership:
    quick:
      included: false
    full:
      included: true
      priority: 1
    blockchain:
      included: true
      priority: 1
closeout_checklist:
- id: oracle-001
  item: Decentralized oracle used
  level: CRITICAL
  verification: manual
  verification_notes: Verify oracle is manipulation resistant
  expected: Confirmed by reviewer
- id: oracle-002
  item: Staleness validation implemented
  level: BLOCKING
  verification: |
    grep -rniE "updatedAt|answeredInRound" \
      --include="*.sol" . 2>/dev/null | \
      wc -l | xargs -I{} test {} -gt 0 && echo "PASS" || echo "FAIL"
  expected: PASS
governance:
  applicable_to:
    archetypes:
    - defi
    - lending
    - derivatives
    - stablecoin
relationships:
  commonly_combined:
  - blockchain.smart-contract-security.flash-loan-attack
  - blockchain.integration.off-chain-data
  - blockchain.smart-contract-quality.error-handling

# Glossary of domain-specific terms:
glossary:
  "timelock": "Governance mechanism requiring delay between proposal and execution"
  "reentrancy": "Vulnerability where external call allows re-entering function before completion"
  "oracle": "External data feed providing off-chain information to smart contracts"
