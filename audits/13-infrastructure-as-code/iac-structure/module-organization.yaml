audit:
  id: infrastructure-as-code.iac-structure.module-organization
  name: IaC Module Organization
  version: 1.0.0
  last_updated: '2026-01-19'
  status: active
  category: infrastructure-as-code
  category_number: 13
  subcategory: iac-structure
  tier: phd
  estimated_duration: 2 hours
  completeness: complete
  requires_runtime: false
  destructive: false
execution:
  automatable: partial
  severity: high
  scope: infrastructure
  default_profiles:
  - full
  - security
  blocks_phase: false
  parallelizable: true
description:
  what: |
    This audit examines the organization and structure of Infrastructure as Code
    modules across Terraform, Pulumi, CloudFormation, and other IaC tools. It
    evaluates module boundaries, composition patterns, versioning strategies,
    and the overall modularity of infrastructure code.

    Key areas examined:
    - Module boundary definitions and single-responsibility adherence
    - Module composition vs inheritance patterns
    - Version pinning and semantic versioning compliance
    - Module registry usage (public vs private)
    - Root module vs child module separation
    - Module input/output interface design
  why_it_matters: |
    Well-organized IaC modules are critical for:
    - Maintainability: Changes can be made in isolation without cascading effects
    - Reusability: Teams can share infrastructure patterns across projects
    - Testability: Modules can be validated independently before composition
    - Governance: Security and compliance policies can be enforced at module level
    - Scalability: Large infrastructure can be managed through composition

    Poor module organization leads to configuration drift, duplicated code,
    difficult upgrades, and increased blast radius for changes.
  when_to_run:
  - During initial IaC architecture review
  - Before major infrastructure refactoring
  - When onboarding new teams to existing infrastructure
  - Quarterly infrastructure health assessments
prerequisites:
  required_artifacts:
  - type: iac_repository
    description: Access to infrastructure code repositories (Terraform, Pulumi, CloudFormation, etc.)
  - type: module_registry
    description: Access to private module registry if used (Terraform Cloud, Artifactory, etc.)
  access_requirements:
  - Read access to all IaC repositories
  - Access to CI/CD pipeline configurations for IaC
  - Module registry read access
discovery:
  code_patterns:
  - pattern: ^module\s+"[^"]+"\s*\{
    type: regex
    scope: config
    purpose: Identify Terraform module declarations
  - pattern: source\s*=\s*"[^"]+"
    type: regex
    scope: config
    purpose: Extract module sources to analyze versioning
  - pattern: version\s*=\s*"[^"]+"
    type: regex
    scope: config
    purpose: Detect version constraints on modules
  - pattern: class.*extends.*ComponentResource
    type: regex
    scope: source
    purpose: Identify Pulumi component resources (modules)
  - pattern: AWS::CloudFormation::Stack
    type: regex
    scope: config
    purpose: Identify CloudFormation nested stacks
  file_patterns:
  - glob: '**/modules/**/main.tf'
    purpose: Locate Terraform module definitions
  - glob: '**/modules/**/variables.tf'
    purpose: Find module input definitions
  - glob: '**/modules/**/outputs.tf'
    purpose: Find module output definitions
  - glob: '**/*.tf'
    purpose: All Terraform configuration files
  - glob: '**/Pulumi.yaml'
    purpose: Pulumi project definitions
  - glob: '**/*.template.yaml'
    purpose: CloudFormation templates
  - glob: '**/template.yaml'
    purpose: SAM/CloudFormation templates
knowledge_sources:
  specifications:
  - id: terraform-modules
    name: Terraform Module Documentation
    url: https://developer.hashicorp.com/terraform/language/modules
    offline_cache: true
    priority: required
  - id: pulumi-components
    name: Pulumi Component Resources
    url: https://www.pulumi.com/docs/concepts/resources/components/
    offline_cache: true
    priority: required
  guides:
  - id: terraform-best-practices
    name: Terraform Best Practices by HashiCorp
    url: https://developer.hashicorp.com/terraform/cloud-docs/recommended-practices
    offline_cache: true
  - id: google-terraform-style
    name: Google Cloud Terraform Best Practices
    url: https://cloud.google.com/docs/terraform/best-practices-for-terraform
    offline_cache: true
  - id: aws-cfn-best-practices
    name: AWS CloudFormation Best Practices
    url: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/best-practices.html
    offline_cache: true
tooling:
  static_analysis:
  - tool: terraform validate
    purpose: Validate Terraform module syntax and consistency
    offline_capable: true
  - tool: tflint
    purpose: Lint Terraform code for best practices and common errors
    offline_capable: true
  - tool: checkov
    purpose: Static analysis for IaC security and compliance
    offline_capable: true
  - tool: cfn-lint
    purpose: Lint CloudFormation templates
    offline_capable: true
  infrastructure_tools:
  - tool: terraform-docs
    purpose: Generate documentation from module structure
    command: terraform-docs markdown ./modules/module-name
  - tool: terraform graph
    purpose: Visualize module dependencies
    command: terraform graph | dot -Tsvg > graph.svg
signals:
  critical:
  - id: IAC-MOD-CRIT-001
    signal: Modules with no version constraints
    evidence_pattern: source\s*=\s*"[^"]+"(?!.*version)
    explanation: |
      Modules without version constraints can break infrastructure unexpectedly
      when upstream changes are made. This is a critical risk for production
      infrastructure as any module update could introduce breaking changes.
    remediation: Add explicit version constraints to all module sources using semantic versioning
  - id: IAC-MOD-CRIT-002
    signal: Hard-coded secrets in module variables
    evidence_pattern: (password|secret|key|token)\s*=\s*"[^"$]+
    explanation: |
      Hard-coded secrets in module declarations expose sensitive credentials
      in version control and can lead to security breaches.
    remediation: Use secret management solutions (Vault, AWS Secrets Manager) or sensitive variable types
  high:
  - id: IAC-MOD-HIGH-001
    signal: Monolithic modules with multiple responsibilities
    evidence_pattern: resource\s+"[^"]+"\s+"[^"]+"
    explanation: |
      Modules with more than 10-15 resources typically have multiple responsibilities
      and should be decomposed for better maintainability and reusability.
    remediation: Decompose large modules into smaller, focused components
  - id: IAC-MOD-HIGH-002
    signal: Missing module documentation
    evidence_indicators:
    - No README.md in module directory
    - Variables without descriptions
    - Outputs without descriptions
    explanation: |
      Undocumented modules are difficult to consume correctly and lead to
      misuse and configuration errors.
    remediation: Add comprehensive README.md and descriptions to all variables and outputs
  - id: IAC-MOD-HIGH-003
    signal: Circular module dependencies
    evidence_indicators:
    - Module A depends on Module B which depends on Module A
    - terraform graph shows cycles
    explanation: |
      Circular dependencies indicate poor module boundaries and can cause
      deployment failures or race conditions.
    remediation: Refactor modules to eliminate circular dependencies through interface extraction
  medium:
  - id: IAC-MOD-MED-001
    signal: Inconsistent module source patterns
    evidence_indicators:
    - Mixed use of local paths, git URLs, and registry sources
    - Inconsistent versioning strategies across modules
    remediation: Standardize on a single module source pattern (preferably registry)
  - id: IAC-MOD-MED-002
    signal: Deep module nesting (>3 levels)
    evidence_pattern: modules/.*/modules/.*/modules/
    remediation: Flatten module hierarchy to improve comprehension and reduce complexity
  - id: IAC-MOD-MED-003
    signal: Modules without output definitions
    evidence_indicators:
    - Module directories without outputs.tf
    - outputs.tf with no output blocks
    remediation: Define meaningful outputs for module composition and integration
  low:
  - id: IAC-MOD-LOW-001
    signal: Inconsistent naming conventions in modules
    evidence_indicators:
    - Mixed use of snake_case and kebab-case
    - Inconsistent prefix/suffix patterns
    remediation: Establish and enforce naming conventions across all modules
  positive:
  - id: IAC-MOD-POS-001
    signal: Well-structured module hierarchy with clear boundaries
    evidence_indicators:
    - Single responsibility per module
    - Clear input/output interfaces
    - Comprehensive documentation
  - id: IAC-MOD-POS-002
    signal: Semantic versioning with proper constraints
    evidence_pattern: version\s*=\s*"[~>=<]*\d+\.\d+(\.\d+)?"
procedure:
  context:
    cognitive_mode: critical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Inventory Module Structure
    description: |
      Identify all IaC modules in the repository and catalog their
      structure, including nested modules and external dependencies.
    duration_estimate: 20 min
    commands:
    - purpose: Find all Terraform modules
      command: find . -name 'main.tf' -exec dirname {} \; | sort -u
    - purpose: Count resources per module
      command: 'for dir in $(find . -name ''main.tf'' -exec dirname {} \;); do echo "$dir: $(grep -c ''^resource''
        $dir/*.tf 2>/dev/null || echo 0)"; done'
    - purpose: List module sources and versions
      command: grep -rh 'source\s*=' --include='*.tf' | sort -u
    expected_findings:
    - Module directory structure and organization
    - External module dependencies
    - Module complexity metrics
  - id: '2'
    name: Analyze Module Boundaries
    description: |
      Evaluate whether modules follow single-responsibility principle
      and have clear, well-defined boundaries.
    duration_estimate: 30 min
    commands:
    - purpose: Identify modules with many resources
      command: 'for dir in $(find . -name ''main.tf'' -exec dirname {} \;); do count=$(grep -c ''^resource''
        $dir/*.tf 2>/dev/null || echo 0); if [ $count -gt 10 ]; then echo "$dir: $count resources (potential
        monolith)"; fi; done'
    - purpose: Check for circular dependencies
      command: terraform graph 2>/dev/null | grep -E '^\s*"module\.' | head -50
    expected_findings:
    - Modules exceeding recommended size
    - Potential circular dependencies
    - Modules with unclear responsibilities
  - id: '3'
    name: Version Constraint Analysis
    description: |
      Verify all modules have appropriate version constraints
      and follow semantic versioning practices.
    duration_estimate: 20 min
    commands:
    - purpose: Find modules without version constraints
      command: grep -rn 'module\s*"' --include='*.tf' -A5 | grep -B5 'source' | grep -v 'version'
    - purpose: List all version constraints
      command: grep -rh 'version\s*=' --include='*.tf' | sort -u
    expected_findings:
    - Modules missing version constraints
    - Overly permissive version constraints
    - Version constraint patterns in use
  - id: '4'
    name: Documentation Review
    description: |
      Assess documentation quality for all modules including
      README files, variable descriptions, and examples.
    duration_estimate: 25 min
    commands:
    - purpose: Find modules without README
      command: 'for dir in $(find . -name ''main.tf'' -exec dirname {} \;); do if [ ! -f "$dir/README.md"
        ]; then echo "Missing README: $dir"; fi; done'
    - purpose: Find variables without descriptions
      command: grep -rn 'variable\s*"' --include='*.tf' -A10 | grep -B10 -v 'description'
    expected_findings:
    - Modules lacking documentation
    - Undocumented variables and outputs
    - Missing usage examples
  - id: '5'
    name: Module Interface Design
    description: |
      Evaluate the quality of module interfaces including
      input validation, output completeness, and type constraints.
    duration_estimate: 25 min
    commands:
    - purpose: Check for type constraints on variables
      command: grep -rn 'variable\s*"' --include='*.tf' -A5 | grep -v 'type\s*='
    - purpose: Identify modules without outputs
      command: 'for dir in $(find . -name ''main.tf'' -exec dirname {} \;); do if [ ! -f "$dir/outputs.tf"
        ] || [ ! -s "$dir/outputs.tf" ]; then echo "No outputs: $dir"; fi; done'
    expected_findings:
    - Variables missing type constraints
    - Missing validation rules
    - Incomplete output definitions
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Module Inventory
    - Critical Findings
    - Recommendations
    - Module Refactoring Roadmap
  confidence_guidance:
    high: Module structure directly observed, automated analysis completed
    medium: Patterns identified but context-dependent interpretation needed
    low: Inferred from partial evidence or naming conventions
offline:
  capability: full
  cache_manifest:
    knowledge:
    - source_id: terraform-modules
      priority: required
    - source_id: terraform-best-practices
      priority: required
profiles:
  membership:
    quick:
      included: false
      reason: Comprehensive module analysis requires thorough examination
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 2
      reason: Module organization affects security boundary enforcement
closeout_checklist:
- id: module-org-001
  item: All modules have version constraints
  level: CRITICAL
  verification: grep -rL 'version\s*=' --include='*.tf' $(find . -name 'main.tf' -exec dirname {} \;)
    2>/dev/null | wc -l | xargs -I{} test {} -eq 0 && echo PASS || echo FAIL
  expected: PASS
- id: module-org-002
  item: No monolithic modules (>15 resources)
  level: BLOCKING
  verification: for dir in $(find . -name 'main.tf' -exec dirname {} \;); do count=$(grep -c '^resource'
    $dir/*.tf 2>/dev/null || echo 0); if [ $count -gt 15 ]; then echo FAIL; exit 1; fi; done && echo PASS
  expected: PASS
- id: module-org-003
  item: All modules have documentation
  level: WARNING
  verification: for dir in $(find . -name 'main.tf' -exec dirname {} \;); do if [ ! -f "$dir/README.md"
    ]; then echo FAIL; exit 1; fi; done && echo PASS
  expected: PASS
- id: module-org-004
  item: No hard-coded secrets in module sources
  level: CRITICAL
  verification: grep -rE '(password|secret|api_key|token)\s*=\s*"[^"$]+"' --include='*.tf' . | grep -v
    'sensitive\s*=\s*true' | wc -l | xargs -I{} test {} -eq 0 && echo PASS || echo FAIL
  expected: PASS
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: CIS Benchmarks
    controls:
    - Infrastructure as Code controls
  - framework: SOC 2
    controls:
    - CC6.1
    - CC7.1
relationships:
  commonly_combined:
  - infrastructure-as-code.iac-structure.code-reusability
  - infrastructure-as-code.state-management.state-backend-security
  - infrastructure-as-code.security-compliance.policy-as-code
