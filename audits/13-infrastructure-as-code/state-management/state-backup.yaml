audit:
  id: infrastructure-as-code.state-management.state-backup
  name: IaC State Backup
  version: 1.0.0
  last_updated: '2026-01-19'
  status: active
  category: infrastructure-as-code
  category_number: 13
  subcategory: state-management
  tier: phd
  estimated_duration: 1.5 hours
  completeness: complete
  requires_runtime: false
  destructive: false
execution:
  automatable: partial
  severity: high
  scope: infrastructure
  default_profiles:
  - full
  blocks_phase: false
  parallelizable: true
description:
  what: |
    This audit examines backup and recovery mechanisms for Infrastructure
    as Code state files. It evaluates versioning, backup strategies,
    disaster recovery capabilities, and state recovery procedures.

    Key areas examined:
    - State file versioning configuration
    - Backup retention policies
    - Cross-region replication for disaster recovery
    - Point-in-time recovery capabilities
    - State recovery procedures and documentation
    - Backup integrity verification
  why_it_matters: |
    State file loss or corruption can be catastrophic:
    - Infrastructure becomes unmanageable via IaC
    - Resources may be orphaned or duplicated
    - Manual intervention required for every change
    - Compliance audit trails are lost
    - Recovery may require complete infrastructure rebuild

    Proper backup ensures:
    - Quick recovery from accidental deletion or corruption
    - Ability to roll back problematic changes
    - Business continuity during disasters
    - Compliance with data retention requirements
  when_to_run:
  - During disaster recovery planning
  - Before production deployments
  - During compliance audits
  - After state corruption incidents
prerequisites:
  required_artifacts:
  - type: iac_repository
    description: Access to infrastructure code with backend configurations
  - type: backup_config
    description: Access to backup and replication configurations
  access_requirements:
  - Read access to IaC repositories
  - Access to state storage configurations
  - Backup policy documentation access
discovery:
  code_patterns:
  - pattern: versioning\s*\{
    type: regex
    scope: config
    purpose: Find versioning configurations
  - pattern: lifecycle_rule\s*\{
    type: regex
    scope: config
    purpose: Identify retention policies
  - pattern: replication_configuration
    type: regex
    scope: config
    purpose: Find cross-region replication
  - pattern: aws_s3_bucket_versioning
    type: regex
    scope: config
    purpose: S3 versioning resources
  file_patterns:
  - glob: '**/backend.tf'
    purpose: Backend configurations
  - glob: '**/s3.tf'
    purpose: S3 bucket configurations
  - glob: '**/backup.tf'
    purpose: Backup configurations
  - glob: '**/disaster-recovery.tf'
    purpose: DR configurations
knowledge_sources:
  guides:
  - id: s3-versioning
    name: S3 Versioning
    url: https://docs.aws.amazon.com/AmazonS3/latest/userguide/Versioning.html
    offline_cache: true
  - id: s3-replication
    name: S3 Replication
    url: https://docs.aws.amazon.com/AmazonS3/latest/userguide/replication.html
    offline_cache: true
  - id: terraform-state-recovery
    name: Terraform State Recovery
    url: https://developer.hashicorp.com/terraform/tutorials/state/state-import
    offline_cache: true
tooling:
  static_analysis:
  - tool: checkov
    purpose: Check backup configurations
    offline_capable: true
  infrastructure_tools:
  - tool: aws s3api
    purpose: Check versioning status
    command: aws s3api get-bucket-versioning --bucket BUCKET_NAME
  - tool: aws s3api
    purpose: List object versions
    command: aws s3api list-object-versions --bucket BUCKET_NAME --prefix terraform.tfstate
signals:
  critical:
  - id: IAC-BAK-CRIT-001
    signal: State bucket versioning disabled
    evidence_pattern: versioning.*enabled\s*=\s*false
    explanation: |
      Without versioning, state file overwrites are permanent. Any
      corruption, accidental deletion, or malicious modification
      cannot be recovered.
    remediation: 'Enable versioning: versioning { enabled = true }'
  - id: IAC-BAK-CRIT-002
    signal: No backup or replication for state bucket
    evidence_indicators:
    - Single-region state storage
    - No replication configuration
    - No backup jobs configured
    explanation: |
      Without backups or replication, a region outage or data center
      failure could result in complete state loss.
    remediation: Configure cross-region replication or backup jobs
  high:
  - id: IAC-BAK-HIGH-001
    signal: No version retention policy
    evidence_indicators:
    - Versioning enabled but no lifecycle rules
    - Unlimited version retention
    explanation: |
      Without retention policies, storage costs grow unbounded and
      old versions may be retained longer than necessary.
    remediation: Implement lifecycle rules for version expiration
  - id: IAC-BAK-HIGH-002
    signal: No state recovery procedure documented
    evidence_indicators:
    - No runbook for state recovery
    - Recovery process not tested
    explanation: |
      Without documented and tested procedures, state recovery during
      an incident will be slow and error-prone.
    remediation: Create and regularly test state recovery runbooks
  - id: IAC-BAK-HIGH-003
    signal: Replication to same region only
    evidence_indicators:
    - Replication destination in same region
    - No geographic distribution
    explanation: |
      Same-region replication doesn't protect against regional
      outages or disasters.
    remediation: Configure cross-region replication to geographically diverse region
  medium:
  - id: IAC-BAK-MED-001
    signal: No MFA delete protection
    evidence_indicators:
    - MFA delete not enabled on state bucket
    remediation: Enable MFA delete to prevent accidental permanent deletion
  - id: IAC-BAK-MED-002
    signal: Lifecycle rules delete versions too quickly
    evidence_indicators:
    - Version expiration less than 30 days
    remediation: Retain versions for at least 90 days for rollback capability
  - id: IAC-BAK-MED-003
    signal: Backup integrity not verified
    evidence_indicators:
    - No automated backup validation
    - No periodic restore tests
    remediation: Implement automated backup integrity checks
  low:
  - id: IAC-BAK-LOW-001
    signal: No alerting for failed replications
    evidence_indicators:
    - No CloudWatch alarms for replication failures
    remediation: Configure alerts for replication lag and failures
  positive:
  - id: IAC-BAK-POS-001
    signal: Comprehensive backup strategy
    evidence_indicators:
    - Versioning enabled
    - Cross-region replication configured
    - Lifecycle policies defined
  - id: IAC-BAK-POS-002
    signal: Documented and tested recovery procedures
    evidence_indicators:
    - Recovery runbook exists
    - Regular recovery drills conducted
procedure:
  context:
    cognitive_mode: evaluative
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Versioning Configuration Review
    description: |
      Examine versioning configuration for state storage
      buckets.
    duration_estimate: 15 min
    commands:
    - purpose: Find versioning configurations
      command: grep -rA10 'versioning' --include='*.tf' | head -50
    - purpose: Check for aws_s3_bucket_versioning resources
      command: grep -rA10 'aws_s3_bucket_versioning' --include='*.tf'
    - purpose: Look for disabled versioning
      command: grep -rn 'enabled\s*=\s*false' --include='*.tf' | grep -i version
    expected_findings:
    - Versioning status for state buckets
    - Versioning configuration patterns
  - id: '2'
    name: Lifecycle and Retention Analysis
    description: |
      Evaluate lifecycle rules and retention policies for
      state file versions.
    duration_estimate: 20 min
    commands:
    - purpose: Find lifecycle configurations
      command: grep -rA30 'lifecycle_rule' --include='*.tf' | head -100
    - purpose: Check expiration settings
      command: grep -rn 'expiration\|noncurrent_version_expiration' --include='*.tf'
    - purpose: Look for aws_s3_bucket_lifecycle_configuration
      command: grep -rA30 'aws_s3_bucket_lifecycle_configuration' --include='*.tf'
    expected_findings:
    - Lifecycle rules for state bucket
    - Version retention periods
    - Expiration policies
  - id: '3'
    name: Replication Configuration Review
    description: |
      Assess cross-region replication configuration for
      disaster recovery.
    duration_estimate: 20 min
    commands:
    - purpose: Find replication configurations
      command: grep -rA30 'replication_configuration' --include='*.tf' | head -100
    - purpose: Check for aws_s3_bucket_replication_configuration
      command: grep -rA30 'aws_s3_bucket_replication_configuration' --include='*.tf'
    - purpose: Identify replication destinations
      command: grep -rn 'destination.*bucket' --include='*.tf'
    expected_findings:
    - Replication configuration presence
    - Replication destinations
    - Cross-region setup
  - id: '4'
    name: Recovery Documentation Review
    description: |
      Verify existence and quality of state recovery
      procedures.
    duration_estimate: 15 min
    commands:
    - purpose: Search for recovery documentation
      command: find . -name '*.md' -exec grep -l -i 'recovery\|restore\|backup' {} \;
    - purpose: Look for runbooks
      command: find . -type f \( -name '*runbook*' -o -name '*playbook*' -o -name '*disaster*' \)
    expected_findings:
    - Recovery documentation
    - Runbook presence
    - Procedure completeness
  - id: '5'
    name: Monitoring and Alerting Review
    description: |
      Check for monitoring of backup and replication
      health.
    duration_estimate: 10 min
    commands:
    - purpose: Find CloudWatch alarms related to S3/replication
      command: grep -rA20 'aws_cloudwatch_metric_alarm' --include='*.tf' | grep -iA20 's3\|replication'
        | head -50
    - purpose: Check for replication metrics monitoring
      command: grep -rn 'ReplicationLatency\|PendingReplicationCount' --include='*.tf'
    expected_findings:
    - Backup monitoring
    - Replication alerting
    - Health check coverage
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Backup Configuration Status
    - Disaster Recovery Assessment
    - Recovery Procedure Evaluation
    - Recommendations
  confidence_guidance:
    high: Direct configuration analysis
    medium: Inferred from related resources
    low: Based on documentation or assumptions
offline:
  capability: full
  cache_manifest:
    knowledge:
    - source_id: s3-versioning
      priority: required
profiles:
  membership:
    quick:
      included: false
      reason: Backup review requires thorough analysis
    full:
      included: true
      priority: 2
closeout_checklist:
- id: backup-001
  item: State bucket versioning enabled
  level: CRITICAL
  verification: grep -rn 'enabled\s*=\s*true' --include='*.tf' $(grep -rl 'versioning' --include='*.tf'
    | xargs grep -l 'state\|terraform') 2>/dev/null | wc -l | xargs -I{} test {} -gt 0 && echo PASS ||
    echo FAIL
  expected: PASS
- id: backup-002
  item: Cross-region replication configured
  level: BLOCKING
  verification: grep -rn 'replication_configuration\|aws_s3_bucket_replication_configuration' --include='*.tf'
    | wc -l | xargs -I{} test {} -gt 0 && echo PASS || echo FAIL
  expected: PASS
- id: backup-003
  item: Lifecycle rules defined for state bucket
  level: WARNING
  verification: grep -rn 'lifecycle_rule\|aws_s3_bucket_lifecycle_configuration' --include='*.tf' | wc
    -l | xargs -I{} test {} -gt 0 && echo PASS || echo FAIL
  expected: PASS
- id: backup-004
  item: Recovery procedures documented
  level: BLOCKING
  verification: manual
  verification_notes: Verify recovery runbook exists and has been tested
  expected: Confirmed by reviewer
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: SOC 2
    controls:
    - A1.2
    - A1.3
  - framework: ISO 27001
    controls:
    - A.12.3
relationships:
  commonly_combined:
  - infrastructure-as-code.state-management.state-backend-security
  - infrastructure-as-code.state-management.state-file-segmentation
