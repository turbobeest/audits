audit:
  id: infrastructure-as-code.security-compliance.secret-handling
  name: IaC Secret Handling
  version: 1.0.0
  last_updated: '2026-01-19'
  status: active
  category: infrastructure-as-code
  category_number: 13
  subcategory: security-compliance
  tier: phd
  estimated_duration: 2 hours
  completeness: complete
  requires_runtime: false
  destructive: false
execution:
  automatable: partial
  severity: critical
  scope: security
  default_profiles:
  - full
  - security
  blocks_phase: true
  parallelizable: true
description:
  what: |
    This audit examines how secrets are handled in Infrastructure as Code
    including credentials, API keys, certificates, and other sensitive
    data. It evaluates secret injection methods, storage, rotation, and
    protection mechanisms.

    Key areas examined:
    - Secret detection in IaC files
    - Secret manager integration (Vault, AWS Secrets Manager, etc.)
    - Sensitive variable handling
    - State file secret protection
    - Secret rotation automation
    - CI/CD secret injection patterns
  why_it_matters: |
    Improper secret handling in IaC is a leading cause of security breaches:
    - Hard-coded secrets in code persist in git history forever
    - Secrets in state files expose credentials to state readers
    - Unrotated secrets increase exposure window
    - Secrets logged in CI/CD output are widely accessible

    Proper secret handling ensures:
    - Secrets never appear in version control
    - Credential lifecycle is managed
    - Access to secrets is auditable
    - Breach impact is minimized through rotation
  when_to_run:
  - During security code reviews
  - Before repository permissions changes
  - After security incidents
  - During compliance audits
prerequisites:
  required_artifacts:
  - type: iac_repository
    description: Access to infrastructure code repository
  - type: secret_manager_config
    description: Access to secret manager configurations
  access_requirements:
  - Read access to IaC repositories
  - Read access to secret manager configurations
  - CI/CD pipeline configuration access
discovery:
  code_patterns:
  - pattern: (password|secret|key|token|credential)\s*=\s*"[^$\{][^"]{8,}
    type: regex
    scope: config
    purpose: Detect potential hardcoded secrets
  - pattern: AKIA[0-9A-Z]{16}
    type: regex
    scope: config
    purpose: Detect AWS access keys
  - pattern: '-----BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY-----'
    type: regex
    scope: config
    purpose: Detect private keys
  - pattern: data\s+"aws_secretsmanager_secret"
    type: regex
    scope: config
    purpose: Find Secrets Manager references
  - pattern: data\s+"vault_generic_secret"
    type: regex
    scope: config
    purpose: Find Vault secret references
  file_patterns:
  - glob: '**/*.tf'
    purpose: Terraform files to scan for secrets
  - glob: '**/*.tfvars'
    purpose: Variable files that may contain secrets
  - glob: '**/.env*'
    purpose: Environment files (should not exist)
  - glob: '**/*secret*'
    purpose: Files with secret in name
  - glob: '**/*credential*'
    purpose: Files with credential in name
knowledge_sources:
  specifications:
  - id: terraform-sensitive
    name: Terraform Sensitive Variables
    url: https://developer.hashicorp.com/terraform/language/values/variables#suppressing-values-in-cli-output
    offline_cache: true
    priority: required
  guides:
  - id: hashicorp-vault
    name: HashiCorp Vault Integration
    url: https://developer.hashicorp.com/terraform/tutorials/secrets
    offline_cache: true
  - id: aws-secrets-manager
    name: AWS Secrets Manager Best Practices
    url: https://docs.aws.amazon.com/secretsmanager/latest/userguide/best-practices.html
    offline_cache: true
  - id: sops-encryption
    name: SOPS Encrypted Secrets
    url: https://github.com/mozilla/sops
    offline_cache: true
tooling:
  static_analysis:
  - tool: gitleaks
    purpose: Detect secrets in git history
    offline_capable: true
  - tool: trufflehog
    purpose: Find high-entropy strings and secrets
    offline_capable: true
  - tool: checkov
    purpose: Check for secret handling issues
    offline_capable: true
  - tool: tfsec
    purpose: Terraform security scanning including secrets
    offline_capable: true
  infrastructure_tools:
  - tool: git-secrets
    purpose: Pre-commit hook for secret detection
    command: git secrets --scan
  scripts:
  - id: secret-scanner
    language: bash
    purpose: Scan for potential secrets in Terraform files
    source: inline
    code: |
      #!/bin/bash
      echo "=== Potential Hardcoded Secrets ==="
      grep -rEn '(password|secret|key|token)\s*=\s*"[^$\{][^"]+' --include='*.tf' --include='*.tfvars' | \
        grep -v 'sensitive\s*=\s*true' | head -30

      echo ""
      echo "=== AWS Access Keys ==="
      grep -rEn 'AKIA[0-9A-Z]{16}' --include='*.tf' --include='*.tfvars' | head -10

      echo ""
      echo "=== Private Keys ==="
      grep -rln '-----BEGIN.*PRIVATE KEY-----' --include='*.tf' --include='*.tfvars' | head -10
signals:
  critical:
  - id: IAC-SEC-CRIT-001
    signal: Hardcoded secrets in Terraform files
    evidence_pattern: (password|secret|api_key|token)\s*=\s*"[^$\{][^"]{8,}
    explanation: |
      Hardcoded secrets in IaC files are exposed to anyone with
      repository access and persist in git history even after removal.
      This is the most common cause of credential leaks.
    remediation: Remove secrets; use secret managers; rotate compromised credentials immediately
  - id: IAC-SEC-CRIT-002
    signal: AWS credentials in code
    evidence_pattern: AKIA[0-9A-Z]{16}
    explanation: |
      AWS access keys in code are immediately exploitable if the
      repository is compromised or made public.
    remediation: Remove and rotate AWS keys; use IAM roles instead of long-term credentials
  - id: IAC-SEC-CRIT-003
    signal: Private keys committed to repository
    evidence_pattern: '-----BEGIN.*PRIVATE KEY-----'
    explanation: |
      Private keys in repositories can be used for unauthorized access
      to systems, impersonation, and decryption of encrypted data.
    remediation: Remove keys; regenerate new keys; audit systems using compromised keys
  - id: IAC-SEC-CRIT-004
    signal: Secrets in terraform.tfvars committed to repository
    evidence_indicators:
    - terraform.tfvars with sensitive values in git
    - Secret values in version-controlled .tfvars
    explanation: |
      .tfvars files with secrets should not be committed to version
      control as they expose credentials broadly.
    remediation: Remove from git; add to .gitignore; use encrypted secrets or secret managers
  high:
  - id: IAC-SEC-HIGH-001
    signal: Sensitive variables not marked as sensitive
    evidence_pattern: variable\s+"[^"]*(?:password|secret|key|token)"[^}]*(?!sensitive\s*=\s*true)
    explanation: |
      Variables containing secrets should be marked sensitive to
      prevent exposure in logs and plan output.
    remediation: Add sensitive = true to all secret-containing variables
  - id: IAC-SEC-HIGH-002
    signal: Secrets passed as plain environment variables
    evidence_indicators:
    - TF_VAR_* for secrets without encryption
    - Secrets visible in CI/CD logs
    explanation: |
      Environment variables may be logged or visible in process
      listings, exposing secrets.
    remediation: Use secret manager injection; mask secrets in CI/CD
  - id: IAC-SEC-HIGH-003
    signal: No secret manager integration
    evidence_indicators:
    - No vault_* or aws_secretsmanager_* resources
    - No external secret references
    explanation: |
      Without secret manager integration, secrets must be passed
      through less secure channels.
    remediation: Integrate with HashiCorp Vault, AWS Secrets Manager, or similar
  medium:
  - id: IAC-SEC-MED-001
    signal: Secrets in state file not encrypted with KMS
    evidence_indicators:
    - State backend without KMS encryption
    - Sensitive values visible in state
    remediation: Enable KMS encryption for state backend
  - id: IAC-SEC-MED-002
    signal: No secret rotation automation
    evidence_indicators:
    - No rotation configuration in secret manager
    - Static secrets without expiration
    remediation: Implement automatic secret rotation
  - id: IAC-SEC-MED-003
    signal: Secret access not audited
    evidence_indicators:
    - No logging for secret access
    - No alerting on secret retrieval
    remediation: Enable audit logging for secret manager access
  low:
  - id: IAC-SEC-LOW-001
    signal: Secret naming doesn't indicate sensitivity
    evidence_indicators:
    - Generic variable names for secrets
    - No naming convention for sensitive vars
    remediation: Use clear naming conventions for sensitive variables
  positive:
  - id: IAC-SEC-POS-001
    signal: Comprehensive secret manager integration
    evidence_indicators:
    - All secrets from Vault/Secrets Manager
    - No hardcoded secrets
    - Automatic rotation configured
  - id: IAC-SEC-POS-002
    signal: Pre-commit secret scanning enabled
    evidence_indicators:
    - git-secrets or gitleaks in pre-commit hooks
    - CI/CD secret scanning
procedure:
  context:
    cognitive_mode: critical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Secret Scanning
    description: |
      Scan the codebase for hardcoded secrets including
      passwords, API keys, and private keys.
    duration_estimate: 30 min
    commands:
    - purpose: Search for potential hardcoded secrets
      command: grep -rEn '(password|secret|key|token|credential)\s*=\s*"[^$\{][^"]+' --include='*.tf'
        --include='*.tfvars' | grep -v 'sensitive\s*=\s*true' | head -30
    - purpose: Search for AWS access keys
      command: grep -rEn 'AKIA[0-9A-Z]{16}' --include='*.tf' --include='*.tfvars' --include='*.env'
    - purpose: Search for private keys
      command: grep -rln '-----BEGIN.*PRIVATE KEY-----' . | head -20
    - purpose: Run gitleaks if available
      command: gitleaks detect --source . --no-git 2>/dev/null || echo 'gitleaks not available'
    expected_findings:
    - Hardcoded secrets
    - AWS credentials
    - Private keys
  - id: '2'
    name: Sensitive Variable Analysis
    description: |
      Review sensitive variable declarations and ensure
      proper handling.
    duration_estimate: 25 min
    commands:
    - purpose: Find sensitive variable declarations
      command: grep -rn 'sensitive\s*=\s*true' --include='*.tf'
    - purpose: Find potentially sensitive variables not marked
      command: grep -rA5 'variable\s*"[^"]*\(password\|secret\|key\|token\)' --include='*.tf' | grep -v
        sensitive
    - purpose: Check for sensitive outputs
      command: grep -rn 'output\s*"[^"]*\(password\|secret\|key\)' --include='*.tf'
    expected_findings:
    - Sensitive variable coverage
    - Unmarked sensitive variables
    - Sensitive output declarations
  - id: '3'
    name: Secret Manager Integration Review
    description: |
      Assess integration with secret management systems
      like Vault and AWS Secrets Manager.
    duration_estimate: 25 min
    commands:
    - purpose: Find Vault references
      command: grep -rn 'vault_' --include='*.tf' | head -30
    - purpose: Find AWS Secrets Manager references
      command: grep -rn 'aws_secretsmanager' --include='*.tf'
    - purpose: Find SSM Parameter Store references
      command: grep -rn 'aws_ssm_parameter' --include='*.tf' | grep -i secret
    - purpose: Check for external secret configuration
      command: find . -name '*.yaml' -exec grep -l 'ExternalSecret' {} \;
    expected_findings:
    - Secret manager integration
    - Coverage of secret retrieval
    - Secret injection patterns
  - id: '4'
    name: CI/CD Secret Handling Review
    description: |
      Evaluate how secrets are injected and protected
      in CI/CD pipelines.
    duration_estimate: 20 min
    commands:
    - purpose: Check GitHub Actions secrets usage
      command: grep -rn 'secrets\.' --include='*.yml' --include='*.yaml' .github/ 2>/dev/null | head -20
    - purpose: Check for TF_VAR environment variables
      command: grep -rn 'TF_VAR_' --include='*.yml' --include='*.yaml'
    - purpose: Look for secret masking
      command: grep -rn '::add-mask::' --include='*.yml' --include='*.yaml'
    expected_findings:
    - CI/CD secret injection
    - Secret masking configuration
    - Exposure risks in pipelines
  - id: '5'
    name: Git History Secret Scan
    description: |
      Scan git history for secrets that may have been
      committed and later removed.
    duration_estimate: 20 min
    commands:
    - purpose: Check for .gitignore patterns
      command: grep -E '\.(env|tfvars|pem|key)$|secret|credential' .gitignore 2>/dev/null || echo 'No
        relevant patterns in .gitignore'
    - purpose: Run trufflehog if available
      command: trufflehog git file://. --only-verified 2>/dev/null | head -50 || echo 'trufflehog not
        available'
    expected_findings:
    - Git history secrets
    - Gitignore coverage
    - Historical exposures
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Secret Inventory
    - Critical Exposures
    - Remediation Priority
    - Recommendations
  confidence_guidance:
    high: Direct evidence of secret exposure
    medium: Pattern matching suggesting secrets
    low: Potential secrets requiring verification
offline:
  capability: full
  cache_manifest:
    knowledge:
    - source_id: terraform-sensitive
      priority: required
    - source_id: hashicorp-vault
      priority: recommended
profiles:
  membership:
    quick:
      included: true
      priority: 1
      reason: Secret detection is critical and fast
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1
      reason: Core security control
closeout_checklist:
- id: secret-001
  item: No hardcoded secrets in Terraform files
  level: CRITICAL
  verification: grep -rEn '(password|secret|api_key|token)\s*=\s*"[^$\{][^"]{8,}' --include='*.tf' | grep
    -v 'example\|placeholder\|CHANGEME' | wc -l | xargs -I{} test {} -eq 0 && echo PASS || echo FAIL
  expected: PASS
- id: secret-002
  item: No AWS access keys in code
  level: CRITICAL
  verification: grep -rEn 'AKIA[0-9A-Z]{16}' --include='*.tf' --include='*.tfvars' | wc -l | xargs -I{}
    test {} -eq 0 && echo PASS || echo FAIL
  expected: PASS
- id: secret-003
  item: All sensitive variables marked sensitive
  level: BLOCKING
  verification: grep -rA5 'variable\s*"[^"]*\(password\|secret\|key\|token\)' --include='*.tf' | grep
    -v sensitive | grep -c 'variable' | xargs -I{} test {} -eq 0 && echo PASS || echo FAIL
  expected: PASS
- id: secret-004
  item: Secret manager integration present
  level: BLOCKING
  verification: grep -rn 'vault_\|aws_secretsmanager\|aws_ssm_parameter' --include='*.tf' | wc -l | xargs
    -I{} test {} -gt 0 && echo PASS || echo FAIL
  expected: PASS
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: SOC 2
    controls:
    - CC6.1
    - CC6.7
  - framework: PCI-DSS
    controls:
    - '3.4'
    - '3.5'
    - '6.5'
  - framework: CIS Controls
    controls:
    - Control 16
relationships:
  commonly_combined:
  - infrastructure-as-code.state-management.state-encryption
  - infrastructure-as-code.iac-structure.variable-organization
