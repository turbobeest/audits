audit:
  id: infrastructure-as-code.testing-validation.plan-review-process
  name: Plan Review Process
  version: 1.0.0
  last_updated: '2026-01-19'
  status: active
  category: infrastructure-as-code
  category_number: 13
  subcategory: testing-validation
  tier: phd
  estimated_duration: 2-3 hours  # median: 2h
  completeness: complete
  requires_runtime: false
  destructive: false
execution:
  automatable: partial
  severity: critical
  scope: process
  default_profiles:
  - full
  - security
  - production
  blocks_phase: false
  parallelizable: true
description:
  what: |
    This audit examines the processes and tooling used to review Terraform
    plan output before changes are applied to infrastructure. It evaluates:

    - How plan output is generated and presented for review
    - What automated checks analyze plan output
    - How human reviewers evaluate proposed changes
    - What approval workflows gate production applies
    - How drift and unexpected changes are detected

    The audit covers tools like Atlantis, Terraform Cloud, Spacelift, and
    custom CI/CD implementations that surface plan output for review.
  why_it_matters: |
    The terraform plan is the last checkpoint before infrastructure changes
    are applied. Inadequate plan review leads to:

    - Unintended resource destruction (data loss)
    - Security misconfigurations reaching production
    - Cost surprises from expensive resource provisioning
    - Breaking changes affecting dependent systems
    - Compliance violations from unauthorized modifications

    A robust plan review process catches these issues before they cause
    production incidents.
  when_to_run:
  - When establishing IaC deployment processes
  - After an incident caused by unreviewed changes
  - During compliance audit preparation
  - When implementing new IaC tools
prerequisites:
  required_artifacts:
  - type: cicd_configuration
    description: CI/CD pipeline definitions for IaC deployment
  - type: review_workflow
    description: Documentation of plan review process
  access_requirements:
  - Access to CI/CD system configurations
  - Access to pull request workflows
  - Interview access to infrastructure team members
discovery:
  code_patterns:
  - pattern: terraform\s+plan
    type: regex
    scope: config
    purpose: Find plan execution in pipelines
  - pattern: atlantis\s+plan
    type: regex
    scope: config
    purpose: Detect Atlantis plan comments
  - pattern: plan.*-out
    type: regex
    scope: config
    purpose: Check for saved plan files
  - pattern: conftest|opa|sentinel
    type: regex
    scope: config
    purpose: Find policy-as-code enforcement
  - pattern: CODEOWNERS
    type: keyword
    scope: config
    purpose: Identify required reviewers
  file_patterns:
  - glob: '**/.github/workflows/*.yml'
    purpose: GitHub Actions workflows
  - glob: '**/atlantis.yaml'
    purpose: Atlantis configuration
  - glob: '**/.gitlab-ci.yml'
    purpose: GitLab CI configuration
  - glob: '**/CODEOWNERS'
    purpose: Code ownership definitions
  - glob: '**/*.sentinel'
    purpose: Sentinel policy files
  interviews:
  - role: Infrastructure engineers
    questions:
    - How do you review terraform plan output before applying?
    - What triggers require additional approval?
    - How do you handle emergency changes?
    purpose: Understand actual review practices
  - role: Security team
    questions:
    - How do you validate infrastructure changes don't violate security policies?
    - What automated checks run against plan output?
    purpose: Verify security review integration
knowledge_sources:
  specifications:
  - id: atlantis-docs
    name: Atlantis Documentation
    url: https://www.runatlantis.io/
    offline_cache: true
    priority: required
  guides:
  - id: terraform-plan-best-practices
    name: Terraform Plan Best Practices
    url: https://developer.hashicorp.com/terraform/cli/commands/plan
    offline_cache: true
  - id: sentinel-docs
    name: HashiCorp Sentinel Documentation
    url: https://developer.hashicorp.com/sentinel
    offline_cache: true
  - id: conftest-docs
    name: Conftest Policy Testing
    url: https://www.conftest.dev/
    offline_cache: true
tooling:
  static_analysis:
  - tool: terraform show
    purpose: Converts plan file to human-readable or JSON format
    offline_capable: true
  - tool: conftest
    purpose: Tests Terraform plans against OPA policies
    offline_capable: true
  - tool: checkov
    purpose: Scans plan files for security issues
    offline_capable: true
  infrastructure_tools:
  - tool: Atlantis
    purpose: Pull request automation for plan/apply
    command: atlantis plan -d .
  - tool: Terraform Cloud
    purpose: Remote plan execution with review UI
    command: terraform cloud run
  - tool: Spacelift
    purpose: GitOps platform with plan review
    command: spacectl stack plan
  scripts:
  - id: plan-analysis
    language: bash
    purpose: Analyze plan output for dangerous operations
    source: inline
    code: |
      #!/bin/bash
      # Analyze terraform plan for risky changes
      PLAN_JSON=$(terraform show -json tfplan)

      # Count destructive operations
      DESTROYS=$(echo "$PLAN_JSON" | jq '[.resource_changes[] | select(.change.actions | contains(["delete"]))] | length')
      REPLACES=$(echo "$PLAN_JSON" | jq '[.resource_changes[] | select(.change.actions | contains(["delete", "create"]))] | length')

      echo "Destroys: $DESTROYS"
      echo "Replaces: $REPLACES"

      if [ "$DESTROYS" -gt 0 ] || [ "$REPLACES" -gt 0 ]; then
        echo "WARNING: Destructive changes detected - manual review required"
        exit 1
      fi
signals:
  critical:
  - id: IAC-PLAN-CRIT-001
    signal: No plan review before apply - changes go directly to production
    evidence_pattern: terraform apply without preceding plan review or approval
    explanation: |
      Applying infrastructure changes without reviewing the plan allows
      unintended changes to reach production. This can cause outages,
      data loss, security vulnerabilities, and compliance violations.
    remediation: |
      Implement mandatory plan review:
      1. Deploy Atlantis or use Terraform Cloud for PR-based review
      2. Require plan output to be posted as PR comments
      3. Implement branch protection requiring approvals
      4. Separate plan and apply stages in CI/CD
  - id: IAC-PLAN-CRIT-002
    signal: Plan output not preserved - apply uses different plan than reviewed
    evidence_pattern: terraform apply without -input=false and plan file
    explanation: |
      If plan and apply are separate commands without a saved plan file,
      the applied changes may differ from what was reviewed due to
      concurrent changes or state drift.
    remediation: |
      Always save and use plan files:
      terraform plan -out=tfplan
      terraform apply tfplan
  high:
  - id: IAC-PLAN-HIGH-001
    signal: No automated policy checks on plan output
    evidence_pattern: Absence of conftest, sentinel, or OPA in pipeline
    explanation: |
      Without automated policy enforcement, reviewers must manually
      check for every compliance and security requirement, leading
      to inconsistent enforcement and missed violations.
    remediation: |
      Implement policy-as-code:
      - Use Conftest with OPA policies
      - Use HashiCorp Sentinel for Terraform Cloud
      - Add checkov plan scanning
  - id: IAC-PLAN-HIGH-002
    signal: Destructive operations not flagged for additional review
    evidence_pattern: No special handling for delete/replace actions
    explanation: |
      Resource deletions can cause data loss and service disruption.
      These should require explicit acknowledgment and potentially
      additional approvals.
    remediation: |
      Add destructive change detection:
      - Parse plan JSON for delete/replace actions
      - Require explicit approval for destructive changes
      - Implement Atlantis delete_source_branch_on_merge: false
  medium:
  - id: IAC-PLAN-MED-001
    signal: Plan output not visible in pull request
    remediation: |
      Configure plan output to post as PR comment:
      - Atlantis does this automatically
      - GitHub Actions: Use PR comment action
      - GitLab: Use merge request note
  - id: IAC-PLAN-MED-002
    signal: No cost estimation in plan review
    remediation: |
      Add Infracost to pipeline to show cost impact:
      infracost breakdown --path .
      infracost comment github --behavior update
  low:
  - id: IAC-PLAN-LOW-001
    signal: Plan output formatting makes review difficult
    remediation: Use terraform show -json | jq for structured review
  positive:
  - id: IAC-PLAN-POS-001
    signal: Atlantis or similar tool enforces plan review in PRs
  - id: IAC-PLAN-POS-002
    signal: Policy-as-code validates plans before apply
  - id: IAC-PLAN-POS-003
    signal: Cost estimation included in plan review
  - id: IAC-PLAN-POS-004
    signal: Destructive changes require additional approval
procedure:
  context:
    cognitive_mode: critical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Map the plan review workflow
    description: |
      Document the complete flow from code change to infrastructure apply,
      identifying all review checkpoints.
    duration_estimate: 30 min
    commands:
    - purpose: Check for Atlantis
      command: find . -name 'atlantis.yaml' -o -name 'atlantis.yml' | head -5
    - purpose: Check CI/CD for plan steps
      command: grep -r 'terraform plan' .github/ .gitlab-ci.yml Jenkinsfile 2>/dev/null | head -20
    - purpose: Check for plan file usage
      command: grep -r 'plan.*-out\|apply.*tfplan' .github/ .gitlab-ci.yml 2>/dev/null | head -10
    expected_findings:
    - IaC deployment tooling in use
    - Plan/apply workflow structure
    - Plan file handling
  - id: '2'
    name: Evaluate approval requirements
    description: |
      Check what approvals are required before terraform apply can execute.
    duration_estimate: 20 min
    commands:
    - purpose: Check branch protection
      command: gh api repos/{owner}/{repo}/branches/main/protection 2>/dev/null | jq '.required_pull_request_reviews'
    - purpose: Check CODEOWNERS
      command: cat CODEOWNERS .github/CODEOWNERS 2>/dev/null | head -30
    - purpose: Check Atlantis approval requirements
      command: cat atlantis.yaml 2>/dev/null | grep -A5 'apply_requirements'
    expected_findings:
    - Required approver count
    - CODEOWNERS configuration
    - Apply requirements
  - id: '3'
    name: Assess automated policy enforcement
    description: |
      Identify what automated checks validate plan output before apply.
    duration_estimate: 30 min
    commands:
    - purpose: Find policy files
      command: find . -name '*.sentinel' -o -name '*.rego' | head -20
    - purpose: Check for Conftest usage
      command: grep -r 'conftest' .github/ Makefile 2>/dev/null | head -10
    - purpose: Check for plan scanning
      command: grep -r 'checkov.*plan\|terraform show' .github/ 2>/dev/null | head -10
    expected_findings:
    - Policy-as-code implementation
    - Plan scanning tools
    - Policy coverage areas
  - id: '4'
    name: Verify destructive change handling
    description: |
      Check how resource deletions and replacements are handled.
    duration_estimate: 20 min
    commands:
    - purpose: Check for destroy detection
      command: grep -r 'delete\|destroy\|replace' .github/ atlantis.yaml 2>/dev/null | head -20
    expected_findings:
    - Destructive change detection
    - Additional approval requirements
  - id: '5'
    name: Interview infrastructure team
    description: |
      Understand the actual review practices through team interviews.
    duration_estimate: 45 min
    questions:
    - Walk me through your typical IaC change review process
    - How do you handle urgent infrastructure changes?
    - What do you look for when reviewing a terraform plan?
    - Have you had incidents from inadequate plan review?
    expected_findings:
    - Actual vs documented practices
    - Team confidence in review process
    - Process improvement opportunities
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Plan Review Workflow Analysis
    - Approval Mechanism Review
    - Automated Policy Assessment
    - Recommendations
  confidence_guidance:
    high: Workflow verified through execution and team interviews
    medium: Configuration reviewed and documented
    low: Only file presence confirmed
offline:
  capability: partial
  cache_manifest:
    knowledge:
    - source_id: atlantis-docs
      priority: required
profiles:
  membership:
    quick:
      included: false
      reason: Requires process investigation
    full:
      included: true
      priority: 1
    production:
      included: true
      reason: Critical for production safety
    security:
      included: true
      reason: Security gate for infrastructure changes
closeout_checklist:
- id: plan-review-001
  item: Plan review required before all applies
  level: CRITICAL
  verification: manual
  verification_notes: Verify CI/CD requires plan approval before apply
  expected: Confirmed by reviewer
- id: plan-review-002
  item: Plan files saved and used for apply
  level: CRITICAL
  verification: grep -r 'plan.*-out' .github/ | wc -l
  expected: '>0'
- id: plan-review-003
  item: Automated policy checks on plan output
  level: BLOCKING
  verification: manual
  verification_notes: Verify conftest, sentinel, or similar in pipeline
  expected: Confirmed by reviewer
- id: plan-review-004
  item: Destructive changes require additional approval
  level: BLOCKING
  verification: manual
  verification_notes: Verify delete operations are flagged
  expected: Confirmed by reviewer
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: SOC 2
    controls:
    - CC6.1
    - CC8.1
  - framework: ISO 27001
    controls:
    - A.12.1.2
    - A.14.2.2
  - framework: PCI DSS
    controls:
    - 6.4.2
relationships:
  commonly_combined:
  - infrastructure-as-code.cicd-integration.approval-workflow
  - infrastructure-as-code.cicd-integration.iac-pipeline
  - infrastructure-as-code.testing-validation.iac-unit-testing
