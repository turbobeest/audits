# ============================================================
# AUDIT: Changelog Maintenance
# ============================================================

audit:
  id: "api-integration.api-documentation.changelog-maintenance"
  name: "Changelog Maintenance Audit"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "api-integration"
  category_number: 9
  subcategory: "api-documentation"

  tier: "expert"
  estimated_duration: "60 minutes"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "documentation"

  default_profiles:
    - "full"
    - "api"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates API changelog practices including change documentation,
    breaking change identification, migration guides, version history,
    deprecation notices, and communication processes. Analyzes whether
    API changes are properly communicated to consumers.

  why_it_matters: |
    API changes without proper changelog break integrations silently.
    Developers waste time debugging issues caused by undocumented
    changes. Breaking changes without migration paths cause customer
    churn and support escalations.

  when_to_run:
    - "API version releases"
    - "Breaking change reviews"
    - "API governance audits"
    - "After integration incidents"

prerequisites:
  required_artifacts:
    - type: "documentation"
      description: "API changelog or release notes"
    - type: "source_code"
      description: "API version history in git"

  access_requirements:
    - "Read access to changelog"
    - "Read access to git history"

discovery:
  code_patterns:
    - pattern: "CHANGELOG|changelog|BREAKING|deprecated"
      type: "regex"
      scope: "docs"
      purpose: "Detect changelog files"

    - pattern: "@deprecated|@obsolete|deprecated:"
      type: "regex"
      scope: "source"
      purpose: "Detect deprecation markers"

  file_patterns:
    - glob: "**/CHANGELOG.md"
      purpose: "Changelog file"
    - glob: "**/HISTORY.md"
      purpose: "History file"
    - glob: "**/CHANGES.md"
      purpose: "Changes file"
    - glob: "**/MIGRATION.md"
      purpose: "Migration guide"

knowledge_sources:
  specifications:
    - id: "semver"
      name: "Semantic Versioning"
      url: "https://semver.org/"
      offline_cache: true
      priority: "required"
    - id: "openapi-spec"
      name: "OpenAPI Specification"
      url: "https://spec.openapis.org/oas/latest.html"
      offline_cache: true
      priority: "recommended"

  guides:
    - id: "keep-changelog"
      name: "Keep a Changelog"
      url: "https://keepachangelog.com/"
      offline_cache: true

    - id: "api-versioning"
      name: "API Versioning Best Practices"
      url: "https://www.moesif.com/blog/technical/api-design/Best-Practices-for-Versioning-REST-and-GraphQL-APIs/"
      offline_cache: true

  learning_resources:
    - id: "breaking-changes"
      title: "Managing Breaking Changes"
      type: "article"
      reference: "Stripe Developer Blog"

tooling:
  static_analysis:
    - tool: "openapi-diff"
      purpose: "Detect API changes between versions"
      offline_capable: true

  scripts:
    - id: "changelog-scan"
      language: "bash"
      purpose: "Analyze changelog practices"
      source: "inline"
      code: |
        echo "=== Changelog Maintenance Analysis ==="
        echo "--- Changelog files ---"
        find . -name "CHANGELOG*" -o -name "HISTORY*" \
          -o -name "CHANGES*" 2>/dev/null | \
          grep -v node_modules | head -10

        echo "--- Deprecation markers ---"
        grep -rn "@deprecated\|deprecated:\|DEPRECATED" \
          --include="*.ts" --include="*.java" --include="*.py" \
          --include="*.yaml" . 2>/dev/null | \
          grep -v node_modules | head -20

        echo "--- Breaking change mentions ---"
        grep -rn "BREAKING\|breaking change\|backwards incompatible" \
          . 2>/dev/null | grep -v node_modules | head -20

signals:
  critical:
    - id: "CM-CRIT-001"
      signal: "No API changelog exists"
      evidence_pattern: "No CHANGELOG file or release notes found"
      explanation: |
        Without a changelog, API consumers have no way to know what
        changed between versions. They discover breaking changes only
        when their integrations fail.
      remediation: "Create and maintain a changelog following keepachangelog.com"

    - id: "CM-CRIT-002"
      signal: "Breaking changes shipped without notice"
      evidence_pattern: "API breaking change not documented in changelog"
      explanation: |
        Undocumented breaking changes cause immediate integration
        failures. Customers experience outages and lose trust in the
        API platform.
      remediation: "Document all breaking changes with migration paths"

  high:
    - id: "CM-HIGH-001"
      signal: "No migration guides for breaking changes"
      evidence_pattern: "Breaking changes listed without migration instructions"
      explanation: |
        Identifying breaking changes is not enough. Developers need
        clear instructions on how to update their integrations.
        Without guidance, migration takes much longer.
      remediation: "Provide migration guides for all breaking changes"

    - id: "CM-HIGH-002"
      signal: "Deprecated endpoints not marked in code"
      evidence_pattern: "Endpoints removed without @deprecated marking"
      explanation: |
        Without deprecation warnings in responses or documentation,
        consumers don't know to migrate until the endpoint disappears.
      remediation: "Mark deprecated endpoints with sunset dates"

    - id: "CM-HIGH-003"
      signal: "No deprecation policy defined"
      evidence_pattern: "No documented deprecation timeline"
      explanation: |
        Without a deprecation policy, consumers don't know how long
        they have to migrate. This creates uncertainty and slows
        adoption of new API versions.
      remediation: "Define and publish deprecation policy (e.g., 6 month notice)"

  medium:
    - id: "CM-MED-001"
      signal: "Changelog not following standard format"
      evidence_pattern: "Inconsistent changelog structure"
      remediation: "Follow keepachangelog.com format"

    - id: "CM-MED-002"
      signal: "Changes not linked to releases"
      evidence_pattern: "Changelog entries without version numbers"
      remediation: "Associate changes with specific version releases"

    - id: "CM-MED-003"
      signal: "No change notification mechanism"
      evidence_pattern: "No email list or webhook for API changes"
      remediation: "Implement change notification for API consumers"

  low:
    - id: "CM-LOW-001"
      signal: "Changelog not updated frequently"
      evidence_pattern: "Last changelog update > 6 months ago"
      remediation: "Update changelog with every release"

  positive:
    - id: "CM-POS-001"
      signal: "Comprehensive changelog maintained"
      evidence_pattern: "All changes documented with categories"

    - id: "CM-POS-002"
      signal: "Breaking changes clearly marked"
      evidence_pattern: "BREAKING prefix or section in changelog"

    - id: "CM-POS-003"
      signal: "Migration guides provided"
      evidence_pattern: "Step-by-step migration instructions available"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Find Changelog"
      description: |
        Locate changelog and related documentation.
      duration_estimate: "10 min"
      commands:
        - purpose: "Find changelog files"
          command: |
            find . -name "CHANGELOG*" -o -name "HISTORY*" \
              -o -name "CHANGES*" -o -name "MIGRATION*" 2>/dev/null | \
              grep -v node_modules | head -10
        - purpose: "Find release notes"
          command: |
            find . -name "RELEASE*" -o -name "release-notes*" 2>/dev/null | \
              grep -v node_modules | head -10

      expected_findings:
        - "Changelog location"
        - "Documentation format"

    - id: "2"
      name: "Analyze Changelog Structure"
      description: |
        Check if changelog follows best practices.
      duration_estimate: "15 min"
      commands:
        - purpose: "Check changelog content"
          command: |
            head -100 CHANGELOG.md 2>/dev/null || \
              head -100 CHANGELOG 2>/dev/null || echo "No CHANGELOG found"

      expected_findings:
        - "Structure quality"
        - "Version organization"

    - id: "3"
      name: "Review Breaking Changes"
      description: |
        Check how breaking changes are documented.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find breaking change documentation"
          command: |
            grep -rn "BREAKING\|breaking change" \
              . 2>/dev/null | grep -v node_modules | head -20

      expected_findings:
        - "Breaking change documentation"
        - "Migration guidance"

    - id: "4"
      name: "Check Deprecation Practices"
      description: |
        Review how deprecations are handled.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find deprecation markers"
          command: |
            grep -rn "@deprecated\|deprecated:" \
              --include="*.ts" --include="*.java" --include="*.yaml" . 2>/dev/null | \
              grep -v node_modules | head -20

      expected_findings:
        - "Deprecation approach"
        - "Sunset dates"

    - id: "5"
      name: "Evaluate Communication"
      description: |
        Check if change notification exists.
      duration_estimate: "5 min"
      questions:
        - "How are API consumers notified of changes?"
        - "Is there a developer mailing list or webhook?"
        - "Are changes announced before release?"

      expected_findings:
        - "Communication channels"
        - "Notification process"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      content:
        - "changelog_status"
        - "breaking_change_handling"
        - "deprecation_practices"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Changelog Analysis"
        - "Communication Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Clear changelog presence or absence"
    medium: "Changelog exists but quality uncertain"
    low: "Requires content review to assess"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "keep-changelog"
        priority: "required"
      - source_id: "semver"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Documentation assessment"
    full:
      included: true
      priority: 1
    api:
      included: true
      priority: 1

closeout_checklist:
  - id: "cm-001"
    item: "Changelog exists"
    level: "CRITICAL"
    verification: |
      find . -name "CHANGELOG*" -o -name "HISTORY*" 2>/dev/null | \
        grep -v node_modules | wc -l | xargs -I {} test {} -gt 0 && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "cm-002"
    item: "Breaking changes documented"
    level: "CRITICAL"
    verification: |
      grep -rn "BREAKING\|breaking change" . 2>/dev/null | \
        grep -v node_modules | wc -l | xargs -I {} test {} -ge 0 && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "cm-003"
    item: "Deprecations marked in code"
    level: "WARNING"
    verification: |
      grep -rn "@deprecated\|deprecated:" \
        --include="*.ts" --include="*.java" --include="*.yaml" . 2>/dev/null | \
        grep -v node_modules | wc -l | xargs -I {} test {} -ge 0 && echo "PASS" || echo "FAIL"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Compatibility"]

relationships:
  commonly_combined:
    - "api-integration.api-documentation.documentation-completeness"
    - "api-integration.api-documentation.documentation-accuracy"
    - "architecture-design.api-versioning.versioning-strategy"
