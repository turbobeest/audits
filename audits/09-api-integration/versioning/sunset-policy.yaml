# ============================================================
# AUDIT: Sunset Policy Assessment
# ============================================================
# Evaluates API version sunset policy and enforcement
# ============================================================

audit:
  id: "api-integration.versioning.sunset-policy"

  name: "Sunset Policy Assessment"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "api-integration"
  category_number: 9
  subcategory: "versioning"

  tier: "expert"
  estimated_duration: "1.5 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "process"

  default_profiles:
    - "full"
    - "production"

  parallelizable: true

description:
  what: |
    Evaluates the API sunset policy including defined timelines, consumer
    notification process, usage monitoring before sunset, graceful degradation,
    and post-sunset handling. Examines whether the policy is documented,
    consistently enforced, and consumer-friendly.

  why_it_matters: |
    A clear sunset policy sets expectations for API lifecycle, enables
    consumers to plan migrations, and prevents version proliferation.
    Without a policy, old versions accumulate maintenance burden, or
    consumers are surprised by arbitrary removals.

  when_to_run:
    - "When establishing API governance"
    - "Before major version sunsets"
    - "During annual API reviews"

prerequisites:
  required_artifacts:
    - type: "policy-docs"
      description: "API lifecycle and sunset policy documents"
    - type: "api-metrics"
      description: "API usage metrics by version"

  access_requirements:
    - "Read access to policy documentation"
    - "Access to API metrics/analytics"

discovery:
  code_patterns:
    - pattern: "sunset|end.of.life|eol|retire"
      type: "regex"
      scope: "documentation"
      purpose: "Sunset policy documentation"
    - pattern: "Sunset:|RFC.*8594"
      type: "regex"
      scope: "source"
      purpose: "Sunset header implementation"

  file_patterns:
    - glob: "**/*policy*"
      purpose: "Policy documents"
    - glob: "**/*lifecycle*"
      purpose: "Lifecycle documentation"
    - glob: "**/docs/**/*.md"
      purpose: "Documentation files"

knowledge_sources:
  specifications:
    - id: "rfc-8594"
      name: "RFC 8594 - The Sunset HTTP Header Field"
      url: "https://datatracker.ietf.org/doc/html/rfc8594"
      offline_cache: true
      priority: "required"

  guides:
    - id: "api-lifecycle"
      name: "API Lifecycle Management"
      url: "https://swagger.io/blog/api-strategy/api-lifecycle-management/"
      offline_cache: true

tooling:
  assessment_tools:
    - tool: "API Analytics"
      purpose: "Monitor version usage for sunset decisions"

signals:
  critical:
    - id: "SUNSET-CRIT-001"
      signal: "No documented sunset policy"
      evidence_indicators:
        - "No policy document found"
        - "No sunset timeline defined"
        - "Ad-hoc version removal"
      explanation: |
        Without a documented policy, version removals are unpredictable.
        Consumers cannot plan migrations or trust version stability.
      remediation: "Document sunset policy with timelines, process, and commitments"

    - id: "SUNSET-CRIT-002"
      signal: "Active consumers on versions being sunset"
      evidence_pattern: "sunset.*active.*users|traffic.*deprecated"
      explanation: |
        Sunsetting versions with active traffic breaks live integrations.
        Usage should be near-zero before final removal.
      remediation: "Monitor usage and extend sunset for versions with active consumers"

  high:
    - id: "SUNSET-HIGH-001"
      signal: "No usage monitoring for sunset decisions"
      evidence_indicators:
        - "No metrics on version usage"
        - "Cannot identify affected consumers"
      explanation: |
        Without usage data, sunset decisions are uninformed. You may
        remove versions that are still heavily used.
      remediation: "Implement per-version usage tracking and consumer identification"

    - id: "SUNSET-HIGH-002"
      signal: "Sunset without consumer notification"
      evidence_pattern: "sunset.*without.*notify|removed.*no.*contact"
      explanation: |
        Consumers should be directly notified of upcoming sunsets via
        multiple channels, not just passive documentation updates.
      remediation: "Implement direct notification (email, webhook, dashboard) for sunsets"

  medium:
    - id: "SUNSET-MED-001"
      signal: "No grace period after sunset date"
      evidence_indicators:
        - "Immediate 404 after sunset"
        - "No graceful degradation"
      remediation: "Return helpful error with migration info after sunset"

    - id: "SUNSET-MED-002"
      signal: "Inconsistent sunset enforcement"
      evidence_pattern: "extended.*some|exception.*made"
      remediation: "Apply sunset policy consistently or document exception process"

  low:
    - id: "SUNSET-LOW-001"
      signal: "No post-sunset analytics review"
      remediation: "Review impact of sunsets to improve future policy"

  positive:
    - id: "SUNSET-POS-001"
      signal: "Documented sunset policy with defined timelines"
    - id: "SUNSET-POS-002"
      signal: "Usage monitoring drives sunset decisions"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Review Sunset Policy Documentation"
      description: |
        Find and evaluate the sunset policy documentation.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find policy documents"
          command: "find . -name '*policy*' -o -name '*lifecycle*' -o -name '*sunset*' 2>/dev/null | head -10"
        - purpose: "Search for sunset terms"
          command: "grep -rn 'sunset\\|end.of.life\\|retirement\\|eol' --include='*.md' ."
        - purpose: "Check for timeline definitions"
          command: "grep -rn 'month\\|year\\|timeline\\|period' --include='*.md' . | grep -i 'sunset\\|deprecat\\|support' | head -10"
      expected_findings:
        - "Policy documentation"
        - "Timeline definitions"

    - id: "2"
      name: "Check Sunset Header Implementation"
      description: |
        Verify Sunset header is used correctly.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find Sunset header"
          command: "grep -rn 'Sunset' --include='*.java' --include='*.ts' --include='*.py' ."
        - purpose: "Check header format"
          command: "grep -rn 'Sunset.*:' --include='*.java' --include='*.ts' . | head -10"
      expected_findings:
        - "Sunset header usage"
        - "Date format compliance"

    - id: "3"
      name: "Evaluate Monitoring Capabilities"
      description: |
        Check for version usage monitoring.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find usage tracking"
          command: "grep -rn 'metric\\|analytics\\|usage\\|track' --include='*.java' --include='*.ts' . | grep -i version | head -20"
        - purpose: "Check for consumer identification"
          command: "grep -rn 'client.*id\\|consumer\\|api.*key' --include='*.java' --include='*.ts' . | head -20"
      expected_findings:
        - "Usage tracking implementation"
        - "Consumer identification"

    - id: "4"
      name: "Review Historical Sunsets"
      description: |
        Examine how previous sunsets were handled.
      duration_estimate: "15 min"
      commands:
        - purpose: "Check changelog for sunsets"
          command: "grep -in 'sunset\\|removed\\|retired\\|end.of.life' $(find . -name 'CHANGELOG*' | head -1) 2>/dev/null | head -20"
        - purpose: "Find sunset-related commits"
          command: "git log --oneline --grep='sunset\\|retire\\|remove.*v[0-9]' 2>/dev/null | head -10"
      expected_findings:
        - "Sunset history"
        - "Historical patterns"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Policy Analysis"
        - "Implementation Review"
        - "Recommendations"

  confidence_guidance:
    high: "Policy and implementation thoroughly analyzed"
    medium: "Partial policy found"
    low: "No documented policy"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "rfc-8594"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires policy and process review"
    full:
      included: true
      priority: 2

closeout_checklist:
  - id: "sunset-001"
    item: "Sunset policy is documented"
    level: "CRITICAL"
    verification: |
      if grep -rq 'sunset\|end.of.life\|retirement' --include='*.md' . 2>/dev/null || find . -name '*policy*' 2>/dev/null | grep -q .; then echo "PASS"; else echo "FAIL"; fi
    expected: "PASS"

  - id: "sunset-002"
    item: "Sunset timelines are defined"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Reviewer confirms minimum support period is documented"
    expected: "Confirmed by reviewer"

  - id: "sunset-003"
    item: "Usage monitoring exists for versions"
    level: "BLOCKING"
    verification: |
      if grep -rq 'metric\|analytics\|usage.*version' --include='*.java' --include='*.ts' . 2>/dev/null; then echo "PASS"; else echo "FAIL"; fi
    expected: "PASS"

  - id: "sunset-004"
    item: "Consumer notification process defined"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Reviewer confirms notification process is documented"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["api-service", "platform", "enterprise-api"]

  compliance_frameworks:
    - framework: "API Governance"
      controls: ["LIFECYCLE-002"]

relationships:
  commonly_combined:
    - "api-integration.versioning.deprecation-communication"
    - "api-integration.versioning.multi-version-support"
