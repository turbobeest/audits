# ============================================================
# AUDIT: Deprecation Communication Assessment
# ============================================================
# Evaluates API deprecation notice and communication practices
# ============================================================

audit:
  id: "api-integration.versioning.deprecation-communication"

  name: "Deprecation Communication Assessment"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "api-integration"
  category_number: 9
  subcategory: "versioning"

  tier: "expert"
  estimated_duration: "1.5 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "production"

  parallelizable: true

description:
  what: |
    Evaluates how API deprecations are communicated to consumers including
    deprecation headers, documentation, warnings, migration guides, and
    advance notice periods. Examines whether consumers have adequate time
    and information to migrate.

  why_it_matters: |
    Poor deprecation communication results in surprised consumers when APIs
    break, damaged relationships, and emergency migration projects. Good
    communication enables smooth transitions, maintains trust, and reduces
    support burden.

  when_to_run:
    - "Before deprecating API versions"
    - "During API lifecycle reviews"
    - "When planning version sunsets"

prerequisites:
  required_artifacts:
    - type: "api-source"
      description: "API implementations"
    - type: "api-docs"
      description: "API documentation"

  access_requirements:
    - "Read access to API source code"
    - "Access to API documentation"
    - "Access to communication channels"

discovery:
  code_patterns:
    - pattern: "@Deprecated|deprecated.*true|x-deprecated"
      type: "regex"
      scope: "source"
      purpose: "Deprecation annotations"
    - pattern: "Deprecation:|Sunset:|Warning:.*deprecated"
      type: "regex"
      scope: "source"
      purpose: "Deprecation headers"
    - pattern: "deprecated|sunset|end-of-life|eol"
      type: "regex"
      scope: "documentation"
      purpose: "Deprecation documentation"

  file_patterns:
    - glob: "**/*openapi*.{yaml,yml,json}"
      purpose: "OpenAPI specifications"
    - glob: "**/docs/**/*.md"
      purpose: "Documentation"
    - glob: "**/CHANGELOG*"
      purpose: "Change logs"

knowledge_sources:
  specifications:
    - id: "rfc-8594"
      name: "RFC 8594 - The Sunset HTTP Header Field"
      url: "https://datatracker.ietf.org/doc/html/rfc8594"
      offline_cache: true
      priority: "required"
    - id: "deprecation-header"
      name: "Deprecation HTTP Header Field"
      url: "https://datatracker.ietf.org/doc/draft-ietf-httpapi-deprecation-header/"
      offline_cache: true
      priority: "required"

  guides:
    - id: "api-deprecation"
      name: "API Deprecation Best Practices"
      url: "https://cloud.google.com/apis/design/compatibility"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "spectral"
      purpose: "Check for deprecated markers in OpenAPI"
      offline_capable: true

signals:
  critical:
    - id: "DEPREC-CRIT-001"
      signal: "APIs removed without prior deprecation notice"
      evidence_pattern: "removed.*without.*notice|sudden.*removal"
      explanation: |
        Removing APIs without deprecation notice breaks consumers immediately.
        This damages trust and creates emergency situations for dependent
        systems.
      remediation: "Always deprecate before removing; provide minimum 6 month notice"

    - id: "DEPREC-CRIT-002"
      signal: "No deprecation headers on deprecated endpoints"
      evidence_pattern: "@Deprecated(?!.*Deprecation.*header)"
      explanation: |
        Deprecated endpoints without headers don't warn consumers at runtime.
        Applications continue using deprecated APIs without visibility.
      remediation: "Add Deprecation and Sunset headers to deprecated endpoints"

  high:
    - id: "DEPREC-HIGH-001"
      signal: "No migration guide for deprecated APIs"
      evidence_indicators:
        - "Deprecation without replacement documentation"
        - "No migration path documented"
      explanation: |
        Deprecation without migration guidance leaves consumers stranded.
        They must reverse-engineer the replacement or contact support.
      remediation: "Provide migration guide with examples for each deprecation"

    - id: "DEPREC-HIGH-002"
      signal: "Deprecation notice period too short"
      evidence_pattern: "sunset.*<.*30.*days|deprecat.*immediate"
      explanation: |
        Short deprecation periods don't allow time for testing and
        deployment cycles. Enterprise consumers may need 3-6+ months.
      remediation: "Provide minimum 3-6 months notice for deprecations"

  medium:
    - id: "DEPREC-MED-001"
      signal: "No Sunset header with deprecation date"
      evidence_indicators:
        - "Deprecation header without Sunset"
        - "No end date communicated"
      remediation: "Add Sunset header indicating when API will be removed"

    - id: "DEPREC-MED-002"
      signal: "Deprecated endpoints not marked in OpenAPI"
      evidence_pattern: "deprecated.*code(?!.*openapi)"
      remediation: "Add deprecated: true to OpenAPI endpoint definitions"

  low:
    - id: "DEPREC-LOW-001"
      signal: "No deprecation tracking or metrics"
      remediation: "Track usage of deprecated endpoints to inform sunset timing"

  positive:
    - id: "DEPREC-POS-001"
      signal: "Deprecation and Sunset headers on deprecated endpoints"
    - id: "DEPREC-POS-002"
      signal: "Comprehensive migration guides available"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify Deprecated APIs"
      description: |
        Find all deprecated endpoints and versions.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find deprecated annotations"
          command: "grep -rn '@Deprecated\\|deprecated.*=.*true' --include='*.java' --include='*.ts' ."
        - purpose: "Find deprecated in OpenAPI"
          command: "grep -rn 'deprecated:\\s*true' --include='*.yaml' --include='*.yml' ."
        - purpose: "Find deprecation in docs"
          command: "grep -rn 'deprecated\\|DEPRECATED' --include='*.md' ."
      expected_findings:
        - "Deprecated API inventory"
        - "Deprecation markers"

    - id: "2"
      name: "Check Header Implementation"
      description: |
        Verify deprecation headers are sent in responses.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find Deprecation header"
          command: "grep -rn 'Deprecation\\|setHeader.*deprecat' --include='*.java' --include='*.ts' ."
        - purpose: "Find Sunset header"
          command: "grep -rn 'Sunset\\|setHeader.*sunset' --include='*.java' --include='*.ts' ."
        - purpose: "Check response interceptors"
          command: "grep -rn 'interceptor\\|filter\\|middleware' --include='*.java' --include='*.ts' . | grep -i deprec | head -10"
      expected_findings:
        - "Header implementation"
        - "Response modification"

    - id: "3"
      name: "Review Migration Documentation"
      description: |
        Check for migration guides and replacement documentation.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find migration docs"
          command: "find . -name '*migration*' -o -name '*MIGRATION*' 2>/dev/null | head -10"
        - purpose: "Check changelog for deprecations"
          command: "grep -in 'deprecat\\|removed\\|replaced' $(find . -name 'CHANGELOG*' | head -1) 2>/dev/null | head -20"
        - purpose: "Find replacement docs"
          command: "grep -rn 'replace.*with\\|use.*instead\\|migrate.*to' --include='*.md' ."
      expected_findings:
        - "Migration documentation"
        - "Replacement guidance"

    - id: "4"
      name: "Evaluate Notice Period"
      description: |
        Check deprecation timeline and notice periods.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find sunset dates"
          command: "grep -rn 'sunset\\|end.of.life\\|removal.date' --include='*.md' --include='*.yaml' ."
        - purpose: "Check deprecation history"
          command: "git log --oneline --grep='deprecat' 2>/dev/null | head -10"
      expected_findings:
        - "Sunset dates"
        - "Notice timeline"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Deprecation Inventory"
        - "Communication Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Deprecation practices thoroughly analyzed"
    medium: "Partial deprecation coverage found"
    low: "Limited deprecation evidence"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "rfc-8594"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires documentation review"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "deprec-001"
    item: "Deprecated endpoints have Deprecation header"
    level: "CRITICAL"
    verification: |
      deprecated=$(grep -rq '@Deprecated\|deprecated.*true' --include='*.java' --include='*.ts' . 2>/dev/null && echo "yes" || echo "no"); if [ "$deprecated" = "yes" ]; then if grep -rq 'Deprecation.*header\|setHeader.*Deprecation' --include='*.java' --include='*.ts' . 2>/dev/null; then echo "PASS"; else echo "FAIL"; fi; else echo "PASS"; fi
    expected: "PASS"

  - id: "deprec-002"
    item: "Sunset dates communicated"
    level: "BLOCKING"
    verification: |
      if grep -rq 'Sunset\|sunset.*date\|end-of-life' --include='*.java' --include='*.ts' --include='*.md' --include='*.yaml' . 2>/dev/null; then echo "PASS"; else echo "FAIL"; fi
    expected: "PASS"

  - id: "deprec-003"
    item: "Migration guide available for deprecations"
    level: "BLOCKING"
    verification: |
      if find . -name '*migration*' -o -name '*MIGRATION*' 2>/dev/null | grep -q . || grep -rq 'use.*instead\|replace.*with\|migrate.*to' --include='*.md' . 2>/dev/null; then echo "PASS"; else echo "FAIL"; fi
    expected: "PASS"

  - id: "deprec-004"
    item: "Deprecations marked in OpenAPI spec"
    level: "WARNING"
    verification: |
      if grep -rq 'deprecated:\s*true' --include='*.yaml' --include='*.yml' . 2>/dev/null; then echo "PASS"; else echo "FAIL"; fi
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["api-service", "platform", "enterprise-api"]

  compliance_frameworks:
    - framework: "API Governance"
      controls: ["LIFECYCLE-001"]

relationships:
  commonly_combined:
    - "api-integration.versioning.sunset-policy"
    - "api-integration.versioning.versioning-strategy"
