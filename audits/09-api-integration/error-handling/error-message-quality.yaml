# ============================================================
# AUDIT: Error Message Quality Assessment
# ============================================================
# Evaluates API error message clarity and helpfulness
# ============================================================

audit:
  id: "api-integration.error-handling.error-message-quality"

  name: "Error Message Quality Assessment"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "api-integration"
  category_number: 9
  subcategory: "error-handling"

  tier: "expert"
  estimated_duration: "1.5 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "codebase"

  default_profiles:
    - "full"

  parallelizable: true

description:
  what: |
    Evaluates the quality and helpfulness of API error messages including
    clarity, actionability, localization support, and separation of
    developer-facing vs user-facing messages. Examines whether messages
    help consumers understand and resolve issues.

  why_it_matters: |
    Good error messages reduce support burden, speed up integration, and
    improve developer experience. Unclear messages waste time debugging,
    cause frustration, and may lead to incorrect error handling. Quality
    messages turn errors into learning opportunities.

  when_to_run:
    - "During developer experience reviews"
    - "Before API releases"
    - "When support tickets involve error confusion"

prerequisites:
  required_artifacts:
    - type: "api-source"
      description: "Error messages and exception handling"

  access_requirements:
    - "Read access to API source code"
    - "Access to error message resources"

discovery:
  code_patterns:
    - pattern: "throw.*new.*Exception\\(\"[^\"]+\""
      type: "regex"
      scope: "source"
      purpose: "Exception messages"
    - pattern: "error.*message|errorMessage|err_msg"
      type: "regex"
      scope: "source"
      purpose: "Error message fields"
    - pattern: "messages\\.properties|i18n|localization"
      type: "regex"
      scope: "config"
      purpose: "Localization resources"

  file_patterns:
    - glob: "**/messages*.properties"
      purpose: "Message resource files"
    - glob: "**/errors/**/*.{java,ts,py}"
      purpose: "Error definitions"
    - glob: "**/i18n/**/*.{json,yaml}"
      purpose: "Internationalization files"

knowledge_sources:
  specifications:
    - id: "owasp-api-security"
      name: "OWASP API Security Top 10"
      url: "https://owasp.org/API-Security/"
      offline_cache: true
      priority: "recommended"

  guides:
    - id: "error-message-design"
      name: "Writing Helpful Error Messages"
      url: "https://ux.stackexchange.com/questions/26985/how-should-error-messages-be-worded"
      offline_cache: true

  learning_resources:
    - id: "microcopy-guide"
      title: "Microcopy: The Complete Guide"
      type: "book"
      reference: "ISBN: 978-9657617465"

tooling:
  assessment_tools:
    - tool: "manual-review"
      purpose: "Human evaluation of message quality"

signals:
  critical:
    - id: "MSGQUAL-CRIT-001"
      signal: "Error messages expose sensitive information"
      evidence_pattern: "password|secret|key|token|ssn|credit"
      explanation: |
        Error messages containing sensitive data (passwords, keys, PII)
        create security vulnerabilities and compliance issues.
      remediation: "Sanitize all error messages; never include sensitive data"

    - id: "MSGQUAL-CRIT-002"
      signal: "Generic errors without actionable guidance"
      evidence_pattern: "Something went wrong|Error occurred|Internal error"
      explanation: |
        Generic messages provide no information to diagnose or resolve issues.
        Consumers cannot take action without understanding what failed.
      remediation: "Provide specific, actionable error descriptions"

  high:
    - id: "MSGQUAL-HIGH-001"
      signal: "Technical jargon in user-facing messages"
      evidence_pattern: "NullPointerException|SQLException|ECONNREFUSED"
      explanation: |
        Technical error names and codes confuse non-technical users and
        may expose implementation details.
      remediation: "Translate technical errors to user-friendly messages"

    - id: "MSGQUAL-HIGH-002"
      signal: "No separation of user vs developer messages"
      evidence_indicators:
        - "Same message shown to users and logged"
        - "No distinction between user_message and details"
      explanation: |
        Developers need technical details; users need friendly guidance.
        Mixing both serves neither audience well.
      remediation: "Provide separate user_message and developer details"

  medium:
    - id: "MSGQUAL-MED-001"
      signal: "Error messages not localized"
      evidence_indicators:
        - "Hardcoded English error strings"
        - "No message resource files"
      remediation: "Externalize messages for localization support"

    - id: "MSGQUAL-MED-002"
      signal: "No suggested actions in error messages"
      evidence_pattern: "error.*(?!try|please|should|must)"
      remediation: "Include suggested corrective actions in messages"

  low:
    - id: "MSGQUAL-LOW-001"
      signal: "Inconsistent message tone/style"
      remediation: "Create style guide for error messages"

  positive:
    - id: "MSGQUAL-POS-001"
      signal: "Error messages include suggested actions"
    - id: "MSGQUAL-POS-002"
      signal: "Localization support implemented"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Collect Error Messages"
      description: |
        Gather all error messages from the codebase.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find exception messages"
          command: "grep -rEo 'throw.*Exception\\(\"[^\"]+\"' --include='*.java' --include='*.ts' . | head -30"
        - purpose: "Find error message strings"
          command: "grep -rn 'error.*=.*\"\\|message.*=.*\"' --include='*.java' --include='*.ts' . | grep -i error | head -30"
        - purpose: "Find message resources"
          command: "find . -name '*messages*' -o -name '*errors*' 2>/dev/null | grep -E '\\.(properties|json|yaml)$' | head -10"
      expected_findings:
        - "Error message samples"
        - "Message resource files"

    - id: "2"
      name: "Check for Sensitive Data"
      description: |
        Verify no sensitive information in error messages.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find sensitive terms in messages"
          command: "grep -rn 'error\\|message\\|Exception' --include='*.java' --include='*.ts' . | grep -iE 'password|secret|key|token|ssn|credit' | head -20"
        - purpose: "Check logged errors"
          command: "grep -rn 'log.*error\\|logger.*error' --include='*.java' --include='*.ts' . | grep -iE 'password|secret|key' | head -10"
      expected_findings:
        - "Potential sensitive data exposure"
        - "Logging patterns"

    - id: "3"
      name: "Evaluate Message Quality"
      description: |
        Assess clarity and actionability of messages.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find generic messages"
          command: "grep -rn 'Something went wrong\\|Error occurred\\|Internal error\\|Unknown error' --include='*.java' --include='*.ts' --include='*.properties' ."
        - purpose: "Find technical jargon"
          command: "grep -rn 'NullPointer\\|SQLException\\|ECONNREFUSED\\|ETIMEDOUT' --include='*.java' --include='*.ts' . | grep -i 'message\\|response' | head -20"
        - purpose: "Find actionable messages"
          command: "grep -rn 'Please\\|Try\\|must\\|should\\|Check' --include='*.java' --include='*.ts' . | grep -i error | head -20"
      expected_findings:
        - "Generic vs specific messages"
        - "Actionability level"

    - id: "4"
      name: "Check Localization Support"
      description: |
        Verify messages support internationalization.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find message bundles"
          command: "find . -name '*.properties' -o -name '*i18n*' -o -name '*locale*' 2>/dev/null | head -10"
        - purpose: "Find hardcoded strings"
          command: "grep -rn 'throw.*new.*Exception(\"[A-Z]' --include='*.java' . | head -20"
        - purpose: "Check for message keys"
          command: "grep -rn 'getMessage\\|messageSource\\|i18n' --include='*.java' --include='*.ts' ."
      expected_findings:
        - "Localization implementation"
        - "Hardcoded vs externalized messages"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Message Quality Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Comprehensive message review completed"
    medium: "Sample of messages analyzed"
    low: "Limited message access"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "error-message-design"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires qualitative analysis"
    full:
      included: true
      priority: 2

closeout_checklist:
  - id: "msgqual-001"
    item: "No sensitive data in error messages"
    level: "CRITICAL"
    verification: |
      if grep -rn 'error\|message\|Exception' --include='*.java' --include='*.ts' . 2>/dev/null | grep -qiE 'password|secret|apikey|token.*='; then echo "FAIL"; else echo "PASS"; fi
    expected: "PASS"

  - id: "msgqual-002"
    item: "No generic 'something went wrong' messages"
    level: "BLOCKING"
    verification: |
      if grep -rq 'Something went wrong\|Error occurred\|Unknown error' --include='*.java' --include='*.ts' . 2>/dev/null; then echo "FAIL"; else echo "PASS"; fi
    expected: "PASS"

  - id: "msgqual-003"
    item: "Error messages include suggested actions"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Reviewer confirms messages include actionable guidance"
    expected: "Confirmed by reviewer"

  - id: "msgqual-004"
    item: "Messages externalized for localization"
    level: "WARNING"
    verification: |
      if find . -name '*messages*.properties' -o -name '*i18n*' 2>/dev/null | grep -q .; then echo "PASS"; else echo "FAIL"; fi
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["api-service", "microservice", "backend"]

relationships:
  commonly_combined:
    - "api-integration.error-handling.error-response-format"
    - "api-integration.error-handling.error-documentation"
