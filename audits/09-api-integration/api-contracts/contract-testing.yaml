# ============================================================
# AUDIT: Contract Testing Assessment
# ============================================================
# Evaluates API contract testing implementation and coverage
# ============================================================

audit:
  id: "api-integration.api-contracts.contract-testing"

  name: "Contract Testing Assessment"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "api-integration"
  category_number: 9
  subcategory: "api-contracts"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "testing"

  default_profiles:
    - "full"
    - "production"

  parallelizable: true

description:
  what: |
    Evaluates contract testing practices including consumer-driven contracts
    (Pact, Spring Cloud Contract), provider verification, contract versioning,
    and CI/CD integration. Examines whether contracts are tested before
    deployment and how contract changes are managed.

  why_it_matters: |
    Without contract testing, API changes can break consumers silently.
    Integration failures are discovered late in production, causing incidents.
    Contract testing catches breaking changes early, enables independent
    deployments, and provides confidence in API compatibility.

  when_to_run:
    - "During CI/CD pipeline reviews"
    - "When setting up new service integrations"
    - "Before microservice decomposition"
    - "After API breakage incidents"

prerequisites:
  required_artifacts:
    - type: "test-source"
      description: "Contract test implementations"
    - type: "ci-config"
      description: "CI/CD pipeline configurations"

  access_requirements:
    - "Read access to test code"
    - "Read access to CI/CD configurations"

discovery:
  code_patterns:
    - pattern: "Pact|@PactBroker|PactVerification"
      type: "regex"
      scope: "source"
      purpose: "Pact contract testing"
    - pattern: "SpringCloudContract|ContractVerifier|stubsMode"
      type: "regex"
      scope: "source"
      purpose: "Spring Cloud Contract"
    - pattern: "dredd|apiblueprint|openapi.*test"
      type: "regex"
      scope: "source"
      purpose: "API testing tools"
    - pattern: "contract.*test|consumer.*driven"
      type: "regex"
      scope: "source"
      purpose: "Contract testing patterns"

  file_patterns:
    - glob: "**/contracts/**/*.{json,yaml,groovy}"
      purpose: "Contract definition files"
    - glob: "**/pacts/**/*.json"
      purpose: "Pact contract files"
    - glob: "**/test/**/*Contract*.{java,ts,js}"
      purpose: "Contract test files"

knowledge_sources:
  specifications:
    - id: "openapi-spec"
      name: "OpenAPI Specification"
      url: "https://spec.openapis.org/oas/latest.html"
      offline_cache: true
      priority: "recommended"

  guides:
    - id: "pact-docs"
      name: "Pact Documentation"
      url: "https://docs.pact.io/"
      offline_cache: true
    - id: "spring-cloud-contract"
      name: "Spring Cloud Contract Documentation"
      url: "https://spring.io/projects/spring-cloud-contract"
      offline_cache: true

  learning_resources:
    - id: "contract-testing-book"
      title: "Testing Microservices with Contract Testing"
      type: "article"
      reference: "https://martinfowler.com/articles/consumerDrivenContracts.html"

tooling:
  static_analysis:
    - tool: "pact-broker"
      purpose: "Contract storage and verification"
      offline_capable: false
    - tool: "spectral"
      purpose: "OpenAPI contract validation"
      offline_capable: true

signals:
  critical:
    - id: "CONTRACT-CRIT-001"
      signal: "No contract testing implemented for service integrations"
      evidence_indicators:
        - "No Pact or Spring Cloud Contract dependencies"
        - "No contract test files found"
        - "Integration tests only use mocks"
      explanation: |
        Without contract testing, API compatibility is verified only through
        expensive end-to-end tests or not at all. Breaking changes slip through
        to production causing integration failures.
      remediation: "Implement consumer-driven contract tests using Pact or similar"

    - id: "CONTRACT-CRIT-002"
      signal: "Contract tests not run in CI/CD pipeline"
      evidence_pattern: "contract.*skip|pact.*disable"
      explanation: |
        Contract tests that don't run automatically provide no protection.
        Developers can accidentally break contracts without knowing.
      remediation: "Integrate contract verification into CI/CD as a gate"

  high:
    - id: "CONTRACT-HIGH-001"
      signal: "Provider verification not implemented"
      evidence_indicators:
        - "Consumer contracts exist but no provider tests"
        - "Pact files not verified against provider"
      explanation: |
        Consumer contracts without provider verification are just documentation.
        The provider can change without failing any tests.
      remediation: "Implement provider verification tests that replay consumer contracts"

    - id: "CONTRACT-HIGH-002"
      signal: "Contracts not versioned with source code"
      evidence_indicators:
        - "Contracts stored in separate unversioned location"
        - "No contract files in repository"
      explanation: |
        Contracts that drift from code create false confidence. Changes to
        contracts should be tracked alongside code changes.
      remediation: "Store contracts in repository or use Pact Broker with can-i-deploy"

  medium:
    - id: "CONTRACT-MED-001"
      signal: "Missing consumer identification in contracts"
      evidence_pattern: "consumer.*name|provider.*name"
      remediation: "Tag contracts with consumer identity for traceability"

    - id: "CONTRACT-MED-002"
      signal: "No contract change notification process"
      evidence_indicators:
        - "No webhook or notification on contract changes"
        - "Provider unaware of new consumer expectations"
      remediation: "Set up notifications when contracts change"

  low:
    - id: "CONTRACT-LOW-001"
      signal: "Contract test coverage not measured"
      remediation: "Track and report contract test coverage metrics"

  positive:
    - id: "CONTRACT-POS-001"
      signal: "Consumer-driven contracts with provider verification"
    - id: "CONTRACT-POS-002"
      signal: "Pact Broker or similar for contract management"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify Contract Testing Tools"
      description: |
        Determine what contract testing frameworks are in use.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find Pact dependencies"
          command: "grep -rn 'pact\\|au.com.dius.pact' --include='pom.xml' --include='build.gradle' --include='package.json' ."
        - purpose: "Find Spring Cloud Contract"
          command: "grep -rn 'spring-cloud-contract\\|ContractVerifier' --include='pom.xml' --include='build.gradle' --include='*.java' ."
        - purpose: "Find other contract tools"
          command: "grep -rn 'dredd\\|prism\\|stoplight' --include='package.json' --include='*.yaml' ."
      expected_findings:
        - "Contract testing tools in use"
        - "Library versions"

    - id: "2"
      name: "Locate Contract Definitions"
      description: |
        Find contract files and their organization.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find Pact files"
          command: "find . -path '*pact*' -name '*.json' 2>/dev/null | head -20"
        - purpose: "Find contract directories"
          command: "find . -type d -name 'contracts' -o -name 'pacts' 2>/dev/null | head -10"
        - purpose: "Find contract test files"
          command: "find . -name '*Contract*Test*' -o -name '*Pact*' 2>/dev/null | grep -E '\\.(java|ts|js)$' | head -20"
      expected_findings:
        - "Contract file locations"
        - "Contract organization"

    - id: "3"
      name: "Check CI/CD Integration"
      description: |
        Verify contract tests run in the pipeline.
      duration_estimate: "20 min"
      commands:
        - purpose: "Check CI config for contract tests"
          command: "grep -rn 'pact\\|contract' --include='*.yml' --include='*.yaml' .github/ .gitlab-ci.yml Jenkinsfile 2>/dev/null"
        - purpose: "Check for can-i-deploy"
          command: "grep -rn 'can-i-deploy\\|pact.*verify\\|contract.*verify' --include='*.sh' --include='*.yml' --include='*.yaml' ."
      expected_findings:
        - "CI/CD contract test stages"
        - "Deployment gates"

    - id: "4"
      name: "Evaluate Consumer-Provider Coverage"
      description: |
        Assess which integrations have contract tests.
      duration_estimate: "20 min"
      commands:
        - purpose: "List consumer contracts"
          command: "grep -rn 'consumer.*=\\|consumerName\\|@Pact.*consumer' --include='*.java' --include='*.ts' ."
        - purpose: "List provider verifications"
          command: "grep -rn 'provider.*=\\|providerName\\|@Provider\\|@PactBroker' --include='*.java' --include='*.ts' ."
      expected_findings:
        - "Consumer-provider relationships"
        - "Coverage gaps"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Contract Coverage Matrix"
        - "CI/CD Integration Status"
        - "Recommendations"

  confidence_guidance:
    high: "Contract testing setup thoroughly analyzed"
    medium: "Partial contract test coverage found"
    low: "Limited contract testing evidence"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "pact-docs"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed test analysis"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "contract-001"
    item: "Contract testing framework is configured"
    level: "CRITICAL"
    verification: |
      if grep -rq 'pact\|spring-cloud-contract\|dredd' --include='pom.xml' --include='build.gradle' --include='package.json' . 2>/dev/null; then echo "PASS"; else echo "FAIL"; fi
    expected: "PASS"

  - id: "contract-002"
    item: "Contract tests run in CI/CD pipeline"
    level: "CRITICAL"
    verification: |
      if grep -rq 'pact\|contract' .github/ .gitlab-ci.yml Jenkinsfile 2>/dev/null; then echo "PASS"; else echo "FAIL"; fi
    expected: "PASS"

  - id: "contract-003"
    item: "Provider verification tests exist"
    level: "BLOCKING"
    verification: |
      if grep -rq '@Provider\|@PactBroker\|providerName' --include='*.java' --include='*.ts' . 2>/dev/null; then echo "PASS"; else echo "FAIL"; fi
    expected: "PASS"

  - id: "contract-004"
    item: "All service integrations have contract coverage"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Reviewer confirms all external integrations have contracts"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["microservice", "api-service", "distributed-system"]

relationships:
  commonly_combined:
    - "api-integration.api-contracts.breaking-change-detection"
    - "api-integration.versioning.versioning-strategy"
