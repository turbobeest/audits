# ============================================================
# AUDIT: Third-Party API Dependency
# ============================================================

audit:
  id: "api-integration.third-party-integration.third-party-api-dependency"
  name: "Third-Party API Dependency Audit"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "api-integration"
  category_number: 9
  subcategory: "third-party-integration"

  tier: "expert"
  estimated_duration: "120 minutes"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "security"
    - "reliability"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates third-party API dependencies including dependency inventory,
    criticality assessment, SLA analysis, security evaluation, and
    vendor lock-in risk. Analyzes whether external API dependencies
    are properly managed and risks are understood.

  why_it_matters: |
    Third-party APIs introduce external dependencies outside your control.
    A third-party outage can bring down your system. Security breaches
    at vendors can expose your data. Price changes or API deprecations
    can force expensive migrations. Understanding these risks is essential.

  when_to_run:
    - "Architecture reviews"
    - "Security assessments"
    - "Vendor evaluation"
    - "Annual risk assessments"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Integration code and configuration"
    - type: "documentation"
      description: "Vendor contracts and SLAs"

  access_requirements:
    - "Read access to integration code"
    - "Access to vendor documentation"

discovery:
  code_patterns:
    - pattern: "api\\.|/api/|https://.*api"
      type: "regex"
      scope: "source"
      purpose: "Detect external API calls"

    - pattern: "stripe|twilio|sendgrid|aws|gcp|azure"
      type: "regex"
      scope: "source"
      purpose: "Detect common third-party services"

    - pattern: "API_KEY|api_key|apiKey|client_id|client_secret"
      type: "regex"
      scope: "config"
      purpose: "Detect API credentials"

  file_patterns:
    - glob: "**/clients/**"
      purpose: "External API clients"
    - glob: "**/integrations/**"
      purpose: "Integration implementations"
    - glob: "**/.env*"
      purpose: "Environment configuration"

knowledge_sources:
  guides:
    - id: "vendor-management"
      name: "Vendor Risk Management"
      url: "https://www.gartner.com/en/information-technology/glossary/vendor-management"
      offline_cache: true

    - id: "api-dependency"
      name: "Managing API Dependencies"
      url: "https://docs.microsoft.com/en-us/azure/architecture/best-practices/api-design"
      offline_cache: true

  learning_resources:
    - id: "third-party-risk"
      title: "Third-Party Risk Management"
      type: "article"
      reference: "NIST Cybersecurity Framework"

tooling:
  static_analysis:
    - tool: "dependency-check"
      purpose: "Identify external dependencies"
      offline_capable: true

  scripts:
    - id: "third-party-scan"
      language: "bash"
      purpose: "Inventory third-party API usage"
      source: "inline"
      code: |
        echo "=== Third-Party API Dependency Analysis ==="
        echo "--- External API hosts ---"
        grep -rn "https://\|http://" \
          --include="*.ts" --include="*.java" --include="*.py" --include="*.yaml" . 2>/dev/null | \
          grep -v "localhost\|127.0.0.1" | grep -v node_modules | head -40

        echo "--- API credentials ---"
        grep -rn "API_KEY\|api_key\|apiKey\|client_id\|SECRET" \
          --include="*.ts" --include="*.java" --include="*.py" --include="*.env*" . 2>/dev/null | \
          grep -v node_modules | head -20

        echo "--- Third-party SDKs ---"
        grep -rn "stripe\|twilio\|sendgrid\|slack\|github" \
          --include="package.json" --include="pom.xml" --include="requirements.txt" . 2>/dev/null | \
          head -20

signals:
  critical:
    - id: "TPD-CRIT-001"
      signal: "Critical path depends on single vendor"
      evidence_pattern: "Core functionality requires specific third-party API"
      explanation: |
        When critical business functions depend on a single external API,
        vendor outages become your outages. There's no fallback when
        the vendor is down, and you're at their mercy for pricing
        and feature changes.
      remediation: "Implement abstraction layer; consider multi-vendor strategy"

    - id: "TPD-CRIT-002"
      signal: "Third-party API credentials exposed"
      evidence_pattern: "API keys in source code or unencrypted config"
      explanation: |
        Exposed credentials allow unauthorized access to third-party
        services, potentially incurring costs, accessing data, or
        performing actions under your account.
      remediation: "Use secret management; never commit credentials to code"

  high:
    - id: "TPD-HIGH-001"
      signal: "No SLA documentation for critical vendors"
      evidence_pattern: "Third-party SLA terms not documented or reviewed"
      explanation: |
        Without understanding vendor SLAs, you cannot set appropriate
        expectations for your own SLAs. You may promise availability
        that depends on a vendor who doesn't guarantee it.
      remediation: "Document and review SLAs for all critical vendors"

    - id: "TPD-HIGH-002"
      signal: "Vendor not meeting stated SLA"
      evidence_pattern: "Historical uptime below SLA commitment"
      explanation: |
        Vendors who don't meet their SLAs will drag down your
        availability. Understanding actual vs. promised performance
        helps set realistic expectations and contingency plans.
      remediation: "Track vendor uptime; consider alternatives for poor performers"

    - id: "TPD-HIGH-003"
      signal: "No inventory of third-party dependencies"
      evidence_pattern: "No documentation of external API dependencies"
      explanation: |
        Without a dependency inventory, you don't know what's at risk.
        You can't assess impact of vendor changes, plan migrations,
        or evaluate security exposure.
      remediation: "Create and maintain third-party dependency inventory"

  medium:
    - id: "TPD-MED-001"
      signal: "Vendor lock-in with proprietary features"
      evidence_pattern: "Using vendor-specific features without abstraction"
      remediation: "Abstract vendor-specific features; design for portability"

    - id: "TPD-MED-002"
      signal: "No vendor security assessment"
      evidence_pattern: "Third-party security posture not evaluated"
      remediation: "Assess vendor security; review SOC2/ISO certifications"

    - id: "TPD-MED-003"
      signal: "Missing business continuity plan for vendor failure"
      evidence_pattern: "No documented plan if vendor becomes unavailable"
      remediation: "Document contingency plans for critical vendor failure"

  low:
    - id: "TPD-LOW-001"
      signal: "Vendor costs not tracked"
      evidence_pattern: "No monitoring of third-party API costs"
      remediation: "Implement cost tracking and alerting for API usage"

  positive:
    - id: "TPD-POS-001"
      signal: "Third-party dependency inventory maintained"
      evidence_pattern: "Documented list of all external APIs"

    - id: "TPD-POS-002"
      signal: "Abstraction layer for vendor services"
      evidence_pattern: "Interface-based design allowing vendor swap"

    - id: "TPD-POS-003"
      signal: "Vendor SLAs documented and tracked"
      evidence_pattern: "SLA terms and actual performance monitored"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory External APIs"
      description: |
        Identify all third-party API dependencies.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find external API calls"
          command: |
            grep -rn "https://\|http://" \
              --include="*.ts" --include="*.java" --include="*.py" . 2>/dev/null | \
              grep -v "localhost\|127.0.0.1\|example.com" | grep -v node_modules | head -50
        - purpose: "Find third-party SDKs"
          command: |
            grep -rn "stripe\|twilio\|sendgrid\|aws\|gcp\|azure\|slack" \
              --include="package.json" --include="pom.xml" --include="requirements.txt" . 2>/dev/null | \
              head -20

      expected_findings:
        - "Third-party API list"
        - "SDK dependencies"

    - id: "2"
      name: "Assess Criticality"
      description: |
        Determine which dependencies are critical path.
      duration_estimate: "25 min"
      questions:
        - "Which APIs are required for core functionality?"
        - "What fails if this API is unavailable?"
        - "Can the system function without each API?"

      expected_findings:
        - "Critical dependencies"
        - "Impact assessment"

    - id: "3"
      name: "Review SLA Coverage"
      description: |
        Check vendor SLA documentation and tracking.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find SLA documentation"
          command: |
            find . -name "*sla*" -o -name "*vendor*" -o -name "*contract*" 2>/dev/null | \
              grep -v node_modules | head -20

      expected_findings:
        - "SLA documentation"
        - "Tracking mechanisms"

    - id: "4"
      name: "Check Credential Management"
      description: |
        Verify API credentials are securely stored.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find credential references"
          command: |
            grep -rn "API_KEY\|api_key\|SECRET\|password" \
              --include="*.ts" --include="*.java" --include="*.py" . 2>/dev/null | \
              grep -v node_modules | grep -v test | head -30

      expected_findings:
        - "Credential storage"
        - "Security practices"

    - id: "5"
      name: "Evaluate Abstraction"
      description: |
        Check if vendor-specific code is abstracted.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find interface patterns"
          command: |
            grep -rn "interface\|abstract\|Provider\|Adapter" \
              --include="*.ts" --include="*.java" . 2>/dev/null | \
              grep -i "api\|service\|client" | grep -v node_modules | head -30

      expected_findings:
        - "Abstraction patterns"
        - "Lock-in risk"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      content:
        - "dependency_inventory"
        - "criticality_assessment"
        - "security_status"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Dependency Inventory"
        - "Risk Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Clear critical dependency or exposed credentials"
    medium: "Dependency exists but risk level uncertain"
    low: "Requires vendor analysis to assess fully"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "vendor-management"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed analysis"
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1

closeout_checklist:
  - id: "tpd-001"
    item: "Third-party dependency inventory exists"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify documentation of all external API dependencies"
    expected: "Confirmed by reviewer"

  - id: "tpd-002"
    item: "API credentials secured"
    level: "CRITICAL"
    verification: |
      grep -rn "API_KEY=\|api_key=\|SECRET=" \
        --include="*.ts" --include="*.java" --include="*.py" . 2>/dev/null | \
        grep -v node_modules | grep -v ".env.example" | \
        wc -l | xargs -I {} test {} -lt 3 && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "tpd-003"
    item: "Vendor abstraction implemented"
    level: "WARNING"
    verification: |
      grep -rn "interface\|Provider\|Adapter" \
        --include="*.ts" --include="*.java" . 2>/dev/null | \
        grep -i "api\|service" | grep -v node_modules | \
        wc -l | xargs -I {} test {} -gt 0 && echo "PASS" || echo "FAIL"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["Vendor Management"]
    - framework: "ISO 27001"
      controls: ["A.15 Supplier Relationships"]

relationships:
  commonly_combined:
    - "api-integration.third-party-integration.fallback-strategy"
    - "api-integration.third-party-integration.rate-limit-handling"
    - "security-trust.secret-management.credential-storage"
