# ============================================================
# AUDIT: Shader Performance
# Category: 43 - Metaverse & Immersive
# Subcategory: rendering-performance
# ============================================================

audit:
  id: "metaverse-immersive.rendering-performance.shader-performance"
  name: "Shader Performance Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "metaverse-immersive"
  category_number: 43
  subcategory: "rendering-performance"

  tier: "expert"
  estimated_duration: "3-5 hours"  # median: 4h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "xr-systems"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates shader performance impact in XR rendering. Assesses shader
    complexity, instruction count, texture sampling, branching, and
    mobile compatibility. Identifies expensive shaders that impact frame rate.

  why_it_matters: |
    Shaders execute for every pixel and can dominate GPU time. Complex
    shaders with many instructions, texture samples, or dynamic branching
    can easily exceed frame budgets, especially on mobile VR hardware.
    Shader optimization is critical for XR performance.

  when_to_run:
    - "During GPU optimization"
    - "When GPU bound"
    - "After adding new shaders"
    - "When porting to mobile"

prerequisites:
  required_artifacts:
    - type: "shader_files"
      description: "Shader source code"
    - type: "gpu_profiler"
      description: "GPU profiling tools"

  access_requirements:
    - "Access to shader code"
    - "GPU profiler access"

discovery:
  file_patterns:
    - glob: "**/*.shader"
      purpose: "Find Unity shaders"
    - glob: "**/*.hlsl"
      purpose: "Find HLSL shaders"
    - glob: "**/*.glsl"
      purpose: "Find GLSL shaders"

  code_patterns:
    - pattern: "tex2D|texture|sample"
      type: "keyword"
      scope: "source"
      purpose: "Find texture samples"
    - pattern: "if|branch|clip|discard"
      type: "keyword"
      scope: "source"
      purpose: "Find branching"

knowledge_sources:
  guides:
    - id: "mobile-shaders"
      name: "Mobile Shader Best Practices"
      url: "https://developer.oculus.com/documentation/unity/unity-shaders/"
      offline_cache: true

    - id: "shader-optimization"
      name: "GPU Shader Optimization"
      url: "https://docs.unity3d.com/Manual/SL-ShaderPerformance.html"
      offline_cache: true

tooling:
  analysis_tools:
    - tool: "shader-analyzer"
      purpose: "Shader complexity analysis"

    - tool: "gpu-profiler"
      purpose: "Shader execution time"

    - tool: "mali-offline-compiler"
      purpose: "Mobile shader analysis"

signals:
  critical:
    - id: "SP-CRIT-001"
      signal: "Shader causes frame rate drop"
      evidence_indicators:
        - "Single shader using > 50% GPU time"
        - "Frame time spikes when shader visible"
      explanation: |
        A single expensive shader can consume the entire frame budget,
        making stable frame rate impossible.
      remediation: "Optimize or replace expensive shader"

    - id: "SP-CRIT-002"
      signal: "Using desktop shaders on mobile"
      evidence_indicators:
        - "Standard shader on mobile VR"
        - "Desktop-only features enabled"
      explanation: |
        Desktop shaders are far too expensive for mobile VR.
        Mobile-specific shaders are required.
      remediation: "Use mobile-optimized shaders"

  high:
    - id: "SP-HIGH-001"
      signal: "Excessive texture samples"
      evidence_threshold: "> 8 texture samples per shader"
      remediation: "Reduce texture samples or combine textures"

    - id: "SP-HIGH-002"
      signal: "Complex dynamic branching"
      evidence_indicators:
        - "Multiple if statements in fragment shader"
        - "Data-dependent branching"
      remediation: "Reduce branching or use shader variants"

  medium:
    - id: "SP-MED-001"
      signal: "Alpha testing/discard used"
      remediation: "Minimize alpha test usage"

    - id: "SP-MED-002"
      signal: "No shader LOD"
      remediation: "Implement shader complexity LOD"

  low:
    - id: "SP-LOW-001"
      signal: "Shader performance not profiled"
      remediation: "Profile shader costs"

  positive:
    - id: "SP-POS-001"
      signal: "Mobile-optimized shaders"
    - id: "SP-POS-002"
      signal: "Low instruction count"
    - id: "SP-POS-003"
      signal: "Minimal branching"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Shaders"
      description: "List all shaders in use"
      duration_estimate: "30 min"

    - id: "2"
      name: "Profile GPU Time"
      description: "Measure shader execution time"
      duration_estimate: "1 hour"

    - id: "3"
      name: "Analyze Complexity"
      description: "Check instruction counts and samples"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Identify Expensive Shaders"
      description: "Find performance hotspots"
      duration_estimate: "45 min"

    - id: "5"
      name: "Test Optimizations"
      description: "Try shader simplifications"
      duration_estimate: "45 min"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "shader_report"
      format: "json"
      description: "Shader performance analysis"

closeout_checklist:
  - id: "sp-001"
    item: "No single shader dominates GPU"
    level: "CRITICAL"
    verification: "automated"

  - id: "sp-002"
    item: "Mobile-appropriate shaders"
    level: "CRITICAL"
    verification: "manual"

  - id: "sp-003"
    item: "Shader complexity documented"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["xr-applications", "mobile-vr"]

relationships:
  commonly_combined:
    - "metaverse-immersive.rendering-performance.frame-rate-stability"
    - "metaverse-immersive.3d-asset-quality.material-quality"
