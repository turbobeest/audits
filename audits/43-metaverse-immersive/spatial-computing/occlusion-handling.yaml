# ============================================================
# AUDIT: Occlusion Handling
# Category: 43 - Metaverse & Immersive
# Subcategory: spatial-computing
# ============================================================

audit:
  id: "metaverse-immersive.spatial-computing.occlusion-handling"
  name: "Occlusion Handling Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "metaverse-immersive"
  category_number: 43
  subcategory: "spatial-computing"

  tier: "expert"
  estimated_duration: "3-4 hours"  # median: 3h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "xr-systems"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the implementation of occlusion in mixed reality applications
    where virtual content should be hidden by real-world objects. Assesses
    occlusion accuracy, edge quality, performance, and handling of dynamic
    occluders.

  why_it_matters: |
    Proper occlusion is essential for convincing mixed reality. When virtual
    objects appear in front of real objects they should be behind, it breaks
    the illusion completely. Occlusion is one of the most important depth
    cues for spatial perception.

  when_to_run:
    - "When implementing MR applications"
    - "When virtual objects appear wrong"
    - "During visual quality review"
    - "After depth sensing changes"

prerequisites:
  required_artifacts:
    - type: "occlusion_implementation"
      description: "Occlusion system code"
    - type: "depth_data"
      description: "Depth sensing configuration"

  access_requirements:
    - "Access to MR device"
    - "Depth API access"
    - "Test environment"

discovery:
  file_patterns:
    - glob: "**/occlusion/**/*.cs"
      purpose: "Find occlusion code"
    - glob: "**/depth/**/*.cs"
      purpose: "Find depth code"

  code_patterns:
    - pattern: "OcclusionManager|DepthTexture|OcclusionMesh"
      type: "keyword"
      scope: "source"
      purpose: "Find occlusion systems"

knowledge_sources:
  guides:
    - id: "arkit-occlusion"
      name: "ARKit People Occlusion"
      url: "https://developer.apple.com/documentation/arkit/camera_lighting_and_effects/occluding_virtual_content_with_people"
      offline_cache: true

    - id: "arcore-depth"
      name: "ARCore Depth API"
      url: "https://developers.google.com/ar/develop/depth"
      offline_cache: true

tooling:
  analysis_tools:
    - tool: "depth-visualizer"
      purpose: "Depth data visualization"

    - tool: "occlusion-debugger"
      purpose: "Occlusion quality analysis"

signals:
  critical:
    - id: "OH-CRIT-001"
      signal: "No occlusion implemented"
      evidence_indicators:
        - "Virtual objects always render in front"
        - "No depth testing against real world"
      explanation: |
        Without occlusion, virtual objects always appear on top of
        everything, completely breaking spatial coherence.
      remediation: "Implement occlusion using depth data or spatial mesh"

    - id: "OH-CRIT-002"
      signal: "Occlusion significantly incorrect"
      evidence_indicators:
        - "Objects visible when they should be hidden"
        - "Objects hidden when they should be visible"
        - "Occlusion flickers randomly"
      explanation: |
        Incorrect occlusion is worse than no occlusion as it creates
        confusing and inconsistent visual results.
      remediation: "Fix depth testing and occlusion logic"

  high:
    - id: "OH-HIGH-001"
      signal: "Occlusion edge quality poor"
      evidence_indicators:
        - "Jagged edges around occluded objects"
        - "Halo effects around occluders"
      remediation: "Improve edge handling with soft edges or higher resolution"

    - id: "OH-HIGH-002"
      signal: "Occlusion latency noticeable"
      evidence_threshold: "occlusion_latency > 50ms"
      remediation: "Reduce occlusion processing latency"

  medium:
    - id: "OH-MED-001"
      signal: "Dynamic occluders not handled"
      remediation: "Add support for moving occluders"

    - id: "OH-MED-002"
      signal: "Occlusion performance impact high"
      remediation: "Optimize occlusion processing"

  low:
    - id: "OH-LOW-001"
      signal: "Occlusion debugging tools missing"
      remediation: "Add occlusion visualization"

  positive:
    - id: "OH-POS-001"
      signal: "Accurate occlusion implemented"
    - id: "OH-POS-002"
      signal: "Clean occlusion edges"
    - id: "OH-POS-003"
      signal: "Real-time dynamic occlusion"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Test Static Occlusion"
      description: "Verify occlusion against stationary objects"
      duration_estimate: "45 min"

    - id: "2"
      name: "Test Dynamic Occlusion"
      description: "Test with moving occluders"
      duration_estimate: "45 min"

    - id: "3"
      name: "Evaluate Edge Quality"
      description: "Check occlusion boundaries"
      duration_estimate: "30 min"

    - id: "4"
      name: "Measure Latency"
      description: "Check occlusion timing"
      duration_estimate: "30 min"

    - id: "5"
      name: "Assess Performance"
      description: "Measure processing overhead"
      duration_estimate: "30 min"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "occlusion_report"
      format: "json"
      description: "Occlusion quality analysis"

closeout_checklist:
  - id: "oh-001"
    item: "Occlusion implemented"
    level: "CRITICAL"
    verification: "manual"

  - id: "oh-002"
    item: "Occlusion accuracy acceptable"
    level: "BLOCKING"
    verification: "manual"

  - id: "oh-003"
    item: "Performance impact acceptable"
    level: "WARNING"
    verification: "automated"

governance:
  applicable_to:
    archetypes: ["ar-applications", "mixed-reality"]

relationships:
  commonly_combined:
    - "metaverse-immersive.spatial-computing.world-mesh-quality"
    - "metaverse-immersive.rendering-performance.frame-rate-stability"
