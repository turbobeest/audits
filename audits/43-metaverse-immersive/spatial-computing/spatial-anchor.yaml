# ============================================================
# AUDIT: Spatial Anchor
# Category: 43 - Metaverse & Immersive
# Subcategory: spatial-computing
# ============================================================

audit:
  id: "metaverse-immersive.spatial-computing.spatial-anchor"
  name: "Spatial Anchor Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "metaverse-immersive"
  category_number: 43
  subcategory: "spatial-computing"

  tier: "expert"
  estimated_duration: "3-5 hours"  # median: 4h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  requires_physical_access: true
  severity: "high"
  scope: "xr-systems"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the implementation and reliability of spatial anchors for
    persistent AR content placement. Assesses anchor creation, persistence,
    sharing, relocation accuracy, and handling of anchor loss or drift.

  why_it_matters: |
    Spatial anchors enable persistent AR experiences where virtual content
    stays in place across sessions. Poor anchor implementation causes
    content to drift, jump, or disappear, breaking the illusion of
    permanence essential for many AR applications.

  when_to_run:
    - "When implementing persistent AR"
    - "When content drifts or moves"
    - "When testing across sessions"
    - "When sharing anchors between users"

prerequisites:
  required_artifacts:
    - type: "anchor_implementation"
      description: "Spatial anchor code"
    - type: "ar_platform"
      description: "AR platform configuration"

  access_requirements:
    - "Access to AR application code"
    - "AR device for testing"
    - "Multiple test sessions"

discovery:
  file_patterns:
    - glob: "**/anchors/**/*.cs"
      purpose: "Find anchor code"
    - glob: "**/spatial/**/*.cs"
      purpose: "Find spatial code"

  code_patterns:
    - pattern: "SpatialAnchor|WorldAnchor|ARAnchor"
      type: "keyword"
      scope: "source"
      purpose: "Find anchor usage"
    - pattern: "CloudAnchor|AzureSpatialAnchors"
      type: "keyword"
      scope: "source"
      purpose: "Find cloud anchor usage"

knowledge_sources:
  specifications:
    - id: "arcore-anchors"
      name: "ARCore Anchors"
      url: "https://developers.google.com/ar/develop/anchors"
      offline_cache: true
      priority: "required"

    - id: "arkit-anchors"
      name: "ARKit Anchors"
      url: "https://developer.apple.com/documentation/arkit/aranch"
      offline_cache: true

  guides:
    - id: "azure-spatial-anchors"
      name: "Azure Spatial Anchors"
      url: "https://docs.microsoft.com/azure/spatial-anchors/"
      offline_cache: true

tooling:
  analysis_tools:
    - tool: "anchor-debugger"
      purpose: "Anchor quality visualization"

    - tool: "ar-foundation"
      purpose: "Cross-platform AR framework"

signals:
  critical:
    - id: "SA-CRIT-001"
      signal: "Anchors fail to persist across sessions"
      evidence_indicators:
        - "Content in wrong location on return"
        - "Anchors lost after closing app"
        - "Persistence not implemented"
      explanation: |
        Non-persistent anchors defeat the purpose of spatial anchoring.
        Users expect placed content to remain where they put it.
      remediation: "Implement proper anchor persistence"

    - id: "SA-CRIT-002"
      signal: "Anchor drift exceeds 10cm"
      evidence_threshold: "anchor_drift > 10cm"
      explanation: |
        Significant drift makes precise placement impossible.
        Content will not appear where users expect it.
      remediation: "Improve relocation accuracy or use cloud anchors"

  high:
    - id: "SA-HIGH-001"
      signal: "No anchor loss handling"
      evidence_indicators:
        - "No fallback when anchor fails"
        - "Content disappears on anchor loss"
        - "App crashes on anchor issues"
      remediation: "Implement graceful anchor loss handling"

    - id: "SA-HIGH-002"
      signal: "Anchor creation slow or unreliable"
      evidence_indicators:
        - "Anchor creation takes > 3 seconds"
        - "Frequent creation failures"
      remediation: "Optimize anchor creation process"

  medium:
    - id: "SA-MED-001"
      signal: "Anchor sharing not implemented"
      remediation: "Add cloud anchor support for multi-user"

    - id: "SA-MED-002"
      signal: "No anchor quality indicators"
      remediation: "Show users when anchor quality is poor"

  low:
    - id: "SA-LOW-001"
      signal: "Anchor debugging tools missing"
      remediation: "Add anchor visualization for development"

  positive:
    - id: "SA-POS-001"
      signal: "Reliable anchor persistence"
    - id: "SA-POS-002"
      signal: "Sub-centimeter relocation accuracy"
    - id: "SA-POS-003"
      signal: "Graceful loss handling"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Test Anchor Creation"
      description: "Verify anchor creation reliability"
      duration_estimate: "45 min"

    - id: "2"
      name: "Test Persistence"
      description: "Check anchors persist across sessions"
      duration_estimate: "1 hour"

    - id: "3"
      name: "Measure Relocation Accuracy"
      description: "Quantify anchor drift"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Test Loss Handling"
      description: "Verify behavior on anchor failure"
      duration_estimate: "45 min"

    - id: "5"
      name: "Test Sharing (if applicable)"
      description: "Check multi-user anchor sharing"
      duration_estimate: "45 min"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "anchor_report"
      format: "json"
      description: "Anchor reliability analysis"

closeout_checklist:
  - id: "sa-001"
    item: "Anchors persist across sessions"
    level: "CRITICAL"
    verification: "manual"

  - id: "sa-002"
    item: "Drift within acceptable limits"
    level: "CRITICAL"
    verification: "automated"

  - id: "sa-003"
    item: "Loss handling implemented"
    level: "BLOCKING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["ar-applications", "mixed-reality"]

relationships:
  commonly_combined:
    - "metaverse-immersive.spatial-computing.spatial-tracking-accuracy"
    - "metaverse-immersive.spatial-computing.world-mesh-quality"
