# ============================================================
# AUDIT: Coordinate System
# Category: 43 - Metaverse & Immersive
# Subcategory: spatial-computing
# ============================================================

audit:
  id: "metaverse-immersive.spatial-computing.coordinate-system"
  name: "Coordinate System Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "metaverse-immersive"
  category_number: 43
  subcategory: "spatial-computing"

  tier: "expert"
  estimated_duration: "2-4 hours"  # median: 3h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "xr-systems"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: true
  parallelizable: true

description:
  what: |
    Evaluates the consistency and correctness of coordinate systems used
    throughout XR applications. Verifies that all components use compatible
    coordinate conventions, handle coordinate space transformations correctly,
    and maintain spatial coherence across reference frames.

  why_it_matters: |
    Coordinate system errors cause objects to appear in wrong positions,
    teleport unexpectedly, or interact incorrectly. These bugs are subtle
    and confusing to debug. Consistent coordinate handling is fundamental
    to spatial computing.

  when_to_run:
    - "During XR development"
    - "When integrating new components"
    - "When objects behave unexpectedly"
    - "During code review"

prerequisites:
  required_artifacts:
    - type: "xr_code"
      description: "XR application code"
    - type: "coordinate_docs"
      description: "Coordinate convention documentation"

  access_requirements:
    - "Access to application code"
    - "XR runtime access"

discovery:
  file_patterns:
    - glob: "**/spatial/**/*.cs"
      purpose: "Find spatial code"
    - glob: "**/transform/**/*.cs"
      purpose: "Find transform code"

  code_patterns:
    - pattern: "Transform|Position|Rotation|Matrix"
      type: "keyword"
      scope: "source"
      purpose: "Find coordinate operations"
    - pattern: "worldToLocal|localToWorld|TransformPoint"
      type: "keyword"
      scope: "source"
      purpose: "Find space conversions"

knowledge_sources:
  specifications:
    - id: "openxr-coords"
      name: "OpenXR Coordinate System"
      url: "https://registry.khronos.org/OpenXR/specs/1.0/html/xrspec.html#coordinate-system"
      offline_cache: true
      priority: "required"

  guides:
    - id: "unity-coords"
      name: "Unity Coordinate Systems"
      url: "https://docs.unity3d.com/Manual/Transforms.html"
      offline_cache: true

tooling:
  analysis_tools:
    - tool: "coordinate-visualizer"
      purpose: "Visualize coordinate spaces"

    - tool: "transform-debugger"
      purpose: "Debug transformations"

signals:
  critical:
    - id: "CS-CRIT-001"
      signal: "Mixed coordinate system conventions"
      evidence_indicators:
        - "Left-handed and right-handed systems mixed"
        - "Y-up and Z-up conventions mixed without conversion"
        - "Objects appear mirrored or rotated incorrectly"
      explanation: |
        Mixing coordinate conventions causes spatial errors that
        are difficult to diagnose and fix systematically.
      remediation: |
        Standardize on single coordinate convention.
        Add explicit conversions at boundaries.
        Document coordinate convention clearly.

    - id: "CS-CRIT-002"
      signal: "Incorrect reference frame usage"
      evidence_indicators:
        - "World positions used as local"
        - "Reference frame not specified"
        - "Objects jump to wrong positions"
      explanation: |
        Using wrong reference frame causes objects to appear in
        completely wrong locations, breaking the experience.
      remediation: "Audit all coordinate operations for correct reference frame"

  high:
    - id: "CS-HIGH-001"
      signal: "Transformation order errors"
      evidence_indicators:
        - "Scale/rotate/translate in wrong order"
        - "Parent-child transforms incorrect"
      remediation: "Verify transformation order throughout codebase"

    - id: "CS-HIGH-002"
      signal: "Precision loss in transformations"
      evidence_indicators:
        - "Objects drift far from origin"
        - "Floating point issues at large coordinates"
      remediation: "Implement floating origin or high-precision transforms"

  medium:
    - id: "CS-MED-001"
      signal: "Inconsistent unit usage"
      remediation: "Standardize on meters throughout"

    - id: "CS-MED-002"
      signal: "Coordinate convention undocumented"
      remediation: "Document coordinate conventions"

  low:
    - id: "CS-LOW-001"
      signal: "Coordinate debugging tools missing"
      remediation: "Add coordinate visualization tools"

  positive:
    - id: "CS-POS-001"
      signal: "Consistent coordinate convention"
    - id: "CS-POS-002"
      signal: "Well-documented coordinate system"
    - id: "CS-POS-003"
      signal: "Robust transformation handling"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Document Current Convention"
      description: "Identify coordinate conventions used"
      duration_estimate: "30 min"

    - id: "2"
      name: "Audit Transformation Code"
      description: "Review coordinate operations"
      duration_estimate: "1 hour"

    - id: "3"
      name: "Check Reference Frames"
      description: "Verify reference frame usage"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Test Boundary Cases"
      description: "Test extreme coordinates"
      duration_estimate: "45 min"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "coordinate_analysis"
      format: "json"
      description: "Coordinate system analysis"

closeout_checklist:
  - id: "cs-001"
    item: "Consistent coordinate convention"
    level: "CRITICAL"
    verification: "manual"

  - id: "cs-002"
    item: "Reference frames correct"
    level: "CRITICAL"
    verification: "automated"

  - id: "cs-003"
    item: "Convention documented"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["xr-applications"]

relationships:
  commonly_combined:
    - "metaverse-immersive.spatial-computing.scale-consistency"
    - "metaverse-immersive.spatial-computing.spatial-anchor"
