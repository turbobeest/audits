audit:
  id: internationalization-localization.locale-detection.user-locale-detection
  name: User Locale Detection Audit
  version: 1.0.0
  last_updated: '2025-01-22'
  status: active
  category: internationalization-localization
  category_number: 36
  subcategory: locale-detection
  tier: expert
  estimated_duration: 2-3 hours  # median: 2h
  completeness: requires_discovery
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: high
  scope: localization
  default_profiles:
  - full
  - quick
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Evaluates how the application detects user locale preferences including
    browser language settings, Accept-Language headers, IP geolocation, user
    profile preferences, and URL-based locale. Examines detection accuracy,
    fallback strategies, and user override capabilities.
  why_it_matters: |
    Proper locale detection is the foundation of localization. Detecting the
    wrong locale forces users to see content in an unfamiliar language or
    format, creating poor first impressions and increasing bounce rates.
  when_to_run:
  - Before international launches
  - When implementing locale system
  - After reports of wrong locale selection
  - During user experience audits
prerequisites:
  required_artifacts:
  - type: source_code
    description: Application source code
  - type: i18n_config
    description: Locale configuration
  - type: running_application
    description: Access to test detection
  access_requirements:
  - Read access to source code
  - Access to running application
  - Ability to modify browser language settings
discovery:
  file_patterns:
  - glob: '**/locale*.{js,ts}'
    purpose: Find locale configuration
  - glob: '**/i18n*.{js,ts}'
    purpose: Find i18n implementation
  - glob: '**/detect*.{js,ts}'
    purpose: Find detection logic
knowledge_sources:
  guides:
  - id: mdn-navigator-language
    name: MDN Navigator.language
    url: https://developer.mozilla.org/en-US/docs/Web/API/Navigator/language
  - id: accept-language
    name: Accept-Language Header
    url: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept-Language
  standards:
  - id: bcp-47
    name: BCP 47 Language Tags
    relevance: Language tag standard
  - id: rfc-7231
    name: RFC 7231
    relevance: Accept-Language specification
tooling:
  analysis_tools:
  - tool: i18next-browser-languagedetector
    purpose: i18next detection plugin
    install: npm install i18next-browser-languagedetector
  - tool: navigator
    purpose: Browser navigator API
  - tool: accept-language-parser
    purpose: Parse Accept-Language header
    install: npm install accept-language-parser
signals:
  critical:
  - id: I18N-DET-CRIT-001
    signal: No locale detection implemented
    evidence_indicators:
    - Hardcoded default locale
    - All users see English
    explanation: |
      Without locale detection, all users receive the same locale,
      providing a poor experience for international users.
    remediation: Implement proper locale detection
  - id: I18N-DET-CRIT-002
    signal: Detection ignores user browser preferences
    evidence_indicators:
    - navigator.language not checked
    - Accept-Language header ignored
    explanation: |
      Users explicitly set browser language preferences; ignoring
      them disregards user intent.
    remediation: Check browser language preferences first
  high:
  - id: I18N-DET-HIGH-001
    signal: No fallback for unsupported locales
    evidence_indicators:
    - Errors when locale not supported
    - Blank content for uncommon locales
    remediation: Implement proper fallback chain
  - id: I18N-DET-HIGH-002
    signal: Locale detection happens too late
    evidence_indicators:
    - Flash of wrong language content
    - Page loads then switches locale
    remediation: Detect locale before first render
  medium:
  - id: I18N-DET-MED-001
    signal: Region-specific variants not respected
    evidence_indicators:
    - en-GB users getting en-US content
    - No regional variant matching
    remediation: Support regional locale variants
  - id: I18N-DET-MED-002
    signal: User preference not remembered
    evidence_indicators:
    - User changes locale, reverts on reload
    - No persistence of locale choice
    remediation: Persist user locale preference
  low:
  - id: I18N-DET-LOW-001
    signal: IP geolocation not used as hint
    remediation: Consider geo-IP as secondary signal
  - id: I18N-DET-LOW-002
    signal: Detection order not optimized
    remediation: Order detection sources by reliability
  positive:
  - id: I18N-DET-POS-001
    signal: Multi-source locale detection with priority
  - id: I18N-DET-POS-002
    signal: User locale preference persisted
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Review Detection Logic
    description: Analyze locale detection implementation
    duration_estimate: 30 min
  - id: '2'
    name: Test Browser Language
    description: Test detection with different browser settings
    duration_estimate: 30 min
  - id: '3'
    name: Test Accept-Language
    description: Verify server-side header handling
    duration_estimate: 20 min
  - id: '4'
    name: Test Fallback Behavior
    description: Verify fallback for unsupported locales
    duration_estimate: 20 min
  - id: '5'
    name: Test Persistence
    description: Verify locale preference is remembered
    duration_estimate: 20 min
  - id: '6'
    name: Document Findings
    description: Compile locale detection audit report
    duration_estimate: 20 min
output:
  deliverables:
  - type: detection_flow
    format: visual
    description: Locale detection flow diagram
  - type: test_results
    format: tabular
    description: Detection test scenarios and results
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Detection Methods
    - Fallback Strategy
    - Test Results
    - Recommendations
closeout_checklist:
- id: i18n-det-001
  item: Browser language preferences checked
  level: ERROR
  verification: manual
- id: i18n-det-002
  item: Fallback strategy implemented
  level: WARNING
  verification: manual
- id: i18n-det-003
  item: User preference persisted
  level: WARNING
  verification: manual
governance:
  applicable_to:
    archetypes:
    - global-applications
    - multi-language-sites
    company_sizes:
    - startup
    - scaleup
    - enterprise
  compliance_mappings:
  - framework: UX-Standards
    control: Locale Experience
    description: Appropriate locale selection
relationships:
  commonly_combined:
  - internationalization-localization.locale-detection.locale-fallbacks
  - internationalization-localization.locale-detection.user-preferences
  depends_on:
  - frontend-architecture.initialization
  feeds_into:
  - internationalization-localization.translation-management.translation-completeness
