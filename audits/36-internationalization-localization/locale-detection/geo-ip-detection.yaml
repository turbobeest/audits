audit:
  id: internationalization-localization.locale-detection.geo-ip-detection
  name: Geo-IP Locale Detection Audit
  version: 1.0.0
  last_updated: '2025-01-22'
  status: active
  category: internationalization-localization
  category_number: 36
  subcategory: locale-detection
  tier: expert
  estimated_duration: 2-3 hours  # median: 2h
  completeness: requires_discovery
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: medium
  scope: localization
  default_profiles:
  - full
  - quick
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Evaluates the use of IP-based geolocation for locale detection and
    content personalization. Examines accuracy, fallback handling, privacy
    implications, VPN/proxy handling, and user override capabilities when
    geo-IP is used for locale inference.
  why_it_matters: |
    Geo-IP can provide locale hints but is imprecise and can be wrong for
    travelers, VPN users, and expats. Over-reliance on geo-IP without
    override options frustrates users who see wrong language/currency
    based on their physical location rather than preferences.
  when_to_run:
  - When implementing geo-based features
  - During locale detection audit
  - When receiving geo-detection complaints
  - Before regional launches
prerequisites:
  required_artifacts:
  - type: source_code
    description: Application source code
  - type: geo_service_config
    description: Geo-IP service configuration
  - type: running_application
    description: Access to test detection
  access_requirements:
  - Read access to source code
  - Access to geo-IP service
  - VPN for testing different locations
discovery:
  file_patterns:
  - glob: '**/*geo*'
    purpose: Find geo-related code
  - glob: '**/*location*'
    purpose: Find location detection
  - glob: '**/*ip*detect*'
    purpose: Find IP detection
knowledge_sources:
  guides:
  - id: maxmind-geoip
    name: MaxMind GeoIP Documentation
    url: https://dev.maxmind.com/geoip/
  - id: cloudflare-geo
    name: Cloudflare Geolocation
    url: https://developers.cloudflare.com/workers/runtime-apis/request/#incomingrequestcfproperties
  standards:
  - id: gdpr
    name: GDPR
    relevance: Location data privacy
  - id: ccpa
    name: CCPA
    relevance: California privacy requirements
tooling:
  analysis_tools:
  - tool: maxmind
    purpose: Geo-IP database
  - tool: ip-api
    purpose: IP geolocation API
  - tool: cloudflare
    purpose: Edge geolocation headers
signals:
  critical:
  - id: I18N-GEO-CRIT-001
    signal: Geo-IP forced with no override
    evidence_indicators:
    - Locale locked based on IP
    - No way to change detected region
    explanation: |
      Forcing geo-IP locale without override traps users in wrong
      locales, especially travelers and expats.
    remediation: Always allow user to override geo-detected locale
  - id: I18N-GEO-CRIT-002
    signal: Geo-IP blocks access based on region
    evidence_indicators:
    - Content blocked by location
    - No explanation or alternative
    explanation: |
      Blocking content without explanation or options creates
      frustrating user experiences.
    remediation: Provide clear explanation and alternatives
  high:
  - id: I18N-GEO-HIGH-001
    signal: Geo-IP overrides explicit user preference
    evidence_indicators:
    - User selects English, geo-IP changes back
    - IP location trumps preference
    remediation: User preference should override geo-IP
  - id: I18N-GEO-HIGH-002
    signal: Inaccurate geo-IP data causing issues
    evidence_indicators:
    - Wrong country detection frequent
    - Corporate IPs mapped incorrectly
    remediation: Use geo-IP as hint, not authoritative source
  medium:
  - id: I18N-GEO-MED-001
    signal: VPN users get wrong locale
    evidence_indicators:
    - VPN exit location used instead of preference
    - No VPN detection handling
    remediation: Don't assume geo-IP is user's actual location
  - id: I18N-GEO-MED-002
    signal: Geo-IP database outdated
    evidence_indicators:
    - Incorrect country mappings
    - Old IP ranges not updated
    remediation: Update geo-IP database regularly
  low:
  - id: I18N-GEO-LOW-001
    signal: Geo-IP latency impacting performance
    remediation: Cache geo-IP results appropriately
  - id: I18N-GEO-LOW-002
    signal: No logging of geo-detection accuracy
    remediation: Monitor geo-IP accuracy over time
  positive:
  - id: I18N-GEO-POS-001
    signal: Geo-IP as hint with easy override
  - id: I18N-GEO-POS-002
    signal: Clear messaging about detected location
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Review Geo-IP Implementation
    description: Analyze geo-IP detection code
    duration_estimate: 30 min
  - id: '2'
    name: Test Detection Accuracy
    description: Test from different geographic locations
    duration_estimate: 30 min
  - id: '3'
    name: Test Override Capability
    description: Verify users can override detection
    duration_estimate: 20 min
  - id: '4'
    name: Test VPN/Proxy Handling
    description: Test behavior with VPNs
    duration_estimate: 20 min
  - id: '5'
    name: Review Privacy Implications
    description: Assess privacy compliance
    duration_estimate: 20 min
  - id: '6'
    name: Document Findings
    description: Compile geo-IP audit report
    duration_estimate: 20 min
output:
  deliverables:
  - type: geo_ip_assessment
    format: structured
    description: Geo-IP implementation status
  - type: accuracy_testing
    format: tabular
    description: Geo-IP accuracy test results
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Implementation Analysis
    - Accuracy Assessment
    - Privacy Review
    - Recommendations
closeout_checklist:
- id: i18n-geo-001
  item: User can override geo-IP detection
  level: ERROR
  verification: manual
- id: i18n-geo-002
  item: Geo-IP used as hint not authority
  level: WARNING
  verification: manual
- id: i18n-geo-003
  item: Privacy compliance verified
  level: WARNING
  verification: manual
governance:
  applicable_to:
    archetypes:
    - global-applications
    - content-platforms
    - e-commerce
    company_sizes:
    - startup
    - scaleup
    - enterprise
  compliance_mappings:
  - framework: GDPR
    control: Location Data
    description: Processing of location data
  - framework: Privacy
    control: Geolocation
    description: Geolocation data handling
relationships:
  commonly_combined:
  - internationalization-localization.locale-detection.user-locale-detection
  - privacy-compliance.data-processing
  depends_on:
  - infrastructure.geo-services
  feeds_into:
  - internationalization-localization.locale-detection.user-preferences
