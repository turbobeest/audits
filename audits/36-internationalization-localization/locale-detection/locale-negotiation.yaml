audit:
  id: internationalization-localization.locale-detection.locale-negotiation
  name: Locale Negotiation Audit
  version: 1.0.0
  last_updated: '2025-01-22'
  status: active
  category: internationalization-localization
  category_number: 36
  subcategory: locale-detection
  tier: expert
  estimated_duration: 2-3 hours  # median: 2h
  completeness: requires_discovery
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: medium
  scope: localization
  default_profiles:
  - full
  - quick
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Evaluates the locale negotiation process that matches user preferences
    against available locales. Examines algorithm for finding best match
    between Accept-Language header priorities and supported locale list,
    handling of partial matches and quality values.
  why_it_matters: |
    Proper locale negotiation finds the best available match for user
    preferences. A user preferring de-AT, de, en should receive de-AT
    if available, de if not, and en as last resort. Poor negotiation
    might give en to a user who would prefer de.
  when_to_run:
  - When implementing locale system
  - When adding new locales
  - After locale detection issues
  - During i18n architecture review
prerequisites:
  required_artifacts:
  - type: source_code
    description: Application source code
  - type: i18n_config
    description: Locale configuration
  - type: supported_locales
    description: List of supported locales
  access_requirements:
  - Read access to source code
  - Access to running application
  - Ability to modify Accept-Language header
discovery:
  file_patterns:
  - glob: '**/locale*.{js,ts}'
    purpose: Find locale handling code
  - glob: '**/negotiate*'
    purpose: Find negotiation logic
  - glob: '**/match*locale*'
    purpose: Find locale matching
knowledge_sources:
  guides:
  - id: rfc-4647
    name: RFC 4647 Matching of Language Tags
    url: https://www.rfc-editor.org/rfc/rfc4647
  - id: http-content-negotiation
    name: HTTP Content Negotiation
    url: https://developer.mozilla.org/en-US/docs/Web/HTTP/Content_negotiation
  standards:
  - id: bcp-47
    name: BCP 47
    relevance: Language tag matching
  - id: rfc-4647
    name: RFC 4647
    relevance: Lookup and filtering algorithms
tooling:
  analysis_tools:
  - tool: accept-language-parser
    purpose: Parse Accept-Language header
    install: npm install accept-language-parser
  - tool: '@formatjs/intl-localematcher'
    purpose: Locale matching algorithm
    install: npm install @formatjs/intl-localematcher
signals:
  critical:
  - id: I18N-NEG-CRIT-001
    signal: No locale negotiation implemented
    evidence_indicators:
    - First available locale always used
    - Accept-Language priorities ignored
    explanation: |
      Without negotiation, users receive wrong locale even when
      their preferred locale is available.
    remediation: Implement proper locale negotiation algorithm
  high:
  - id: I18N-NEG-HIGH-001
    signal: Quality values (q=) ignored
    evidence_indicators:
    - 'Accept-Language: de;q=0.8, en;q=1.0 gives de'
    - Priority weights not respected
    remediation: Respect quality values in negotiation
  - id: I18N-NEG-HIGH-002
    signal: Partial matches not considered
    evidence_indicators:
    - User wants de-AT, has de, gets en
    - Regional variants don't match base
    remediation: Include partial match fallback in negotiation
  medium:
  - id: I18N-NEG-MED-001
    signal: Case sensitivity issues in matching
    evidence_indicators:
    - '''en-US'' doesn''t match ''en-us'''
    - Case-sensitive comparison
    remediation: Use case-insensitive locale comparison
  - id: I18N-NEG-MED-002
    signal: Negotiation result not cached
    evidence_indicators:
    - Negotiation runs on every request
    - Performance impact from repeated negotiation
    remediation: Cache negotiation results appropriately
  low:
  - id: I18N-NEG-LOW-001
    signal: Verbose negotiation logging missing
    remediation: Add logging for debugging negotiation issues
  - id: I18N-NEG-LOW-002
    signal: Script variants not handled in negotiation
    remediation: Consider script tag matching (zh-Hans vs zh-Hant)
  positive:
  - id: I18N-NEG-POS-001
    signal: RFC 4647 compliant negotiation
  - id: I18N-NEG-POS-002
    signal: Intelligent fallback in matching
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Review Negotiation Code
    description: Analyze negotiation algorithm
    duration_estimate: 30 min
  - id: '2'
    name: Test Priority Handling
    description: Verify quality value handling
    duration_estimate: 30 min
  - id: '3'
    name: Test Partial Matches
    description: Verify regional/base fallback
    duration_estimate: 20 min
  - id: '4'
    name: Test Edge Cases
    description: Test unusual locale combinations
    duration_estimate: 20 min
  - id: '5'
    name: Performance Testing
    description: Assess negotiation performance
    duration_estimate: 15 min
  - id: '6'
    name: Document Findings
    description: Compile negotiation audit report
    duration_estimate: 20 min
output:
  deliverables:
  - type: negotiation_analysis
    format: structured
    description: Negotiation algorithm assessment
  - type: test_matrix
    format: tabular
    description: Accept-Language vs result mapping
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Algorithm Analysis
    - Test Results
    - Performance Assessment
    - Recommendations
closeout_checklist:
- id: i18n-neg-001
  item: Proper locale negotiation implemented
  level: ERROR
  verification: automated
- id: i18n-neg-002
  item: Quality values respected
  level: WARNING
  verification: automated
- id: i18n-neg-003
  item: Partial matches handled correctly
  level: WARNING
  verification: automated
governance:
  applicable_to:
    archetypes:
    - global-applications
    - multi-language-sites
    company_sizes:
    - startup
    - scaleup
    - enterprise
  compliance_mappings:
  - framework: HTTP-Standards
    control: Content Negotiation
    description: HTTP content negotiation compliance
relationships:
  commonly_combined:
  - internationalization-localization.locale-detection.user-locale-detection
  - internationalization-localization.locale-detection.locale-fallbacks
  depends_on:
  - internationalization-localization.locale-detection.user-locale-detection
  feeds_into:
  - internationalization-localization.locale-detection.locale-fallbacks
