audit:
  id: internationalization-localization.number-currency-formatting.decimal-precision
  name: Decimal Precision Handling Audit
  version: 1.0.0
  last_updated: '2025-01-22'
  status: active
  category: internationalization-localization
  category_number: 36
  subcategory: number-currency-formatting
  tier: expert
  estimated_duration: 2-3 hours  # median: 2h
  completeness: requires_discovery
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: high
  scope: localization
  default_profiles:
  - full
  - quick
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Evaluates handling of decimal precision for financial calculations,
    scientific displays, and general numeric handling. Examines rounding
    strategies, precision preservation, floating-point handling, and
    context-appropriate precision levels.
  why_it_matters: |
    Precision errors compound in financial calculations, leading to
    discrepancies. Different contexts require different precision levels:
    currency needs exact cents, scientific data needs consistent significant
    figures, and percentages need appropriate rounding.
  when_to_run:
  - Before financial feature launches
  - When implementing calculation features
  - During e-commerce audits
  - After arithmetic bug reports
prerequisites:
  required_artifacts:
  - type: source_code
    description: Application source code
  - type: calculation_logic
    description: Financial and numeric calculation code
  - type: database_schema
    description: Numeric column definitions
  access_requirements:
  - Read access to source code
  - Access to calculation logic
  - Database schema access
discovery:
  file_patterns:
  - glob: '**/*calculation*'
    purpose: Find calculation logic
  - glob: '**/*price*'
    purpose: Find pricing logic
  - glob: '**/*decimal*'
    purpose: Find decimal handling
knowledge_sources:
  guides:
  - id: floating-point
    name: What Every Programmer Should Know About Floating-Point
    url: https://floating-point-gui.de/
  - id: decimal-js
    name: Decimal.js Documentation
    url: https://mikemcl.github.io/decimal.js/
  standards:
  - id: ieee-754
    name: IEEE 754
    relevance: Floating-point standard
  - id: iso-4217
    name: ISO 4217
    relevance: Currency decimal places
tooling:
  analysis_tools:
  - tool: decimal.js
    purpose: Arbitrary precision decimals
    install: npm install decimal.js
  - tool: bignumber.js
    purpose: Arbitrary precision library
    install: npm install bignumber.js
  - tool: dinero.js
    purpose: Money with safe precision
    install: npm install dinero.js
signals:
  critical:
  - id: I18N-PREC-CRIT-001
    signal: Floating-point used for currency calculations
    evidence_indicators:
    - price * quantity using native floats
    - 0.1 + 0.2 !== 0.3 issues
    explanation: |
      Floating-point arithmetic causes rounding errors that accumulate,
      leading to financial discrepancies and compliance issues.
    remediation: Use integer cents or decimal library for currency
  - id: I18N-PREC-CRIT-002
    signal: Precision loss in financial totals
    evidence_indicators:
    - Order totals don't match line items
    - Rounding errors visible to users
    explanation: |
      Visible precision errors damage trust and may cause disputes
      or regulatory issues.
    remediation: Implement proper decimal arithmetic
  high:
  - id: I18N-PREC-HIGH-001
    signal: Inconsistent rounding strategies
    evidence_indicators:
    - Different rounding in different places
    - Mix of round, floor, ceil
    remediation: Standardize on consistent rounding strategy
  - id: I18N-PREC-HIGH-002
    signal: Database precision doesn't match requirements
    evidence_indicators:
    - FLOAT columns for currency
    - Insufficient DECIMAL scale
    remediation: Use DECIMAL with appropriate precision for currency
  medium:
  - id: I18N-PREC-MED-001
    signal: Display precision inconsistent with calculations
    evidence_indicators:
    - Stored with 4 decimals, displayed with 2
    - Rounding happens at display only
    remediation: Align storage, calculation, and display precision
  - id: I18N-PREC-MED-002
    signal: Percentage calculations losing precision
    evidence_indicators:
    - Tax calculations off by cents
    - Discount rounding issues
    remediation: Apply proper rounding rules for percentages
  low:
  - id: I18N-PREC-LOW-001
    signal: Scientific notation displayed inappropriately
    remediation: Control when scientific notation is used
  - id: I18N-PREC-LOW-002
    signal: Trailing zeros not handled consistently
    remediation: Standardize trailing zero display
  positive:
  - id: I18N-PREC-POS-001
    signal: Decimal library used for all financial calculations
  - id: I18N-PREC-POS-002
    signal: Consistent precision strategy documented
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Identify Financial Calculations
    description: Find all currency/financial calculations
    duration_estimate: 20 min
  - id: '2'
    name: Review Arithmetic Methods
    description: Analyze how calculations are performed
    duration_estimate: 30 min
  - id: '3'
    name: Test Precision Scenarios
    description: Run precision test cases
    duration_estimate: 45 min
  - id: '4'
    name: Check Database Schema
    description: Verify numeric column definitions
    duration_estimate: 20 min
  - id: '5'
    name: Review Rounding Strategy
    description: Document rounding approaches
    duration_estimate: 20 min
  - id: '6'
    name: Document Findings
    description: Compile precision audit report
    duration_estimate: 25 min
output:
  deliverables:
  - type: precision_assessment
    format: structured
    description: Precision handling across calculations
  - type: test_results
    format: tabular
    description: Precision test case results
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Calculation Analysis
    - Database Schema Review
    - Rounding Strategy
    - Recommendations
closeout_checklist:
- id: i18n-prec-001
  item: Currency uses integer cents or decimal library
  level: ERROR
  verification: automated
- id: i18n-prec-002
  item: Database columns have appropriate precision
  level: ERROR
  verification: automated
- id: i18n-prec-003
  item: Consistent rounding strategy documented
  level: WARNING
  verification: manual
governance:
  applicable_to:
    archetypes:
    - financial-applications
    - e-commerce
    - scientific-applications
    company_sizes:
    - startup
    - scaleup
    - enterprise
  compliance_mappings:
  - framework: Financial-Regulations
    control: Calculation Accuracy
    description: Financial calculation requirements
  - framework: Accounting-Standards
    control: Rounding Rules
    description: Proper rounding requirements
relationships:
  commonly_combined:
  - internationalization-localization.number-currency-formatting.currency-display
  - data-integrity.numeric-accuracy
  depends_on:
  - database-management.schema-design
  feeds_into:
  - financial-compliance.calculation-accuracy
