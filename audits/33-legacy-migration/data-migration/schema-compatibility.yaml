# ============================================================
# AUDIT: Schema Compatibility Assessment
# Category: 33 - Legacy & Migration
# Subcategory: data-migration
# ============================================================

audit:
  id: "legacy-migration.data-migration.schema-compatibility"
  name: "Schema Compatibility Assessment Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "legacy-migration"
  category_number: 33
  subcategory: "data-migration"

  tier: "expert"
  estimated_duration: "6-10 hours"  # median: 8h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "data"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Analyzes source and target database schemas to identify compatibility issues,
    required transformations, data type mappings, and potential data loss scenarios.
    This audit compares schemas at the table, column, constraint, and data type
    levels to ensure data can be migrated accurately and completely.

  why_it_matters: |
    Schema incompatibilities cause data migration failures, data corruption, and
    data loss. Understanding differences between source and target schemas before
    migration enables proper transformation planning and prevents surprises during
    the actual migration that could cause extended downtime or data issues.

  when_to_run:
    - "Before data migration planning"
    - "When designing target schema"
    - "After target schema changes"
    - "During migration readiness review"

prerequisites:
  required_artifacts:
    - type: "source_schema"
      description: "Source database schema definition"
    - type: "target_schema"
      description: "Target database schema definition"
    - type: "data_dictionary"
      description: "Data definitions and business rules"

  access_requirements:
    - "Database schema access"
    - "Data dictionary documentation"
    - "Sample data for analysis"
    - "Query execution privileges"

discovery:
  file_patterns:
    - glob: "**/*.sql"
      purpose: "Find schema definition files"
    - glob: "**/migrations/**"
      purpose: "Find database migrations"
    - glob: "**/schema*"
      purpose: "Find schema documentation"

  interview_questions:
    - role: "Database Administrator"
      questions:
        - "What are the major differences between source and target databases?"
        - "Are there any custom data types or extensions?"
        - "What constraints must be preserved?"
    - role: "Data Engineer"
      questions:
        - "Are there any known data quality issues?"
        - "What transformations are needed?"
        - "Are there any deprecated fields?"

knowledge_sources:
  guides:
    - id: "data-migration"
      name: "Database Migration Best Practices"
      url: "https://docs.aws.amazon.com/dms/latest/userguide/Welcome.html"
    - id: "schema-evolution"
      name: "Schema Evolution Patterns"
      url: "https://docs.confluent.io/platform/current/schema-registry/fundamentals/schema-evolution.html"

  standards:
    - id: "iso-8000"
      name: "ISO 8000 Data Quality"
      relevance: "Data quality standards"

tooling:
  analysis_tools:
    - tool: "SchemaCrawler"
      purpose: "Database schema analysis"
      command: "schemacrawler --info-level=maximum --command=schema"
    - tool: "AWS DMS Schema Conversion"
      purpose: "Schema compatibility analysis"
    - tool: "SQLCompare"
      purpose: "Schema comparison for SQL Server"
    - tool: "Liquibase"
      purpose: "Schema diff generation"
      command: "liquibase diff"
    - tool: "pgloader"
      purpose: "PostgreSQL migration with schema mapping"

signals:
  critical:
    - id: "SCA-CRIT-001"
      signal: "Data type incompatibility causes data loss"
      evidence_indicators:
        - "Precision reduction in numeric types"
        - "String truncation required"
        - "Date/time precision loss"
      explanation: |
        Data type conversions that lose precision or truncate data result
        in permanent information loss during migration.
      remediation: "Adjust target schema or implement lossless transformation"

    - id: "SCA-CRIT-002"
      signal: "Required columns cannot be populated"
      evidence_indicators:
        - "New required columns with no source data"
        - "NOT NULL constraints without default values"
        - "Foreign keys to non-existent data"
      explanation: |
        Columns that cannot be populated will cause migration failures
        or constraint violations.
      remediation: "Define defaults, nullable columns, or data generation strategy"

  high:
    - id: "SCA-HIGH-001"
      signal: "Character encoding differences between schemas"
      remediation: "Plan encoding conversion with testing"

    - id: "SCA-HIGH-002"
      signal: "Index strategies incompatible"
      remediation: "Redesign indexes for target platform"

    - id: "SCA-HIGH-003"
      signal: "Constraint definitions differ significantly"
      remediation: "Map constraints and validate preservation"

  medium:
    - id: "SCA-MED-001"
      signal: "Column ordering differences"
      remediation: "Ensure migration handles column mapping"

    - id: "SCA-MED-002"
      signal: "Default value differences"
      remediation: "Document and validate default behavior"

  low:
    - id: "SCA-LOW-001"
      signal: "Naming convention differences"
      remediation: "Create naming mapping document"

    - id: "SCA-LOW-002"
      signal: "Comment and metadata differences"
      remediation: "Plan metadata migration separately"

  positive:
    - id: "SCA-POS-001"
      signal: "Schemas highly compatible with minimal transformation"

    - id: "SCA-POS-002"
      signal: "All transformations are lossless"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Extract Source Schema"
      description: "Document complete source database schema"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Extract Target Schema"
      description: "Document complete target database schema"
      duration_estimate: "1 hour"

    - id: "3"
      name: "Compare Table Structures"
      description: "Identify table and column differences"
      duration_estimate: "2 hours"

    - id: "4"
      name: "Analyze Data Types"
      description: "Map data types and identify conversion issues"
      duration_estimate: "2 hours"

    - id: "5"
      name: "Evaluate Constraints"
      description: "Compare constraints, keys, and relationships"
      duration_estimate: "2 hours"

    - id: "6"
      name: "Document Transformations"
      description: "Create required transformation specifications"
      duration_estimate: "2 hours"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Schema Comparison"
        - "Data Type Mapping"
        - "Constraint Analysis"
        - "Required Transformations"
        - "Risk Assessment"

closeout_checklist:
  - id: "sca-001"
    item: "Both schemas fully documented"
    level: "WARNING"
    verification: "manual"
  - id: "sca-002"
    item: "Data type mappings defined"
    level: "WARNING"
    verification: "manual"
  - id: "sca-003"
    item: "Transformation requirements documented"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["database-migrations", "platform-changes"]

  compliance_mappings:
    - framework: "ISO 8000"
      control: "Data Quality"
      description: "Data accuracy and completeness"
    - framework: "GDPR"
      control: "Article 5"
      description: "Data accuracy principle"

relationships:
  commonly_combined:
    - "legacy-migration.data-migration.data-validation"
    - "legacy-migration.data-migration.transformation-mapping"
  depends_on:
    - "database.schema-documentation"
  feeds_into:
    - "legacy-migration.data-migration.migration-execution"
    - "legacy-migration.migration-planning.rollback-planning"
