# ============================================================
# AUDIT: API Version Coexistence
# Category: 33 - Legacy & Migration
# Subcategory: api-versioning
# ============================================================

audit:
  id: "legacy-migration.api-versioning.version-coexistence"
  name: "API Version Coexistence Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "legacy-migration"
  category_number: 33
  subcategory: "api-versioning"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "api"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the architecture and operations supporting multiple API versions
    running simultaneously. This audit examines routing mechanisms, shared
    resources, version-specific logic, testing strategies, and operational
    complexity when multiple versions must coexist in production.

  why_it_matters: |
    Running multiple API versions simultaneously increases operational complexity
    and cost. Poor coexistence architecture leads to code duplication, inconsistent
    behavior, and increased maintenance burden. Understanding coexistence patterns
    enables efficient multi-version operation.

  when_to_run:
    - "When supporting multiple versions"
    - "During architecture review"
    - "When operational complexity increases"
    - "Before adding new versions"

prerequisites:
  required_artifacts:
    - type: "api_architecture"
      description: "API architecture documentation"
    - type: "deployment_configuration"
      description: "Version deployment setup"
    - type: "routing_configuration"
      description: "Version routing rules"

  access_requirements:
    - "Architecture documentation"
    - "Deployment configuration access"
    - "API gateway configuration"

discovery:
  file_patterns:
    - glob: "**/api/v*/**"
      purpose: "Find versioned API code"
    - glob: "**/routes/**"
      purpose: "Find routing configurations"
    - glob: "**/gateway*"
      purpose: "Find gateway configurations"

  interview_questions:
    - role: "API Developer"
      questions:
        - "How is version routing implemented?"
        - "How much code is shared between versions?"
        - "What is the operational overhead of multiple versions?"
    - role: "DevOps Engineer"
      questions:
        - "How are multiple versions deployed?"
        - "What monitoring exists per version?"
        - "How are version-specific issues diagnosed?"

knowledge_sources:
  guides:
    - id: "api-gateway-patterns"
      name: "API Gateway Patterns"
      url: "https://microservices.io/patterns/apigateway.html"

  standards:
    - id: "api-management"
      name: "API Management Best Practices"
      relevance: "Multi-version management"

tooling:
  analysis_tools:
    - tool: "Kong"
      purpose: "API gateway with version routing"
    - tool: "AWS API Gateway"
      purpose: "Managed API versioning"
    - tool: "Nginx"
      purpose: "Version routing proxy"

signals:
  critical:
    - id: "AVC-CRIT-001"
      signal: "Version-specific bugs affect all versions"
      evidence_indicators:
        - "Shared code without version isolation"
        - "Version fixes break other versions"
        - "No version-specific testing"
      explanation: |
        Poor version isolation means changes intended for one version
        inadvertently affect others, causing widespread issues.
      remediation: "Implement proper version isolation"

    - id: "AVC-CRIT-002"
      signal: "Cannot deploy versions independently"
      evidence_indicators:
        - "Monolithic deployment of all versions"
        - "Version updates require full deployment"
        - "No independent version pipelines"
      explanation: |
        Coupled deployment means version-specific changes require
        deploying all versions, increasing risk and complexity.
      remediation: "Implement independent version deployment"

  high:
    - id: "AVC-HIGH-001"
      signal: "High code duplication between versions"
      remediation: "Implement shared libraries with version adapters"

    - id: "AVC-HIGH-002"
      signal: "Operational complexity unsustainable"
      remediation: "Accelerate deprecation or simplify architecture"

    - id: "AVC-HIGH-003"
      signal: "Inconsistent behavior across versions"
      remediation: "Standardize shared functionality"

  medium:
    - id: "AVC-MED-001"
      signal: "Version routing complexity high"
      remediation: "Simplify routing architecture"

    - id: "AVC-MED-002"
      signal: "Monitoring not version-aware"
      remediation: "Implement version-specific monitoring"

  low:
    - id: "AVC-LOW-001"
      signal: "Minor documentation gaps per version"
      remediation: "Update version-specific documentation"

    - id: "AVC-LOW-002"
      signal: "Testing strategy could be improved"
      remediation: "Enhance version-specific testing"

  positive:
    - id: "AVC-POS-001"
      signal: "Clean version isolation with shared core"

    - id: "AVC-POS-002"
      signal: "Independent version deployment and monitoring"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Review Architecture"
      description: "Understand version coexistence architecture"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Analyze Code Sharing"
      description: "Assess code reuse and duplication"
      duration_estimate: "1 hour"

    - id: "3"
      name: "Evaluate Routing"
      description: "Review version routing mechanisms"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Assess Deployment"
      description: "Evaluate version deployment independence"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Review Operations"
      description: "Assess operational complexity"
      duration_estimate: "1 hour"

    - id: "6"
      name: "Document Findings"
      description: "Create coexistence assessment report"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Architecture Analysis"
        - "Code Sharing Assessment"
        - "Operational Complexity"
        - "Recommendations"

closeout_checklist:
  - id: "avc-001"
    item: "Coexistence architecture documented"
    level: "WARNING"
    verification: "manual"
  - id: "avc-002"
    item: "Code sharing patterns analyzed"
    level: "WARNING"
    verification: "manual"
  - id: "avc-003"
    item: "Operational implications assessed"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["api-providers", "multi-version-systems"]

  compliance_mappings:
    - framework: "API Governance"
      control: "Version Management"
      description: "Multi-version operation"

relationships:
  commonly_combined:
    - "legacy-migration.api-versioning.versioning-strategy"
    - "architecture-design.api-architecture"
  depends_on:
    - "api-design.api-inventory"
  feeds_into:
    - "operations.api-operations"
    - "legacy-migration.api-versioning.deprecation-management"
