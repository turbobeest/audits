# ============================================================
# AUDIT: Multi-AZ/Multi-Region Deployment Audit
# ============================================================

audit:
  id: "reliability-resilience.high-availability.multi-az-multi-region-deployment"
  name: "Multi-AZ/Multi-Region Deployment Audit"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "reliability-resilience"
  category_number: 3
  subcategory: "high-availability"

  tier: "expert"
  estimated_duration: "4 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "infrastructure"

  default_profiles:
    - "full"
    - "production"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the geographic distribution of infrastructure across
    availability zones and regions. Examines compute, storage, and
    database placement, traffic routing and failover mechanisms,
    data replication strategies, and the ability to survive zone
    or regional failures.

  why_it_matters: |
    Single-AZ or single-region deployments are vulnerable to complete
    outages from infrastructure failures, natural disasters, or regional
    issues. Multi-AZ provides protection from hardware and facility
    failures; multi-region provides protection from regional events
    and reduces latency for global users. Geographic redundancy is
    essential for high availability targets.

  when_to_run:
    - "During infrastructure architecture review"
    - "When targeting high availability SLAs (99.99%+)"
    - "After regional infrastructure incidents"
    - "When expanding to serve global users"

prerequisites:
  required_artifacts:
    - type: "infrastructure"
      description: "Cloud infrastructure configuration"
    - type: "architecture"
      description: "System architecture diagrams"

  access_requirements:
    - "Cloud console or CLI access"
    - "Access to infrastructure as code"
    - "Access to DNS and traffic routing configuration"

discovery:
  file_patterns:
    - glob: "**/terraform/**/*.tf"
      purpose: "Terraform infrastructure definitions"
    - glob: "**/cloudformation/**/*.yaml"
      purpose: "CloudFormation templates"

  code_patterns:
    - pattern: "availability_zone|region|multi-az|replica"
      type: "keyword"
      scope: "config"
      purpose: "Find multi-AZ/region configurations"

knowledge_sources:
  specifications:
    - id: "aws-multi-az"
      name: "AWS Multi-AZ Deployments"
      url: "https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.MultiAZ.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "aws-disaster-recovery"
      name: "AWS Disaster Recovery Whitepaper"
      url: "https://docs.aws.amazon.com/whitepapers/latest/disaster-recovery-workloads-on-aws/"
      offline_cache: true
    - id: "release-it"
      name: "Michael Nygard - Release It!"
      url: "https://pragprog.com/titles/mnee2/release-it-second-edition/"
      offline_cache: true
    - id: "sre-book"
      name: "Site Reliability Engineering"
      url: "https://sre.google/sre-book/table-of-contents/"
      offline_cache: true

tooling:
  infrastructure_tools:
    - tool: "aws cli"
      purpose: "Check resource distribution"
      command: "aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId,Placement.AvailabilityZone]'"
    - tool: "kubectl"
      purpose: "Check pod distribution"
      command: "kubectl get pods -o wide --all-namespaces | awk '{print $8}' | sort | uniq -c"

signals:
  critical:
    - id: "HA-MR-CRIT-001"
      signal: "All infrastructure in single availability zone"
      evidence_indicators:
        - "All compute instances in one AZ"
        - "Database without multi-AZ enabled"
      explanation: |
        Single-AZ deployment means complete outage if that AZ fails.
        AZ failures, while rare, cause extended downtime.
      remediation: "Distribute infrastructure across at least 2 availability zones"

    - id: "HA-MR-CRIT-002"
      signal: "Critical stateful services without cross-AZ replication"
      evidence_indicators:
        - "Single-AZ database instances"
        - "No data replication to secondary AZ"
      explanation: |
        Stateful services without replication will lose data or
        require extended recovery time during AZ failures.
      remediation: "Enable multi-AZ for RDS, use replicated storage services"

  high:
    - id: "HA-MR-HIGH-001"
      signal: "No automatic failover for regional failure"
      explanation: "Regional failures require manual intervention to restore service"
      remediation: "Implement DNS-based or traffic manager-based regional failover"

    - id: "HA-MR-HIGH-002"
      signal: "Uneven distribution across availability zones"
      explanation: "Uneven distribution means losing one AZ affects more than expected capacity"
      remediation: "Balance resources across AZs to handle loss of any single AZ"

  medium:
    - id: "HA-MR-MED-001"
      signal: "Cross-region replication lag not monitored"
      remediation: "Monitor replication lag and alert on excessive delays"

    - id: "HA-MR-MED-002"
      signal: "No regular failover testing"
      remediation: "Conduct periodic failover drills to verify recovery capability"

  low:
    - id: "HA-MR-LOW-001"
      signal: "Cost optimization not considered in multi-region design"

  positive:
    - id: "HA-MR-POS-001"
      signal: "Active-active multi-region deployment"
    - id: "HA-MR-POS-002"
      signal: "Automatic failover with sub-minute RTO"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Map Infrastructure Distribution"
      description: |
        Document the geographic distribution of all infrastructure
        components across AZs and regions.
      duration_estimate: "60 min"
      commands:
        - purpose: "List EC2 instances by AZ"
          command: "aws ec2 describe-instances --query 'Reservations[*].Instances[*].[Tags[?Key==`Name`].Value|[0],Placement.AvailabilityZone]' --output table"
        - purpose: "Check RDS multi-AZ status"
          command: "aws rds describe-db-instances --query 'DBInstances[*].[DBInstanceIdentifier,MultiAZ,AvailabilityZone]'"
      expected_findings:
        - "Compute distribution across AZs"
        - "Database redundancy configuration"

    - id: "2"
      name: "Analyze Data Replication"
      description: |
        Review data replication strategies for databases and storage.
      duration_estimate: "45 min"
      commands:
        - purpose: "Check S3 bucket replication"
          command: "aws s3api get-bucket-replication --bucket <bucket-name>"
      expected_findings:
        - "Replication configuration for databases"
        - "Storage replication status"

    - id: "3"
      name: "Review Failover Configuration"
      description: |
        Examine traffic routing and failover mechanisms.
      duration_estimate: "45 min"
      commands:
        - purpose: "Check Route 53 health checks"
          command: "aws route53 list-health-checks"
      expected_findings:
        - "DNS failover configuration"
        - "Health check integration"

    - id: "4"
      name: "Assess Failure Scenarios"
      description: |
        Analyze impact of AZ and regional failures on service availability.
      duration_estimate: "30 min"
      questions:
        - "What happens if a single AZ is lost?"
        - "What happens if an entire region is lost?"
        - "What is the expected recovery time for each scenario?"
      expected_findings:
        - "Failure impact analysis"
        - "Recovery time estimates"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Infrastructure Distribution Map"
        - "Replication Analysis"
        - "Failover Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Full infrastructure access with failover testing"
    medium: "Infrastructure review without failover testing"
    low: "Documentation and IaC review only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "aws-multi-az"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive infrastructure review"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "multi-az-region-001"
    item: "Infrastructure distributed across at least 2 AZs"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify compute and database placement across AZs"
    expected: "Confirmed by reviewer"

  - id: "multi-az-region-002"
    item: "Databases configured with multi-AZ replication"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Check RDS multi-AZ or equivalent configuration"
    expected: "Confirmed by reviewer"

  - id: "multi-az-region-003"
    item: "Failover mechanism exists for regional failure"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Verify DNS or traffic manager failover configuration"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["A1.2"]
    - framework: "ISO 27001"
      controls: ["A.17.1.2"]

relationships:
  commonly_combined:
    - "reliability-resilience.high-availability.active-active-vs-active-passive"
    - "reliability-resilience.disaster-recovery.rto-rpo-definition"
