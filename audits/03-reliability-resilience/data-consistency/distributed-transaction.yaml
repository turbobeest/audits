# ============================================================
# AUDIT: Distributed Transaction Audit
# ============================================================
# Evaluates distributed transaction handling across multiple
# services and data stores.
# ============================================================

# ============================================================
# SECTION 1: IDENTITY & METADATA
# ============================================================

audit:
  id: "reliability-resilience.data-consistency.distributed-transaction"

  name: "Distributed Transaction Audit"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "reliability-resilience"
  category_number: 3
  subcategory: "data-consistency"

  tier: "phd"
  estimated_duration: "6 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

# ============================================================
# SECTION 2: EXECUTION CLASSIFICATION
# ============================================================

execution:
  automatable: "partial"

  severity: "critical"

  scope: "architecture"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

# ============================================================
# SECTION 3: DESCRIPTION & RATIONALE
# ============================================================

description:
  what: |
    Evaluates distributed transaction patterns across microservices
    and multiple data stores. Assesses 2PC implementations, saga
    patterns, eventual consistency handling, and coordination
    mechanisms for cross-service data operations.

  why_it_matters: |
    Distributed transactions are notoriously difficult to implement
    correctly. Failures in coordination can cause data inconsistencies
    across services that are extremely difficult to detect and repair.
    Understanding and properly implementing distributed transaction
    patterns is critical for system reliability.

  when_to_run:
    - "When designing cross-service operations"
    - "After distributed consistency incidents"
    - "During microservices architecture reviews"
    - "When adding new services that share data"

# ============================================================
# SECTION 4: PREREQUISITES
# ============================================================

prerequisites:
  required_artifacts:
    - type: "architecture_docs"
      description: "Service architecture and data flow documentation"
    - type: "application_code"
      description: "Code implementing cross-service operations"
    - type: "data_model"
      description: "Data ownership and service boundaries"

  access_requirements:
    - "Service code repository access"
    - "Architecture documentation"
    - "Message queue/event configurations"

# ============================================================
# SECTION 5: DISCOVERY SPECIFICATION
# ============================================================

discovery:
  code_patterns:
    - pattern: "saga|Saga|SAGA"
      type: "regex"
      scope: "source"
      purpose: "Identify saga pattern implementations"
    - pattern: "2PC|two.phase|TwoPhase|XA"
      type: "regex"
      scope: "source"
      purpose: "Identify 2PC implementations"
    - pattern: "compensate|compensation|rollback"
      type: "regex"
      scope: "source"
      purpose: "Identify compensation logic"

  file_patterns:
    - glob: "**/saga/**/*.java"
      purpose: "Saga implementation code"
    - glob: "**/orchestrator/**/*.py"
      purpose: "Transaction orchestration"

  interviews:
    - role: "Architects"
      questions:
        - "How are cross-service transactions handled?"
        - "What pattern is used (saga, 2PC, choreography)?"
        - "How are failures and partial completions handled?"
      purpose: "Understand distributed transaction architecture"
    - role: "Backend Engineers"
      questions:
        - "How are compensation actions triggered?"
        - "What happens when compensations fail?"
        - "How is transaction state tracked?"
      purpose: "Understand implementation details"

# ============================================================
# SECTION 6: EXTERNAL KNOWLEDGE SOURCES
# ============================================================

knowledge_sources:
  papers:
    - id: "saga-paper"
      title: "Sagas - Hector Garcia-Molina"
      url: "https://www.cs.cornell.edu/andru/cs711/2002fa/reading/sagas.pdf"
    - id: "2pc-problems"
      title: "Problems with Two-Phase Commit"
      url: "https://www.the-paper-trail.org/post/2008-11-29-consensus-protocols-two-phase-commit/"

  guides:
    - id: "microservices-patterns"
      name: "Microservices Patterns - Saga"
      url: "https://microservices.io/patterns/data/saga.html"
      offline_cache: true

  learning_resources:
    - id: "designing-data-intensive"
      title: "Designing Data-Intensive Applications"
      type: "book"
      reference: "ISBN 978-1449373320"

# ============================================================
# SECTION 7: TOOLING & AUTOMATION
# ============================================================

tooling:
  static_analysis:
    - tool: "Code pattern analysis"
      purpose: "Find distributed transaction patterns"
      offline_capable: true

  infrastructure_tools:
    - tool: "Message queue inspection"
      purpose: "Analyze event flows"
      command: "aws sqs list-queues"

# ============================================================
# SECTION 8: SIGNALS & FINDINGS TAXONOMY
# ============================================================

signals:
  critical:
    - id: "DT-CRIT-001"
      signal: "Cross-service operations without transaction coordination"
      evidence_indicators:
        - "Direct service-to-service calls modifying data"
        - "No saga or compensation mechanism"
      explanation: |
        Uncoordinated cross-service operations can leave data inconsistent
        when one service fails after another has committed changes.
      remediation: "Implement saga pattern or similar coordination mechanism"

    - id: "DT-CRIT-002"
      signal: "Compensation actions not implemented for all saga steps"
      evidence_indicators:
        - "Forward actions without corresponding compensations"
        - "Incomplete rollback paths"
      explanation: |
        Without compensation actions, partial saga failures cannot be
        properly reversed, leaving data permanently inconsistent.
      remediation: "Implement compensation for every saga step"

  high:
    - id: "DT-HIGH-001"
      signal: "2PC used in high-latency distributed environment"
      explanation: "2PC blocks resources and doesn't tolerate network partitions well"
      remediation: "Consider saga pattern for long-running distributed transactions"

    - id: "DT-HIGH-002"
      signal: "Saga state not persisted durably"
      explanation: "Process failure can lose saga state, preventing proper completion"
      remediation: "Persist saga state to durable storage"

  medium:
    - id: "DT-MED-001"
      signal: "No idempotency for saga actions"
      remediation: "Implement idempotency keys for all saga steps"

    - id: "DT-MED-002"
      signal: "Orchestration single point of failure"
      remediation: "Ensure orchestrator is highly available or use choreography"

  low:
    - id: "DT-LOW-001"
      signal: "Distributed transaction patterns not documented"

  positive:
    - id: "DT-POS-001"
      signal: "Well-implemented saga pattern with compensation for all steps"
    - id: "DT-POS-002"
      signal: "Idempotent operations with proper saga state management"

# ============================================================
# SECTION 9: EXECUTION PROCEDURE
# ============================================================

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Map Cross-Service Operations"
      description: |
        Identify all operations that span multiple services
        and modify data in multiple places.
      duration_estimate: "60 min"
      questions:
        - "What operations modify data in multiple services?"
        - "What is the expected consistency behavior?"
        - "What happens if one service is unavailable?"
      expected_findings:
        - "Cross-service operation inventory"
        - "Data modification flow"

    - id: "2"
      name: "Analyze Transaction Patterns"
      description: |
        Identify which distributed transaction patterns are used
        (saga, 2PC, choreography, etc.).
      duration_estimate: "60 min"
      commands:
        - purpose: "Find saga implementations"
          command: "grep -r 'saga\\|Saga\\|compensation\\|compensate' --include='*.java' --include='*.py'"
      expected_findings:
        - "Pattern identification"
        - "Pattern appropriateness assessment"

    - id: "3"
      name: "Review Compensation Logic"
      description: |
        For saga patterns, verify that compensation actions
        exist and are correct for all steps.
      duration_estimate: "90 min"
      questions:
        - "Does every step have a compensation action?"
        - "Are compensations idempotent?"
        - "What if compensation fails?"
      expected_findings:
        - "Compensation coverage"
        - "Compensation correctness"

    - id: "4"
      name: "Assess Failure Handling"
      description: |
        Evaluate how failures are detected, communicated,
        and handled in distributed transactions.
      duration_estimate: "60 min"
      questions:
        - "How are failures detected?"
        - "How is saga state tracked?"
        - "What happens on coordinator failure?"
      expected_findings:
        - "Failure handling assessment"
        - "Recovery capability"

# ============================================================
# SECTION 10: OUTPUT SPECIFICATION
# ============================================================

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "transaction_map"
      format: "diagram"
      description: "Visual map of distributed transaction flows"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Cross-Service Operation Analysis"
        - "Pattern Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Code reviewed with failure scenario testing"
    medium: "Code reviewed without failure testing"
    low: "Based on architecture documentation only"

# ============================================================
# SECTION 11: OFFLINE SUPPORT
# ============================================================

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "saga-paper"
        priority: "required"
      - source_id: "microservices-patterns"
        priority: "required"

# ============================================================
# SECTION 12: PROFILES
# ============================================================

profiles:
  membership:
    quick:
      included: false
      reason: "Distributed transaction review is complex and time-intensive"
    full:
      included: true
      priority: 1

# ============================================================
# SECTION 13: DETERMINISTIC VERIFICATION
# ============================================================

closeout_checklist:
  - id: "dt-001"
    item: "Cross-service operations have transaction coordination"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Review cross-service flows for saga/2PC implementation"
    expected: "Confirmed by reviewer"

  - id: "dt-002"
    item: "Compensation actions implemented for all saga steps"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Map forward actions to compensating actions"
    expected: "Confirmed by reviewer"

  - id: "dt-003"
    item: "Saga state persisted durably"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Verify saga state storage mechanism"
    expected: "Confirmed by reviewer"

  - id: "dt-004"
    item: "All saga steps are idempotent"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Review saga actions for idempotency"
    expected: "Confirmed by reviewer"

# ============================================================
# SECTION 14: GOVERNANCE
# ============================================================

governance:
  applicable_to:
    archetypes: ["microservices", "distributed-systems"]

  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["CC6.1"]

# ============================================================
# SECTION 15: RELATIONSHIPS
# ============================================================

relationships:
  commonly_combined:
    - "reliability-resilience.data-consistency.saga-pattern-implementation"
    - "reliability-resilience.data-consistency.idempotency-key"
    - "reliability-resilience.data-consistency.eventual-consistency"
