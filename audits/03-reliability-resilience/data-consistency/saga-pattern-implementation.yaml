# ============================================================
# AUDIT: Saga Pattern Implementation Audit
# ============================================================
# Evaluates saga pattern implementations for distributed
# transaction management in microservices.
# ============================================================

# ============================================================
# SECTION 1: IDENTITY & METADATA
# ============================================================

audit:
  id: "reliability-resilience.data-consistency.saga-pattern-implementation"

  name: "Saga Pattern Implementation Audit"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "reliability-resilience"
  category_number: 3
  subcategory: "data-consistency"

  tier: "phd"
  estimated_duration: "5 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

# ============================================================
# SECTION 2: EXECUTION CLASSIFICATION
# ============================================================

execution:
  automatable: "partial"

  severity: "critical"

  scope: "architecture"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

# ============================================================
# SECTION 3: DESCRIPTION & RATIONALE
# ============================================================

description:
  what: |
    Evaluates saga pattern implementations including orchestration
    vs choreography approaches, compensation logic, state management,
    and failure handling. Assesses whether sagas correctly maintain
    data consistency across distributed services.

  why_it_matters: |
    Sagas are the primary pattern for maintaining consistency in
    microservices without distributed transactions. Incorrect
    implementations can leave services in inconsistent states,
    with partial completions that are difficult to detect and
    repair. Proper saga implementation is critical for system
    reliability.

  when_to_run:
    - "When implementing cross-service operations"
    - "After saga-related consistency issues"
    - "During microservices architecture reviews"
    - "When refactoring distributed workflows"

# ============================================================
# SECTION 4: PREREQUISITES
# ============================================================

prerequisites:
  required_artifacts:
    - type: "application_code"
      description: "Saga implementation code"
    - type: "architecture_docs"
      description: "Service workflow documentation"
    - type: "event_schema"
      description: "Event/message schemas for saga steps"

  access_requirements:
    - "Service code repository access"
    - "Message queue/event bus access"
    - "Saga state storage access"

# ============================================================
# SECTION 5: DISCOVERY SPECIFICATION
# ============================================================

discovery:
  code_patterns:
    - pattern: "saga|Saga|SAGA"
      type: "regex"
      scope: "source"
      purpose: "Find saga implementations"
    - pattern: "compensate|compensation|Compensate|rollback"
      type: "regex"
      scope: "source"
      purpose: "Find compensation logic"
    - pattern: "orchestrator|Orchestrator|choreography"
      type: "regex"
      scope: "source"
      purpose: "Identify saga coordination pattern"

  file_patterns:
    - glob: "**/saga/**/*.java"
      purpose: "Saga implementation files"
    - glob: "**/workflow/**/*.py"
      purpose: "Workflow definitions"
    - glob: "**/orchestration/**/*.ts"
      purpose: "Orchestration logic"

  interviews:
    - role: "Backend Engineers"
      questions:
        - "What saga framework or pattern is used?"
        - "How is saga state persisted?"
        - "What happens when compensations fail?"
      purpose: "Understand saga implementation approach"

# ============================================================
# SECTION 6: EXTERNAL KNOWLEDGE SOURCES
# ============================================================

knowledge_sources:
  papers:
    - id: "saga-original"
      title: "Sagas - Hector Garcia-Molina"
      url: "https://www.cs.cornell.edu/andru/cs711/2002fa/reading/sagas.pdf"

  guides:
    - id: "microservices-saga"
      name: "Microservices.io Saga Pattern"
      url: "https://microservices.io/patterns/data/saga.html"
      offline_cache: true
    - id: "temporal-saga"
      name: "Temporal Saga Pattern"
      url: "https://docs.temporal.io/workflows"
      offline_cache: true

  learning_resources:
    - id: "microservices-patterns-book"
      title: "Microservices Patterns"
      type: "book"
      reference: "ISBN 978-1617294549"

# ============================================================
# SECTION 7: TOOLING & AUTOMATION
# ============================================================

tooling:
  static_analysis:
    - tool: "Code pattern analysis"
      purpose: "Find saga implementations and compensations"
      offline_capable: true

  infrastructure_tools:
    - tool: "Temporal"
      purpose: "Inspect workflow definitions"
      command: "tctl workflow describe -w WORKFLOW_ID"
    - tool: "AWS Step Functions"
      purpose: "Inspect state machine definitions"
      command: "aws stepfunctions describe-state-machine --state-machine-arn ARN"

# ============================================================
# SECTION 8: SIGNALS & FINDINGS TAXONOMY
# ============================================================

signals:
  critical:
    - id: "SAGA-CRIT-001"
      signal: "Saga steps without compensating actions"
      evidence_indicators:
        - "Forward action without corresponding compensation"
        - "Compensation method missing or empty"
      explanation: |
        Without compensation for every step, partial saga failures
        cannot be properly rolled back, leaving data inconsistent
        across services permanently.
      remediation: "Implement compensation action for every saga step"

    - id: "SAGA-CRIT-002"
      signal: "Saga state not persisted durably"
      evidence_indicators:
        - "In-memory saga state only"
        - "No saga state table or storage"
      explanation: |
        If saga state is lost (process crash), the system cannot
        resume or compensate the saga, leaving it in limbo state.
      remediation: "Persist saga state to durable storage before each step"

  high:
    - id: "SAGA-HIGH-001"
      signal: "Compensations not idempotent"
      explanation: "Retry of compensation could over-compensate or fail"
      remediation: "Make all compensation actions idempotent"

    - id: "SAGA-HIGH-002"
      signal: "No handling for compensation failures"
      explanation: "Failed compensation leaves system in unknown state"
      remediation: "Implement dead letter handling and manual intervention for failed compensations"

  medium:
    - id: "SAGA-MED-001"
      signal: "No timeout for saga completion"
      remediation: "Implement saga timeout with automatic compensation"

    - id: "SAGA-MED-002"
      signal: "Saga events not correlated properly"
      remediation: "Use saga ID for correlating all related events"

  low:
    - id: "SAGA-LOW-001"
      signal: "Saga patterns not documented"

  positive:
    - id: "SAGA-POS-001"
      signal: "Complete saga implementation with compensations for all steps"
    - id: "SAGA-POS-002"
      signal: "Durable saga state with proper failure handling"

# ============================================================
# SECTION 9: EXECUTION PROCEDURE
# ============================================================

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Saga Workflows"
      description: |
        Identify all saga workflows in the system and document
        their steps and participants.
      duration_estimate: "45 min"
      questions:
        - "What business processes use sagas?"
        - "Which services participate in each saga?"
        - "What is the coordination mechanism (orchestration/choreography)?"
      expected_findings:
        - "Saga inventory"
        - "Coordination pattern used"

    - id: "2"
      name: "Map Steps to Compensations"
      description: |
        For each saga, map every forward step to its corresponding
        compensation action.
      duration_estimate: "60 min"
      commands:
        - purpose: "Find saga steps and compensations"
          command: "grep -r 'saga\\|compensate\\|Compensation' --include='*.java' --include='*.py' -A 10"
      expected_findings:
        - "Step-to-compensation mapping"
        - "Missing compensation actions"

    - id: "3"
      name: "Review State Management"
      description: |
        Evaluate how saga state is persisted and managed
        throughout the saga lifecycle.
      duration_estimate: "45 min"
      questions:
        - "Where is saga state stored?"
        - "When is state persisted (before or after each step)?"
        - "Can sagas be resumed after process restart?"
      expected_findings:
        - "State management assessment"
        - "Durability guarantees"

    - id: "4"
      name: "Assess Failure Handling"
      description: |
        Evaluate how failures are detected and handled including
        compensation triggering and dead letter handling.
      duration_estimate: "60 min"
      questions:
        - "How are step failures detected?"
        - "How are compensations triggered?"
        - "What happens if compensation fails?"
      expected_findings:
        - "Failure handling assessment"
        - "Manual intervention procedures"

    - id: "5"
      name: "Verify Idempotency"
      description: |
        Check that all saga steps and compensations are
        idempotent for safe retry.
      duration_estimate: "45 min"
      questions:
        - "Are saga steps idempotent?"
        - "Are compensations idempotent?"
        - "How are retries handled?"
      expected_findings:
        - "Idempotency assessment"
        - "Retry safety"

# ============================================================
# SECTION 10: OUTPUT SPECIFICATION
# ============================================================

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "saga_map"
      format: "diagram"
      description: "Visual representation of saga steps and compensations"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Saga Inventory"
        - "Compensation Coverage"
        - "State Management Review"
        - "Recommendations"

  confidence_guidance:
    high: "Code reviewed with failure scenario testing"
    medium: "Code reviewed without failure testing"
    low: "Based on documentation only"

# ============================================================
# SECTION 11: OFFLINE SUPPORT
# ============================================================

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "saga-original"
        priority: "required"
      - source_id: "microservices-saga"
        priority: "required"

# ============================================================
# SECTION 12: PROFILES
# ============================================================

profiles:
  membership:
    quick:
      included: false
      reason: "Saga review is complex and time-intensive"
    full:
      included: true
      priority: 1

# ============================================================
# SECTION 13: DETERMINISTIC VERIFICATION
# ============================================================

closeout_checklist:
  - id: "saga-001"
    item: "Every saga step has corresponding compensation"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Review saga definitions for compensation coverage"
    expected: "Confirmed by reviewer"

  - id: "saga-002"
    item: "Saga state persisted to durable storage"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify saga state storage mechanism"
    expected: "Confirmed by reviewer"

  - id: "saga-003"
    item: "All saga steps and compensations are idempotent"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Review step/compensation implementations for idempotency"
    expected: "Confirmed by reviewer"

  - id: "saga-004"
    item: "Compensation failure handling defined"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Review failure handling and dead letter procedures"
    expected: "Confirmed by reviewer"

  - id: "saga-005"
    item: "Saga timeout configured with automatic compensation"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Check for timeout configuration"
    expected: "Confirmed by reviewer"

# ============================================================
# SECTION 14: GOVERNANCE
# ============================================================

governance:
  applicable_to:
    archetypes: ["microservices", "distributed-systems"]

  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["CC6.1"]

# ============================================================
# SECTION 15: RELATIONSHIPS
# ============================================================

relationships:
  commonly_combined:
    - "reliability-resilience.data-consistency.distributed-transaction"
    - "reliability-resilience.data-consistency.idempotency-key"
    - "reliability-resilience.data-consistency.eventual-consistency"
