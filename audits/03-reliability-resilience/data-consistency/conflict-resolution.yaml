# ============================================================
# AUDIT: Conflict Resolution Audit
# ============================================================
# Evaluates conflict resolution strategies in distributed systems
# for handling concurrent updates and data divergence.
# ============================================================

# ============================================================
# SECTION 1: IDENTITY & METADATA
# ============================================================

audit:
  id: "reliability-resilience.data-consistency.conflict-resolution"

  name: "Conflict Resolution Audit"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "reliability-resilience"
  category_number: 3
  subcategory: "data-consistency"

  tier: "expert"
  estimated_duration: "3 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

# ============================================================
# SECTION 2: EXECUTION CLASSIFICATION
# ============================================================

execution:
  automatable: "partial"

  severity: "high"

  scope: "codebase"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

# ============================================================
# SECTION 3: DESCRIPTION & RATIONALE
# ============================================================

description:
  what: |
    Evaluates conflict resolution strategies in distributed systems
    including version vectors, CRDTs (Conflict-free Replicated Data Types),
    last-write-wins policies, and merge strategies. Assesses whether
    conflict resolution preserves data integrity.

  why_it_matters: |
    In distributed systems, concurrent updates to the same data are
    inevitable. Without proper conflict resolution, updates can be
    silently lost, causing data corruption and user frustration.
    Proper conflict resolution ensures all updates are either
    preserved or explicitly handled.

  when_to_run:
    - "When designing distributed data systems"
    - "After data loss incidents from conflicts"
    - "When adding multi-master replication"
    - "During distributed system audits"

# ============================================================
# SECTION 4: PREREQUISITES
# ============================================================

prerequisites:
  required_artifacts:
    - type: "application_code"
      description: "Code handling data updates and conflicts"
    - type: "architecture_docs"
      description: "Distributed system architecture documentation"
    - type: "data_model"
      description: "Data model documentation"

  access_requirements:
    - "Application code repository access"
    - "Architecture documentation access"
    - "Data store configuration access"

# ============================================================
# SECTION 5: DISCOVERY SPECIFICATION
# ============================================================

discovery:
  code_patterns:
    - pattern: "version|Version|etag|ETag|revision|Revision"
      type: "regex"
      scope: "source"
      purpose: "Identify versioning for conflict detection"
    - pattern: "CRDT|conflict|merge|reconcile"
      type: "regex"
      scope: "source"
      purpose: "Identify conflict resolution code"
    - pattern: "lastWriteWins|last.write.wins|LWW"
      type: "regex"
      scope: "source"
      purpose: "Identify last-write-wins patterns"

  file_patterns:
    - glob: "**/conflict*.py"
      purpose: "Conflict resolution modules"
    - glob: "**/merge*.js"
      purpose: "Merge strategy implementations"

  interviews:
    - role: "Backend Engineers"
      questions:
        - "How are concurrent updates handled?"
        - "What conflict resolution strategy is used?"
        - "How are conflicts surfaced to users?"
      purpose: "Understand conflict handling approach"

# ============================================================
# SECTION 6: EXTERNAL KNOWLEDGE SOURCES
# ============================================================

knowledge_sources:
  papers:
    - id: "crdt-paper"
      title: "A Comprehensive Study of CRDTs"
      url: "https://hal.inria.fr/inria-00555588/document"
    - id: "vector-clocks"
      title: "Vector Clocks and Distributed Systems"
      url: "https://en.wikipedia.org/wiki/Vector_clock"

  guides:
    - id: "dynamodb-optimistic"
      name: "DynamoDB Optimistic Locking"
      url: "https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBMapper.OptimisticLocking.html"
      offline_cache: true

# ============================================================
# SECTION 7: TOOLING & AUTOMATION
# ============================================================

tooling:
  static_analysis:
    - tool: "grep/ast analysis"
      purpose: "Find conflict resolution patterns"
      offline_capable: true

  scripts:
    - id: "find-conflict-patterns"
      language: "bash"
      purpose: "Identify conflict resolution code patterns"
      source: "inline"
      code: |
        #!/bin/bash
        echo "Finding conflict resolution patterns..."
        grep -r "version\|etag\|conflict\|merge" --include="*.py" --include="*.java" --include="*.js"

# ============================================================
# SECTION 8: SIGNALS & FINDINGS TAXONOMY
# ============================================================

signals:
  critical:
    - id: "CR-CRIT-001"
      signal: "Last-write-wins without version checking causes silent data loss"
      evidence_pattern: "UPDATE.*SET.*WHERE.*id"
      evidence_indicators:
        - "Unconditional updates overwrite concurrent changes"
        - "No version or timestamp comparison"
      explanation: |
        Last-write-wins without conflict detection silently discards
        concurrent updates, causing data loss that may go unnoticed.
      remediation: "Implement optimistic locking with version checks"

    - id: "CR-CRIT-002"
      signal: "No conflict resolution strategy for multi-master replication"
      evidence_indicators:
        - "Multi-master setup without conflict handling"
        - "Replication without version vectors"
      explanation: |
        Multi-master replication without conflict resolution will
        inevitably diverge, causing data inconsistency across replicas.
      remediation: "Implement CRDTs or explicit conflict resolution"

  high:
    - id: "CR-HIGH-001"
      signal: "Conflicts silently resolved without logging"
      explanation: "Silent resolution hides data integrity issues"
      remediation: "Log all conflict resolutions for audit and debugging"

    - id: "CR-HIGH-002"
      signal: "User-generated content merged without user notification"
      explanation: "Users may lose work without realizing it"
      remediation: "Surface conflicts to users for resolution"

  medium:
    - id: "CR-MED-001"
      signal: "Conflict resolution not tested with concurrent operations"
      remediation: "Add integration tests for concurrent update scenarios"

    - id: "CR-MED-002"
      signal: "Inconsistent conflict resolution across different entities"
      remediation: "Standardize conflict resolution approach"

  low:
    - id: "CR-LOW-001"
      signal: "Conflict resolution strategy not documented"

  positive:
    - id: "CR-POS-001"
      signal: "CRDTs used for conflict-free distributed data"
    - id: "CR-POS-002"
      signal: "Optimistic locking with user-friendly conflict UI"

# ============================================================
# SECTION 9: EXECUTION PROCEDURE
# ============================================================

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify Concurrent Update Scenarios"
      description: |
        Map out scenarios where concurrent updates to the same
        data are possible.
      duration_estimate: "30 min"
      questions:
        - "What data can be updated by multiple users/processes?"
        - "What happens when concurrent updates occur?"
        - "Are there multi-master replication scenarios?"
      expected_findings:
        - "List of concurrent update scenarios"
        - "Current handling for each scenario"

    - id: "2"
      name: "Review Conflict Detection Mechanisms"
      description: |
        Analyze how conflicts are detected including version
        checking, timestamps, and change tracking.
      duration_estimate: "45 min"
      commands:
        - purpose: "Find version checking patterns"
          command: "grep -r 'version\\|etag\\|if-match\\|conditional' --include='*.py' --include='*.java' --include='*.js'"
      expected_findings:
        - "Conflict detection mechanisms"
        - "Coverage of detection"

    - id: "3"
      name: "Analyze Conflict Resolution Logic"
      description: |
        Review how detected conflicts are resolved including
        merge strategies, user interaction, and automatic resolution.
      duration_estimate: "60 min"
      questions:
        - "How are conflicts resolved?"
        - "Is resolution automatic or manual?"
        - "What data might be lost in resolution?"
      expected_findings:
        - "Resolution strategies by entity type"
        - "Potential data loss scenarios"

    - id: "4"
      name: "Evaluate User Experience"
      description: |
        Assess how conflicts are communicated to users and
        whether users can resolve conflicts effectively.
      duration_estimate: "30 min"
      questions:
        - "How are users notified of conflicts?"
        - "Can users see conflicting versions?"
        - "Is the resolution process user-friendly?"
      expected_findings:
        - "User experience assessment"
        - "Conflict visibility"

# ============================================================
# SECTION 10: OUTPUT SPECIFICATION
# ============================================================

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "conflict_matrix"
      format: "table"
      columns:
        - "Entity/Data Type"
        - "Concurrent Update Possible"
        - "Detection Method"
        - "Resolution Strategy"
        - "Data Loss Risk"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Conflict Scenario Analysis"
        - "Resolution Strategy Review"
        - "Recommendations"

  confidence_guidance:
    high: "Code reviewed and conflict scenarios tested"
    medium: "Code reviewed without testing"
    low: "Based on documentation only"

# ============================================================
# SECTION 11: OFFLINE SUPPORT
# ============================================================

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "crdt-paper"
        priority: "recommended"

# ============================================================
# SECTION 12: PROFILES
# ============================================================

profiles:
  membership:
    quick:
      included: false
      reason: "Conflict resolution review requires thorough code analysis"
    full:
      included: true
      priority: 1

# ============================================================
# SECTION 13: DETERMINISTIC VERIFICATION
# ============================================================

closeout_checklist:
  - id: "cr-001"
    item: "Conflict detection mechanism in place for mutable data"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Review code for version checking or conflict detection"
    expected: "Confirmed by reviewer"

  - id: "cr-002"
    item: "Conflict resolution strategy does not silently lose data"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Analyze resolution logic for data preservation"
    expected: "Confirmed by reviewer"

  - id: "cr-003"
    item: "Conflict resolution logged for debugging"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Verify logging in conflict resolution code paths"
    expected: "Confirmed by reviewer"

  - id: "cr-004"
    item: "Users notified when their changes conflict"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Review UI for conflict notifications"
    expected: "Confirmed by reviewer"

# ============================================================
# SECTION 14: GOVERNANCE
# ============================================================

governance:
  applicable_to:
    archetypes: ["distributed-systems", "collaborative-apps"]

  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["CC6.1"]

# ============================================================
# SECTION 15: RELATIONSHIPS
# ============================================================

relationships:
  commonly_combined:
    - "reliability-resilience.data-consistency.eventual-consistency"
    - "reliability-resilience.data-consistency.optimistic-vs-pessimistic-locking"
    - "reliability-resilience.data-consistency.distributed-transaction"
