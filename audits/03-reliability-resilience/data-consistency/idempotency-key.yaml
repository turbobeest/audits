# ============================================================
# AUDIT: Idempotency Key Audit
# ============================================================
# Evaluates idempotency key implementation for safe request
# retry handling and duplicate prevention.
# ============================================================

# ============================================================
# SECTION 1: IDENTITY & METADATA
# ============================================================

audit:
  id: "reliability-resilience.data-consistency.idempotency-key"

  name: "Idempotency Key Audit"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "reliability-resilience"
  category_number: 3
  subcategory: "data-consistency"

  tier: "expert"
  estimated_duration: "3 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

# ============================================================
# SECTION 2: EXECUTION CLASSIFICATION
# ============================================================

execution:
  automatable: "partial"

  severity: "high"

  scope: "codebase"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

# ============================================================
# SECTION 3: DESCRIPTION & RATIONALE
# ============================================================

description:
  what: |
    Evaluates idempotency key implementation for API endpoints and
    message handlers. Assesses key generation, storage, expiration,
    and response caching to ensure operations can be safely retried
    without causing duplicate effects.

  why_it_matters: |
    Network failures, timeouts, and client retries are common in
    distributed systems. Without idempotency, retried requests can
    cause duplicate charges, double-creates, or incorrect state
    changes. Proper idempotency ensures exactly-once semantics
    for critical operations.

  when_to_run:
    - "When designing APIs for critical operations"
    - "After duplicate processing incidents"
    - "During payment/financial system reviews"
    - "When implementing retry logic"

# ============================================================
# SECTION 4: PREREQUISITES
# ============================================================

prerequisites:
  required_artifacts:
    - type: "api_specification"
      description: "API documentation showing idempotency requirements"
    - type: "application_code"
      description: "Request handling and idempotency implementation"
    - type: "data_model"
      description: "Idempotency key storage schema"

  access_requirements:
    - "API specification access"
    - "Application code repository access"
    - "Database schema access"

# ============================================================
# SECTION 5: DISCOVERY SPECIFICATION
# ============================================================

discovery:
  code_patterns:
    - pattern: "idempotency|Idempotency|idempotent|Idempotent"
      type: "regex"
      scope: "source"
      purpose: "Find idempotency implementations"
    - pattern: "X-Idempotency-Key|Idempotency-Key"
      type: "regex"
      scope: "source"
      purpose: "Find idempotency header handling"
    - pattern: "dedup|deduplicate|duplicate"
      type: "regex"
      scope: "source"
      purpose: "Find deduplication logic"

  file_patterns:
    - glob: "**/middleware/**/*.py"
      purpose: "Middleware handling idempotency"
    - glob: "**/interceptors/**/*.java"
      purpose: "Request interceptors"

  interviews:
    - role: "Backend Engineers"
      questions:
        - "Which endpoints support idempotency?"
        - "How are idempotency keys stored and managed?"
        - "What is the key expiration policy?"
      purpose: "Understand idempotency implementation"

# ============================================================
# SECTION 6: EXTERNAL KNOWLEDGE SOURCES
# ============================================================

knowledge_sources:
  guides:
    - id: "stripe-idempotency"
      name: "Stripe Idempotent Requests"
      url: "https://stripe.com/docs/api/idempotent_requests"
      offline_cache: true
    - id: "aws-idempotency"
      name: "AWS API Idempotency"
      url: "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/Run_Instance_Idempotency.html"
      offline_cache: true

# ============================================================
# SECTION 7: TOOLING & AUTOMATION
# ============================================================

tooling:
  static_analysis:
    - tool: "Code pattern matching"
      purpose: "Find idempotency patterns"
      offline_capable: true

  scripts:
    - id: "find-idempotency"
      language: "bash"
      purpose: "Locate idempotency implementations"
      source: "inline"
      code: |
        #!/bin/bash
        echo "Finding idempotency patterns..."
        grep -r "idempotency\|Idempotency\|X-Idempotency" --include="*.py" --include="*.java" --include="*.js"

# ============================================================
# SECTION 8: SIGNALS & FINDINGS TAXONOMY
# ============================================================

signals:
  critical:
    - id: "IK-CRIT-001"
      signal: "Critical operations (payments, transfers) lack idempotency"
      evidence_indicators:
        - "Payment endpoints without idempotency key support"
        - "Financial operations not deduplicated"
      explanation: |
        Without idempotency, retried payment requests can cause duplicate
        charges, significantly impacting customers and requiring manual
        reconciliation.
      remediation: "Implement idempotency keys for all critical financial operations"

    - id: "IK-CRIT-002"
      signal: "Idempotency check occurs after side effects"
      evidence_indicators:
        - "Database write before idempotency check"
        - "External API call before deduplication"
      explanation: |
        If idempotency check happens after side effects, the duplicate
        detection is ineffective and side effects will occur twice.
      remediation: "Check idempotency key before any side effects"

  high:
    - id: "IK-HIGH-001"
      signal: "Idempotency keys stored only in memory"
      explanation: "Server restart loses idempotency state, allowing duplicates"
      remediation: "Store idempotency keys in durable storage (Redis, database)"

    - id: "IK-HIGH-002"
      signal: "Response not cached with idempotency key"
      explanation: "Retry may succeed but return different response confusing clients"
      remediation: "Cache and return same response for retried requests"

  medium:
    - id: "IK-MED-001"
      signal: "Idempotency key expiration too short"
      remediation: "Set expiration to cover reasonable retry windows (24-48 hours)"

    - id: "IK-MED-002"
      signal: "No idempotency key format validation"
      remediation: "Validate key format and length to prevent abuse"

  low:
    - id: "IK-LOW-001"
      signal: "Idempotency behavior not documented in API"

  positive:
    - id: "IK-POS-001"
      signal: "Comprehensive idempotency with response caching"
    - id: "IK-POS-002"
      signal: "Client-friendly error handling for duplicate requests"

# ============================================================
# SECTION 9: EXECUTION PROCEDURE
# ============================================================

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify Critical Operations"
      description: |
        Identify all operations that must be idempotent including
        payments, resource creation, and state changes.
      duration_estimate: "30 min"
      questions:
        - "Which operations involve money or resources?"
        - "Which operations have side effects that cannot be undone?"
        - "Which operations are commonly retried?"
      expected_findings:
        - "List of operations requiring idempotency"
        - "Current idempotency coverage"

    - id: "2"
      name: "Review Idempotency Implementation"
      description: |
        Analyze how idempotency keys are processed, stored,
        and used to prevent duplicate operations.
      duration_estimate: "60 min"
      commands:
        - purpose: "Find idempotency handling code"
          command: "grep -r 'idempotency\\|Idempotency' --include='*.py' --include='*.java' --include='*.js' -A 10"
      expected_findings:
        - "Implementation patterns"
        - "Storage mechanism"

    - id: "3"
      name: "Verify Check-Before-Effect Pattern"
      description: |
        Ensure idempotency check occurs before any side effects
        like database writes or external API calls.
      duration_estimate: "45 min"
      questions:
        - "When in the request flow is idempotency checked?"
        - "Are any side effects triggered before the check?"
      expected_findings:
        - "Check ordering assessment"
        - "Potential race conditions"

    - id: "4"
      name: "Assess Response Handling"
      description: |
        Verify that responses are cached and returned consistently
        for retried requests.
      duration_estimate: "30 min"
      questions:
        - "Is the original response cached?"
        - "What is returned for a retry request?"
        - "How are errors handled for retries?"
      expected_findings:
        - "Response caching assessment"
        - "Error handling patterns"

# ============================================================
# SECTION 10: OUTPUT SPECIFICATION
# ============================================================

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "idempotency_matrix"
      format: "table"
      columns:
        - "Operation"
        - "Criticality"
        - "Idempotency Supported"
        - "Storage"
        - "Expiration"
        - "Status"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Coverage Analysis"
        - "Implementation Review"
        - "Recommendations"

  confidence_guidance:
    high: "Code reviewed and tested with duplicate requests"
    medium: "Code reviewed without testing"
    low: "Based on documentation only"

# ============================================================
# SECTION 11: OFFLINE SUPPORT
# ============================================================

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "stripe-idempotency"
        priority: "recommended"

# ============================================================
# SECTION 12: PROFILES
# ============================================================

profiles:
  membership:
    quick:
      included: false
      reason: "Idempotency review requires thorough code analysis"
    full:
      included: true
      priority: 1

# ============================================================
# SECTION 13: DETERMINISTIC VERIFICATION
# ============================================================

closeout_checklist:
  - id: "ik-001"
    item: "Financial/critical operations support idempotency keys"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Review critical endpoints for idempotency support"
    expected: "Confirmed by reviewer"

  - id: "ik-002"
    item: "Idempotency check occurs before side effects"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Trace request flow to verify check ordering"
    expected: "Confirmed by reviewer"

  - id: "ik-003"
    item: "Idempotency keys stored in durable storage"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Verify storage mechanism (Redis, database, etc.)"
    expected: "Confirmed by reviewer"

  - id: "ik-004"
    item: "Responses cached for idempotent requests"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Review response handling for retried requests"
    expected: "Confirmed by reviewer"

# ============================================================
# SECTION 14: GOVERNANCE
# ============================================================

governance:
  applicable_to:
    archetypes: ["api-services", "payment-systems"]

  compliance_frameworks:
    - framework: "PCI-DSS"
      controls: ["3.4"]

# ============================================================
# SECTION 15: RELATIONSHIPS
# ============================================================

relationships:
  commonly_combined:
    - "reliability-resilience.data-consistency.distributed-transaction"
    - "reliability-resilience.data-consistency.saga-pattern-implementation"
    - "reliability-resilience.error-handling.retry-strategy"
