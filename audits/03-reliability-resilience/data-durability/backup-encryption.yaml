# ============================================================
# AUDIT: Backup Encryption Audit
# ============================================================

audit:
  id: "reliability-resilience.data-durability.backup-encryption"
  name: "Backup Encryption Audit"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "reliability-resilience"
  category_number: 3
  subcategory: "data-durability"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "security"

  default_profiles:
    - "full"
    - "production"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates encryption for backup data including encryption at rest,
    encryption in transit, key management, and key recovery procedures.
    Examines whether backup encryption provides defense in depth without
    creating recovery risks from lost keys.

  why_it_matters: |
    Unencrypted backups expose sensitive data to theft if storage is
    compromised. However, encrypted backups with poor key management
    can become unrecoverable if keys are lost. Proper backup encryption
    protects data confidentiality while ensuring recoverability through
    secure key escrow and rotation.

  when_to_run:
    - "During security architecture review"
    - "When implementing backup encryption"
    - "During compliance audits"
    - "After security incidents"

prerequisites:
  required_artifacts:
    - type: "infrastructure"
      description: "Backup system configuration"
    - type: "documentation"
      description: "Key management procedures"

  access_requirements:
    - "Backup system configuration access"
    - "Key management system access"
    - "Encryption policy documentation"

discovery:
  code_patterns:
    - pattern: "encrypt|kms|SSE|AES|key.*backup|backup.*key"
      type: "regex"
      scope: "config"
      purpose: "Find backup encryption configuration"

  file_patterns:
    - glob: "**/backup/**/*.yaml"
      purpose: "Backup configuration"
    - glob: "**/terraform/**/*.tf"
      purpose: "Infrastructure as code"

knowledge_sources:
  specifications:
    - id: "aws-kms"
      name: "AWS KMS Documentation"
      url: "https://docs.aws.amazon.com/kms/latest/developerguide/"
      offline_cache: true
      priority: "required"

  guides:
    - id: "backup-encryption"
      name: "Backup Encryption Best Practices"
      url: "https://docs.aws.amazon.com/prescriptive-guidance/latest/backup-recovery/backup-encryption.html"
      offline_cache: true

tooling:
  infrastructure_tools:
    - tool: "aws cli"
      purpose: "Check S3 bucket encryption"
      command: "aws s3api get-bucket-encryption --bucket backup-bucket"
    - tool: "aws cli"
      purpose: "Check RDS backup encryption"
      command: "aws rds describe-db-instances --query 'DBInstances[*].[DBInstanceIdentifier,StorageEncrypted,KmsKeyId]'"

signals:
  critical:
    - id: "DD-BE-CRIT-001"
      signal: "Backups stored without encryption"
      evidence_indicators:
        - "S3 bucket without default encryption"
        - "RDS snapshots without encryption"
      explanation: |
        Unencrypted backups expose all historical data if storage
        is compromised through breach or misconfiguration.
      remediation: "Enable encryption for all backup storage"

    - id: "DD-BE-CRIT-002"
      signal: "Encryption keys not recoverable"
      evidence_indicators:
        - "No key escrow or backup"
        - "Keys stored only in single location"
      explanation: |
        Lost encryption keys make encrypted backups permanently
        unrecoverable, effectively causing total data loss.
      remediation: "Implement key escrow with secure recovery procedures"

  high:
    - id: "DD-BE-HIGH-001"
      signal: "Same key used for primary data and backups"
      explanation: "Compromised key affects both production and recovery data"
      remediation: "Use separate keys for backup encryption"

    - id: "DD-BE-HIGH-002"
      signal: "Key rotation not implemented"
      explanation: "Long-lived keys have higher compromise risk"
      remediation: "Implement automatic key rotation"

  medium:
    - id: "DD-BE-MED-001"
      signal: "Encryption in transit not enforced for backup transfers"
      remediation: "Require TLS for all backup data transfers"

    - id: "DD-BE-MED-002"
      signal: "Key access not logged"
      remediation: "Enable CloudTrail or equivalent for key usage logging"

  low:
    - id: "DD-BE-LOW-001"
      signal: "Encryption algorithm not documented"

  positive:
    - id: "DD-BE-POS-001"
      signal: "HSM-backed key management for backup encryption"
    - id: "DD-BE-POS-002"
      signal: "Separate encryption keys with automatic rotation"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Verify Encryption at Rest"
      description: |
        Confirm all backup storage has encryption enabled.
      duration_estimate: "30 min"
      commands:
        - purpose: "Check S3 encryption"
          command: "aws s3api get-bucket-encryption --bucket backup-bucket"
        - purpose: "Check EBS snapshot encryption"
          command: "aws ec2 describe-snapshots --owner-ids self --query 'Snapshots[*].[SnapshotId,Encrypted]'"
      expected_findings:
        - "Encryption status per backup store"
        - "Encryption algorithm used"

    - id: "2"
      name: "Review Key Management"
      description: |
        Examine how encryption keys are managed and protected.
      duration_estimate: "30 min"
      commands:
        - purpose: "List KMS keys used for backups"
          command: "aws kms list-keys"
        - purpose: "Check key rotation"
          command: "aws kms get-key-rotation-status --key-id key-id"
      expected_findings:
        - "Key management approach"
        - "Key rotation status"

    - id: "3"
      name: "Verify Key Recovery"
      description: |
        Confirm keys can be recovered if primary access is lost.
      duration_estimate: "30 min"
      questions:
        - "Is there key escrow or backup?"
        - "Who can recover keys in emergency?"
        - "Has key recovery been tested?"
      expected_findings:
        - "Key recovery procedures"
        - "Test results"

    - id: "4"
      name: "Test Encrypted Backup Recovery"
      description: |
        Verify encrypted backups can be successfully restored.
      duration_estimate: "30 min"
      questions:
        - "Has encrypted backup restoration been tested?"
        - "Are restoration procedures documented?"
      expected_findings:
        - "Restoration test results"
        - "Procedure documentation"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Encryption Configuration Review"
        - "Key Management Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Full configuration review with recovery testing"
    medium: "Configuration review without testing"
    low: "Documentation review only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "aws-kms"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires security-focused analysis"
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1

closeout_checklist:
  - id: "backup-encryption-001"
    item: "All backup storage encrypted at rest"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify encryption configuration for all backup locations"
    expected: "Confirmed by reviewer"

  - id: "backup-encryption-002"
    item: "Key recovery procedure exists and tested"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Review key escrow and recovery documentation"
    expected: "Confirmed by reviewer"

  - id: "backup-encryption-003"
    item: "Encrypted backup restoration tested"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Review restoration test records"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["CC6.1", "CC6.7"]
    - framework: "HIPAA"
      controls: ["164.312(a)(2)(iv)"]
    - framework: "PCI DSS"
      controls: ["3.4", "3.5"]

relationships:
  commonly_combined:
    - "reliability-resilience.data-durability.immutable-storage"
    - "reliability-resilience.data-durability.snapshot-strategy"
