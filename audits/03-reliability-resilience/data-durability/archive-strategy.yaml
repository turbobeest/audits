# ============================================================
# AUDIT: Archive Strategy Audit
# ============================================================

audit:
  id: "reliability-resilience.data-durability.archive-strategy"
  name: "Archive Strategy Audit"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "reliability-resilience"
  category_number: 3
  subcategory: "data-durability"

  tier: "expert"
  estimated_duration: "2.5 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "data"

  default_profiles:
    - "full"
    - "production"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the strategy for archiving data including lifecycle policies,
    archive storage tiers, retrieval procedures, and long-term preservation.
    Examines the balance between storage costs, retrieval time, and data
    retention requirements.

  why_it_matters: |
    Proper archiving reduces storage costs while maintaining access to
    historical data for compliance, analytics, and disaster recovery.
    Poor archive strategies result in either excessive costs (keeping
    everything in hot storage) or data loss (premature deletion). Archive
    retrieval times must align with business needs.

  when_to_run:
    - "During storage cost optimization"
    - "When implementing data lifecycle policies"
    - "During compliance reviews"
    - "When data volumes are growing significantly"

prerequisites:
  required_artifacts:
    - type: "documentation"
      description: "Data retention policy"
    - type: "infrastructure"
      description: "Storage lifecycle configuration"

  access_requirements:
    - "Storage system admin access"
    - "Access to data retention policies"

discovery:
  code_patterns:
    - pattern: "lifecycle|archive|glacier|cold.*storage|transition|expiration"
      type: "regex"
      scope: "config"
      purpose: "Find archive configuration"

  file_patterns:
    - glob: "**/terraform/**/*.tf"
      purpose: "Infrastructure as code"
    - glob: "**/lifecycle*.json"
      purpose: "Lifecycle policy files"

knowledge_sources:
  specifications:
    - id: "s3-lifecycle"
      name: "Amazon S3 Lifecycle Configuration"
      url: "https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lifecycle-mgmt.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "data-lifecycle"
      name: "Data Lifecycle Management Best Practices"
      url: "https://docs.aws.amazon.com/wellarchitected/latest/cost-optimization-pillar/data-lifecycle-management.html"
      offline_cache: true

tooling:
  infrastructure_tools:
    - tool: "aws cli"
      purpose: "Check S3 lifecycle policies"
      command: "aws s3api get-bucket-lifecycle-configuration --bucket bucket-name"
    - tool: "aws cli"
      purpose: "Check Glacier vault policies"
      command: "aws glacier get-vault-access-policy --vault-name vault-name"

signals:
  critical:
    - id: "DD-AS-CRIT-001"
      signal: "Data deleted before retention requirements met"
      evidence_indicators:
        - "Lifecycle expiration shorter than retention policy"
        - "No lifecycle policy causing manual deletion"
      explanation: |
        Premature deletion violates compliance requirements and
        eliminates historical data needed for recovery or analysis.
      remediation: "Align lifecycle expiration with retention requirements"

    - id: "DD-AS-CRIT-002"
      signal: "Archive data not retrievable"
      evidence_indicators:
        - "Archive retrieval never tested"
        - "Format obsolescence risks"
      explanation: |
        Archived data that cannot be retrieved provides no value
        and fails to meet retention obligations.
      remediation: "Test archive retrieval and maintain format compatibility"

  high:
    - id: "DD-AS-HIGH-001"
      signal: "No archive tier for infrequently accessed data"
      explanation: "All data in hot storage wastes money on rarely accessed data"
      remediation: "Implement lifecycle policies to move cold data to archive tiers"

    - id: "DD-AS-HIGH-002"
      signal: "Archive retrieval time not aligned with business needs"
      explanation: "Glacier Deep Archive may take 12+ hours to retrieve"
      remediation: "Choose archive tier based on acceptable retrieval time"

  medium:
    - id: "DD-AS-MED-001"
      signal: "Lifecycle policies not applied consistently"
      remediation: "Apply consistent lifecycle policies across all storage"

    - id: "DD-AS-MED-002"
      signal: "Archive access not monitored"
      remediation: "Monitor archive retrievals for unexpected access patterns"

  low:
    - id: "DD-AS-LOW-001"
      signal: "Archive strategy not documented"

  positive:
    - id: "DD-AS-POS-001"
      signal: "Automated lifecycle policies with appropriate transitions"
    - id: "DD-AS-POS-002"
      signal: "Regular archive retrieval testing"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Review Data Retention Requirements"
      description: |
        Document retention requirements for different data categories.
      duration_estimate: "30 min"
      questions:
        - "What are the regulatory retention requirements?"
        - "What are the business retention requirements?"
        - "What data can be safely deleted and when?"
      expected_findings:
        - "Retention requirements by data type"
        - "Compliance obligations"

    - id: "2"
      name: "Audit Lifecycle Policies"
      description: |
        Review configured lifecycle policies for all storage.
      duration_estimate: "40 min"
      commands:
        - purpose: "Get lifecycle configuration"
          command: "aws s3api get-bucket-lifecycle-configuration --bucket bucket-name"
      expected_findings:
        - "Lifecycle policies per bucket"
        - "Transition and expiration rules"

    - id: "3"
      name: "Verify Archive Retrieval"
      description: |
        Test or review archive retrieval capability and timing.
      duration_estimate: "40 min"
      questions:
        - "How long does archive retrieval take?"
        - "When was retrieval last tested?"
        - "Is the retrieval process documented?"
      expected_findings:
        - "Retrieval time per archive tier"
        - "Test results"

    - id: "4"
      name: "Analyze Cost Efficiency"
      description: |
        Review storage distribution across tiers and cost optimization.
      duration_estimate: "30 min"
      commands:
        - purpose: "Check storage class distribution"
          command: "aws s3api list-objects-v2 --bucket bucket-name --query 'Contents[].StorageClass' | sort | uniq -c"
      expected_findings:
        - "Data distribution by storage tier"
        - "Cost optimization opportunities"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Retention Requirements Analysis"
        - "Lifecycle Policy Review"
        - "Recommendations"

  confidence_guidance:
    high: "Policy review with retrieval testing"
    medium: "Policy review without testing"
    low: "Documentation review only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "s3-lifecycle"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive policy review"
    full:
      included: true
      priority: 2

closeout_checklist:
  - id: "archive-strategy-001"
    item: "Lifecycle policies align with retention requirements"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Compare lifecycle expiration to retention policy"
    expected: "Confirmed by reviewer"

  - id: "archive-strategy-002"
    item: "Archive retrieval tested and documented"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Review archive retrieval test records"
    expected: "Confirmed by reviewer"

  - id: "archive-strategy-003"
    item: "Appropriate archive tiers used for cost optimization"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Review storage tier distribution"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "GDPR"
      controls: ["Article 17 - Right to erasure"]
    - framework: "SOC 2"
      controls: ["C1.1"]

relationships:
  commonly_combined:
    - "reliability-resilience.data-durability.storage-redundancy"
    - "reliability-resilience.data-durability.backup-encryption"
