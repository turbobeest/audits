# ============================================================
# AUDIT: Cross-Region Replication Audit
# ============================================================
# Evaluates cross-region data replication for disaster recovery,
# ensuring data survives regional failures.
# ============================================================

# ============================================================
# SECTION 1: IDENTITY & METADATA
# ============================================================

audit:
  id: "reliability-resilience.disaster-recovery.cross-region-replication"

  name: "Cross-Region Replication Audit"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "reliability-resilience"
  category_number: 3
  subcategory: "disaster-recovery"

  tier: "expert"
  estimated_duration: "3 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

# ============================================================
# SECTION 2: EXECUTION CLASSIFICATION
# ============================================================

execution:
  automatable: "partial"

  severity: "high"

  scope: "infrastructure"

  default_profiles:
    - "full"
    - "production"

  blocks_phase: false
  parallelizable: true

# ============================================================
# SECTION 3: DESCRIPTION & RATIONALE
# ============================================================

description:
  what: |
    Evaluates cross-region data replication configurations including
    replication targets, lag monitoring, consistency guarantees, and
    failover capabilities. Assesses whether replication provides
    adequate protection against regional disasters.

  why_it_matters: |
    Regional disasters (natural disasters, data center failures, network
    partitions) can render entire regions unavailable. Without cross-region
    replication, data stored in affected regions may be inaccessible or
    lost. Cross-region replication is essential for true disaster recovery.

  when_to_run:
    - "Initial DR architecture design"
    - "After infrastructure changes"
    - "Annual DR planning review"
    - "Before multi-region deployment"

# ============================================================
# SECTION 4: PREREQUISITES
# ============================================================

prerequisites:
  required_artifacts:
    - type: "infrastructure_diagram"
      description: "Multi-region architecture documentation"
    - type: "configuration"
      description: "Replication configurations for databases and storage"
    - type: "documentation"
      description: "DR runbooks for regional failover"

  access_requirements:
    - "Read access to replication configurations"
    - "Access to replication monitoring dashboards"
    - "Cross-region infrastructure access"

# ============================================================
# SECTION 5: DISCOVERY SPECIFICATION
# ============================================================

discovery:
  file_patterns:
    - glob: "**/terraform/**/*replication*"
      purpose: "Infrastructure-as-code replication configs"
    - glob: "**/cloudformation/**/*replica*"
      purpose: "CloudFormation replica configurations"

  interviews:
    - role: "Platform/Infrastructure Engineers"
      questions:
        - "Which data stores have cross-region replication?"
        - "What is the typical replication lag?"
        - "How is replication failure detected and handled?"
      purpose: "Understand replication implementation"

  metrics_queries:
    - system: "CloudWatch"
      query: "ReplicaLag"
      purpose: "Monitor replication lag"
      threshold: "< 1 second for sync, < 5 min for async"

# ============================================================
# SECTION 6: EXTERNAL KNOWLEDGE SOURCES
# ============================================================

knowledge_sources:
  specifications:
    - id: "aws-multi-region"
      name: "AWS Multi-Region Architecture"
      url: "https://aws.amazon.com/solutions/implementations/multi-region-application-architecture/"
      offline_cache: true
      priority: "required"

  guides:
    - id: "gcp-multi-region"
      name: "Google Cloud Multi-Region Deployment"
      url: "https://cloud.google.com/architecture/multi-region-high-availability"
      offline_cache: true
    - id: "sre-book"
      name: "Site Reliability Engineering"
      url: "https://sre.google/sre-book/table-of-contents/"
      offline_cache: true

# ============================================================
# SECTION 7: TOOLING & AUTOMATION
# ============================================================

tooling:
  infrastructure_tools:
    - tool: "AWS CLI"
      purpose: "Check S3 replication configuration"
      command: "aws s3api get-bucket-replication --bucket BUCKET_NAME"
    - tool: "AWS CLI"
      purpose: "Check RDS read replica status"
      command: "aws rds describe-db-instances --query 'DBInstances[?ReadReplicaSourceDBInstanceIdentifier!=null]'"
    - tool: "gcloud"
      purpose: "Check Cloud SQL replica status"
      command: "gcloud sql instances list --filter='instanceType=READ_REPLICA_INSTANCE'"

  monitoring_queries:
    - system: "CloudWatch"
      query: "SELECT AVG(ReplicaLag) FROM SCHEMA(\"AWS/RDS\", DBInstanceIdentifier)"
      purpose: "Monitor cross-region replica lag"

# ============================================================
# SECTION 8: SIGNALS & FINDINGS TAXONOMY
# ============================================================

signals:
  critical:
    - id: "CRR-CRIT-001"
      signal: "Critical data stores have no cross-region replication"
      evidence_indicators:
        - "Primary database has no read replica in different region"
        - "S3 buckets without cross-region replication"
        - "Single-region data storage for critical systems"
      explanation: |
        Without cross-region replication, regional disasters result
        in complete data unavailability or potential data loss.
      remediation: "Configure cross-region replication for all critical data stores"

    - id: "CRR-CRIT-002"
      signal: "Replication is broken or has extreme lag"
      evidence_indicators:
        - "Replication lag exceeds hours"
        - "Replication errors not being addressed"
      explanation: |
        Broken replication provides no protection. The secondary region
        may have significantly outdated data unusable for recovery.
      remediation: "Investigate and fix replication issues immediately"

  high:
    - id: "CRR-HIGH-001"
      signal: "No replication lag monitoring or alerting"
      explanation: "Replication failures may go undetected until disaster strikes"
      remediation: "Implement replication lag monitoring with alerting"

    - id: "CRR-HIGH-002"
      signal: "Secondary region not tested for failover"
      explanation: "Untested failover may fail when actually needed"
      remediation: "Conduct regular failover tests to secondary region"

  medium:
    - id: "CRR-MED-001"
      signal: "Asynchronous replication used for zero-RPO requirements"
      remediation: "Implement synchronous replication or adjust RPO expectations"

    - id: "CRR-MED-002"
      signal: "Network path between regions not redundant"
      remediation: "Ensure multiple network paths for replication traffic"

  low:
    - id: "CRR-LOW-001"
      signal: "Cross-region replication costs not monitored"

  positive:
    - id: "CRR-POS-001"
      signal: "Comprehensive cross-region replication with lag monitoring"
    - id: "CRR-POS-002"
      signal: "Regular failover testing to secondary region"

# ============================================================
# SECTION 9: EXECUTION PROCEDURE
# ============================================================

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Replicated Resources"
      description: |
        Identify all data stores and systems with cross-region
        replication configured.
      duration_estimate: "45 min"
      commands:
        - purpose: "List S3 buckets with replication"
          command: "for bucket in $(aws s3api list-buckets --query 'Buckets[*].Name' --output text); do aws s3api get-bucket-replication --bucket $bucket 2>/dev/null && echo \"Bucket: $bucket has replication\"; done"
        - purpose: "List RDS replicas"
          command: "aws rds describe-db-instances --query 'DBInstances[*].[DBInstanceIdentifier,ReadReplicaSourceDBInstanceIdentifier,AvailabilityZone]'"
      expected_findings:
        - "List of resources with cross-region replication"
        - "Target regions for replication"

    - id: "2"
      name: "Assess Replication Configuration"
      description: |
        Review replication settings including sync/async mode,
        encryption, and conflict resolution.
      duration_estimate: "30 min"
      questions:
        - "Is replication synchronous or asynchronous?"
        - "Is data encrypted in transit and at rest?"
        - "How are conflicts resolved?"
      expected_findings:
        - "Replication mode by data store"
        - "Encryption status"

    - id: "3"
      name: "Evaluate Replication Lag"
      description: |
        Check current replication lag and historical patterns
        across all replicated resources.
      duration_estimate: "30 min"
      commands:
        - purpose: "Check RDS replica lag"
          command: "aws cloudwatch get-metric-statistics --namespace AWS/RDS --metric-name ReplicaLag --dimensions Name=DBInstanceIdentifier,Value=REPLICA_NAME --period 3600 --statistics Average --start-time $(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%S) --end-time $(date -u +%Y-%m-%dT%H:%M:%S)"
      expected_findings:
        - "Current and historical lag measurements"
        - "Lag patterns and anomalies"

    - id: "4"
      name: "Verify Failover Capability"
      description: |
        Assess whether the secondary region can actually serve
        as a failover target.
      duration_estimate: "45 min"
      questions:
        - "Can the secondary region be promoted to primary?"
        - "What is the expected failover time?"
        - "Has failover been tested?"
      expected_findings:
        - "Failover readiness assessment"
        - "Test results from previous failovers"

# ============================================================
# SECTION 10: OUTPUT SPECIFICATION
# ============================================================

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "replication_matrix"
      format: "table"
      columns:
        - "Resource"
        - "Primary Region"
        - "Secondary Region"
        - "Replication Type"
        - "Current Lag"
        - "Status"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Replication Coverage"
        - "Lag Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Replication configurations and metrics directly verified"
    medium: "Configuration reviewed without live metric verification"
    low: "Based on documentation without system access"

# ============================================================
# SECTION 11: OFFLINE SUPPORT
# ============================================================

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "aws-multi-region"
        priority: "required"

# ============================================================
# SECTION 12: PROFILES
# ============================================================

profiles:
  membership:
    quick:
      included: false
      reason: "Cross-region assessment requires infrastructure access"
    full:
      included: true
      priority: 1
    production:
      included: true
      priority: 1

# ============================================================
# SECTION 13: DETERMINISTIC VERIFICATION
# ============================================================

closeout_checklist:
  - id: "crr-001"
    item: "Critical databases have cross-region read replicas"
    level: "CRITICAL"
    verification: "aws rds describe-db-instances --query 'DBInstances[?ReadReplicaSourceDBInstanceIdentifier!=null].DBInstanceIdentifier' | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "crr-002"
    item: "Replication lag monitored with alerting configured"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Check CloudWatch alarms for ReplicaLag metric"
    expected: "Confirmed by reviewer"

  - id: "crr-003"
    item: "Cross-region failover tested within last 6 months"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Review failover test reports"
    expected: "Confirmed by reviewer"

  - id: "crr-004"
    item: "Replication encryption enabled for all cross-region traffic"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Verify TLS/encryption settings for replication"
    expected: "Confirmed by reviewer"

# ============================================================
# SECTION 14: GOVERNANCE
# ============================================================

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["A1.2", "A1.3"]
    - framework: "ISO 27001"
      controls: ["A.17.1.2"]

# ============================================================
# SECTION 15: RELATIONSHIPS
# ============================================================

relationships:
  commonly_combined:
    - "reliability-resilience.disaster-recovery.backup-strategy"
    - "reliability-resilience.disaster-recovery.recovery-point-objective"
    - "reliability-resilience.high-availability.multi-region-deployment"
