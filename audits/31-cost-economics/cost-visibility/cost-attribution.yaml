# ============================================================
# AUDIT: Cost Attribution
# Category: 31 - Cost & Economics
# Subcategory: cost-visibility
# ============================================================
# Evaluates the accuracy and completeness of cost attribution
# across organizational dimensions including teams, products,
# environments, and business units.
# ============================================================

audit:
  id: "cost-economics.cost-visibility.cost-attribution"
  name: "Cost Attribution Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "cost-economics"
  category_number: 31
  subcategory: "cost-visibility"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h
  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "organizational"

  default_profiles:
    - "full"
    - "finops"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit examines how effectively costs are attributed to their
    consumers across multiple dimensions: applications, teams, business
    units, environments, and projects. It evaluates attribution accuracy,
    identifies unattributed costs, and assesses the methodology used for
    shared cost distribution.

  why_it_matters: |
    Accurate cost attribution enables informed decision-making at all
    organizational levels. When costs cannot be traced to their source,
    teams lack accountability and cannot optimize their spending. Poor
    attribution leads to budget disputes, over-provisioning, and inability
    to measure true ROI of technology investments.

  when_to_run:
    - "Monthly financial close process"
    - "Before budget planning cycles"
    - "When implementing or updating FinOps practices"
    - "After organizational restructuring"
    - "During cloud cost optimization initiatives"

prerequisites:
  required_artifacts:
    - type: "cost-data"
      description: "Access to cloud billing data and cost management tools"
    - type: "organizational-hierarchy"
      description: "Current org chart and team/product mappings"
    - type: "attribution-rules"
      description: "Documented cost attribution methodology"

  access_requirements:
    - "Read access to cloud billing and cost management"
    - "Access to organizational hierarchy data"
    - "Read access to resource inventory"
    - "Access to attribution rule documentation"

discovery:
  api_queries:
    - provider: "AWS"
      service: "Cost Explorer"
      operation: "GetCostAndUsageWithResources"
      purpose: "Detailed cost data with resource-level attribution"
    - provider: "Azure"
      service: "Cost Management"
      operation: "Query"
      purpose: "Cost data with subscription and resource group attribution"
    - provider: "GCP"
      service: "BigQuery Billing Export"
      purpose: "Detailed billing data with project and label attribution"

  file_patterns:
    - glob: "**/cost-allocation/**/*.yaml"
      purpose: "Cost allocation rules and configurations"
    - glob: "**/finops/**/*.md"
      purpose: "FinOps documentation and processes"

knowledge_sources:
  specifications:
    - id: "finops-cost-allocation"
      name: "FinOps Foundation - Cost Allocation"
      url: "https://www.finops.org/framework/capabilities/cost-allocation/"
      offline_cache: true
      priority: "required"

  guides:
    - id: "aws-cost-allocation-tags"
      name: "AWS Cost Allocation Tags"
      url: "https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/cost-alloc-tags.html"
      offline_cache: true
    - id: "azure-cost-analysis"
      name: "Azure Cost Management Analysis"
      url: "https://docs.microsoft.com/azure/cost-management-billing/costs/quick-acm-cost-analysis"
      offline_cache: true

tooling:
  cost_management_tools:
    - tool: "AWS Cost Explorer"
      purpose: "Analyze cost attribution by dimensions"
    - tool: "Azure Cost Management"
      purpose: "Cost analysis with scope filtering"
    - tool: "GCP Billing Reports"
      purpose: "Project and label-based cost analysis"

  third_party_tools:
    - tool: "CloudHealth"
      purpose: "Multi-cloud cost attribution and reporting"
    - tool: "Kubecost"
      purpose: "Kubernetes cost attribution"
    - tool: "Spot.io"
      purpose: "Cloud cost visibility and attribution"

signals:
  critical:
    - id: "ATTR-CRIT-001"
      signal: "More than 25% of costs cannot be attributed to any owner"
      evidence_threshold: "unattributed_cost_percentage > 25%"
      explanation: |
        When a quarter or more of cloud spend has no clear owner, the
        organization cannot hold teams accountable or make informed
        optimization decisions. This indicates fundamental gaps in
        cost governance.
      remediation: "Implement comprehensive attribution strategy with tagging enforcement"

    - id: "ATTR-CRIT-002"
      signal: "No documented cost attribution methodology"
      evidence_pattern: "Missing attribution rules or methodology documentation"
      explanation: |
        Without documented rules for how costs are attributed, decisions
        become arbitrary and inconsistent. This leads to disputes and
        undermines trust in cost data.
      remediation: "Document and communicate cost attribution methodology"

  high:
    - id: "ATTR-HIGH-001"
      signal: "Shared costs distributed without documented methodology"
      evidence_pattern: "Shared services costs allocated arbitrarily"
      explanation: |
        Shared infrastructure costs (databases, networking, security)
        must be allocated using fair and transparent methods. Ad-hoc
        allocation creates disputes and misaligned incentives.
      remediation: "Implement documented shared cost allocation methodology"

    - id: "ATTR-HIGH-002"
      signal: "Attribution dimensions not aligned with business structure"
      evidence_pattern: "Cost centers/tags do not match organizational hierarchy"
      explanation: |
        When attribution dimensions do not match how the business is
        organized, reports cannot provide actionable insights to
        decision-makers.
      remediation: "Align attribution taxonomy with organizational structure"

  medium:
    - id: "ATTR-MED-001"
      signal: "Attribution granularity insufficient for optimization"
      evidence_pattern: "Costs attributed at too high a level"
      remediation: "Increase attribution granularity to enable targeted optimization"

    - id: "ATTR-MED-002"
      signal: "Lag in attribution data exceeds 48 hours"
      evidence_threshold: "data_freshness > 48 hours"
      remediation: "Improve data pipeline for near-real-time attribution"

  low:
    - id: "ATTR-LOW-001"
      signal: "Attribution metadata not validated for accuracy"
      evidence_pattern: "No validation process for attribution data quality"
      remediation: "Implement attribution data quality checks"

  positive:
    - id: "ATTR-POS-001"
      signal: "Greater than 95% of costs attributed with high confidence"
    - id: "ATTR-POS-002"
      signal: "Multi-dimensional attribution enables flexible analysis"
    - id: "ATTR-POS-003"
      signal: "Real-time attribution dashboard available to stakeholders"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Review attribution methodology"
      description: |
        Examine documented methodology for cost attribution including
        rules for direct costs, shared costs, and support costs.
      duration_estimate: "45 min"
      expected_findings:
        - "Attribution methodology documentation"
        - "Shared cost distribution rules"
        - "Attribution dimension hierarchy"

    - id: "2"
      name: "Assess attribution coverage"
      description: |
        Calculate the percentage of total costs that can be attributed
        to each dimension (team, product, environment, etc.).
      duration_estimate: "60 min"
      expected_findings:
        - "Attribution coverage by dimension"
        - "Unattributed cost analysis"
        - "Coverage gaps by cost category"

    - id: "3"
      name: "Validate attribution accuracy"
      description: |
        Sample attributed costs to verify accuracy of the attribution.
        Check for misattributions and classification errors.
      duration_estimate: "60 min"
      expected_findings:
        - "Attribution accuracy assessment"
        - "Common misattribution patterns"

    - id: "4"
      name: "Analyze shared cost distribution"
      description: |
        Evaluate how shared costs (platforms, infrastructure, support)
        are distributed across consumers.
      duration_estimate: "45 min"
      expected_findings:
        - "Shared cost allocation methodology"
        - "Fairness assessment of distribution"

    - id: "5"
      name: "Evaluate attribution timeliness"
      description: |
        Assess the lag between cost incurrence and attribution
        availability for decision-making.
      duration_estimate: "30 min"
      expected_findings:
        - "Data freshness metrics"
        - "Attribution pipeline performance"

    - id: "6"
      name: "Review stakeholder access"
      description: |
        Verify that cost owners have access to their attributed costs
        and can drill down into details.
      duration_estimate: "30 min"
      expected_findings:
        - "Stakeholder access assessment"
        - "Self-service capability evaluation"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Attribution Coverage Analysis"
        - "Methodology Assessment"
        - "Shared Cost Distribution Review"
        - "Recommendations"

    - type: "metrics_dashboard"
      metrics:
        - "Attribution coverage by dimension"
        - "Unattributed cost percentage"
        - "Attribution accuracy score"
        - "Data freshness (lag time)"

  confidence_guidance:
    high: "Complete billing data with verified attribution rules"
    medium: "Sampling-based validation with documented methodology"
    low: "Limited data access or undocumented methodology"

offline:
  capability: "minimal"

  cache_manifest:
    knowledge:
      - source_id: "finops-cost-allocation"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive data analysis"
    full:
      included: true
      priority: 1
    finops:
      included: true
      priority: 1

closeout_checklist:
  - id: "attr-001"
    item: "Attribution methodology documented"
    level: "CRITICAL"
    verification: "manual"
    expected: "Documentation available and current"

  - id: "attr-002"
    item: "Attribution coverage exceeds 90%"
    level: "BLOCKING"
    verification: "automated"
    expected: "attributed_percentage >= 0.90"

  - id: "attr-003"
    item: "Shared cost allocation methodology fair and transparent"
    level: "WARNING"
    verification: "manual"
    expected: "Methodology documented and approved"

  - id: "attr-004"
    item: "Cost owners have access to their attributed costs"
    level: "WARNING"
    verification: "manual"
    expected: "Self-service access confirmed"

governance:
  applicable_to:
    archetypes:
      - "cloud-native"
      - "hybrid"
      - "enterprise"

  compliance_frameworks:
    - framework: "FinOps Foundation"
      controls: ["Cost Allocation", "Data Analysis and Showback"]
    - framework: "ITIL"
      controls: ["Financial Management"]

relationships:
  commonly_combined:
    - "cost-economics.cost-visibility.resource-tagging"
    - "cost-economics.cost-allocation.chargeback"
    - "cost-economics.cost-allocation.showback"
