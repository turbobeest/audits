audit:
  id: cloud-infrastructure.storage.storage-replication
  name: Storage Replication
  version: 1.0.0
  last_updated: '2026-01-19'
  status: active
  category: cloud-infrastructure
  category_number: 12
  subcategory: storage
  tier: phd
  estimated_duration: 2-3 hours  # median: 2h
  completeness: requires_discovery
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: critical
  scope: infrastructure
  default_profiles:
  - full
  - production
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Evaluates storage replication configurations including S3 cross-region
    replication, EBS snapshots, database replicas, and backup strategies.
    Examines replication lag, recovery point objectives (RPO), and recovery
    time objectives (RTO) alignment with business requirements.
  why_it_matters: |
    Data loss from storage failures, accidental deletion, or regional outages
    can be catastrophic without proper replication. Replication provides both
    disaster recovery capability and data durability. Organizations without
    tested replication have lost months of data during cloud region failures.
    Proper replication enables meeting RPO/RTO commitments.
  when_to_run:
  - Disaster recovery planning
  - After architecture changes
  - Compliance assessments
  - Quarterly DR testing
prerequisites:
  required_artifacts:
  - type: cloud_access
    description: Read access to storage and replication configurations
  - type: dr_requirements
    description: RPO/RTO requirements documentation
  access_requirements:
  - S3 replication configuration access
  - EBS snapshot access
  - RDS replica and backup access
  - Cross-region access if applicable
discovery:
  metrics_queries:
  - system: CloudWatch
    query: |
      SELECT MAX(ReplicationLatency)
      FROM S3
      WHERE BucketName = '{bucket}'
    purpose: Monitor replication lag
    threshold: Lag > RPO indicates replication issue
  - system: CloudWatch
    query: |
      SELECT AVG(ReplicaLag)
      FROM RDS
      WHERE DBInstanceIdentifier = '{replica}'
    purpose: Monitor database replica lag
    threshold: Lag > 60s may indicate performance issues
  file_patterns:
  - glob: '**/terraform/**/*replication*.tf'
    purpose: Find Terraform replication configurations
  - glob: '**/terraform/**/*backup*.tf'
    purpose: Find backup configurations
  - glob: '**/dr/**/*.yaml'
    purpose: Find DR configuration files
knowledge_sources:
  specifications:
  - id: aws-s3-replication
    name: AWS S3 Replication
    url: https://docs.aws.amazon.com/AmazonS3/latest/userguide/replication.html
    offline_cache: true
    priority: required
  - id: aws-ebs-snapshots
    name: AWS EBS Snapshots
    url: https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSSnapshots.html
    offline_cache: true
    priority: required
  - id: aws-rds-replicas
    name: AWS RDS Read Replicas
    url: https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_ReadRepl.html
    offline_cache: true
    priority: required
  guides:
  - id: aws-dr-whitepaper
    name: AWS Disaster Recovery Workloads
    url: https://docs.aws.amazon.com/whitepapers/latest/disaster-recovery-workloads-on-aws/
    offline_cache: true
  - id: backup-best-practices
    name: AWS Backup Best Practices
    url: https://docs.aws.amazon.com/aws-backup/latest/devguide/best-practices.html
    offline_cache: true
tooling:
  infrastructure_tools:
  - tool: AWS CLI
    purpose: Check S3 replication configuration
    command: aws s3api get-bucket-replication --bucket {bucket_name}
  - tool: AWS CLI
    purpose: List EBS snapshots
    command: aws ec2 describe-snapshots --owner-ids self --query 'Snapshots[].{ID:SnapshotId,Volume:VolumeId,Created:StartTime,State:State}'
  - tool: AWS CLI
    purpose: Check RDS replicas
    command: aws rds describe-db-instances --query 'DBInstances[].{ID:DBInstanceIdentifier,ReadReplicas:ReadReplicaDBInstanceIdentifiers,ReplicaOf:ReadReplicaSourceDBInstanceIdentifier}'
  - tool: AWS Backup
    purpose: Check backup plans
    command: aws backup list-backup-plans
  scripts:
  - id: replication-audit
    language: bash
    purpose: Audit storage replication configurations
    source: inline
    code: |
      #!/bin/bash
      echo "=== Storage Replication Audit ==="

      # S3 Cross-Region Replication
      echo "S3 Replication Configuration:"
      for bucket in $(aws s3api list-buckets --query 'Buckets[].Name' --output text); do
        replication=$(aws s3api get-bucket-replication --bucket "$bucket" 2>&1)
        if echo "$replication" | grep -q "ReplicationConfigurationNotFoundError"; then
          echo "NO REPLICATION: $bucket"
        else
          dest=$(echo "$replication" | jq -r '.ReplicationConfiguration.Rules[0].Destination.Bucket // "unknown"')
          echo "REPLICATED to $dest: $bucket"
        fi
      done

      # EBS Snapshots
      echo ""
      echo "EBS Snapshot Summary:"
      aws ec2 describe-snapshots --owner-ids self \
        --query 'Snapshots | sort_by(@, &StartTime) | [-10:].{ID:SnapshotId,Volume:VolumeId,Created:StartTime}' \
        --output table

      # RDS Backups
      echo ""
      echo "RDS Backup Configuration:"
      aws rds describe-db-instances \
        --query 'DBInstances[].{ID:DBInstanceIdentifier,BackupRetention:BackupRetentionPeriod,BackupWindow:PreferredBackupWindow}' \
        --output table

      # AWS Backup Plans
      echo ""
      echo "AWS Backup Plans:"
      aws backup list-backup-plans \
        --query 'BackupPlansList[].{Name:BackupPlanName,ID:BackupPlanId}' \
        --output table
signals:
  critical:
  - id: REPLICATION-CRIT-001
    signal: Critical data without any replication or backup
    evidence_indicators:
    - S3 buckets without replication or versioning
    - EBS volumes without snapshots
    - RDS instances with 0-day backup retention
    explanation: |
      Data without replication or backup is at risk of permanent loss
      from hardware failures, accidental deletion, or ransomware.
      This violates most compliance frameworks and business continuity
      requirements.
    remediation: Implement replication or backup immediately for all critical data
  - id: REPLICATION-CRIT-002
    signal: Replication to same region only (no cross-region protection)
    evidence_pattern: Replication destination in same region as source
    explanation: |
      Same-region replication does not protect against regional outages.
      AWS regions have experienced multi-hour or multi-day failures.
      Critical data needs cross-region replication for true DR.
    remediation: Configure cross-region replication for critical data
  - id: REPLICATION-CRIT-003
    signal: Replication lag exceeds RPO requirements
    evidence_threshold: ReplicationLatency > defined RPO
    explanation: |
      Replication lag beyond RPO means potential data loss in a
      failover scenario. This indicates insufficient bandwidth,
      large objects, or replication configuration issues.
    remediation: Investigate and resolve replication lag; consider S3 Replication Time Control
  high:
  - id: REPLICATION-HIGH-001
    signal: Database backups not retained long enough
    evidence_threshold: BackupRetentionPeriod < 7 days
    explanation: |
      Short backup retention limits recovery options for discovered
      data corruption or delayed incident detection.
    remediation: Increase backup retention period to meet RPO requirements
  - id: REPLICATION-HIGH-002
    signal: EBS snapshots not automated
    evidence_indicators:
    - No Data Lifecycle Manager policies
    - Manual snapshot creation only
    explanation: |
      Manual snapshots are often forgotten or inconsistent.
      Automated snapshots ensure regular, reliable backups.
    remediation: Implement DLM policies for automated EBS snapshots
  - id: REPLICATION-HIGH-003
    signal: Replication not tested or validated
    evidence_indicators:
    - No DR test documentation
    - Replication never used for recovery
    explanation: |
      Untested replication may fail when needed due to configuration
      drift, permission issues, or incomplete data.
    remediation: Implement regular DR testing with documented results
  medium:
  - id: REPLICATION-MED-001
    signal: S3 versioning not enabled for important buckets
    remediation: Enable versioning to protect against accidental deletion
  - id: REPLICATION-MED-002
    signal: No point-in-time recovery for databases
    remediation: Enable PITR for granular recovery capability
  - id: REPLICATION-MED-003
    signal: Backup windows overlap with peak usage
    remediation: Schedule backups during low-traffic periods
  low:
  - id: REPLICATION-LOW-001
    signal: Replication metrics not monitored
    remediation: Implement alerting for replication lag and failures
  positive:
  - id: REPLICATION-POS-001
    signal: Cross-region replication with RTC for critical data
  - id: REPLICATION-POS-002
    signal: Regular DR testing with documented recovery times
  - id: REPLICATION-POS-003
    signal: AWS Backup with centralized management
procedure:
  context:
    cognitive_mode: critical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: S3 Replication Assessment
    description: |
      Audit S3 bucket replication configurations including
      cross-region replication and versioning.
    duration_estimate: 30 min
    commands:
    - purpose: Check bucket replication and versioning
      command: for bucket in $(aws s3api list-buckets --query 'Buckets[].Name' --output text); do echo
        "=== $bucket ==="; echo 'Versioning:'; aws s3api get-bucket-versioning --bucket $bucket; echo
        'Replication:'; aws s3api get-bucket-replication --bucket $bucket 2>&1 | head -20; done
    expected_findings:
    - Replication configuration per bucket
    - Versioning status
  - id: '2'
    name: EBS Backup Assessment
    description: |
      Audit EBS volume snapshot configurations and DLM policies.
    duration_estimate: 20 min
    commands:
    - purpose: List DLM policies
      command: aws dlm get-lifecycle-policies --query 'Policies[].{ID:PolicyId,State:State,Description:Description}'
        --output table
    - purpose: Check recent snapshots
      command: aws ec2 describe-snapshots --owner-ids self --query 'Snapshots | sort_by(@, &StartTime)
        | [-20:].{ID:SnapshotId,Volume:VolumeId,Created:StartTime,State:State}' --output table
    expected_findings:
    - DLM policy coverage
    - Snapshot freshness
  - id: '3'
    name: Database Replication Assessment
    description: |
      Audit RDS backup configurations and read replicas.
    duration_estimate: 30 min
    commands:
    - purpose: Check RDS backup settings
      command: aws rds describe-db-instances --query 'DBInstances[].{ID:DBInstanceIdentifier,Engine:Engine,Retention:BackupRetentionPeriod,MultiAZ:MultiAZ,Replicas:ReadReplicaDBInstanceIdentifiers}'
        --output table
    - purpose: Check replica lag
      command: aws cloudwatch get-metric-statistics --namespace AWS/RDS --metric-name ReplicaLag --dimensions
        Name=DBInstanceIdentifier,Value={replica_id} --start-time $(date -d '1 hour ago' -u +%Y-%m-%dT%H:%M:%SZ)
        --end-time $(date -u +%Y-%m-%dT%H:%M:%SZ) --period 300 --statistics Maximum
    expected_findings:
    - Backup retention periods
    - Replica configuration and lag
  - id: '4'
    name: AWS Backup Assessment
    description: |
      Review centralized backup plans and vault configurations.
    duration_estimate: 20 min
    commands:
    - purpose: List backup plans
      command: aws backup list-backup-plans --query 'BackupPlansList[].{ID:BackupPlanId,Name:BackupPlanName,Created:CreationDate}'
        --output table
    - purpose: List backup vaults
      command: aws backup list-backup-vaults --query 'BackupVaultList[].{Name:BackupVaultName,Records:NumberOfRecoveryPoints}'
        --output table
    expected_findings:
    - Backup plan coverage
    - Recovery point inventory
  - id: '5'
    name: RPO/RTO Alignment
    description: |
      Compare actual replication/backup configurations against
      documented RPO/RTO requirements.
    duration_estimate: 30 min
    questions:
    - What are the documented RPO/RTO requirements?
    - Do current configurations meet these requirements?
    - When was DR testing last performed?
    expected_findings:
    - RPO/RTO gap analysis
    - DR readiness assessment
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Replication Coverage Analysis
    - Backup Assessment
    - RPO/RTO Alignment
    - DR Readiness
    - Recommendations
  confidence_guidance:
    high: Full access to replication configs, documented RPO/RTO, DR test results
    medium: Config access with partial requirements documentation
    low: Limited access or no documented requirements
offline:
  capability: partial
  cache_manifest:
    knowledge:
    - source_id: aws-s3-replication
      priority: required
    - source_id: aws-dr-whitepaper
      priority: required
  limitations:
  - Cannot verify live replication status offline
  - Replication lag metrics require runtime access
profiles:
  membership:
    quick:
      included: true
      reason: Critical for data protection assessment
    full:
      included: true
      priority: 1
    production:
      included: true
      priority: 1
closeout_checklist:
- id: replication-001
  item: Critical data replication verified
  level: CRITICAL
  verification: manual
  verification_notes: Confirm all critical data has replication or backup
  expected: Confirmed by reviewer
- id: replication-002
  item: Cross-region replication for DR
  level: CRITICAL
  verification: manual
  verification_notes: Verify cross-region replication for critical workloads
  expected: Confirmed by reviewer
- id: replication-003
  item: Database backups configured
  level: CRITICAL
  verification: aws rds describe-db-instances --query 'DBInstances[?BackupRetentionPeriod==`0`]' --output
    text | grep -q . && echo FAIL || echo PASS
  expected: PASS
- id: replication-004
  item: RPO/RTO requirements documented and met
  level: BLOCKING
  verification: manual
  verification_notes: Verify configurations align with documented requirements
  expected: Confirmed by reviewer
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: SOC 2
    controls:
    - CC7.5
    - A1.2
  - framework: ISO 27001
    controls:
    - A.12.3.1
    - A.17.1.1
  - framework: HIPAA
    controls:
    - 164.308(a)(7)(ii)(A)
relationships:
  commonly_combined:
  - cloud-infrastructure.storage.storage-encryption
  - cloud-infrastructure.compute.compute-redundancy
  - disaster-recovery.backup-verification
