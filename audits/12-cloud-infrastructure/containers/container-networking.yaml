audit:
  id: cloud-infrastructure.containers.container-networking
  name: Container Networking
  version: 1.0.0
  last_updated: '2026-01-19'
  status: active
  category: cloud-infrastructure
  category_number: 12
  subcategory: containers
  tier: phd
  estimated_duration: 2-3 hours  # median: 2h
  completeness: complete
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: high
  scope: infrastructure
  default_profiles:
  - full
  - security
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Examines container networking configurations including network policies,
    service exposure, ingress configurations, CNI plugin settings, pod-to-pod
    communication, egress controls, and DNS configurations. Evaluates network
    segmentation, encryption in transit, and exposure of services to external
    networks.
  why_it_matters: |
    Container networking misconfigurations can expose services to unauthorized
    access, enable lateral movement after compromise, and create data exfiltration
    paths. Proper network segmentation is essential for defense in depth.
    Incorrect service exposure can unintentionally make internal services
    accessible from the internet.
  when_to_run:
  - Before deploying new services to production
  - After network-related security incidents
  - During security architecture reviews
  - When implementing network policies or service mesh
prerequisites:
  required_artifacts:
  - type: kubernetes-cluster
    description: Access to running Kubernetes cluster
  - type: network-configs
    description: Network policies, services, and ingress configurations
  access_requirements:
  - kubectl access with network policy permissions
  - Access to CNI configuration
  - Ability to inspect service and ingress resources
discovery:
  file_patterns:
  - glob: '**/networkpolicy*.yaml'
    purpose: Network policy definitions
  - glob: '**/service*.yaml'
    purpose: Service definitions
  - glob: '**/ingress*.yaml'
    purpose: Ingress configurations
  - glob: '**/gateway*.yaml'
    purpose: Gateway API configurations
  - glob: '**/egress*.yaml'
    purpose: Egress configurations
  code_patterns:
  - pattern: type:\s*LoadBalancer
    type: regex
    scope: config
    purpose: Detect public load balancer services
  - pattern: type:\s*NodePort
    type: regex
    scope: config
    purpose: Detect NodePort services
  - pattern: hostNetwork:\s*true
    type: regex
    scope: config
    purpose: Detect host network usage
  - pattern: externalTrafficPolicy
    type: keyword
    scope: config
    purpose: Check traffic policy configurations
knowledge_sources:
  specifications:
  - id: k8s-network-policies
    name: Kubernetes Network Policies
    url: https://kubernetes.io/docs/concepts/services-networking/network-policies/
    offline_cache: true
    priority: required
  - id: cni-spec
    name: CNI Specification
    url: https://github.com/containernetworking/cni/blob/main/SPEC.md
    offline_cache: true
    priority: recommended
  - id: cis-kubernetes
    name: CIS Kubernetes Benchmark
    url: https://www.cisecurity.org/benchmark/kubernetes
    offline_cache: true
    priority: required
  - id: nsa-kubernetes
    name: NSA Kubernetes Hardening Guide
    url: https://media.defense.gov/2022/Aug/29/2003066362/-1/-1/0/CTR_KUBERNETES_HARDENING_GUIDANCE_1.2_20220829.PDF
    offline_cache: true
    priority: required
  guides:
  - id: k8s-services
    name: Kubernetes Services
    url: https://kubernetes.io/docs/concepts/services-networking/service/
    offline_cache: true
  - id: k8s-ingress
    name: Kubernetes Ingress
    url: https://kubernetes.io/docs/concepts/services-networking/ingress/
    offline_cache: true
tooling:
  infrastructure_tools:
  - tool: kubectl
    purpose: Inspect network configurations
    command: kubectl get networkpolicies -A
  - tool: kubectl-netpol
    purpose: Visualize network policies
    command: kubectl-netpol visualize
  - tool: cilium
    purpose: Advanced CNI with policy visualization
    command: cilium connectivity test
  scripts:
  - id: network-audit
    language: bash
    purpose: Basic network audit
    source: inline
    code: |
      #!/bin/bash
      echo "=== Namespaces without NetworkPolicies ==="
      for ns in $(kubectl get ns -o jsonpath='{.items[*].metadata.name}'); do
        count=$(kubectl get networkpolicies -n $ns --no-headers 2>/dev/null | wc -l)
        if [ "$count" -eq 0 ]; then
          echo "  $ns: No policies"
        fi
      done
      echo "=== External Services ==="
      kubectl get svc -A -o wide | grep -E 'LoadBalancer|NodePort'
      echo "=== Host Network Pods ==="
      kubectl get pods -A -o json | jq -r '.items[] | select(.spec.hostNetwork==true) | "\(.metadata.namespace)/\(.metadata.name)"'
signals:
  critical:
  - id: CONTAINER-NET-CRIT-001
    signal: No network policies in production namespaces
    evidence_pattern: Zero NetworkPolicy resources in namespace
    explanation: |
      Without network policies, all pods can communicate with each
      other by default. This enables lateral movement if any pod
      is compromised.
    remediation: Implement network policies with default-deny and explicit allows
  - id: CONTAINER-NET-CRIT-002
    signal: Internal services exposed via LoadBalancer
    evidence_pattern: 'Internal services with type: LoadBalancer'
    explanation: |
      LoadBalancer services create public endpoints. Internal services
      accidentally exposed can lead to unauthorized access.
    remediation: Use ClusterIP for internal services, LoadBalancer only when required
  - id: CONTAINER-NET-CRIT-003
    signal: Pods using host network without justification
    evidence_pattern: 'hostNetwork: true on non-system pods'
    explanation: |
      Host network bypasses container network isolation, exposing
      host network interfaces and potentially all node services.
    remediation: Remove hostNetwork unless absolutely required
  high:
  - id: CONTAINER-NET-HIGH-001
    signal: Overly permissive network policies
    evidence_pattern: Network policy with empty podSelector or allow-all ingress
    explanation: |
      Overly broad network policies provide little security benefit
      and may create false sense of security.
    remediation: Refine policies to allow only necessary traffic
  - id: CONTAINER-NET-HIGH-002
    signal: No egress controls
    evidence_pattern: Missing egress rules in network policies
    explanation: |
      Without egress controls, compromised pods can communicate with
      external command and control servers or exfiltrate data.
    remediation: Implement egress policies restricting outbound traffic
  - id: CONTAINER-NET-HIGH-003
    signal: Ingress without TLS termination
    evidence_pattern: Ingress resources without TLS configuration
    explanation: |
      Unencrypted ingress exposes traffic to interception and
      man-in-the-middle attacks.
    remediation: Configure TLS for all ingress resources
  medium:
  - id: CONTAINER-NET-MED-001
    signal: NodePort services in production
    evidence_pattern: 'Services with type: NodePort'
    remediation: Use LoadBalancer or Ingress instead of NodePort for production
  - id: CONTAINER-NET-MED-002
    signal: DNS policy not configured
    evidence_pattern: dnsPolicy not explicitly set
    remediation: Set appropriate dnsPolicy for pod requirements
  - id: CONTAINER-NET-MED-003
    signal: Services without selector
    evidence_pattern: Headless service or external service
    remediation: Verify headless/external services are intentional
  low:
  - id: CONTAINER-NET-LOW-001
    signal: Services using deprecated annotations
    remediation: Update to current ingress/service annotations
  - id: CONTAINER-NET-LOW-002
    signal: Missing network policy labels
    remediation: Add labels to support policy selection
  positive:
  - id: CONTAINER-NET-POS-001
    signal: Default-deny network policies in all namespaces
  - id: CONTAINER-NET-POS-002
    signal: Egress policies restrict outbound traffic
  - id: CONTAINER-NET-POS-003
    signal: All ingress uses TLS with valid certificates
procedure:
  context:
    cognitive_mode: critical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Inventory network policies
    description: |
      Collect all network policies and identify namespaces without
      policy coverage.
    duration_estimate: 20 min
    commands:
    - purpose: List all network policies
      command: kubectl get networkpolicies -A -o wide
    - purpose: Get policy details
      command: kubectl get networkpolicies -A -o yaml
    expected_findings:
    - Network policy coverage map
    - Namespaces without policies
  - id: '2'
    name: Analyze service exposure
    description: |
      Review all services to identify external exposure and
      potential misconfiguration.
    duration_estimate: 25 min
    commands:
    - purpose: List external services
      command: kubectl get svc -A -o wide | grep -E 'LoadBalancer|NodePort'
    - purpose: Get service details
      command: 'kubectl get svc -A -o json | jq ''.items[] | {namespace: .metadata.namespace, name: .metadata.name,
        type: .spec.type, ports: .spec.ports}'''
    expected_findings:
    - External service inventory
    - Potential over-exposure
  - id: '3'
    name: Review ingress configurations
    description: |
      Examine ingress resources for proper TLS configuration and
      path security.
    duration_estimate: 25 min
    commands:
    - purpose: List all ingress resources
      command: kubectl get ingress -A -o wide
    - purpose: Check TLS configuration
      command: 'kubectl get ingress -A -o json | jq ''.items[] | {namespace: .metadata.namespace, name:
        .metadata.name, tls: .spec.tls, rules: .spec.rules}'''
    expected_findings:
    - Ingress TLS status
    - Routing configuration review
  - id: '4'
    name: Check pod network settings
    description: |
      Review pod-level network configurations including hostNetwork
      and dnsPolicy.
    duration_estimate: 20 min
    commands:
    - purpose: Find host network pods
      command: 'kubectl get pods -A -o json | jq ''.items[] | select(.spec.hostNetwork==true) | {namespace:
        .metadata.namespace, name: .metadata.name}'''
    - purpose: Check DNS policies
      command: 'kubectl get pods -A -o json | jq ''.items[] | {name: .metadata.name, dnsPolicy: .spec.dnsPolicy}'''
    expected_findings:
    - Host network usage assessment
    - DNS configuration review
  - id: '5'
    name: Verify egress controls
    description: |
      Review egress policies and identify unrestricted outbound
      communication paths.
    duration_estimate: 20 min
    commands:
    - purpose: List egress policies
      command: 'kubectl get networkpolicies -A -o json | jq ''.items[] | select(.spec.egress != null)
        | {namespace: .metadata.namespace, name: .metadata.name, egress: .spec.egress}'''
    - purpose: Check for default deny egress
      command: 'kubectl get networkpolicies -A -o json | jq ''.items[] | select(.spec.policyTypes[] ==
        "Egress" and .spec.egress == null) | {namespace: .metadata.namespace, name: .metadata.name}'''
    expected_findings:
    - Egress policy coverage
    - Unrestricted egress paths
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Network Segmentation Analysis
    - Service Exposure Assessment
    - Recommendations
  confidence_guidance:
    high: Direct kubectl query results, policy analysis
    medium: Inferred from configuration patterns
    low: Based on absence of expected configurations
offline:
  capability: partial
  cache_manifest:
    knowledge:
    - source_id: k8s-network-policies
      priority: required
profiles:
  membership:
    quick:
      included: false
      reason: Requires live cluster analysis
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1
closeout_checklist:
- id: container-networking-001
  item: Network policies exist for all production namespaces
  level: CRITICAL
  verification: manual
  verification_notes: Verify each production namespace has at least one NetworkPolicy
  expected: Confirmed by reviewer
- id: container-networking-002
  item: No unauthorized external service exposure
  level: CRITICAL
  verification: kubectl get svc -A -o json | jq '[.items[] | select(.spec.type=="LoadBalancer")] | length'
  expected: Review each LoadBalancer service for authorization
- id: container-networking-003
  item: All ingress uses TLS
  level: BLOCKING
  verification: kubectl get ingress -A -o json | jq '[.items[] | select(.spec.tls == null)] | length'
    | awk '{print ($1==0)?"PASS":"FAIL"}'
  expected: PASS
- id: container-networking-004
  item: No non-system pods using host network
  level: BLOCKING
  verification: kubectl get pods -A -o json | jq '[.items[] | select(.spec.hostNetwork==true and .metadata.namespace!="kube-system")]
    | length' | awk '{print ($1==0)?"PASS":"FAIL"}'
  expected: PASS
- id: container-networking-005
  item: Egress policies implemented
  level: WARNING
  verification: kubectl get networkpolicies -A -o json | jq '[.items[] | select(.spec.policyTypes[]? ==
    "Egress")] | length' | awk '{print ($1>0)?"PASS":"FAIL"}'
  expected: PASS
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: SOC2
    controls:
    - CC6.1
    - CC6.6
  - framework: PCI-DSS
    controls:
    - '1.1'
    - '1.2'
    - '1.3'
  - framework: NIST-CSF
    controls:
    - PR.AC-5
    - PR.DS-5
relationships:
  commonly_combined:
  - cloud-infrastructure.containers.container-orchestration
  - cloud-infrastructure.service-mesh.service-mesh-security
  - cloud-infrastructure.cloud-security.encryption-in-transit
