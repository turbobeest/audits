# ============================================================
# AUDIT FILE: Compliance Controls
# ============================================================

audit:
  id: "cloud-infrastructure.cloud-security.compliance-controls"
  name: "Compliance Controls"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "cloud-infrastructure"
  category_number: 12
  subcategory: "cloud-security"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "infrastructure"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates cloud infrastructure compliance with regulatory frameworks
    and industry standards including SOC2, PCI-DSS, HIPAA, GDPR, ISO27001,
    and CIS Benchmarks. Examines security controls implementation, evidence
    collection, policy enforcement, and compliance automation tools.
    Maps technical controls to compliance requirements.

  why_it_matters: |
    Compliance failures can result in regulatory fines, legal liability,
    reputational damage, and loss of business. Many organizations are
    contractually required to maintain compliance certifications.
    Technical controls must be properly implemented and documented to
    satisfy audit requirements.

  when_to_run:
    - "Before compliance audits"
    - "After significant infrastructure changes"
    - "Quarterly compliance reviews"
    - "When onboarding new compliance requirements"

prerequisites:
  required_artifacts:
    - type: "cloud-account"
      description: "Access to cloud account configuration"
    - type: "compliance-scope"
      description: "Defined compliance requirements and scope"

  access_requirements:
    - "Broad read access to cloud configuration"
    - "Access to security services (Config, Security Hub, etc.)"
    - "Access to compliance documentation"

discovery:
  file_patterns:
    - glob: "**/config-rules*.yaml"
      purpose: "AWS Config rule configurations"
    - glob: "**/compliance*.yaml"
      purpose: "Compliance policy configurations"
    - glob: "**/security-hub*.tf"
      purpose: "Security Hub configurations"

  code_patterns:
    - pattern: "compliance_resource_types"
      type: "keyword"
      scope: "config"
      purpose: "Find compliance resource configurations"
    - pattern: "conformance_pack"
      type: "keyword"
      scope: "config"
      purpose: "Find conformance pack configurations"

knowledge_sources:
  specifications:
    - id: "cis-aws"
      name: "CIS AWS Foundations Benchmark"
      url: "https://www.cisecurity.org/benchmark/amazon_web_services"
      offline_cache: true
      priority: "required"
    - id: "pci-dss"
      name: "PCI DSS Requirements"
      url: "https://www.pcisecuritystandards.org/document_library"
      offline_cache: true
      priority: "required"
    - id: "soc2"
      name: "SOC2 Trust Services Criteria"
      url: "https://www.aicpa.org/soc4so"
      offline_cache: true
      priority: "required"

  guides:
    - id: "aws-compliance"
      name: "AWS Compliance Programs"
      url: "https://aws.amazon.com/compliance/programs/"
      offline_cache: true
    - id: "security-hub"
      name: "AWS Security Hub"
      url: "https://docs.aws.amazon.com/securityhub/latest/userguide/"
      offline_cache: true

tooling:
  infrastructure_tools:
    - tool: "aws-cli"
      purpose: "Query compliance status"
      command: "aws securityhub get-findings"
    - tool: "prowler"
      purpose: "Multi-framework compliance assessment"
      command: "prowler aws --compliance cis_level2_aws"
    - tool: "ScoutSuite"
      purpose: "Cloud security auditing"
      command: "scout aws"
    - tool: "aws-config"
      purpose: "Compliance rule evaluation"
      command: "aws configservice get-compliance-summary-by-config-rule"

  scripts:
    - id: "compliance-audit"
      language: "bash"
      purpose: "Compliance status check"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Security Hub Standards ==="
        aws securityhub get-enabled-standards --query 'StandardsSubscriptions[*].[StandardsArn,StandardsStatus]' --output table
        echo "=== Compliance Summary ==="
        aws securityhub get-findings --filters '{"ComplianceStatus": [{"Value": "FAILED", "Comparison": "EQUALS"}]}' --query 'Findings | length(@)'
        echo "=== Config Rule Compliance ==="
        aws configservice get-compliance-summary-by-config-rule

signals:
  critical:
    - id: "COMPLIANCE-CRIT-001"
      signal: "Critical compliance controls failing"
      evidence_pattern: "Security Hub critical findings or Config rule violations"
      explanation: |
        Critical control failures indicate significant gaps in security
        posture that will likely fail compliance audits and create
        real security risk.
      remediation: "Address critical findings immediately, document remediation"
    - id: "COMPLIANCE-CRIT-002"
      signal: "No compliance monitoring enabled"
      evidence_pattern: "Security Hub or Config not enabled"
      explanation: |
        Without continuous compliance monitoring, drift goes undetected.
        Point-in-time audits cannot ensure ongoing compliance.
      remediation: "Enable Security Hub and AWS Config for continuous monitoring"
    - id: "COMPLIANCE-CRIT-003"
      signal: "Data residency requirements violated"
      evidence_pattern: "Data stored in non-compliant regions"
      explanation: |
        Many regulations require data to stay within specific geographic
        boundaries. Violations can result in significant penalties.
      remediation: "Relocate data to compliant regions, enable region restrictions"

  high:
    - id: "COMPLIANCE-HIGH-001"
      signal: "Multiple high-severity findings"
      evidence_pattern: ">10 high severity Security Hub findings"
      explanation: |
        Accumulation of high-severity findings indicates systemic
        compliance issues that need attention.
      remediation: "Prioritize and remediate findings, establish regular review"
    - id: "COMPLIANCE-HIGH-002"
      signal: "Required compliance standards not enabled"
      evidence_pattern: "Applicable standards not enabled in Security Hub"
      explanation: |
        Compliance cannot be continuously assessed without enabling
        the relevant standards.
      remediation: "Enable required compliance standards (CIS, PCI-DSS, etc.)"
    - id: "COMPLIANCE-HIGH-003"
      signal: "Evidence collection not automated"
      evidence_pattern: "Manual compliance evidence gathering"
      explanation: |
        Manual evidence collection is error-prone, time-consuming,
        and may not capture point-in-time compliance state.
      remediation: "Implement automated evidence collection and retention"

  medium:
    - id: "COMPLIANCE-MED-001"
      signal: "Config rules not covering all requirements"
      evidence_pattern: "Gaps in Config rule coverage"
      remediation: "Deploy additional Config rules or conformance packs"
    - id: "COMPLIANCE-MED-002"
      signal: "Finding remediation not tracked"
      evidence_pattern: "Findings without remediation status or owner"
      remediation: "Implement finding tracking and assignment workflow"
    - id: "COMPLIANCE-MED-003"
      signal: "Compliance reports not regularly generated"
      evidence_pattern: "No scheduled compliance reports"
      remediation: "Configure automated compliance reporting"

  low:
    - id: "COMPLIANCE-LOW-001"
      signal: "Compliance documentation incomplete"
      remediation: "Complete compliance documentation for all controls"
    - id: "COMPLIANCE-LOW-002"
      signal: "Custom compliance rules not versioned"
      remediation: "Version control custom Config rules and policies"

  positive:
    - id: "COMPLIANCE-POS-001"
      signal: "All applicable standards enabled and passing"
    - id: "COMPLIANCE-POS-002"
      signal: "Automated evidence collection configured"
    - id: "COMPLIANCE-POS-003"
      signal: "Regular compliance reviews documented"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify compliance requirements"
      description: |
        Document applicable compliance frameworks based on business
        requirements and regulatory obligations.
      duration_estimate: "30 min"
      questions:
        - "Which compliance frameworks apply (SOC2, PCI-DSS, HIPAA, GDPR)?"
        - "What is the scope of compliance for each framework?"
        - "Are there contractual compliance obligations?"
      expected_findings:
        - "Compliance framework inventory"
        - "Scope definition"

    - id: "2"
      name: "Assess compliance monitoring"
      description: |
        Evaluate continuous compliance monitoring tools and configuration.
      duration_estimate: "45 min"
      commands:
        - purpose: "Check Security Hub status"
          command: "aws securityhub describe-hub"
        - purpose: "List enabled standards"
          command: "aws securityhub get-enabled-standards"
        - purpose: "Check Config status"
          command: "aws configservice describe-configuration-recorders"
      expected_findings:
        - "Monitoring tool status"
        - "Standard enablement"

    - id: "3"
      name: "Review compliance findings"
      description: |
        Analyze current compliance findings and their severity.
      duration_estimate: "60 min"
      commands:
        - purpose: "Get critical findings"
          command: "aws securityhub get-findings --filters '{\"SeverityLabel\": [{\"Value\": \"CRITICAL\", \"Comparison\": \"EQUALS\"}]}'"
        - purpose: "Get compliance summary"
          command: "aws securityhub get-findings-aggregator --finding-aggregator-arn <arn>"
        - purpose: "Check Config compliance"
          command: "aws configservice get-compliance-summary-by-config-rule"
      expected_findings:
        - "Finding inventory by severity"
        - "Compliance posture assessment"

    - id: "4"
      name: "Evaluate control implementation"
      description: |
        Map technical controls to compliance requirements and assess
        implementation completeness.
      duration_estimate: "90 min"
      commands:
        - purpose: "Run Prowler compliance check"
          command: "prowler aws --compliance cis_level2_aws -M csv"
      expected_findings:
        - "Control mapping"
        - "Implementation gaps"

    - id: "5"
      name: "Review evidence collection"
      description: |
        Assess evidence collection automation and retention for audit
        readiness.
      duration_estimate: "45 min"
      commands:
        - purpose: "Check Config delivery"
          command: "aws configservice describe-delivery-channels"
        - purpose: "Check CloudTrail for evidence"
          command: "aws cloudtrail describe-trails"
      expected_findings:
        - "Evidence collection status"
        - "Retention configuration"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Compliance Posture Assessment"
        - "Finding Analysis"
        - "Remediation Roadmap"

  confidence_guidance:
    high: "Automated compliance tool results, Security Hub findings"
    medium: "Manual control assessment, configuration review"
    low: "Based on incomplete information or sampling"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "cis-aws"
        priority: "required"
      - source_id: "pci-dss"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive compliance assessment"
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1

closeout_checklist:
  - id: "compliance-controls-001"
    item: "Security Hub enabled with applicable standards"
    level: "CRITICAL"
    verification: "aws securityhub describe-hub --query HubArn && echo PASS || echo FAIL"
    expected: "PASS"
  - id: "compliance-controls-002"
    item: "No critical compliance findings"
    level: "CRITICAL"
    verification: "aws securityhub get-findings --filters '{\"SeverityLabel\": [{\"Value\": \"CRITICAL\", \"Comparison\": \"EQUALS\"}], \"ComplianceStatus\": [{\"Value\": \"FAILED\", \"Comparison\": \"EQUALS\"}]}' --query 'length(Findings)' | awk '{print ($1==0)?\"PASS\":\"FAIL\"}'"
    expected: "PASS"
  - id: "compliance-controls-003"
    item: "AWS Config enabled with rules"
    level: "BLOCKING"
    verification: "aws configservice describe-configuration-recorders --query 'ConfigurationRecorders[0].name' && echo PASS || echo FAIL"
    expected: "PASS"
  - id: "compliance-controls-004"
    item: "Evidence collection automated"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Verify Config delivery channel and retention configured"
    expected: "Confirmed by reviewer"
  - id: "compliance-controls-005"
    item: "Compliance requirements documented"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Verify compliance scope and requirements are documented"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC2"
      controls: ["All"]
    - framework: "PCI-DSS"
      controls: ["All"]
    - framework: "HIPAA"
      controls: ["All"]
    - framework: "ISO27001"
      controls: ["All"]
    - framework: "CIS"
      controls: ["All"]

relationships:
  commonly_combined:
    - "cloud-infrastructure.cloud-security.iam-configuration"
    - "cloud-infrastructure.cloud-security.cloud-audit-logging"
    - "cloud-infrastructure.cloud-security.encryption-at-rest"
