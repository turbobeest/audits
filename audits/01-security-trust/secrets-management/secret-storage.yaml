audit:
  id: security-trust.secrets-management.secret-storage
  name: Secret Storage Audit
  version: 1.0.0
  last_updated: '2026-01-18'
  status: active
  category: security-trust
  category_number: 1
  subcategory: secrets-management
  tier: phd
  estimated_duration: 2 hours
  completeness: complete
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: critical
  scope: infrastructure
  default_profiles:
  - full
  - security
  blocks_phase: false
  parallelizable: true
description:
  what: |
    This audit evaluates how secrets are stored throughout the application
    infrastructure including secrets managers (HashiCorp Vault, AWS Secrets
    Manager, Azure Key Vault, GCP Secret Manager), encrypted storage,
    Kubernetes secrets, and file-based storage. It assesses encryption at
    rest, access controls, key management, and integration patterns.
  why_it_matters: |
    Proper secret storage is fundamental to security. OWASP recommends using
    designated secret management solutions and explicitly warns against storing
    secrets in code, config files, or environment variables. Centralized
    secrets management provides encryption, access control, auditing, and
    rotation capabilities essential for security compliance including PCI-DSS,
    SOC 2, and HIPAA.
  when_to_run:
  - During infrastructure security assessments
  - When implementing secrets management solutions
  - Before production deployments
  - During compliance audits
prerequisites:
  required_artifacts:
  - type: infrastructure_config
    description: Infrastructure-as-code, Kubernetes manifests, cloud configuration
  access_requirements:
  - Read access to infrastructure configuration
  - Access to secrets manager policies (view-only)
  - Kubernetes RBAC visibility
discovery:
  code_patterns:
  - pattern: vault|Vault|HashiCorp
    type: regex
    scope: config
    purpose: HashiCorp Vault usage
  - pattern: SecretsManager|secretsmanager|aws-sdk.*secrets
    type: regex
    scope: config
    purpose: AWS Secrets Manager usage
  - pattern: KeyVault|keyvault|azure.*secret
    type: regex
    scope: config
    purpose: Azure Key Vault usage
  - pattern: secretmanager|google.*secret
    type: regex
    scope: config
    purpose: GCP Secret Manager usage
  - pattern: kind:\s*Secret|apiVersion.*v1.*Secret
    type: regex
    scope: config
    purpose: Kubernetes Secrets
  file_patterns:
  - glob: '**/kubernetes/**/*.yaml'
    purpose: Kubernetes manifests
  - glob: '**/helm/**'
    purpose: Helm charts
  - glob: '**/terraform/**'
    purpose: Terraform configurations
  - glob: '**/vault/**'
    purpose: Vault configurations
knowledge_sources:
  specifications:
  - id: owasp-secrets-management
    name: OWASP Secrets Management Cheat Sheet
    url: https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
    offline_cache: true
    priority: required
  - id: owasp-key-management
    name: OWASP Key Management Cheat Sheet
    url: https://cheatsheetseries.owasp.org/cheatsheets/Key_Management_Cheat_Sheet.html
    offline_cache: true
    priority: required
  - id: cwe-922
    name: 'CWE-922: Insecure Storage of Sensitive Information'
    url: https://cwe.mitre.org/data/definitions/922.html
    offline_cache: true
    priority: required
  - id: nist-800-53
    name: NIST SP 800-53 Security and Privacy Controls
    url: https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final
    offline_cache: true
    priority: required
  - id: owasp-asvs
    name: OWASP Application Security Verification Standard
    url: https://owasp.org/www-project-application-security-verification-standard/
    offline_cache: true
    priority: required
  guides:
  - id: nist-key-management
    name: NIST SP 800-57 Key Management
    url: https://csrc.nist.gov/publications/detail/sp/800-57-part-1/rev-5/final
    offline_cache: true
tooling:
  infrastructure_tools:
  - tool: vault
    purpose: HashiCorp Vault CLI for policy verification
    command: vault policy list
  - tool: kubectl
    purpose: Kubernetes secret inspection
    command: kubectl get secrets -A
  - tool: aws
    purpose: AWS Secrets Manager verification
    command: aws secretsmanager list-secrets
  static_analysis:
  - tool: checkov
    purpose: IaC security scanning
    offline_capable: true
  - tool: tfsec
    purpose: Terraform security scanning
    offline_capable: true
signals:
  critical:
  - id: STORAGE-CRIT-001
    signal: Secrets stored in plaintext files
    evidence_pattern: password\s*=|secret\s*=|token\s*=
    explanation: |
      Plaintext secret storage provides no protection against unauthorized
      access. Anyone with file system access can read secrets. CWE-312.
    remediation: Migrate to encrypted secrets manager or vault solution
    cwe: CWE-312
  - id: STORAGE-CRIT-002
    signal: Kubernetes Secret without encryption at rest
    evidence_pattern: kind:\s*Secret
    explanation: |
      Kubernetes Secrets are base64 encoded by default, not encrypted.
      Without etcd encryption, secrets are stored in plaintext. CWE-311.
    remediation: Enable etcd encryption, use sealed-secrets, or external secrets operator
    cwe: CWE-311
  - id: STORAGE-CRIT-003
    signal: Secrets manager without access logging
    evidence_pattern: secretsmanager|vault
    explanation: |
      Secrets managers must log all access for audit purposes. Without
      logging, unauthorized access cannot be detected or investigated. CWE-778.
    remediation: Enable audit logging on secrets manager
    cwe: CWE-778
  high:
  - id: STORAGE-HIGH-001
    signal: Overly permissive secrets manager policies
    evidence_pattern: Action.*\*|Resource.*\*
    explanation: |
      Secrets manager policies with wildcard permissions violate least
      privilege. Applications should only access required secrets. CWE-732.
    remediation: Implement fine-grained IAM policies per application/service
    cwe: CWE-732
  - id: STORAGE-HIGH-002
    signal: No HSM backing for cryptographic key storage
    explanation: |
      High-security environments require Hardware Security Module (HSM)
      backing for key storage. Software-only solutions are vulnerable
      to memory extraction attacks. CWE-522.
    remediation: Use AWS CloudHSM, Azure Dedicated HSM, or Vault with HSM seal
    cwe: CWE-522
  - id: STORAGE-HIGH-003
    signal: Secrets accessible without authentication
    evidence_pattern: anonymous|no-auth|unauthenticated
    explanation: |
      Secrets must require authentication before access. Anonymous
      access defeats the purpose of secret storage. CWE-306.
    remediation: Enforce authentication for all secret access
    cwe: CWE-306
  medium:
  - id: STORAGE-MED-001
    signal: Single key for all secrets
    explanation: |
      Using one encryption key for all secrets increases blast radius
      if the key is compromised. Key separation limits exposure.
    remediation: Use separate keys per application or sensitivity level
  - id: STORAGE-MED-002
    signal: No versioning for secrets
    explanation: |
      Secret versioning enables rollback, rotation verification, and
      audit trail. Without it, secret history is lost.
    remediation: Enable versioning in secrets manager
  - id: STORAGE-MED-003
    signal: Secrets not replicated for availability
    explanation: |
      Single-region secret storage creates availability risks. Critical
      secrets should be replicated across regions.
    remediation: Configure cross-region replication for critical secrets
  positive:
  - id: STORAGE-POS-001
    signal: Centralized secrets manager in use
  - id: STORAGE-POS-002
    signal: HSM-backed key storage
  - id: STORAGE-POS-003
    signal: Fine-grained access policies
  - id: STORAGE-POS-004
    signal: Audit logging enabled
procedure:
  context:
    cognitive_mode: critical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Identify secrets storage mechanisms
    description: |
      Locate all secrets storage implementations including secrets
      managers, encrypted files, and Kubernetes secrets.
    duration_estimate: 20 min
    commands:
    - purpose: Find Vault configuration
      command: find . -name '*vault*' -o -name '*.hcl' 2>/dev/null | head -20
    - purpose: Find AWS Secrets Manager usage
      command: grep -rn 'secretsmanager\|SecretsManager' . 2>/dev/null | grep -v node_modules | head -20
    - purpose: Find Kubernetes secrets
      command: 'grep -rn ''kind: Secret'' . 2>/dev/null | head -20'
    expected_findings:
    - Secrets storage technologies in use
    - Configuration file locations
  - id: '2'
    name: Evaluate encryption at rest
    description: |
      Verify that stored secrets are encrypted and assess the
      encryption configuration.
    duration_estimate: 25 min
    commands:
    - purpose: Check for etcd encryption config
      command: grep -rn 'encryptionConfiguration\|encryption-provider' . 2>/dev/null
    - purpose: Check Vault seal configuration
      command: grep -rn 'seal.*{\|awskms\|azurekeyvault\|gcpckms' . 2>/dev/null
    - purpose: Check AWS KMS usage
      command: grep -rn 'kms:Encrypt\|KmsKeyId\|kms_key' . 2>/dev/null | head -20
    expected_findings:
    - Encryption configuration
    - Key management integration
  - id: '3'
    name: Review access control policies
    description: |
      Examine access policies for secrets managers to ensure
      least privilege principles are followed.
    duration_estimate: 30 min
    commands:
    - purpose: Find IAM policies for secrets
      command: grep -rn -A10 'secretsmanager:\|vault/' . 2>/dev/null | head -50
    - purpose: Check for wildcard permissions
      command: grep -rn 'Action.*\*\|Resource.*\*' . 2>/dev/null | grep -i secret | head -20
    - purpose: Find Kubernetes RBAC for secrets
      command: grep -rn -A5 'secrets\|Secret' . 2>/dev/null | grep -E 'rules:|verbs:|resources:' | head
        -30
    expected_findings:
    - Access policy definitions
    - Permission scope
  - id: '4'
    name: Verify audit logging
    description: |
      Confirm that secret access is logged for audit and
      incident response purposes.
    duration_estimate: 15 min
    commands:
    - purpose: Check Vault audit configuration
      command: grep -rn 'audit\|log' . 2>/dev/null | grep -i vault | head -20
    - purpose: Check CloudTrail for secrets
      command: grep -rn 'cloudtrail\|CloudTrail' . 2>/dev/null | head -10
    expected_findings:
    - Audit logging configuration
    - Log destination and retention
  - id: '5'
    name: Assess secrets injection pattern
    description: |
      Review how secrets are delivered to applications - mounted
      volumes, environment injection, or API calls.
    duration_estimate: 20 min
    commands:
    - purpose: Find sidecar/init container patterns
      command: grep -rn 'initContainers\|sidecar\|vault-agent' . 2>/dev/null | head -20
    - purpose: Find secrets environment injection
      command: grep -rn -B2 -A5 'valueFrom:\s*secretKeyRef' . 2>/dev/null | head -40
    - purpose: Find volume-mounted secrets
      command: grep -rn -B2 -A5 'secret:\|secretName:' . 2>/dev/null | head -40
    expected_findings:
    - Secret delivery mechanisms
    - Injection patterns
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Storage Architecture Assessment
    - Access Control Analysis
    - Encryption Evaluation
    - Recommendations
  confidence_guidance:
    high: Direct evidence of insecure storage or missing encryption
    medium: Configuration gaps or incomplete implementations
    low: Best practice deviations requiring infrastructure verification
offline:
  capability: partial
  cache_manifest:
    knowledge:
    - source_id: owasp-secrets-management
      priority: required
    - source_id: owasp-key-management
      priority: required
profiles:
  membership:
    quick:
      included: false
      reason: Requires infrastructure analysis
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1
closeout_checklist:
- id: secret-storage-001
  item: Centralized secrets manager in use
  level: CRITICAL
  verification: grep -rn 'vault\|secretsmanager\|KeyVault\|secretmanager' . 2>/dev/null | head -1 | grep
    -q . && echo PASS || echo FAIL
  expected: PASS
- id: secret-storage-002
  item: Secrets encrypted at rest
  level: CRITICAL
  verification: manual
  verification_notes: Verify etcd encryption, Vault seal, or cloud KMS configuration
  expected: Confirmed by reviewer
- id: secret-storage-003
  item: Fine-grained access policies
  level: BLOCKING
  verification: grep -rn 'Action.*\*' . 2>/dev/null | grep -i secret | wc -l | xargs -I {} test {} -eq
    0 && echo PASS || echo FAIL
  expected: PASS
- id: secret-storage-004
  item: Audit logging enabled
  level: WARNING
  verification: grep -rn 'audit\|cloudtrail' . 2>/dev/null | grep -i secret | head -1 | grep -q . && echo
    PASS || echo FAIL
  expected: PASS
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: CWE
    controls:
    - CWE-922
    - CWE-311
    - CWE-312
  - framework: PCI-DSS
    controls:
    - '3.4'
    - '3.5'
    - '3.6'
  - framework: SOC 2
    controls:
    - CC6.1
    - CC6.6
    - CC6.7
  - framework: NIST
    controls:
    - SC-28
    - SC-12
relationships:
  commonly_combined:
  - security-trust.secrets-management.hardcoded-secrets
  - security-trust.secrets-management.secret-rotation
  - security-trust.cryptography.encryption-at-rest
