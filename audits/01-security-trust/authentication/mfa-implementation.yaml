audit:
  id: security-trust.authentication.mfa-implementation
  name: Multi-Factor Authentication Audit
  version: 1.0.0
  last_updated: '2026-01-18'
  status: active
  category: security-trust
  category_number: 1
  subcategory: authentication
  tier: phd
  estimated_duration: 3 hours
  completeness: complete
  requires_runtime: false
  destructive: false
execution:
  automatable: partial
  severity: critical
  scope: codebase
  default_profiles:
  - full
  - security
  blocks_phase: false
  parallelizable: true
description:
  what: |
    This audit evaluates Multi-Factor Authentication (MFA) implementations
    against NIST SP 800-63B guidelines and AAL (Authenticator Assurance Level)
    requirements. It examines TOTP/HOTP implementations, WebAuthn/FIDO2
    integration, SMS/voice OTP security, backup codes, recovery mechanisms,
    and phishing resistance capabilities.
  why_it_matters: |
    Microsoft estimates MFA prevents 99.9% of account compromise attacks.
    However, poorly implemented MFA can provide false security assurance.
    Weak implementations may be vulnerable to real-time phishing, SIM swapping,
    or bypass attacks. NIST SP 800-63B-4 now strongly promotes phishing-resistant
    authenticators like FIDO2/passkeys for AAL2 and AAL3 compliance.
  when_to_run:
  - Before enabling MFA for production systems
  - After changes to authentication mechanisms
  - During security compliance assessments
  - When upgrading from SMS OTP to phishing-resistant methods
prerequisites:
  required_artifacts:
  - type: source_code
    description: MFA implementation code including TOTP, WebAuthn, and recovery flows
  - type: configuration
    description: Authentication server configuration and AAL settings
  access_requirements:
  - Read access to authentication service codebase
  - Access to MFA provider configuration
  - Understanding of target AAL requirements
discovery:
  code_patterns:
  - pattern: totp|TOTP|time.*based.*otp
    type: regex
    scope: source
    purpose: Locate TOTP implementation
  - pattern: hotp|HOTP|hmac.*otp|counter.*otp
    type: regex
    scope: source
    purpose: Locate HOTP implementation
  - pattern: webauthn|WebAuthn|fido2|FIDO2|passkey
    type: regex
    scope: source
    purpose: Identify WebAuthn/FIDO2 implementation
  - pattern: sms.*otp|send.*sms|twilio|sns.*sms|voice.*call
    type: regex
    scope: source
    purpose: Detect SMS/voice OTP usage
  - pattern: backup.*code|recovery.*code|scratch.*code
    type: regex
    scope: source
    purpose: Find backup code implementation
  - pattern: authenticator.*app|google.*authenticator|authy|duo
    type: regex
    scope: source
    purpose: Identify authenticator app integration
  - pattern: mfa.*bypass|skip.*mfa|disable.*2fa
    type: regex
    scope: source
    purpose: Detect MFA bypass mechanisms
  - pattern: remember.*device|trusted.*device|device.*trust
    type: regex
    scope: source
    purpose: Find device trust/remember functionality
  file_patterns:
  - glob: '**/*mfa*'
    purpose: MFA implementation files
  - glob: '**/*2fa*'
    purpose: Two-factor authentication files
  - glob: '**/auth/**'
    purpose: Authentication module files
  - glob: '**/*webauthn*'
    purpose: WebAuthn implementation files
  - glob: '**/*totp*'
    purpose: TOTP implementation files
knowledge_sources:
  specifications:
  - id: nist-800-63b
    name: NIST SP 800-63B Authentication and Lifecycle Management
    url: https://pages.nist.gov/800-63-3/sp800-63b.html
    offline_cache: true
    priority: required
  - id: nist-800-63b-4
    name: NIST SP 800-63B-4 Digital Identity Guidelines
    url: https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-63B-4.pdf
    offline_cache: true
    priority: required
  - id: rfc6238
    name: 'RFC 6238 - TOTP: Time-Based One-Time Password Algorithm'
    url: https://datatracker.ietf.org/doc/html/rfc6238
    offline_cache: true
    priority: required
  - id: webauthn-spec
    name: WebAuthn Level 2 Specification
    url: https://www.w3.org/TR/webauthn-2/
    offline_cache: true
    priority: recommended
  - id: nist-800-53
    name: NIST SP 800-53 Security and Privacy Controls
    url: https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final
    offline_cache: true
    priority: required
  - id: nist-800-207
    name: NIST SP 800-207 Zero Trust Architecture
    url: https://csrc.nist.gov/publications/detail/sp/800-207/final
    offline_cache: true
    priority: required
  - id: nsa-zero-trust
    name: NSA Embracing a Zero Trust Security Model
    url: https://media.defense.gov/2021/Feb/25/2002588479/-1/-1/0/CSI_EMBRACING_ZT_SECURITY_MODEL_UOO115131-21.PDF
    offline_cache: true
    priority: required
  - id: owasp-asvs
    name: OWASP Application Security Verification Standard
    url: https://owasp.org/www-project-application-security-verification-standard/
    offline_cache: true
    priority: required
  guides:
  - id: owasp-mfa
    name: OWASP Multi-Factor Authentication Cheat Sheet
    url: https://cheatsheetseries.owasp.org/cheatsheets/Multifactor_Authentication_Cheat_Sheet.html
    offline_cache: true
  - id: owasp-auth
    name: OWASP Authentication Cheat Sheet
    url: https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html
    offline_cache: true
tooling:
  static_analysis:
  - tool: semgrep
    purpose: Detect MFA implementation patterns
    offline_capable: true
  scripts:
  - id: mfa-detector
    language: bash
    purpose: Detect MFA methods in codebase
    source: inline
    code: |
      #!/bin/bash
      echo "=== MFA Method Detection ==="
      echo "TOTP Implementation:"
      grep -rn "totp\|TOTP" --include="*.js" --include="*.ts" --include="*.py" --include="*.java" .
      echo ""
      echo "WebAuthn/FIDO2:"
      grep -rn "webauthn\|WebAuthn\|fido2\|passkey" --include="*.js" --include="*.ts" --include="*.py" .
      echo ""
      echo "SMS OTP (Phishing-susceptible):"
      grep -rn "sms.*otp\|twilio\|send.*verification" --include="*.js" --include="*.ts" --include="*.py" .
signals:
  critical:
  - id: AUTH-MFA-CRIT-001
    signal: MFA bypass mechanism without proper authorization controls
    cwe: CWE-287
    evidence_pattern: mfa.*bypass|skip.*mfa|disable.*2fa|force_mfa\s*[=:]\s*false
    explanation: |
      Administrative MFA bypass capabilities without proper controls allow
      attackers with admin access to disable MFA for any user. This can
      escalate insider threats or compromised admin accounts to full
      account takeover.
    remediation: |
      Require MFA for all administrative actions including MFA bypass.
      Implement audit logging for bypass events. Require multiple
      administrator approval for bypass operations. Set automatic
      re-enablement timers.
  - id: AUTH-MFA-CRIT-002
    signal: TOTP secret stored in plaintext or weakly encrypted
    cwe: CWE-312
    evidence_pattern: totp_secret\s*[=:]|mfa_secret.*plain|secret.*base32
    explanation: |
      TOTP secrets stored in plaintext allow attackers with database access
      to generate valid OTP codes for any user, completely bypassing MFA.
      This is equivalent to storing passwords in plaintext.
    remediation: |
      Encrypt TOTP secrets using envelope encryption with HSM-backed keys.
      Use separate encryption keys from password storage. Implement
      key rotation procedures.
  - id: AUTH-MFA-CRIT-003
    signal: MFA verification susceptible to race conditions
    cwe: CWE-362
    evidence_pattern: verify.*totp(?!.*lock)|check.*otp(?!.*atomic)
    explanation: |
      Race conditions in MFA verification can allow replay attacks where
      the same OTP code is used multiple times before invalidation.
      This defeats the one-time property of OTP codes.
    remediation: |
      Implement atomic OTP verification with immediate invalidation.
      Use database transactions or distributed locks. Track used codes
      within the time window to prevent reuse.
  high:
  - id: AUTH-MFA-HIGH-001
    signal: SMS-based OTP as sole MFA option
    cwe: CWE-308
    evidence_pattern: sms.*otp|send.*sms.*verification(?!.*webauthn|.*totp)
    explanation: |
      SMS OTP is vulnerable to SIM swapping, SS7 attacks, and real-time
      phishing. NIST SP 800-63B restricts SMS OTP and recommends
      phishing-resistant alternatives. SMS should not be the only
      MFA option.
    remediation: |
      Offer phishing-resistant alternatives (WebAuthn, TOTP apps).
      Deprecate SMS OTP for high-value accounts. Implement additional
      controls like device binding when SMS is used.
  - id: AUTH-MFA-HIGH-002
    signal: Weak TOTP configuration (short secret or time step)
    cwe: CWE-328
    evidence_pattern: secret.*length.*[=:]\s*([1-9]|1[0-5])\b|time_step.*[=:]\s*(10|15)\b
    explanation: |
      TOTP secrets shorter than 128 bits or non-standard time steps
      weaken the cryptographic security. RFC 6238 recommends minimum
      128-bit secrets and 30-second time steps.
    remediation: |
      Use 160-bit (20-byte) or 256-bit secrets for TOTP. Use standard
      30-second time step. Implement SHA-256 or SHA-512 HMAC for
      higher assurance levels.
  - id: AUTH-MFA-HIGH-003
    signal: Backup codes not single-use or improperly stored
    cwe: CWE-262
    evidence_pattern: backup_code(?!.*hash)|recovery_code.*plain|scratch.*code(?!.*bcrypt)
    explanation: |
      Backup codes that can be reused or are stored without hashing
      create persistent credential exposure. A single database breach
      provides unlimited MFA bypass capability.
    remediation: |
      Hash backup codes with bcrypt/argon2. Mark codes as used immediately
      upon consumption. Generate new backup code set after any code use.
      Limit total backup codes (typically 8-10).
  - id: AUTH-MFA-HIGH-004
    signal: Extended device trust without re-verification
    cwe: CWE-613
    evidence_pattern: remember.*device.*days\s*[=:]\s*(30|60|90|365)|trust.*duration.*(month|year)
    explanation: |
      Long-lived device trust effectively reduces MFA to single-factor
      for the trusted period. Compromised devices maintain persistent
      access without MFA challenge.
    remediation: |
      Limit device trust duration (7-14 days maximum). Require periodic
      MFA re-verification. Invalidate trust on password change or
      suspicious activity. Implement device fingerprinting.
  medium:
  - id: AUTH-MFA-MED-001
    signal: No rate limiting on MFA verification attempts
    cwe: CWE-307
    evidence_pattern: verify.*totp(?!.*rate|.*limit)|check.*otp(?!.*throttle)
    remediation: |
      Implement rate limiting on MFA verification (e.g., 5 attempts per
      5 minutes). Implement exponential backoff. Lock MFA temporarily
      after repeated failures.
  - id: AUTH-MFA-MED-002
    signal: MFA enrollment without identity verification
    cwe: CWE-287
    evidence_pattern: enroll.*mfa(?!.*verify)|setup.*totp(?!.*confirm)
    remediation: |
      Require password re-authentication before MFA enrollment.
      Send notification to existing verified channels.
      Implement enrollment confirmation step.
  - id: AUTH-MFA-MED-003
    signal: Missing MFA for sensitive operations
    cwe: CWE-306
    evidence_pattern: password.*change(?!.*mfa)|email.*change(?!.*2fa)
    remediation: |
      Require step-up MFA for password changes, email changes, MFA
      modifications, and other sensitive account operations.
  low:
  - id: AUTH-MFA-LOW-001
    signal: MFA status exposed in error messages
    evidence_pattern: error.*mfa.*not.*enabled|user.*no.*2fa
    remediation: |
      Use generic error messages that do not reveal MFA status.
      Avoid enumeration of MFA-enabled accounts.
  positive:
  - id: AUTH-MFA-POS-001
    signal: WebAuthn/FIDO2 phishing-resistant MFA implemented
    evidence_pattern: webauthn|WebAuthn|navigator\.credentials|PublicKeyCredential
  - id: AUTH-MFA-POS-002
    signal: Hardware security key support (AAL3)
    evidence_pattern: security.*key|yubikey|authenticatorAttachment.*cross-platform
  - id: AUTH-MFA-POS-003
    signal: TOTP secrets encrypted at rest
    evidence_pattern: encrypt.*totp|kms.*mfa|envelope.*encryption.*secret
procedure:
  context:
    cognitive_mode: critical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Identify MFA Methods
    description: |
      Catalog all MFA methods implemented in the system.
      Assess AAL compliance level.
    duration_estimate: 30 min
    commands:
    - purpose: Find TOTP implementation
      command: grep -rn 'totp\|TOTP\|speakeasy\|otplib' --include='*.js' --include='*.ts' --include='*.py'
        --include='*.java' .
    - purpose: Find WebAuthn implementation
      command: grep -rn 'webauthn\|WebAuthn\|fido2\|passkey\|PublicKeyCredential' --include='*.js' --include='*.ts'
        --include='*.py' .
    - purpose: Find SMS OTP implementation
      command: grep -rn 'sms.*otp\|twilio\|send.*sms\|verify.*phone' --include='*.js' --include='*.ts'
        --include='*.py' .
    expected_findings:
    - Complete inventory of MFA methods
    - AAL level assessment
  - id: '2'
    name: Audit TOTP Security
    description: |
      Verify TOTP implementation follows RFC 6238 and secrets
      are properly protected.
    duration_estimate: 45 min
    commands:
    - purpose: Check TOTP secret storage
      command: grep -rn 'totp_secret\|mfa_secret\|otp_secret' --include='*.js' --include='*.ts' --include='*.py'
        --include='*.java' .
    - purpose: Verify TOTP configuration
      command: grep -rn 'time_step\|digits\s*[=:]\|algorithm.*sha' --include='*.js' --include='*.ts' --include='*.py'
        .
    expected_findings:
    - TOTP secrets encrypted at rest
    - RFC 6238 compliant configuration
  - id: '3'
    name: Evaluate Bypass and Recovery
    description: |
      Analyze MFA bypass mechanisms and backup code handling.
    duration_estimate: 30 min
    commands:
    - purpose: Find MFA bypass code
      command: grep -rn 'bypass.*mfa\|skip.*2fa\|disable.*mfa\|force_mfa' --include='*.js' --include='*.ts'
        --include='*.py' .
    - purpose: Check backup code handling
      command: grep -rn 'backup.*code\|recovery.*code\|scratch.*code' --include='*.js' --include='*.ts'
        --include='*.py' .
    expected_findings:
    - Bypass requires elevated permissions
    - Backup codes hashed and single-use
  - id: '4'
    name: Verify Rate Limiting
    description: |
      Check rate limiting and lockout on MFA verification endpoints.
    duration_estimate: 30 min
    commands:
    - purpose: Find MFA verification endpoints
      command: grep -rn 'verify.*mfa\|validate.*otp\|check.*totp' --include='*.js' --include='*.ts' --include='*.py'
        .
    - purpose: Check for rate limiting
      command: grep -rn 'rate.*limit\|throttle\|attempt.*count' --include='*.js' --include='*.ts' --include='*.py'
        .
    expected_findings:
    - Rate limiting on MFA verification
    - Account lockout after failures
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - AAL Compliance Assessment
    - MFA Method Security Analysis
    - Recommendations
  confidence_guidance:
    high: Direct evidence from code review and configuration analysis
    medium: Pattern matches requiring runtime verification
    low: Circumstantial evidence suggesting potential weakness
offline:
  capability: full
  cache_manifest:
    knowledge:
    - source_id: nist-800-63b
      priority: required
    - source_id: owasp-mfa
      priority: required
profiles:
  membership:
    quick:
      included: false
      reason: MFA security requires thorough analysis
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1
closeout_checklist:
- id: mfa-001
  item: Phishing-resistant MFA option available (WebAuthn/FIDO2)
  level: CRITICAL
  verification: |
    if grep -rq 'webauthn\|WebAuthn\|fido2\|passkey' --include='*.js' --include='*.ts' --include='*.py' .; then echo "PASS"; else echo "FAIL - No phishing-resistant MFA"; fi
  expected: PASS
- id: mfa-002
  item: No uncontrolled MFA bypass mechanisms
  level: CRITICAL
  verification: |
    if grep -rq 'mfa.*bypass.*true\|skip_mfa\s*=\s*true\|force_mfa\s*=\s*false' --include='*.js' --include='*.ts' --include='*.py' .; then echo "FAIL"; else echo "PASS"; fi
  expected: PASS
- id: mfa-003
  item: TOTP secrets not stored in plaintext
  level: BLOCKING
  verification: |
    if grep -rq 'totp_secret.*plain\|mfa_secret.*unencrypted' --include='*.js' --include='*.ts' --include='*.py' .; then echo "FAIL"; else echo "PASS"; fi
  expected: PASS
- id: mfa-004
  item: Rate limiting on MFA verification
  level: BLOCKING
  verification: |
    if grep -rq 'rate.*limit.*mfa\|throttle.*otp\|mfa.*attempt.*limit' --include='*.js' --include='*.ts' --include='*.py' .; then echo "PASS"; else echo "WARNING - Verify rate limiting manually"; fi
  expected: PASS
- id: mfa-005
  item: Backup codes are hashed
  level: WARNING
  verification: |
    if grep -rq 'hash.*backup\|bcrypt.*recovery\|argon2.*code' --include='*.js' --include='*.ts' --include='*.py' .; then echo "PASS"; else echo "WARNING - Verify backup code storage"; fi
  expected: PASS
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: NIST SP 800-63B
    controls:
    - AAL1
    - AAL2
    - AAL3
  - framework: OWASP ASVS
    controls:
    - V2.7
    - V2.8
  - framework: PCI DSS
    controls:
    - '8.3'
relationships:
  commonly_combined:
  - security-trust.authentication.session-management
  - security-trust.authentication.brute-force-protection
  - security-trust.authentication.password-policy
