audit:
  id: security-trust.authentication.token-lifecycle
  name: Token Lifecycle Audit
  version: 1.0.0
  last_updated: '2026-01-18'
  status: active
  category: security-trust
  category_number: 1
  subcategory: authentication
  tier: phd
  estimated_duration: 3 hours
  completeness: complete
  requires_runtime: false
  destructive: false
execution:
  automatable: partial
  severity: high
  scope: codebase
  default_profiles:
  - full
  - security
  blocks_phase: false
  parallelizable: true
description:
  what: |
    This audit examines token lifecycle management including JWT creation,
    validation, expiration, refresh token rotation, revocation strategies,
    and secure storage. It evaluates token security per OWASP JWT Cheat Sheet
    and RFC 7519 covering algorithm security, claim validation, lifetime
    configuration, and token theft prevention.
  why_it_matters: |
    Tokens are the primary mechanism for maintaining authenticated sessions
    in modern applications. Poor lifecycle management enables token theft,
    replay attacks, and prolonged unauthorized access. Access tokens should
    be short-lived (15-30 minutes), refresh tokens must be rotated on each
    use, and revocation mechanisms are critical for incident response.
    JWT-specific vulnerabilities like algorithm confusion (alg:none) and
    weak signature verification remain common.
  when_to_run:
  - Before production deployment of authentication systems
  - After changes to token handling logic
  - During security assessments
  - When implementing refresh token rotation
prerequisites:
  required_artifacts:
  - type: source_code
    description: Token generation, validation, and refresh logic
  - type: configuration
    description: JWT configuration and token settings
  access_requirements:
  - Read access to authentication service codebase
  - Access to token configuration
  - Understanding of session management architecture
discovery:
  code_patterns:
  - pattern: jwt|JWT|jsonwebtoken|jose
    type: regex
    scope: source
    purpose: Locate JWT implementation
  - pattern: access.*token|accessToken|access_token
    type: regex
    scope: source
    purpose: Find access token handling
  - pattern: refresh.*token|refreshToken|refresh_token
    type: regex
    scope: source
    purpose: Find refresh token handling
  - pattern: expiresIn|exp|expires_in|token.*lifetime
    type: regex
    scope: source
    purpose: Check token expiration configuration
  - pattern: alg.*none|algorithm.*none|HS256|RS256|ES256
    type: regex
    scope: source
    purpose: Identify JWT algorithms
  - pattern: verify|decode|validate.*token
    type: regex
    scope: source
    purpose: Find token verification code
  - pattern: revoke|invalidate|blocklist|blacklist
    type: regex
    scope: source
    purpose: Check for revocation mechanisms
  - pattern: localStorage|sessionStorage|cookie
    type: regex
    scope: source
    purpose: Find token storage patterns
  - pattern: jti|tokenId|token_id
    type: regex
    scope: source
    purpose: Check for unique token identifiers
  - pattern: rotate.*token|token.*rotation
    type: regex
    scope: source
    purpose: Find token rotation implementation
  file_patterns:
  - glob: '**/*token*'
    purpose: Token handling files
  - glob: '**/*jwt*'
    purpose: JWT implementation files
  - glob: '**/auth/**'
    purpose: Authentication module files
  - glob: '**/session*'
    purpose: Session management files
knowledge_sources:
  specifications:
  - id: rfc7519
    name: RFC 7519 - JSON Web Token (JWT)
    url: https://datatracker.ietf.org/doc/html/rfc7519
    offline_cache: true
    priority: required
  - id: rfc7515
    name: RFC 7515 - JSON Web Signature (JWS)
    url: https://datatracker.ietf.org/doc/html/rfc7515
    offline_cache: true
    priority: recommended
  - id: nist-800-53
    name: NIST SP 800-53 Security and Privacy Controls
    url: https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final
    offline_cache: true
    priority: required
  - id: nist-800-207
    name: NIST SP 800-207 Zero Trust Architecture
    url: https://csrc.nist.gov/publications/detail/sp/800-207/final
    offline_cache: true
    priority: required
  - id: nsa-zero-trust
    name: NSA Embracing a Zero Trust Security Model
    url: https://media.defense.gov/2021/Feb/25/2002588479/-1/-1/0/CSI_EMBRACING_ZT_SECURITY_MODEL_UOO115131-21.PDF
    offline_cache: true
    priority: required
  - id: owasp-asvs
    name: OWASP Application Security Verification Standard
    url: https://owasp.org/www-project-application-security-verification-standard/
    offline_cache: true
    priority: required
  guides:
  - id: owasp-jwt
    name: OWASP JWT Cheat Sheet for Java
    url: https://cheatsheetseries.owasp.org/cheatsheets/JSON_Web_Token_for_Java_Cheat_Sheet.html
    offline_cache: true
  - id: owasp-session
    name: OWASP Session Management Cheat Sheet
    url: https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html
    offline_cache: true
  - id: auth0-refresh
    name: Auth0 Refresh Token Rotation
    url: https://auth0.com/blog/refresh-tokens-what-are-they-and-when-to-use-them/
    offline_cache: true
tooling:
  static_analysis:
  - tool: semgrep
    purpose: JWT security patterns
    offline_capable: true
  - tool: jwt_tool
    purpose: JWT vulnerability testing
    offline_capable: true
  scripts:
  - id: token-lifecycle-scanner
    language: bash
    purpose: Scan for token lifecycle issues
    source: inline
    code: |
      #!/bin/bash
      echo "=== Token Lifecycle Scanner ==="
      echo "JWT Algorithm Configuration:"
      grep -rn "alg\|algorithm\|HS256\|RS256\|ES256" --include="*.js" --include="*.ts" --include="*.py" --include="*.java" .
      echo ""
      echo "Token Expiration:"
      grep -rn "expiresIn\|expires_in\|exp\|token.*lifetime" --include="*.js" --include="*.ts" --include="*.py" --include="*.java" .
      echo ""
      echo "Refresh Token Rotation:"
      grep -rn "rotate.*token\|token.*rotation\|refresh.*rotate" --include="*.js" --include="*.ts" --include="*.py" .
      echo ""
      echo "Token Storage:"
      grep -rn "localStorage\|sessionStorage" --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" .
signals:
  critical:
  - id: AUTH-TOKEN-CRIT-001
    signal: JWT algorithm none accepted or signature verification disabled
    cwe: CWE-347
    evidence_pattern: alg['"]?\s*[=:]\s*['"]?none|verify\s*[=:]\s*false|algorithms.*none
    explanation: |
      The alg:none attack bypasses JWT signature verification entirely,
      allowing attackers to forge tokens with arbitrary claims. This
      enables complete authentication bypass and privilege escalation.
    remediation: |
      Explicitly whitelist allowed algorithms (RS256, ES256).
      Never accept 'none' algorithm. Use well-maintained JWT libraries
      that reject none by default. Verify both signature and algorithm.
  - id: AUTH-TOKEN-CRIT-002
    signal: Symmetric key (HS256) with exposed or weak secret
    cwe: CWE-321
    evidence_pattern: HS256.*secret\s*[=:]\s*['"][a-zA-Z0-9]{1,31}['"]|jwt.*secret.*password
    explanation: |
      Weak or exposed HS256 secrets allow attackers to forge valid JWTs.
      Secrets should be at least 256 bits (32 bytes) generated using
      cryptographically secure random functions.
    remediation: |
      Generate secrets using cryptographic random generators (min 256 bits).
      Store secrets in secrets management systems. Rotate secrets every
      90 days. Prefer asymmetric algorithms (RS256, ES256) for distributed
      systems.
  - id: AUTH-TOKEN-CRIT-003
    signal: No token expiration (exp claim missing or very long)
    cwe: CWE-613
    evidence_pattern: expiresIn.*['"]?(365d|8760h|31536000)|exp.*undefined|noExpiration
    explanation: |
      Tokens without expiration or with very long lifetimes provide
      persistent access if stolen. Access tokens should expire in
      15-60 minutes; longer-lived refresh tokens must be rotatable.
    remediation: |
      Set access token expiration to 15-30 minutes for sensitive operations.
      Use refresh tokens with rotation for extended sessions.
      Implement absolute timeout (8-24 hours) regardless of activity.
  high:
  - id: AUTH-TOKEN-HIGH-001
    signal: Refresh tokens not rotated on use
    cwe: CWE-384
    evidence_pattern: refresh.*token(?!.*rotate|.*invalidate|.*revoke)|refreshToken.*return.*same
    explanation: |
      Reusable refresh tokens create persistent attack windows. If stolen,
      attackers maintain access until the token expires. Rotation ensures
      stolen tokens are detected and invalidated after first use.
    remediation: |
      Issue new refresh token on each use and invalidate the old one.
      Implement token family tracking for reuse detection.
      Invalidate entire token family on suspected theft.
  - id: AUTH-TOKEN-HIGH-002
    signal: Tokens stored in localStorage (XSS vulnerable)
    cwe: CWE-922
    evidence_pattern: localStorage\.setItem.*token|localStorage\[.*token|window\.localStorage.*jwt
    explanation: |
      localStorage is accessible to JavaScript including XSS payloads.
      Attackers exploiting XSS can steal tokens and maintain persistent
      access. HttpOnly cookies prevent JavaScript access.
    remediation: |
      Store tokens in HttpOnly, Secure cookies with SameSite=Strict.
      If localStorage is required, use short-lived tokens with
      frequent rotation. Implement strong CSP to mitigate XSS.
  - id: AUTH-TOKEN-HIGH-003
    signal: No token revocation mechanism implemented
    cwe: CWE-613
    evidence_pattern: jwt.*verify(?!.*blacklist|.*revoke|.*blocklist)|token.*valid(?!.*revoked)
    explanation: |
      Without revocation, compromised tokens remain valid until expiration.
      Critical for incident response when credentials are compromised,
      users log out, or accounts are suspended.
    remediation: |
      Implement token blocklist in Redis or database. Check blocklist
      on every token verification. Store revoked token IDs until
      original expiration. Support password-change revocation.
  - id: AUTH-TOKEN-HIGH-004
    signal: Missing JWT claim validation (iss, aud, exp)
    cwe: CWE-345
    evidence_pattern: jwt\.decode(?!.*verify)|verify.*complete.*false|ignoreExpiration
    explanation: |
      Skipping claim validation allows tokens from other issuers,
      intended for other audiences, or expired tokens to be accepted.
      All claims must be validated to prevent token misuse.
    remediation: |
      Validate iss (issuer), aud (audience), exp (expiration), and
      nbf (not before) claims. Use strict audience matching.
      Reject tokens with unexpected issuers.
  medium:
  - id: AUTH-TOKEN-MED-001
    signal: Access token lifetime exceeds 1 hour
    cwe: CWE-613
    evidence_pattern: expiresIn.*['"]?(2h|3h|[4-9]h|[0-9]+h|86400|172800)
    remediation: |
      Reduce access token lifetime to 15-30 minutes.
      Use refresh tokens for extended sessions.
      Implement sliding expiration if needed.
  - id: AUTH-TOKEN-MED-002
    signal: No unique token identifier (jti claim)
    cwe: CWE-384
    evidence_pattern: jwt\.sign(?!.*jti)|createToken(?!.*tokenId|.*jti)
    remediation: |
      Include jti claim with unique identifier in all tokens.
      Use UUID or cryptographically random ID.
      Track jti for revocation and replay detection.
  - id: AUTH-TOKEN-MED-003
    signal: Token not bound to client or session
    cwe: CWE-384
    evidence_pattern: token(?!.*fingerprint|.*binding|.*client)
    remediation: |
      Bind tokens to client fingerprint or session.
      Include client identifier in token claims.
      Validate binding on each request.
  - id: AUTH-TOKEN-MED-004
    signal: Refresh token reuse detection not implemented
    cwe: CWE-294
    evidence_pattern: refresh.*token(?!.*family|.*chain|.*reuse)
    remediation: |
      Implement token family tracking.
      Invalidate all family tokens on reuse detection.
      Alert on suspected token theft.
  low:
  - id: AUTH-TOKEN-LOW-001
    signal: Token debugging enabled in production
    evidence_pattern: jwt.*debug\s*[=:]\s*true|LOG_TOKEN.*true
    remediation: |
      Disable token debugging in production.
      Never log full token payloads.
      Use token IDs for tracing.
  positive:
  - id: AUTH-TOKEN-POS-001
    signal: Asymmetric JWT algorithm (RS256/ES256) in use
    evidence_pattern: algorithm.*RS256|algorithm.*ES256|alg.*RS256
  - id: AUTH-TOKEN-POS-002
    signal: Refresh token rotation implemented
    evidence_pattern: rotate.*refresh|refresh.*rotate|newRefreshToken
  - id: AUTH-TOKEN-POS-003
    signal: Token blocklist/revocation implemented
    evidence_pattern: blocklist|blacklist|revokedTokens|tokenRevocation
  - id: AUTH-TOKEN-POS-004
    signal: Tokens stored in HttpOnly cookies
    evidence_pattern: httpOnly\s*[=:]\s*true|HttpOnly.*cookie
procedure:
  context:
    cognitive_mode: critical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Analyze JWT Configuration
    description: |
      Review JWT algorithm selection and secret management.
    duration_estimate: 30 min
    commands:
    - purpose: Find JWT algorithm configuration
      command: grep -rn 'algorithm\|alg\|HS256\|RS256\|ES256' --include='*.js' --include='*.ts' --include='*.py'
        --include='*.java' .
    - purpose: Check for algorithm none
      command: grep -rn 'alg.*none\|algorithm.*none' --include='*.js' --include='*.ts' --include='*.py'
        .
    - purpose: Find JWT secret configuration
      command: grep -rn 'jwt.*secret\|JWT_SECRET\|secretKey' --include='*.js' --include='*.ts' --include='*.py'
        --include='*.env' .
    expected_findings:
    - JWT algorithm identification
    - Secret management assessment
  - id: '2'
    name: Review Token Expiration
    description: |
      Verify appropriate token lifetimes are configured.
    duration_estimate: 20 min
    commands:
    - purpose: Find expiration configuration
      command: grep -rn 'expiresIn\|expires_in\|exp\|token.*lifetime\|TOKEN_LIFETIME' --include='*.js'
        --include='*.ts' --include='*.py' --include='*.java' .
    expected_findings:
    - Access token lifetime
    - Refresh token lifetime
  - id: '3'
    name: Audit Refresh Token Handling
    description: |
      Check refresh token rotation and reuse detection.
    duration_estimate: 30 min
    commands:
    - purpose: Find refresh token logic
      command: grep -rn 'refresh.*token\|refreshToken\|token.*refresh' --include='*.js' --include='*.ts'
        --include='*.py' .
    - purpose: Check for rotation
      command: grep -rn 'rotate\|rotation\|newRefreshToken\|invalidate.*refresh' --include='*.js' --include='*.ts'
        --include='*.py' .
    expected_findings:
    - Refresh token rotation status
    - Reuse detection implementation
  - id: '4'
    name: Verify Revocation Mechanism
    description: |
      Ensure tokens can be revoked when needed.
    duration_estimate: 20 min
    commands:
    - purpose: Find revocation implementation
      command: grep -rn 'revoke\|blocklist\|blacklist\|invalidate.*token' --include='*.js' --include='*.ts'
        --include='*.py' .
    expected_findings:
    - Revocation mechanism status
  - id: '5'
    name: Check Token Storage
    description: |
      Review client-side token storage for security.
    duration_estimate: 20 min
    commands:
    - purpose: Find localStorage usage
      command: grep -rn 'localStorage.*token\|sessionStorage.*token' --include='*.js' --include='*.ts'
        --include='*.jsx' --include='*.tsx' .
    - purpose: Check for HttpOnly cookies
      command: grep -rn 'httpOnly\|HttpOnly\|cookie.*token' --include='*.js' --include='*.ts' --include='*.py'
        .
    expected_findings:
    - Token storage security assessment
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - JWT Security Assessment
    - Token Lifecycle Analysis
    - Recommendations
  confidence_guidance:
    high: Direct evidence from code and configuration
    medium: Configuration patterns requiring verification
    low: Potential issues requiring runtime testing
offline:
  capability: full
  cache_manifest:
    knowledge:
    - source_id: owasp-jwt
      priority: required
    - source_id: rfc7519
      priority: required
profiles:
  membership:
    quick:
      included: false
      reason: Token lifecycle security requires thorough analysis
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1
closeout_checklist:
- id: token-001
  item: JWT algorithm none not accepted
  level: CRITICAL
  verification: |
    if grep -rq 'alg.*none\|algorithm.*none' --include='*.js' --include='*.ts' --include='*.py' .; then echo "FAIL"; else echo "PASS"; fi
  expected: PASS
- id: token-002
  item: JWT signature verification enabled
  level: CRITICAL
  verification: |
    if grep -rq 'verify.*false\|ignoreExpiration.*true' --include='*.js' --include='*.ts' --include='*.py' .; then echo "FAIL"; else echo "PASS"; fi
  expected: PASS
- id: token-003
  item: Access tokens have appropriate expiration
  level: BLOCKING
  verification: manual
  verification_notes: Verify access token lifetime is 15-60 minutes
  expected: Confirmed by reviewer
- id: token-004
  item: Refresh token rotation implemented
  level: BLOCKING
  verification: |
    if grep -rq 'rotate.*token\|token.*rotation' --include='*.js' --include='*.ts' --include='*.py' .; then echo "PASS"; else echo "WARNING - Verify rotation"; fi
  expected: PASS
- id: token-005
  item: Tokens not stored in localStorage
  level: WARNING
  verification: |
    if grep -rq 'localStorage.*token\|localStorage\.setItem.*jwt' --include='*.js' --include='*.ts' --include='*.tsx' .; then echo "WARNING - localStorage used"; else echo "PASS"; fi
  expected: PASS
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: OWASP ASVS
    controls:
    - V3.5
    - V3.6
  - framework: OWASP API Security
    controls:
    - API2:2023
relationships:
  commonly_combined:
  - security-trust.authentication.session-management
  - security-trust.authentication.oauth2-implementation
  - security-trust.authentication.api-key-management
