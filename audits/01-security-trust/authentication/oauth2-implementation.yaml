audit:
  id: security-trust.authentication.oauth2-implementation
  name: OAuth2/OIDC Implementation Audit
  version: 1.0.0
  last_updated: '2026-01-18'
  status: active
  category: security-trust
  category_number: 1
  subcategory: authentication
  tier: phd
  estimated_duration: 4 hours
  completeness: complete
  requires_runtime: false
  destructive: false
execution:
  automatable: partial
  severity: critical
  scope: codebase
  default_profiles:
  - full
  - security
  blocks_phase: false
  parallelizable: true
description:
  what: |
    This audit examines OAuth2 and OpenID Connect (OIDC) implementations for
    security vulnerabilities, configuration weaknesses, and adherence to
    RFC 9700 (OAuth 2.0 Security Best Current Practice). It evaluates
    authorization flows, token handling, PKCE implementation, scope validation,
    redirect URI validation, and state parameter usage.
  why_it_matters: |
    OAuth2/OIDC is the foundation of modern authentication and authorization.
    Implementation flaws can lead to account takeover, unauthorized access to
    protected resources, token theft, and privilege escalation. The deprecated
    Implicit flow and missing PKCE protection are common attack vectors.
    Misconfigurations in redirect URI validation enable authorization code
    interception attacks.
  when_to_run:
  - Before production deployment of authentication systems
  - After changes to OAuth2/OIDC configuration
  - During security assessments and penetration testing
  - When integrating new identity providers
prerequisites:
  required_artifacts:
  - type: source_code
    description: Access to OAuth2/OIDC client and server implementation code
  - type: configuration
    description: OAuth2 client configuration files and environment variables
  access_requirements:
  - Read access to authentication service codebase
  - Access to OAuth2 client registration configurations
  - Access to identity provider integration settings
discovery:
  code_patterns:
  - pattern: response_type\s*[=:]\s*['"]?token['"]?
    type: regex
    scope: source
    purpose: Detect deprecated Implicit flow usage
  - pattern: grant_type\s*[=:]\s*['"]?password['"]?
    type: regex
    scope: source
    purpose: Detect deprecated Resource Owner Password Credentials flow
  - pattern: code_challenge|code_verifier|PKCE
    type: regex
    scope: source
    purpose: Verify PKCE implementation presence
  - pattern: state\s*[=:]|oauth.*state|authorization.*state
    type: regex
    scope: source
    purpose: Check for state parameter handling
  - pattern: redirect_uri|callback.*url|return.*url
    type: regex
    scope: source
    purpose: Locate redirect URI handling code
  - pattern: alg['"]?\s*[=:]\s*['"]?none['"]?
    type: regex
    scope: source
    purpose: Detect JWT algorithm none vulnerability
  - pattern: verify\s*[=:]\s*false|verify_signature\s*[=:]\s*false
    type: regex
    scope: source
    purpose: Detect disabled signature verification
  - pattern: client_secret|CLIENT_SECRET
    type: regex
    scope: source
    purpose: Check for hardcoded client secrets
  file_patterns:
  - glob: '**/*oauth*'
    purpose: OAuth configuration and implementation files
  - glob: '**/*oidc*'
    purpose: OpenID Connect implementation files
  - glob: '**/auth/**'
    purpose: Authentication module files
  - glob: '**/.env*'
    purpose: Environment files potentially containing OAuth secrets
knowledge_sources:
  specifications:
  - id: rfc9700
    name: RFC 9700 - OAuth 2.0 Security Best Current Practice
    url: https://datatracker.ietf.org/doc/rfc9700/
    offline_cache: true
    priority: required
  - id: rfc6749
    name: RFC 6749 - The OAuth 2.0 Authorization Framework
    url: https://datatracker.ietf.org/doc/html/rfc6749
    offline_cache: true
    priority: required
  - id: rfc7636
    name: RFC 7636 - PKCE for OAuth Public Clients
    url: https://datatracker.ietf.org/doc/html/rfc7636
    offline_cache: true
    priority: required
  - id: oidc-core
    name: OpenID Connect Core 1.0
    url: https://openid.net/specs/openid-connect-core-1_0.html
    offline_cache: true
    priority: required
  - id: nist-800-53
    name: NIST SP 800-53 Security and Privacy Controls
    url: https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final
    offline_cache: true
    priority: required
  - id: nist-800-207
    name: NIST SP 800-207 Zero Trust Architecture
    url: https://csrc.nist.gov/publications/detail/sp/800-207/final
    offline_cache: true
    priority: required
  - id: nsa-zero-trust
    name: NSA Embracing a Zero Trust Security Model
    url: https://media.defense.gov/2021/Feb/25/2002588479/-1/-1/0/CSI_EMBRACING_ZT_SECURITY_MODEL_UOO115131-21.PDF
    offline_cache: true
    priority: required
  - id: owasp-asvs
    name: OWASP Application Security Verification Standard
    url: https://owasp.org/www-project-application-security-verification-standard/
    offline_cache: true
    priority: required
  guides:
  - id: owasp-oauth2
    name: OWASP OAuth2 Cheat Sheet
    url: https://cheatsheetseries.owasp.org/cheatsheets/OAuth2_Cheat_Sheet.html
    offline_cache: true
  - id: owasp-testing-oauth
    name: OWASP Testing for OAuth Weaknesses
    url: https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/05-Testing_for_OAuth_Weaknesses
    offline_cache: true
tooling:
  static_analysis:
  - tool: semgrep
    purpose: Detect OAuth2/OIDC security patterns
    offline_capable: true
  - tool: eslint-plugin-security
    purpose: JavaScript OAuth security linting
    offline_capable: true
  scripts:
  - id: oauth-flow-detector
    language: bash
    purpose: Detect OAuth flow types in codebase
    source: inline
    code: |
      #!/bin/bash
      echo "=== OAuth Flow Detection ==="
      echo "Implicit Flow (DEPRECATED):"
      grep -rn "response_type.*token" --include="*.js" --include="*.ts" --include="*.py" --include="*.java" .
      echo ""
      echo "ROPC Flow (DEPRECATED):"
      grep -rn "grant_type.*password" --include="*.js" --include="*.ts" --include="*.py" --include="*.java" .
      echo ""
      echo "PKCE Implementation:"
      grep -rn "code_challenge\|code_verifier" --include="*.js" --include="*.ts" --include="*.py" --include="*.java" .
signals:
  critical:
  - id: AUTH-OAUTH-CRIT-001
    signal: Implicit OAuth flow in use (response_type=token)
    cwe: CWE-287
    evidence_pattern: response_type\s*[=:]\s*['"]?token['"]?
    explanation: |
      The Implicit flow is deprecated in OAuth 2.1 and RFC 9700 due to token
      exposure in browser history, referrer headers, and URL fragments.
      Access tokens are directly exposed to the client without
      server-side verification.
    remediation: |
      Migrate to Authorization Code flow with PKCE. Update OAuth client
      configuration to use response_type=code with code_challenge parameter.
  - id: AUTH-OAUTH-CRIT-002
    signal: JWT signature verification disabled or algorithm set to none
    cwe: CWE-347
    evidence_pattern: alg['"]?\s*[=:]\s*['"]?none['"]?|verify.*[=:].*false
    explanation: |
      Disabling JWT signature verification or accepting 'none' algorithm
      allows attackers to forge tokens with arbitrary claims. This is a
      critical vulnerability that enables complete authentication bypass.
    remediation: |
      Always verify JWT signatures. Explicitly whitelist allowed algorithms
      (RS256, ES256). Reject tokens with alg=none. Use well-maintained
      JWT libraries that prevent algorithm confusion attacks.
  - id: AUTH-OAUTH-CRIT-003
    signal: Client secret exposed in client-side code or version control
    cwe: CWE-798
    evidence_pattern: client_secret\s*[=:]\s*['"][a-zA-Z0-9_-]{20,}['"]
    explanation: |
      OAuth client secrets in frontend code or repositories can be extracted
      by attackers, enabling them to impersonate the legitimate client
      application and obtain tokens.
    remediation: |
      Remove client secrets from client-side code. Use PKCE for public
      clients. Store secrets in secure vaults. For confidential clients,
      keep secrets server-side only.
  high:
  - id: AUTH-OAUTH-HIGH-001
    signal: PKCE not implemented for authorization code flow
    cwe: CWE-352
    evidence_pattern: response_type.*code(?!.*code_challenge)
    explanation: |
      Without PKCE, authorization codes can be intercepted by malicious
      apps on the same device or through redirect URI manipulation.
      PKCE is required for all clients per RFC 9700.
    remediation: |
      Implement PKCE with S256 challenge method. Generate cryptographically
      random code_verifier (43-128 chars). Transmit code_challenge with
      authorization request.
  - id: AUTH-OAUTH-HIGH-002
    signal: Resource Owner Password Credentials (ROPC) grant in use
    cwe: CWE-522
    evidence_pattern: grant_type\s*[=:]\s*['"]?password['"]?
    explanation: |
      ROPC exposes user credentials directly to the client application,
      violating OAuth's core security model. It is deprecated in OAuth 2.1
      and should only be used for migration from legacy systems.
    remediation: |
      Migrate to Authorization Code flow with PKCE or Device Authorization
      Grant for limited-input devices. Remove ROPC grant type from
      authorization server configuration.
  - id: AUTH-OAUTH-HIGH-003
    signal: Missing or weak state parameter validation
    cwe: CWE-352
    evidence_pattern: state\s*[=:]\s*['"][a-zA-Z0-9]{1,8}['"]
    explanation: |
      Weak or missing state parameters enable CSRF attacks during OAuth
      flows. Attackers can trick users into authorizing malicious requests
      or associate their accounts with attacker-controlled identities.
    remediation: |
      Generate cryptographically random state values (min 32 bytes).
      Store state in session before redirect. Validate state matches
      on callback. Consider using PKCE which provides implicit CSRF protection.
  - id: AUTH-OAUTH-HIGH-004
    signal: Insufficient redirect URI validation
    cwe: CWE-601
    evidence_pattern: redirect_uri.*\*|callback.*contains|startsWith.*redirect
    explanation: |
      Permissive redirect URI validation (wildcards, prefix matching)
      enables authorization code or token theft through open redirects.
      Attackers can redirect authorization responses to malicious endpoints.
    remediation: |
      Use exact string matching for redirect URIs. Register all valid
      redirect URIs explicitly. Do not use wildcards or pattern matching.
      Validate both scheme and host components.
  medium:
  - id: AUTH-OAUTH-MED-001
    signal: Overly broad OAuth scopes requested
    cwe: CWE-250
    evidence_pattern: scope.*['"]\*['"]|scope.*admin|scope.*full
    remediation: |
      Request minimum necessary scopes. Use fine-grained scope definitions.
      Implement scope reduction for less sensitive operations.
  - id: AUTH-OAUTH-MED-002
    signal: Access tokens with excessive lifetime
    cwe: CWE-613
    evidence_pattern: expires_in.*['"]?(86400|172800|604800|2592000)
    remediation: |
      Set access token lifetime to 5-15 minutes for sensitive resources.
      Use refresh tokens for extended sessions. Implement token refresh
      rotation.
  - id: AUTH-OAUTH-MED-003
    signal: Missing ID token validation (iss, aud, exp)
    cwe: CWE-345
    evidence_pattern: decode.*jwt(?!.*verify)|parseJwt(?!.*validate)
    remediation: |
      Validate all ID token claims: iss (issuer), aud (audience),
      exp (expiration), nonce. Use OIDC library validation functions.
  low:
  - id: AUTH-OAUTH-LOW-001
    signal: OAuth debug logging enabled in production
    evidence_pattern: oauth.*debug\s*[=:]\s*true|LOG_OAUTH.*true
    remediation: |
      Disable OAuth debug logging in production environments.
      Ensure tokens are not logged.
  positive:
  - id: AUTH-OAUTH-POS-001
    signal: PKCE with S256 challenge method implemented
    evidence_pattern: code_challenge_method.*S256|challenge.*sha256
  - id: AUTH-OAUTH-POS-002
    signal: Secure JWT library with algorithm whitelist
    evidence_pattern: algorithms\s*[=:]\s*\[.*RS256.*ES256
procedure:
  context:
    cognitive_mode: critical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Identify OAuth Flow Types
    description: |
      Scan codebase for OAuth grant types in use. Flag deprecated
      Implicit and ROPC flows.
    duration_estimate: 30 min
    commands:
    - purpose: Detect Implicit flow usage
      command: grep -rn 'response_type.*token' --include='*.js' --include='*.ts' --include='*.py' --include='*.java'
        --include='*.go' .
    - purpose: Detect ROPC flow usage
      command: grep -rn 'grant_type.*password' --include='*.js' --include='*.ts' --include='*.py' --include='*.java'
        --include='*.go' .
    expected_findings:
    - List of files using deprecated OAuth flows
  - id: '2'
    name: Verify PKCE Implementation
    description: |
      Check for PKCE code_challenge and code_verifier implementation
      in authorization code flows.
    duration_estimate: 30 min
    commands:
    - purpose: Search for PKCE implementation
      command: grep -rn 'code_challenge\|code_verifier\|PKCE' --include='*.js' --include='*.ts' --include='*.py'
        --include='*.java' .
    - purpose: Verify S256 challenge method
      command: grep -rn 'code_challenge_method.*S256\|sha256' --include='*.js' --include='*.ts' --include='*.py'
        .
    expected_findings:
    - PKCE implementation in all authorization code flows
    - S256 challenge method usage
  - id: '3'
    name: Audit Token Security
    description: |
      Examine JWT handling, signature verification, algorithm
      configuration, and token lifetime settings.
    duration_estimate: 45 min
    commands:
    - purpose: Check for algorithm none vulnerability
      command: grep -rn 'alg.*none\|algorithm.*none' --include='*.js' --include='*.ts' --include='*.py'
        --include='*.java' .
    - purpose: Find signature verification bypass
      command: grep -rn 'verify.*false\|skipVerification\|noVerify' --include='*.js' --include='*.ts'
        --include='*.py' .
    expected_findings:
    - JWT signature verification enabled
    - Explicit algorithm whitelist
  - id: '4'
    name: Validate Redirect URI Handling
    description: |
      Analyze redirect URI validation logic for open redirect
      vulnerabilities.
    duration_estimate: 30 min
    commands:
    - purpose: Find redirect URI handling
      command: grep -rn 'redirect_uri\|callback.*url\|return_to' --include='*.js' --include='*.ts' --include='*.py'
        --include='*.java' .
    expected_findings:
    - Exact match redirect URI validation
    - No wildcard or pattern-based matching
  - id: '5'
    name: Check Secret Management
    description: |
      Verify OAuth client secrets are not exposed in code
      or configuration files.
    duration_estimate: 30 min
    commands:
    - purpose: Search for hardcoded client secrets
      command: grep -rn 'client_secret.*=\|CLIENT_SECRET.*=' --include='*.js' --include='*.ts' --include='*.py'
        --include='*.env' .
    expected_findings:
    - No hardcoded client secrets
    - Secrets loaded from secure vault
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - OAuth Flow Analysis
    - Token Security Assessment
    - Recommendations
  confidence_guidance:
    high: Direct evidence of vulnerable code patterns verified through testing
    medium: Pattern matches indicating likely vulnerability, needs verification
    low: Circumstantial evidence suggesting potential issues
offline:
  capability: full
  cache_manifest:
    knowledge:
    - source_id: rfc9700
      priority: required
    - source_id: owasp-oauth2
      priority: required
profiles:
  membership:
    quick:
      included: false
      reason: OAuth security requires thorough analysis
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1
closeout_checklist:
- id: oauth2-001
  item: No deprecated Implicit flow usage detected
  level: CRITICAL
  verification: |
    if grep -rq 'response_type.*token' --include='*.js' --include='*.ts' --include='*.py' --include='*.java' .; then echo "FAIL"; else echo "PASS"; fi
  expected: PASS
- id: oauth2-002
  item: No ROPC grant type in use
  level: CRITICAL
  verification: |
    if grep -rq 'grant_type.*password' --include='*.js' --include='*.ts' --include='*.py' --include='*.java' .; then echo "FAIL"; else echo "PASS"; fi
  expected: PASS
- id: oauth2-003
  item: PKCE implemented for authorization code flows
  level: BLOCKING
  verification: |
    if grep -rq 'code_challenge\|code_verifier' --include='*.js' --include='*.ts' --include='*.py' .; then echo "PASS"; else echo "FAIL - No PKCE found"; fi
  expected: PASS
- id: oauth2-004
  item: No JWT algorithm none vulnerability
  level: CRITICAL
  verification: |
    if grep -rq 'alg.*none' --include='*.js' --include='*.ts' --include='*.py' --include='*.json' .; then echo "FAIL"; else echo "PASS"; fi
  expected: PASS
- id: oauth2-005
  item: No hardcoded client secrets in source code
  level: BLOCKING
  verification: |
    if grep -rq 'client_secret\s*[=:]\s*["\x27][a-zA-Z0-9_-]\{20,\}' --include='*.js' --include='*.ts' --include='*.py' .; then echo "FAIL"; else echo "PASS"; fi
  expected: PASS
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: OWASP ASVS
    controls:
    - V2.1
    - V3.1
    - V3.5
  - framework: NIST 800-63B
    controls:
    - '5.1'
    - '5.2'
relationships:
  commonly_combined:
  - security-trust.authentication.session-management
  - security-trust.authentication.token-lifecycle
  - security-trust.authentication.sso-federated-identity
