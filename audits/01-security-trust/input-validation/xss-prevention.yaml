audit:
  id: security-trust.input-validation.xss-prevention
  name: XSS (Cross-Site Scripting) Audit
  version: 1.0.0
  last_updated: '2026-01-18'
  status: active
  category: security-trust
  category_number: 1
  subcategory: input-validation
  tier: phd
  estimated_duration: 3 hours
  completeness: complete
  requires_runtime: false
  destructive: false
execution:
  automatable: partial
  severity: critical
  scope: codebase
  default_profiles:
  - full
  - security
  - quick
  blocks_phase: true
  parallelizable: true
description:
  what: |
    This audit examines the codebase for Cross-Site Scripting (XSS) vulnerabilities -
    instances where user-controlled input is rendered in web pages without proper
    sanitization or encoding. It identifies reflected XSS, stored XSS, and DOM-based
    XSS patterns, as well as missing Content Security Policy (CSP) headers.
  why_it_matters: |
    XSS (CWE-79) is one of the most prevalent web vulnerabilities, ranking in
    OWASP Top 10 under A03:2021-Injection. XSS allows attackers to execute
    malicious scripts in victims' browsers, leading to session hijacking,
    credential theft, defacement, malware distribution, and phishing. CISA
    classifies XSS as a "Secure by Design" priority that should be eliminated
    from all software products.
  when_to_run:
  - Initial security audit of web applications
  - Code review for frontend/template changes
  - Before production deployment
  - After adding user-generated content features
  - When implementing new rendering logic
prerequisites:
  required_artifacts:
  - type: source_code
    description: Frontend and backend source code including templates
  - type: configuration
    description: Web server and CSP configuration
  access_requirements:
  - Read access to source code repositories
  - Access to web server configuration
  - Access to HTTP response headers
discovery:
  code_patterns:
  - pattern: \.innerHTML\s*=|\.outerHTML\s*=
    type: regex
    scope: source
    purpose: Detect innerHTML/outerHTML assignment (DOM XSS risk)
  - pattern: document\.write\(|document\.writeln\(
    type: regex
    scope: source
    purpose: Detect document.write usage (XSS risk)
  - pattern: \$\{.*\}.*<.*>|<.*>.*\$\{.*\}
    type: regex
    scope: source
    purpose: Detect template literals in HTML context
  - pattern: dangerouslySetInnerHTML
    type: regex
    scope: source
    purpose: Detect React dangerous HTML insertion
  - pattern: v-html\s*=
    type: regex
    scope: source
    purpose: Detect Vue v-html directive (XSS risk)
  - pattern: bypassSecurityTrust|sanitize.*bypass
    type: regex
    scope: source
    purpose: Detect Angular security bypass
  - pattern: mark_safe\(|\|safe\}|\{\{.*\|safe
    type: regex
    scope: source
    purpose: Detect Django/Jinja2 safe filter (disables escaping)
  - pattern: autoescape\s*=\s*False|\{%\s*autoescape\s+false
    type: regex
    scope: source
    purpose: Detect autoescape disabled
  - pattern: <\?=\s*\$|echo\s+\$.*>|print\s+\$.*>
    type: regex
    scope: source
    purpose: Detect PHP direct output without encoding
  - pattern: <%=\s*raw|<%-.*raw|html_safe
    type: regex
    scope: source
    purpose: Detect Ruby raw HTML output
  - pattern: '@Html\.Raw\(|<%=.*%>'
    type: regex
    scope: source
    purpose: Detect ASP.NET raw HTML output
  - pattern: \.html\s*\(.*\$|\$\(.*\)\.html\(
    type: regex
    scope: source
    purpose: Detect jQuery html() with potential user input
  - pattern: eval\s*\(|new\s+Function\s*\(
    type: regex
    scope: source
    purpose: Detect eval/Function (script injection risk)
  - pattern: location\.(search|hash|href).*innerHTML|getParameter.*innerHTML
    type: regex
    scope: source
    purpose: Detect URL parameters used in DOM (reflected XSS)
  - pattern: (escapeHtml|htmlEncode|htmlspecialchars|HtmlEncode|encodeForHTML)
    type: regex
    scope: source
    purpose: Detect HTML encoding functions (positive)
  - pattern: (textContent|innerText)\s*=
    type: regex
    scope: source
    purpose: Detect safe text assignment (positive)
  file_patterns:
  - glob: '**/*.html'
    purpose: HTML templates
  - glob: '**/*.jsx'
    purpose: React JSX files
  - glob: '**/*.tsx'
    purpose: TypeScript React files
  - glob: '**/*.vue'
    purpose: Vue single-file components
  - glob: '**/*.ejs'
    purpose: EJS templates
  - glob: '**/*.erb'
    purpose: Ruby ERB templates
  - glob: '**/*.blade.php'
    purpose: Laravel Blade templates
  - glob: '**/*.jinja'
    purpose: Jinja templates
  - glob: '**/*.jinja2'
    purpose: Jinja2 templates
  - glob: '**/templates/**'
    purpose: Template directories
knowledge_sources:
  specifications:
  - id: cwe-79
    name: 'CWE-79: Improper Neutralization of Input During Web Page Generation'
    url: https://cwe.mitre.org/data/definitions/79.html
    offline_cache: true
    priority: required
  - id: owasp-top-10
    name: OWASP Top 10 Web Application Security Risks
    url: https://owasp.org/www-project-top-ten/
    offline_cache: true
    priority: required
  - id: owasp-asvs
    name: OWASP Application Security Verification Standard
    url: https://owasp.org/www-project-application-security-verification-standard/
    offline_cache: true
    priority: required
  - id: cisa-known-exploited
    name: CISA Known Exploited Vulnerabilities Catalog
    url: https://www.cisa.gov/known-exploited-vulnerabilities-catalog
    offline_cache: false
    priority: required
  guides:
  - id: owasp-xss-prevention
    name: OWASP Cross Site Scripting Prevention Cheat Sheet
    url: https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html
    offline_cache: true
  - id: owasp-dom-xss
    name: OWASP DOM based XSS Prevention Cheat Sheet
    url: https://cheatsheetseries.owasp.org/cheatsheets/DOM_based_XSS_Prevention_Cheat_Sheet.html
    offline_cache: true
  - id: owasp-csp
    name: OWASP Content Security Policy Cheat Sheet
    url: https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html
    offline_cache: true
  - id: cisa-xss
    name: 'CISA Secure by Design Alert: Eliminating XSS Vulnerabilities'
    url: https://www.cisa.gov/resources-tools/resources/secure-design-alert-eliminating-cross-site-scripting-vulnerabilities
    offline_cache: true
tooling:
  static_analysis:
  - tool: semgrep
    purpose: Detect XSS patterns across languages and frameworks
    offline_capable: true
  - tool: eslint-plugin-security
    purpose: JavaScript XSS detection
    offline_capable: true
  - tool: bandit
    purpose: Python security linting including XSS
    offline_capable: true
  - tool: brakeman
    purpose: Ruby on Rails security scanner
    offline_capable: true
  infrastructure_tools:
  - tool: observatory
    purpose: Scan HTTP headers including CSP
    command: observatory --host example.com
  - tool: csp-evaluator
    purpose: Evaluate CSP effectiveness
    command: https://csp-evaluator.withgoogle.com/
  scripts:
  - id: detect-xss-patterns
    language: bash
    purpose: Detect potential XSS vulnerabilities
    source: inline
    code: |
      #!/bin/bash
      echo "=== XSS Vulnerability Detection ==="

      echo "--- innerHTML/outerHTML usage ---"
      grep -rn --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" \
        -E "\\.innerHTML\s*=|\\.outerHTML\s*=" . 2>/dev/null | head -30 || echo "None found"

      echo "--- document.write usage ---"
      grep -rn --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" \
        -E "document\\.write\(|document\\.writeln\(" . 2>/dev/null | head -20 || echo "None found"

      echo "--- React dangerouslySetInnerHTML ---"
      grep -rn --include="*.js" --include="*.jsx" --include="*.tsx" \
        "dangerouslySetInnerHTML" . 2>/dev/null | head -20 || echo "None found"

      echo "--- Django/Jinja safe filter ---"
      grep -rn --include="*.html" --include="*.jinja" --include="*.jinja2" \
        -E "mark_safe|\\|safe\\}" . 2>/dev/null | head -20 || echo "None found"

      echo "--- Vue v-html ---"
      grep -rn --include="*.vue" --include="*.html" "v-html" . 2>/dev/null | head -20 || echo "None found"

      echo "--- eval/Function usage ---"
      grep -rn --include="*.js" --include="*.ts" \
        -E "eval\s*\(|new\s+Function\s*\(" . 2>/dev/null | head -20 || echo "None found"
signals:
  critical:
  - id: XSS-CRIT-001
    signal: User input directly inserted via innerHTML
    cwe: CWE-79
    evidence_pattern: (request|user|input|param|query).*innerHTML|innerHTML.*\$\{|innerHTML.*\+
    explanation: |
      innerHTML assignment with user input allows direct script injection.
      An attacker can inject <script> tags or event handlers (onerror, onclick)
      that execute arbitrary JavaScript in the user's browser.
    remediation: |
      Replace innerHTML with textContent or innerText for text content.
      If HTML is required, use a sanitization library like DOMPurify:
      element.innerHTML = DOMPurify.sanitize(userInput);
      Or use createElement/appendChild for dynamic DOM construction.
  - id: XSS-CRIT-002
    signal: React dangerouslySetInnerHTML with user input
    cwe: CWE-79
    evidence_pattern: dangerouslySetInnerHTML.*\{.*__(html|user|input|data)
    explanation: |
      React's dangerouslySetInnerHTML bypasses React's built-in XSS
      protection. If user input reaches this prop, XSS is possible.
    remediation: |
      Avoid dangerouslySetInnerHTML when possible. If HTML rendering
      is required, sanitize input with DOMPurify before rendering:
      <div dangerouslySetInnerHTML={{__html: DOMPurify.sanitize(data)}} />
  - id: XSS-CRIT-003
    signal: eval() or Function() with user input
    cwe: CWE-79
    evidence_pattern: eval\s*\(.*request|eval\s*\(.*user|new\s+Function.*user
    explanation: |
      eval() and new Function() execute arbitrary code. If user input
      reaches these functions, attackers can execute any JavaScript,
      leading to complete compromise of the user's session.
    remediation: |
      Never use eval() or new Function() with user-controlled data.
      Use JSON.parse() for JSON data. For dynamic functionality,
      use safer alternatives like function references or switch statements.
  - id: XSS-CRIT-004
    signal: Template autoescape disabled
    cwe: CWE-79
    evidence_pattern: autoescape\s*=\s*False|\{%\s*autoescape\s+(false|off)
    explanation: |
      Disabling autoescape in template engines removes automatic XSS
      protection. All output becomes potentially dangerous.
    remediation: |
      Never disable autoescape globally. If raw HTML is needed for
      specific cases, use targeted safe filters only for trusted
      content, and sanitize any user input.
  high:
  - id: XSS-HIGH-001
    signal: mark_safe or |safe with user input
    cwe: CWE-79
    evidence_pattern: mark_safe\(.*request|mark_safe\(.*user|\|safe.*user
    explanation: |
      Django's mark_safe and Jinja's |safe filter tell the template
      engine to not escape the content. If user input is marked safe,
      XSS is possible.
    remediation: |
      Only use mark_safe/|safe for truly trusted content (static HTML).
      For user content requiring HTML, use bleach or similar sanitizers:
      mark_safe(bleach.clean(user_input, tags=['p', 'b', 'i']))
  - id: XSS-HIGH-002
    signal: Vue v-html with user input
    cwe: CWE-79
    evidence_pattern: v-html\s*=\s*["']?\s*\{?\{?\s*(user|input|data)
    explanation: |
      Vue's v-html directive renders raw HTML, bypassing Vue's
      automatic escaping. User input in v-html enables XSS.
    remediation: |
      Use text interpolation {{ }} instead of v-html when possible.
      If HTML is required, sanitize with DOMPurify before binding:
      v-html="sanitizedContent" where sanitizedContent uses DOMPurify
  - id: XSS-HIGH-003
    signal: No Content Security Policy header
    cwe: CWE-79
    evidence_indicators:
    - No CSP header in HTTP responses
    - No <meta http-equiv="Content-Security-Policy"> tag
    explanation: |
      Without CSP, inline scripts and external script sources are
      unrestricted. CSP provides defense-in-depth against XSS by
      blocking unauthorized script execution.
    remediation: |
      Implement a strict CSP. Start with:
      Content-Security-Policy: default-src 'self'; script-src 'self';
      style-src 'self'; img-src 'self' data:;
      Use nonces or hashes for inline scripts if needed.
  - id: XSS-HIGH-004
    signal: Angular bypassSecurityTrust usage
    cwe: CWE-79
    evidence_pattern: bypassSecurityTrust(Html|Script|Style|Url|ResourceUrl)
    explanation: |
      Angular's bypassSecurityTrust methods disable Angular's built-in
      XSS protection. If user input reaches these methods, XSS is possible.
    remediation: |
      Avoid bypass methods when possible. If required, ensure input
      is thoroughly sanitized before bypassing. Prefer Angular's
      built-in sanitization.
  medium:
  - id: XSS-MED-001
    signal: jQuery .html() with dynamic content
    cwe: CWE-79
    evidence_pattern: \.html\s*\(.*\$|\$\(.*\)\.html\((?!\s*['"])
    explanation: |
      jQuery's .html() method sets innerHTML and can lead to XSS
      if used with unsanitized user input.
    remediation: |
      Use .text() instead of .html() for text content.
      Sanitize input if HTML is required:
      $(element).html(DOMPurify.sanitize(userContent));
  - id: XSS-MED-002
    signal: URL parameters used in DOM manipulation
    cwe: CWE-79
    evidence_pattern: location\.(search|hash|href).*document|getParameter.*dom
    explanation: |
      URL parameters are attacker-controlled. Using them in DOM
      manipulation can lead to reflected XSS attacks.
    remediation: |
      Validate and sanitize URL parameters before DOM usage.
      Use textContent instead of innerHTML. Encode for output context.
  - id: XSS-MED-003
    signal: document.write usage
    cwe: CWE-79
    evidence_pattern: document\.write\(|document\.writeln\(
    explanation: |
      document.write() is dangerous as it can execute scripts and
      is particularly vulnerable in modern async contexts.
    remediation: |
      Replace document.write() with DOM manipulation methods:
      createElement(), appendChild(), textContent assignment.
  low:
  - id: XSS-LOW-001
    signal: CSP with unsafe-inline
    evidence_pattern: Content-Security-Policy.*unsafe-inline
    explanation: |
      unsafe-inline in CSP allows inline scripts, reducing CSP's
      effectiveness against XSS.
    remediation: |
      Replace unsafe-inline with nonces or hashes for specific
      inline scripts that are required.
  positive:
  - id: XSS-POS-001
    signal: HTML encoding functions used consistently
    evidence_pattern: (escapeHtml|htmlEncode|htmlspecialchars|encodeForHTML|DOMPurify)
    explanation: |
      The codebase uses HTML encoding/sanitization functions,
      demonstrating awareness of XSS prevention.
  - id: XSS-POS-002
    signal: textContent used instead of innerHTML
    evidence_pattern: \.textContent\s*=|\.innerText\s*=
    explanation: |
      textContent and innerText are safe for text content as they
      don't parse HTML.
  - id: XSS-POS-003
    signal: Strict Content Security Policy implemented
    evidence_pattern: Content-Security-Policy.*script-src\s+'self'
    explanation: |
      A strict CSP provides defense-in-depth against XSS attacks.
  - id: XSS-POS-004
    signal: Modern framework with auto-escaping
    evidence_pattern: (React|Vue|Angular|Svelte).*render|\{\{.*\}\}
    explanation: |
      Modern frameworks auto-escape by default, providing baseline
      XSS protection when used correctly.
procedure:
  context:
    cognitive_mode: critical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Identify all output points
    description: |
      Find all locations where dynamic content is rendered in HTML,
      including template files, JavaScript DOM manipulation, and
      server-side rendering.
    duration_estimate: 30 min
    commands:
    - purpose: Find template files
      command: |
        find . -name "*.html" -o -name "*.ejs" -o -name "*.jsx" -o -name "*.vue" \
          -o -name "*.erb" -o -name "*.jinja*" 2>/dev/null | head -50
    - purpose: Find DOM manipulation
      command: |
        grep -rn --include="*.js" --include="*.ts" \
          -E "(innerHTML|outerHTML|document\.write|\.html\()" . 2>/dev/null | head -50
    expected_findings:
    - Inventory of all output/rendering points
    - Classification by output type
  - id: '2'
    name: Detect dangerous patterns
    description: |
      Search for patterns that bypass automatic escaping or
      directly insert user content.
    duration_estimate: 30 min
    commands:
    - purpose: Find innerHTML usage
      command: |
        grep -rn --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" \
          "\.innerHTML\s*=" . 2>/dev/null | head -30
    - purpose: Find framework escape bypasses
      command: |
        grep -rn --include="*.js" --include="*.jsx" --include="*.vue" --include="*.html" \
          -E "(dangerouslySetInnerHTML|v-html|bypassSecurityTrust)" . 2>/dev/null | head -30
    - purpose: Find template safe filters
      command: |
        grep -rn --include="*.html" --include="*.jinja*" --include="*.erb" \
          -E "(mark_safe|\|safe|\.raw|html_safe)" . 2>/dev/null | head -30
    expected_findings:
    - List of dangerous output patterns
    - Context for each finding
  - id: '3'
    name: Check CSP implementation
    description: |
      Verify Content Security Policy is implemented and properly
      configured.
    duration_estimate: 20 min
    commands:
    - purpose: Find CSP headers in code
      command: |
        grep -rn "Content-Security-Policy" . 2>/dev/null | head -20
    - purpose: Find CSP meta tags
      command: |
        grep -rn --include="*.html" "http-equiv.*Content-Security-Policy" . 2>/dev/null | head -10
    expected_findings:
    - CSP implementation status
    - CSP policy evaluation
  - id: '4'
    name: Verify encoding functions
    description: |
      Check that proper encoding/sanitization is used for user content.
    duration_estimate: 20 min
    commands:
    - purpose: Find encoding function usage
      command: |
        grep -rn --include="*.js" --include="*.py" --include="*.java" \
          -E "(escapeHtml|htmlEncode|htmlspecialchars|DOMPurify|bleach)" . 2>/dev/null | head -30
    expected_findings:
    - Encoding function inventory
    - Coverage assessment
  - id: '5'
    name: Run static analysis
    description: |
      Execute security-focused static analysis tools for XSS.
    duration_estimate: 30 min
    commands:
    - purpose: Run Semgrep XSS rules
      command: |
        semgrep --config=p/xss . 2>/dev/null | head -100 || echo "Semgrep not available"
    - purpose: Run ESLint security plugin
      command: |
        npx eslint --plugin security --rule 'security/detect-non-literal-regexp: warn' . 2>/dev/null | head -50 || echo "ESLint not available"
    expected_findings:
    - Static analysis XSS findings
    - Additional patterns from tooling
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Critical XSS Vulnerabilities
    - Stored XSS Findings
    - DOM XSS Findings
    - CSP Assessment
    - Remediation Roadmap
  confidence_guidance:
    high: Direct evidence of user input in dangerous sinks
    medium: Dangerous patterns found, user input source unclear
    low: Potential issues based on patterns, needs data flow analysis
offline:
  capability: full
  cache_manifest:
    knowledge:
    - source_id: cwe-79
      priority: required
    - source_id: owasp-xss-prevention
      priority: required
    - source_id: owasp-csp
      priority: recommended
profiles:
  membership:
    quick:
      included: true
      reason: XSS is critical and frequently exploited
      priority: 1
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1
closeout_checklist:
- id: xss-001
  item: No innerHTML with user input
  level: CRITICAL
  verification: |
    ! grep -rn --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" \
      -E "(request|user|input|param).*innerHTML" . 2>/dev/null | grep -v test && echo "PASS" || echo "FAIL"
  expected: PASS
- id: xss-002
  item: No dangerouslySetInnerHTML with unsanitized input
  level: CRITICAL
  verification: |
    ! grep -rn --include="*.jsx" --include="*.tsx" \
      "dangerouslySetInnerHTML" . 2>/dev/null | grep -v "DOMPurify\|sanitize" | grep -v test && echo "NEEDS_REVIEW" || echo "PASS"
  expected: PASS
- id: xss-003
  item: Content Security Policy implemented
  level: BLOCKING
  verification: |
    grep -rn "Content-Security-Policy" . 2>/dev/null && echo "PASS" || echo "NEEDS_CSP"
  expected: PASS
- id: xss-004
  item: No eval() or Function() with user input
  level: CRITICAL
  verification: |
    ! grep -rn --include="*.js" --include="*.ts" \
      -E "eval\s*\(|new\s+Function\s*\(" . 2>/dev/null | grep -v test | grep -v node_modules && echo "PASS" || echo "NEEDS_REVIEW"
  expected: PASS
- id: xss-005
  item: Template autoescape not disabled
  level: BLOCKING
  verification: |
    ! grep -rn --include="*.html" --include="*.jinja*" \
      "autoescape.*false\|autoescape.*off" . 2>/dev/null && echo "PASS" || echo "FAIL"
  expected: PASS
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: OWASP Top 10
    controls:
    - A03:2021 - Injection
  - framework: CWE
    controls:
    - CWE-79
    - CWE-80
    - CWE-87
  - framework: SANS Top 25
    controls:
    - CWE-79
  - framework: PCI DSS
    controls:
    - 6.5.7
  - framework: OWASP ASVS
    controls:
    - V5.3.3
  - framework: CISA Secure by Design
    controls:
    - XSS Elimination
relationships:
  commonly_combined:
  - security-trust.input-validation.template-injection
  - security-trust.input-validation.header-injection
  - security-trust.network-security.csp-configuration
