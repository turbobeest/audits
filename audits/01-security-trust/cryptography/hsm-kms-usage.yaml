audit:
  id: security-trust.cryptography.hsm-kms-usage
  name: HSM/KMS Usage Audit
  version: 1.0.0
  last_updated: '2026-01-18'
  status: active
  category: security-trust
  category_number: 1
  subcategory: cryptography
  tier: phd
  estimated_duration: 4 hours
  completeness: requires_discovery
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: high
  scope: infrastructure
  default_profiles:
  - full
  - security
  blocks_phase: false
  parallelizable: true
description:
  what: |
    This audit examines the proper use of Hardware Security Modules (HSMs) and
    Key Management Services (KMS) for cryptographic key protection. It verifies
    that sensitive keys are stored in FIPS 140-2/140-3 validated hardware,
    proper access controls are configured, and key management follows NIST
    SP 800-57 guidelines.
  why_it_matters: |
    HSMs and KMS provide hardware-protected boundaries for cryptographic
    operations, ensuring keys never exist in plaintext outside secure hardware.
    Without proper HSM/KMS usage, keys may be exposed in application memory,
    logs, or backups, leading to complete compromise of encrypted data.
    FIPS 140-2/3 Level 3 certification is required by many compliance
    frameworks including FedRAMP, PCI DSS, and HIPAA.
  when_to_run:
  - Initial security architecture review
  - Before handling regulated data (PCI, HIPAA, FedRAMP)
  - When implementing encryption for sensitive data
  - During cloud security assessment
  - Annual compliance review
prerequisites:
  required_artifacts:
  - type: source_code
    description: Source code with cryptographic operations
  - type: infrastructure_config
    description: Cloud infrastructure configuration (Terraform, CloudFormation, etc.)
  - type: documentation
    description: Key management architecture documentation
  access_requirements:
  - Read access to source code repositories
  - Read access to cloud KMS configuration
  - Access to IAM/RBAC policies for KMS
  - HSM audit log access (if applicable)
discovery:
  code_patterns:
  - pattern: aws[._]kms|boto3\.client\(["']kms["']\)|KmsClient
    type: regex
    scope: source
    purpose: Detect AWS KMS usage
  - pattern: kms:Encrypt|kms:Decrypt|kms:GenerateDataKey
    type: regex
    scope: config
    purpose: Detect AWS KMS IAM permissions
  - pattern: google\.cloud\.kms|cloudkms\.googleapis\.com
    type: regex
    scope: source
    purpose: Detect GCP Cloud KMS usage
  - pattern: azure[._]keyvault|KeyVaultClient|SecretClient|CryptographyClient
    type: regex
    scope: source
    purpose: Detect Azure Key Vault usage
  - pattern: hvac|vault\.hashicorp|Vault\.Client
    type: regex
    scope: source
    purpose: Detect HashiCorp Vault usage
  - pattern: Cipher\.|AES\.|Fernet\(|cryptography\.fernet
    type: regex
    scope: source
    purpose: Detect direct crypto usage that may bypass KMS
  - pattern: (encryption_key|master_key|secret_key)\s*[=:]\s*["']
    type: regex
    scope: source
    purpose: Detect keys that should be in KMS
  - pattern: (data_key|DataKey|envelope|wrap.*key|unwrap.*key)
    type: regex
    scope: source
    purpose: Detect envelope encryption (KMS best practice)
  file_patterns:
  - glob: '**/*.tf'
    purpose: Terraform KMS configuration
  - glob: '**/cloudformation*.yaml'
    purpose: CloudFormation KMS configuration
  - glob: '**/cloudformation*.json'
    purpose: CloudFormation KMS configuration
  - glob: '**/kms*.yaml'
    purpose: KMS configuration files
  - glob: '**/vault*.yaml'
    purpose: Vault configuration files
  - glob: '**/iam*.json'
    purpose: IAM policy files
  infrastructure_queries:
  - system: AWS
    query: aws kms list-keys
    purpose: Inventory all KMS keys
  - system: AWS
    query: aws kms describe-key --key-id <key-id>
    purpose: Get KMS key details and HSM backing
  - system: GCP
    query: gcloud kms keyrings list --location=global
    purpose: Inventory GCP KMS keyrings
knowledge_sources:
  specifications:
  - id: nist-fips-140-3
    name: 'FIPS 140-3: Security Requirements for Cryptographic Modules'
    url: https://csrc.nist.gov/publications/detail/fips/140/3/final
    offline_cache: true
    priority: required
  - id: nist-sp-800-57
    name: 'NIST SP 800-57: Recommendation for Key Management'
    url: https://nvlpubs.nist.gov/nistpubs/specialpublications/nist.sp.800-57pt1r5.pdf
    offline_cache: true
    priority: required
  - id: nist-sp-800-130
    name: 'NIST SP 800-130: Framework for Designing Key Management Systems'
    url: https://csrc.nist.gov/pubs/sp/800/130/final
    offline_cache: true
    priority: recommended
  - id: nist-800-53
    name: NIST SP 800-53 Security and Privacy Controls
    url: https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final
    offline_cache: true
    priority: required
  - id: owasp-asvs
    name: OWASP Application Security Verification Standard
    url: https://owasp.org/www-project-application-security-verification-standard/
    offline_cache: true
    priority: required
  guides:
  - id: owasp-key-management
    name: OWASP Key Management Cheat Sheet
    url: https://cheatsheetseries.owasp.org/cheatsheets/Key_Management_Cheat_Sheet.html
    offline_cache: true
  - id: owasp-secrets-management
    name: OWASP Secrets Management Cheat Sheet
    url: https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
    offline_cache: true
  - id: aws-kms-best-practices
    name: AWS KMS Best Practices
    url: https://docs.aws.amazon.com/prescriptive-guidance/latest/aws-kms-best-practices/key-management.html
    offline_cache: true
  - id: nsa-cloud-key-management
    name: 'NSA Cloud Top 10: Secure Cloud Key Management Practices'
    url: https://media.defense.gov/2024/Mar/07/2003407858/-1/-1/0/CSI-CloudTop10-Key-Management.PDF
    offline_cache: true
  - id: cwe-320
    name: 'CWE-320: Key Management Errors'
    url: https://cwe.mitre.org/data/definitions/320.html
    offline_cache: true
tooling:
  static_analysis:
  - tool: semgrep
    purpose: Detect cryptographic patterns and KMS usage
    offline_capable: true
  - tool: checkov
    purpose: Scan Terraform/CloudFormation for KMS misconfigurations
    offline_capable: true
  - tool: tfsec
    purpose: Terraform security scanning including KMS
    offline_capable: true
  infrastructure_tools:
  - tool: aws-cli
    purpose: Query AWS KMS configuration and key policies
    command: aws kms describe-key --key-id <key-id>
  - tool: gcloud
    purpose: Query GCP Cloud KMS configuration
    command: gcloud kms keys describe <key> --keyring=<ring> --location=<loc>
  - tool: az
    purpose: Query Azure Key Vault configuration
    command: az keyvault show --name <vault-name>
  - tool: vault
    purpose: Query HashiCorp Vault configuration
    command: vault secrets list
  scripts:
  - id: audit-kms-usage
    language: bash
    purpose: Audit KMS key usage and configuration
    source: inline
    code: |
      #!/bin/bash
      echo "=== KMS Usage Audit ==="

      # AWS KMS
      echo "--- AWS KMS Keys ---"
      aws kms list-keys --query 'Keys[*].KeyId' --output text 2>/dev/null | \
        xargs -I {} sh -c 'echo "Key: {}"; aws kms describe-key --key-id {} --query "KeyMetadata.[KeyId,KeyState,Origin,KeySpec]" 2>/dev/null' || echo "AWS CLI not configured"

      # Check for customer managed keys
      echo "--- Customer Managed Keys ---"
      aws kms list-keys --query 'Keys[*].KeyId' --output text 2>/dev/null | \
        xargs -I {} aws kms describe-key --key-id {} --query "KeyMetadata | {KeyId: KeyId, Manager: KeyManager}" 2>/dev/null || echo "N/A"
signals:
  critical:
  - id: HSM-CRIT-001
    signal: Encryption keys stored outside HSM/KMS in plaintext
    cwe: CWE-311
    evidence_pattern: (encryption_key|master_key|aes_key)\s*[=:]\s*["'][A-Za-z0-9+/=]{16,}["']
    explanation: |
      Keys stored in plaintext in application code, configuration files, or
      environment variables can be extracted from memory, logs, backups, or
      by anyone with code access. HSM/KMS ensures keys are never exposed in
      plaintext outside hardware-protected boundaries.
    remediation: |
      Migrate all encryption keys to a FIPS 140-2/3 validated HSM or cloud KMS.
      Use envelope encryption pattern: KMS encrypts data encryption keys (DEKs),
      which are stored encrypted alongside data.
  - id: HSM-CRIT-002
    signal: KMS key policy allows unrestricted access
    cwe: CWE-732
    evidence_pattern: Principal.*\*|Effect.*Allow.*Action.*kms:\*
    explanation: |
      Overly permissive KMS key policies allow any principal to use keys for
      encryption/decryption, defeating the purpose of key management. This
      could allow attackers to decrypt sensitive data.
    remediation: |
      Implement least-privilege key policies. Specify exact principals and
      actions. Use IAM conditions to restrict access by VPC, time, or MFA.
      Enable key grants for temporary access instead of broad policies.
  - id: HSM-CRIT-003
    signal: Using non-FIPS validated cryptographic module
    cwe: CWE-327
    evidence_indicators:
    - HSM without FIPS 140-2/3 validation
    - Software-based key storage for regulated data
    - Custom crypto implementation
    explanation: |
      FIPS 140-2/3 validation ensures cryptographic modules meet rigorous
      security standards. Non-validated modules may have implementation
      flaws that compromise key security. Many compliance frameworks
      require FIPS-validated cryptography.
    remediation: |
      Use only FIPS 140-2 Level 2+ or FIPS 140-3 validated HSMs/KMS.
      AWS KMS, GCP Cloud HSM, and Azure Managed HSM are FIPS validated.
      Verify validation status on NIST CMVP website.
  high:
  - id: HSM-HIGH-001
    signal: No envelope encryption pattern used
    cwe: CWE-320
    evidence_indicators:
    - Direct encryption with master key
    - No data encryption key (DEK) generation
    - Master key used for bulk data encryption
    explanation: |
      Envelope encryption uses KMS to encrypt data encryption keys (DEKs)
      rather than data directly. This limits KMS calls, enables local
      caching of encrypted DEKs, and provides key hierarchy benefits.
      Without envelope encryption, every encryption operation requires
      KMS access, creating performance and availability issues.
    remediation: |
      Implement envelope encryption:
      1. Generate DEK via KMS GenerateDataKey
      2. Encrypt data locally with plaintext DEK
      3. Store encrypted DEK with data
      4. Use KMS to decrypt DEK when needed
  - id: HSM-HIGH-002
    signal: KMS key deletion protection disabled
    evidence_pattern: DeletionWindowInDays|ScheduleKeyDeletion|deletion_window
    explanation: |
      Without deletion protection, keys can be accidentally or maliciously
      deleted, permanently losing access to all encrypted data.
    remediation: |
      Enable deletion protection on all KMS keys. Use longer deletion
      windows (30 days). Implement CloudTrail alerts for deletion attempts.
      Consider multi-party approval for key deletion.
  - id: HSM-HIGH-003
    signal: Single-region KMS keys for multi-region data
    evidence_pattern: MultiRegion.*false|single.*region.*key
    explanation: |
      Single-region keys create availability risks for multi-region
      applications. If the key's region has an outage, encrypted data
      in other regions becomes inaccessible.
    remediation: |
      Use multi-region KMS keys for data accessed across regions.
      Implement key replication to disaster recovery regions.
      Consider regional key hierarchies for compliance.
  - id: HSM-HIGH-004
    signal: KMS audit logging disabled
    evidence_pattern: logging.*disabled|CloudTrail.*false
    explanation: |
      Without audit logging, there's no visibility into key usage.
      Compromises cannot be detected, and compliance requirements
      cannot be met.
    remediation: |
      Enable CloudTrail logging for all KMS operations.
      Integrate with SIEM for real-time monitoring.
      Set up alerts for suspicious key usage patterns.
  medium:
  - id: HSM-MED-001
    signal: AWS managed keys used instead of customer managed
    evidence_pattern: aws/.*alias|KeyManager.*AWS
    explanation: |
      AWS-managed keys provide basic encryption but offer less control
      over key rotation, policies, and auditing. Customer-managed keys
      provide full control and meet stricter compliance requirements.
    remediation: |
      Migrate from AWS-managed keys to customer-managed keys (CMKs)
      for sensitive data. AWS-managed keys are acceptable for
      non-sensitive logging and metrics.
  - id: HSM-MED-002
    signal: No key usage monitoring/alerting
    evidence_indicators:
    - No CloudWatch alarms for KMS
    - No alerts for key policy changes
    - No usage anomaly detection
    explanation: |
      Without monitoring, unusual key usage patterns that indicate
      compromise or misuse go undetected.
    remediation: |
      Set up CloudWatch alarms for KMS usage patterns.
      Alert on key policy changes, unusual volumes, and
      access from unexpected principals.
  - id: HSM-MED-003
    signal: Key material origin is external without secure import
    evidence_pattern: Origin.*EXTERNAL|import.*key.*material
    explanation: |
      Externally imported key material (BYOK) requires secure generation
      and import procedures. Improper handling during import can expose
      key material.
    remediation: |
      Use KMS import token and public key for secure import.
      Generate external keys in validated HSM.
      Verify key material is destroyed after import.
  low:
  - id: HSM-LOW-001
    signal: Key aliases not used consistently
    explanation: |
      Using key IDs instead of aliases makes key rotation harder and
      reduces code readability.
    remediation: |
      Use meaningful key aliases. Update code to reference aliases
      instead of key IDs where possible.
  positive:
  - id: HSM-POS-001
    signal: FIPS 140-2/3 Level 3 HSM in use
    evidence_pattern: CloudHSM|HSM.*Level.?3|FIPS.*140.*3
    explanation: |
      FIPS 140-2/3 Level 3 provides physical tamper resistance and
      identity-based authentication, the highest standard for key
      protection outside specialized environments.
  - id: HSM-POS-002
    signal: Envelope encryption properly implemented
    evidence_pattern: GenerateDataKey|DataKey|envelope.*encrypt
    explanation: |
      Envelope encryption pattern correctly separates key encryption
      keys from data encryption keys, following best practices.
  - id: HSM-POS-003
    signal: Key policies follow least privilege
    evidence_pattern: Condition|Principal.*arn:aws|kms:[A-Za-z]+(?!\*)
    explanation: |
      Key policies restrict access to specific principals and
      actions, limiting exposure from compromised credentials.
procedure:
  context:
    cognitive_mode: critical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Inventory cryptographic operations
    description: |
      Identify all code that performs encryption, decryption, signing,
      or key generation operations.
    duration_estimate: 30 min
    commands:
    - purpose: Find encryption operations
      command: |
        grep -rn --include="*.py" --include="*.js" --include="*.java" --include="*.go" \
          -E "(encrypt|decrypt|Cipher|AES|RSA|sign|verify)" . 2>/dev/null | head -100
    - purpose: Find KMS/HSM usage
      command: |
        grep -rn --include="*.py" --include="*.js" --include="*.java" --include="*.go" \
          -E "(kms|KMS|hsm|HSM|KeyVault|Vault)" . 2>/dev/null
    expected_findings:
    - Inventory of all cryptographic operations
    - Classification by KMS vs local crypto
  - id: '2'
    name: Verify KMS configuration
    description: |
      Check KMS key configuration including encryption context,
      key rotation, and access policies.
    duration_estimate: 45 min
    commands:
    - purpose: List AWS KMS keys
      command: |
        aws kms list-keys --output json 2>/dev/null | jq -r '.Keys[].KeyId' | head -20
    - purpose: Check key rotation status
      command: |
        aws kms list-keys --query 'Keys[*].KeyId' --output text 2>/dev/null | \
          xargs -I {} aws kms get-key-rotation-status --key-id {} 2>/dev/null
    - purpose: Scan Terraform for KMS config
      command: |
        grep -rn --include="*.tf" -E "(aws_kms_key|enable_key_rotation|key_rotation_enabled)" . 2>/dev/null
    expected_findings:
    - KMS key inventory with configuration details
    - Rotation status for each key
  - id: '3'
    name: Audit key policies
    description: |
      Review KMS key policies for least-privilege access and
      proper principal restrictions.
    duration_estimate: 45 min
    commands:
    - purpose: Get key policies
      command: |
        aws kms list-keys --query 'Keys[*].KeyId' --output text 2>/dev/null | \
          xargs -I {} aws kms get-key-policy --key-id {} --policy-name default 2>/dev/null
    - purpose: Check for overly permissive policies
      command: |
        grep -rn --include="*.json" --include="*.tf" \
          -E "kms:\\*|Principal.*\\*" . 2>/dev/null
    expected_findings:
    - Key policy assessment
    - Overly permissive policies identified
  - id: '4'
    name: Check for plaintext keys
    description: |
      Search for cryptographic keys stored outside of HSM/KMS.
    duration_estimate: 30 min
    commands:
    - purpose: Find hard-coded keys
      command: |
        grep -rn --include="*.py" --include="*.js" --include="*.java" --include="*.go" \
          -E "(encryption_key|secret_key|master_key)\\s*[=:]\\s*[\"']" . 2>/dev/null
    - purpose: Run secret scanner
      command: |
        trufflehog filesystem . --only-verified 2>/dev/null || echo "trufflehog not installed"
    expected_findings:
    - Plaintext keys that should be in KMS
    - Secret exposure assessment
  - id: '5'
    name: Verify FIPS compliance
    description: |
      Confirm cryptographic modules meet FIPS 140-2/3 requirements
      if handling regulated data.
    duration_estimate: 30 min
    questions:
    - What HSM/KMS service is in use?
    - What is the FIPS validation level?
    - Is FIPS mode enabled in cloud provider?
    - Are there any non-FIPS cryptographic operations?
    expected_findings:
    - FIPS compliance status
    - Gaps in FIPS coverage
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - KMS/HSM Inventory
    - Key Policy Assessment
    - FIPS Compliance Status
    - Plaintext Key Findings
    - Recommendations
  confidence_guidance:
    high: Direct evidence from KMS configuration and key policies
    medium: Code patterns suggest issues, needs infrastructure verification
    low: Potential issues based on architecture, needs documentation review
offline:
  capability: partial
  cache_manifest:
    knowledge:
    - source_id: nist-fips-140-3
      priority: required
    - source_id: owasp-key-management
      priority: required
    - source_id: aws-kms-best-practices
      priority: recommended
profiles:
  membership:
    quick:
      included: false
      reason: Requires infrastructure access and detailed analysis
    full:
      included: true
      priority: 2
    security:
      included: true
      priority: 1
closeout_checklist:
- id: hsm-001
  item: All encryption keys stored in HSM/KMS
  level: CRITICAL
  verification: |
    ! grep -rn --include="*.py" --include="*.js" --include="*.java" --include="*.go" \
      -E "(encryption_key|master_key|aes_key)\\s*[=:]\\s*[\"'][A-Za-z0-9+/=]{16,}[\"']" . 2>/dev/null && echo "PASS" || echo "FAIL"
  expected: PASS
- id: hsm-002
  item: KMS key rotation enabled
  level: BLOCKING
  verification: manual
  verification_notes: Verify via AWS/GCP/Azure console that automatic rotation is enabled
  expected: Confirmed by reviewer
- id: hsm-003
  item: Key policies follow least privilege
  level: BLOCKING
  verification: |
    ! grep -rn --include="*.json" --include="*.tf" "kms:\\*" . 2>/dev/null && echo "PASS" || echo "NEEDS_REVIEW"
  expected: PASS
- id: hsm-004
  item: FIPS 140-2/3 validated HSM in use
  level: BLOCKING
  verification: manual
  verification_notes: Verify HSM/KMS FIPS validation status on NIST CMVP website
  expected: Confirmed by reviewer
- id: hsm-005
  item: KMS audit logging enabled
  level: WARNING
  verification: manual
  verification_notes: Verify CloudTrail or equivalent logging captures all KMS operations
  expected: Confirmed by reviewer
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: FIPS 140-2/140-3
    controls:
    - Level 2
    - Level 3
  - framework: NIST SP 800-57
    controls:
    - Part 1
    - Part 2
  - framework: PCI DSS
    controls:
    - '3.5'
    - 3.5.1
    - '3.6'
  - framework: HIPAA
    controls:
    - 164.312(a)(2)(iv)
  - framework: FedRAMP
    controls:
    - SC-12
    - SC-13
  - framework: CWE
    controls:
    - CWE-311
    - CWE-320
    - CWE-327
    - CWE-732
relationships:
  commonly_combined:
  - security-trust.cryptography.key-rotation
  - security-trust.cryptography.crypto-library-vs-custom
  - security-trust.secrets-management.secrets-storage
