# ============================================================
# AUDIT: Dependency Security Practices
# Category: 32 - Dependency & Supply Chain
# Subcategory: dependency-health
# ============================================================

audit:
  id: "dependency-supply-chain.dependency-health.security-practices"
  name: "Dependency Security Practices Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "dependency-supply-chain"
  category_number: 32
  subcategory: "dependency-health"

  tier: "expert"
  estimated_duration: "2-4 hours"  # median: 3h

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "dependencies"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit evaluates the security practices of dependency projects,
    including their vulnerability disclosure processes, security policies,
    response to security reports, and overall security posture as measured
    by tools like OpenSSF Scorecard.

  why_it_matters: |
    A dependency's security practices directly affect your security.
    Projects with good practices respond quickly to vulnerabilities,
    follow secure development, and are less likely to introduce security
    issues in the first place.

  when_to_run:
    - "When selecting security-sensitive dependencies"
    - "During security assessments"
    - "For strategic dependency decisions"
    - "After security incidents in dependencies"

prerequisites:
  required_artifacts:
    - type: "dependency_manifest"
      description: "List of dependencies"

  access_requirements:
    - "Access to public repositories"
    - "Access to security advisories"

discovery:
  file_patterns:
    - glob: "**/SECURITY*"
      purpose: "Find security policies"
    - glob: "**/package.json"
      purpose: "Find dependencies"

knowledge_sources:
  guides:
    - id: "ossf-scorecard"
      name: "OpenSSF Scorecard"
      url: "https://securityscorecards.dev/"

    - id: "security-policy"
      name: "GitHub Security Policies"
      url: "https://docs.github.com/en/code-security/getting-started/adding-a-security-policy-to-your-repository"

  standards:
    - id: "openssf-best-practices"
      name: "OpenSSF Best Practices Badge"
      relevance: "Security practice standards"

tooling:
  analysis_tools:
    - tool: "scorecard"
      purpose: "OpenSSF Scorecard CLI"
    - tool: "gh"
      purpose: "Check security features"

signals:
  critical:
    - id: "DEP-SECPRAC-CRIT-001"
      signal: "Dependency has history of unpatched vulnerabilities"
      evidence_indicators:
        - "Multiple CVEs went months without patches"
        - "Security reports ignored"
      explanation: |
        Poor security response indicates vulnerabilities in this
        dependency may remain exploitable long after disclosure,
        putting your application at extended risk.
      remediation: "Consider alternative with better security practices"

  high:
    - id: "DEP-SECPRAC-HIGH-001"
      signal: "No security policy or disclosure process"
      evidence_indicators:
        - "No SECURITY.md"
        - "No security contact"
        - "No vulnerability disclosure process"
      remediation: "Flag as security risk; prefer packages with policies"

    - id: "DEP-SECPRAC-HIGH-002"
      signal: "Low OpenSSF Scorecard score"
      evidence_indicators:
        - "Scorecard below 5/10"
        - "Critical checks failing"
      remediation: "Evaluate alternatives with better scores"

  medium:
    - id: "DEP-SECPRAC-MED-001"
      signal: "No branch protection on main branch"
      evidence_indicators:
        - "Direct pushes to main allowed"
        - "No required reviews"
      remediation: "Note risk of unauthorized changes"

    - id: "DEP-SECPRAC-MED-002"
      signal: "No signed releases"
      evidence_indicators:
        - "Releases not signed"
        - "No provenance"
      remediation: "Note authenticity verification not possible"

  low:
    - id: "DEP-SECPRAC-LOW-001"
      signal: "Security practices documented but basic"
      evidence_indicators:
        - "SECURITY.md exists but minimal"
        - "Some best practices followed"
      remediation: "Acceptable; document limitations"

  positive:
    - id: "DEP-SECPRAC-POS-001"
      signal: "Excellent OpenSSF Scorecard score"

    - id: "DEP-SECPRAC-POS-002"
      signal: "Comprehensive security practices documented"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "security-auditor"

  steps:
    - id: "1"
      name: "Run OpenSSF Scorecard"
      description: "Get security scorecard for dependencies"
      commands:
        - purpose: "Run scorecard"
          command: "scorecard --repo=github.com/expressjs/express 2>/dev/null || echo 'scorecard not available; check securityscorecards.dev'"

    - id: "2"
      name: "Check for Security Policy"
      description: "Verify SECURITY.md exists"
      commands:
        - purpose: "Check via API"
          command: "gh api repos/expressjs/express/contents/SECURITY.md 2>/dev/null && echo 'SECURITY.md exists' || echo 'No SECURITY.md'"

    - id: "3"
      name: "Check Branch Protection"
      description: "Verify main branch is protected"
      commands:
        - purpose: "Check branch protection"
          command: "gh api repos/expressjs/express/branches/main/protection 2>/dev/null | jq '.required_status_checks' || echo 'Branch protection check not available'"

    - id: "4"
      name: "Check Vulnerability History"
      description: "Review past security advisories"
      commands:
        - purpose: "List security advisories"
          command: "gh api repos/expressjs/express/security-advisories 2>/dev/null | jq '.[0:5] | .[].summary' || echo 'Check GitHub Security tab manually'"

    - id: "5"
      name: "Check for Signed Commits/Releases"
      description: "Verify signing practices"
      commands:
        - purpose: "Check release signatures"
          command: "gh api repos/expressjs/express/releases/latest --jq '.tag_name' 2>/dev/null || echo 'Check releases for signatures'"

    - id: "6"
      name: "Check OpenSSF Best Practices Badge"
      description: "Look for best practices certification"
      commands:
        - purpose: "Note badge check"
          command: "echo 'Check for OpenSSF Best Practices badge:\nhttps://bestpractices.coreinfrastructure.org/projects?q=[project]\n\nBadge levels: Passing, Silver, Gold'"

output:
  deliverables:
    - type: "security_practice_assessment"
      format: "structured"
      description: "Security practices for each dependency"

    - type: "scorecard_results"
      format: "structured"
      description: "OpenSSF Scorecard results"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Scorecard Analysis"
        - "Security Policy Review"
        - "Vulnerability History"
        - "Recommendations"

closeout_checklist:
  - id: "dep-secprac-001"
    item: "Critical deps have security policies"
    level: "REQUIRED"
    verification: "SECURITY.md or equivalent exists"

  - id: "dep-secprac-002"
    item: "Scorecard run on key dependencies"
    level: "REQUIRED"
    verification: "Scores documented"

  - id: "dep-secprac-003"
    item: "Poor practice deps flagged"
    level: "CRITICAL"
    verification: "At-risk list complete"

  - id: "dep-secprac-004"
    item: "Alternatives identified for risky deps"
    level: "RECOMMENDED"
    verification: "Alternatives documented"

governance:
  applicable_to:
    archetypes: ["security-sensitive-projects"]

  compliance_mappings:
    - framework: "SOC 2"
      control: "CC9.2"
      description: "Third-party security assessment"
    - framework: "NIST CSF"
      control: "ID.SC-2"
      description: "Supplier security assessment"

relationships:
  commonly_combined:
    - "dependency-supply-chain.dependency-health.maintenance-status"
  depends_on:
    - "dependency-supply-chain.dependency-inventory.dependency-enumeration"
  feeds_into:
    - "security-trust.third-party-risk"
