# ============================================================
# AUDIT: Dependency Code Quality Assessment
# Category: 32 - Dependency & Supply Chain
# Subcategory: dependency-health
# ============================================================

audit:
  id: "dependency-supply-chain.dependency-health.code-quality-assessment"
  name: "Dependency Code Quality Assessment Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "dependency-supply-chain"
  category_number: 32
  subcategory: "dependency-health"

  tier: "expert"
  estimated_duration: "3-6 hours"  # median: 4h

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "dependencies"

  default_profiles:
    - "full"
    - "comprehensive"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit evaluates the code quality of key dependencies by examining
    test coverage, code complexity, documentation quality, and engineering
    practices. High-quality codebases are more likely to be secure,
    maintainable, and reliable.

  why_it_matters: |
    Poor code quality in dependencies becomes your problem. Bugs,
    security issues, and maintenance difficulties cascade into your
    application. Understanding dependency code quality helps predict
    future issues and informs selection decisions.

  when_to_run:
    - "When deeply integrating a dependency"
    - "When selecting between alternatives"
    - "For critical path dependencies"
    - "During security-sensitive decisions"

prerequisites:
  required_artifacts:
    - type: "dependency_source"
      description: "Access to dependency source code"

  access_requirements:
    - "Access to dependency repositories"
    - "Ability to analyze code"

discovery:
  file_patterns:
    - glob: "**/package.json"
      purpose: "Find dependencies"

knowledge_sources:
  guides:
    - id: "code-quality-metrics"
      name: "Software Quality Metrics"
      url: "https://www.sonarsource.com/resources/white-papers/code-quality-metrics/"

  standards:
    - id: "software-quality"
      name: "ISO 25010 Software Quality"
      relevance: "Quality characteristics"

tooling:
  analysis_tools:
    - tool: "sonarqube"
      purpose: "Code quality analysis"
    - tool: "codeclimate"
      purpose: "Maintainability assessment"
    - tool: "coveralls"
      purpose: "Test coverage tracking"

signals:
  critical:
    - id: "DEP-QUAL-CRIT-001"
      signal: "Critical dependency has no test coverage"
      evidence_indicators:
        - "0% or near-0% test coverage"
        - "No test files in repository"
      explanation: |
        Lack of tests means no safety net for changes. Bugs and
        regressions are more likely, and security issues may go
        undetected. This is particularly concerning for critical deps.
      remediation: "Consider alternatives with better test coverage"

  high:
    - id: "DEP-QUAL-HIGH-001"
      signal: "Very high code complexity"
      evidence_indicators:
        - "Cyclomatic complexity > 50"
        - "Many large functions"
      remediation: "Complexity increases bug likelihood; evaluate carefully"

    - id: "DEP-QUAL-HIGH-002"
      signal: "No CI/CD or quality gates"
      evidence_indicators:
        - "No automated testing"
        - "No build status badge"
      remediation: "Changes may introduce regressions easily"

  medium:
    - id: "DEP-QUAL-MED-001"
      signal: "Moderate test coverage"
      evidence_indicators:
        - "Test coverage 40-70%"
        - "Core functionality tested"
      remediation: "Acceptable but note limitations"

    - id: "DEP-QUAL-MED-002"
      signal: "Code quality tools show issues"
      evidence_indicators:
        - "CodeClimate maintainability < B"
        - "Multiple code smells"
      remediation: "Note technical debt; may affect reliability"

  low:
    - id: "DEP-QUAL-LOW-001"
      signal: "Documentation could be improved"
      evidence_indicators:
        - "Basic README only"
        - "API docs incomplete"
      remediation: "Minor concern; may affect usability"

  positive:
    - id: "DEP-QUAL-POS-001"
      signal: "High test coverage and clean code"

    - id: "DEP-QUAL-POS-002"
      signal: "Well-documented with quality badges"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "code-quality-auditor"

  steps:
    - id: "1"
      name: "Check Test Coverage"
      description: "Find test coverage information"
      commands:
        - purpose: "Check for coverage badge"
          command: "curl -s 'https://raw.githubusercontent.com/lodash/lodash/main/README.md' 2>/dev/null | grep -i 'coverage\\|coveralls\\|codecov' || echo 'Check README for coverage badges'"

    - id: "2"
      name: "Check CI Status"
      description: "Verify CI/CD is in place"
      commands:
        - purpose: "Check for CI config"
          command: "gh api repos/lodash/lodash/contents/.github/workflows 2>/dev/null | jq '.[].name' || echo 'Check repo for CI configuration'"

    - id: "3"
      name: "Review Code Structure"
      description: "Assess code organization"
      commands:
        - purpose: "Note code review process"
          command: "echo 'Code Structure Review:\n\n[ ] Clear directory organization\n[ ] Separation of concerns\n[ ] Consistent coding style\n[ ] Documentation in code\n[ ] Error handling patterns'"

    - id: "4"
      name: "Check Quality Badges"
      description: "Look for quality indicators"
      commands:
        - purpose: "Note quality badges"
          command: "echo 'Quality Badges to Check:\n\n[ ] Test coverage (Coveralls, Codecov)\n[ ] Code quality (CodeClimate, SonarCloud)\n[ ] Build status (Travis, GitHub Actions)\n[ ] Dependency status (Snyk, Dependabot)\n[ ] OpenSSF Best Practices'"

    - id: "5"
      name: "Review Issue History"
      description: "Check for quality-related issues"
      commands:
        - purpose: "Search for bug issues"
          command: "gh api 'repos/lodash/lodash/issues?labels=bug&state=all' --jq 'length' 2>/dev/null || echo 'Check GitHub issues for bug count'"

    - id: "6"
      name: "Assess Documentation Quality"
      description: "Evaluate documentation"
      commands:
        - purpose: "Check documentation"
          command: "echo 'Documentation Quality Checklist:\n\n[ ] Comprehensive README\n[ ] API documentation\n[ ] Usage examples\n[ ] Changelog maintained\n[ ] TypeScript types (if applicable)'"

output:
  deliverables:
    - type: "quality_assessment"
      format: "structured"
      description: "Code quality metrics for key dependencies"

    - type: "quality_concerns"
      format: "list"
      description: "Dependencies with quality concerns"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Test Coverage Analysis"
        - "Code Quality Metrics"
        - "Documentation Review"
        - "Recommendations"

closeout_checklist:
  - id: "dep-qual-001"
    item: "Critical deps have test coverage"
    level: "REQUIRED"
    verification: "Coverage documented"

  - id: "dep-qual-002"
    item: "Quality concerns documented"
    level: "REQUIRED"
    verification: "Concerns list complete"

  - id: "dep-qual-003"
    item: "CI/CD verified for key deps"
    level: "REQUIRED"
    verification: "CI status checked"

  - id: "dep-qual-004"
    item: "Documentation quality assessed"
    level: "RECOMMENDED"
    verification: "Docs reviewed"

governance:
  applicable_to:
    archetypes: ["all-software-projects"]

  compliance_mappings:
    - framework: "SOC 2"
      control: "CC9.2"
      description: "Third-party assessment"
    - framework: "ISO 27001"
      control: "A.14.2.1"
      description: "Secure development"

relationships:
  commonly_combined:
    - "dependency-supply-chain.dependency-health.maintenance-status"
  depends_on:
    - "dependency-supply-chain.dependency-inventory.dependency-enumeration"
  feeds_into:
    - "code-quality.technical-debt"
