audit:
  id: dependency-supply-chain.vulnerability-scanning.container-image-scanning
  name: Container Image Scanning Audit
  version: 1.0.0
  last_updated: '2025-01-22'
  status: active
  category: dependency-supply-chain
  category_number: 32
  subcategory: vulnerability-scanning
  tier: expert
  estimated_duration: 1-2 hours  # median: 1h
  completeness: complete
  requires_runtime: false
  destructive: false
execution:
  automatable: full
  severity: high
  scope: dependencies
  default_profiles:
  - full
  - quick
  blocks_phase: true
  parallelizable: true
description:
  what: |
    This audit scans container images for vulnerabilities in base images,
    installed OS packages, and application dependencies. It covers the
    entire software supply chain within containers, including vulnerabilities
    that may not be visible in application-level scanning.
  why_it_matters: |
    Containers often include vulnerable base images, system libraries, and
    packages not tracked in application manifests. A secure application
    running on a vulnerable base image inherits those vulnerabilities.
    Container scanning is essential for complete supply chain coverage.
  when_to_run:
  - Before pushing images to registry
  - During CI/CD pipeline
  - On regular schedule for deployed images
  - When base images are updated
prerequisites:
  required_artifacts:
  - type: dockerfile
    description: Dockerfile or container definition
  - type: container_image
    description: Built container image
  access_requirements:
  - Access to container images
  - Docker/Podman CLI access
discovery:
  file_patterns:
  - glob: '**/Dockerfile*'
    purpose: Find Dockerfiles
  - glob: '**/docker-compose*.yml'
    purpose: Find Docker Compose files
  - glob: '**/*.dockerfile'
    purpose: Find alternative Dockerfiles
  - glob: '**/Containerfile'
    purpose: Find Podman Containerfiles
knowledge_sources:
  guides:
  - id: docker-security
    name: Docker Security Best Practices
    url: https://docs.docker.com/develop/security-best-practices/
  - id: trivy-container
    name: Trivy Container Scanning
    url: https://aquasecurity.github.io/trivy/latest/docs/target/container_image/
  standards:
  - id: cis-docker
    name: CIS Docker Benchmark
    relevance: Container security standards
tooling:
  analysis_tools:
  - tool: trivy
    purpose: Comprehensive container image scanner
  - tool: grype
    purpose: Anchore container scanner
  - tool: snyk container
    purpose: Snyk container scanning
  - tool: clair
    purpose: CoreOS Clair scanner
  - tool: docker scout
    purpose: Docker native scanning
  - tool: cosign
    purpose: Container signing and verification
signals:
  critical:
  - id: DEP-CONT-CRIT-001
    signal: Critical vulnerability in base image
    evidence_indicators:
    - CVE with CVSS >= 9.0 in OS packages
    - Known exploited vulnerability in base image
    explanation: |
      Base image vulnerabilities affect all containers built on it.
      Critical vulnerabilities in system libraries like glibc or OpenSSL
      can compromise the entire container regardless of application security.
    remediation: Update base image immediately; rebuild and redeploy
  - id: DEP-CONT-CRIT-002
    signal: Running as root with known vulnerabilities
    evidence_indicators:
    - Container runs as root
    - Root-exploitable vulnerabilities present
    remediation: Switch to non-root user; patch vulnerabilities
  high:
  - id: DEP-CONT-HIGH-001
    signal: Outdated base image with multiple vulnerabilities
    evidence_indicators:
    - Base image months or years old
    - 10+ known vulnerabilities in base
    remediation: Update to latest base image version
  - id: DEP-CONT-HIGH-002
    signal: Unnecessary packages with vulnerabilities
    evidence_indicators:
    - Debug/build tools in production image
    - Vulnerable packages not required at runtime
    remediation: Use minimal base image; remove unnecessary packages
  medium:
  - id: DEP-CONT-MED-001
    signal: Minor base image updates available
    evidence_indicators:
    - Newer patch versions available
    - Security updates pending
    remediation: Schedule base image update
  - id: DEP-CONT-MED-002
    signal: Image not regularly rebuilt
    evidence_indicators:
    - Image age > 30 days
    - No rebuild pipeline
    remediation: Implement regular image rebuilds
  low:
  - id: DEP-CONT-LOW-001
    signal: Image uses latest tag
    evidence_indicators:
    - FROM uses :latest
    - No pinned base image version
    remediation: Pin base image to specific digest
  positive:
  - id: DEP-CONT-POS-001
    signal: All container images scanned and clean
  - id: DEP-CONT-POS-002
    signal: Using minimal base images
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Find Container Definitions
    description: Locate all Dockerfiles and container definitions
    commands:
    - purpose: Find Dockerfiles
      command: find . -name 'Dockerfile*' -o -name 'Containerfile' -o -name '*.dockerfile' 2>/dev/null
        | grep -v node_modules | head -20
  - id: '2'
    name: Identify Base Images
    description: Extract base images from Dockerfiles
    commands:
    - purpose: Extract FROM statements
      command: grep -h '^FROM' Dockerfile* 2>/dev/null || echo 'No Dockerfiles found'
  - id: '3'
    name: Scan with Trivy
    description: Run Trivy container image scan
    commands:
    - purpose: Scan local image with trivy
      command: trivy image --scanners vuln myimage:latest 2>/dev/null | head -200 || echo 'trivy not available
        or no image to scan'
    - purpose: Scan from Dockerfile
      command: trivy fs --scanners vuln Dockerfile 2>/dev/null | head -100 || echo 'Dockerfile scan not
        applicable'
  - id: '4'
    name: Scan with Grype
    description: Run Grype container image scan
    commands:
    - purpose: Scan with grype
      command: grype myimage:latest 2>/dev/null | head -200 || echo 'grype not available or no image to
        scan'
  - id: '5'
    name: Scan with Docker Scout
    description: Run Docker Scout analysis
    commands:
    - purpose: Run docker scout
      command: docker scout cves myimage:latest 2>/dev/null | head -200 || echo 'docker scout not available'
  - id: '6'
    name: Check Base Image Age
    description: Verify base image is current
    commands:
    - purpose: Check image creation date
      command: docker inspect --format='{{.Created}}' myimage:latest 2>/dev/null || echo 'Cannot inspect
        image'
  - id: '7'
    name: Verify Image Signing
    description: Check if images are signed
    commands:
    - purpose: Verify with cosign
      command: cosign verify myimage:latest 2>/dev/null || echo 'cosign verification not available or
        image not signed'
output:
  deliverables:
  - type: vulnerability_report
    format: structured
    description: Container image vulnerabilities
  - type: base_image_analysis
    format: structured
    description: Base image assessment
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Critical Findings
    - Base Image Analysis
    - Layer-by-Layer Results
    - Recommendations
closeout_checklist:
- id: dep-cont-001
  item: All container images scanned
  level: CRITICAL
  verification: Scan results for each image
- id: dep-cont-002
  item: No critical vulnerabilities in production images
  level: CRITICAL
  verification: trivy/grype shows no critical issues
- id: dep-cont-003
  item: Base images pinned to specific versions
  level: REQUIRED
  verification: No :latest tags in Dockerfiles
- id: dep-cont-004
  item: Scanning integrated in CI/CD
  level: REQUIRED
  verification: Pipeline includes image scanning
governance:
  applicable_to:
    archetypes:
    - containerized-applications
  compliance_mappings:
  - framework: SOC 2
    control: CC6.1
    description: Container vulnerability management
  - framework: PCI DSS
    control: '6.2'
    description: System component vulnerabilities
  - framework: CIS
    control: Docker Benchmark 4.1
    description: Image vulnerability scanning
relationships:
  commonly_combined:
  - dependency-supply-chain.vulnerability-scanning.cve-detection
  depends_on:
  - infrastructure-cloud.container-configuration
  feeds_into:
  - security-trust.vulnerability-management
