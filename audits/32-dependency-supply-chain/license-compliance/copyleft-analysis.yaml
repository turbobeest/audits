# ============================================================
# AUDIT: Copyleft Analysis
# Category: 32 - Dependency & Supply Chain
# Subcategory: license-compliance
# ============================================================

audit:
  id: "dependency-supply-chain.license-compliance.copyleft-analysis"
  name: "Copyleft Analysis Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "dependency-supply-chain"
  category_number: 32
  subcategory: "license-compliance"

  tier: "expert"
  estimated_duration: "2-4 hours"  # median: 3h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "dependencies"

  default_profiles:
    - "full"
    - "legal"

  blocks_phase: true
  parallelizable: true

description:
  what: |
    This audit performs deep analysis of copyleft license usage in
    the project. It examines GPL, AGPL, LGPL, and other copyleft
    licensed dependencies to understand obligations, assess risk,
    and determine compliance requirements.

  why_it_matters: |
    Copyleft licenses (GPL, AGPL, LGPL) have "viral" properties that
    can require entire works to be released under the same terms.
    Misunderstanding these licenses can result in unexpected source
    code disclosure requirements or legal liability.

  when_to_run:
    - "When copyleft dependencies are detected"
    - "Before product release"
    - "During M&A due diligence"
    - "When changing distribution model"

prerequisites:
  required_artifacts:
    - type: "license_inventory"
      description: "Complete license list"
    - type: "architecture_documentation"
      description: "Understanding of component boundaries"

  access_requirements:
    - "Access to license information"
    - "Understanding of code architecture"

discovery:
  file_patterns:
    - glob: "**/package.json"
      purpose: "Find npm dependencies"
    - glob: "**/COPYING*"
      purpose: "Find GPL license files"
    - glob: "**/LICENSE.GPL*"
      purpose: "Find GPL licenses"

knowledge_sources:
  guides:
    - id: "gpl-faq"
      name: "GNU GPL FAQ"
      url: "https://www.gnu.org/licenses/gpl-faq.html"

    - id: "lgpl-guide"
      name: "LGPL Compliance Guide"
      url: "https://www.gnu.org/licenses/lgpl-java.html"

  standards:
    - id: "fsf-licenses"
      name: "FSF License List"
      relevance: "GPL family details"

tooling:
  analysis_tools:
    - tool: "license-checker"
      purpose: "Identify GPL licenses"
    - tool: "fossa"
      purpose: "Deep license analysis"
    - tool: "scancode-toolkit"
      purpose: "License clause detection"

signals:
  critical:
    - id: "DEP-COPY-CRIT-001"
      signal: "GPL code linked into proprietary application"
      evidence_indicators:
        - "GPL dependency in closed-source project"
        - "Static linking with GPL library"
      explanation: |
        GPL requires derivative works to be GPL licensed. Including
        GPL code in proprietary software without source release is
        a license violation.
      remediation: "Remove GPL code, find alternative, or release source"

    - id: "DEP-COPY-CRIT-002"
      signal: "AGPL dependency in networked service without compliance"
      evidence_indicators:
        - "AGPL code in web service"
        - "Source not available to users"
      explanation: |
        AGPL extends GPL to network use. Users of AGPL web services
        must be able to access the source code.
      remediation: "Provide source access to users or remove AGPL code"

  high:
    - id: "DEP-COPY-HIGH-001"
      signal: "LGPL compliance unclear"
      evidence_indicators:
        - "LGPL library linked but method unclear"
        - "Static vs dynamic linking not verified"
      remediation: "Ensure dynamic linking or provide relinking capability"

    - id: "DEP-COPY-HIGH-002"
      signal: "GPL version compatibility issues"
      evidence_indicators:
        - "Mix of GPL-2.0-only and GPL-3.0"
        - "Incompatible GPL versions combined"
      remediation: "Resolve version conflicts; may require removing deps"

  medium:
    - id: "DEP-COPY-MED-001"
      signal: "Copyleft in development dependencies"
      evidence_indicators:
        - "GPL in devDependencies"
        - "Build tools with copyleft"
      remediation: "Verify dev deps not distributed; document analysis"

    - id: "DEP-COPY-MED-002"
      signal: "Weak copyleft licenses present"
      evidence_indicators:
        - "MPL, EPL, CDDL licensed code"
        - "File-level copyleft"
      remediation: "Understand specific obligations for each license"

  low:
    - id: "DEP-COPY-LOW-001"
      signal: "Copyleft analysis not documented"
      evidence_indicators:
        - "Analysis done but not recorded"
        - "Decisions not explained"
      remediation: "Document copyleft analysis for future reference"

  positive:
    - id: "DEP-COPY-POS-001"
      signal: "No problematic copyleft dependencies"

    - id: "DEP-COPY-POS-002"
      signal: "Copyleft obligations clearly understood and met"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "legal-auditor"

  steps:
    - id: "1"
      name: "Identify All Copyleft Licenses"
      description: "Find all GPL, AGPL, LGPL, and similar licenses"
      commands:
        - purpose: "Find GPL-family licenses"
          command: "npx license-checker 2>/dev/null | grep -iE '(GPL|LGPL|AGPL|MPL|EPL|CDDL)' || echo 'Copyleft search not available'"

    - id: "2"
      name: "Categorize Copyleft Types"
      description: "Separate strong, weak, and network copyleft"
      commands:
        - purpose: "Generate copyleft categories"
          command: "echo 'Copyleft Categories:\n\nStrong Copyleft (affects entire work):\n- GPL-2.0, GPL-3.0\n- AGPL-3.0 (network trigger)\n\nWeak Copyleft (affects only modified files/library):\n- LGPL-2.1, LGPL-3.0\n- MPL-2.0\n- EPL-2.0\n- CDDL-1.0'"

    - id: "3"
      name: "Analyze GPL Dependencies"
      description: "Examine GPL licensed packages in detail"
      commands:
        - purpose: "List GPL packages"
          command: "npx license-checker --onlyAllow 'GPL;GPL-2.0;GPL-3.0' 2>/dev/null || echo 'GPL filter not available; review manually'"

    - id: "4"
      name: "Check for AGPL"
      description: "Identify AGPL dependencies requiring special handling"
      commands:
        - purpose: "Find AGPL packages"
          command: "npx license-checker 2>/dev/null | grep -i 'AGPL' || echo 'No AGPL licenses found or tool unavailable'"

    - id: "5"
      name: "Analyze Linking Method"
      description: "Determine how copyleft code is integrated"
      commands:
        - purpose: "Document linking analysis questions"
          command: "echo 'Linking Analysis for LGPL:\n\n1. Is the LGPL library dynamically linked? [ ] Yes [ ] No\n2. Can users relink with modified library? [ ] Yes [ ] No\n3. Are you distributing the application? [ ] Yes [ ] No\n4. Is source code for modifications provided? [ ] Yes [ ] No\n\nNote: Static linking with LGPL may require releasing app source.'"

    - id: "6"
      name: "Document Compliance Approach"
      description: "Record how copyleft obligations will be met"
      commands:
        - purpose: "Generate compliance template"
          command: "echo 'Copyleft Compliance Documentation:\n\nPackage: [name]\nLicense: [GPL/LGPL/AGPL version]\nIntegration Method: [dynamic link/static link/bundled]\n\nObligations:\n- [ ] Provide source code\n- [ ] Include license text\n- [ ] Preserve notices\n- [ ] Provide modification capability (LGPL)\n- [ ] Offer written source offer\n\nCompliance Method:\n[Describe how obligations are met]'"

output:
  deliverables:
    - type: "copyleft_inventory"
      format: "structured"
      description: "All copyleft dependencies categorized"

    - type: "compliance_assessment"
      format: "structured"
      description: "Assessment of compliance status"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Copyleft Inventory"
        - "Risk Analysis"
        - "Compliance Requirements"
        - "Recommendations"

closeout_checklist:
  - id: "dep-copy-001"
    item: "All copyleft dependencies identified"
    level: "CRITICAL"
    verification: "Copyleft inventory complete"

  - id: "dep-copy-002"
    item: "GPL/AGPL compliance assessed"
    level: "CRITICAL"
    verification: "Strong copyleft analysis complete"

  - id: "dep-copy-003"
    item: "Linking methods documented"
    level: "REQUIRED"
    verification: "Integration analysis complete"

  - id: "dep-copy-004"
    item: "Compliance approach documented"
    level: "REQUIRED"
    verification: "Compliance documentation exists"

governance:
  applicable_to:
    archetypes: ["all-software-projects"]

  compliance_mappings:
    - framework: "SOC 2"
      control: "CC6.1"
      description: "License compliance"
    - framework: "ISO 27001"
      control: "A.18.1.2"
      description: "Intellectual property compliance"

relationships:
  commonly_combined:
    - "dependency-supply-chain.license-compliance.license-compatibility"
  depends_on:
    - "dependency-supply-chain.license-compliance.license-detection"
  feeds_into:
    - "compliance-legal.open-source-compliance"
