# ============================================================
# AUDIT: Security Test Automation
# ============================================================
# Evaluates automation of security testing in the development
# lifecycle.
# ============================================================

audit:
  id: "testing-quality-assurance.security-testing.security-test-automation"
  name: "Security Test Automation"
  version: "1.0.0"
  last_updated: "2026-01-22"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 26
  subcategory: "security-testing"

  tier: "expert"
  estimated_duration: "1-2 hours"  # median: 1h

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "yes"
  severity: "high"
  scope: "security"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the automation of security testing including integration
    of security tools in CI/CD pipelines, automated security regression
    testing, and continuous security validation. Assesses the maturity
    of DevSecOps practices.

  why_it_matters: |
    Manual security testing doesn't scale. Automated security testing
    catches issues early, runs consistently, and provides continuous
    feedback. DevSecOps principles require security to be automated
    throughout the development lifecycle.

  when_to_run:
    - "CI/CD pipeline assessment"
    - "DevSecOps maturity review"
    - "Security program evaluation"
    - "Process improvement"

prerequisites:
  required_artifacts:
    - type: "ci_config"
      description: "CI/CD pipeline configuration"
    - type: "security_tools"
      description: "Security tool configurations"

  access_requirements:
    - "CI/CD configuration access"
    - "Pipeline execution logs"

discovery:
  file_patterns:
    - glob: "**/.github/workflows/*"
      purpose: "GitHub Actions workflows"
    - glob: "**/.gitlab-ci.yml"
      purpose: "GitLab CI configuration"
    - glob: "**/Jenkinsfile"
      purpose: "Jenkins pipeline"

  code_patterns:
    - pattern: "security|sast|dast|scan|audit"
      type: "regex"
      scope: "config"
      purpose: "Security automation"

knowledge_sources:
  guides:
    - id: "devsecops"
      name: "DevSecOps Implementation Guide"
      url: "https://owasp.org/www-project-devsecops-guideline/"
      offline_cache: true
    - id: "security-pipeline"
      name: "Building Secure Pipelines"
      url: "https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions"
      offline_cache: true

  learning_resources:
    - id: "devsecops-book"
      title: "DevSecOps Engineering"
      type: "book"
      reference: "ISBN 978-1788995504"

tooling:
  static_analysis:
    - tool: "GitHub Actions"
      purpose: "CI/CD automation"
      offline_capable: false
    - tool: "GitLab CI"
      purpose: "CI/CD automation"
      offline_capable: false

  scripts:
    - id: "security-automation-check"
      language: "bash"
      purpose: "Check security automation"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Security Test Automation Analysis ==="

        echo "Security-related CI jobs:"
        grep -r -l 'security\|sast\|dast\|audit\|scan' .github/workflows/ .gitlab-ci.yml 2>/dev/null | wc -l

        echo ""
        echo "Security tools in CI:"
        grep -r -E '(semgrep|sonar|snyk|trivy|gitleaks|zap)' .github/workflows/ 2>/dev/null | head -15

        echo ""
        echo "Security gates (blocking):"
        grep -r -A5 'if:.*fail\|continue-on-error.*false' .github/workflows/ 2>/dev/null | grep -i security | head -10

        echo ""
        echo "Scheduled security scans:"
        grep -r 'schedule\|cron' .github/workflows/ 2>/dev/null | head -5

signals:
  critical:
    - id: "SECAUTO-CRIT-001"
      signal: "No automated security testing in CI"
      evidence_pattern: "Pipeline lacks any security scanning"
      explanation: |
        Without automated security testing, security relies on manual
        review which is inconsistent and doesn't scale. Every deployment
        should include automated security validation.
      remediation: |
        Integrate security automation:
        1. Add SAST to PR checks
        2. Add dependency scanning to builds
        3. Add secret scanning pre-commit
        4. Add DAST to deployment pipelines
        5. Configure blocking for critical findings

    - id: "SECAUTO-CRIT-002"
      signal: "Security scans don't block deployment"
      evidence_pattern: "Security failures don't stop pipeline"
      explanation: |
        Security scans that don't block are advisory only. Vulnerabilities
        can ship to production if developers are under pressure. Security
        gates must enforce standards.
      remediation: |
        Configure security gates:
        - Fail on critical vulnerabilities
        - Require security approval for overrides
        - Track and audit all overrides
        - Report on bypassed findings

  high:
    - id: "SECAUTO-HIGH-001"
      signal: "Security tests only on main branch"
      evidence_pattern: "No security scanning on pull requests"
      explanation: |
        Security issues should be caught before merge. PR-based scanning
        gives developers immediate feedback and prevents vulnerabilities
        from ever reaching the main branch.
      remediation: |
        Add security to PR workflow:
        - Run SAST on every PR
        - Run dependency scan on dependency changes
        - Report findings as PR comments
        - Block merge on critical issues

    - id: "SECAUTO-HIGH-002"
      signal: "No scheduled security scans"
      evidence_pattern: "Security only runs on commits"
      explanation: |
        New vulnerabilities are discovered in existing dependencies.
        Scheduled scans catch CVEs published after code was deployed.
        Regular re-scanning is essential.
      remediation: |
        Add scheduled scanning:
        - Daily dependency vulnerability scan
        - Weekly full SAST scan
        - Monthly DAST scan of deployed applications
        - Alert on new findings

  medium:
    - id: "SECAUTO-MED-001"
      signal: "Security automation not documented"
      evidence_pattern: "Unclear what security tests run when"
      remediation: "Document security gates and their triggers"

    - id: "SECAUTO-MED-002"
      signal: "Results not aggregated"
      evidence_pattern: "Security results scattered across tools"
      remediation: "Centralize security findings in security dashboard"

  low:
    - id: "SECAUTO-LOW-001"
      signal: "Security metrics not tracked"
      evidence_pattern: "No trending of security findings"

  positive:
    - id: "SECAUTO-POS-001"
      signal: "Comprehensive security automation"
      evidence_pattern: "SAST, DAST, SCA integrated and blocking"

    - id: "SECAUTO-POS-002"
      signal: "Security as code"
      evidence_pattern: "Security policies defined in pipeline config"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Analyze CI configuration"
      description: |
        Review CI/CD configuration for security integration.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find security steps"
          command: "grep -r -l 'security\\|sast\\|dast\\|audit' .github/workflows/ 2>/dev/null"
        - purpose: "List security tools"
          command: "grep -r -E '(semgrep|sonar|snyk|trivy|gitleaks|zap)' .github/workflows/ 2>/dev/null | head -15"
      expected_findings:
        - "Security tools in pipeline"
        - "Integration points"

    - id: "2"
      name: "Verify blocking configuration"
      description: |
        Check if security failures block deployment.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find blocking config"
          command: "cat .github/workflows/*.yml 2>/dev/null | grep -A10 -i security | grep -E 'fail|exit|block'"
      expected_findings:
        - "Blocking configuration"
        - "Gate enforcement"

    - id: "3"
      name: "Check PR integration"
      description: |
        Verify security runs on pull requests.
      duration_estimate: "15 min"
      commands:
        - purpose: "Check PR triggers"
          command: "cat .github/workflows/*.yml 2>/dev/null | grep -A5 'on:' | grep 'pull_request'"
      expected_findings:
        - "PR security coverage"
        - "Shift-left status"

    - id: "4"
      name: "Review scheduling"
      description: |
        Check for scheduled security scans.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find scheduled scans"
          command: "grep -r -A2 'schedule' .github/workflows/ 2>/dev/null"
      expected_findings:
        - "Scheduled scans"
        - "Scan frequency"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "automation_report"
      format: "table"
      sections:
        - "Security Tools"
        - "Pipeline Integration"
        - "Gate Configuration"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Automation Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Full pipeline review with execution verification"
    medium: "Configuration analysis"
    low: "Pattern matching only"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "devsecops"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed analysis"
    security:
      included: true
      priority: 3
    full:
      included: true
      priority: 6

closeout_checklist:
  - id: "secauto-001"
    item: "Security tools in CI identified"
    level: "CRITICAL"
    verification: "grep -r -c 'semgrep\\|sonar\\|snyk' .github/workflows/ 2>/dev/null"
    expected: "Count > 0"

  - id: "secauto-002"
    item: "Blocking configuration verified"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Confirm security failures block deployment"
    expected: "Confirmed by reviewer"

  - id: "secauto-003"
    item: "PR security coverage confirmed"
    level: "WARNING"
    verification: "grep -r 'pull_request' .github/workflows/ 2>/dev/null | wc -l"
    expected: "Count > 0"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC2"
      controls: ["CC7.1", "CC7.2"]
    - framework: "ISO 27001"
      controls: ["A.14.2.1"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.security-testing.sast-integration"
    - "testing-quality-assurance.security-testing.dast-integration"
    - "cicd-pipeline.pipeline-security.secure-pipeline"
