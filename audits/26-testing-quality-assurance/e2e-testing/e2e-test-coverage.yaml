# ============================================================
# AUDIT: E2E Test Coverage
# ============================================================
# Evaluates end-to-end test coverage for complete user flows.
# ============================================================

audit:
  id: "testing-quality-assurance.e2e-testing.e2e-test-coverage"
  name: "E2E Test Coverage"
  version: "1.0.0"
  last_updated: "2026-01-22"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 26
  subcategory: "e2e-testing"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "testing"

  default_profiles:
    - "full"
    - "production"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates end-to-end test coverage which verifies complete user
    flows through the system from UI to backend to database. Assesses
    coverage of critical paths, feature completeness, and the balance
    between E2E tests and lower-level tests.

  why_it_matters: |
    E2E tests provide the highest confidence that the system works for
    users. They catch integration issues that unit and integration tests
    miss. However, E2E tests are expensive to write and maintain, so
    coverage must be strategic - focusing on critical user journeys
    rather than attempting to test everything at this level.

  when_to_run:
    - "Pre-release validation"
    - "Major feature releases"
    - "Test strategy assessment"
    - "After significant UI changes"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "E2E test suite"
    - type: "application"
      description: "Running application instance"

  access_requirements:
    - "Source code repository access"
    - "Test environment access"
    - "E2E test execution capability"

discovery:
  file_patterns:
    - glob: "**/e2e/**/*.{test,spec}.*"
      purpose: "E2E test files"
    - glob: "**/cypress/**"
      purpose: "Cypress test directory"
    - glob: "**/playwright/**"
      purpose: "Playwright test directory"

  code_patterns:
    - pattern: "cy\\.|page\\.|browser\\."
      type: "regex"
      scope: "test"
      purpose: "E2E framework APIs"
    - pattern: "describe.*E2E|e2e"
      type: "regex"
      scope: "test"
      purpose: "E2E test labels"

knowledge_sources:
  guides:
    - id: "e2e-strategy"
      name: "E2E Testing Strategy"
      url: "https://martinfowler.com/articles/practical-test-pyramid.html#TheImportanceOfTesting"
      offline_cache: true
    - id: "cypress-best-practices"
      name: "Cypress Best Practices"
      url: "https://docs.cypress.io/guides/references/best-practices"
      offline_cache: true

  learning_resources:
    - id: "e2e-testing"
      title: "End-to-End Testing with Playwright"
      type: "documentation"
      reference: "https://playwright.dev/docs/intro"

tooling:
  static_analysis:
    - tool: "Cypress"
      purpose: "JavaScript E2E testing"
      offline_capable: false
    - tool: "Playwright"
      purpose: "Cross-browser E2E testing"
      offline_capable: false
    - tool: "Selenium"
      purpose: "Browser automation"
      offline_capable: false
    - tool: "Puppeteer"
      purpose: "Chrome automation"
      offline_capable: false

  scripts:
    - id: "e2e-coverage"
      language: "bash"
      purpose: "Analyze E2E test coverage"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== E2E Test Coverage Analysis ==="

        echo "E2E test files:"
        find . -path '*e2e*' -name '*.{test,spec}.*' 2>/dev/null | wc -l

        echo ""
        echo "Cypress tests:"
        find . -path '*cypress*' -name '*.{cy,spec}.*' 2>/dev/null | wc -l

        echo ""
        echo "Playwright tests:"
        find . -name '*.spec.ts' -path '*tests*' 2>/dev/null | wc -l

        echo ""
        echo "Test scenarios (it/test blocks):"
        grep -r -c "it(\\|test(" --include='*.cy.*' --include='*.spec.*' . 2>/dev/null | awk -F: '{sum+=$2} END {print sum}'

signals:
  critical:
    - id: "E2ECOV-CRIT-001"
      signal: "No E2E tests exist"
      evidence_pattern: "Zero E2E test files found"
      explanation: |
        Without E2E tests, there's no automated verification that the
        system works end-to-end. Critical bugs can reach production
        because unit and integration tests don't catch all issues.
      remediation: |
        Start E2E testing with critical flows:
        1. Choose framework (Playwright or Cypress recommended)
        2. Identify top 5-10 critical user journeys
        3. Write E2E tests for each critical journey
        4. Integrate into CI pipeline
        5. Expand coverage gradually

    - id: "E2ECOV-CRIT-002"
      signal: "Critical user flows not covered by E2E"
      evidence_pattern: "Login, checkout, or core workflows missing E2E tests"
      explanation: |
        Critical user flows that affect revenue, security, or core
        functionality must have E2E coverage. These are the flows
        where bugs have the highest impact.
      remediation: |
        Prioritize E2E coverage for:
        - User registration and login
        - Core feature workflows
        - Checkout and payment flows
        - Account management
        - Data export/import

  high:
    - id: "E2ECOV-HIGH-001"
      signal: "E2E tests only cover happy paths"
      evidence_pattern: "No error flow or edge case E2E tests"
      explanation: |
        Happy path-only E2E tests miss error handling bugs that affect
        user experience. Users encounter errors regularly - these
        scenarios need testing too.
      remediation: |
        Add error scenario E2E tests:
        - Invalid input handling
        - Network failure recovery
        - Session expiry handling
        - Concurrent modification scenarios

    - id: "E2ECOV-HIGH-002"
      signal: "E2E/unit test ratio inverted"
      evidence_threshold: "More E2E tests than unit tests"
      explanation: |
        Over-reliance on E2E tests creates a slow, flaky test suite.
        The test pyramid recommends many unit tests, fewer integration
        tests, and even fewer E2E tests.
      remediation: |
        Rebalance test pyramid:
        - Push tests down to appropriate level
        - Use E2E only for journey validation
        - Increase unit test coverage
        - Reserve E2E for flows that cross many boundaries

  medium:
    - id: "E2ECOV-MED-001"
      signal: "New features lack E2E tests"
      evidence_pattern: "Recent features without corresponding E2E coverage"
      remediation: "Require E2E tests for new critical features"

    - id: "E2ECOV-MED-002"
      signal: "E2E tests don't align with acceptance criteria"
      evidence_pattern: "Feature specs don't map to test scenarios"
      remediation: "Derive E2E tests from acceptance criteria/user stories"

  low:
    - id: "E2ECOV-LOW-001"
      signal: "E2E test documentation missing"
      evidence_pattern: "No explanation of what flows are covered"

  positive:
    - id: "E2ECOV-POS-001"
      signal: "All critical journeys have E2E coverage"
      evidence_pattern: "Complete critical path coverage"

    - id: "E2ECOV-POS-002"
      signal: "Appropriate test pyramid balance"
      evidence_pattern: "E2E tests are focused and strategic"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory E2E tests"
      description: |
        Count and categorize existing E2E tests.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find E2E test files"
          command: "find . -path '*e2e*' -name '*.{test,spec}.*' -o -path '*cypress*' -name '*.cy.*' 2>/dev/null | wc -l"
        - purpose: "Count test scenarios"
          command: "grep -r -c \"it(\\|test(\" --include='*.cy.*' --include='*.spec.*' . 2>/dev/null | awk -F: '{sum+=$2} END {print sum}'"
      expected_findings:
        - "E2E test count"
        - "Test distribution"

    - id: "2"
      name: "Map critical user journeys"
      description: |
        Identify critical user flows that require E2E coverage.
      duration_estimate: "30 min"
      questions:
        - "What are the core user journeys?"
        - "Which flows affect revenue or security?"
        - "What are the most common user paths?"
      expected_findings:
        - "Critical journey inventory"
        - "Coverage requirements"

    - id: "3"
      name: "Assess coverage alignment"
      description: |
        Compare E2E tests against critical journey requirements.
      duration_estimate: "30 min"
      commands:
        - purpose: "List E2E test descriptions"
          command: "grep -r -h \"describe(\\|it(\" --include='*.cy.*' --include='*.spec.*' . 2>/dev/null | head -40"
      expected_findings:
        - "Coverage gaps"
        - "Over-tested areas"

    - id: "4"
      name: "Evaluate test pyramid balance"
      description: |
        Check the ratio of E2E to unit/integration tests.
      duration_estimate: "15 min"
      commands:
        - purpose: "Count unit tests"
          command: "find . -name '*.test.*' -not -path '*e2e*' 2>/dev/null | wc -l"
        - purpose: "Compare to E2E tests"
          command: "find . -path '*e2e*' -name '*.{test,spec}.*' 2>/dev/null | wc -l"
      expected_findings:
        - "Test type distribution"
        - "Pyramid assessment"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "coverage_matrix"
      format: "table"
      sections:
        - "Critical Journeys"
        - "E2E Coverage"
        - "Test Pyramid Balance"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Coverage Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Full journey mapping with test alignment"
    medium: "Test inventory without journey mapping"
    low: "Pattern matching only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "e2e-strategy"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed analysis"
    production:
      included: true
      priority: 2
    full:
      included: true
      priority: 4

closeout_checklist:
  - id: "e2ecov-001"
    item: "E2E tests inventoried"
    level: "CRITICAL"
    verification: "find . -path '*e2e*' -name '*.spec.*' 2>/dev/null | wc -l"
    expected: "Count documented"

  - id: "e2ecov-002"
    item: "Critical journeys identified"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Document critical user flows"
    expected: "Confirmed by reviewer"

  - id: "e2ecov-003"
    item: "Coverage gaps documented"
    level: "WARNING"
    verification: "manual"
    verification_notes: "List uncovered critical journeys"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Functional Suitability"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.e2e-testing.critical-user-journey-coverage"
    - "testing-quality-assurance.e2e-testing.e2e-test-stability"
    - "testing-quality-assurance.test-effectiveness.test-roi"
