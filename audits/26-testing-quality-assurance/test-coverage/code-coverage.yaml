# ============================================================
# AUDIT: Code Coverage
# ============================================================
# Evaluates line-level code coverage metrics and enforcement
# across the codebase.
# ============================================================

audit:
  id: "testing-quality-assurance.test-coverage.code-coverage"
  name: "Code Coverage"
  version: "1.0.0"
  last_updated: "2026-01-22"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 26
  subcategory: "test-coverage"

  tier: "expert"
  estimated_duration: "1-2 hours"  # median: 1h

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "yes"
  severity: "high"
  scope: "testing"

  default_profiles:
    - "full"
    - "quality"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the percentage of source code lines executed during test
    runs. Measures statement coverage, analyzes coverage distribution
    across modules, identifies uncovered code sections, and validates
    coverage enforcement mechanisms in CI/CD pipelines.

  why_it_matters: |
    Code coverage provides a baseline metric for test suite effectiveness.
    Low coverage indicates untested code paths that may harbor bugs.
    Without coverage visibility, teams cannot identify testing gaps or
    prioritize test development efforts. Coverage thresholds in CI
    prevent regression and maintain quality standards.

  when_to_run:
    - "CI/CD pipeline quality gates"
    - "Pre-release validation"
    - "Sprint quality retrospectives"
    - "After major refactoring efforts"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Source code with test suite"
    - type: "coverage_tooling"
      description: "Coverage instrumentation configured"

  access_requirements:
    - "Source code repository access"
    - "Ability to execute test suite"
    - "Coverage report access"

discovery:
  file_patterns:
    - glob: "**/coverage/**"
      purpose: "Coverage report directories"
    - glob: "**/*.lcov"
      purpose: "LCOV coverage files"
    - glob: "**/coverage*.xml"
      purpose: "Cobertura/JaCoCo XML reports"
    - glob: "**/coverage*.json"
      purpose: "JSON coverage summaries"

  code_patterns:
    - pattern: "coverageThreshold|coverage.*threshold"
      type: "regex"
      scope: "config"
      purpose: "Coverage threshold configuration"
    - pattern: "nyc|istanbul|coverage\\.py|jacoco"
      type: "regex"
      scope: "config"
      purpose: "Coverage tool configuration"

  metrics_queries:
    - system: "SonarQube"
      query: "component_measures?metricKeys=coverage,line_coverage"
      purpose: "Line coverage metrics"
      threshold: ">= 80%"

knowledge_sources:
  specifications:
    - id: "istqb-coverage"
      name: "ISTQB Test Coverage Standards"
      url: "https://www.istqb.org/"
      offline_cache: true
      priority: "recommended"

  guides:
    - id: "google-coverage"
      name: "Google Code Coverage Best Practices"
      url: "https://testing.googleblog.com/2020/08/code-coverage-best-practices.html"
      offline_cache: true
    - id: "martin-fowler-coverage"
      name: "Martin Fowler on Test Coverage"
      url: "https://martinfowler.com/bliki/TestCoverage.html"
      offline_cache: true

  learning_resources:
    - id: "coverage-book"
      title: "xUnit Test Patterns"
      type: "book"
      reference: "ISBN 978-0131495050"

tooling:
  static_analysis:
    - tool: "istanbul/nyc"
      purpose: "JavaScript/TypeScript coverage"
      offline_capable: true
    - tool: "coverage.py"
      purpose: "Python coverage analysis"
      offline_capable: true
    - tool: "JaCoCo"
      purpose: "Java coverage analysis"
      offline_capable: true
    - tool: "SimpleCov"
      purpose: "Ruby coverage analysis"
      offline_capable: true
    - tool: "gcov/lcov"
      purpose: "C/C++ coverage analysis"
      offline_capable: true

  scripts:
    - id: "coverage-check"
      language: "bash"
      purpose: "Check code coverage metrics"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Code Coverage Analysis ==="

        # Check for common coverage report formats
        if [ -f "coverage/coverage-summary.json" ]; then
          echo "JSON coverage report found:"
          cat coverage/coverage-summary.json | jq '.total'
        elif [ -f "coverage/lcov.info" ]; then
          echo "LCOV report found:"
          lcov --summary coverage/lcov.info 2>/dev/null || head -50 coverage/lcov.info
        elif [ -f "coverage.xml" ]; then
          echo "Cobertura report found"
          grep -o 'line-rate="[^"]*"' coverage.xml | head -1
        else
          echo "No coverage reports found"
        fi

signals:
  critical:
    - id: "CODECOV-CRIT-001"
      signal: "Code coverage below 50%"
      evidence_threshold: "Line coverage < 50%"
      explanation: |
        Less than half the codebase is tested, indicating significant
        quality risk. Bug fixes and refactoring carry high risk of
        introducing regressions in untested code paths.
      remediation: |
        Establish a coverage improvement plan:
        1. Identify critical business logic modules
        2. Prioritize coverage for high-risk code paths
        3. Set incremental coverage targets (e.g., +5% per sprint)
        4. Block merges that decrease coverage

    - id: "CODECOV-CRIT-002"
      signal: "No coverage tooling configured"
      evidence_pattern: "Missing coverage configuration files"
      explanation: |
        Without coverage tooling, teams have no visibility into test
        effectiveness. This blindness prevents data-driven quality
        improvement decisions.
      remediation: |
        Configure coverage tooling appropriate for your stack:
        - JavaScript: nyc/istanbul with Jest or Mocha
        - Python: coverage.py with pytest-cov
        - Java: JaCoCo with Maven/Gradle
        - Go: go test -cover

  high:
    - id: "CODECOV-HIGH-001"
      signal: "Coverage thresholds not enforced in CI"
      evidence_pattern: "No coverage gates in pipeline configuration"
      explanation: |
        Without CI enforcement, coverage can silently regress as new
        untested code is added. Coverage becomes a vanity metric rather
        than a quality gate.
      remediation: |
        Add coverage thresholds to CI pipeline:
        - Jest: coverageThreshold in package.json
        - pytest: --cov-fail-under flag
        - JaCoCo: minimum coverage rules in pom.xml

    - id: "CODECOV-HIGH-002"
      signal: "Critical modules have significantly lower coverage"
      evidence_threshold: "Core business logic coverage < team average - 20%"
      explanation: |
        Critical code paths require higher coverage assurance. Low
        coverage in important modules creates outsized risk despite
        acceptable overall numbers.
      remediation: |
        Implement per-module coverage requirements. Critical modules
        should have higher thresholds than utility code.

  medium:
    - id: "CODECOV-MED-001"
      signal: "Coverage trending downward"
      evidence_threshold: "Coverage decreased over 5+ recent commits"
      remediation: "Enable coverage-diff reporting on PRs to catch regressions"

    - id: "CODECOV-MED-002"
      signal: "Coverage reports not integrated with code review"
      evidence_pattern: "No coverage annotations on pull requests"
      remediation: "Configure Codecov, Coveralls, or similar PR integration"

  low:
    - id: "CODECOV-LOW-001"
      signal: "Coverage excludes patterns overly broad"
      evidence_pattern: "Large exclusion patterns in coverage config"

  positive:
    - id: "CODECOV-POS-001"
      signal: "Coverage above 80% with enforced thresholds"
      evidence_threshold: "Line coverage >= 80% and CI gates active"

    - id: "CODECOV-POS-002"
      signal: "Coverage trending upward consistently"
      evidence_threshold: "Coverage improved over past month"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify coverage tooling"
      description: |
        Determine what coverage tools are configured and available
        for the project.
      duration_estimate: "10 min"
      commands:
        - purpose: "Check for coverage config in package.json"
          command: "cat package.json 2>/dev/null | jq '.jest.coverageThreshold // .nyc // \"not found\"'"
        - purpose: "Check for coverage.py config"
          command: "cat .coveragerc pyproject.toml 2>/dev/null | grep -A 10 'coverage' || echo 'not found'"
      expected_findings:
        - "Coverage tool identification"
        - "Threshold configuration presence"

    - id: "2"
      name: "Collect coverage metrics"
      description: |
        Run or retrieve coverage reports to analyze current state.
      duration_estimate: "20 min"
      commands:
        - purpose: "Run tests with coverage"
          command: "npm test -- --coverage 2>/dev/null || pytest --cov 2>/dev/null || echo 'Run manually'"
        - purpose: "Find existing reports"
          command: "find . -name 'coverage*' -type f 2>/dev/null | head -20"
      expected_findings:
        - "Current coverage percentages"
        - "Coverage report locations"

    - id: "3"
      name: "Analyze coverage distribution"
      description: |
        Examine coverage across modules to identify gaps and imbalances.
      duration_estimate: "20 min"
      commands:
        - purpose: "Parse module-level coverage"
          command: "cat coverage/coverage-summary.json 2>/dev/null | jq 'to_entries | map(select(.value.lines.pct < 50)) | .[].key' || echo 'Check HTML report'"
      expected_findings:
        - "Low-coverage modules list"
        - "Coverage distribution patterns"

    - id: "4"
      name: "Verify CI enforcement"
      description: |
        Check that coverage thresholds are enforced in the CI/CD pipeline.
      duration_estimate: "15 min"
      commands:
        - purpose: "Check CI config for coverage gates"
          command: "grep -r 'coverage' .github/workflows/ .gitlab-ci.yml Jenkinsfile 2>/dev/null | head -20"
      expected_findings:
        - "CI coverage gate presence"
        - "Threshold values in CI"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "coverage_report"
      format: "table"
      sections:
        - "Overall Coverage Metrics"
        - "Module Coverage Breakdown"
        - "Coverage Gaps"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Coverage Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Coverage measured from actual test execution"
    medium: "Coverage from existing reports without fresh run"
    low: "Estimated from configuration inspection only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "google-coverage"
        priority: "required"

profiles:
  membership:
    quick:
      included: true
      reason: "Quick coverage check provides immediate value"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "codecov-001"
    item: "Coverage metrics collected"
    level: "CRITICAL"
    verification: "test -d coverage && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "codecov-002"
    item: "Current coverage level documented"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Record overall line coverage percentage"
    expected: "Confirmed by reviewer"

  - id: "codecov-003"
    item: "CI enforcement verified"
    level: "WARNING"
    verification: "grep -r 'coverage' .github/workflows/ 2>/dev/null && echo PASS || echo FAIL"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Testability"]
    - framework: "IEC 62443"
      controls: ["SR-3.3"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.test-coverage.branch-coverage"
    - "testing-quality-assurance.test-coverage.mutation-testing-coverage"
    - "testing-quality-assurance.test-effectiveness.test-roi"
