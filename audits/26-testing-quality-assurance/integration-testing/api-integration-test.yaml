# ============================================================
# AUDIT: API Integration Test
# ============================================================
# Evaluates API integration testing for completeness and
# effectiveness.
# ============================================================

audit:
  id: "testing-quality-assurance.integration-testing.api-integration-test"
  name: "API Integration Test"
  version: "1.0.0"
  last_updated: "2026-01-22"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 26
  subcategory: "integration-testing"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "yes"
  severity: "high"
  scope: "testing"

  default_profiles:
    - "full"
    - "production"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates integration testing of APIs including REST endpoints,
    GraphQL queries/mutations, and gRPC services. Verifies request/response
    validation, authentication flows, error handling, status codes, and
    content negotiation are properly tested.

  why_it_matters: |
    APIs are the contract between services and clients. Untested APIs
    lead to integration failures, security vulnerabilities, and breaking
    changes that affect consumers. Comprehensive API testing ensures
    reliable service behavior and prevents contract violations.

  when_to_run:
    - "Pre-release API validation"
    - "After API changes"
    - "Contract compliance verification"
    - "New API version deployment"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "API implementation with tests"
    - type: "api_specification"
      description: "OpenAPI, GraphQL schema, or protobuf definitions"

  access_requirements:
    - "Source code repository access"
    - "Test environment API access"
    - "API specification access"

discovery:
  file_patterns:
    - glob: "**/api/**/*.test.*"
      purpose: "API test files"
    - glob: "**/*.api.test.*"
      purpose: "API test files"
    - glob: "**/e2e/api/**"
      purpose: "API e2e tests"

  code_patterns:
    - pattern: "supertest|request\\(app\\)|chai-http"
      type: "regex"
      scope: "test"
      purpose: "HTTP test libraries"
    - pattern: "expect\\(res\\.status\\)|expect\\(response\\.statusCode\\)"
      type: "regex"
      scope: "test"
      purpose: "Status code assertions"
    - pattern: "Authorization|Bearer|jwt|token"
      type: "regex"
      scope: "test"
      purpose: "Auth testing"

knowledge_sources:
  specifications:
    - id: "openapi"
      name: "OpenAPI Specification"
      url: "https://swagger.io/specification/"
      offline_cache: true
      priority: "recommended"

  guides:
    - id: "api-testing"
      name: "API Testing Best Practices"
      url: "https://www.postman.com/api-platform/api-testing/"
      offline_cache: true
    - id: "rest-testing"
      name: "REST API Testing Guide"
      url: "https://www.guru99.com/testing-rest-api-manually.html"
      offline_cache: true

  learning_resources:
    - id: "api-design"
      title: "API Design Patterns"
      type: "book"
      reference: "ISBN 978-1617295850"

tooling:
  static_analysis:
    - tool: "supertest"
      purpose: "Node.js HTTP assertions"
      offline_capable: true
    - tool: "pytest + requests"
      purpose: "Python API testing"
      offline_capable: true
    - tool: "REST Assured"
      purpose: "Java API testing"
      offline_capable: true
    - tool: "Postman/Newman"
      purpose: "API test automation"
      offline_capable: true

  scripts:
    - id: "api-test-coverage"
      language: "bash"
      purpose: "Check API test coverage"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== API Integration Test Analysis ==="

        echo "API routes defined:"
        grep -r -E "(app\.(get|post|put|delete|patch)|@(Get|Post|Put|Delete))" --include='*.{js,ts,java}' . 2>/dev/null | wc -l

        echo ""
        echo "API test files:"
        find . -name '*api*.test.*' -o -name '*.api.test.*' 2>/dev/null | wc -l

        echo ""
        echo "Status code tests:"
        grep -r -c 'status(\\|statusCode' --include='*.test.*' . 2>/dev/null | awk -F: '{sum+=$2} END {print sum}'

        echo ""
        echo "Auth tests:"
        grep -r -c 'Authorization\\|Bearer\\|401\\|403' --include='*.test.*' . 2>/dev/null | awk -F: '{sum+=$2} END {print sum}'

signals:
  critical:
    - id: "APITEST-CRIT-001"
      signal: "API endpoints lack integration tests"
      evidence_pattern: "Endpoints defined but no corresponding tests"
      explanation: |
        Untested API endpoints may return incorrect data, have broken
        validation, or expose security vulnerabilities. Each endpoint
        represents a contract that must be verified.
      remediation: |
        Create integration tests for each endpoint:
        1. Test happy path with valid inputs
        2. Test validation with invalid inputs
        3. Test authentication/authorization
        4. Test error responses
        5. Verify response schema matches spec

    - id: "APITEST-CRIT-002"
      signal: "Authentication/authorization flows untested"
      evidence_pattern: "No tests for 401/403 scenarios"
      explanation: |
        Auth bypass is a critical security vulnerability. Without
        testing protected endpoints with and without valid credentials,
        auth requirements may be incorrectly implemented.
      remediation: |
        Test auth for every protected endpoint:
        - Request without credentials (401)
        - Request with invalid credentials (401)
        - Request with insufficient permissions (403)
        - Request with valid credentials (success)

  high:
    - id: "APITEST-HIGH-001"
      signal: "Error responses not tested"
      evidence_pattern: "Only success scenarios tested, no 4xx/5xx tests"
      explanation: |
        APIs must return appropriate errors for invalid requests.
        Untested error handling may leak sensitive information,
        return incorrect status codes, or crash on edge cases.
      remediation: |
        Test error scenarios:
        - Invalid input (400)
        - Not found (404)
        - Validation failures (422)
        - Server errors (500) - verify no stack traces

    - id: "APITEST-HIGH-002"
      signal: "Request validation not tested"
      evidence_pattern: "No tests with invalid request bodies"
      explanation: |
        Inadequate validation testing allows malformed requests to
        reach business logic. This causes crashes, data corruption,
        or security vulnerabilities.
      remediation: |
        Test validation comprehensively:
        - Missing required fields
        - Invalid data types
        - Out of range values
        - Malicious input patterns

  medium:
    - id: "APITEST-MED-001"
      signal: "Response schema not validated"
      evidence_pattern: "Tests check status but not response structure"
      remediation: "Add schema validation to verify response matches contract"

    - id: "APITEST-MED-002"
      signal: "Content negotiation untested"
      evidence_pattern: "No tests for Accept/Content-Type headers"
      remediation: "Test content type handling if API supports multiple formats"

  low:
    - id: "APITEST-LOW-001"
      signal: "API versioning behavior untested"
      evidence_pattern: "Multiple versions without version-specific tests"

  positive:
    - id: "APITEST-POS-001"
      signal: "All endpoints have integration tests"
      evidence_pattern: "100% endpoint coverage"

    - id: "APITEST-POS-002"
      signal: "Schema-based response validation"
      evidence_pattern: "Using JSON Schema or similar for validation"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory API endpoints"
      description: |
        List all API endpoints to establish coverage baseline.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find Express/Koa routes"
          command: "grep -r -E \"app\\.(get|post|put|delete|patch)\\s*\\(\" --include='*.{js,ts}' . 2>/dev/null | head -30"
        - purpose: "Find controller annotations"
          command: "grep -r -E \"@(Get|Post|Put|Delete|Patch)Mapping\" --include='*.java' . 2>/dev/null | head -30"
      expected_findings:
        - "Endpoint inventory"
        - "Route count"

    - id: "2"
      name: "Map tests to endpoints"
      description: |
        Identify which endpoints have corresponding tests.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find endpoint tests"
          command: "grep -r -E \"(get|post|put|delete)\\s*\\(['\\\"/]\" --include='*.test.*' . 2>/dev/null | head -30"
      expected_findings:
        - "Test-to-endpoint mapping"
        - "Coverage gaps"

    - id: "3"
      name: "Verify auth testing"
      description: |
        Check for authentication and authorization tests.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find auth tests"
          command: "grep -r -E '(401|403|Authorization|Forbidden|Unauthorized)' --include='*.test.*' . 2>/dev/null | head -20"
      expected_findings:
        - "Auth test presence"
        - "Coverage of protected endpoints"

    - id: "4"
      name: "Check error handling tests"
      description: |
        Verify error scenarios are tested.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find error tests"
          command: "grep -r -E '(400|404|422|500)' --include='*.test.*' . 2>/dev/null | head -20"
      expected_findings:
        - "Error scenario coverage"
        - "Response validation"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "api_coverage_matrix"
      format: "table"
      sections:
        - "Endpoint Inventory"
        - "Test Coverage"
        - "Auth Coverage"
        - "Error Coverage"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "API Test Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Complete endpoint mapping with test verification"
    medium: "Sample-based analysis"
    low: "Pattern matching only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "api-testing"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed analysis"
    production:
      included: true
      priority: 2
    full:
      included: true
      priority: 4

closeout_checklist:
  - id: "apitest-001"
    item: "Endpoints inventoried"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Document all API endpoints"
    expected: "Confirmed by reviewer"

  - id: "apitest-002"
    item: "Test coverage mapped"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Match tests to endpoints"
    expected: "Confirmed by reviewer"

  - id: "apitest-003"
    item: "Auth testing verified"
    level: "CRITICAL"
    verification: "grep -r '401\\|403' --include='*.test.*' . 2>/dev/null | wc -l"
    expected: "Count > 0"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "OWASP API Security"
      controls: ["API1-API10"]
    - framework: "SOC2"
      controls: ["CC6.1"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.integration-testing.contract-testing"
    - "testing-quality-assurance.integration-testing.integration-test-coverage"
    - "security-trust.api-security.api-authentication"
