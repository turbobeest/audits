# ============================================================
# AUDIT: Third-Party Integration Test
# ============================================================
# Evaluates testing of third-party service integrations and
# external API dependencies.
# ============================================================

audit:
  id: "testing-quality-assurance.integration-testing.third-party-integration-test"
  name: "Third-Party Integration Test"
  version: "1.0.0"
  last_updated: "2026-01-22"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 26
  subcategory: "integration-testing"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "testing"

  default_profiles:
    - "full"
    - "production"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates testing of integrations with third-party services including
    payment processors, email providers, analytics platforms, identity
    providers, and external APIs. Verifies error handling, timeout
    behavior, authentication, and response processing are properly tested.

  why_it_matters: |
    Third-party integrations are a major source of production incidents.
    These services change without notice, have unique failure modes,
    and are outside your control. Comprehensive testing ensures your
    application handles third-party behavior gracefully, including
    failures, timeouts, and unexpected responses.

  when_to_run:
    - "After adding new third-party service"
    - "Third-party API version changes"
    - "Pre-release validation"
    - "Incident post-mortem"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Source code with third-party integrations"
    - type: "third_party_documentation"
      description: "API documentation for integrated services"

  access_requirements:
    - "Source code repository access"
    - "Sandbox/test accounts for third parties"
    - "Mock server infrastructure"

discovery:
  file_patterns:
    - glob: "**/integrations/**/*.test.*"
      purpose: "Integration test files"
    - glob: "**/external/**/*.test.*"
      purpose: "External service tests"
    - glob: "**/clients/**/*.test.*"
      purpose: "API client tests"

  code_patterns:
    - pattern: "stripe|paypal|twilio|sendgrid|auth0"
      type: "regex"
      scope: "source"
      purpose: "Common third-party services"
    - pattern: "nock|msw|wiremock|mock.*server"
      type: "regex"
      scope: "test"
      purpose: "HTTP mocking frameworks"
    - pattern: "sandbox|test.*api|staging"
      type: "regex"
      scope: "config"
      purpose: "Test environment configuration"

knowledge_sources:
  guides:
    - id: "third-party-testing"
      name: "Testing Third-Party Integrations"
      url: "https://www.martinfowler.com/articles/practical-test-pyramid.html#IntegrationTests"
      offline_cache: true
    - id: "contract-testing"
      name: "Consumer-Driven Contract Testing"
      url: "https://pact.io/"
      offline_cache: true

  learning_resources:
    - id: "vcr-pattern"
      title: "VCR/Replay Testing Pattern"
      type: "article"
      reference: "https://github.com/vcr/vcr"

tooling:
  infrastructure_tools:
    - tool: "nock"
      purpose: "Node.js HTTP mocking"
      offline_capable: true
    - tool: "msw"
      purpose: "Mock Service Worker"
      offline_capable: true
    - tool: "WireMock"
      purpose: "Java HTTP mocking"
      offline_capable: true
    - tool: "vcr.py"
      purpose: "Python HTTP recording"
      offline_capable: true
    - tool: "Pact"
      purpose: "Contract testing"
      offline_capable: true

  scripts:
    - id: "third-party-test-check"
      language: "bash"
      purpose: "Analyze third-party integration tests"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Third-Party Integration Test Analysis ==="

        echo "Third-party SDK usage:"
        grep -r -l 'stripe\\|paypal\\|twilio\\|sendgrid\\|aws-sdk\\|auth0' --include='*.{js,ts,py,java}' . 2>/dev/null | wc -l

        echo ""
        echo "Mock server usage:"
        grep -r -c 'nock\\|msw\\|wiremock\\|mock.*server' --include='*.test.*' . 2>/dev/null | awk -F: '{sum+=$2} END {print sum}'

        echo ""
        echo "Timeout tests:"
        grep -r -c 'timeout\\|ETIMEDOUT\\|TimeoutError' --include='*.test.*' . 2>/dev/null | awk -F: '{sum+=$2} END {print sum}'

        echo ""
        echo "Error response tests:"
        grep -r -c '5[0-9][0-9]\\|rate.*limit\\|ServiceUnavailable' --include='*.test.*' . 2>/dev/null | awk -F: '{sum+=$2} END {print sum}'

signals:
  critical:
    - id: "3RDPARTY-CRIT-001"
      signal: "No tests for critical third-party services"
      evidence_pattern: "Payment/auth providers without integration tests"
      explanation: |
        Critical third-party services like payment processors require
        thorough testing. Failures in these integrations directly
        impact revenue and user trust. Production is not the place
        to discover integration bugs.
      remediation: |
        For each critical third-party:
        1. Create mock/sandbox test environment
        2. Test authentication flow
        3. Test happy path transactions
        4. Test all error scenarios from API docs
        5. Test timeout and retry behavior

    - id: "3RDPARTY-CRIT-002"
      signal: "Third-party error handling untested"
      evidence_pattern: "No tests for 5xx errors, rate limits, or timeouts"
      explanation: |
        Third-party services fail regularly. Without testing error
        handling, your application may crash, hang, or expose confusing
        errors to users when external services have issues.
      remediation: |
        Test failure scenarios:
        - Service unavailable (503)
        - Rate limiting (429)
        - Request timeout
        - Invalid response format
        - Authentication expiry

  high:
    - id: "3RDPARTY-HIGH-001"
      signal: "Webhook handling untested"
      evidence_pattern: "Webhook endpoints without integration tests"
      explanation: |
        Webhooks process external events asynchronously. Untested
        webhook handlers may miss events, process duplicates, or
        fail to validate signatures, causing data inconsistency
        or security issues.
      remediation: |
        Test webhook handlers:
        - Signature validation
        - Duplicate event handling (idempotency)
        - Out-of-order event handling
        - Malformed payload handling

    - id: "3RDPARTY-HIGH-002"
      signal: "Real third-party calls in tests"
      evidence_pattern: "Tests hit actual third-party APIs without mocking"
      explanation: |
        Real API calls in tests are slow, flaky, may incur costs,
        and can cause unintended side effects. Tests should be
        deterministic and not depend on external service availability.
      remediation: |
        Mock third-party services:
        - Use nock/msw/wiremock for HTTP mocking
        - Record real responses for replay testing
        - Use official sandbox environments where available
        - Consider contract testing for API verification

  medium:
    - id: "3RDPARTY-MED-001"
      signal: "Third-party SDK version compatibility untested"
      evidence_pattern: "No tests for SDK upgrade impact"
      remediation: "Add version-specific tests or contract tests"

    - id: "3RDPARTY-MED-002"
      signal: "Retry logic untested"
      evidence_pattern: "Retry/backoff code without test coverage"
      remediation: "Test retry behavior including exponential backoff"

  low:
    - id: "3RDPARTY-LOW-001"
      signal: "Third-party rate limit handling not verified"
      evidence_pattern: "No tests for rate limit throttling behavior"

  positive:
    - id: "3RDPARTY-POS-001"
      signal: "Comprehensive mock coverage for third parties"
      evidence_pattern: "All third-party calls have mock tests"

    - id: "3RDPARTY-POS-002"
      signal: "Contract tests for critical integrations"
      evidence_pattern: "Pact or similar contract testing in place"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory third-party integrations"
      description: |
        Identify all third-party services the application integrates with.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find third-party imports"
          command: "grep -r -h 'import.*stripe\\|import.*twilio\\|require.*paypal' --include='*.{js,ts,py}' . 2>/dev/null | sort -u | head -20"
        - purpose: "Find API client configurations"
          command: "grep -r -l 'API_KEY\\|CLIENT_ID\\|SECRET' --include='*.{env,yaml,json}' . 2>/dev/null | head -10"
      expected_findings:
        - "Third-party service inventory"
        - "Integration criticality"

    - id: "2"
      name: "Map integration tests"
      description: |
        Identify tests for each third-party integration.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find integration tests"
          command: "find . -path '*integrations*' -name '*.test.*' 2>/dev/null"
        - purpose: "Find mock configurations"
          command: "grep -r -l 'nock\\|msw\\|wiremock' --include='*.test.*' . 2>/dev/null | head -20"
      expected_findings:
        - "Test coverage per service"
        - "Mocking approach"

    - id: "3"
      name: "Verify error handling tests"
      description: |
        Check for tests covering third-party failure scenarios.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find error scenario tests"
          command: "grep -r -E '(500|503|429|timeout|error)' --include='*.test.*' . 2>/dev/null | grep -i -E '(stripe|twilio|payment|external)' | head -20"
      expected_findings:
        - "Error handling coverage"
        - "Timeout testing"

    - id: "4"
      name: "Assess testing strategy"
      description: |
        Evaluate overall third-party testing approach.
      duration_estimate: "15 min"
      questions:
        - "Are sandbox environments used appropriately?"
        - "Is response recording used for replay testing?"
        - "Are contract tests in place?"
      expected_findings:
        - "Testing strategy assessment"
        - "Recommendations"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "integration_matrix"
      format: "table"
      sections:
        - "Third-Party Inventory"
        - "Test Coverage"
        - "Error Handling Coverage"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Integration Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Complete inventory with test mapping"
    medium: "Pattern-based analysis"
    low: "Estimated from code structure"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "third-party-testing"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed analysis"
    production:
      included: true
      priority: 4
    full:
      included: true
      priority: 7

closeout_checklist:
  - id: "3rdparty-001"
    item: "Third-party integrations inventoried"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Document all external service dependencies"
    expected: "Confirmed by reviewer"

  - id: "3rdparty-002"
    item: "Test coverage mapped"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Match tests to each integration"
    expected: "Confirmed by reviewer"

  - id: "3rdparty-003"
    item: "Error handling tested"
    level: "WARNING"
    verification: "grep -r 'timeout\\|5[0-9][0-9]' --include='*.test.*' . 2>/dev/null | wc -l"
    expected: "Count > 0"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "SOC2"
      controls: ["CC9.2"]
    - framework: "PCI-DSS"
      controls: ["6.5.10"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.integration-testing.contract-testing"
    - "testing-quality-assurance.integration-testing.integration-test-coverage"
    - "error-handling-resilience.external-failures.third-party-resilience"
