# ============================================================
# AUDIT: Mock/Stub Strategy
# ============================================================
# Evaluates the effectiveness and appropriateness of mocking
# and stubbing strategies in unit tests.
# ============================================================

audit:
  id: "testing-quality-assurance.unit-testing.mock-stub-strategy"
  name: "Mock/Stub Strategy"
  version: "1.0.0"
  last_updated: "2026-01-22"
  status: "active"

  category: "testing-quality-assurance"
  category_number: 26
  subcategory: "unit-testing"

  tier: "expert"
  estimated_duration: "1-2 hours"  # median: 1h

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "testing"

  default_profiles:
    - "full"
    - "quality"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the mocking and stubbing strategy used in unit tests including
    appropriate use of mocks vs stubs vs fakes, mock scope and granularity,
    verification of mock interactions, and avoidance of over-mocking that
    creates brittle tests.

  why_it_matters: |
    Proper mocking enables true unit testing by isolating the system under
    test. However, over-mocking creates tests that verify implementation
    details rather than behavior, making refactoring difficult. Under-mocking
    leaves external dependencies that cause flaky tests. The right balance
    is critical for maintainable, valuable tests.

  when_to_run:
    - "Test suite code review"
    - "Investigating brittle tests"
    - "Test maintainability assessment"
    - "After major refactoring"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Source code with unit tests"
    - type: "test_suite"
      description: "Tests using mocking frameworks"

  access_requirements:
    - "Source code repository access"
    - "Test file analysis capability"

discovery:
  code_patterns:
    - pattern: "jest\\.mock|mock\\.Mock|@Mock|MagicMock"
      type: "regex"
      scope: "test"
      purpose: "Mock creation patterns"
    - pattern: "jest\\.fn|stub|sinon\\.stub"
      type: "regex"
      scope: "test"
      purpose: "Stub patterns"
    - pattern: "verify|toHaveBeenCalled|assert_called"
      type: "regex"
      scope: "test"
      purpose: "Mock verification patterns"
    - pattern: "mockImplementation|mockReturnValue|return_value"
      type: "regex"
      scope: "test"
      purpose: "Mock configuration"

knowledge_sources:
  specifications:
    - id: "test-doubles"
      name: "Martin Fowler - Mocks Aren't Stubs"
      url: "https://martinfowler.com/articles/mocksArentStubs.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "jest-mocking"
      name: "Jest Mocking Guide"
      url: "https://jestjs.io/docs/mock-functions"
      offline_cache: true
    - id: "python-mocking"
      name: "Python unittest.mock Guide"
      url: "https://docs.python.org/3/library/unittest.mock.html"
      offline_cache: true

  learning_resources:
    - id: "growing-oo"
      title: "Growing Object-Oriented Software, Guided by Tests"
      type: "book"
      reference: "ISBN 978-0321503626"

tooling:
  static_analysis:
    - tool: "jest"
      purpose: "JavaScript mocking"
      offline_capable: true
    - tool: "unittest.mock"
      purpose: "Python mocking"
      offline_capable: true
    - tool: "Mockito"
      purpose: "Java mocking"
      offline_capable: true
    - tool: "sinon"
      purpose: "JavaScript stubs and spies"
      offline_capable: true

  scripts:
    - id: "mock-analysis"
      language: "bash"
      purpose: "Analyze mocking patterns"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Mock/Stub Strategy Analysis ==="

        echo "Mock creations:"
        grep -r -c 'jest\.mock\|Mock\(\|@Mock' --include='*.test.*' . 2>/dev/null | awk -F: '{sum+=$2} END {print sum}'

        echo "Stub creations:"
        grep -r -c 'jest\.fn\|stub\(' --include='*.test.*' . 2>/dev/null | awk -F: '{sum+=$2} END {print sum}'

        echo "Mock verifications:"
        grep -r -c 'toHaveBeenCalled\|verify\|assert_called' --include='*.test.*' . 2>/dev/null | awk -F: '{sum+=$2} END {print sum}'

        echo "Implementation mocks:"
        grep -r -c 'mockImplementation\|mockReturnValue' --include='*.test.*' . 2>/dev/null | awk -F: '{sum+=$2} END {print sum}'

signals:
  critical:
    - id: "MOCKSTUB-CRIT-001"
      signal: "Mocking the system under test"
      evidence_pattern: "Tests mock methods of the class being tested"
      explanation: |
        Mocking the system under test means you're testing mock behavior,
        not real code. The test proves nothing about actual functionality
        and will pass even if the real code is broken.
      remediation: |
        Only mock dependencies, never the system under test:
        - Mock collaborators, not the tested class
        - Use dependency injection to provide mocks
        - If you need to mock internals, consider refactoring

    - id: "MOCKSTUB-CRIT-002"
      signal: "No mocking of external services"
      evidence_pattern: "Tests make real network/database calls"
      explanation: |
        Without mocking external services, tests are not true unit tests.
        They become slow, flaky, and environment-dependent integration
        tests masquerading as unit tests.
      remediation: |
        Mock all external boundaries:
        - HTTP clients
        - Database connections
        - File system access
        - Third-party services

  high:
    - id: "MOCKSTUB-HIGH-001"
      signal: "Over-mocking internal implementation"
      evidence_pattern: "Every method call mocked with verification"
      explanation: |
        Tests that verify every internal method call are coupled to
        implementation details. Any refactoring breaks tests even if
        behavior is unchanged, making tests a burden not an asset.
      remediation: |
        Focus on behavior, not implementation:
        - Verify outputs and side effects, not method calls
        - Mock at boundaries, not between internal classes
        - Allow implementation changes without test changes

    - id: "MOCKSTUB-HIGH-002"
      signal: "Mock configurations are complex and fragile"
      evidence_pattern: "Long chains of mockReturnValue configurations"
      explanation: |
        Complex mock setup indicates tests are too coupled to
        implementation or testing at the wrong level. Maintenance
        burden grows with complexity.
      remediation: |
        Simplify mock setup:
        - Use builder patterns for complex objects
        - Create reusable mock factories
        - Consider testing at higher integration level

  medium:
    - id: "MOCKSTUB-MED-001"
      signal: "Inconsistent mock/stub usage across codebase"
      evidence_pattern: "Mixed patterns: jest.mock, jest.fn, manual stubs"
      remediation: "Standardize mocking approach across the project"

    - id: "MOCKSTUB-MED-002"
      signal: "Mocks not reset between tests"
      evidence_pattern: "Missing jest.clearAllMocks or mock.reset_mock"
      remediation: "Add mock cleanup in afterEach hooks"

  low:
    - id: "MOCKSTUB-LOW-001"
      signal: "Using mocks where stubs would suffice"
      evidence_pattern: "Mock verifications on unimportant calls"

  positive:
    - id: "MOCKSTUB-POS-001"
      signal: "Appropriate mock boundaries"
      evidence_pattern: "Mocking only at system edges"

    - id: "MOCKSTUB-POS-002"
      signal: "Behavior-focused assertions"
      evidence_pattern: "Verifying outcomes rather than call sequences"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory mocking patterns"
      description: |
        Identify all mocking and stubbing patterns used in tests.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find mock patterns"
          command: "grep -r -h 'jest\\.mock\\|mock\\.Mock\\|@Mock' --include='*.test.*' . 2>/dev/null | head -30"
        - purpose: "Find stub patterns"
          command: "grep -r -h 'jest\\.fn\\|stub\\(' --include='*.test.*' . 2>/dev/null | head -30"
      expected_findings:
        - "Mocking framework used"
        - "Mock creation patterns"

    - id: "2"
      name: "Analyze mock scope"
      description: |
        Determine what is being mocked - dependencies vs internals.
      duration_estimate: "30 min"
      commands:
        - purpose: "Check what's being mocked"
          command: "grep -r -B2 'jest\\.mock' --include='*.test.*' . 2>/dev/null | head -40"
      expected_findings:
        - "Mock targets"
        - "Boundary vs internal mocking"

    - id: "3"
      name: "Review mock verifications"
      description: |
        Assess whether verifications are behavior or implementation focused.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find verification patterns"
          command: "grep -r 'toHaveBeenCalled\\|verify\\|assert_called' --include='*.test.*' . 2>/dev/null | head -30"
      expected_findings:
        - "Verification patterns"
        - "Behavior vs implementation focus"

    - id: "4"
      name: "Check mock cleanup"
      description: |
        Verify mocks are properly cleaned up between tests.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find mock cleanup"
          command: "grep -r 'clearAllMocks\\|resetAllMocks\\|restore' --include='*.test.*' . 2>/dev/null | wc -l"
      expected_findings:
        - "Mock cleanup presence"
        - "Cleanup coverage"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "mock_analysis"
      format: "table"
      sections:
        - "Mocking Patterns Used"
        - "Mock Boundaries"
        - "Verification Practices"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Mocking Strategy Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Pattern analysis plus manual review"
    medium: "Automated pattern detection"
    low: "Estimated from sampling"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "test-doubles"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed analysis"
    full:
      included: true
      priority: 8

closeout_checklist:
  - id: "mockstub-001"
    item: "Mocking patterns inventoried"
    level: "CRITICAL"
    verification: "grep -r 'jest\\.mock\\|Mock' --include='*.test.*' . 2>/dev/null | wc -l"
    expected: "Count documented"

  - id: "mockstub-002"
    item: "Mock boundaries assessed"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Document what is being mocked"
    expected: "Confirmed by reviewer"

  - id: "mockstub-003"
    item: "Mock cleanup verified"
    level: "WARNING"
    verification: "grep -r 'clearAllMocks\\|afterEach' --include='*.test.*' . 2>/dev/null | wc -l"
    expected: "Cleanup present"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Testability"]

relationships:
  commonly_combined:
    - "testing-quality-assurance.unit-testing.unit-test-isolation"
    - "testing-quality-assurance.unit-testing.unit-test-maintainability"
    - "testing-quality-assurance.test-effectiveness.test-maintenance-burden"
