# ============================================================
# AUDIT: Data Loss Prevention Assessment
# ============================================================
# Evaluates mechanisms to prevent accidental data loss from
# navigation, browser events, or unsaved changes.
# ============================================================

audit:
  id: "usability-interaction.error-prevention.data-loss-prevention"

  name: "Data Loss Prevention Assessment"

  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "usability-interaction"
  category_number: 14
  subcategory: "error-prevention"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: true
  destructive: false

# ============================================================
# EXECUTION CLASSIFICATION
# ============================================================

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

# ============================================================
# DESCRIPTION & RATIONALE
# ============================================================

description:
  what: |
    This audit evaluates mechanisms that protect users from losing
    unsaved work. It examines browser navigation warnings, unsaved
    change detection, session persistence, and recovery mechanisms
    that prevent accidental data loss.

  why_it_matters: |
    Data loss is one of the most frustrating user experiences. When
    users accidentally navigate away from unsaved work or their session
    expires, they lose time and effort. Proper data loss prevention
    builds trust and reduces support burden while improving overall
    user satisfaction.

  when_to_run:
    - "When implementing forms with significant data entry"
    - "After data loss complaints from users"
    - "During session management review"
    - "When implementing content creation features"

# ============================================================
# PREREQUISITES
# ============================================================

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Form and data handling implementations"
    - type: "running_application"
      description: "Access to test data loss scenarios"

  access_requirements:
    - "Access to form and state management code"
    - "Ability to simulate navigation and session events"

# ============================================================
# DISCOVERY SPECIFICATION
# ============================================================

discovery:
  code_patterns:
    - pattern: "beforeunload|onbeforeunload"
      type: "keyword"
      scope: "source"
      purpose: "Find navigation warning handlers"
    - pattern: "unsaved|dirty|isDirty|hasChanges"
      type: "keyword"
      scope: "source"
      purpose: "Find unsaved change detection"
    - pattern: "localStorage|sessionStorage"
      type: "keyword"
      scope: "source"
      purpose: "Find local persistence mechanisms"
    - pattern: "autosave|autoSave|auto-save"
      type: "keyword"
      scope: "source"
      purpose: "Find auto-save implementations"

  file_patterns:
    - glob: "**/*form*"
      purpose: "Find form components"
    - glob: "**/*editor*"
      purpose: "Find editor components"
    - glob: "**/*draft*"
      purpose: "Find draft-related files"

# ============================================================
# KNOWLEDGE SOURCES
# ============================================================

knowledge_sources:
  guides:
    - id: "nngroup-unsaved"
      name: "Nielsen Norman Group - Preventing User Data Loss"
      url: "https://www.nngroup.com/articles/data-loss/"
      offline_cache: true
    - id: "web-dev-forms"
      name: "web.dev - Form Best Practices"
      url: "https://web.dev/learn/forms/"
      offline_cache: true

# ============================================================
# TOOLING & AUTOMATION
# ============================================================

tooling:
  scripts:
    - id: "data-loss-prevention-finder"
      language: "bash"
      purpose: "Find data loss prevention patterns"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Navigation Warning Handlers ==="
        grep -rn "beforeunload" --include="*.jsx" --include="*.tsx" --include="*.ts" | head -10

        echo "=== Unsaved Change Detection ==="
        grep -rn "unsaved\|dirty\|isDirty\|hasChanges" --include="*.jsx" --include="*.tsx" | head -15

        echo "=== Local Storage Usage ==="
        grep -rn "localStorage\|sessionStorage" --include="*.jsx" --include="*.tsx" --include="*.ts" | head -15

        echo "=== Auto-Save Patterns ==="
        grep -rn "autosave\|autoSave\|auto-save" --include="*.jsx" --include="*.tsx" | head -10

# ============================================================
# SIGNALS & FINDINGS TAXONOMY
# ============================================================

signals:
  critical:
    - id: "DATALOSS-CRIT-001"
      signal: "No warning when navigating away from unsaved changes"
      evidence_pattern: "Forms/editors without beforeunload handler or navigation prompt"
      explanation: |
        Users can accidentally lose significant work by closing tabs,
        clicking links, or using browser navigation without warning.
      remediation: "Implement beforeunload handler and/or navigation prompts for dirty forms"
    - id: "DATALOSS-CRIT-002"
      signal: "Session expiry loses unsaved work without warning"
      evidence_pattern: "Session timeout without data persistence or warning"
      explanation: |
        Users working on long tasks may have sessions expire, losing
        all unsaved work without opportunity to save.
      remediation: "Warn before session expiry; persist critical data locally"

  high:
    - id: "DATALOSS-HIGH-001"
      signal: "Complex form lacks any persistence"
      evidence_indicators:
        - "Multi-field form with no auto-save"
        - "No local storage backup"
        - "Refresh loses all entered data"
      explanation: |
        Complex forms require significant user effort that can be
        lost to accidental refresh or navigation.
      remediation: "Implement auto-save or local storage persistence for complex forms"
    - id: "DATALOSS-HIGH-002"
      signal: "Text editor content not persisted"
      evidence_pattern: "Rich text or code editor without draft saving"
      explanation: |
        Editors for significant content creation should preserve
        work-in-progress to prevent frustrating data loss.
      remediation: "Auto-save editor content to drafts or local storage"
    - id: "DATALOSS-HIGH-003"
      signal: "Multi-step form loses progress on back navigation"
      evidence_pattern: "Browser back button clears previous step data"
      explanation: |
        Users expect back navigation to return to previous state,
        not lose their progress.
      remediation: "Persist multi-step form state in URL, session, or local storage"

  medium:
    - id: "DATALOSS-MED-001"
      signal: "Unsaved indicator not visible"
      evidence_pattern: "No visual indication of unsaved changes"
      remediation: "Show clear indicator when form has unsaved changes"
    - id: "DATALOSS-MED-002"
      signal: "Auto-save interval too long"
      evidence_pattern: "Auto-save runs less frequently than every 60 seconds"
      remediation: "Reduce auto-save interval to 30-60 seconds for important content"
    - id: "DATALOSS-MED-003"
      signal: "No recovery after browser crash"
      evidence_pattern: "No mechanism to recover interrupted work"
      remediation: "Persist state that survives browser crashes (localStorage, IndexedDB)"

  low:
    - id: "DATALOSS-LOW-001"
      signal: "Auto-save status not communicated"
      remediation: "Show when data was last saved and saving status"
    - id: "DATALOSS-LOW-002"
      signal: "Draft recovery UX unclear"
      remediation: "Clearly offer draft recovery when returning to form"

  positive:
    - id: "DATALOSS-POS-001"
      signal: "Navigation warning implemented for unsaved changes"
    - id: "DATALOSS-POS-002"
      signal: "Auto-save implemented for forms/editors"
    - id: "DATALOSS-POS-003"
      signal: "Local storage persistence for critical data"
    - id: "DATALOSS-POS-004"
      signal: "Clear unsaved change indicators"

# ============================================================
# EXECUTION PROCEDURE
# ============================================================

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify Data Entry Points"
      description: |
        Map all significant data entry points including forms,
        editors, and configuration screens.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find form components"
          command: "find src/ -name '*form*' -o -name '*editor*' 2>/dev/null | head -20"
        - purpose: "Find state management for forms"
          command: "grep -rn 'formState\\|formData\\|values' --include='*.jsx' --include='*.tsx' src/ | head -20"
      expected_findings:
        - "Data entry point inventory"
        - "State management patterns"

    - id: "2"
      name: "Audit Navigation Warnings"
      description: |
        Check whether forms with significant data have navigation
        warnings implemented.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find beforeunload handlers"
          command: "grep -rn 'beforeunload' --include='*.jsx' --include='*.tsx' --include='*.ts' src/"
        - purpose: "Find prompt-on-navigation patterns"
          command: "grep -rn 'Prompt\\|usePrompt\\|useBlocker' --include='*.jsx' --include='*.tsx' src/"
      expected_findings:
        - "Navigation warning coverage"
        - "Missing warnings"

    - id: "3"
      name: "Test Data Persistence"
      description: |
        Test whether form data persists across refresh, navigation,
        and session events.
      duration_estimate: "30 min"
      questions:
        - "Does page refresh preserve entered data?"
        - "Does browser back button preserve form state?"
        - "Does session timeout preserve or warn about data?"
        - "Is there auto-save functionality?"
      expected_findings:
        - "Persistence behavior"
        - "Data loss scenarios"

    - id: "4"
      name: "Review Auto-Save Implementation"
      description: |
        Evaluate auto-save implementations for coverage, frequency,
        and user communication.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find auto-save patterns"
          command: "grep -rn 'autosave\\|autoSave\\|auto-save' --include='*.jsx' --include='*.tsx' src/"
      questions:
        - "Is auto-save interval appropriate?"
        - "Is save status communicated to users?"
        - "Can users access previous versions?"
      expected_findings:
        - "Auto-save implementation quality"
        - "User communication"

# ============================================================
# OUTPUT SPECIFICATION
# ============================================================

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Data Entry Point Inventory"
        - "Navigation Warning Assessment"
        - "Persistence Testing Results"
        - "Auto-Save Review"
        - "Recommendations"

  confidence_guidance:
    high: "Issues verified through code review and functional testing"
    medium: "Issues identified through code review or testing alone"
    low: "Potential issues requiring additional scenario testing"

# ============================================================
# OFFLINE SUPPORT
# ============================================================

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "nngroup-unsaved"
        priority: "recommended"

# ============================================================
# PROFILES
# ============================================================

profiles:
  membership:
    quick:
      included: true
      priority: 2
    full:
      included: true
      priority: 1

# ============================================================
# CLOSEOUT CHECKLIST
# ============================================================

closeout_checklist:
  - id: "dataloss-001"
    item: "Navigation warnings for unsaved changes"
    level: "CRITICAL"
    verification: "grep -rn 'beforeunload' --include='*.jsx' --include='*.tsx' --include='*.ts' src/ | wc -l"
    expected: ">0 beforeunload handlers found"

  - id: "dataloss-002"
    item: "Complex forms have persistence"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Multi-field forms persist data across refresh"
    expected: "Confirmed by reviewer"

  - id: "dataloss-003"
    item: "Unsaved change indicator visible"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Users can see when forms have unsaved changes"
    expected: "Confirmed by reviewer"

# ============================================================
# GOVERNANCE
# ============================================================

governance:
  applicable_to:
    archetypes: ["web-application", "mobile-application", "saas"]

# ============================================================
# RELATIONSHIPS
# ============================================================

relationships:
  commonly_combined:
    - "usability-interaction.error-prevention.draft-auto-save"
    - "usability-interaction.forms-input.multi-step-form-flow"
    - "usability-interaction.error-prevention.recovery-path"
