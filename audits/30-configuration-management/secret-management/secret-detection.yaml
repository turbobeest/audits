# ============================================================
# AUDIT: Secret Detection
# Category: 30 - Configuration Management
# Subcategory: secret-management
# ============================================================
# Detection of secrets in code and configurations to prevent
# accidental exposure.
# ============================================================

audit:
  id: "configuration-management.secret-management.secret-detection"
  name: "Secret Detection Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "secret-management"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h
  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "full"
  severity: "critical"
  scope: "codebase"
  default_profiles: ["full", "production", "security"]

description:
  what: |
    This audit examines secret detection mechanisms to prevent accidental
    exposure of credentials in code. It evaluates pre-commit hooks,
    CI scanning, secret detection tools, and historical secret scanning.

  why_it_matters: |
    Secrets committed to code are exposed in git history forever. Detection
    at commit time prevents exposure. Historical scanning finds past exposure.
    Automated detection catches secrets that humans miss.

  when_to_run:
    - "When implementing DevSecOps"
    - "After secret exposure incidents"
    - "During security assessments"

discovery:
  code_patterns:
    - pattern: "(detect[-_]secrets|gitleaks|trufflehog|git[-_]secrets)"
      type: "regex"
      scope: "config"
      purpose: "Detect secret scanning tools"

  file_patterns:
    - glob: "**/.pre-commit-config.yaml"
      purpose: "Pre-commit configuration"
    - glob: "**/.gitleaks*"
      purpose: "Gitleaks configuration"
    - glob: "**/.detect-secrets*"
      purpose: "detect-secrets configuration"

signals:
  critical:
    - id: "SDET-CRIT-001"
      signal: "No secret detection in place"
      evidence_indicators:
        - "No pre-commit hooks"
        - "No CI secret scanning"
        - "No detection tools configured"
      explanation: "Without detection, secrets are easily committed to code."
      remediation: "Implement secret detection (gitleaks, detect-secrets, etc.)."
      cwe: "CWE-540"

    - id: "SDET-CRIT-002"
      signal: "Secrets found in codebase"
      evidence_indicators:
        - "API keys in code"
        - "Passwords in configs"
        - "Credentials in git history"
      explanation: "Exposed secrets enable unauthorized access."
      remediation: "Remove secrets, rotate credentials, scan history."

  high:
    - id: "SDET-HIGH-001"
      signal: "Secret detection bypassed"
      evidence_indicators:
        - "Can commit without scanning"
        - "Detection not enforced in CI"
        - "Easy to skip hooks"
      explanation: "Bypassable detection provides false confidence."
      remediation: "Enforce detection in CI pipeline."

    - id: "SDET-HIGH-002"
      signal: "Historical secrets not scanned"
      evidence_indicators:
        - "Git history not scanned"
        - "Old secrets may exist"
        - "No historical analysis"
      explanation: "Historical secrets remain exposed."
      remediation: "Scan git history for secrets."

  medium:
    - id: "SDET-MED-001"
      signal: "Secret detection rules incomplete"
      evidence_indicators:
        - "Custom secrets not detected"
        - "Limited pattern coverage"
        - "New secret types missed"
      explanation: "Incomplete rules miss some secrets."
      remediation: "Add custom rules for organization-specific secrets."

procedure:
  steps:
    - id: "1"
      name: "Detection Tool Assessment"
      description: "Assess secret detection tooling."
      commands:
        - purpose: "Check for pre-commit hooks"
          command: |
            cat .pre-commit-config.yaml 2>/dev/null | grep -i secret | head -10
        - purpose: "Find gitleaks/detect-secrets config"
          command: |
            find . \( -name ".gitleaks*" -o -name ".detect-secrets*" \) 2>/dev/null | head -10
        - purpose: "Check CI for secret scanning"
          command: |
            grep -rn "gitleaks\|detect.secrets\|trufflehog" \
              --include="*.yaml" .github/workflows/ 2>/dev/null | head -20

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"

profiles:
  membership:
    quick: {included: true, priority: 2}
    full: {included: true, priority: 1}
    security: {included: true, priority: 1}

governance:
  applicable_to:
    archetypes: ["all"]
  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["CC6.1"]
    - framework: "PCI-DSS"
      controls: ["6.5"]
