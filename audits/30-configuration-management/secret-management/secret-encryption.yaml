# ============================================================
# AUDIT: Secret Encryption
# Category: 30 - Configuration Management
# Subcategory: secret-management
# ============================================================
# Encryption of secrets at rest and in transit ensuring
# confidentiality.
# ============================================================

audit:
  id: "configuration-management.secret-management.secret-encryption"
  name: "Secret Encryption Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "secret-management"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h
  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "infrastructure"
  default_profiles: ["full", "production", "security"]

description:
  what: |
    This audit examines encryption of secrets at rest and in transit.
    It evaluates encryption algorithms, key management, TLS configuration,
    and encrypted secret storage.

  why_it_matters: |
    Unencrypted secrets are exposed if storage is compromised. Encryption
    at rest protects stored secrets. Encryption in transit prevents
    interception. Strong key management is essential for encryption value.

  when_to_run:
    - "During security assessments"
    - "Compliance audits"
    - "When implementing encryption"

discovery:
  code_patterns:
    - pattern: "(encrypt|decrypt|kms|seal|unseal)"
      type: "regex"
      scope: "config"
      purpose: "Detect encryption configuration"

    - pattern: "(aes|rsa|kms[-_]key|master[-_]key)"
      type: "regex"
      scope: "config"
      purpose: "Detect encryption algorithms/keys"

  file_patterns:
    - glob: "**/*.enc"
      purpose: "Encrypted files"
    - glob: "**/sealed*"
      purpose: "Sealed secrets"

signals:
  critical:
    - id: "SENC-CRIT-001"
      signal: "Secrets stored unencrypted"
      evidence_indicators:
        - "Plaintext secrets in storage"
        - "No encryption at rest"
        - "Secrets readable without decryption"
      explanation: "Unencrypted secrets are exposed if storage is compromised."
      remediation: "Encrypt all secrets at rest."
      cwe: "CWE-312"

    - id: "SENC-CRIT-002"
      signal: "Secrets transmitted unencrypted"
      evidence_indicators:
        - "HTTP used for secrets"
        - "No TLS for secret retrieval"
        - "Plaintext protocols"
      explanation: "Unencrypted transit exposes secrets to interception."
      remediation: "Use TLS for all secret transmission."
      cwe: "CWE-319"

  high:
    - id: "SENC-HIGH-001"
      signal: "Weak encryption algorithm"
      evidence_indicators:
        - "DES or 3DES in use"
        - "MD5 for sensitive data"
        - "Deprecated algorithms"
      explanation: "Weak algorithms can be broken."
      remediation: "Use AES-256 or better for encryption."

    - id: "SENC-HIGH-002"
      signal: "Encryption keys poorly managed"
      evidence_indicators:
        - "Keys in code"
        - "Keys not rotated"
        - "Keys stored with data"
      explanation: "Poor key management defeats encryption."
      remediation: "Use KMS with proper key rotation and separation."

  medium:
    - id: "SENC-MED-001"
      signal: "No key rotation"
      evidence_indicators:
        - "Same encryption key for years"
        - "No rotation policy"
        - "No automated rotation"
      explanation: "Long-lived keys accumulate risk."
      remediation: "Implement key rotation policy."

procedure:
  steps:
    - id: "1"
      name: "Encryption Configuration Review"
      description: "Review secret encryption configuration."
      commands:
        - purpose: "Find encryption configurations"
          command: |
            grep -rn "encrypt\|kms\|seal" --include="*.yaml" --include="*.tf" . 2>/dev/null | head -30
        - purpose: "Check for encrypted files"
          command: |
            find . -name "*.enc" -o -name "*sealed*" 2>/dev/null | head -20

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"

profiles:
  membership:
    full: {included: true, priority: 1}
    security: {included: true, priority: 1}
    production: {included: true, priority: 1}

governance:
  applicable_to:
    archetypes: ["all"]
  compliance_frameworks:
    - framework: "PCI-DSS"
      controls: ["3.4", "4.1"]
    - framework: "SOC 2"
      controls: ["CC6.1"]
    - framework: "ISO 27001"
      controls: ["A.8.24"]
