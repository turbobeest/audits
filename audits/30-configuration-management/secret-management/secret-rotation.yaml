# ============================================================
# AUDIT: Secret Rotation
# Category: 30 - Configuration Management
# Subcategory: secret-management
# ============================================================
# Automatic rotation of secrets to limit exposure window and
# meet compliance requirements.
# ============================================================

audit:
  id: "configuration-management.secret-management.secret-rotation"
  name: "Secret Rotation Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "secret-management"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h
  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "infrastructure"
  default_profiles: ["full", "production", "security"]

description:
  what: |
    This audit examines secret rotation practices to limit credential
    exposure window. It evaluates rotation policies, automation,
    zero-downtime rotation, and rotation monitoring.

  why_it_matters: |
    Secret rotation limits the damage from compromised credentials.
    PCI-DSS requires password rotation. Long-lived secrets have extended
    exposure windows. Automated rotation ensures consistent compliance.

  when_to_run:
    - "During security assessments"
    - "Compliance audits"
    - "After credential exposure"

discovery:
  code_patterns:
    - pattern: "(rotat|renew|expire)[-_](secret|credential|key|password)"
      type: "regex"
      scope: "config"
      purpose: "Detect rotation configuration"

  file_patterns:
    - glob: "**/*rotation*"
      purpose: "Rotation configurations"

signals:
  critical:
    - id: "SROT-CRIT-001"
      signal: "Secrets never rotated"
      evidence_indicators:
        - "Same credentials for years"
        - "No rotation policy"
        - "Static API keys"
      explanation: "Long-lived secrets have extended exposure windows."
      remediation: "Implement automatic secret rotation."
      cwe: "CWE-798"

  high:
    - id: "SROT-HIGH-001"
      signal: "Rotation not automated"
      evidence_indicators:
        - "Manual rotation only"
        - "Rotation often skipped"
        - "No rotation reminders"
      explanation: "Manual rotation is inconsistent and often neglected."
      remediation: "Automate secret rotation with vault or secrets manager."

    - id: "SROT-HIGH-002"
      signal: "Rotation causes downtime"
      evidence_indicators:
        - "Services fail during rotation"
        - "No graceful rotation"
        - "Applications not rotation-aware"
      explanation: "Disruptive rotation discourages regular rotation."
      remediation: "Implement zero-downtime rotation patterns."

  medium:
    - id: "SROT-MED-001"
      signal: "Rotation period too long"
      evidence_indicators:
        - "Rotation less than annually"
        - "No defined rotation schedule"
        - "Inconsistent rotation periods"
      explanation: "Long rotation periods extend exposure windows."
      remediation: "Implement 90-day rotation minimum, shorter for high-risk."

    - id: "SROT-MED-002"
      signal: "No rotation monitoring"
      evidence_indicators:
        - "Cannot verify rotation occurred"
        - "No rotation alerts"
        - "Rotation failures undetected"
      explanation: "Unmonitored rotation may fail silently."
      remediation: "Monitor and alert on rotation success/failure."

procedure:
  steps:
    - id: "1"
      name: "Rotation Policy Review"
      description: "Review secret rotation policies and automation."
      commands:
        - purpose: "Find rotation configurations"
          command: |
            grep -rn "rotat" --include="*.yaml" --include="*.tf" . 2>/dev/null | head -30
        - purpose: "Check AWS Secrets Manager rotation"
          command: |
            grep -rn "rotation_lambda\|rotation_rules" --include="*.tf" . 2>/dev/null | head -20

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"

profiles:
  membership:
    full: {included: true, priority: 1}
    security: {included: true, priority: 1}
    production: {included: true, priority: 1}

governance:
  applicable_to:
    archetypes: ["all"]
  compliance_frameworks:
    - framework: "PCI-DSS"
      controls: ["8.2.4"]
    - framework: "SOC 2"
      controls: ["CC6.1"]
