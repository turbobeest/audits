# ============================================================
# AUDIT: Secret Injection
# Category: 30 - Configuration Management
# Subcategory: secret-management
# ============================================================
# Secure injection of secrets into applications at runtime
# without exposing in configurations.
# ============================================================

audit:
  id: "configuration-management.secret-management.secret-injection"
  name: "Secret Injection Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "secret-management"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h
  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "infrastructure"
  default_profiles: ["full", "production", "security"]

description:
  what: |
    This audit examines how secrets are injected into applications at
    runtime. It evaluates injection patterns, sidecar injectors,
    init containers, environment variable injection, and file mounts.

  why_it_matters: |
    Proper secret injection keeps secrets out of configs and images.
    Secrets should be retrieved at runtime, not baked in. Injection
    patterns affect security, portability, and operational complexity.

  when_to_run:
    - "When implementing secret management"
    - "During deployment pipeline review"
    - "Security assessments"

discovery:
  code_patterns:
    - pattern: "(inject|sidecar|mutating[-_]webhook|init[-_]container)"
      type: "regex"
      scope: "config"
      purpose: "Detect injection patterns"

    - pattern: "(external[-_]secrets|sealed[-_]secrets|vault[-_]agent)"
      type: "regex"
      scope: "config"
      purpose: "Detect secret injectors"

  file_patterns:
    - glob: "**/external-secrets/**"
      purpose: "External Secrets configs"
    - glob: "**/vault-agent/**"
      purpose: "Vault Agent configs"

signals:
  high:
    - id: "SINJ-HIGH-001"
      signal: "Secrets baked into container images"
      evidence_indicators:
        - "Secrets in Dockerfile"
        - "Secrets copied at build time"
        - "Secrets in image layers"
      explanation: "Baked secrets are exposed in image registry and layers."
      remediation: "Inject secrets at runtime, never at build time."
      cwe: "CWE-312"

    - id: "SINJ-HIGH-002"
      signal: "Secrets passed as command arguments"
      evidence_indicators:
        - "Secrets in command line"
        - "Visible in process list"
        - "Logged in history"
      explanation: "Command line secrets are visible in process lists."
      remediation: "Use environment variables or file mounts instead."

    - id: "SINJ-HIGH-003"
      signal: "No secret injection mechanism"
      evidence_indicators:
        - "Manual secret configuration"
        - "Secrets in config maps"
        - "No automated injection"
      explanation: "Manual handling increases exposure risk."
      remediation: "Implement automated secret injection (External Secrets, Vault Agent)."

  medium:
    - id: "SINJ-MED-001"
      signal: "Injected secrets visible in environment"
      evidence_indicators:
        - "Secrets in env dump"
        - "No memory-only injection"
        - "Debug endpoints expose env"
      explanation: "Environment secrets can be exposed through debug endpoints."
      remediation: "Consider file-based injection or memory-only patterns."

    - id: "SINJ-MED-002"
      signal: "Injection not refreshed on rotation"
      evidence_indicators:
        - "Restart required for new secrets"
        - "No dynamic refresh"
        - "Stale secrets after rotation"
      explanation: "Non-refreshing injection breaks rotation."
      remediation: "Implement dynamic secret refresh without restart."

procedure:
  steps:
    - id: "1"
      name: "Injection Pattern Analysis"
      description: "Analyze secret injection patterns."
      commands:
        - purpose: "Find Kubernetes secret references"
          command: |
            grep -rn "secretKeyRef\|secretRef" --include="*.yaml" . 2>/dev/null | head -30
        - purpose: "Find external secrets configurations"
          command: |
            find . -name "*external-secret*" -o -name "*vault-agent*" 2>/dev/null | head -20
        - purpose: "Check for secrets in Dockerfiles"
          command: |
            grep -rn "secret\|password\|key" --include="Dockerfile*" . 2>/dev/null | head -20

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"

profiles:
  membership:
    full: {included: true, priority: 1}
    security: {included: true, priority: 1}
    production: {included: true, priority: 1}

governance:
  applicable_to:
    archetypes: ["all"]
  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["CC6.1"]
