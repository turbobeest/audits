# ============================================================
# AUDIT: Vault Integration
# Category: 30 - Configuration Management
# Subcategory: secret-management
# ============================================================
# Integration with secret management systems (HashiCorp Vault,
# AWS Secrets Manager, etc.) for secure secret storage.
# ============================================================

audit:
  id: "configuration-management.secret-management.vault-integration"
  name: "Vault Integration Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "secret-management"

  tier: "expert"
  estimated_duration: "3-4 hours"  # median: 3h
  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "infrastructure"
  default_profiles: ["full", "production", "security"]

description:
  what: |
    This audit examines integration with secret management systems for
    secure storage and retrieval of secrets. It evaluates vault deployment,
    authentication methods, access policies, audit logging, and secret
    injection patterns.

  why_it_matters: |
    Centralized secret management is essential for security. Secrets in code
    or config files are exposed. Vault provides secure storage, access control,
    audit logging, and rotation capabilities that protect sensitive data.

  when_to_run:
    - "During security assessments"
    - "When implementing secret management"
    - "After security incidents"
    - "Compliance audits"

discovery:
  code_patterns:
    - pattern: "(vault|secretsmanager|keyvault|secret[-_]store)"
      type: "regex"
      scope: "config"
      purpose: "Detect secret management integration"

    - pattern: "(VAULT_|AWS_SECRETS|AZURE_KEYVAULT)"
      type: "regex"
      scope: "config"
      purpose: "Detect secret manager env vars"

  file_patterns:
    - glob: "**/vault/**"
      purpose: "Vault configurations"
    - glob: "**/*secret*manager*"
      purpose: "Secret manager configurations"

signals:
  critical:
    - id: "VINT-CRIT-001"
      signal: "No secret management system in use"
      evidence_indicators:
        - "Secrets in environment files"
        - "Secrets in config files"
        - "No vault integration"
      explanation: "Without vault, secrets are exposed in code and configs."
      remediation: "Implement HashiCorp Vault, AWS Secrets Manager, or equivalent."
      cwe: "CWE-312"

    - id: "VINT-CRIT-002"
      signal: "Vault audit logging disabled"
      evidence_indicators:
        - "No audit log for secret access"
        - "Cannot track who accessed secrets"
        - "Audit logging not configured"
      explanation: "Without audit logging, secret access cannot be monitored."
      remediation: "Enable and configure vault audit logging."

  high:
    - id: "VINT-HIGH-001"
      signal: "Vault authentication weak"
      evidence_indicators:
        - "Token-only authentication"
        - "Long-lived tokens"
        - "Shared credentials"
      explanation: "Weak authentication enables unauthorized secret access."
      remediation: "Use strong authentication (IAM roles, Kubernetes auth, etc.)."

    - id: "VINT-HIGH-002"
      signal: "Vault policies overly permissive"
      evidence_indicators:
        - "Wildcard paths in policies"
        - "Broad secret access"
        - "No least privilege"
      explanation: "Permissive policies violate least privilege."
      remediation: "Implement fine-grained, least-privilege policies."

    - id: "VINT-HIGH-003"
      signal: "Secrets retrieved and stored locally"
      evidence_indicators:
        - "Secrets written to disk"
        - "Secrets cached in files"
        - "No direct injection"
      explanation: "Local storage exposes secrets."
      remediation: "Use direct secret injection, avoid local storage."

  medium:
    - id: "VINT-MED-001"
      signal: "Vault high availability not configured"
      evidence_indicators:
        - "Single vault instance"
        - "No cluster configuration"
        - "No failover"
      explanation: "Single instance creates availability risk."
      remediation: "Deploy vault in HA configuration."

    - id: "VINT-MED-002"
      signal: "Vault backup procedures missing"
      evidence_indicators:
        - "No vault backup"
        - "No disaster recovery plan"
        - "Cannot recover secrets"
      explanation: "Without backups, secrets could be lost."
      remediation: "Implement vault backup and disaster recovery."

procedure:
  steps:
    - id: "1"
      name: "Vault Integration Assessment"
      description: "Assess vault integration and configuration."
      commands:
        - purpose: "Find vault configurations"
          command: |
            find . -name "*vault*" -not -path "*/node_modules/*" 2>/dev/null | head -30
        - purpose: "Check for secret manager references"
          command: |
            grep -rn "secretsmanager\|VAULT_\|keyvault" \
              --include="*.yaml" --include="*.tf" . 2>/dev/null | head -30

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"

profiles:
  membership:
    full: {included: true, priority: 1}
    security: {included: true, priority: 1}
    production: {included: true, priority: 1}

governance:
  applicable_to:
    archetypes: ["all"]
  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["CC6.1", "CC6.6"]
    - framework: "PCI-DSS"
      controls: ["3.4", "3.5"]
    - framework: "ISO 27001"
      controls: ["A.8.24"]
