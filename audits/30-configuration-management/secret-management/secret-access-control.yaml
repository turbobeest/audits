# ============================================================
# AUDIT: Secret Access Control
# Category: 30 - Configuration Management
# Subcategory: secret-management
# ============================================================
# Access controls for secrets ensuring least privilege and
# appropriate authorization.
# ============================================================

audit:
  id: "configuration-management.secret-management.secret-access-control"
  name: "Secret Access Control Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "secret-management"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h
  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "infrastructure"
  default_profiles: ["full", "production", "security"]

description:
  what: |
    This audit examines access controls for secrets ensuring appropriate
    authorization and least privilege. It evaluates RBAC policies, service
    account access, human access controls, and access audit logging.

  why_it_matters: |
    Secret access must follow least privilege. Overly broad access exposes
    secrets to unnecessary risk. Proper access controls limit blast radius
    of compromised accounts and ensure compliance.

  when_to_run:
    - "During security assessments"
    - "After access control changes"
    - "Compliance audits"

discovery:
  code_patterns:
    - pattern: "(policy|role|permission).*secret"
      type: "regex"
      scope: "config"
      purpose: "Detect secret access policies"

  file_patterns:
    - glob: "**/policies/**"
      purpose: "Policy definitions"

signals:
  critical:
    - id: "SACL-CRIT-001"
      signal: "Secrets accessible without authentication"
      evidence_indicators:
        - "No auth required for secrets"
        - "Anonymous secret access"
        - "Public secret endpoints"
      explanation: "Unauthenticated access exposes secrets to anyone."
      remediation: "Require strong authentication for all secret access."
      cwe: "CWE-306"

    - id: "SACL-CRIT-002"
      signal: "Overly permissive secret access"
      evidence_indicators:
        - "Everyone can access all secrets"
        - "No RBAC for secrets"
        - "Wildcard permissions"
      explanation: "Permissive access violates least privilege."
      remediation: "Implement least-privilege RBAC for secrets."
      cwe: "CWE-250"

  high:
    - id: "SACL-HIGH-001"
      signal: "No secret access audit logging"
      evidence_indicators:
        - "Access not logged"
        - "Cannot determine who accessed secrets"
        - "No audit trail"
      explanation: "Without logging, unauthorized access goes undetected."
      remediation: "Enable comprehensive secret access logging."

    - id: "SACL-HIGH-002"
      signal: "Human access not restricted"
      evidence_indicators:
        - "Developers can access prod secrets"
        - "No break-glass process"
        - "Standing human access"
      explanation: "Standing human access increases risk."
      remediation: "Implement just-in-time access for humans."

  medium:
    - id: "SACL-MED-001"
      signal: "No access review process"
      evidence_indicators:
        - "Access never reviewed"
        - "Stale access not removed"
        - "No periodic recertification"
      explanation: "Unreviewed access accumulates beyond need."
      remediation: "Implement periodic access reviews."

procedure:
  steps:
    - id: "1"
      name: "Access Policy Review"
      description: "Review secret access policies."
      commands:
        - purpose: "Find secret policies"
          command: |
            find . -name "*policy*" -exec grep -l "secret" {} \; 2>/dev/null | head -20
        - purpose: "Check for wildcard permissions"
          command: |
            grep -rn '"\*"' --include="*.tf" --include="*.yaml" . 2>/dev/null | \
              grep -i "secret" | head -20

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"

profiles:
  membership:
    full: {included: true, priority: 1}
    security: {included: true, priority: 1}
    production: {included: true, priority: 1}

governance:
  applicable_to:
    archetypes: ["all"]
  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["CC6.1", "CC6.2", "CC6.3"]
    - framework: "PCI-DSS"
      controls: ["7.1", "7.2"]
