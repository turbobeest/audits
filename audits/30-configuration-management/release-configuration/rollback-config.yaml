# ============================================================
# AUDIT: Rollback Configuration
# Category: 30 - Configuration Management
# Subcategory: release-configuration
# ============================================================
# Configuration for deployment rollback capabilities ensuring
# quick recovery from failed releases.
# ============================================================

audit:
  id: "configuration-management.release-configuration.rollback-config"
  name: "Rollback Configuration Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "release-configuration"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h
  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "infrastructure"
  default_profiles: ["full", "production"]

description:
  what: |
    This audit examines rollback configuration and capabilities for
    deployments. It evaluates rollback procedures, artifact retention,
    database migration rollback, and automated rollback triggers.

  why_it_matters: |
    Every deployment needs a rollback plan. When releases fail, quick
    rollback minimizes user impact. Without proper rollback configuration,
    teams scramble during incidents, extending outages and increasing risk.

  when_to_run:
    - "When establishing deployment pipelines"
    - "After rollback failures"
    - "During DR planning"
    - "For production readiness reviews"

discovery:
  code_patterns:
    - pattern: "(rollback|revert|previous[-_]version)"
      type: "regex"
      scope: "config"
      purpose: "Detect rollback configurations"
    - pattern: "(revisionHistoryLimit|rollbackTo)"
      type: "regex"
      scope: "config"
      purpose: "Detect Kubernetes rollback settings"

  file_patterns:
    - glob: "**/*rollback*"
      purpose: "Rollback configuration files"
    - glob: "**/migrations/**"
      purpose: "Database migrations"

signals:
  critical:
    - id: "RLBK-CRIT-001"
      signal: "No rollback capability exists"
      evidence_indicators:
        - "Cannot revert deployments"
        - "No previous version retention"
        - "Rollback requires redeploy"
      explanation: "Without rollback, recovery requires full redeploy."
      remediation: "Implement instant rollback capability."

    - id: "RLBK-CRIT-002"
      signal: "Database migrations cannot be rolled back"
      evidence_indicators:
        - "Destructive migrations"
        - "No down migrations"
        - "Data loss on rollback"
      explanation: "Irreversible migrations prevent full rollback."
      remediation: "Ensure all migrations are reversible."

  high:
    - id: "RLBK-HIGH-001"
      signal: "Insufficient revision history retained"
      evidence_indicators:
        - "Only one previous version"
        - "History quickly pruned"
        - "Cannot rollback multiple versions"
      explanation: "Limited history restricts rollback options."
      remediation: "Retain at least 5-10 previous revisions."

    - id: "RLBK-HIGH-002"
      signal: "Rollback not tested regularly"
      evidence_indicators:
        - "Never tested rollback"
        - "No rollback drills"
        - "Process untested"
      explanation: "Untested rollback may fail when needed."
      remediation: "Test rollback procedures regularly."

  medium:
    - id: "RLBK-MED-001"
      signal: "Manual rollback process"
      evidence_indicators:
        - "No automated rollback"
        - "Multiple manual steps"
        - "Requires deep knowledge"
      explanation: "Manual rollback is slow and error-prone."
      remediation: "Automate rollback process."

    - id: "RLBK-MED-002"
      signal: "No automatic rollback triggers"
      evidence_indicators:
        - "Requires human detection"
        - "No metric-based triggers"
        - "No health check integration"
      explanation: "Auto-triggers enable faster recovery."
      remediation: "Configure automatic rollback on failure metrics."

  low:
    - id: "RLBK-LOW-001"
      signal: "Rollback procedures not documented"
      evidence_indicators:
        - "No runbook"
        - "Tribal knowledge only"
        - "Steps not written down"
      explanation: "Documentation ensures anyone can rollback."
      remediation: "Document rollback procedures in runbook."

procedure:
  steps:
    - id: "1"
      name: "Rollback Capability Assessment"
      description: "Assess rollback configuration and capability."
      commands:
        - purpose: "Check Kubernetes revision history"
          command: |
            grep -rn "revisionHistoryLimit" --include="*.yaml" . 2>/dev/null | head -20
        - purpose: "Find rollback scripts"
          command: |
            find . -name "*rollback*" -type f 2>/dev/null | head -20

    - id: "2"
      name: "Database Migration Review"
      description: "Review database migration reversibility."
      commands:
        - purpose: "Find migration files"
          command: |
            find . -path "*/migrations/*" -name "*.sql" -o -path "*/migrations/*" -name "*.py" 2>/dev/null | head -20
        - purpose: "Check for down migrations"
          command: |
            grep -rn "down\|rollback\|revert" --include="*.sql" . 2>/dev/null | head -20

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
    - type: "rollback_capability_matrix"
      format: "table"
      description: "Matrix of rollback capabilities by component"

profiles:
  membership:
    full: {included: true, priority: 1}
    quick: {included: true, priority: 1}
    production: {included: true, priority: 1}

governance:
  applicable_to:
    archetypes: ["all"]
  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["CC7.4"]
