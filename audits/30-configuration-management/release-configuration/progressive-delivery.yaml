# ============================================================
# AUDIT: Progressive Delivery Configuration
# Category: 30 - Configuration Management
# Subcategory: release-configuration
# ============================================================
# Configuration for progressive delivery strategies combining
# multiple deployment techniques for safe releases.
# ============================================================

audit:
  id: "configuration-management.release-configuration.progressive-delivery"
  name: "Progressive Delivery Configuration Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "release-configuration"

  tier: "expert"
  estimated_duration: "3-4 hours"  # median: 3h
  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "infrastructure"
  default_profiles: ["full", "production"]

description:
  what: |
    This audit examines progressive delivery configurations that combine
    feature flags, canary deployments, and metrics analysis for controlled
    releases. It evaluates the integration of deployment strategies with
    observability and automated decision-making.

  why_it_matters: |
    Progressive delivery represents the state of the art in safe releases,
    combining multiple techniques for risk reduction. Poor configuration
    can negate these benefits or create complex failure modes. Proper
    setup ensures each layer provides its intended protection.

  when_to_run:
    - "When implementing progressive delivery"
    - "After release incidents"
    - "During deployment modernization"
    - "For SRE maturity assessments"

discovery:
  code_patterns:
    - pattern: "(Rollout|AnalysisRun|Experiment)"
      type: "regex"
      scope: "config"
      purpose: "Detect Argo Rollouts resources"
    - pattern: "(flagger|istio|linkerd)"
      type: "regex"
      scope: "config"
      purpose: "Detect service mesh integration"

  file_patterns:
    - glob: "**/rollouts/**"
      purpose: "Rollout configurations"
    - glob: "**/analysis/**"
      purpose: "Analysis templates"
    - glob: "**/experiments/**"
      purpose: "Experiment configurations"

signals:
  critical:
    - id: "PROG-CRIT-001"
      signal: "No automated analysis for progressive rollouts"
      evidence_indicators:
        - "Manual promotion decisions"
        - "No metric-based gates"
        - "Human judgment only"
      explanation: "Automation enables faster, more consistent decisions."
      remediation: "Configure automated analysis with clear success criteria."

  high:
    - id: "PROG-HIGH-001"
      signal: "Analysis metrics not comprehensive"
      evidence_indicators:
        - "Only error rate checked"
        - "No latency analysis"
        - "Business metrics ignored"
      explanation: "Narrow metrics miss important issues."
      remediation: "Include error rate, latency, and business metrics."

    - id: "PROG-HIGH-002"
      signal: "No integration between feature flags and deployment"
      evidence_indicators:
        - "Flags and deployments separate"
        - "No coordinated rollout"
        - "Manual flag management"
      explanation: "Integration enables feature-level progressive delivery."
      remediation: "Integrate feature flags with deployment tooling."

  medium:
    - id: "PROG-MED-001"
      signal: "No experiment capabilities"
      evidence_indicators:
        - "Cannot run A/B tests"
        - "No baseline comparison"
        - "No statistical analysis"
      explanation: "Experiments enable data-driven decisions."
      remediation: "Add experiment capability for comparing releases."

    - id: "PROG-MED-002"
      signal: "Analysis templates not reusable"
      evidence_indicators:
        - "Per-service analysis configs"
        - "Duplicated definitions"
        - "Inconsistent criteria"
      explanation: "Reusable templates ensure consistency."
      remediation: "Create shared analysis templates."

  low:
    - id: "PROG-LOW-001"
      signal: "Progressive delivery strategy not documented"
      evidence_indicators:
        - "No strategy documentation"
        - "Team not trained"
        - "Inconsistent application"
      explanation: "Documentation ensures consistent adoption."
      remediation: "Document progressive delivery strategy and train teams."

procedure:
  steps:
    - id: "1"
      name: "Progressive Delivery Assessment"
      description: "Assess progressive delivery configuration."
      commands:
        - purpose: "Find Argo Rollouts resources"
          command: |
            grep -rn "kind: Rollout\|kind: AnalysisTemplate\|kind: Experiment" \
              --include="*.yaml" . 2>/dev/null | head -20
        - purpose: "Find Flagger configurations"
          command: |
            grep -rn "kind: Canary\|flagger" --include="*.yaml" . 2>/dev/null | head -20

    - id: "2"
      name: "Analysis Configuration Review"
      description: "Review analysis and metrics configuration."
      commands:
        - purpose: "Check analysis metrics"
          command: |
            grep -A20 "metrics:" --include="*.yaml" -r . 2>/dev/null | \
              grep -E "name:|successCondition:|provider:" | head -30
        - purpose: "Check success criteria"
          command: |
            grep -rn "successCondition\|failureCondition" --include="*.yaml" . 2>/dev/null | head -20

    - id: "3"
      name: "Integration Assessment"
      description: "Assess integration with other systems."
      commands:
        - purpose: "Check feature flag integration"
          command: |
            grep -rn "featureFlag\|launchdarkly\|unleash" --include="*.yaml" . 2>/dev/null | head -20
        - purpose: "Check notification integration"
          command: |
            grep -rn "notification\|slack\|webhook" --include="*.yaml" . 2>/dev/null | head -20

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
    - type: "maturity_assessment"
      format: "table"
      description: "Progressive delivery maturity by component"

profiles:
  membership:
    full: {included: true, priority: 1}
    production: {included: true, priority: 1}

governance:
  applicable_to:
    archetypes: ["saas", "platform", "microservices"]

relationships:
  related_audits:
    - id: "configuration-management.release-configuration.canary-config"
      relationship: "extends"
    - id: "configuration-management.feature-flags.flag-lifecycle"
      relationship: "complements"
