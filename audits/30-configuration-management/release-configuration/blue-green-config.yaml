# ============================================================
# AUDIT: Blue-Green Deployment Configuration
# Category: 30 - Configuration Management
# Subcategory: release-configuration
# ============================================================
# Configuration for blue-green deployments enabling zero-downtime
# releases with instant traffic switching.
# ============================================================

audit:
  id: "configuration-management.release-configuration.blue-green-config"
  name: "Blue-Green Deployment Configuration Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "release-configuration"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h
  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "infrastructure"
  default_profiles: ["full", "production"]

description:
  what: |
    This audit examines blue-green deployment configurations. It evaluates
    environment parity between blue and green, traffic switching mechanisms,
    validation procedures, and resource management for parallel environments.

  why_it_matters: |
    Blue-green deployments provide zero-downtime releases and instant rollback.
    Misconfiguration can cause traffic routing issues, resource waste, or
    failed cutover. Proper configuration ensures reliable deployment switching.

  when_to_run:
    - "When implementing blue-green strategy"
    - "After cutover failures"
    - "During deployment strategy reviews"
    - "For DR testing"

discovery:
  code_patterns:
    - pattern: "(blue[-_]green|active[-_]passive|slot[-_]swap)"
      type: "regex"
      scope: "config"
      purpose: "Detect blue-green configurations"
    - pattern: "(previewService|activeService)"
      type: "regex"
      scope: "config"
      purpose: "Detect Argo Rollouts blue-green"

  file_patterns:
    - glob: "**/*blue*green*"
      purpose: "Blue-green configuration files"
    - glob: "**/slots/**"
      purpose: "Deployment slot configurations"

signals:
  critical:
    - id: "BLGR-CRIT-001"
      signal: "Blue and green environments not identical"
      evidence_indicators:
        - "Different infrastructure configs"
        - "Resource disparity"
        - "Configuration drift between slots"
      explanation: "Non-identical environments cause unpredictable behavior."
      remediation: "Ensure blue and green are configured identically."

  high:
    - id: "BLGR-HIGH-001"
      signal: "No health validation before traffic switch"
      evidence_indicators:
        - "Switch without validation"
        - "No smoke tests"
        - "Blind cutover"
      explanation: "Unvalidated switches can route traffic to broken deployments."
      remediation: "Implement health checks before traffic switch."

    - id: "BLGR-HIGH-002"
      signal: "Traffic switch not instant"
      evidence_indicators:
        - "Gradual DNS-based switch"
        - "TTL delays"
        - "Split traffic during switch"
      explanation: "Slow switches reduce blue-green benefits."
      remediation: "Use load balancer or service mesh for instant switch."

  medium:
    - id: "BLGR-MED-001"
      signal: "No promotion automation"
      evidence_indicators:
        - "Manual traffic switch"
        - "No automated validation"
        - "Human-triggered cutover"
      explanation: "Manual processes are slow and error-prone."
      remediation: "Automate blue-green promotion with validation."

    - id: "BLGR-MED-002"
      signal: "Insufficient old environment retention"
      evidence_indicators:
        - "Green torn down immediately"
        - "No rollback window"
        - "Quick cleanup"
      explanation: "Retain old environment for quick rollback."
      remediation: "Keep previous environment running for rollback period."

  low:
    - id: "BLGR-LOW-001"
      signal: "Blue-green procedures not documented"
      evidence_indicators:
        - "No cutover runbook"
        - "Process undocumented"
        - "Tribal knowledge"
      explanation: "Documentation ensures consistent execution."
      remediation: "Document blue-green procedures."

procedure:
  steps:
    - id: "1"
      name: "Blue-Green Config Assessment"
      description: "Assess blue-green deployment configuration."
      commands:
        - purpose: "Find blue-green configurations"
          command: |
            find . -name "*blue*" -o -name "*green*" -o -name "*slot*" 2>/dev/null | head -20
        - purpose: "Check for Argo Rollouts blue-green"
          command: |
            grep -rn "blueGreen\|previewService\|activeService" --include="*.yaml" . 2>/dev/null | head -20

    - id: "2"
      name: "Environment Parity Check"
      description: "Verify blue and green environment parity."
      commands:
        - purpose: "Compare environment configurations"
          command: |
            diff -r blue/ green/ 2>/dev/null || echo "Check manually if dirs don't exist"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"

profiles:
  membership:
    full: {included: true, priority: 2}
    production: {included: true, priority: 2}

governance:
  applicable_to:
    archetypes: ["saas", "platform", "enterprise"]
