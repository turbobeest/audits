# ============================================================
# AUDIT: Environment Provisioning
# Category: 30 - Configuration Management
# Subcategory: environment-management
# ============================================================
# Automated and consistent provisioning of environments through
# infrastructure as code.
# ============================================================

audit:
  id: "configuration-management.environment-management.environment-provisioning"
  name: "Environment Provisioning Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "environment-management"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h
  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "infrastructure"
  default_profiles: ["full", "production"]

description:
  what: |
    This audit examines environment provisioning practices through
    infrastructure as code. It evaluates IaC coverage, provisioning
    automation, environment templates, and reproducibility.

  why_it_matters: |
    IaC enables reproducible and consistent environment provisioning.
    Manual provisioning creates drift and inconsistency. Automated
    provisioning supports rapid scaling and disaster recovery.

  when_to_run:
    - "When implementing IaC"
    - "During infrastructure reviews"
    - "When scaling operations"

discovery:
  code_patterns:
    - pattern: "(terraform|pulumi|cloudformation|cdk)"
      type: "regex"
      scope: "config"
      purpose: "Detect IaC tools"

    - pattern: "resource\\s+\"[^\"]+\"\\s+\"[^\"]+\""
      type: "regex"
      scope: "config"
      purpose: "Detect Terraform resources"

  file_patterns:
    - glob: "**/*.tf"
      purpose: "Terraform files"
    - glob: "**/cloudformation/**"
      purpose: "CloudFormation templates"
    - glob: "**/cdk/**"
      purpose: "CDK code"

signals:
  critical:
    - id: "EPRV-CRIT-001"
      signal: "Production environment manually provisioned"
      evidence_indicators:
        - "No IaC for production"
        - "Console-created resources"
        - "Cannot reproduce environment"
      explanation: "Manual provisioning prevents reproducibility and disaster recovery."
      remediation: "Implement IaC for all production infrastructure."

  high:
    - id: "EPRV-HIGH-001"
      signal: "Inconsistent provisioning across environments"
      evidence_indicators:
        - "Different methods for different environments"
        - "Some environments use IaC, others manual"
        - "Drift between IaC and reality"
      explanation: "Inconsistent provisioning creates environment differences."
      remediation: "Use same IaC approach for all environments."

    - id: "EPRV-HIGH-002"
      signal: "No environment template or module"
      evidence_indicators:
        - "Copy-paste for new environments"
        - "No reusable modules"
        - "Duplication across environments"
      explanation: "Without templates, each environment diverges over time."
      remediation: "Create reusable environment modules/templates."

  medium:
    - id: "EPRV-MED-001"
      signal: "Provisioning not automated"
      evidence_indicators:
        - "Manual terraform apply"
        - "No CI/CD for infrastructure"
        - "Human-triggered deployments only"
      explanation: "Manual provisioning is slow and error-prone."
      remediation: "Automate provisioning through CI/CD pipelines."

procedure:
  steps:
    - id: "1"
      name: "IaC Coverage Assessment"
      description: "Assess infrastructure as code coverage."
      commands:
        - purpose: "Find Terraform files"
          command: |
            find . -name "*.tf" -not -path "*/.terraform/*" 2>/dev/null | wc -l
        - purpose: "List IaC resources"
          command: |
            grep -rn "^resource " --include="*.tf" . 2>/dev/null | wc -l

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"

profiles:
  membership:
    full: {included: true, priority: 2}
    production: {included: true, priority: 2}

governance:
  applicable_to:
    archetypes: ["all"]
  compliance_frameworks:
    - framework: "CMMI"
      controls: ["CM"]
