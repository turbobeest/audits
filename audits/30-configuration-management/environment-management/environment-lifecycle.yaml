# ============================================================
# AUDIT: Environment Lifecycle Management
# Category: 30 - Configuration Management
# Subcategory: environment-management
# ============================================================
# Managing the complete lifecycle of environments from creation
# through decommissioning.
# ============================================================

audit:
  id: "configuration-management.environment-management.environment-lifecycle"
  name: "Environment Lifecycle Management Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "environment-management"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h
  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "infrastructure"
  default_profiles: ["full", "production"]

description:
  what: |
    This audit examines management of environment lifecycle from creation
    through decommissioning. It evaluates creation procedures, maintenance,
    temporary environment cleanup, and secure decommissioning.

  why_it_matters: |
    Unmanaged environment lifecycle creates waste and security risk.
    Orphaned environments consume resources and may be forgotten attack
    surfaces. Proper decommissioning ensures data is securely removed.

  when_to_run:
    - "During cost optimization"
    - "Security assessments"
    - "Quarterly resource reviews"

discovery:
  code_patterns:
    - pattern: "(ttl|expires|cleanup|decommission)"
      type: "regex"
      scope: "config"
      purpose: "Detect lifecycle configuration"

  file_patterns:
    - glob: "**/lifecycle/**"
      purpose: "Lifecycle configurations"

signals:
  high:
    - id: "ELFC-HIGH-001"
      signal: "Temporary environments not cleaned up"
      evidence_indicators:
        - "Old test environments running"
        - "No TTL on temporary environments"
        - "Resources from old branches"
      explanation: "Orphaned environments waste resources and create risk."
      remediation: "Implement automatic cleanup for temporary environments."

    - id: "ELFC-HIGH-002"
      signal: "No decommissioning procedure"
      evidence_indicators:
        - "Environments shut down without process"
        - "Data not securely deleted"
        - "Access not revoked"
      explanation: "Improper decommissioning leaves data and access exposed."
      remediation: "Define and follow decommissioning procedures."

  medium:
    - id: "ELFC-MED-001"
      signal: "Environment inventory incomplete"
      evidence_indicators:
        - "Unknown environments exist"
        - "No central inventory"
        - "Environments not tracked"
      explanation: "Untracked environments are unmanaged environments."
      remediation: "Maintain complete environment inventory."

    - id: "ELFC-MED-002"
      signal: "Environment ownership unclear"
      evidence_indicators:
        - "No owner assigned"
        - "Orphaned environments"
        - "Unknown who maintains"
      explanation: "Unowned environments lack accountability."
      remediation: "Assign and track environment ownership."

procedure:
  steps:
    - id: "1"
      name: "Environment Inventory Review"
      description: "Review environment inventory and ownership."
      commands:
        - purpose: "Find environment configurations"
          command: |
            find . -type d \( -name "environments" -o -name "envs" \) \
              -not -path "*/node_modules/*" 2>/dev/null | head -20
        - purpose: "Check for cleanup/TTL configurations"
          command: |
            grep -rn "ttl\|cleanup\|expire" --include="*.yaml" --include="*.tf" . 2>/dev/null | head -20

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"

profiles:
  membership:
    full: {included: true, priority: 2}
    production: {included: true, priority: 2}

governance:
  applicable_to:
    archetypes: ["all"]
  compliance_frameworks:
    - framework: "ITIL"
      controls: ["Service Asset and Configuration Management"]
