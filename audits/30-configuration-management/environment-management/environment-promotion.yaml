# ============================================================
# AUDIT: Environment Promotion
# Category: 30 - Configuration Management
# Subcategory: environment-management
# ============================================================
# Controlled promotion of configurations through environment tiers
# from development to production.
# ============================================================

audit:
  id: "configuration-management.environment-management.environment-promotion"
  name: "Environment Promotion Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "environment-management"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h
  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "infrastructure"
  default_profiles: ["full", "production"]

description:
  what: |
    This audit examines the controlled promotion of configurations through
    environment tiers. It evaluates promotion pipelines, approval gates,
    promotion validation, and rollback capabilities.

  why_it_matters: |
    Controlled promotion ensures configurations are validated before reaching
    production. Direct-to-production changes bypass validation. ITIL recommends
    staged change promotion through controlled environments.

  when_to_run:
    - "When establishing deployment pipelines"
    - "After promotion-related incidents"
    - "During CI/CD improvements"

discovery:
  code_patterns:
    - pattern: "(promote|deploy|release)[-_](to|env|environment)"
      type: "regex"
      scope: "config"
      purpose: "Detect promotion configurations"

  file_patterns:
    - glob: "**/.github/workflows/*deploy*.yaml"
      purpose: "Deployment workflows"

signals:
  critical:
    - id: "EPRO-CRIT-001"
      signal: "Direct deployment to production bypassing staging"
      evidence_indicators:
        - "No staging environment in pipeline"
        - "Production deploys without prior environment"
        - "No validation before production"
      explanation: "Direct production deployment bypasses validation stages."
      remediation: "Implement mandatory staging deployment before production."

  high:
    - id: "EPRO-HIGH-001"
      signal: "No approval gates between environments"
      evidence_indicators:
        - "Automatic promotion without approval"
        - "No manual gates for production"
      explanation: "Ungated promotion enables untested changes reaching production."
      remediation: "Add approval gates between environment tiers."

  medium:
    - id: "EPRO-MED-001"
      signal: "Promotion validation incomplete"
      evidence_indicators:
        - "No smoke tests after promotion"
        - "Health checks not verified"
      explanation: "Unvalidated promotions may deploy broken configurations."
      remediation: "Add post-promotion validation and smoke tests."

procedure:
  steps:
    - id: "1"
      name: "Promotion Pipeline Review"
      description: "Review deployment pipeline for promotion stages."
      commands:
        - purpose: "Find deployment workflows"
          command: |
            find . -name "*deploy*.yaml" -path ".github/workflows/*" 2>/dev/null | head -20
        - purpose: "Check for environment stages"
          command: |
            grep -rn "environment:" --include="*.yaml" .github/workflows/ 2>/dev/null | head -30

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"

profiles:
  membership:
    full: {included: true, priority: 1}
    production: {included: true, priority: 1}

governance:
  applicable_to:
    archetypes: ["all"]
  compliance_frameworks:
    - framework: "ITIL"
      controls: ["Release Management"]
