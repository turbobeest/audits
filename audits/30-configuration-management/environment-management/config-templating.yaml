# ============================================================
# AUDIT: Configuration Templating
# Category: 30 - Configuration Management
# Subcategory: environment-management
# ============================================================
# Use of templates and parameterization for environment-specific
# configuration generation.
# ============================================================

audit:
  id: "configuration-management.environment-management.config-templating"
  name: "Configuration Templating Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "environment-management"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h
  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "full"
  severity: "medium"
  scope: "codebase"
  default_profiles: ["full", "production"]

description:
  what: |
    This audit examines configuration templating practices for generating
    environment-specific configurations from shared templates. It evaluates
    template usage, parameterization, and template management.

  why_it_matters: |
    Templates enable DRY (Don't Repeat Yourself) configuration management.
    Without templates, configurations are duplicated and diverge. Parameterized
    templates ensure consistency while supporting environment differences.

  when_to_run:
    - "When configuration duplication is high"
    - "During configuration standardization"
    - "When adding new environments"

discovery:
  code_patterns:
    - pattern: "(template|tmpl|tpl|j2|jinja|mustache|handlebars)"
      type: "regex"
      scope: "config"
      purpose: "Detect templating"

    - pattern: "\\{\\{\\s*\\.\\w+\\s*\\}\\}|\\{%\\s*"
      type: "regex"
      scope: "config"
      purpose: "Detect template syntax"

  file_patterns:
    - glob: "**/*.tpl"
      purpose: "Template files"
    - glob: "**/*.tmpl"
      purpose: "Template files"
    - glob: "**/*.j2"
      purpose: "Jinja2 templates"
    - glob: "**/templates/**"
      purpose: "Template directories"

signals:
  high:
    - id: "CTPL-HIGH-001"
      signal: "Configuration duplication across environments"
      evidence_indicators:
        - "Copied configs for each environment"
        - "Same content with minor differences"
        - "Updates needed in multiple places"
      explanation: "Duplication leads to inconsistency and maintenance burden."
      remediation: "Consolidate into parameterized templates."

    - id: "CTPL-HIGH-002"
      signal: "Templates not validated"
      evidence_indicators:
        - "Template errors discovered at deploy time"
        - "No template linting"
        - "Invalid syntax not caught"
      explanation: "Unvalidated templates fail during deployment."
      remediation: "Implement template validation in CI."

  medium:
    - id: "CTPL-MED-001"
      signal: "Inconsistent templating approaches"
      evidence_indicators:
        - "Mix of templating engines"
        - "Some configs templated, others not"
        - "No standard approach"
      explanation: "Inconsistent approaches increase complexity."
      remediation: "Standardize on single templating approach."

    - id: "CTPL-MED-002"
      signal: "Template variables undocumented"
      evidence_indicators:
        - "No variable documentation"
        - "Required variables unclear"
        - "Default values undocumented"
      explanation: "Undocumented variables cause deployment errors."
      remediation: "Document all template variables and defaults."

  low:
    - id: "CTPL-LOW-001"
      signal: "Templates too complex"
      evidence_indicators:
        - "Heavy logic in templates"
        - "Deeply nested conditionals"
        - "Difficult to understand"
      explanation: "Complex templates are error-prone and hard to maintain."
      remediation: "Simplify templates, move logic elsewhere."

procedure:
  steps:
    - id: "1"
      name: "Template Usage Assessment"
      description: "Assess template usage in configurations."
      commands:
        - purpose: "Find template files"
          command: |
            find . \( -name "*.tpl" -o -name "*.tmpl" -o -name "*.j2" \) \
              -not -path "*/node_modules/*" 2>/dev/null | head -30
        - purpose: "Detect template syntax in configs"
          command: |
            grep -rl "{{" --include="*.yaml" --include="*.json" . 2>/dev/null | head -20

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"

profiles:
  membership:
    full: {included: true, priority: 2}
    production: {included: true, priority: 2}

governance:
  applicable_to:
    archetypes: ["all"]
