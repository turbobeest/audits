# ============================================================
# AUDIT: Environment Isolation
# Category: 30 - Configuration Management
# Subcategory: environment-management
# ============================================================
# Ensuring proper isolation between environments to prevent
# cross-environment impact and data leakage.
# ============================================================

audit:
  id: "configuration-management.environment-management.environment-isolation"
  name: "Environment Isolation Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "environment-management"

  tier: "expert"
  estimated_duration: "3-4 hours"  # median: 3h
  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "infrastructure"
  default_profiles: ["full", "production", "security"]

description:
  what: |
    This audit examines isolation between environments to prevent cross-
    environment impact. It evaluates network isolation, data separation,
    credential isolation, and resource boundaries.

  why_it_matters: |
    Environment isolation prevents cascading failures and data breaches.
    Development accessing production data violates privacy. Shared resources
    create dependencies that cause cross-environment failures.

  when_to_run:
    - "During security assessments"
    - "When setting up new environments"
    - "After cross-environment incidents"

discovery:
  code_patterns:
    - pattern: "(vpc|network|subnet|isolation|segregat)"
      type: "regex"
      scope: "config"
      purpose: "Detect network isolation configuration"

    - pattern: "(cross[-_]env|shared[-_]resource)"
      type: "regex"
      scope: "config"
      purpose: "Detect cross-environment references"

  file_patterns:
    - glob: "**/network/**"
      purpose: "Network configurations"
    - glob: "**/vpc/**"
      purpose: "VPC configurations"

signals:
  critical:
    - id: "EISO-CRIT-001"
      signal: "Environments share production data"
      evidence_indicators:
        - "Dev/staging access production database"
        - "Same data source across environments"
        - "Production data in non-production"
      explanation: "Shared production data creates privacy and security risks."
      remediation: "Implement data isolation with masked/synthetic data for non-prod."
      cwe: "CWE-653"

    - id: "EISO-CRIT-002"
      signal: "No network isolation between environments"
      evidence_indicators:
        - "Shared VPC/network"
        - "No firewall between environments"
        - "Cross-environment connectivity"
      explanation: "Network connectivity enables cross-environment attacks."
      remediation: "Implement network segmentation between environments."

  high:
    - id: "EISO-HIGH-001"
      signal: "Shared credentials across environments"
      evidence_indicators:
        - "Same API keys in dev and prod"
        - "Shared service accounts"
        - "Common secrets across environments"
      explanation: "Shared credentials enable dev access to production."
      remediation: "Use environment-specific credentials."

    - id: "EISO-HIGH-002"
      signal: "Shared infrastructure resources"
      evidence_indicators:
        - "Same cluster for all environments"
        - "Shared message queues"
        - "Common cache instances"
      explanation: "Shared resources create cross-environment dependencies."
      remediation: "Provision dedicated resources per environment."

  medium:
    - id: "EISO-MED-001"
      signal: "Environment boundary not enforced"
      evidence_indicators:
        - "Cross-environment API calls possible"
        - "No validation of target environment"
      explanation: "Unenforced boundaries enable accidental cross-environment impact."
      remediation: "Implement environment boundary validation."

procedure:
  steps:
    - id: "1"
      name: "Network Isolation Review"
      description: "Review network isolation between environments."
      commands:
        - purpose: "Find network configurations"
          command: |
            find . -name "*.tf" -exec grep -l "vpc\|subnet\|network" {} \; 2>/dev/null | head -20
        - purpose: "Check for cross-environment references"
          command: |
            grep -rn "prod.*dev\|dev.*prod" --include="*.yaml" --include="*.tf" . 2>/dev/null | head -20

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"

profiles:
  membership:
    full: {included: true, priority: 1}
    security: {included: true, priority: 1}
    production: {included: true, priority: 1}

governance:
  applicable_to:
    archetypes: ["all"]
  compliance_frameworks:
    - framework: "SOC 2"
      controls: ["CC6.1"]
    - framework: "PCI-DSS"
      controls: ["6.4"]
