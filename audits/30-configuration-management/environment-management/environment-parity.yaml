# ============================================================
# AUDIT: Environment Parity
# Category: 30 - Configuration Management
# Subcategory: environment-management
# ============================================================
# Ensuring development, staging, and production environments
# have consistent configurations per 12-factor app principles.
# ============================================================

audit:
  id: "configuration-management.environment-management.environment-parity"
  name: "Environment Parity Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "environment-management"

  tier: "expert"
  estimated_duration: "3-4 hours"  # median: 3h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "infrastructure"

  default_profiles:
    - "full"
    - "production"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit examines consistency between development, staging, and
    production environments. It evaluates:
    - Configuration structure parity across environments
    - Infrastructure configuration alignment
    - Service version consistency
    - Database schema synchronization
    - Third-party service parity
    - Environment-specific vs shared configurations
    - Parity verification automation

  why_it_matters: |
    Environment parity is essential for reliable deployments:
    - 12-factor app Factor X requires keeping dev, staging, and prod similar
    - Environment drift causes "works on my machine" problems
    - Differences create surprises in production deployment
    - Parity enables accurate testing in non-production
    - Compliance may require consistent controls across environments
    - Parity reduces deployment risk and incident likelihood

  when_to_run:
    - "When environments are initially set up"
    - "After environment drift is suspected"
    - "Before major deployments"
    - "During deployment pipeline improvements"
    - "Quarterly environment reviews"

prerequisites:
  required_artifacts:
    - type: "environment_configs"
      description: "Configuration files for all environments"
    - type: "infrastructure_code"
      description: "IaC defining environment infrastructure"

  access_requirements:
    - "Read access to all environment configurations"
    - "Access to environment infrastructure"

discovery:
  code_patterns:
    - pattern: "(dev|development|staging|stage|prod|production)"
      type: "regex"
      scope: "config"
      purpose: "Detect environment-specific configurations"

    - pattern: "environment:\\s*(dev|staging|prod)"
      type: "regex"
      scope: "config"
      purpose: "Detect environment declarations"

  file_patterns:
    - glob: "**/environments/**"
      purpose: "Environment directories"
    - glob: "**/config/{dev,staging,prod}/**"
      purpose: "Environment-specific configs"
    - glob: "**/*.{dev,staging,prod}.*"
      purpose: "Environment-suffixed files"

knowledge_sources:
  specifications:
    - id: "12factor-parity"
      name: "12-Factor App: Factor X - Dev/Prod Parity"
      url: "https://12factor.net/dev-prod-parity"
      offline_cache: true
      priority: "required"

tooling:
  scripts:
    - id: "parity-audit"
      language: "bash"
      purpose: "Audit environment parity"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Environment Parity Audit ==="
        echo ""
        echo "=== Environment Directories ==="
        find . -type d \( -name "dev*" -o -name "staging*" -o -name "prod*" \) \
          -not -path "*/node_modules/*" 2>/dev/null | head -20
        echo ""
        echo "=== Environment-Specific Configs ==="
        find . -name "*.dev.*" -o -name "*.staging.*" -o -name "*.prod.*" \
          -not -path "*/node_modules/*" 2>/dev/null | head -30
        echo ""
        echo "=== Config Diff Opportunities ==="
        if [ -d "config/dev" ] && [ -d "config/prod" ]; then
          diff -rq config/dev config/prod 2>/dev/null | head -20
        fi

signals:
  critical:
    - id: "EPAR-CRIT-001"
      signal: "Significant environment configuration drift"
      evidence_indicators:
        - "Production configs differ substantially from staging"
        - "Different configuration structure across environments"
        - "Critical configs missing in some environments"
      explanation: |
        12-factor app requires keeping environments similar.
        Significant drift means testing in staging doesn't
        validate production behavior, increasing deployment risk.
      remediation: |
        - Audit and document environment differences
        - Eliminate unnecessary differences
        - Use same configuration templates
        - Implement environment parity checks
      cwe: "CWE-1059"

    - id: "EPAR-CRIT-002"
      signal: "Production-only configurations not tested"
      evidence_indicators:
        - "Configs exist only in production"
        - "No equivalent in staging/dev"
        - "Cannot test before production"
      explanation: |
        Production-only configurations cannot be tested
        before deployment, creating risk of untested
        behavior and potential outages.
      remediation: |
        - Create equivalent configs in non-prod
        - Enable testing of all prod configs
        - Maintain configuration parity
        - Document intentional differences

  high:
    - id: "EPAR-HIGH-001"
      signal: "Infrastructure configuration differs"
      evidence_indicators:
        - "Different instance types/sizes"
        - "Different network configurations"
        - "Different service versions"
      explanation: |
        Infrastructure differences create environment-specific
        behavior. Issues may appear only in production due
        to scaling or network differences.
      remediation: |
        - Align infrastructure configuration
        - Use parameterized infrastructure code
        - Document intentional differences
        - Test with prod-like infrastructure

    - id: "EPAR-HIGH-002"
      signal: "No environment parity verification"
      evidence_indicators:
        - "No automated parity checking"
        - "Manual review only"
        - "Drift discovered during incidents"
      explanation: |
        Without verification, parity degradation goes
        undetected. Automated checking ensures parity
        is maintained over time.
      remediation: |
        - Implement automated parity checks
        - Run checks in CI/CD
        - Alert on parity violations
        - Review differences regularly

    - id: "EPAR-HIGH-003"
      signal: "Third-party service versions differ"
      evidence_indicators:
        - "Different database versions"
        - "Different API versions in use"
        - "Different service configurations"
      explanation: |
        Third-party service differences can cause
        compatibility issues that only appear in
        production.
      remediation: |
        - Align third-party service versions
        - Use same configurations
        - Document required differences
        - Test version compatibility

  medium:
    - id: "EPAR-MED-001"
      signal: "Environment-specific overrides excessive"
      evidence_indicators:
        - "Many environment-specific configs"
        - "Override files larger than base"
        - "Difficult to understand effective config"
      explanation: |
        Excessive overrides complicate configuration
        understanding and increase error risk.
      remediation: |
        - Reduce environment-specific overrides
        - Use shared base configurations
        - Document override rationale
        - Review overrides regularly

    - id: "EPAR-MED-002"
      signal: "Parity not documented"
      evidence_indicators:
        - "No documented parity expectations"
        - "Intentional differences unclear"
        - "No parity guidelines"
      explanation: |
        Documentation clarifies expectations.
        Without it, teams may create unnecessary
        differences.
      remediation: |
        - Document parity expectations
        - List intentional differences
        - Create parity guidelines
        - Review documentation regularly

  low:
    - id: "EPAR-LOW-001"
      signal: "Environment naming inconsistent"
      evidence_indicators:
        - "Mix of dev/development/develop"
        - "Different naming conventions"
        - "Environment names unclear"
      explanation: |
        Consistent naming aids clarity. Inconsistent
        names cause confusion and potential errors.
      remediation: |
        - Standardize environment names
        - Use consistent conventions
        - Document naming standards
        - Migrate to standard names

  positive:
    - id: "EPAR-POS-001"
      signal: "Strong environment parity maintained"
      evidence_indicators:
        - "Environments configured consistently"
        - "Automated parity verification"
        - "Minimal intentional differences"

procedure:
  context:
    cognitive_mode: "methodical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Environment Configuration Inventory"
      description: "Inventory configuration files across environments."
      duration_estimate: "45 min"
      commands:
        - purpose: "Find environment-specific directories"
          command: |
            find . -type d \( -name "dev*" -o -name "staging*" -o -name "prod*" \
              -o -name "environments" \) -not -path "*/node_modules/*" 2>/dev/null | head -30
        - purpose: "List environment-specific config files"
          command: |
            find . \( -name "*.dev.*" -o -name "*.staging.*" -o -name "*.prod.*" \
              -o -path "*dev*" -o -path "*prod*" \) -name "*.yaml" \
              -not -path "*/node_modules/*" 2>/dev/null | head -50

    - id: "2"
      name: "Parity Analysis"
      description: "Compare configurations across environments."
      duration_estimate: "45 min"
      commands:
        - purpose: "Compare environment configs if structured"
          command: |
            for env_pair in "dev:prod" "staging:prod"; do
              env1=${env_pair%:*}
              env2=${env_pair#*:}
              echo "=== Comparing $env1 vs $env2 ==="
              find . -type d -name "$env1" 2>/dev/null | while read dir; do
                prod_dir="${dir/$env1/$env2}"
                if [ -d "$prod_dir" ]; then
                  diff -rq "$dir" "$prod_dir" 2>/dev/null | head -10
                fi
              done
            done

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Parity Assessment"
        - "Difference Analysis"
        - "Recommendations"
    - type: "parity_matrix"
      format: "table"
      description: "Environment configuration parity status"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "12factor-parity"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Parity audit requires thorough comparison"
    full:
      included: true
      priority: 1
    production:
      included: true
      priority: 1

closeout_checklist:
  - id: "epar-001"
    item: "Environment parity documented"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify parity expectations documented"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]
  compliance_frameworks:
    - framework: "12-Factor App"
      controls: ["Factor X"]

relationships:
  commonly_combined:
    - "configuration-management.environment-management.environment-promotion"
    - "configuration-management.configuration-verification.drift-detection"
