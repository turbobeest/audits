# ============================================================
# AUDIT: Feature Flag Targeting Rules
# Category: 30 - Configuration Management
# Subcategory: feature-flags
# ============================================================
# Configuration and management of feature flag targeting rules
# for controlled rollouts.
# ============================================================

audit:
  id: "configuration-management.feature-flags.targeting-rules"
  name: "Feature Flag Targeting Rules Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "feature-flags"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h
  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "infrastructure"
  default_profiles: ["full", "production"]

description:
  what: |
    This audit examines feature flag targeting rules used for controlled
    rollouts. It evaluates user targeting, percentage rollouts, segment
    targeting, and rule complexity.

  why_it_matters: |
    Targeting rules control who sees features. Complex or incorrect rules
    cause unexpected behavior. Proper targeting enables safe rollouts.
    Audit ensures rules work as intended.

  when_to_run:
    - "Before major feature rollouts"
    - "When targeting issues occur"
    - "During flag reviews"

discovery:
  code_patterns:
    - pattern: "(target|segment|percentage|rollout|variant)"
      type: "regex"
      scope: "config"
      purpose: "Detect targeting configuration"

  file_patterns:
    - glob: "**/*targeting*"
      purpose: "Targeting configurations"
    - glob: "**/*rollout*"
      purpose: "Rollout configurations"

signals:
  high:
    - id: "TRUL-HIGH-001"
      signal: "Targeting rules overly complex"
      evidence_indicators:
        - "Many nested conditions"
        - "Difficult to understand behavior"
        - "High error risk"
      explanation: "Complex rules are error-prone and hard to debug."
      remediation: "Simplify targeting rules."

    - id: "TRUL-HIGH-002"
      signal: "No fallback for targeting failures"
      evidence_indicators:
        - "Errors cause feature to fail"
        - "No default behavior"
        - "Exceptions not handled"
      explanation: "Targeting failures should fail gracefully."
      remediation: "Implement default behavior for targeting failures."

  medium:
    - id: "TRUL-MED-001"
      signal: "Targeting rules not versioned"
      evidence_indicators:
        - "No history of rule changes"
        - "Cannot audit past rules"
        - "No rollback capability"
      explanation: "Unversioned rules cannot be audited or rolled back."
      remediation: "Version control targeting rules."

    - id: "TRUL-MED-002"
      signal: "PII used in targeting"
      evidence_indicators:
        - "Email addresses in rules"
        - "Names used for targeting"
        - "Sensitive data in conditions"
      explanation: "PII in targeting creates privacy concerns."
      remediation: "Use IDs or segments instead of PII."

  low:
    - id: "TRUL-LOW-001"
      signal: "Targeting rules not documented"
      evidence_indicators:
        - "No explanation for rules"
        - "Purpose unclear"
        - "Conditions unexplained"
      explanation: "Undocumented rules are hard to maintain."
      remediation: "Document targeting rule purpose and logic."

procedure:
  steps:
    - id: "1"
      name: "Targeting Rule Review"
      description: "Review feature flag targeting rules."
      commands:
        - purpose: "Find targeting configurations"
          command: |
            grep -rn "target\|segment\|percentage" \
              --include="*flag*" --include="*feature*" . 2>/dev/null | head -30
        - purpose: "Check for PII in targeting"
          command: |
            grep -rn "@\|email\|name" --include="*flag*" . 2>/dev/null | head -20

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"

profiles:
  membership:
    full: {included: true, priority: 2}
    production: {included: true, priority: 2}

governance:
  applicable_to:
    archetypes: ["all"]
