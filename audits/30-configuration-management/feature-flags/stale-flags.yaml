# ============================================================
# AUDIT: Stale Feature Flags
# Category: 30 - Configuration Management
# Subcategory: feature-flags
# ============================================================
# Detection and cleanup of stale feature flags that should be
# removed from the codebase.
# ============================================================

audit:
  id: "configuration-management.feature-flags.stale-flags"
  name: "Stale Feature Flags Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "feature-flags"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h
  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "codebase"
  default_profiles: ["full", "production"]

description:
  what: |
    This audit identifies stale feature flags that are no longer needed.
    It evaluates flags past their expiration, flags always on/off,
    and orphaned flags with no references.

  why_it_matters: |
    Stale flags create code complexity and maintenance burden. Flags that
    are always on/off serve no purpose. Orphaned flags cause confusion.
    Cleaning up stale flags improves code quality and reduces risk.

  when_to_run:
    - "During technical debt sprints"
    - "Quarterly flag reviews"
    - "When code complexity is high"

discovery:
signals:
  high:
    - id: "SFLG-HIGH-001"
      signal: "Flags permanently enabled for all users"
      evidence_indicators:
        - "Flag at 100% rollout for months"
        - "No plans to remove"
        - "Code branches never used"
      explanation: "Permanently on flags add dead code complexity."
      remediation: "Remove flag and dead code branch."

    - id: "SFLG-HIGH-002"
      signal: "Flags past expiration date"
      evidence_indicators:
        - "Expiration date passed"
        - "Flag still in use"
        - "No extension documented"
      explanation: "Expired flags should have been cleaned up."
      remediation: "Review and remove or extend expired flags."

    - id: "SFLG-HIGH-003"
      signal: "Orphaned flags with no code references"
      evidence_indicators:
        - "Flags defined but not used"
        - "Code deleted but flag remains"
        - "No references in codebase"
      explanation: "Orphaned flags are pure clutter."
      remediation: "Remove orphaned flags immediately."

  medium:
    - id: "SFLG-MED-001"
      signal: "High number of feature flags"
      evidence_indicators:
        - "More than 50 active flags"
        - "Cognitive complexity from flags"
        - "Difficult to understand state"
      explanation: "Too many flags create complexity."
      remediation: "Audit and reduce flag count."

    - id: "SFLG-MED-002"
      signal: "Long-lived flags without review"
      evidence_indicators:
        - "Flags older than 6 months"
        - "No recent activity"
        - "Never reviewed"
      explanation: "Old flags should be reviewed for retirement."
      remediation: "Review all flags older than 6 months."

procedure:
  steps:
    - id: "1"
      name: "Stale Flag Detection"
      description: "Identify potentially stale flags."
      commands:
        - purpose: "Count feature flag references"
          command: |
            grep -rho "isEnabled(['\"][^'\"]+['\"])" \
              --include="*.js" --include="*.ts" . 2>/dev/null | sort | uniq -c | sort -rn | head -30
        - purpose: "Find flags with full rollout"
          command: |
            grep -rn "100%\|enabled.*true" --include="*flag*" --include="*feature*" . 2>/dev/null | head -20

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
    - type: "stale_flag_list"
      format: "table"
      description: "List of stale flags for cleanup"

profiles:
  membership:
    full: {included: true, priority: 2}
    production: {included: true, priority: 2}

governance:
  applicable_to:
    archetypes: ["all"]
