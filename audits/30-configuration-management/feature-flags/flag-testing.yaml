# ============================================================
# AUDIT: Feature Flag Testing
# Category: 30 - Configuration Management
# Subcategory: feature-flags
# ============================================================
# Testing practices for feature flagged code ensuring both
# code paths are validated.
# ============================================================

audit:
  id: "configuration-management.feature-flags.flag-testing"
  name: "Feature Flag Testing Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "feature-flags"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h
  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"
  default_profiles: ["full", "production"]

description:
  what: |
    This audit examines testing practices for feature flagged code.
    It evaluates whether both flag states are tested, flag mocking
    approaches, and integration testing with flags.

  why_it_matters: |
    Feature flags create multiple code paths that must all be tested.
    Untested flag states cause production bugs. Testing both states
    ensures functionality regardless of flag configuration.

  when_to_run:
    - "When adding feature flags"
    - "During test coverage reviews"
    - "Before flag rollouts"

discovery:
  code_patterns:
    - pattern: "(mock|stub).*(flag|feature|toggle)"
      type: "regex"
      scope: "source"
      purpose: "Detect flag mocking in tests"

  file_patterns:
    - glob: "**/*.test.*"
      purpose: "Test files"
    - glob: "**/*.spec.*"
      purpose: "Spec files"

signals:
  high:
    - id: "FTST-HIGH-001"
      signal: "Feature flag code paths not tested"
      evidence_indicators:
        - "Only one flag state tested"
        - "No tests for disabled state"
        - "Coverage gaps in flag branches"
      explanation: "Untested flag states may contain bugs."
      remediation: "Test both enabled and disabled states for all flags."

    - id: "FTST-HIGH-002"
      signal: "No flag state verification in tests"
      evidence_indicators:
        - "Tests don't verify flag state"
        - "Assume production flag state"
        - "No explicit flag control"
      explanation: "Tests should explicitly control flag state."
      remediation: "Explicitly set and verify flag states in tests."

  medium:
    - id: "FTST-MED-001"
      signal: "Flag mocking inconsistent"
      evidence_indicators:
        - "Different mocking approaches"
        - "Hard to mock flags"
        - "No standard pattern"
      explanation: "Inconsistent mocking makes testing difficult."
      remediation: "Standardize flag mocking approach."

    - id: "FTST-MED-002"
      signal: "No integration tests with flags"
      evidence_indicators:
        - "Unit tests only"
        - "No E2E with flags"
        - "Integration behavior not verified"
      explanation: "Integration testing verifies real flag behavior."
      remediation: "Add integration tests for flagged features."

procedure:
  steps:
    - id: "1"
      name: "Flag Testing Coverage"
      description: "Assess test coverage for flagged code."
      commands:
        - purpose: "Find flag-related tests"
          command: |
            grep -rn "flag\|feature\|toggle" --include="*.test.*" --include="*.spec.*" \
              . 2>/dev/null | head -40
        - purpose: "Find flag mocking patterns"
          command: |
            grep -rn "mock.*flag\|stub.*feature" --include="*.test.*" --include="*.spec.*" \
              . 2>/dev/null | head -20

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"

profiles:
  membership:
    full: {included: true, priority: 2}
    production: {included: true, priority: 2}

governance:
  applicable_to:
    archetypes: ["all"]
