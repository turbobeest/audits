# ============================================================
# AUDIT: Feature Flag Monitoring
# Category: 30 - Configuration Management
# Subcategory: feature-flags
# ============================================================
# Monitoring and observability for feature flags and their
# impact on system behavior.
# ============================================================

audit:
  id: "configuration-management.feature-flags.flag-monitoring"
  name: "Feature Flag Monitoring Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "feature-flags"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h
  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "infrastructure"
  default_profiles: ["full", "production"]

description:
  what: |
    This audit examines monitoring and observability for feature flags.
    It evaluates flag evaluation metrics, impact monitoring, error tracking,
    and performance monitoring for flagged features.

  why_it_matters: |
    Monitoring enables understanding flag impact. Without monitoring,
    flag-related issues go undetected. Metrics help decide when to
    fully roll out or roll back flagged features.

  when_to_run:
    - "When implementing flag platforms"
    - "During observability improvements"
    - "When flag issues are suspected"

discovery:
  code_patterns:
    - pattern: "(flag[-_]metric|flag[-_]evaluation|flag[-_]track)"
      type: "regex"
      scope: "config"
      purpose: "Detect flag monitoring"

  file_patterns:
    - glob: "**/monitoring/**"
      purpose: "Monitoring configurations"
    - glob: "**/dashboards/**"
      purpose: "Dashboard definitions"

signals:
  high:
    - id: "FMON-HIGH-001"
      signal: "No monitoring for flag-related errors"
      evidence_indicators:
        - "Errors in flagged code not tracked"
        - "No correlation with flag state"
        - "Cannot detect flag-caused issues"
      explanation: "Unmonitored errors in flagged code go undetected."
      remediation: "Track errors by flag state."

    - id: "FMON-HIGH-002"
      signal: "Flag evaluation failures not monitored"
      evidence_indicators:
        - "SDK errors not tracked"
        - "Evaluation timeouts undetected"
        - "Fallback usage unknown"
      explanation: "Flag evaluation failures affect user experience."
      remediation: "Monitor flag evaluation health."

  medium:
    - id: "FMON-MED-001"
      signal: "No flag impact metrics"
      evidence_indicators:
        - "Cannot measure feature impact"
        - "No A/B metrics"
        - "No comparison between states"
      explanation: "Impact metrics inform rollout decisions."
      remediation: "Implement flag impact metrics."

    - id: "FMON-MED-002"
      signal: "No flag evaluation metrics"
      evidence_indicators:
        - "Evaluation count unknown"
        - "No latency metrics"
        - "Usage patterns unclear"
      explanation: "Evaluation metrics help understand flag usage."
      remediation: "Track flag evaluation metrics."

  low:
    - id: "FMON-LOW-001"
      signal: "No flag dashboards"
      evidence_indicators:
        - "No visibility into flag state"
        - "No central flag view"
        - "Hard to see flag status"
      explanation: "Dashboards provide flag visibility."
      remediation: "Create flag monitoring dashboards."

procedure:
  steps:
    - id: "1"
      name: "Flag Monitoring Assessment"
      description: "Assess feature flag monitoring."
      commands:
        - purpose: "Find flag-related monitoring"
          command: |
            grep -rn "flag.*metric\|flag.*monitor" \
              --include="*.yaml" --include="*.json" . 2>/dev/null | head -20
        - purpose: "Check for flag dashboards"
          command: |
            find . -name "*dashboard*" -exec grep -l "flag\|feature" {} \; 2>/dev/null | head -10

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"

profiles:
  membership:
    full: {included: true, priority: 2}
    production: {included: true, priority: 2}

governance:
  applicable_to:
    archetypes: ["all"]
