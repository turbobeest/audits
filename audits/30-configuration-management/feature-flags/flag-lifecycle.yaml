# ============================================================
# AUDIT: Feature Flag Lifecycle
# Category: 30 - Configuration Management
# Subcategory: feature-flags
# ============================================================
# Management of feature flags through their complete lifecycle
# from creation to retirement.
# ============================================================

audit:
  id: "configuration-management.feature-flags.flag-lifecycle"
  name: "Feature Flag Lifecycle Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "feature-flags"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h
  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "codebase"
  default_profiles: ["full", "production"]

description:
  what: |
    This audit examines feature flag lifecycle management from creation
    through retirement. It evaluates flag documentation, ownership,
    expiration policies, and cleanup processes.

  why_it_matters: |
    Unmanaged feature flags accumulate technical debt. Old flags create
    confusion and code complexity. Proper lifecycle management keeps flags
    purposeful and temporary, not permanent code clutter.

  when_to_run:
    - "During technical debt assessment"
    - "When flag count is high"
    - "Quarterly flag reviews"

discovery:
  code_patterns:
    - pattern: "(feature[-_]flag|feature[-_]toggle|isEnabled|isFeatureEnabled)"
      type: "regex"
      scope: "source"
      purpose: "Detect feature flag usage"

    - pattern: "(launchdarkly|unleash|split|flagsmith|flipper)"
      type: "regex"
      scope: "config"
      purpose: "Detect feature flag platforms"

  file_patterns:
    - glob: "**/*feature*flag*"
      purpose: "Feature flag configurations"
    - glob: "**/*toggle*"
      purpose: "Toggle configurations"

signals:
  high:
    - id: "FLFC-HIGH-001"
      signal: "Feature flags without expiration"
      evidence_indicators:
        - "No expiration date on flags"
        - "Flags intended as permanent"
        - "No retirement plan"
      explanation: "Flags without expiration become permanent tech debt."
      remediation: "Require expiration dates for all feature flags."

    - id: "FLFC-HIGH-002"
      signal: "Flag ownership not assigned"
      evidence_indicators:
        - "No owner for flags"
        - "Orphaned flags"
        - "No accountability for cleanup"
      explanation: "Unowned flags never get cleaned up."
      remediation: "Assign ownership to all feature flags."

    - id: "FLFC-HIGH-003"
      signal: "No flag documentation"
      evidence_indicators:
        - "Flags without descriptions"
        - "Purpose unclear"
        - "No context for decisions"
      explanation: "Undocumented flags create confusion."
      remediation: "Document purpose and criteria for each flag."

  medium:
    - id: "FLFC-MED-001"
      signal: "No flag review process"
      evidence_indicators:
        - "Flags never reviewed"
        - "No periodic cleanup"
        - "Flags accumulate indefinitely"
      explanation: "Without review, flags accumulate."
      remediation: "Implement periodic flag review process."

    - id: "FLFC-MED-002"
      signal: "Flag creation process informal"
      evidence_indicators:
        - "Anyone can create flags"
        - "No approval for new flags"
        - "Duplicates created"
      explanation: "Informal creation leads to proliferation."
      remediation: "Establish flag creation process with approval."

  low:
    - id: "FLFC-LOW-001"
      signal: "Flag naming inconsistent"
      evidence_indicators:
        - "Mixed naming conventions"
        - "Unclear flag names"
        - "No naming standard"
      explanation: "Inconsistent naming creates confusion."
      remediation: "Establish and enforce naming conventions."

procedure:
  steps:
    - id: "1"
      name: "Flag Inventory"
      description: "Inventory feature flags in codebase."
      commands:
        - purpose: "Find feature flag usage"
          command: |
            grep -rn "isEnabled\|feature.*flag\|toggle" \
              --include="*.js" --include="*.ts" --include="*.py" . 2>/dev/null | head -50
        - purpose: "Find flag configurations"
          command: |
            find . -name "*feature*flag*" -o -name "*toggle*" 2>/dev/null | head -20

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
    - type: "flag_inventory"
      format: "table"
      description: "Inventory of feature flags"

profiles:
  membership:
    full: {included: true, priority: 2}
    production: {included: true, priority: 2}

governance:
  applicable_to:
    archetypes: ["all"]
