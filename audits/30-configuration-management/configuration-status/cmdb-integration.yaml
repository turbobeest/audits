# ============================================================
# AUDIT: CMDB Integration
# Category: 30 - Configuration Management
# Subcategory: configuration-status
# ============================================================
# Integration of configuration data with Configuration Management
# Database for unified visibility and management.
# ============================================================

audit:
  id: "configuration-management.configuration-status.cmdb-integration"
  name: "CMDB Integration Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "configuration-status"

  tier: "expert"
  estimated_duration: "3-4 hours"  # median: 3h

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "infrastructure"

  default_profiles:
    - "full"
    - "production"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit examines integration of configuration data with Configuration
    Management Database systems. It evaluates:
    - CMDB data population and accuracy
    - Automated discovery and synchronization
    - CI relationship mapping in CMDB
    - Data quality and completeness
    - CMDB integration with change management
    - Federation with external configuration sources
    - CMDB accessibility and usability

  why_it_matters: |
    CMDB integration provides unified configuration visibility:
    - ITIL requires CMDB as authoritative source for CI information
    - Integrated CMDB enables impact analysis for changes
    - Siloed configuration data prevents unified management
    - Automated population ensures data accuracy
    - Relationship mapping supports dependency analysis
    - CMDB supports incident and problem management

  when_to_run:
    - "When implementing or upgrading CMDB"
    - "During ITIL maturity assessments"
    - "When data quality issues are reported"
    - "During configuration management audits"
    - "Quarterly CMDB reviews"

prerequisites:
  required_artifacts:
    - type: "cmdb"
      description: "Configuration Management Database"
    - type: "documentation"
      description: "CMDB policies and procedures"

  access_requirements:
    - "Access to CMDB system"
    - "Access to configuration sources"
    - "Access to discovery tools"

discovery:
  code_patterns:
    - pattern: "(cmdb|servicenow|service[-_]now|asset[-_]management)"
      type: "regex"
      scope: "config"
      purpose: "Detect CMDB integrations"

    - pattern: "(discovery|sync|import)[-_](ci|config|asset)"
      type: "regex"
      scope: "config"
      purpose: "Detect discovery/sync configurations"

  file_patterns:
    - glob: "**/cmdb/**"
      purpose: "CMDB configurations"
    - glob: "**/servicenow/**"
      purpose: "ServiceNow integrations"
    - glob: "**/discovery/**"
      purpose: "Discovery configurations"

knowledge_sources:
  specifications:
    - id: "itil-cmdb"
      name: "ITIL Configuration Management Database"
      url: "https://www.axelos.com/best-practice-solutions/itil"
      offline_cache: true
      priority: "required"

tooling:
  scripts:
    - id: "cmdb-integration-audit"
      language: "bash"
      purpose: "Audit CMDB integration"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== CMDB Integration Audit ==="
        echo ""
        echo "=== CMDB Integration Files ==="
        find . -type f \( -name "*cmdb*" -o -name "*servicenow*" -o -name "*discovery*" \) \
          -not -path "*/node_modules/*" 2>/dev/null | head -20
        echo ""
        echo "=== Inventory/Asset Files ==="
        find . -type f \( -name "*inventory*" -o -name "*asset*" \) \
          -not -path "*/node_modules/*" 2>/dev/null | head -20

signals:
  critical:
    - id: "CMDB-CRIT-001"
      signal: "No CMDB or configuration inventory"
      evidence_indicators:
        - "No centralized CI repository"
        - "Configuration data scattered"
        - "No single source of truth"
      explanation: |
        ITIL requires a CMDB as authoritative source for CI information.
        Without a CMDB, there is no unified view of configuration state,
        and impact analysis is not possible.
      remediation: |
        - Implement CMDB or configuration inventory
        - Define CI data model
        - Populate with existing configurations
        - Establish as authoritative source
      cwe: "CWE-1059"

  high:
    - id: "CMDB-HIGH-001"
      signal: "CMDB data not synchronized"
      evidence_indicators:
        - "CMDB data stale"
        - "Manual updates only"
        - "Reality differs from CMDB"
      explanation: |
        Unsynchronized CMDB provides incorrect information.
        Decisions based on stale data may be wrong, and
        impact analysis will be unreliable.
      remediation: |
        - Implement automated discovery
        - Schedule regular synchronization
        - Detect and alert on drift
        - Validate data accuracy

    - id: "CMDB-HIGH-002"
      signal: "CI relationships not mapped"
      evidence_indicators:
        - "No dependency information"
        - "Impact analysis not possible"
        - "Isolated CI records"
      explanation: |
        CI relationships enable impact analysis. Without
        relationships, changes cannot be assessed for
        effects on dependent configurations.
      remediation: |
        - Define relationship types
        - Map CI dependencies
        - Automate relationship discovery
        - Validate relationship accuracy

    - id: "CMDB-HIGH-003"
      signal: "CMDB not integrated with change management"
      evidence_indicators:
        - "Changes not linked to CMDB"
        - "CI not updated after changes"
        - "Separate systems not connected"
      explanation: |
        CMDB and change management should be integrated.
        Without integration, CMDB becomes stale and
        change impact cannot be assessed.
      remediation: |
        - Integrate CMDB with change management
        - Update CI after changes
        - Link changes to affected CIs
        - Automate CI updates

  medium:
    - id: "CMDB-MED-001"
      signal: "Discovery coverage incomplete"
      evidence_indicators:
        - "Not all config types discovered"
        - "Manual CI creation required"
        - "Discovery gaps"
      explanation: |
        Incomplete discovery leaves blind spots. CIs not
        discovered are not managed and may cause issues.
      remediation: |
        - Expand discovery coverage
        - Add discovery for all config types
        - Monitor discovery completeness
        - Address gaps promptly

    - id: "CMDB-MED-002"
      signal: "CMDB data quality issues"
      evidence_indicators:
        - "Missing attributes"
        - "Duplicate CIs"
        - "Inconsistent data"
      explanation: |
        Poor data quality undermines CMDB value. Decisions
        based on inaccurate data may be incorrect.
      remediation: |
        - Implement data quality checks
        - Detect and merge duplicates
        - Enforce attribute requirements
        - Regular data quality audits

  low:
    - id: "CMDB-LOW-001"
      signal: "CMDB access limited"
      evidence_indicators:
        - "Difficult to query CMDB"
        - "Limited self-service access"
        - "API not available"
      explanation: |
        Accessible CMDB increases value. Limited access
        reduces adoption and utility.
      remediation: |
        - Enable self-service access
        - Provide API access
        - Create user-friendly interfaces
        - Document access methods

  positive:
    - id: "CMDB-POS-001"
      signal: "Comprehensive CMDB with automation"
      evidence_indicators:
        - "All CIs in CMDB"
        - "Automated discovery and sync"
        - "Relationships mapped"

procedure:
  context:
    cognitive_mode: "methodical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "CMDB Existence Assessment"
      description: "Verify CMDB or configuration inventory exists."
      duration_estimate: "30 min"
      commands:
        - purpose: "Find CMDB-related configurations"
          command: |
            find . -type f \( -name "*cmdb*" -o -name "*inventory*" -o -name "*catalog*" \) \
              -not -path "*/node_modules/*" 2>/dev/null | head -30

    - id: "2"
      name: "Integration Assessment"
      description: "Assess CMDB integration with other systems."
      duration_estimate: "45 min"
      commands:
        - purpose: "Find integration configurations"
          command: |
            grep -rn "cmdb\|servicenow\|asset[-_]management" \
              --include="*.yaml" --include="*.json" . 2>/dev/null | head -30
        - purpose: "Check for discovery/sync configurations"
          command: |
            find . -type f \( -name "*discovery*" -o -name "*sync*" \) \
              -not -path "*/node_modules/*" 2>/dev/null | head -20

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "CMDB Assessment"
        - "Integration Analysis"
        - "Recommendations"

offline:
  capability: "partial"
  cache_manifest:
    knowledge:
      - source_id: "itil-cmdb"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "CMDB audit requires thorough review"
    full:
      included: true
      priority: 2
    production:
      included: true
      priority: 2

closeout_checklist:
  - id: "cmdb-001"
    item: "CMDB or configuration inventory exists"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify centralized CI repository exists"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]
  compliance_frameworks:
    - framework: "ITIL"
      controls: ["Configuration Management", "CMDB"]

relationships:
  commonly_combined:
    - "configuration-management.configuration-identification.config-discovery"
    - "configuration-management.configuration-status.change-tracking"
