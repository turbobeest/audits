# ============================================================
# AUDIT: Configuration Compliance Checking
# Category: 30 - Configuration Management
# Subcategory: configuration-verification
# ============================================================
# Verification of configurations against security policies and
# compliance requirements.
# ============================================================

audit:
  id: "configuration-management.configuration-verification.compliance-checking"
  name: "Configuration Compliance Checking Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "configuration-verification"

  tier: "expert"
  estimated_duration: "3-4 hours"  # median: 3h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "infrastructure"

  default_profiles:
    - "full"
    - "production"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit examines compliance checking mechanisms for configuration
    items against policies and standards. It evaluates:
    - Policy-as-code implementation
    - Compliance rule coverage
    - CIS benchmark conformance
    - Security best practice checking
    - Regulatory compliance verification
    - Compliance reporting and dashboards
    - Remediation guidance and automation

  why_it_matters: |
    Configuration compliance is essential for security and governance:
    - Non-compliant configurations create security vulnerabilities
    - Regulatory frameworks require demonstrable compliance
    - CIS benchmarks provide industry-standard baselines
    - Policy-as-code enables consistent enforcement
    - Compliance checking prevents misconfigurations reaching production
    - Audit readiness requires continuous compliance monitoring

  when_to_run:
    - "During compliance audits"
    - "When implementing policy-as-code"
    - "After security incidents"
    - "When adding new compliance requirements"
    - "Regular security assessments"

prerequisites:
  required_artifacts:
    - type: "policies"
      description: "Security policies and compliance rules"
    - type: "infrastructure_code"
      description: "IaC for compliance checking"

  access_requirements:
    - "Access to policy definitions"
    - "Access to compliance checking tools"
    - "Read access to configurations"

discovery:
  code_patterns:
    - pattern: "(policy|compliance|benchmark|opa|conftest|sentinel)"
      type: "regex"
      scope: "config"
      purpose: "Detect policy-as-code tools"

    - pattern: "(cis|stig|pci|hipaa|soc2)[-_](benchmark|compliance)"
      type: "regex"
      scope: "config"
      purpose: "Detect compliance standards"

  file_patterns:
    - glob: "**/policies/**"
      purpose: "Policy definitions"
    - glob: "**/*.rego"
      purpose: "OPA Rego policies"
    - glob: "**/*sentinel*"
      purpose: "Sentinel policies"
    - glob: "**/checkov*"
      purpose: "Checkov configurations"

knowledge_sources:
  specifications:
    - id: "cis-benchmarks"
      name: "CIS Benchmarks"
      url: "https://www.cisecurity.org/cis-benchmarks"
      offline_cache: true
      priority: "required"

    - id: "nist-800-53"
      name: "NIST 800-53"
      url: "https://csrc.nist.gov/pubs/sp/800/53/r5/upd1/final"
      offline_cache: true
      priority: "required"

  guides:
    - id: "opa-policies"
      name: "Open Policy Agent"
      url: "https://www.openpolicyagent.org/docs/latest/"
      offline_cache: true

    - id: "checkov"
      name: "Checkov Documentation"
      url: "https://www.checkov.io/1.Welcome/What%20is%20Checkov.html"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "checkov"
      purpose: "Infrastructure security scanning"
      offline_capable: true

    - tool: "tfsec"
      purpose: "Terraform security scanning"
      offline_capable: true

    - tool: "conftest"
      purpose: "OPA policy testing"
      offline_capable: true

  scripts:
    - id: "compliance-audit"
      language: "bash"
      purpose: "Audit compliance checking"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Compliance Checking Audit ==="
        echo ""
        echo "=== Policy Files ==="
        find . -name "*.rego" -o -name "*policy*.yaml" -o -name "*sentinel*" \
          -not -path "*/node_modules/*" 2>/dev/null | head -30
        echo ""
        echo "=== Security Scanner Configs ==="
        find . -name ".checkov*" -o -name ".tfsec*" -o -name "*trivy*" \
          -not -path "*/node_modules/*" 2>/dev/null | head -20
        echo ""
        echo "=== Compliance in CI/CD ==="
        grep -rn "checkov\|tfsec\|conftest\|security" \
          --include="*.yaml" .github/workflows/ 2>/dev/null | head -30

signals:
  critical:
    - id: "CCMP-CRIT-001"
      signal: "No compliance checking for configurations"
      evidence_indicators:
        - "No policy-as-code"
        - "No security scanning"
        - "Configs not checked against standards"
      explanation: |
        Without compliance checking, misconfigurations creating
        security vulnerabilities are not detected. This exposes
        systems to attacks and compliance failures.
      remediation: |
        - Implement policy-as-code
        - Add security scanning (Checkov, tfsec)
        - Define compliance baselines
        - Integrate in CI/CD
      cwe: "CWE-16"

    - id: "CCMP-CRIT-002"
      signal: "Known compliance violations not remediated"
      evidence_indicators:
        - "Violations detected but ignored"
        - "Exceptions without justification"
        - "Security findings unaddressed"
      explanation: |
        Known violations that are not remediated represent
        accepted risk. This may violate compliance requirements
        and creates ongoing vulnerability exposure.
      remediation: |
        - Remediate all high/critical violations
        - Document exceptions with justification
        - Track violation remediation
        - Reduce violation backlog

  high:
    - id: "CCMP-HIGH-001"
      signal: "Compliance checking not automated"
      evidence_indicators:
        - "Manual compliance reviews only"
        - "No CI/CD integration"
        - "Periodic manual audits"
      explanation: |
        Manual compliance checking is slow and inconsistent.
        Automated checking ensures continuous enforcement
        and catches violations before deployment.
      remediation: |
        - Automate compliance checking
        - Integrate in CI/CD pipeline
        - Block deployment on violations
        - Schedule regular scans

    - id: "CCMP-HIGH-002"
      signal: "Compliance rules incomplete"
      evidence_indicators:
        - "Limited rule coverage"
        - "Critical areas not covered"
        - "Custom requirements not implemented"
      explanation: |
        Incomplete rules leave blind spots. All relevant
        compliance requirements should be codified and
        checked automatically.
      remediation: |
        - Expand compliance rule coverage
        - Add custom organization rules
        - Map to regulatory requirements
        - Regular rule review and update

    - id: "CCMP-HIGH-003"
      signal: "CIS benchmarks not implemented"
      evidence_indicators:
        - "No CIS benchmark checking"
        - "Industry standards not applied"
        - "Security baselines undefined"
      explanation: |
        CIS benchmarks provide proven security baselines.
        Not implementing them misses industry best practices
        and may not meet compliance requirements.
      remediation: |
        - Implement CIS benchmark checking
        - Apply relevant benchmarks by platform
        - Track benchmark compliance scores
        - Remediate benchmark violations

  medium:
    - id: "CCMP-MED-001"
      signal: "Compliance reporting limited"
      evidence_indicators:
        - "No compliance dashboards"
        - "Manual compliance reporting"
        - "Stakeholders lack visibility"
      explanation: |
        Compliance reporting enables oversight. Without
        reporting, compliance status is unclear and
        audits require manual investigation.
      remediation: |
        - Create compliance dashboards
        - Automate compliance reporting
        - Share with stakeholders
        - Track compliance trends

    - id: "CCMP-MED-002"
      signal: "No remediation guidance provided"
      evidence_indicators:
        - "Violations without fix suggestions"
        - "No auto-remediation"
        - "Manual research for fixes"
      explanation: |
        Remediation guidance speeds resolution. Without
        guidance, engineers must research fixes, slowing
        compliance improvement.
      remediation: |
        - Include remediation in violation reports
        - Provide fix examples
        - Implement auto-remediation where safe
        - Link to documentation

  low:
    - id: "CCMP-LOW-001"
      signal: "Compliance scan results not retained"
      evidence_indicators:
        - "No historical compliance data"
        - "Cannot track trends"
        - "No audit trail for compliance"
      explanation: |
        Historical data enables trend analysis. Without
        it, improvement cannot be measured and audit
        evidence may be unavailable.
      remediation: |
        - Retain compliance scan results
        - Track compliance trends
        - Maintain audit trail
        - Report on improvements

  positive:
    - id: "CCMP-POS-001"
      signal: "Comprehensive policy-as-code implementation"
      evidence_indicators:
        - "Complete compliance rule coverage"
        - "CI/CD enforcement"
        - "Automated remediation guidance"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Policy-as-Code Assessment"
      description: "Assess policy-as-code implementation."
      duration_estimate: "45 min"
      commands:
        - purpose: "Find policy files"
          command: |
            find . \( -name "*.rego" -o -name "*policy*" -o -name "*sentinel*" \) \
              -not -path "*/node_modules/*" 2>/dev/null | head -30
        - purpose: "Find security scanner configurations"
          command: |
            find . \( -name ".checkov*" -o -name ".tfsec*" -o -name ".trivy*" \) \
              2>/dev/null | head -20

    - id: "2"
      name: "CI/CD Integration Review"
      description: "Review compliance checking in CI/CD."
      duration_estimate: "30 min"
      commands:
        - purpose: "Check for compliance tools in CI"
          command: |
            grep -rn "checkov\|tfsec\|conftest\|trivy\|snyk" \
              --include="*.yaml" .github/workflows/ 2>/dev/null | head -30

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Compliance Coverage"
        - "Violation Analysis"
        - "Recommendations"

offline:
  capability: "partial"
  cache_manifest:
    knowledge:
      - source_id: "cis-benchmarks"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Compliance audit requires thorough review"
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1
    production:
      included: true
      priority: 1

closeout_checklist:
  - id: "ccmp-001"
    item: "Compliance checking implemented"
    level: "CRITICAL"
    verification: |
      find . \( -name "*.rego" -o -name ".checkov*" -o -name ".tfsec*" \) \
        -not -path "*/node_modules/*" 2>/dev/null | wc -l | \
        xargs -I{} test {} -gt 0 && echo "PASS" || echo "FAIL"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["all"]
  compliance_frameworks:
    - framework: "CIS"
      controls: ["All applicable benchmarks"]
    - framework: "SOC 2"
      controls: ["CC6.1", "CC7.1"]
    - framework: "PCI-DSS"
      controls: ["2.2"]
    - framework: "ISO 27001"
      controls: ["A.8.9"]

relationships:
  commonly_combined:
    - "configuration-management.configuration-verification.drift-detection"
    - "security-trust.vulnerability-management.infrastructure-scanning"
