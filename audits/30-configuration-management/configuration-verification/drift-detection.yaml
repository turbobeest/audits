audit:
  id: configuration-management.configuration-verification.drift-detection
  name: Configuration Drift Detection Audit
  version: 1.0.0
  last_updated: '2025-01-22'
  status: active
  category: configuration-management
  category_number: 30
  subcategory: configuration-verification
  tier: phd
  estimated_duration: 3-4 hours  # median: 3h
  completeness: complete
  requires_runtime: true
  destructive: false
execution:
  automatable: full
  severity: high
  scope: infrastructure
  default_profiles:
  - full
  - production
  blocks_phase: false
  parallelizable: true
description:
  what: |
    This audit examines the capabilities for detecting configuration drift
    from desired state. It evaluates:
    - Drift detection mechanisms and tools
    - Baseline comparison capabilities
    - Real-time vs scheduled drift detection
    - Drift alerting and notification
    - Drift categorization and prioritization
    - Drift remediation automation
    - Drift trend analysis
  why_it_matters: |
    Configuration drift undermines system reliability and security:
    - CMMI CM SP 3.2 requires verifying CI integrity
    - Drift represents unauthorized or untracked changes
    - Security misconfigurations often result from drift
    - Compliance violations may go undetected without drift detection
    - GitOps principles require reconciliation with desired state
    - Drift accumulation increases incident risk
    - 12-factor app immutability prevents drift by design
  when_to_run:
  - When implementing GitOps or IaC
  - After production incidents
  - During compliance audits
  - When drift is suspected
  - Regular operational reviews
prerequisites:
  required_artifacts:
  - type: infrastructure_code
    description: Infrastructure as Code defining desired state
  - type: runtime_access
    description: Access to compare actual vs desired state
  access_requirements:
  - Read access to infrastructure state
  - Access to IaC repositories
  - Access to configuration management tools
discovery:
  code_patterns:
  - pattern: (drift|reconcile|sync|converge)[-_](detect|check|status)
    type: regex
    scope: config
    purpose: Detect drift detection configuration
  - pattern: (terraform\s+plan|terraform\s+apply|pulumi\s+preview)
    type: regex
    scope: scripts
    purpose: Detect IaC drift commands
  - pattern: (argocd|flux|gitops|reconcil)
    type: regex
    scope: config
    purpose: Detect GitOps tools
  file_patterns:
  - glob: '**/terraform/**/*.tf'
    purpose: Terraform configurations
  - glob: '**/argocd/**'
    purpose: ArgoCD configurations
  - glob: '**/flux/**'
    purpose: Flux configurations
knowledge_sources:
  specifications:
  - id: cmmi-cm-sp32
    name: CMMI CM SP 3.2 - Perform Configuration Audits
    url: https://cmmiinstitute.com/cmmi
    offline_cache: true
    priority: required
  - id: gitops-principles
    name: GitOps Principles
    url: https://www.gitops.tech/
    offline_cache: true
    priority: required
  guides:
  - id: terraform-drift
    name: Terraform Drift Detection
    url: https://developer.hashicorp.com/terraform/tutorials/state/resource-drift
    offline_cache: true
  - id: argocd-sync
    name: ArgoCD Application Sync
    url: https://argo-cd.readthedocs.io/en/stable/user-guide/sync-options/
    offline_cache: true
tooling:
  infrastructure_tools:
  - tool: terraform
    purpose: Infrastructure drift detection
    command: terraform plan -detailed-exitcode
  - tool: argocd
    purpose: Kubernetes drift detection
    command: argocd app diff APP_NAME
  - tool: aws-config
    purpose: AWS configuration compliance
    command: aws configservice get-compliance-details-by-config-rule
  scripts:
  - id: drift-detection-audit
    language: bash
    purpose: Audit drift detection capabilities
    source: inline
    code: |
      #!/bin/bash
      echo "=== Drift Detection Audit ==="
      echo ""
      echo "=== GitOps Tool Configurations ==="
      find . -type f \( -name "*argocd*" -o -name "*flux*" -o -name "*gitops*" \) \
        -not -path "*/node_modules/*" 2>/dev/null | head -20
      echo ""
      echo "=== Terraform State Files ==="
      find . -name "*.tfstate" -not -path "*/.terraform/*" 2>/dev/null | head -10
      echo ""
      echo "=== Drift Detection Scripts ==="
      grep -rl "drift\|reconcile\|sync" --include="*.sh" --include="*.yaml" \
        . 2>/dev/null | head -20
signals:
  critical:
  - id: DRFT-CRIT-001
    signal: No drift detection capability
    evidence_indicators:
    - No mechanism to detect configuration changes
    - No comparison of actual vs desired state
    - Drift discovered only during incidents
    explanation: |
      Without drift detection, configurations can diverge from
      desired state without detection. This creates security
      vulnerabilities and compliance violations that accumulate
      until they cause incidents.
    remediation: |
      - Implement drift detection tooling
      - Schedule regular drift checks
      - Configure drift alerting
      - Integrate with GitOps workflow
    cwe: CWE-1059
  - id: DRFT-CRIT-002
    signal: Production drift not detected or remediated
    evidence_indicators:
    - Known drift in production
    - Drift detected but not addressed
    - Production diverged from IaC
    explanation: |
      Production drift creates risk of outages and security
      issues. Unaddressed drift accumulates, making systems
      unpredictable and potentially non-compliant.
    remediation: |
      - Remediate existing production drift
      - Implement automatic drift remediation
      - Prioritize production drift alerts
      - Prevent future drift through automation
  high:
  - id: DRFT-HIGH-001
    signal: Drift detection not automated
    evidence_indicators:
    - Manual drift checks only
    - No scheduled drift detection
    - Drift checked only on demand
    explanation: |
      Manual drift detection is unreliable and infrequent.
      Automated detection enables continuous monitoring
      and rapid response to unauthorized changes.
    remediation: |
      - Automate drift detection
      - Schedule regular drift checks
      - Implement continuous reconciliation
      - Use GitOps for automatic sync
  - id: DRFT-HIGH-002
    signal: Drift alerting not configured
    evidence_indicators:
    - Drift detected but not alerted
    - No notification on drift
    - Teams unaware of drift
    explanation: |
      Detected drift without alerting is nearly useless.
      Teams must be notified promptly to address drift
      before it causes issues.
    remediation: |
      - Configure drift alerting
      - Route alerts to responsible teams
      - Set appropriate thresholds
      - Include drift details in alerts
  - id: DRFT-HIGH-003
    signal: Security configuration drift not prioritized
    evidence_indicators:
    - Security drift treated same as other drift
    - No fast-track for security drift
    - Security misconfigurations persist
    explanation: |
      Security configuration drift creates vulnerabilities.
      Security-related drift should be prioritized and
      remediated urgently.
    remediation: |
      - Classify drift by type
      - Prioritize security drift
      - Implement urgent remediation for security
      - Monitor security config compliance
  medium:
  - id: DRFT-MED-001
    signal: Drift remediation manual
    evidence_indicators:
    - No automatic drift correction
    - Manual apply after drift detection
    - Remediation delays
    explanation: |
      Manual remediation introduces delays. Automated
      remediation ensures rapid return to desired state.
    remediation: |
      - Implement auto-remediation for safe changes
      - Use GitOps auto-sync
      - Require approval for risky remediations
      - Reduce manual intervention
  - id: DRFT-MED-002
    signal: Drift trends not analyzed
    evidence_indicators:
    - No drift metrics
    - Cannot identify drift patterns
    - Recurring drift not addressed
    explanation: |
      Drift trends reveal systemic issues. Recurring drift
      indicates process or tooling problems that should
      be addressed at the root cause.
    remediation: |
      - Track drift metrics
      - Analyze drift patterns
      - Address root causes
      - Measure drift reduction
  - id: DRFT-MED-003
    signal: Not all configuration types covered
    evidence_indicators:
    - Some configs excluded from drift detection
    - Partial coverage only
    - Manual configs not monitored
    explanation: |
      Incomplete coverage leaves blind spots. All
      configurations should be monitored for drift.
    remediation: |
      - Expand drift detection coverage
      - Include all config types
      - Monitor manual configurations
      - Document coverage gaps
  low:
  - id: DRFT-LOW-001
    signal: Drift detection results not retained
    evidence_indicators:
    - No drift history
    - Past drift not queryable
    - Cannot review drift patterns
    explanation: |
      Drift history enables trend analysis. Without
      history, patterns cannot be identified.
    remediation: |
      - Retain drift detection results
      - Enable historical analysis
      - Keep drift audit trail
      - Report on drift trends
  positive:
  - id: DRFT-POS-001
    signal: Comprehensive automated drift detection
    evidence_indicators:
    - All configs monitored
    - Automatic detection and alerting
    - Auto-remediation for safe changes
  - id: DRFT-POS-002
    signal: GitOps with continuous reconciliation
    evidence_indicators:
    - GitOps tools in use
    - Desired state in Git
    - Automatic sync to desired state
procedure:
  context:
    cognitive_mode: methodical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Drift Detection Tooling Assessment
    description: Assess drift detection tools and capabilities.
    duration_estimate: 45 min
    commands:
    - purpose: Find GitOps configurations
      command: |
        find . -type f \( -name "*argocd*" -o -name "*flux*" \
          -o -name "*gitops*" \) -not -path "*/node_modules/*" 2>/dev/null | head -30
    - purpose: Check for Terraform state
      command: |
        find . -name "*.tfstate" -not -path "*/.terraform/*" 2>/dev/null | head -10
    - purpose: Find drift detection scripts
      command: |
        grep -rn "terraform plan\|drift\|reconcile" \
          --include="*.sh" --include="*.yaml" . 2>/dev/null | head -30
  - id: '2'
    name: Drift Alerting Configuration
    description: Verify drift alerting is configured.
    duration_estimate: 30 min
    commands:
    - purpose: Check for drift alerts
      command: |
        grep -rn "drift\|out.of.sync\|diverged" \
          --include="*alert*" --include="*.yaml" . 2>/dev/null | head -20
    - purpose: Find notification configurations
      command: |
        grep -rn "slack\|pagerduty\|email" --include="*.yaml" \
          . 2>/dev/null | head -20
  - id: '3'
    name: Coverage Assessment
    description: Assess drift detection coverage.
    duration_estimate: 30 min
    commands:
    - purpose: List IaC managed resources
      command: |
        grep -rn "resource\s" --include="*.tf" . 2>/dev/null | wc -l
    - purpose: List Kubernetes managed resources
      command: |
        find . -name "*.yaml" -path "*k8s*" -exec grep -l "kind:" {} \; 2>/dev/null | wc -l
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Drift Detection Assessment
    - Coverage Analysis
    - Recommendations
  - type: drift_inventory
    format: table
    description: Current drift status by resource type
offline:
  capability: partial
  cache_manifest:
    knowledge:
    - source_id: cmmi-cm-sp32
      priority: required
    - source_id: gitops-principles
      priority: required
profiles:
  membership:
    quick:
      included: false
      reason: Drift detection requires comprehensive review
    full:
      included: true
      priority: 1
    production:
      included: true
      priority: 1
closeout_checklist:
- id: drft-001
  item: Drift detection capability exists
  level: CRITICAL
  verification: |
    find . \( -name "*.tfstate" -o -name "*argocd*" -o -name "*flux*" \) \
      -not -path "*/node_modules/*" 2>/dev/null | wc -l | \
      xargs -I{} test {} -gt 0 && echo "PASS" || echo "FAIL"
  expected: PASS
- id: drft-002
  item: Drift alerting configured
  level: BLOCKING
  verification: manual
  verification_notes: Verify drift alerts are configured
  expected: Confirmed by reviewer
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: CMMI
    controls:
    - CM SP 3.2
  - framework: SOC 2
    controls:
    - CC7.1
  - framework: ISO 27001
    controls:
    - A.8.9
relationships:
  commonly_combined:
  - configuration-management.configuration-identification.config-baseline
  - configuration-management.configuration-verification.config-validation
