# ============================================================
# AUDIT: Configuration Testing and Verification
# Category: 30 - Configuration Management
# Subcategory: configuration-verification
# ============================================================
# Testing of configuration changes in non-production environments
# before deployment to production.
# ============================================================

audit:
  id: "configuration-management.configuration-verification.testing-verification"
  name: "Configuration Testing and Verification Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "configuration-verification"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "infrastructure"

  default_profiles:
    - "full"
    - "production"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit examines the testing and verification of configuration
    changes before production deployment. It evaluates:
    - Configuration testing environments
    - Automated configuration testing
    - Smoke testing after config deployment
    - Integration testing with config changes
    - Configuration rollout testing
    - Test coverage for configuration scenarios
    - Pre-production validation gates

  why_it_matters: |
    Configuration testing prevents production incidents:
    - Untested configs are a leading cause of outages
    - Testing catches errors before they impact users
    - 12-factor app requires dev/prod parity for config testing
    - Automated testing enables rapid config deployment
    - Test environments validate config behavior
    - Pre-production gates prevent bad configs reaching prod
    - Testing builds confidence in configuration changes

  when_to_run:
    - "When establishing configuration processes"
    - "After configuration-related incidents"
    - "When improving deployment pipelines"
    - "During quality process reviews"
    - "When adding new configuration types"

prerequisites:
  required_artifacts:
    - type: "test_environments"
      description: "Non-production testing environments"
    - type: "test_suites"
      description: "Configuration test automation"

  access_requirements:
    - "Access to test environments"
    - "Access to CI/CD configuration"
    - "Access to test results"

discovery:
  code_patterns:
    - pattern: "(test|spec|verify)[-_](config|configuration)"
      type: "regex"
      scope: "source"
      purpose: "Detect configuration tests"

    - pattern: "(smoke|sanity|integration)[-_]test"
      type: "regex"
      scope: "config"
      purpose: "Detect test configurations"

  file_patterns:
    - glob: "**/*config*.test.*"
      purpose: "Configuration test files"
    - glob: "**/test/**"
      purpose: "Test directories"
    - glob: "**/*spec*"
      purpose: "Specification tests"

knowledge_sources:
  specifications:
    - id: "12factor-parity"
      name: "12-Factor App: Factor X - Dev/Prod Parity"
      url: "https://12factor.net/dev-prod-parity"
      offline_cache: true
      priority: "required"

  guides:
    - id: "terratest"
      name: "Terratest Documentation"
      url: "https://terratest.gruntwork.io/"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "terratest"
      purpose: "Infrastructure testing"
      offline_capable: true

    - tool: "kitchen"
      purpose: "Infrastructure test framework"
      offline_capable: true

  scripts:
    - id: "config-testing-audit"
      language: "bash"
      purpose: "Audit configuration testing"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Configuration Testing Audit ==="
        echo ""
        echo "=== Configuration Test Files ==="
        find . -name "*config*test*" -o -name "*test*config*" \
          -not -path "*/node_modules/*" 2>/dev/null | head -30
        echo ""
        echo "=== Test Environment Configs ==="
        find . -path "*test*" -name "*.yaml" -o -path "*staging*" -name "*.yaml" \
          -not -path "*/node_modules/*" 2>/dev/null | head -30
        echo ""
        echo "=== CI/CD Test Steps ==="
        grep -rn "test\|verify\|validate" \
          --include="*.yaml" .github/workflows/ 2>/dev/null | head -30

signals:
  critical:
    - id: "CTST-CRIT-001"
      signal: "No configuration testing before production"
      evidence_indicators:
        - "Configs deployed directly to production"
        - "No test environment for configs"
        - "No pre-production validation"
      explanation: |
        Untested configurations are a leading cause of outages.
        Testing catches errors before they impact production users.
      remediation: |
        - Implement config testing environments
        - Add automated config tests
        - Require pre-production deployment
        - Block untested configs from production
      cwe: "CWE-20"

  high:
    - id: "CTST-HIGH-001"
      signal: "Configuration testing manual only"
      evidence_indicators:
        - "No automated config tests"
        - "Manual verification only"
        - "Testing often skipped"
      explanation: |
        Manual testing is slow and inconsistent. Automated
        testing enables faster deployment with consistent
        verification.
      remediation: |
        - Automate configuration testing
        - Integrate tests in CI/CD
        - Run tests on every change
        - Block on test failure

    - id: "CTST-HIGH-002"
      signal: "Test environment not representative"
      evidence_indicators:
        - "Test environment differs from production"
        - "Dev/prod parity not maintained"
        - "Different config patterns in test"
      explanation: |
        12-factor app requires dev/prod parity. Testing in
        unrepresentative environments may not catch issues
        that appear in production.
      remediation: |
        - Maintain dev/prod parity
        - Use same config patterns everywhere
        - Sync test and prod configurations
        - Minimize environment differences

    - id: "CTST-HIGH-003"
      signal: "No smoke tests after config deployment"
      evidence_indicators:
        - "No post-deployment verification"
        - "Deployment success assumed"
        - "No health checks"
      explanation: |
        Smoke tests verify successful deployment. Without
        them, failed deployments may go unnoticed until
        users are impacted.
      remediation: |
        - Implement post-deployment smoke tests
        - Verify critical functionality
        - Run health checks automatically
        - Alert on smoke test failure

  medium:
    - id: "CTST-MED-001"
      signal: "Configuration test coverage low"
      evidence_indicators:
        - "Not all config types tested"
        - "Edge cases not covered"
        - "Critical scenarios missing"
      explanation: |
        Low test coverage misses issues. Comprehensive
        coverage including edge cases catches more errors.
      remediation: |
        - Increase test coverage
        - Cover all config types
        - Add edge case tests
        - Test failure scenarios

    - id: "CTST-MED-002"
      signal: "No rollout testing"
      evidence_indicators:
        - "Full deployment only"
        - "No canary or staged rollout"
        - "Cannot test partial deployment"
      explanation: |
        Rollout testing limits blast radius. Without it,
        config errors affect all users immediately.
      remediation: |
        - Implement staged rollout
        - Test in canary first
        - Progressively expand rollout
        - Monitor at each stage

  low:
    - id: "CTST-LOW-001"
      signal: "Test results not retained"
      evidence_indicators:
        - "No test history"
        - "Cannot review past tests"
        - "No trend analysis"
      explanation: |
        Test history enables trend analysis. Without it,
        patterns cannot be identified.
      remediation: |
        - Retain test results
        - Track test trends
        - Enable historical analysis
        - Report on test quality

  positive:
    - id: "CTST-POS-001"
      signal: "Comprehensive automated config testing"
      evidence_indicators:
        - "Tests for all config types"
        - "CI/CD integration"
        - "Pre-production gates"

procedure:
  context:
    cognitive_mode: "methodical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Test Environment Assessment"
      description: "Assess configuration test environments."
      duration_estimate: "30 min"
      commands:
        - purpose: "Find test environment configs"
          command: |
            find . \( -path "*test*" -o -path "*staging*" \) -name "*.yaml" \
              -not -path "*/node_modules/*" 2>/dev/null | head -30
        - purpose: "Check for environment definitions"
          command: |
            find . -name "*environment*" -not -path "*/node_modules/*" \
              2>/dev/null | head -20

    - id: "2"
      name: "Test Automation Review"
      description: "Review configuration test automation."
      duration_estimate: "30 min"
      commands:
        - purpose: "Find config test files"
          command: |
            find . \( -name "*config*test*" -o -name "*test*config*" \) \
              -not -path "*/node_modules/*" 2>/dev/null | head -30
        - purpose: "Check CI/CD for testing"
          command: |
            grep -rn "test\|verify\|validate" \
              --include="*.yaml" .github/workflows/ 2>/dev/null | head -30

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Test Environment Assessment"
        - "Automation Review"
        - "Recommendations"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "12factor-parity"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Testing audit requires thorough review"
    full:
      included: true
      priority: 1
    production:
      included: true
      priority: 1

closeout_checklist:
  - id: "ctst-001"
    item: "Configuration testing exists"
    level: "CRITICAL"
    verification: |
      find . -name "*config*test*" -not -path "*/node_modules/*" 2>/dev/null | \
        wc -l | xargs -I{} test {} -gt 0 && echo "PASS" || echo "WARN"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["all"]
  compliance_frameworks:
    - framework: "12-Factor App"
      controls: ["Factor X"]
    - framework: "CMMI"
      controls: ["VER"]

relationships:
  commonly_combined:
    - "configuration-management.environment-management.environment-parity"
    - "configuration-management.release-configuration.canary-config"
