# ============================================================
# AUDIT: Configuration Integrity Verification
# Category: 30 - Configuration Management
# Subcategory: configuration-verification
# ============================================================
# Verification of configuration integrity through checksums,
# signatures, and tamper detection mechanisms.
# ============================================================

audit:
  id: "configuration-management.configuration-verification.integrity-verification"
  name: "Configuration Integrity Verification Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "configuration-management"
  category_number: 30
  subcategory: "configuration-verification"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "full"
  severity: "high"
  scope: "infrastructure"

  default_profiles:
    - "full"
    - "production"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit examines integrity verification mechanisms for configuration
    items. It evaluates:
    - Checksum verification for configurations
    - Digital signatures for configuration packages
    - Tamper detection mechanisms
    - Integrity monitoring tools
    - Supply chain integrity for configurations
    - File integrity monitoring (FIM)
    - Verification automation and alerting

  why_it_matters: |
    Configuration integrity is essential for security:
    - Tampering with configurations enables attacks
    - Supply chain attacks target configuration packages
    - Integrity verification detects unauthorized modifications
    - Compliance frameworks require integrity controls
    - FIM is a key security control for sensitive configs
    - Signatures ensure authenticity of config sources
    - Early tamper detection limits damage

  when_to_run:
    - "During security assessments"
    - "When implementing supply chain security"
    - "After security incidents"
    - "For compliance verification"
    - "Regular security reviews"

prerequisites:
  required_artifacts:
    - type: "configurations"
      description: "Configuration files to verify"
    - type: "signatures"
      description: "Digital signatures if used"

  access_requirements:
    - "Access to configuration files"
    - "Access to integrity monitoring tools"
    - "Access to signature verification"

discovery:
  code_patterns:
    - pattern: "(checksum|hash|sha256|md5|digest|signature)"
      type: "regex"
      scope: "config"
      purpose: "Detect integrity verification"

    - pattern: "(fim|tripwire|ossec|aide|verify[-_]signature)"
      type: "regex"
      scope: "config"
      purpose: "Detect integrity monitoring tools"

  file_patterns:
    - glob: "**/*.sha256"
      purpose: "SHA256 checksum files"
    - glob: "**/*.sig"
      purpose: "Signature files"
    - glob: "**/checksums*"
      purpose: "Checksum manifests"

knowledge_sources:
  specifications:
    - id: "nist-si-7"
      name: "NIST 800-53 SI-7 Software and Information Integrity"
      url: "https://csrc.nist.gov/pubs/sp/800/53/r5/upd1/final"
      offline_cache: true
      priority: "required"

  guides:
    - id: "slsa"
      name: "SLSA Supply Chain Levels"
      url: "https://slsa.dev/"
      offline_cache: true

tooling:
  infrastructure_tools:
    - tool: "cosign"
      purpose: "Container signing and verification"
      command: "cosign verify"

    - tool: "sigstore"
      purpose: "Signature verification"
      command: "cosign verify-blob"

  scripts:
    - id: "integrity-audit"
      language: "bash"
      purpose: "Audit integrity verification"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Configuration Integrity Audit ==="
        echo ""
        echo "=== Checksum Files ==="
        find . -name "*.sha256" -o -name "*.sha512" -o -name "*checksum*" \
          -not -path "*/node_modules/*" 2>/dev/null | head -20
        echo ""
        echo "=== Signature Files ==="
        find . -name "*.sig" -o -name "*.asc" \
          -not -path "*/node_modules/*" 2>/dev/null | head -20
        echo ""
        echo "=== FIM/Integrity Tool Configs ==="
        find . -name "*tripwire*" -o -name "*ossec*" -o -name "*aide*" \
          -not -path "*/node_modules/*" 2>/dev/null | head -20

signals:
  critical:
    - id: "CINT-CRIT-001"
      signal: "No configuration integrity verification"
      evidence_indicators:
        - "No checksums for configurations"
        - "No signature verification"
        - "No FIM for critical configs"
      explanation: |
        Without integrity verification, configuration tampering
        goes undetected. Attackers can modify configurations
        to enable further attacks.
      remediation: |
        - Implement checksum verification
        - Sign critical configurations
        - Deploy file integrity monitoring
        - Verify integrity before deployment
      cwe: "CWE-354"

    - id: "CINT-CRIT-002"
      signal: "Configuration supply chain not secured"
      evidence_indicators:
        - "Third-party configs not verified"
        - "No provenance tracking"
        - "Unsigned dependencies"
      explanation: |
        Supply chain attacks target configuration sources.
        Without verification, malicious configs can be
        introduced through trusted channels.
      remediation: |
        - Verify third-party config sources
        - Implement provenance tracking
        - Require signatures for external configs
        - Follow SLSA guidelines

  high:
    - id: "CINT-HIGH-001"
      signal: "Integrity verification not automated"
      evidence_indicators:
        - "Manual integrity checks"
        - "No CI/CD integration"
        - "Verification often skipped"
      explanation: |
        Manual verification is inconsistent. Automated
        verification ensures every deployment is verified.
      remediation: |
        - Automate integrity verification
        - Integrate in CI/CD
        - Block deployment on failure
        - Alert on integrity violations

    - id: "CINT-HIGH-002"
      signal: "Critical configurations not monitored"
      evidence_indicators:
        - "No FIM for security configs"
        - "Changes to critical configs undetected"
        - "No runtime integrity monitoring"
      explanation: |
        Critical configurations need continuous monitoring.
        Point-in-time verification misses runtime tampering.
      remediation: |
        - Deploy FIM for critical configs
        - Monitor security-sensitive files
        - Alert on unauthorized changes
        - Investigate integrity alerts

  medium:
    - id: "CINT-MED-001"
      signal: "Checksum algorithms weak"
      evidence_indicators:
        - "MD5 checksums used"
        - "SHA1 in use"
        - "No cryptographic hash"
      explanation: |
        Weak algorithms can be attacked. Modern cryptographic
        hashes (SHA256+) resist collision attacks.
      remediation: |
        - Use SHA256 or SHA512
        - Migrate from MD5/SHA1
        - Update verification tools
        - Document algorithm requirements

    - id: "CINT-MED-002"
      signal: "Signature keys not protected"
      evidence_indicators:
        - "Signing keys in code"
        - "Keys not in secure storage"
        - "No key rotation"
      explanation: |
        Compromised signing keys enable forged signatures.
        Key protection is essential for signature value.
      remediation: |
        - Store keys in HSM or vault
        - Implement key rotation
        - Limit key access
        - Monitor key usage

  low:
    - id: "CINT-LOW-001"
      signal: "Integrity verification not logged"
      evidence_indicators:
        - "No audit trail for verification"
        - "Cannot prove verification occurred"
        - "No forensic evidence"
      explanation: |
        Logging enables audit and investigation. Without
        logs, verification cannot be proven for compliance.
      remediation: |
        - Log all integrity verifications
        - Include verification in audit trail
        - Retain logs per policy
        - Enable log analysis

  positive:
    - id: "CINT-POS-001"
      signal: "Comprehensive integrity verification"
      evidence_indicators:
        - "Checksums for all configs"
        - "Automated verification in CI/CD"
        - "FIM for critical files"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Checksum and Signature Assessment"
      description: "Assess checksum and signature usage."
      duration_estimate: "30 min"
      commands:
        - purpose: "Find checksum files"
          command: |
            find . \( -name "*.sha256" -o -name "*.sha512" -o -name "*checksum*" \) \
              -not -path "*/node_modules/*" 2>/dev/null | head -30
        - purpose: "Find signature files"
          command: |
            find . \( -name "*.sig" -o -name "*.asc" \) \
              -not -path "*/node_modules/*" 2>/dev/null | head -20

    - id: "2"
      name: "FIM and Monitoring Assessment"
      description: "Assess file integrity monitoring."
      duration_estimate: "30 min"
      commands:
        - purpose: "Find FIM configurations"
          command: |
            find . \( -name "*tripwire*" -o -name "*ossec*" -o -name "*aide*" \) \
              -not -path "*/node_modules/*" 2>/dev/null | head -20
        - purpose: "Check for container signing"
          command: |
            grep -rn "cosign\|sigstore\|notation" --include="*.yaml" \
              . 2>/dev/null | head -20

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Integrity Mechanisms"
        - "Gap Analysis"
        - "Recommendations"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "nist-si-7"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Integrity audit requires thorough review"
    full:
      included: true
      priority: 1
    security:
      included: true
      priority: 1
    production:
      included: true
      priority: 1

closeout_checklist:
  - id: "cint-001"
    item: "Configuration integrity verification exists"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify checksums or signatures used"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]
  compliance_frameworks:
    - framework: "NIST 800-53"
      controls: ["SI-7"]
    - framework: "PCI-DSS"
      controls: ["11.5"]
    - framework: "SOC 2"
      controls: ["CC7.2"]

relationships:
  commonly_combined:
    - "configuration-management.configuration-control.change-control"
    - "security-trust.supply-chain.artifact-verification"
