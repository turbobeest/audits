audit:
  id: observability-instrumentation.distributed-tracing.trace-retention
  name: Trace Retention Audit
  version: 1.0.0
  last_updated: '2026-01-18'
  status: active
  category: observability-instrumentation
  category_number: 5
  subcategory: distributed-tracing
  tier: expert
  estimated_duration: 1 hour
  completeness: complete
  requires_runtime: true
  destructive: false
execution:
  automatable: full
  severity: medium
  scope: infrastructure
  default_profiles:
  - full
  - production
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Reviews trace data retention policies including storage duration,
    archival strategies, and compliance requirements. Evaluates whether
    retention periods balance debugging needs with storage costs.
  why_it_matters: |
    Insufficient retention loses critical debugging data before post-incident
    reviews complete. Over-retention wastes storage resources and may create
    compliance issues. Proper retention ensures traces are available when
    needed while managing costs effectively.
  when_to_run:
  - Storage cost review
  - Compliance audit preparation
  - After retention-related incidents
  - Quarterly observability review
prerequisites:
  required_artifacts:
  - type: tracing_backend
    description: Access to trace storage configuration
  - type: retention_policy
    description: Documented retention requirements
  access_requirements:
  - Trace storage administration
  - Index lifecycle management configuration
  - Storage utilization metrics
discovery:
  metrics_queries:
  - system: Elasticsearch
    query: _cat/indices/jaeger-*?v
    purpose: List trace indices and sizes
    threshold: Indices match retention policy
  - system: Prometheus
    query: elasticsearch_indices_docs_count{index=~'jaeger.*'}
    purpose: Track trace document counts
    threshold: Growth within expected range
  code_patterns:
  - pattern: max_age|retention|lifecycle|delete_after
    type: regex
    scope: config
    purpose: Identify retention configuration
  file_patterns:
  - glob: '**/elasticsearch*.yaml'
    purpose: Elasticsearch configuration
  - glob: '**/ilm-policy*.json'
    purpose: Index lifecycle policies
  - glob: '**/jaeger*.yaml'
    purpose: Jaeger storage configuration
knowledge_sources:
  specifications:
  - id: es-ilm
    name: Elasticsearch Index Lifecycle Management
    url: https://www.elastic.co/guide/en/elasticsearch/reference/current/index-lifecycle-management.html
    offline_cache: true
    priority: required
  guides:
  - id: jaeger-storage
    name: Jaeger Storage Backend
    url: https://www.jaegertracing.io/docs/deployment/#storage-backends
    offline_cache: true
tooling:
  infrastructure_tools:
  - tool: curl
    purpose: Query Elasticsearch ILM policy
    command: curl -s 'http://elasticsearch:9200/_ilm/policy/jaeger-policy'
  - tool: elasticsearch
    purpose: List trace indices
    command: curl -s 'http://elasticsearch:9200/_cat/indices/jaeger-*?v&s=creation.date:desc'
  monitoring_queries:
  - system: Prometheus
    query: sum(elasticsearch_indices_store_size_bytes{index=~'jaeger.*'})
    purpose: Total trace storage usage
signals:
  critical:
  - id: TRACE-RET-CRIT-001
    signal: Trace retention less than 24 hours
    evidence_threshold: retention_days < 1
    explanation: |
      Less than 24-hour retention means traces are deleted before most
      incidents can be investigated. On-call engineers need at least
      24 hours to begin post-incident analysis.
    remediation: Increase minimum retention to 7 days
  - id: TRACE-RET-CRIT-002
    signal: No retention policy configured
    evidence_pattern: ILM policy missing or disabled
    explanation: |
      Without retention policies, trace storage grows unbounded,
      eventually causing storage exhaustion and service degradation.
    remediation: Configure ILM policy with appropriate retention
  high:
  - id: TRACE-RET-HIGH-001
    signal: Retention less than 7 days
    evidence_threshold: retention_days < 7
    explanation: |
      Most post-incident reviews happen within a week. Insufficient
      retention forces rushed analysis before data expires.
    remediation: Extend retention to at least 14 days for standard traces
  - id: TRACE-RET-HIGH-002
    signal: Error traces same retention as normal traces
    evidence_pattern: No differentiated retention for errors
    explanation: |
      Error traces are more valuable for debugging and should be
      retained longer than successful request traces.
    remediation: Implement longer retention for error-flagged traces
  medium:
  - id: TRACE-RET-MED-001
    signal: No archival strategy for old traces
    evidence_pattern: Traces deleted, not archived
    remediation: Consider cold storage archival for compliance
  - id: TRACE-RET-MED-002
    signal: Retention not aligned with compliance requirements
    evidence_pattern: Policy shorter than regulatory requirement
    remediation: Review compliance requirements and adjust retention
  low:
  - id: TRACE-RET-LOW-001
    signal: Retention policy not documented
    remediation: Document retention policy and rationale
  positive:
  - id: TRACE-RET-POS-001
    signal: Tiered retention with extended error trace storage
    evidence_pattern: 14+ days standard, 30+ days errors
procedure:
  context:
    cognitive_mode: critical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Review retention configuration
    description: |
      Examine index lifecycle management policies and trace
      storage retention settings.
    duration_estimate: 15 min
    commands:
    - purpose: Get ILM policy
      command: curl -s 'http://elasticsearch:9200/_ilm/policy/jaeger-policy' | jq
    - purpose: Check index ages
      command: curl -s 'http://elasticsearch:9200/_cat/indices/jaeger-*?v&h=index,creation.date.string,store.size'
    expected_findings:
    - Retention policy details
    - Current index inventory
  - id: '2'
    name: Verify actual retention
    description: |
      Confirm that oldest available traces match the configured
      retention policy and data is being properly cleaned up.
    duration_estimate: 20 min
    commands:
    - purpose: Find oldest trace
      command: curl -s 'http://jaeger:16686/api/traces?service=api&limit=1&start=0&end=9999999999999999'
        | jq '.data[0].spans[0].startTime'
    - purpose: Calculate actual retention
      command: date -d @$(curl -s 'http://elasticsearch:9200/jaeger-span-*/_search?size=1&sort=startTime:asc'
        | jq '.hits.hits[0]._source.startTime/1000000' | cut -d. -f1)
    expected_findings:
    - Actual oldest trace date
    - Retention verification
  - id: '3'
    name: Assess storage utilization
    description: |
      Review storage consumption trends and project future
      needs based on current retention policy.
    duration_estimate: 15 min
    commands:
    - purpose: Get storage usage
      command: curl -s 'http://elasticsearch:9200/_cat/indices/jaeger-*?v&h=index,store.size&s=store.size:desc'
    - purpose: Calculate daily growth
      command: curl -s 'http://prometheus:9090/api/v1/query?query=increase(elasticsearch_indices_store_size_bytes{index=~"jaeger.*"}[24h])'
    expected_findings:
    - Storage utilization
    - Growth rate
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Retention Policy Review
    - Storage Analysis
    - Recommendations
  confidence_guidance:
    high: Direct configuration and storage verification
    medium: Configuration review only
    low: Documentation review
offline:
  capability: partial
  cache_manifest:
    knowledge:
    - source_id: es-ilm
      priority: required
profiles:
  membership:
    quick:
      included: true
      priority: 3
    full:
      included: true
      priority: 2
    production:
      included: true
      priority: 2
closeout_checklist:
- id: trace-ret-001
  item: Retention policy documented
  level: CRITICAL
  verification: curl -sf 'http://elasticsearch:9200/_ilm/policy/jaeger-policy' && echo PASS || echo FAIL
  expected: PASS
- id: trace-ret-002
  item: Minimum 7-day retention verified
  level: BLOCKING
  verification: manual
  expected: Traces available from 7+ days ago
- id: trace-ret-003
  item: Storage growth sustainable
  level: WARNING
  verification: manual
  expected: Growth within capacity
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: SOC 2
    controls:
    - Data Retention
  - framework: GDPR
    controls:
    - Data Minimization
relationships:
  commonly_combined:
  - observability-instrumentation.distributed-tracing.trace-storage-cost
  - observability-instrumentation.distributed-tracing.trace-sampling
  - security-trust.data-protection.data-retention
