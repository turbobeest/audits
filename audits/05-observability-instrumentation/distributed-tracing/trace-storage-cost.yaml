audit:
  id: observability-instrumentation.distributed-tracing.trace-storage-cost
  name: Trace Storage Cost Audit
  version: 1.0.0
  last_updated: '2026-01-18'
  status: active
  category: observability-instrumentation
  category_number: 5
  subcategory: distributed-tracing
  tier: expert
  estimated_duration: 1.5 hours
  completeness: complete
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: medium
  scope: infrastructure
  default_profiles:
  - full
  - production
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Analyzes trace storage costs including storage infrastructure, data
    transfer, and query costs. Identifies cost optimization opportunities
    through sampling adjustments, attribute reduction, and storage tiering.
  why_it_matters: |
    Tracing at scale can become a significant cost center. Unoptimized
    storage with verbose spans, high sampling rates, and long retention
    leads to unnecessary expenses. Cost optimization enables sustainable
    tracing practices without sacrificing essential visibility.
  when_to_run:
  - Quarterly cost review
  - When tracing costs exceed budget
  - Before scaling traffic significantly
  - After adding new services
prerequisites:
  required_artifacts:
  - type: cost_data
    description: Cloud provider billing or infrastructure costs
  - type: storage_metrics
    description: Trace storage utilization data
  access_requirements:
  - Cloud cost explorer or billing access
  - Storage infrastructure metrics
  - Trace ingestion rate metrics
discovery:
  metrics_queries:
  - system: Prometheus
    query: sum(rate(otelcol_exporter_sent_spans[1h])) * 3600
    purpose: Calculate hourly span ingestion
    threshold: Within expected range
  - system: Prometheus
    query: sum(elasticsearch_indices_store_size_bytes{index=~'jaeger.*'})
    purpose: Total trace storage bytes
    threshold: Within budget
  code_patterns:
  - pattern: span\.set_attribute|add_attribute|SetTag
    type: regex
    scope: source
    purpose: Identify span attribute verbosity
  file_patterns:
  - glob: '**/otel-collector*.yaml'
    purpose: Collector processing configuration
  - glob: '**/cost*.{yaml,json}'
    purpose: Cost allocation configuration
knowledge_sources:
  specifications:
  - id: otel-attribute-limits
    name: OpenTelemetry Attribute Limits
    url: https://opentelemetry.io/docs/specs/otel/common/#attribute-limits
    offline_cache: true
    priority: required
  guides:
  - id: cost-optimization
    name: Observability Cost Optimization
    url: https://opentelemetry.io/docs/collector/scaling/
    offline_cache: true
tooling:
  infrastructure_tools:
  - tool: aws-cost
    purpose: Query AWS cost data
    command: aws ce get-cost-and-usage --time-period Start=2026-01-01,End=2026-01-18 --granularity DAILY
      --metrics BlendedCost --filter '{"Tags":{"Key":"service","Values":["tracing"]}}'
  - tool: elasticsearch
    purpose: Get storage statistics
    command: 'curl -s ''http://elasticsearch:9200/jaeger-*/_stats/store'' | jq ''.indices | to_entries
      | map({name: .key, size_gb: (.value.primaries.store.size_in_bytes/1073741824)})'''
  monitoring_queries:
  - system: Prometheus
    query: sum by (service) (rate(otelcol_exporter_sent_spans[24h])) * 86400
    purpose: Daily span count by service
signals:
  critical:
  - id: TRACE-COST-CRIT-001
    signal: Tracing costs exceeding budget by 50%+
    evidence_threshold: actual_cost > budget * 1.5
    explanation: |
      Significantly over-budget tracing costs indicate fundamental
      configuration issues that require immediate attention to
      prevent runaway spending.
    remediation: Implement emergency sampling rate reduction
  - id: TRACE-COST-CRIT-002
    signal: Storage growth unsustainable
    evidence_pattern: Storage doubling monthly without traffic increase
    explanation: |
      Exponential storage growth will exhaust capacity and budget.
      Immediate intervention required to prevent service disruption.
    remediation: Review sampling rates and attribute verbosity
  high:
  - id: TRACE-COST-HIGH-001
    signal: Single service consuming majority of storage
    evidence_threshold: service_storage > 0.5 * total_storage
    explanation: |
      Disproportionate storage consumption indicates over-instrumentation
      or missing sampling for high-volume services.
    remediation: Implement service-specific sampling rates
  - id: TRACE-COST-HIGH-002
    signal: Verbose span attributes inflating storage
    evidence_pattern: Average span size > 5KB
    explanation: |
      Large spans with excessive attributes multiply storage costs.
      Most debugging needs can be met with smaller, focused spans.
    remediation: Reduce unnecessary span attributes
  medium:
  - id: TRACE-COST-MED-001
    signal: No cost allocation by team/service
    evidence_pattern: Missing cost tags on trace infrastructure
    remediation: Implement cost allocation tagging
  - id: TRACE-COST-MED-002
    signal: No storage tiering implemented
    evidence_pattern: All traces on hot storage
    remediation: Implement cold storage for older traces
  low:
  - id: TRACE-COST-LOW-001
    signal: Cost trends not monitored
    remediation: Set up cost monitoring dashboards and alerts
  positive:
  - id: TRACE-COST-POS-001
    signal: Optimized storage with tiering and appropriate sampling
    evidence_pattern: Costs stable and within budget
procedure:
  context:
    cognitive_mode: critical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Calculate current costs
    description: |
      Gather all costs associated with trace storage including
      infrastructure, data transfer, and query costs.
    duration_estimate: 30 min
    commands:
    - purpose: Get storage size by index
      command: curl -s 'http://elasticsearch:9200/_cat/indices/jaeger-*?v&h=index,store.size,docs.count'
    - purpose: Calculate monthly storage cost
      command: 'curl -s ''http://elasticsearch:9200/jaeger-*/_stats/store'' | jq ''.all.primaries.store.size_in_bytes
        / 1073741824 * 0.10'' # Assuming $0.10/GB/month'
    expected_findings:
    - Total storage size
    - Estimated monthly cost
  - id: '2'
    name: Analyze cost drivers
    description: |
      Identify which services, endpoints, or span types are
      driving the majority of storage costs.
    duration_estimate: 30 min
    commands:
    - purpose: Get span count by service
      command: curl -s 'http://prometheus:9090/api/v1/query?query=sum%20by%20(service)%20(increase(otelcol_exporter_sent_spans[30d]))'
    - purpose: Calculate average span size
      command: curl -s 'http://elasticsearch:9200/jaeger-span-*/_stats' | jq '.all.primaries.store.size_in_bytes
        / .all.primaries.docs.count'
    expected_findings:
    - Cost by service
    - Average span size
    - Top cost drivers
  - id: '3'
    name: Identify optimization opportunities
    description: |
      Review sampling rates, span attributes, and retention
      settings for potential cost reduction.
    duration_estimate: 30 min
    commands:
    - purpose: Review sampling configuration
      command: kubectl get configmap otel-collector-config -o yaml | grep -A 10 'probabilistic_sampler'
    - purpose: Find verbose spans
      command: curl -s 'http://jaeger:16686/api/traces?service=api&limit=10' | jq '[.data[].spans[].tags
        | length] | add / length'
    expected_findings:
    - Current sampling rates
    - Attribute verbosity
    - Optimization recommendations
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Cost Analysis
    - Cost Drivers
    - Optimization Recommendations
  confidence_guidance:
    high: Direct cost data from billing and storage metrics
    medium: Estimated costs from usage metrics
    low: Rough estimates from configuration
offline:
  capability: partial
  cache_manifest:
    knowledge:
    - source_id: otel-attribute-limits
      priority: required
profiles:
  membership:
    quick:
      included: false
      reason: Requires cost data collection
    full:
      included: true
      priority: 2
    production:
      included: true
      priority: 2
closeout_checklist:
- id: trace-cost-001
  item: Current costs calculated
  level: CRITICAL
  verification: manual
  expected: Total cost documented
- id: trace-cost-002
  item: Cost drivers identified
  level: BLOCKING
  verification: manual
  expected: Top 3 cost drivers documented
- id: trace-cost-003
  item: Optimization plan created
  level: WARNING
  verification: manual
  expected: Action items with projected savings
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: FinOps
    controls:
    - Cost Optimization
relationships:
  commonly_combined:
  - observability-instrumentation.distributed-tracing.trace-sampling
  - observability-instrumentation.distributed-tracing.trace-retention
  - observability-instrumentation.distributed-tracing.trace-coverage
