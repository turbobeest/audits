# ============================================================
# AUDIT: Error Suggestion - WCAG 2.1 Compliance
# ============================================================
# Verifies error messages provide helpful suggestions per
# WCAG 2.1 SC 3.3.3.

audit:
  id: "accessibility-inclusion.understandable-content.error-suggestion"
  name: "Error Suggestion Audit"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "accessibility-inclusion"
  category_number: 15
  subcategory: "understandable-content"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "accessibility"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit verifies error messages provide helpful suggestions
    for correction per WCAG 2.1 SC 3.3.3 Error Suggestion (Level AA)
    and SC 3.3.1 Error Identification (Level A).

    The audit covers:
    - Form validation error messages
    - Input format suggestions
    - Required field messaging
    - Password requirement guidance
    - Date/time format help
    - Search and filter error states
    - API/server error handling
    - Inline vs. summary error display

  why_it_matters: |
    Unclear error messages frustrate all users but especially:

    - Users with cognitive disabilities struggle to understand vague errors
    - Users with learning disabilities need specific guidance
    - Non-native speakers need clear language
    - Screen reader users need errors associated with fields
    - All users benefit from actionable suggestions

    Error messages that only say "Invalid input" leave users
    guessing what to fix.

  when_to_run:
    - "When implementing form validation"
    - "When adding new input fields"
    - "Before accessibility compliance audits"
    - "When updating error handling"
    - "During UX review"

prerequisites:
  required_artifacts:
    - type: "codebase"
      description: "Access to validation and error handling code"
    - type: "running_application"
      description: "Deployed instance for testing"

  access_requirements:
    - "Read access to form and validation code"
    - "Browser access for testing"

discovery:
  code_patterns:
    - pattern: "error|Error|invalid|Invalid"
      type: "regex"
      scope: "source"
      purpose: "Find error handling code"
    - pattern: "validation|validate|validator"
      type: "regex"
      scope: "source"
      purpose: "Find validation implementations"
    - pattern: "aria-invalid|aria-errormessage|aria-describedby"
      type: "regex"
      scope: "source"
      purpose: "Find ARIA error associations"
    - pattern: "helperText|errorMessage|errorText"
      type: "regex"
      scope: "source"
      purpose: "Find error message patterns"

  file_patterns:
    - glob: "**/validation*.{js,ts}"
      purpose: "Validation files"
    - glob: "**/form*.{jsx,tsx}"
      purpose: "Form components"
    - glob: "**/error*.{js,ts,jsx,tsx}"
      purpose: "Error handling code"
    - glob: "**/messages*.{js,ts,json}"
      purpose: "Message/string files"

knowledge_sources:
  specifications:
    - id: "wcag-21"
      name: "WCAG 2.1 Quick Reference"
      url: "https://www.w3.org/WAI/WCAG21/quickref/"
      offline_cache: true
      priority: "recommended"
    - id: "wcag21-331"
      name: "WCAG 2.1 Success Criterion 3.3.1 Error Identification"
      url: "https://www.w3.org/WAI/WCAG21/Understanding/error-identification.html"
      offline_cache: true
      priority: "required"
    - id: "wcag21-333"
      name: "WCAG 2.1 Success Criterion 3.3.3 Error Suggestion"
      url: "https://www.w3.org/WAI/WCAG21/Understanding/error-suggestion.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "webaim-forms"
      name: "WebAIM: Accessible Form Validation"
      url: "https://webaim.org/techniques/formvalidation/"
      offline_cache: true
    - id: "nngroup-errors"
      name: "NN/g: Error Message Guidelines"
      url: "https://www.nngroup.com/articles/error-message-guidelines/"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "axe-core"
      purpose: "Detect form accessibility issues"
      offline_capable: true
    - tool: "eslint-plugin-jsx-a11y"
      purpose: "Lint for form accessibility"
      offline_capable: true

  scripts:
    - id: "find-error-messages"
      language: "bash"
      purpose: "Find error message strings"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Error Messages ==="
        grep -rn "error\|Error\|invalid\|Invalid" --include="*.json" --include="*.ts" --include="*.js" . | \
          grep -i "message\|text\|label" | head -30
        echo ""
        echo "=== ARIA Error Patterns ==="
        grep -rn "aria-invalid\|aria-errormessage" --include="*.jsx" --include="*.tsx" . | head -20

signals:
  critical:
    - id: "A11Y-ERROR-CRIT-001"
      signal: "Errors not identified in text"
      evidence_pattern: "Error indicated only by color or icon"
      explanation: |
        WCAG 3.3.1 requires errors be identified in text. Color-only
        or icon-only errors are not accessible to all users.
      remediation: "Add text description of every error"
    - id: "A11Y-ERROR-CRIT-002"
      signal: "Error not associated with input field"
      evidence_pattern: "Error message not linked via aria-describedby"
      explanation: |
        Screen reader users need errors programmatically associated
        with the fields they describe.
      remediation: "Associate errors with inputs via aria-describedby or aria-errormessage"

  high:
    - id: "A11Y-ERROR-HIGH-001"
      signal: "Error message provides no correction suggestion"
      explanation: "Errors should suggest how to fix the problem"
      remediation: "Add specific guidance for correcting the error"
    - id: "A11Y-ERROR-HIGH-002"
      signal: "Format requirements not shown before error"
      explanation: "Users should know format requirements upfront"
      remediation: "Show format hints before validation fails"
    - id: "A11Y-ERROR-HIGH-003"
      signal: "Required field error not descriptive"
      explanation: "'Required' alone doesn't help users understand what to do"
      remediation: "Say 'Please enter [field name]' instead of just 'Required'"

  medium:
    - id: "A11Y-ERROR-MED-001"
      signal: "Generic error messages used"
      remediation: "Create specific messages for each error type"
    - id: "A11Y-ERROR-MED-002"
      signal: "Error summary not provided for forms"
      remediation: "Add error summary at top of form with links to fields"
    - id: "A11Y-ERROR-MED-003"
      signal: "Errors not announced to screen readers"
      remediation: "Use aria-live or role='alert' for dynamic errors"

  low:
    - id: "A11Y-ERROR-LOW-001"
      signal: "Error wording could be more helpful"

  positive:
    - id: "A11Y-ERROR-POS-001"
      signal: "All errors include correction suggestions"
    - id: "A11Y-ERROR-POS-002"
      signal: "Errors properly associated with inputs"
    - id: "A11Y-ERROR-POS-003"
      signal: "Format requirements shown before error occurs"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Form Fields and Validation"
      description: |
        Identify all form fields and their validation rules.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find form components"
          command: "grep -rln 'form\\|Form' --include='*.jsx' --include='*.tsx' . | head -20"
        - purpose: "Find validation code"
          command: "grep -rn 'validate\\|validation\\|required' --include='*.js' --include='*.ts' . | head -40"
      expected_findings:
        - "Form field inventory"
        - "Validation rule coverage"

    - id: "2"
      name: "Trigger and Review Error Messages"
      description: |
        Deliberately trigger validation errors and evaluate
        the error messages provided.
      duration_estimate: "45 min"
      questions:
        - "Is the error described in text (not just color/icon)?"
        - "Does the error explain what went wrong?"
        - "Does the error suggest how to fix it?"
        - "Is the error associated with the input field?"
      expected_findings:
        - "Error message quality"
        - "Missing suggestions"

    - id: "3"
      name: "Test Error Accessibility"
      description: |
        Verify errors are accessible to screen readers and
        properly announced.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find aria error attributes"
          command: "grep -rn 'aria-invalid\\|aria-describedby\\|aria-errormessage' --include='*.jsx' --include='*.tsx' ."
      questions:
        - "Are errors announced when they appear?"
        - "Can screen reader users navigate to error fields?"
        - "Is error summary read at form level?"
      expected_findings:
        - "Screen reader error handling"
        - "ARIA implementation gaps"

    - id: "4"
      name: "Evaluate Error Message Content"
      description: |
        Review actual error message text for clarity
        and helpfulness.
      duration_estimate: "30 min"
      questions:
        - "Are messages written in plain language?"
        - "Do messages avoid technical jargon?"
        - "Do messages include examples where helpful?"
        - "Are password requirements clearly stated?"
      expected_findings:
        - "Message content quality"
        - "Language clarity"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Form Error Inventory"
        - "Error Message Quality Assessment"
        - "Accessibility Implementation"
        - "Recommended Improvements"

  confidence_guidance:
    high: "Tested with screen reader, triggered all error types"
    medium: "Triggered common errors, code review complete"
    low: "Code analysis only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "wcag21-331"
        priority: "required"
      - source_id: "wcag21-333"
        priority: "required"

profiles:
  membership:
    quick:
      included: true
      priority: 2
      reason: "Error handling is critical for usability"
    full:
      included: true
      priority: 1
    accessibility:
      included: true
      priority: 1

closeout_checklist:
  - id: "error-suggestion-001"
    item: "All errors identified in text (not color/icon only)"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Trigger errors and verify text descriptions exist"
    expected: "Confirmed by reviewer"

  - id: "error-suggestion-002"
    item: "Errors associated with input fields"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Check aria-describedby or aria-errormessage"
    expected: "Confirmed by reviewer"

  - id: "error-suggestion-003"
    item: "Errors suggest how to correct problems"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Review error messages for correction guidance"
    expected: "Confirmed by reviewer"

  - id: "error-suggestion-004"
    item: "Errors announced to screen readers"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Test with screen reader for error announcements"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "WCAG 2.1"
      controls: ["3.3.1", "3.3.3"]
    - framework: "Section 508"
      controls: ["1194.22"]
    - framework: "EN 301 549"
      controls: ["9.3.3.1", "9.3.3.3"]

relationships:
  commonly_combined:
    - "accessibility-inclusion.understandable-content.reading-level"
    - "accessibility-inclusion.perceivable-visual.color-only-information"
    - "accessibility-inclusion.operable-keyboard.focus-order"
