# ============================================================
# AUDIT: Language Identification - WCAG 2.1 Compliance
# ============================================================
# Verifies page language and language changes are programmatically
# identified per WCAG 2.1 SC 3.1.1 and 3.1.2.

audit:
  id: "accessibility-inclusion.understandable-content.language-identification"
  name: "Language Identification Audit"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "accessibility-inclusion"
  category_number: 15
  subcategory: "understandable-content"

  tier: "expert"
  estimated_duration: "1-2 hours"  # median: 1h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "accessibility"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit verifies language identification per WCAG 2.1:
    - SC 3.1.1 Language of Page (Level A)
    - SC 3.1.2 Language of Parts (Level AA)

    The audit covers:
    - HTML lang attribute on root element
    - Valid BCP 47 language tags
    - Language changes marked with lang attribute
    - Multi-language content handling
    - Language direction (dir attribute)
    - Embedded content language
    - Programmatic language identification

  why_it_matters: |
    Screen readers and other assistive technologies use language
    identification to:

    - Select correct pronunciation rules
    - Apply appropriate text-to-speech voice
    - Handle language-specific processing
    - Support multi-language content

    Without language identification:
    - Screen readers mispronounce content
    - Braille displays may show incorrect characters
    - Translation tools cannot function properly
    - Users cannot understand synthesized speech

  when_to_run:
    - "When creating new pages"
    - "When adding multi-language content"
    - "Before accessibility compliance audits"
    - "When implementing internationalization"
    - "During code review"

prerequisites:
  required_artifacts:
    - type: "codebase"
      description: "Access to HTML templates"
    - type: "running_application"
      description: "Deployed instance for verification"

  access_requirements:
    - "Read access to HTML/template files"
    - "Browser DevTools for inspection"

discovery:
  code_patterns:
    - pattern: "<html[^>]*lang="
      type: "regex"
      scope: "source"
      purpose: "Find page-level language declaration"
    - pattern: "lang=['\"][a-z]{2,3}"
      type: "regex"
      scope: "source"
      purpose: "Find language attributes"
    - pattern: "dir=['\"]rtl|ltr['\"]"
      type: "regex"
      scope: "source"
      purpose: "Find direction attributes"
    - pattern: "xml:lang"
      type: "regex"
      scope: "source"
      purpose: "Find XML language declarations"

  file_patterns:
    - glob: "**/index.html"
      purpose: "Main HTML files"
    - glob: "**/_document.{js,jsx,tsx}"
      purpose: "Next.js document component"
    - glob: "**/App.{jsx,tsx}"
      purpose: "React app root"

knowledge_sources:
  specifications:
    - id: "wcag-21"
      name: "WCAG 2.1 Quick Reference"
      url: "https://www.w3.org/WAI/WCAG21/quickref/"
      offline_cache: true
      priority: "recommended"
    - id: "wcag21-311"
      name: "WCAG 2.1 Success Criterion 3.1.1 Language of Page"
      url: "https://www.w3.org/WAI/WCAG21/Understanding/language-of-page.html"
      offline_cache: true
      priority: "required"
    - id: "wcag21-312"
      name: "WCAG 2.1 Success Criterion 3.1.2 Language of Parts"
      url: "https://www.w3.org/WAI/WCAG21/Understanding/language-of-parts.html"
      offline_cache: true
      priority: "required"
    - id: "bcp47"
      name: "BCP 47 Language Tags"
      url: "https://www.ietf.org/rfc/bcp/bcp47.txt"
      offline_cache: true
      priority: "required"

  guides:
    - id: "w3c-lang"
      name: "W3C: Language on the Web"
      url: "https://www.w3.org/International/questions/qa-lang-why"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "axe-core"
      purpose: "Detect missing language declarations"
      offline_capable: true
    - tool: "htmlhint"
      purpose: "Validate lang attribute presence"
      offline_capable: true

  scripts:
    - id: "find-lang-attrs"
      language: "bash"
      purpose: "Find language attributes"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== HTML Lang Attribute ==="
        grep -rn "<html.*lang=" --include="*.html" . | head -10
        echo ""
        echo "=== Language Changes ==="
        grep -rn "lang=" --include="*.html" --include="*.jsx" --include="*.tsx" . | grep -v "<html" | head -20

signals:
  critical:
    - id: "A11Y-LANG-CRIT-001"
      signal: "Page missing lang attribute on html element"
      evidence_pattern: "<html> without lang attribute"
      explanation: |
        Without a lang attribute, screen readers cannot determine
        which language rules to use, causing mispronunciation.
      remediation: "Add lang='en' (or appropriate language code) to <html>"
    - id: "A11Y-LANG-CRIT-002"
      signal: "Invalid language tag used"
      evidence_pattern: "lang='english' or other invalid code"
      explanation: |
        Language tags must follow BCP 47 format (e.g., 'en', 'en-US').
        Invalid tags are ignored by assistive technology.
      remediation: "Use valid BCP 47 language codes"

  high:
    - id: "A11Y-LANG-HIGH-001"
      signal: "Language changes not marked"
      explanation: "Inline content in different languages needs lang attribute"
      remediation: "Add lang attribute to elements containing other languages"
    - id: "A11Y-LANG-HIGH-002"
      signal: "RTL language missing dir attribute"
      explanation: "Right-to-left languages need dir='rtl'"
      remediation: "Add dir='rtl' for Hebrew, Arabic, etc."
    - id: "A11Y-LANG-HIGH-003"
      signal: "Embedded iframe missing lang"
      explanation: "Embedded documents need language identification"
      remediation: "Ensure embedded content has lang attribute"

  medium:
    - id: "A11Y-LANG-MED-001"
      signal: "Language tag missing region code where helpful"
      remediation: "Consider adding region (en-US vs en-GB) for pronunciation"
    - id: "A11Y-LANG-MED-002"
      signal: "Language changes for common phrases unmarked"
      remediation: "Mark foreign phrases with appropriate lang"

  low:
    - id: "A11Y-LANG-LOW-001"
      signal: "Proper nouns in other languages unmarked"

  positive:
    - id: "A11Y-LANG-POS-001"
      signal: "Page has valid lang attribute"
    - id: "A11Y-LANG-POS-002"
      signal: "Language changes properly marked"
    - id: "A11Y-LANG-POS-003"
      signal: "RTL content has dir attribute"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Check Page-Level Language"
      description: |
        Verify the html element has a valid lang attribute.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find html lang attribute"
          command: "grep -rn '<html.*lang=' --include='*.html' . | head -10"
        - purpose: "Check Next.js document"
          command: "grep -rn 'Html.*lang\\|lang=' --include='_document*' . 2>/dev/null | head -5"
      expected_findings:
        - "Page language declaration"
        - "Language tag validity"

    - id: "2"
      name: "Validate Language Tags"
      description: |
        Verify all language tags are valid BCP 47 codes.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find all lang attributes"
          command: "grep -rn 'lang=[\"'\\']' --include='*.html' --include='*.jsx' --include='*.tsx' . | head -30"
      expected_findings:
        - "All language tags used"
        - "Invalid tags"

    - id: "3"
      name: "Identify Multi-Language Content"
      description: |
        Find content in languages different from page language.
      duration_estimate: "20 min"
      questions:
        - "Is there content in multiple languages?"
        - "Are foreign phrases present?"
        - "Are non-English proper nouns used?"
        - "Is there RTL content?"
      expected_findings:
        - "Multi-language content locations"
        - "Unmarked language changes"

    - id: "4"
      name: "Test with Screen Reader"
      description: |
        Verify screen reader pronounces content correctly
        based on language identification.
      duration_estimate: "20 min"
      questions:
        - "Does screen reader use correct voice/pronunciation?"
        - "Are language changes pronounced correctly?"
        - "Is RTL content read in correct direction?"
      expected_findings:
        - "Pronunciation accuracy"
        - "Screen reader behavior"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Page Language Analysis"
        - "Language Tag Validation"
        - "Multi-Language Content"
        - "Recommendations"

  confidence_guidance:
    high: "Verified with screen reader pronunciation"
    medium: "Code review with automated validation"
    low: "Automated scan only"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "wcag21-311"
        priority: "required"
      - source_id: "wcag21-312"
        priority: "required"

profiles:
  membership:
    quick:
      included: true
      priority: 2
      reason: "Lang attribute is quick to check and Level A"
    full:
      included: true
      priority: 1
    accessibility:
      included: true
      priority: 1

closeout_checklist:
  - id: "language-id-001"
    item: "HTML element has valid lang attribute"
    level: "CRITICAL"
    verification: "grep -r '<html' --include='*.html' . | grep -c 'lang='"
    expected: "> 0 with valid BCP 47 tag"

  - id: "language-id-002"
    item: "Language tags are valid BCP 47 codes"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Validate all lang attribute values"
    expected: "Confirmed by reviewer"

  - id: "language-id-003"
    item: "Language changes marked on inline content"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Check foreign phrases for lang attribute"
    expected: "Confirmed by reviewer"

  - id: "language-id-004"
    item: "RTL content has dir attribute"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Check Hebrew/Arabic content for dir='rtl'"
    expected: "Confirmed by reviewer or N/A"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "WCAG 2.1"
      controls: ["3.1.1", "3.1.2"]
    - framework: "Section 508"
      controls: ["1194.22"]
    - framework: "EN 301 549"
      controls: ["9.3.1.1", "9.3.1.2"]

relationships:
  commonly_combined:
    - "accessibility-inclusion.understandable-content.reading-level"
    - "accessibility-inclusion.understandable-content.abbreviation-explanation"
