# ============================================================
# AUDIT: Time Limit Adjustability - WCAG 2.1 Compliance
# ============================================================
# Verifies users can adjust, extend, or disable time limits
# per WCAG 2.1 Success Criterion 2.2.1.

audit:
  id: "accessibility-inclusion.operable-timing.time-limit-adjustability"
  name: "Time Limit Adjustability Audit"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "accessibility-inclusion"
  category_number: 15
  subcategory: "operable-timing"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "accessibility"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit verifies compliance with WCAG 2.1 SC 2.2.1 Timing
    Adjustable (Level A), ensuring users can turn off, adjust,
    or extend time limits.

    The audit covers:
    - Session timeouts
    - Form submission deadlines
    - Quiz and test time limits
    - Reservation hold periods
    - Auto-refreshing content
    - Countdown timers
    - Real-time competitive features
    - Live event deadlines

  why_it_matters: |
    Time limits can prevent users from completing tasks:

    - Users with cognitive disabilities need more time to read
    - Users with motor impairments take longer to input data
    - Screen reader users need more time to navigate
    - Users with attention disorders may need breaks
    - Anxiety conditions are worsened by time pressure

    Inflexible time limits exclude users who simply cannot
    work as fast as the system expects.

  when_to_run:
    - "When implementing session management"
    - "When adding timed features"
    - "Before accessibility compliance audits"
    - "When building assessment or quiz features"
    - "When implementing auto-refresh content"

prerequisites:
  required_artifacts:
    - type: "codebase"
      description: "Access to timer and session code"
    - type: "running_application"
      description: "Deployed instance for testing"

  access_requirements:
    - "Read access to JavaScript and configuration"
    - "Browser access for testing"
    - "Access to session management settings"

discovery:
  code_patterns:
    - pattern: "setTimeout|setInterval"
      type: "regex"
      scope: "source"
      purpose: "Find timer implementations"
    - pattern: "session.*timeout|timeout.*session"
      type: "regex"
      scope: "source"
      purpose: "Find session timeout settings"
    - pattern: "expires|expiry|expiration"
      type: "regex"
      scope: "source"
      purpose: "Find expiration logic"
    - pattern: "countdown|timer|deadline"
      type: "regex"
      scope: "source"
      purpose: "Find countdown implementations"
    - pattern: "auto.*refresh|refresh.*interval"
      type: "regex"
      scope: "source"
      purpose: "Find auto-refresh patterns"

  file_patterns:
    - glob: "**/session*.{js,ts}"
      purpose: "Session management code"
    - glob: "**/timer*.{js,ts,jsx,tsx}"
      purpose: "Timer components"
    - glob: "**/config*.{js,ts,json}"
      purpose: "Configuration files with timeouts"

knowledge_sources:
  specifications:
    - id: "wcag21-221"
      name: "WCAG 2.1 Success Criterion 2.2.1 Timing Adjustable"
      url: "https://www.w3.org/WAI/WCAG21/Understanding/timing-adjustable.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "w3c-timing"
      name: "W3C: Timing Adjustable Techniques"
      url: "https://www.w3.org/WAI/WCAG21/Techniques/general/G133"
      offline_cache: true
    - id: "webaim-timing"
      name: "WebAIM: Session Timeout"
      url: "https://webaim.org/articles/timeout/"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "custom eslint rule"
      purpose: "Detect hardcoded timeouts"
      offline_capable: true

  scripts:
    - id: "find-timeouts"
      language: "bash"
      purpose: "Find timeout implementations"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== setTimeout/setInterval ==="
        grep -rn "setTimeout\|setInterval" --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" . | head -30
        echo ""
        echo "=== Session Timeouts ==="
        grep -rn "session.*timeout\|timeout.*session\|expires" --include="*.js" --include="*.ts" --include="*.json" . | head -20

signals:
  critical:
    - id: "A11Y-TIME-CRIT-001"
      signal: "Session timeout with no warning or extension option"
      evidence_pattern: "Session expires without user notification"
      explanation: |
        Users lose all their work when sessions expire unexpectedly.
        Must warn 20 seconds before timeout and allow extension.
      remediation: "Add timeout warning with option to extend session"
    - id: "A11Y-TIME-CRIT-002"
      signal: "Form data lost on timeout without warning"
      evidence_pattern: "Form submission fails after timeout without saving"
      explanation: |
        Users who take longer to fill forms lose all entered data.
      remediation: "Persist form data, warn before timeout, allow extension"

  high:
    - id: "A11Y-TIME-HIGH-001"
      signal: "No option to disable or adjust time limits"
      explanation: "Users must be able to disable, adjust, or extend time limits"
      remediation: "Provide setting to turn off, adjust, or extend timing"
    - id: "A11Y-TIME-HIGH-002"
      signal: "Timeout warning period too short"
      explanation: "Warning must come at least 20 seconds before timeout"
      remediation: "Ensure 20-second minimum warning window"
    - id: "A11Y-TIME-HIGH-003"
      signal: "Cannot request additional time more than 10 times"
      explanation: "WCAG requires at least 10 extension opportunities"
      remediation: "Allow at least 10 time extensions or set limit to 20 hours"

  medium:
    - id: "A11Y-TIME-MED-001"
      signal: "Timeout warning not keyboard accessible"
      remediation: "Ensure timeout dialog can be used with keyboard"
    - id: "A11Y-TIME-MED-002"
      signal: "Timeout warning not announced to screen readers"
      remediation: "Use ARIA live region for timeout warnings"
    - id: "A11Y-TIME-MED-003"
      signal: "Default timeout too short for complex forms"
      remediation: "Increase default timeout for lengthy processes"

  low:
    - id: "A11Y-TIME-LOW-001"
      signal: "Timeout could be more generous"

  positive:
    - id: "A11Y-TIME-POS-001"
      signal: "Users can extend or disable time limits"
    - id: "A11Y-TIME-POS-002"
      signal: "Timeout warnings provided with accessible dialog"
    - id: "A11Y-TIME-POS-003"
      signal: "Form data persisted across timeout"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory All Time Limits"
      description: |
        Identify all time-limited features: session timeouts,
        form deadlines, quiz timers, etc.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find setTimeout/setInterval"
          command: "grep -rn 'setTimeout\\|setInterval' --include='*.js' --include='*.ts' . | head -50"
        - purpose: "Find session timeout config"
          command: "grep -rn 'timeout\\|expires\\|expir' --include='*.json' --include='*.env*' . | head -20"
        - purpose: "Find countdown components"
          command: "grep -rn 'countdown\\|timer\\|deadline' --include='*.jsx' --include='*.tsx' . | head -20"
      expected_findings:
        - "Complete time limit inventory"
        - "Timeout configuration locations"

    - id: "2"
      name: "Test Session Timeout Behavior"
      description: |
        Verify session timeout provides warning and extension.
      duration_estimate: "30 min"
      questions:
        - "What is the default session timeout?"
        - "Is there a warning before timeout?"
        - "How much warning time is given?"
        - "Can the user extend the session?"
        - "How many times can they extend?"
      expected_findings:
        - "Session timeout behavior"
        - "Warning mechanism details"

    - id: "3"
      name: "Test Form Time Limits"
      description: |
        Verify forms with time limits provide adjustment options.
      duration_estimate: "30 min"
      questions:
        - "Do any forms have time limits?"
        - "Is form data saved if timeout occurs?"
        - "Can time limits be extended?"
        - "Can time limits be disabled?"
      expected_findings:
        - "Form time limit behavior"
        - "Data persistence status"

    - id: "4"
      name: "Test Timer Warning Accessibility"
      description: |
        Verify timeout warnings are accessible to all users.
      duration_estimate: "30 min"
      questions:
        - "Is the warning dialog keyboard accessible?"
        - "Is the warning announced by screen readers?"
        - "Can users easily extend the session?"
        - "Does extension button have accessible name?"
      expected_findings:
        - "Warning accessibility status"
        - "Screen reader announcement"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Time Limit Inventory"
        - "Session Timeout Analysis"
        - "Form Time Limit Assessment"
        - "Warning Accessibility"
        - "Recommendations"

  confidence_guidance:
    high: "Tested with screen reader and keyboard"
    medium: "Runtime testing complete"
    low: "Code analysis only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "wcag21-221"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires timeout testing over extended period"
    full:
      included: true
      priority: 2
    accessibility:
      included: true
      priority: 1

closeout_checklist:
  - id: "time-limit-001"
    item: "Session timeout provides warning before expiration"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Test session timeout and verify warning appears"
    expected: "Confirmed by reviewer"

  - id: "time-limit-002"
    item: "Users can extend session at least 10 times"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Verify session extension option is available"
    expected: "Confirmed by reviewer"

  - id: "time-limit-003"
    item: "Timeout warning is keyboard and screen reader accessible"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Test warning dialog with keyboard and screen reader"
    expected: "Confirmed by reviewer"

  - id: "time-limit-004"
    item: "Users can turn off or adjust non-essential time limits"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Check for time limit settings"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "WCAG 2.1"
      controls: ["2.2.1"]
    - framework: "Section 508"
      controls: ["1194.22(p)"]
    - framework: "EN 301 549"
      controls: ["9.2.2.1"]

relationships:
  commonly_combined:
    - "accessibility-inclusion.operable-timing.no-timing-dependency"
    - "accessibility-inclusion.operable-timing.pause-stop-hide-control"
