# ============================================================
# AUDIT: Focus Order - WCAG 2.1 Compliance
# ============================================================
# Verifies keyboard focus moves in a logical, meaningful order
# per WCAG 2.1 Success Criterion 2.4.3.

audit:
  id: "accessibility-inclusion.operable-keyboard.focus-order"
  name: "Focus Order Audit"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "accessibility-inclusion"
  category_number: 15
  subcategory: "operable-keyboard"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "accessibility"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit verifies that focus order is logical and preserves
    meaning and operability per WCAG 2.1 SC 2.4.3 Focus Order (Level A).

    The audit covers:
    - Sequential navigation follows visual/logical order
    - DOM order matches visual presentation
    - Dynamically inserted content focus management
    - Modal and dialog focus handling
    - Tab panels and accordion focus patterns
    - Form field order matches visual layout
    - Multi-column layouts and grids
    - RTL (right-to-left) language considerations

  why_it_matters: |
    Illogical focus order confuses and disorients keyboard users:

    - Users build mental models of page structure while navigating
    - Unexpected focus jumps break comprehension
    - Important content may be skipped or reached too late
    - Form completion becomes frustrating and error-prone
    - Screen reader users lose context of their position

    Focus order issues affect all keyboard users including blind
    users, motor-impaired users, and power users.

  when_to_run:
    - "When implementing complex layouts"
    - "After CSS flexbox/grid reordering"
    - "When adding dynamic content"
    - "When implementing modals or dialogs"
    - "Before accessibility compliance audits"

prerequisites:
  required_artifacts:
    - type: "codebase"
      description: "Access to HTML/CSS code"
    - type: "running_application"
      description: "Deployed instance for testing"

  access_requirements:
    - "Read access to source code"
    - "Browser access for keyboard testing"

discovery:
  code_patterns:
    - pattern: "tabindex\\s*=\\s*['\"]?[1-9]"
      type: "regex"
      scope: "source"
      purpose: "Find positive tabindex that may disrupt order"
    - pattern: "order:\\s*[0-9]+|flex-direction:\\s*row-reverse|grid-auto-flow"
      type: "regex"
      scope: "source"
      purpose: "Find CSS that reorders elements visually"
    - pattern: "position:\\s*absolute|position:\\s*fixed"
      type: "regex"
      scope: "source"
      purpose: "Find positioned elements that may be out of DOM order"
    - pattern: "float:\\s*(left|right)"
      type: "regex"
      scope: "source"
      purpose: "Find floated elements affecting visual order"

  file_patterns:
    - glob: "**/*.css"
      purpose: "CSS layout files"
    - glob: "**/*.scss"
      purpose: "SCSS layout files"
    - glob: "**/layout*.{jsx,tsx}"
      purpose: "Layout components"

knowledge_sources:
  specifications:
    - id: "wcag-21"
      name: "WCAG 2.1 Quick Reference"
      url: "https://www.w3.org/WAI/WCAG21/quickref/"
      offline_cache: true
      priority: "recommended"
    - id: "wcag21-243"
      name: "WCAG 2.1 Success Criterion 2.4.3 Focus Order"
      url: "https://www.w3.org/WAI/WCAG21/Understanding/focus-order.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "mdn-focus-order"
      name: "MDN: Managing Focus Order"
      url: "https://developer.mozilla.org/en-US/docs/Web/Accessibility/Understanding_WCAG/Keyboard#Focus_order"
      offline_cache: true
    - id: "a11y-source-order"
      name: "A11Y: Source Order Matters"
      url: "https://adrianroselli.com/2015/09/source-order-matters.html"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "axe-core"
      purpose: "Detect focus order issues"
      offline_capable: true

  scripts:
    - id: "find-visual-reordering"
      language: "bash"
      purpose: "Find CSS that reorders elements"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== CSS Order Properties ==="
        grep -rn "order:\|flex-direction.*reverse\|direction.*rtl" --include="*.css" --include="*.scss" . | head -20
        echo ""
        echo "=== Positive Tabindex ==="
        grep -rn "tabindex=\"[1-9]" --include="*.html" --include="*.jsx" --include="*.tsx" . | head -20

signals:
  critical:
    - id: "A11Y-FOCUS-ORDER-CRIT-001"
      signal: "Focus order completely contradicts visual order"
      evidence_pattern: "Tab sequence jumps randomly across page"
      explanation: |
        When focus order is completely disconnected from visual order,
        keyboard users cannot navigate logically.
      remediation: "Restructure DOM to match visual presentation or use appropriate tabindex"
    - id: "A11Y-FOCUS-ORDER-CRIT-002"
      signal: "Important content unreachable via keyboard"
      evidence_pattern: "Critical interactive elements not in tab sequence"
      explanation: |
        Content that cannot be reached by tabbing is effectively
        inaccessible to keyboard users.
      remediation: "Ensure all interactive content is in the tab order"

  high:
    - id: "A11Y-FOCUS-ORDER-HIGH-001"
      signal: "Positive tabindex values disrupt natural order"
      explanation: "tabindex > 0 creates confusing tab sequences"
      remediation: "Remove positive tabindex; use DOM order instead"
    - id: "A11Y-FOCUS-ORDER-HIGH-002"
      signal: "CSS visual reordering not reflected in DOM"
      explanation: "Flexbox order or CSS direction changes don't affect tab order"
      remediation: "Match DOM order to visual order, or document navigation pattern"
    - id: "A11Y-FOCUS-ORDER-HIGH-003"
      signal: "Form fields out of logical sequence"
      explanation: "Form fields should follow logical completion order"
      remediation: "Reorder form fields in DOM to match expected completion sequence"

  medium:
    - id: "A11Y-FOCUS-ORDER-MED-001"
      signal: "Modal dialog focus not properly managed"
      remediation: "Focus first focusable element when modal opens"
    - id: "A11Y-FOCUS-ORDER-MED-002"
      signal: "Tab panels focus order confusing"
      remediation: "Implement ARIA tab panel focus pattern"
    - id: "A11Y-FOCUS-ORDER-MED-003"
      signal: "Dynamically added content out of logical order"
      remediation: "Insert dynamic content at appropriate DOM position"

  low:
    - id: "A11Y-FOCUS-ORDER-LOW-001"
      signal: "Focus order could be more intuitive"

  positive:
    - id: "A11Y-FOCUS-ORDER-POS-001"
      signal: "Focus order matches visual and logical flow"
    - id: "A11Y-FOCUS-ORDER-POS-002"
      signal: "No positive tabindex values used"
    - id: "A11Y-FOCUS-ORDER-POS-003"
      signal: "Dynamic content properly integrated into focus order"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Check for Visual Reordering"
      description: |
        Search for CSS properties that visually reorder
        elements without changing DOM order.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find flexbox/grid reordering"
          command: "grep -rn 'order:\\|flex-direction.*reverse\\|grid-auto-flow' --include='*.css' --include='*.scss' ."
        - purpose: "Find RTL direction changes"
          command: "grep -rn 'direction:\\s*rtl' --include='*.css' . | head -10"
        - purpose: "Find tabindex usage"
          command: "grep -rn 'tabindex' --include='*.html' --include='*.jsx' --include='*.tsx' . | head -30"
      expected_findings:
        - "Visual reordering instances"
        - "Potential mismatches"

    - id: "2"
      name: "Tab Through Application"
      description: |
        Systematically tab through the application, comparing
        focus order to visual presentation.
      duration_estimate: "60 min"
      questions:
        - "Does focus move left-to-right, top-to-bottom (in LTR layouts)?"
        - "Are there unexpected focus jumps?"
        - "Is form field order logical?"
        - "Does navigation focus follow visual menu order?"
        - "Do multi-column layouts tab in reading order?"
      expected_findings:
        - "Focus order discrepancies"
        - "Illogical sequences"

    - id: "3"
      name: "Test Dynamic Content"
      description: |
        Verify focus handling when content is dynamically
        added or removed.
      duration_estimate: "30 min"
      questions:
        - "When modal opens, where does focus go?"
        - "When modal closes, where does focus return?"
        - "When content is added dynamically, is it in logical order?"
        - "When content is removed, where does focus go?"
      expected_findings:
        - "Dynamic focus handling issues"
        - "Missing focus management"

    - id: "4"
      name: "Document Focus Flow"
      description: |
        Create a focus order map documenting the expected
        vs actual navigation sequence.
      duration_estimate: "30 min"
      expected_findings:
        - "Focus order documentation"
        - "Remediation priorities"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Focus Order Analysis"
        - "Visual vs DOM Order Comparison"
        - "Dynamic Content Focus Handling"
        - "Recommendations"

  confidence_guidance:
    high: "Complete keyboard testing with visual comparison"
    medium: "Sample testing with code analysis"
    low: "Code pattern analysis only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "wcag21-243"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires thorough keyboard navigation testing"
    full:
      included: true
      priority: 2
    accessibility:
      included: true
      priority: 1

closeout_checklist:
  - id: "focus-order-001"
    item: "Focus order matches visual/logical order"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Tab through application and compare to visual layout"
    expected: "Confirmed by reviewer"

  - id: "focus-order-002"
    item: "No positive tabindex values (except tabindex='0')"
    level: "BLOCKING"
    verification: "grep -r 'tabindex=\"[1-9]' --include='*.jsx' --include='*.tsx' --include='*.html' . | wc -l"
    expected: "0"

  - id: "focus-order-003"
    item: "CSS visual reordering accounted for"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Verify elements using CSS order have appropriate DOM structure"
    expected: "Confirmed by reviewer"

  - id: "focus-order-004"
    item: "Modal/dialog focus properly managed"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Test focus when opening and closing dialogs"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "WCAG 2.1"
      controls: ["2.4.3"]
    - framework: "Section 508"
      controls: ["1194.21(a)"]
    - framework: "EN 301 549"
      controls: ["9.2.4.3"]

relationships:
  commonly_combined:
    - "accessibility-inclusion.operable-keyboard.full-keyboard-navigation"
    - "accessibility-inclusion.operable-keyboard.focus-trap-prevention"
    - "accessibility-inclusion.perceivable-visual.focus-indicator-visibility"
