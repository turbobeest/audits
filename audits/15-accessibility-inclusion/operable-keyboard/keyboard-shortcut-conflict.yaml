# ============================================================
# AUDIT: Keyboard Shortcut Conflicts - WCAG 2.1 Compliance
# ============================================================
# Verifies keyboard shortcuts don't conflict with assistive
# technology or can be disabled per WCAG 2.1 SC 2.1.4.

audit:
  id: "accessibility-inclusion.operable-keyboard.keyboard-shortcut-conflict"
  name: "Keyboard Shortcut Conflict Audit"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "accessibility-inclusion"
  category_number: 15
  subcategory: "operable-keyboard"

  tier: "expert"
  estimated_duration: "1-2 hours"  # median: 1h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "accessibility"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit verifies keyboard shortcuts comply with WCAG 2.1
    SC 2.1.4 Character Key Shortcuts (Level A), ensuring single-
    character shortcuts can be turned off or remapped.

    The audit covers:
    - Single-character keyboard shortcuts (letters, numbers, symbols)
    - Application-defined shortcuts
    - Shortcuts that may conflict with screen readers
    - Shortcuts that may conflict with voice control
    - Mechanism to disable or remap shortcuts
    - Modifier key combinations (Ctrl, Alt, Shift)
    - Platform-specific shortcut conventions

  why_it_matters: |
    Single-character keyboard shortcuts create significant problems:

    - Screen readers use letter keys for navigation commands
    - Voice control users may accidentally trigger shortcuts
    - Users with motor impairments may accidentally press keys
    - Speech-to-text can activate unintended shortcuts

    These conflicts can make applications completely unusable
    for assistive technology users.

  when_to_run:
    - "When implementing keyboard shortcuts"
    - "After JavaScript library updates"
    - "Before accessibility compliance audits"
    - "When adding hotkey functionality"
    - "When integrating keyboard navigation"

prerequisites:
  required_artifacts:
    - type: "codebase"
      description: "Access to JavaScript and keyboard handling code"
    - type: "running_application"
      description: "Deployed instance for testing"

  access_requirements:
    - "Read access to source code"
    - "Browser access for testing"
    - "Screen reader for conflict testing"

discovery:
  code_patterns:
    - pattern: "keydown|keypress|keyup"
      type: "regex"
      scope: "source"
      purpose: "Find keyboard event handlers"
    - pattern: "key\\s*===?\\s*['\"][a-zA-Z0-9]['\"]"
      type: "regex"
      scope: "source"
      purpose: "Find single-character key checks"
    - pattern: "hotkey|shortcut|keybind"
      type: "regex"
      scope: "source"
      purpose: "Find hotkey implementations"
    - pattern: "mousetrap|hotkeys|keymaster"
      type: "regex"
      scope: "source"
      purpose: "Find keyboard shortcut libraries"
    - pattern: "e\\.key\\s*===\\s*['\"][a-zA-Z]['\"]"
      type: "regex"
      scope: "source"
      purpose: "Find single letter key handlers"

  file_patterns:
    - glob: "**/keyboard*.{js,ts}"
      purpose: "Keyboard handling files"
    - glob: "**/shortcut*.{js,ts}"
      purpose: "Shortcut implementation files"
    - glob: "**/hotkey*.{js,ts}"
      purpose: "Hotkey implementation files"

knowledge_sources:
  specifications:
    - id: "wcag-21"
      name: "WCAG 2.1 Quick Reference"
      url: "https://www.w3.org/WAI/WCAG21/quickref/"
      offline_cache: true
      priority: "recommended"
    - id: "wcag21-214"
      name: "WCAG 2.1 Success Criterion 2.1.4 Character Key Shortcuts"
      url: "https://www.w3.org/WAI/WCAG21/Understanding/character-key-shortcuts.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "w3c-shortcuts"
      name: "W3C: Character Key Shortcut Techniques"
      url: "https://www.w3.org/WAI/WCAG21/Techniques/general/G217"
      offline_cache: true
    - id: "adrianroselli-shortcuts"
      name: "Adrian Roselli: Don't Use Keyboard Shortcuts"
      url: "https://adrianroselli.com/2020/08/dont-use-keyboard-shortcuts.html"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "eslint"
      purpose: "Custom rules for keyboard shortcut patterns"
      offline_capable: true

  scripts:
    - id: "find-keyboard-shortcuts"
      language: "bash"
      purpose: "Find keyboard shortcut implementations"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Keyboard Event Handlers ==="
        grep -rn "addEventListener.*keydown\|onKeyDown" --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" . | head -30
        echo ""
        echo "=== Single Key Checks ==="
        grep -rn "key.*===.*['\"][a-zA-Z]['\"]" --include="*.js" --include="*.ts" . | head -20

signals:
  critical:
    - id: "A11Y-SHORTCUT-CRIT-001"
      signal: "Single-character shortcuts active without focus requirement"
      evidence_pattern: "Document-level keydown listener for single letters"
      explanation: |
        Single-character shortcuts that work without focus on a
        specific element will conflict with screen readers and
        voice control software.
      remediation: "Require modifier key, restrict to focused element, or allow disabling"
    - id: "A11Y-SHORTCUT-CRIT-002"
      signal: "No mechanism to disable or remap shortcuts"
      evidence_pattern: "Hard-coded shortcuts without settings option"
      explanation: |
        Users must be able to turn off or remap character key
        shortcuts that interfere with their assistive technology.
      remediation: "Provide settings to disable or remap shortcuts"

  high:
    - id: "A11Y-SHORTCUT-HIGH-001"
      signal: "Shortcuts conflict with common screen reader commands"
      explanation: "Letters like H, T, B, L are used by screen readers for navigation"
      remediation: "Use modifier keys (Ctrl+H) or allow remapping"
    - id: "A11Y-SHORTCUT-HIGH-002"
      signal: "Shortcuts conflict with voice control phrases"
      explanation: "Single letters can be triggered by speech recognition"
      remediation: "Require intentional activation or allow disabling"
    - id: "A11Y-SHORTCUT-HIGH-003"
      signal: "Escape key overridden in non-modal context"
      explanation: "Escape key has expected behaviors users rely on"
      remediation: "Only override Escape in modal contexts"

  medium:
    - id: "A11Y-SHORTCUT-MED-001"
      signal: "Shortcuts not documented accessibly"
      remediation: "Provide accessible documentation of all shortcuts"
    - id: "A11Y-SHORTCUT-MED-002"
      signal: "Remapping mechanism not keyboard accessible"
      remediation: "Ensure shortcut settings are keyboard accessible"
    - id: "A11Y-SHORTCUT-MED-003"
      signal: "Shortcuts inconsistent across application"
      remediation: "Standardize shortcut patterns"

  low:
    - id: "A11Y-SHORTCUT-LOW-001"
      signal: "Shortcut could use more intuitive key combination"

  positive:
    - id: "A11Y-SHORTCUT-POS-001"
      signal: "All shortcuts use modifier keys"
    - id: "A11Y-SHORTCUT-POS-002"
      signal: "Shortcuts can be disabled in settings"
    - id: "A11Y-SHORTCUT-POS-003"
      signal: "Shortcuts only active when component focused"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Keyboard Shortcuts"
      description: |
        Search codebase for all keyboard shortcut implementations.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find keyboard listeners"
          command: "grep -rn 'keydown\\|keypress\\|keyup' --include='*.js' --include='*.ts' --include='*.jsx' --include='*.tsx' . | head -50"
        - purpose: "Find key comparison"
          command: "grep -rn 'key\\s*===\\|keyCode\\s*===' --include='*.js' --include='*.ts' . | head -30"
        - purpose: "Find shortcut libraries"
          command: "grep -rn 'mousetrap\\|hotkeys\\|keymaster' --include='*.json' --include='*.js' ."
      expected_findings:
        - "Complete shortcut inventory"
        - "Shortcut implementation patterns"

    - id: "2"
      name: "Identify Single-Character Shortcuts"
      description: |
        Identify shortcuts that use only a single character
        without modifier keys.
      duration_estimate: "20 min"
      questions:
        - "Are there shortcuts using single letters?"
        - "Are there shortcuts using single numbers?"
        - "Are there shortcuts using symbols without modifiers?"
        - "Do shortcuts work globally or only when focused?"
      expected_findings:
        - "Single-character shortcut list"
        - "Scope of shortcut activation"

    - id: "3"
      name: "Test with Screen Reader"
      description: |
        Test keyboard shortcuts while screen reader is active
        to identify conflicts.
      duration_estimate: "30 min"
      questions:
        - "Do shortcuts conflict with NVDA/JAWS quick keys?"
        - "Do shortcuts conflict with VoiceOver commands?"
        - "Can screen reader users navigate without triggering shortcuts?"
      expected_findings:
        - "Screen reader conflicts"
        - "Affected shortcuts"

    - id: "4"
      name: "Verify Disable/Remap Option"
      description: |
        Check if users can disable or remap conflicting shortcuts.
      duration_estimate: "20 min"
      questions:
        - "Is there a settings page for shortcuts?"
        - "Can individual shortcuts be disabled?"
        - "Can shortcuts be remapped to different keys?"
        - "Is the settings page keyboard accessible?"
      expected_findings:
        - "Shortcut customization options"
        - "Accessibility of settings"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Keyboard Shortcut Inventory"
        - "Single-Character Shortcut Analysis"
        - "Assistive Technology Conflict Report"
        - "Recommendations"

  confidence_guidance:
    high: "Tested with screen reader and voice control"
    medium: "Code analysis with keyboard testing"
    low: "Code pattern analysis only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "wcag21-214"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires shortcut inventory and AT testing"
    full:
      included: true
      priority: 2
    accessibility:
      included: true
      priority: 1

closeout_checklist:
  - id: "shortcut-conflict-001"
    item: "Single-character shortcuts can be turned off or remapped"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify settings exist for disabling/remapping single-key shortcuts"
    expected: "Confirmed by reviewer"

  - id: "shortcut-conflict-002"
    item: "Shortcuts don't conflict with screen reader commands"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Test shortcuts with NVDA/VoiceOver active"
    expected: "Confirmed by reviewer"

  - id: "shortcut-conflict-003"
    item: "Shortcuts only active when component has focus"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Verify shortcuts don't fire when typing in text fields"
    expected: "Confirmed by reviewer or uses modifier keys"

  - id: "shortcut-conflict-004"
    item: "Shortcut documentation is accessible"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Check for accessible shortcut reference"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "WCAG 2.1"
      controls: ["2.1.4"]
    - framework: "EN 301 549"
      controls: ["9.2.1.4"]

relationships:
  commonly_combined:
    - "accessibility-inclusion.operable-keyboard.full-keyboard-navigation"
    - "accessibility-inclusion.operable-keyboard.focus-trap-prevention"
