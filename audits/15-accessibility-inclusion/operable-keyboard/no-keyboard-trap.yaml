# ============================================================
# AUDIT: No Keyboard Trap (Comprehensive) - WCAG 2.1 Compliance
# ============================================================
# Comprehensive audit ensuring no keyboard traps exist anywhere
# in the application per WCAG 2.1 SC 2.1.2.

audit:
  id: "accessibility-inclusion.operable-keyboard.no-keyboard-trap"
  name: "No Keyboard Trap Comprehensive Audit"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "accessibility-inclusion"
  category_number: 15
  subcategory: "operable-keyboard"

  tier: "expert"
  estimated_duration: "2-4 hours"  # median: 3h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "codebase"

  default_profiles:
    - "full"
    - "accessibility"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This comprehensive audit systematically tests every part of the
    application for keyboard traps per WCAG 2.1 SC 2.1.2 No Keyboard
    Trap (Level A).

    The audit covers:
    - Page-level navigation flow
    - All embedded content (iframes, videos, plugins)
    - All custom interactive widgets
    - All third-party integrations
    - All modal and overlay patterns
    - All form components
    - All editor components (rich text, code, etc.)
    - All canvas and interactive graphics
    - Browser-level keyboard accessibility

  why_it_matters: |
    Keyboard traps are among the most severe accessibility barriers:

    - Completely blocks keyboard users from proceeding
    - Often requires closing browser to escape
    - Loses all user work and context
    - Makes application entirely unusable
    - Creates frustration and abandonment
    - Violates Level A (baseline) WCAG compliance

    Even a single keyboard trap can render an entire application
    inaccessible for keyboard users.

  when_to_run:
    - "Pre-launch accessibility review"
    - "After major feature additions"
    - "When adding embedded content"
    - "During accessibility compliance audits"
    - "After integrating third-party components"

prerequisites:
  required_artifacts:
    - type: "codebase"
      description: "Access to all source code"
    - type: "running_application"
      description: "Deployed instance for comprehensive testing"
    - type: "sitemap"
      description: "List of all pages/routes to test"

  access_requirements:
    - "Read access to source code"
    - "Browser access for testing"
    - "List of all application routes"

discovery:
  code_patterns:
    - pattern: "<iframe|<embed|<object"
      type: "regex"
      scope: "source"
      purpose: "Find embedded content"
    - pattern: "contenteditable|designMode"
      type: "regex"
      scope: "source"
      purpose: "Find editable regions"
    - pattern: "focusTrap|trap.*focus|focus.*trap"
      type: "regex"
      scope: "source"
      purpose: "Find focus trapping code"
    - pattern: "preventDefault.*key|key.*preventDefault"
      type: "regex"
      scope: "source"
      purpose: "Find keyboard event prevention"
    - pattern: "Modal|Dialog|Overlay|Popup"
      type: "regex"
      scope: "source"
      purpose: "Find modal components"

  file_patterns:
    - glob: "**/*.{jsx,tsx,vue,svelte}"
      purpose: "Component files"
    - glob: "**/pages/**/*.{jsx,tsx}"
      purpose: "Page components"
    - glob: "**/routes/**"
      purpose: "Route definitions"

knowledge_sources:
  specifications:
    - id: "wcag-21"
      name: "WCAG 2.1 Quick Reference"
      url: "https://www.w3.org/WAI/WCAG21/quickref/"
      offline_cache: true
      priority: "recommended"
    - id: "wcag21-212"
      name: "WCAG 2.1 Success Criterion 2.1.2 No Keyboard Trap"
      url: "https://www.w3.org/WAI/WCAG21/Understanding/no-keyboard-trap.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "w3c-trap-techniques"
      name: "W3C: Techniques for No Keyboard Trap"
      url: "https://www.w3.org/WAI/WCAG21/Techniques/general/G21"
      offline_cache: true
    - id: "deque-trap"
      name: "Deque: Keyboard Traps"
      url: "https://dequeuniversity.com/rules/axe/4.7/keyboard-trap"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "axe-core"
      purpose: "Automated keyboard trap detection"
      offline_capable: true

  scripts:
    - id: "comprehensive-trap-check"
      language: "bash"
      purpose: "Find all potential keyboard trap sources"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Embedded Content ==="
        grep -rn "<iframe\|<embed\|<object" --include="*.html" --include="*.jsx" --include="*.tsx" . | head -20
        echo ""
        echo "=== Editable Regions ==="
        grep -rn "contenteditable\|designMode" --include="*.html" --include="*.jsx" . | head -15
        echo ""
        echo "=== Modal/Dialog Components ==="
        grep -rln "Modal\|Dialog\|Overlay" --include="*.jsx" --include="*.tsx" . | head -15
        echo ""
        echo "=== Focus Trapping ==="
        grep -rn "focusTrap\|trapFocus" --include="*.js" --include="*.ts" . | head -15

signals:
  critical:
    - id: "A11Y-NOTRAP-CRIT-001"
      signal: "Confirmed keyboard trap found"
      evidence_pattern: "Component where Tab cycles and Escape doesn't work"
      explanation: |
        A keyboard trap prevents users from continuing to use
        the application and violates Level A compliance.
      remediation: "Implement escape mechanism (Tab, Escape, or documented alternative)"
    - id: "A11Y-NOTRAP-CRIT-002"
      signal: "Third-party widget creates keyboard trap"
      evidence_pattern: "Embedded widget that captures and holds focus"
      explanation: |
        Third-party content must also be keyboard navigable.
      remediation: "Replace widget, configure widget, or provide escape instructions"

  high:
    - id: "A11Y-NOTRAP-HIGH-001"
      signal: "Potential trap in untested browser/OS combination"
      explanation: "Traps may manifest differently across environments"
      remediation: "Test across major browsers and operating systems"
    - id: "A11Y-NOTRAP-HIGH-002"
      signal: "Dynamic content creates trap when loaded"
      explanation: "Lazily loaded content may trap focus"
      remediation: "Ensure dynamic content maintains keyboard accessibility"
    - id: "A11Y-NOTRAP-HIGH-003"
      signal: "Error state creates unexpected trap"
      explanation: "Error handling may inadvertently trap focus"
      remediation: "Test error states for keyboard accessibility"

  medium:
    - id: "A11Y-NOTRAP-MED-001"
      signal: "Escape mechanism requires non-standard key"
      remediation: "Document escape mechanism clearly"
    - id: "A11Y-NOTRAP-MED-002"
      signal: "Multiple Tab presses needed to escape"
      remediation: "Provide more efficient escape mechanism"

  low:
    - id: "A11Y-NOTRAP-LOW-001"
      signal: "Escape could be more intuitive"

  positive:
    - id: "A11Y-NOTRAP-POS-001"
      signal: "No keyboard traps found in comprehensive test"
    - id: "A11Y-NOTRAP-POS-002"
      signal: "All modals properly trap and release focus"
    - id: "A11Y-NOTRAP-POS-003"
      signal: "All embedded content keyboard navigable"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Create Complete Component Inventory"
      description: |
        List all components that could potentially trap keyboard:
        embeds, editors, modals, widgets, third-party content.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find all potential trap sources"
          command: "grep -rln '<iframe\\|contenteditable\\|Modal\\|Dialog\\|Overlay\\|Editor' --include='*.jsx' --include='*.tsx' --include='*.html' . | sort | uniq"
      expected_findings:
        - "Complete inventory of testable components"
        - "Third-party integrations"

    - id: "2"
      name: "Systematic Page-by-Page Testing"
      description: |
        Test every page/route for keyboard traps by tabbing
        through all content.
      duration_estimate: "90 min"
      questions:
        - "Can you Tab through the entire page?"
        - "Can you Tab away from every interactive element?"
        - "Does Escape work where expected?"
        - "Can you exit all embedded content?"
      expected_findings:
        - "Traps found by page"
        - "Components causing traps"

    - id: "3"
      name: "Test All Modal/Dialog Components"
      description: |
        Verify every modal traps focus appropriately and
        releases on close.
      duration_estimate: "30 min"
      questions:
        - "Does focus enter modal on open?"
        - "Does Tab cycle within modal?"
        - "Does Escape close modal?"
        - "Does focus return to trigger on close?"
      expected_findings:
        - "Modal focus management status"
        - "Trapping/releasing behavior"

    - id: "4"
      name: "Test All Embedded Content"
      description: |
        Test iframes, videos, maps, and third-party widgets.
      duration_estimate: "30 min"
      questions:
        - "Can you Tab into and out of iframes?"
        - "Can you exit video players?"
        - "Can you escape map widgets?"
        - "Are social embeds navigable?"
      expected_findings:
        - "Embedded content accessibility"
        - "Third-party issues"

    - id: "5"
      name: "Cross-Browser Testing"
      description: |
        Test for traps across different browsers as behavior
        may vary.
      duration_estimate: "30 min"
      questions:
        - "Does Chrome exhibit any traps?"
        - "Does Firefox exhibit any traps?"
        - "Does Safari exhibit any traps?"
        - "Does Edge exhibit any traps?"
      expected_findings:
        - "Browser-specific issues"
        - "Universal vs conditional traps"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Complete Trap Test Results"
        - "Page-by-Page Analysis"
        - "Modal/Dialog Assessment"
        - "Embedded Content Report"
        - "Cross-Browser Results"
        - "Remediation Priority List"

  confidence_guidance:
    high: "Complete systematic testing across browsers"
    medium: "Single browser comprehensive test"
    low: "Sample testing with code analysis"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "wcag21-212"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive systematic testing"
    full:
      included: true
      priority: 1
    accessibility:
      included: true
      priority: 1

closeout_checklist:
  - id: "no-trap-001"
    item: "No keyboard traps exist in application"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Complete systematic keyboard testing of all pages"
    expected: "Confirmed by reviewer"

  - id: "no-trap-002"
    item: "All modals allow keyboard escape"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Test Escape and Tab on all modal components"
    expected: "Confirmed by reviewer"

  - id: "no-trap-003"
    item: "All embedded content keyboard navigable"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Test all iframes and third-party widgets"
    expected: "Confirmed by reviewer"

  - id: "no-trap-004"
    item: "Tested across major browsers"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Chrome, Firefox, Safari, Edge testing completed"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "WCAG 2.1"
      controls: ["2.1.2"]
    - framework: "Section 508"
      controls: ["1194.21(a)"]
    - framework: "EN 301 549"
      controls: ["9.2.1.2", "11.2.1.2"]

relationships:
  commonly_combined:
    - "accessibility-inclusion.operable-keyboard.focus-trap-prevention"
    - "accessibility-inclusion.operable-keyboard.full-keyboard-navigation"
    - "accessibility-inclusion.operable-keyboard.focus-order"
