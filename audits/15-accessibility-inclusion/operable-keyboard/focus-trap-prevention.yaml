# ============================================================
# AUDIT: Focus Trap Prevention - WCAG 2.1 Compliance
# ============================================================
# Verifies users are not trapped in content sections
# per WCAG 2.1 Success Criterion 2.1.2.

audit:
  id: "accessibility-inclusion.operable-keyboard.focus-trap-prevention"
  name: "Focus Trap Prevention Audit"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "accessibility-inclusion"
  category_number: 15
  subcategory: "operable-keyboard"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "codebase"

  default_profiles:
    - "full"
    - "accessibility"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit verifies users can navigate away from any component
    using standard keyboard mechanisms per WCAG 2.1 SC 2.1.2
    No Keyboard Trap (Level A).

    The audit covers:
    - Embedded content (iframes, plugins)
    - Rich text editors
    - Code editors
    - Custom widgets that capture keyboard input
    - Modal dialogs (intentional focus trapping)
    - Canvas elements
    - PDF viewers and document embeds
    - Third-party widgets
    - Auto-complete and suggestion interfaces

  why_it_matters: |
    A keyboard trap makes it impossible for keyboard users to
    continue navigating or leave a component:

    - Users become stuck with no way to proceed
    - The only escape may be closing the browser
    - Loses all unsaved work and context
    - Makes the entire application unusable
    - Is one of the most severe accessibility failures

    Note: Intentional focus trapping in modals is acceptable when
    Escape key or explicit close button is provided.

  when_to_run:
    - "When implementing embedded content"
    - "When adding rich text or code editors"
    - "When implementing modals or overlays"
    - "When integrating third-party widgets"
    - "Before accessibility compliance audits"

prerequisites:
  required_artifacts:
    - type: "codebase"
      description: "Access to component and embed code"
    - type: "running_application"
      description: "Deployed instance for testing"

  access_requirements:
    - "Read access to source code"
    - "Browser access for keyboard testing"

discovery:
  code_patterns:
    - pattern: "<iframe"
      type: "regex"
      scope: "source"
      purpose: "Find embedded iframes"
    - pattern: "<embed|<object"
      type: "regex"
      scope: "source"
      purpose: "Find embedded objects/plugins"
    - pattern: "contenteditable"
      type: "regex"
      scope: "source"
      purpose: "Find editable regions"
    - pattern: "focus.*trap|trapFocus|focusTrap"
      type: "regex"
      scope: "source"
      purpose: "Find intentional focus trapping code"
    - pattern: "e\\.preventDefault\\(\\)|event\\.preventDefault\\(\\)"
      type: "regex"
      scope: "source"
      purpose: "Find potential keyboard event interception"

  file_patterns:
    - glob: "**/editor*.{jsx,tsx}"
      purpose: "Editor components"
    - glob: "**/modal*.{jsx,tsx}"
      purpose: "Modal components"
    - glob: "**/embed*.{jsx,tsx}"
      purpose: "Embed components"

knowledge_sources:
  specifications:
    - id: "wcag-21"
      name: "WCAG 2.1 Quick Reference"
      url: "https://www.w3.org/WAI/WCAG21/quickref/"
      offline_cache: true
      priority: "recommended"
    - id: "wcag21-212"
      name: "WCAG 2.1 Success Criterion 2.1.2 No Keyboard Trap"
      url: "https://www.w3.org/WAI/WCAG21/Understanding/no-keyboard-trap.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "w3c-trap"
      name: "W3C: Understanding No Keyboard Trap"
      url: "https://www.w3.org/WAI/WCAG21/Techniques/general/G21"
      offline_cache: true
    - id: "aria-modal"
      name: "WAI-ARIA: Modal Dialog Example"
      url: "https://www.w3.org/WAI/ARIA/apg/patterns/dialog-modal/"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "axe-core"
      purpose: "Detect potential keyboard traps"
      offline_capable: true

  scripts:
    - id: "find-trapping-patterns"
      language: "bash"
      purpose: "Find patterns that may trap focus"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Iframes ==="
        grep -rn "<iframe" --include="*.html" --include="*.jsx" --include="*.tsx" . | head -20
        echo ""
        echo "=== Contenteditable ==="
        grep -rn "contenteditable" --include="*.html" --include="*.jsx" . | head -20
        echo ""
        echo "=== Focus Trapping Code ==="
        grep -rn "focusTrap\|trapFocus" --include="*.js" --include="*.ts" . | head -20

signals:
  critical:
    - id: "A11Y-TRAP-CRIT-001"
      signal: "Component traps keyboard focus with no escape"
      evidence_pattern: "Tab cycles within component, Escape doesn't work"
      explanation: |
        When users cannot leave a component using standard keyboard
        navigation (Tab, Escape), they are completely trapped.
      remediation: "Provide Tab or Escape key to exit component, document if non-standard"
    - id: "A11Y-TRAP-CRIT-002"
      signal: "Iframe or embed traps keyboard"
      evidence_pattern: "Third-party content prevents keyboard exit"
      explanation: |
        Embedded content from other sources may not respect
        keyboard navigation, trapping users.
      remediation: "Provide escape mechanism or keyboard instructions"

  high:
    - id: "A11Y-TRAP-HIGH-001"
      signal: "Rich text editor traps Tab key"
      explanation: "Tab in editors should insert content, but escape must be possible"
      remediation: "Provide Escape or Ctrl+Shift+Tab to exit editor"
    - id: "A11Y-TRAP-HIGH-002"
      signal: "Modal prevents browser keyboard shortcuts"
      explanation: "Focus trapping should not prevent browser functions"
      remediation: "Allow browser shortcuts (F6, Ctrl+L) to work"
    - id: "A11Y-TRAP-HIGH-003"
      signal: "Escape key doesn't close modal"
      explanation: "Users expect Escape to close dialogs"
      remediation: "Implement Escape key handler to close modal"

  medium:
    - id: "A11Y-TRAP-MED-001"
      signal: "Escape method not documented"
      remediation: "Document how to exit non-standard components"
    - id: "A11Y-TRAP-MED-002"
      signal: "Third-party widget may trap in some browsers"
      remediation: "Test across browsers or provide instructions"
    - id: "A11Y-TRAP-MED-003"
      signal: "Canvas element captures keyboard without escape"
      remediation: "Add visible button or Escape key to exit canvas mode"

  low:
    - id: "A11Y-TRAP-LOW-001"
      signal: "Escape mechanism could be clearer"

  positive:
    - id: "A11Y-TRAP-POS-001"
      signal: "All components allow keyboard exit"
    - id: "A11Y-TRAP-POS-002"
      signal: "Modals properly trap and release focus"
    - id: "A11Y-TRAP-POS-003"
      signal: "Editors provide documented escape mechanism"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify Potential Trap Sources"
      description: |
        Search for components that might trap keyboard focus:
        iframes, editors, modals, embedded content.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find iframes"
          command: "grep -rn '<iframe' --include='*.html' --include='*.jsx' --include='*.tsx' ."
        - purpose: "Find editors and contenteditable"
          command: "grep -rn 'contenteditable\\|editor\\|CodeMirror\\|Monaco' --include='*.jsx' --include='*.tsx' . | head -30"
        - purpose: "Find modal implementations"
          command: "grep -rn 'Modal\\|Dialog\\|Overlay' --include='*.jsx' --include='*.tsx' . | head -30"
      expected_findings:
        - "List of potential trap sources"
        - "Focus trapping implementations"

    - id: "2"
      name: "Test Keyboard Escape"
      description: |
        For each potential trap, verify keyboard exit is possible.
      duration_estimate: "60 min"
      questions:
        - "Can you Tab out of the component?"
        - "Does Escape key exit or close the component?"
        - "Are keyboard shortcuts documented if non-standard?"
        - "Does the component cycle focus or truly trap it?"
      expected_findings:
        - "Components that trap focus"
        - "Available escape mechanisms"

    - id: "3"
      name: "Test Modal Focus Management"
      description: |
        Verify modals trap focus appropriately and release
        it when closed.
      duration_estimate: "30 min"
      questions:
        - "Does opening modal move focus into modal?"
        - "Does Tab cycle within modal (not escape to background)?"
        - "Does Escape key close the modal?"
        - "Does closing modal return focus to trigger element?"
      expected_findings:
        - "Modal focus behavior"
        - "Focus restoration issues"

    - id: "4"
      name: "Test Third-Party Embeds"
      description: |
        Test embedded third-party content for keyboard traps.
      duration_estimate: "30 min"
      questions:
        - "Can you Tab into and out of embedded content?"
        - "Are there any iframes that trap focus?"
        - "Do embedded maps or players trap keyboard?"
      expected_findings:
        - "Third-party keyboard issues"
        - "Mitigation requirements"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Potential Trap Inventory"
        - "Keyboard Escape Testing Results"
        - "Modal Focus Management"
        - "Third-Party Embed Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Complete keyboard testing of all potential traps"
    medium: "Sample testing with code analysis"
    low: "Code pattern analysis only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "wcag21-212"
        priority: "required"

profiles:
  membership:
    quick:
      included: true
      priority: 1
      reason: "Keyboard traps are critical failures"
    full:
      included: true
      priority: 1
    accessibility:
      included: true
      priority: 1

closeout_checklist:
  - id: "focus-trap-001"
    item: "No components trap keyboard focus indefinitely"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Test all iframes, editors, modals for keyboard exit"
    expected: "Confirmed by reviewer"

  - id: "focus-trap-002"
    item: "Modals trap focus appropriately and release on close"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Test focus cycling in modals and return on close"
    expected: "Confirmed by reviewer"

  - id: "focus-trap-003"
    item: "Escape key closes modals and dialogs"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Test Escape key on all modal/dialog components"
    expected: "Confirmed by reviewer"

  - id: "focus-trap-004"
    item: "Non-standard escape methods documented"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Verify documentation for editors and special components"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "WCAG 2.1"
      controls: ["2.1.2"]
    - framework: "Section 508"
      controls: ["1194.21(a)"]
    - framework: "EN 301 549"
      controls: ["9.2.1.2"]

relationships:
  commonly_combined:
    - "accessibility-inclusion.operable-keyboard.full-keyboard-navigation"
    - "accessibility-inclusion.operable-keyboard.focus-order"
    - "accessibility-inclusion.operable-keyboard.no-keyboard-trap"
