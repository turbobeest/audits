# ============================================================
# AUDIT: Background Audio Control - WCAG 2.1 Compliance
# ============================================================
# Verifies background audio can be controlled and does not
# interfere with screen reader users.

audit:
  id: "accessibility-inclusion.perceivable-auditory.background-audio-control"
  name: "Background Audio Control Audit"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "accessibility-inclusion"
  category_number: 15
  subcategory: "perceivable-auditory"

  tier: "expert"
  estimated_duration: "1-2 hours"  # median: 1h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "accessibility"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit verifies compliance with WCAG 2.1 SC 1.4.2 Audio Control
    (Level A), ensuring users can control audio that plays automatically.

    The audit covers:
    - Auto-playing audio on page load
    - Background music or ambient sounds
    - Audio advertisements
    - Video auto-play with sound
    - Notification sounds
    - Audio that plays for more than 3 seconds
    - Mechanism to pause, stop, or control volume

  why_it_matters: |
    Auto-playing audio is extremely problematic for accessibility:

    - Screen readers use audio output - background audio makes them
      impossible to hear
    - Users with cognitive disabilities find unexpected audio disorienting
    - Auto-play can be startling or embarrassing in public settings
    - Users cannot access content until they locate the sound source

    This is one of the most impactful accessibility failures, as it
    prevents screen reader users from using the page at all.

  when_to_run:
    - "When adding audio or video content"
    - "When implementing notifications"
    - "After third-party widget integration"
    - "Before accessibility compliance audits"
    - "When adding advertisements"

prerequisites:
  required_artifacts:
    - type: "codebase"
      description: "Access to audio/video embedding code"
    - type: "running_application"
      description: "Deployed instance for audio testing"

  access_requirements:
    - "Read access to HTML and JavaScript"
    - "Browser access to running application"
    - "Audio output for testing"

discovery:
  code_patterns:
    - pattern: "autoplay"
      type: "regex"
      scope: "source"
      purpose: "Find auto-play attributes"
    - pattern: "\\.play\\(\\)"
      type: "regex"
      scope: "source"
      purpose: "Find JavaScript play calls"
    - pattern: "new Audio\\("
      type: "regex"
      scope: "source"
      purpose: "Find Audio object creation"
    - pattern: "muted\\s*=\\s*false|muted={false}"
      type: "regex"
      scope: "source"
      purpose: "Find unmuted auto-play"
    - pattern: "<audio[^>]*autoplay"
      type: "regex"
      scope: "source"
      purpose: "Find audio elements with autoplay"

  file_patterns:
    - glob: "**/*.html"
      purpose: "HTML files with media"
    - glob: "**/player*.{js,jsx,tsx}"
      purpose: "Media player components"

knowledge_sources:
  specifications:
    - id: "wcag-21"
      name: "WCAG 2.1 Quick Reference"
      url: "https://www.w3.org/WAI/WCAG21/quickref/"
      offline_cache: true
      priority: "recommended"
    - id: "wcag21-142"
      name: "WCAG 2.1 Success Criterion 1.4.2 Audio Control"
      url: "https://www.w3.org/WAI/WCAG21/Understanding/audio-control.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "w3c-audio-control"
      name: "W3C: Audio Control"
      url: "https://www.w3.org/WAI/WCAG21/Techniques/general/G60"
      offline_cache: true
    - id: "mdn-autoplay"
      name: "MDN: Autoplay guide for media"
      url: "https://developer.mozilla.org/en-US/docs/Web/Media/Autoplay_guide"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "axe-core"
      purpose: "Detect auto-playing audio without controls"
      offline_capable: true

  scripts:
    - id: "find-autoplay"
      language: "bash"
      purpose: "Find autoplay attributes and JavaScript play calls"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Autoplay Attributes ==="
        grep -rn "autoplay" --include="*.html" --include="*.jsx" --include="*.tsx" . | head -20
        echo ""
        echo "=== JavaScript play() calls ==="
        grep -rn "\.play()" --include="*.js" --include="*.ts" --include="*.jsx" . | head -20

signals:
  critical:
    - id: "A11Y-BGAUDIO-CRIT-001"
      signal: "Audio auto-plays for more than 3 seconds without control"
      evidence_pattern: "<audio autoplay> or <video autoplay> without muted"
      explanation: |
        Auto-playing audio prevents screen reader users from hearing
        their assistive technology. This makes the page completely
        inaccessible.
      remediation: "Remove autoplay OR mute by default with visible unmute control"
    - id: "A11Y-BGAUDIO-CRIT-002"
      signal: "No mechanism to stop or pause background audio"
      evidence_pattern: "Audio element without controls attribute"
      explanation: |
        Users must be able to pause, stop, or mute any audio that
        plays automatically.
      remediation: "Add pause/stop/mute controls visible within first 3 seconds"

  high:
    - id: "A11Y-BGAUDIO-HIGH-001"
      signal: "Audio controls not keyboard accessible"
      explanation: "Keyboard users must be able to control audio"
      remediation: "Ensure audio controls are focusable and keyboard-operable"
    - id: "A11Y-BGAUDIO-HIGH-002"
      signal: "Audio controls not visible or discoverable"
      explanation: "Users must be able to quickly find and operate audio controls"
      remediation: "Make audio controls prominent and easy to locate"
    - id: "A11Y-BGAUDIO-HIGH-003"
      signal: "JavaScript plays audio on page load"
      explanation: "Script-initiated audio has same requirements as HTML autoplay"
      remediation: "Require user interaction before playing audio"

  medium:
    - id: "A11Y-BGAUDIO-MED-001"
      signal: "Volume control not available, only mute"
      remediation: "Provide full volume control slider"
    - id: "A11Y-BGAUDIO-MED-002"
      signal: "Audio restarts on each page navigation"
      remediation: "Remember user's audio preference across pages"
    - id: "A11Y-BGAUDIO-MED-003"
      signal: "Third-party widgets auto-play audio"
      remediation: "Configure widgets to require user activation"

  low:
    - id: "A11Y-BGAUDIO-LOW-001"
      signal: "Notification sounds play without preference setting"

  positive:
    - id: "A11Y-BGAUDIO-POS-001"
      signal: "All audio requires user activation to play"
    - id: "A11Y-BGAUDIO-POS-002"
      signal: "Audio controls are prominent and keyboard accessible"
    - id: "A11Y-BGAUDIO-POS-003"
      signal: "User audio preference is persisted"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify Auto-Playing Audio"
      description: |
        Search for autoplay attributes and JavaScript that
        plays audio without user interaction.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find autoplay in HTML"
          command: "grep -rn 'autoplay' --include='*.html' --include='*.jsx' --include='*.tsx' ."
        - purpose: "Find play() calls"
          command: "grep -rn '\\.play()' --include='*.js' --include='*.ts' . | head -30"
        - purpose: "Find Audio object creation"
          command: "grep -rn 'new Audio(' --include='*.js' --include='*.ts' . | head -20"
      expected_findings:
        - "Autoplay usage locations"
        - "JavaScript-initiated audio"

    - id: "2"
      name: "Test Audio on Page Load"
      description: |
        Load pages with potential audio and verify nothing
        plays automatically (or plays muted with controls).
      duration_estimate: "30 min"
      questions:
        - "Does any audio play immediately on page load?"
        - "Does audio play for more than 3 seconds?"
        - "Is there a mechanism to stop audio within first 3 seconds?"
        - "Are controls at the top of the page/easily discoverable?"
      expected_findings:
        - "Auto-playing audio instances"
        - "Control availability"

    - id: "3"
      name: "Verify Audio Controls"
      description: |
        Test all audio control mechanisms for accessibility.
      duration_estimate: "20 min"
      questions:
        - "Can controls be reached with keyboard?"
        - "Are controls properly labeled for screen readers?"
        - "Is the current play state announced?"
        - "Can volume be adjusted with keyboard?"
      expected_findings:
        - "Control accessibility status"
        - "Labeling and announcement issues"

    - id: "4"
      name: "Test Third-Party Content"
      description: |
        Check embedded content and third-party widgets
        for auto-playing audio.
      duration_estimate: "20 min"
      questions:
        - "Do any embedded iframes auto-play audio?"
        - "Do advertising scripts play audio?"
        - "Do chat widgets or notifications play sounds?"
      expected_findings:
        - "Third-party audio sources"
        - "Configuration options available"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Auto-Play Audit Results"
        - "Audio Control Assessment"
        - "Third-Party Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Runtime testing with audio playback verified"
    medium: "Static code analysis complete"
    low: "Pattern-based discovery only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "wcag21-142"
        priority: "required"

profiles:
  membership:
    quick:
      included: true
      priority: 1
      reason: "Auto-play audio is a critical barrier"
    full:
      included: true
      priority: 1
    accessibility:
      included: true
      priority: 1

closeout_checklist:
  - id: "background-audio-001"
    item: "No audio auto-plays for more than 3 seconds"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Load all pages and verify no unexpected audio plays"
    expected: "Confirmed by reviewer"

  - id: "background-audio-002"
    item: "Auto-playing audio has pause/stop/mute control"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify controls are visible and functional"
    expected: "Confirmed by reviewer"

  - id: "background-audio-003"
    item: "Audio controls are keyboard accessible"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Tab to and operate all audio controls with keyboard"
    expected: "Confirmed by reviewer"

  - id: "background-audio-004"
    item: "Third-party content does not auto-play audio"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Check embedded widgets and ads for audio"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "WCAG 2.1"
      controls: ["1.4.2"]
    - framework: "Section 508"
      controls: ["1194.22"]
    - framework: "EN 301 549"
      controls: ["9.1.4.2"]

relationships:
  commonly_combined:
    - "accessibility-inclusion.perceivable-visual.animation-motion-control"
    - "accessibility-inclusion.operable-timing.pause-stop-hide-control"
    - "accessibility-inclusion.perceivable-auditory.video-caption"
