# ============================================================
# AUDIT: Dark Mode Support - Accessibility Enhancement
# ============================================================
# Verifies dark mode implementation provides accessible experience
# for users with light sensitivity and visual preferences.

audit:
  id: "accessibility-inclusion.perceivable-visual.dark-mode-support"
  name: "Dark Mode Support Audit"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "accessibility-inclusion"
  category_number: 15
  subcategory: "perceivable-visual"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "codebase"

  default_profiles:
    - "full"
    - "accessibility"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit examines dark mode implementation for accessibility
    and usability, ensuring users who need reduced light exposure
    have a fully functional experience.

    The audit covers:
    - Support for prefers-color-scheme media query
    - Contrast ratios maintained in dark mode
    - User preference persistence
    - Smooth transition between modes
    - Image and media handling in dark mode
    - Form elements and inputs visibility
    - Third-party component compatibility
    - Print stylesheet considerations

  why_it_matters: |
    Dark mode is not just a preference but an accessibility need for
    many users:

    - Photophobia: Bright screens cause pain and migraines
    - Visual impairments: Some conditions improve with reduced glare
    - Eye fatigue: Dark mode reduces strain during extended use
    - Low-light environments: Better usability without disturbing others
    - Cognitive benefits: Some users focus better with reduced brightness

    Over 82% of users use dark mode when available.

  when_to_run:
    - "When implementing dark mode"
    - "After theme system changes"
    - "Before major releases"
    - "When updating color palette"
    - "After adding new components"

prerequisites:
  required_artifacts:
    - type: "codebase"
      description: "Access to CSS and theming code"
    - type: "running_application"
      description: "Deployed instance for visual testing"

  access_requirements:
    - "Read access to CSS/SCSS files"
    - "Access to theme configuration"
    - "Browser for testing both modes"

discovery:
  code_patterns:
    - pattern: "prefers-color-scheme:\\s*dark"
      type: "regex"
      scope: "source"
      purpose: "Find dark mode media queries"
    - pattern: "data-theme|\\[theme=|theme-mode"
      type: "regex"
      scope: "source"
      purpose: "Find theme attribute selectors"
    - pattern: "--[a-z-]*(bg|background|color|text)"
      type: "regex"
      scope: "source"
      purpose: "Find CSS custom properties for theming"
    - pattern: "dark:|:dark|.dark"
      type: "regex"
      scope: "source"
      purpose: "Find Tailwind-style dark mode classes"

  file_patterns:
    - glob: "**/theme*.{css,scss,js,ts}"
      purpose: "Theme configuration files"
    - glob: "**/dark*.css"
      purpose: "Dark mode stylesheets"
    - glob: "**/colors*.{js,ts,json}"
      purpose: "Color definitions"

knowledge_sources:
  specifications:
    - id: "wcag-21"
      name: "WCAG 2.1 Quick Reference"
      url: "https://www.w3.org/WAI/WCAG21/quickref/"
      offline_cache: true
      priority: "recommended"
    - id: "wcag-22"
      name: "WCAG 2.2 Specification"
      url: "https://www.w3.org/TR/WCAG22/"
      offline_cache: true
      priority: "recommended"
    - id: "wcag21-143"
      name: "WCAG 2.1 Success Criterion 1.4.3 Contrast (Minimum)"
      url: "https://www.w3.org/WAI/WCAG21/Understanding/contrast-minimum.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "mdn-color-scheme"
      name: "MDN: prefers-color-scheme"
      url: "https://developer.mozilla.org/en-US/docs/Web/CSS/@media/prefers-color-scheme"
      offline_cache: true
    - id: "a11y-dark-mode"
      name: "A11Y Project: Dark Mode"
      url: "https://www.a11yproject.com/posts/operating-system-and-browser-accessibility-display-modes/"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "axe-core"
      purpose: "Test contrast in both modes"
      offline_capable: true
    - tool: "stylelint"
      purpose: "Validate CSS custom property usage"
      offline_capable: true

  scripts:
    - id: "find-dark-mode"
      language: "bash"
      purpose: "Find dark mode implementation"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Media Query Support ==="
        grep -rn "prefers-color-scheme" --include="*.css" --include="*.scss" . | head -20
        echo ""
        echo "=== Theme Classes/Attributes ==="
        grep -rn "\\[data-theme\\|.dark\\|:dark" --include="*.css" --include="*.scss" . | head -20

signals:
  critical:
    - id: "A11Y-DARK-CRIT-001"
      signal: "Dark mode text fails minimum contrast (< 4.5:1)"
      evidence_pattern: "Light text on dark background with ratio < 4.5:1"
      explanation: |
        Dark mode must maintain the same contrast standards as light mode.
        Users often switch to dark mode due to visual impairments.
      remediation: "Increase text lightness or decrease background darkness"
    - id: "A11Y-DARK-CRIT-002"
      signal: "Form inputs invisible in dark mode"
      evidence_pattern: "Input elements without dark mode styling"
      explanation: |
        Unstyled form elements may be invisible against dark backgrounds,
        preventing form completion.
      remediation: "Ensure all form elements have dark mode styles"

  high:
    - id: "A11Y-DARK-HIGH-001"
      signal: "prefers-color-scheme not supported"
      explanation: "Users expect their OS preference to be respected"
      remediation: "Add @media (prefers-color-scheme: dark) { } styles"
    - id: "A11Y-DARK-HIGH-002"
      signal: "No manual dark mode toggle available"
      explanation: "Users should be able to override system preference"
      remediation: "Add accessible toggle for theme switching"
    - id: "A11Y-DARK-HIGH-003"
      signal: "Images too bright in dark mode"
      explanation: "Bright images create harsh contrast against dark UI"
      remediation: "Consider image dimming or border treatment in dark mode"

  medium:
    - id: "A11Y-DARK-MED-001"
      signal: "Dark mode preference not persisted"
      remediation: "Store preference in localStorage or user settings"
    - id: "A11Y-DARK-MED-002"
      signal: "Third-party components don't match dark mode"
      remediation: "Override third-party component styles or use themed alternatives"
    - id: "A11Y-DARK-MED-003"
      signal: "Harsh transition between modes"
      remediation: "Add smooth transition for background/color changes"

  low:
    - id: "A11Y-DARK-LOW-001"
      signal: "Dark mode could be darker/lighter for preference"

  positive:
    - id: "A11Y-DARK-POS-001"
      signal: "Full dark mode support with system preference detection"
    - id: "A11Y-DARK-POS-002"
      signal: "All contrast ratios maintained in dark mode"
    - id: "A11Y-DARK-POS-003"
      signal: "User preference persisted across sessions"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Check Dark Mode Implementation"
      description: |
        Identify how dark mode is implemented and whether
        system preferences are supported.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find prefers-color-scheme usage"
          command: "grep -rn 'prefers-color-scheme' --include='*.css' --include='*.scss' --include='*.js' ."
        - purpose: "Find theme toggle implementation"
          command: "grep -rn 'dark-mode\\|darkMode\\|theme-toggle' --include='*.js' --include='*.ts' . | head -20"
        - purpose: "Find CSS custom properties for theming"
          command: "grep -rn ':root\\|\\[data-theme' --include='*.css' . | head -20"
      expected_findings:
        - "Dark mode implementation approach"
        - "System preference support status"

    - id: "2"
      name: "Test Contrast in Dark Mode"
      description: |
        Enable dark mode and verify all text and UI elements
        maintain required contrast ratios.
      duration_estimate: "45 min"
      questions:
        - "Does all body text meet 4.5:1 contrast?"
        - "Do UI components meet 3:1 non-text contrast?"
        - "Are focus indicators visible in dark mode?"
        - "Are error/success states distinguishable?"
      expected_findings:
        - "Contrast violations specific to dark mode"
        - "Elements needing dark mode adjustment"

    - id: "3"
      name: "Test User Experience"
      description: |
        Verify dark mode provides a complete and usable experience.
      duration_estimate: "45 min"
      questions:
        - "Does system preference (prefers-color-scheme) work?"
        - "Is there a manual toggle that is accessible?"
        - "Is the preference persisted?"
        - "Do all components render correctly?"
        - "Are images and media handled appropriately?"
      expected_findings:
        - "User experience gaps"
        - "Incomplete component coverage"

    - id: "4"
      name: "Document Theme Variables"
      description: |
        Review theme variable structure for maintainability
        and completeness.
      duration_estimate: "20 min"
      expected_findings:
        - "Theme variable organization"
        - "Missing color variables for dark mode"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Dark Mode Implementation Review"
        - "Contrast Analysis"
        - "User Experience Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Visually tested in dark mode, contrast verified"
    medium: "Code analysis complete, testing pending"
    low: "Inferred from CSS patterns"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "wcag21-143"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive visual testing"
    full:
      included: true
      priority: 3
    accessibility:
      included: true
      priority: 2

closeout_checklist:
  - id: "dark-mode-001"
    item: "prefers-color-scheme media query supported"
    level: "BLOCKING"
    verification: "grep -r 'prefers-color-scheme' --include='*.css' --include='*.scss' . | wc -l"
    expected: "> 0"

  - id: "dark-mode-002"
    item: "Dark mode contrast ratios meet 4.5:1 minimum"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Enable dark mode and run axe-core contrast checks"
    expected: "Confirmed by reviewer"

  - id: "dark-mode-003"
    item: "Manual theme toggle available and accessible"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Verify toggle is keyboard accessible and properly labeled"
    expected: "Confirmed by reviewer"

  - id: "dark-mode-004"
    item: "User preference persisted across sessions"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Toggle dark mode, refresh page, verify setting retained"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "WCAG 2.1"
      controls: ["1.4.3", "1.4.6", "1.4.11"]

relationships:
  commonly_combined:
    - "accessibility-inclusion.perceivable-visual.color-contrast"
    - "accessibility-inclusion.perceivable-visual.high-contrast-mode"
    - "accessibility-inclusion.perceivable-visual.focus-indicator-visibility"
