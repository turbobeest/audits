# ============================================================
# AUDIT: High Contrast Mode Support
# ============================================================
# Verifies application works with Windows High Contrast Mode
# and forced colors, ensuring usability for low vision users.

audit:
  id: "accessibility-inclusion.perceivable-visual.high-contrast-mode"
  name: "High Contrast Mode Support Audit"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "accessibility-inclusion"
  category_number: 15
  subcategory: "perceivable-visual"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "accessibility"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit verifies the application functions correctly when
    Windows High Contrast Mode or forced-colors mode is enabled,
    per WCAG 2.1 SC 1.4.11 Non-text Contrast.

    The audit covers:
    - Support for forced-colors media query
    - Support for -ms-high-contrast (legacy)
    - System color keyword usage
    - Button and link visibility
    - Focus indicator preservation
    - Icon and graphic visibility
    - Custom scrollbar handling
    - Border preservation for boundaries
    - SVG and canvas accessibility

  why_it_matters: |
    Windows High Contrast Mode is an essential assistive technology
    for users with low vision. When enabled, it overrides application
    colors with high contrast system colors:

    - Approximately 2.2 billion people have vision impairments
    - High Contrast Mode users depend on it for daily computer use
    - UI elements can become invisible if not designed properly
    - Critical information can be lost when colors are overridden
    - Buttons and interactive elements may disappear entirely

  when_to_run:
    - "When implementing custom UI components"
    - "After CSS changes to interactive elements"
    - "Before Windows-targeted releases"
    - "During accessibility compliance audits"
    - "When using CSS that relies heavily on colors for UI"

prerequisites:
  required_artifacts:
    - type: "codebase"
      description: "Access to CSS and component code"
    - type: "running_application"
      description: "Deployed instance for testing"
    - type: "testing_environment"
      description: "Windows machine or VM for High Contrast testing"

  access_requirements:
    - "Read access to CSS files"
    - "Windows device or VM for testing"
    - "Browser with forced-colors support"

discovery:
  code_patterns:
    - pattern: "forced-colors"
      type: "regex"
      scope: "source"
      purpose: "Find forced-colors media query usage"
    - pattern: "-ms-high-contrast"
      type: "regex"
      scope: "source"
      purpose: "Find legacy high contrast support"
    - pattern: "ButtonText|Canvas|CanvasText|LinkText|GrayText|Highlight|HighlightText"
      type: "regex"
      scope: "source"
      purpose: "Find system color keyword usage"
    - pattern: "background-image:\\s*url"
      type: "regex"
      scope: "source"
      purpose: "Find background images (invisible in high contrast)"
    - pattern: "box-shadow"
      type: "regex"
      scope: "source"
      purpose: "Find box-shadow (removed in high contrast)"

  file_patterns:
    - glob: "**/*.css"
      purpose: "CSS stylesheets"
    - glob: "**/button*.{css,scss}"
      purpose: "Button component styles"
    - glob: "**/form*.{css,scss}"
      purpose: "Form element styles"

knowledge_sources:
  specifications:
    - id: "wcag-21"
      name: "WCAG 2.1 Quick Reference"
      url: "https://www.w3.org/WAI/WCAG21/quickref/"
      offline_cache: true
      priority: "recommended"
    - id: "wcag-22"
      name: "WCAG 2.2 Specification"
      url: "https://www.w3.org/TR/WCAG22/"
      offline_cache: true
      priority: "recommended"
    - id: "wcag21-1411"
      name: "WCAG 2.1 Success Criterion 1.4.11 Non-text Contrast"
      url: "https://www.w3.org/WAI/WCAG21/Understanding/non-text-contrast.html"
      offline_cache: true
      priority: "required"
    - id: "forced-colors-spec"
      name: "CSS Color Adjustment Module Level 1"
      url: "https://www.w3.org/TR/css-color-adjust-1/#forced-colors-mode"
      offline_cache: true
      priority: "required"

  guides:
    - id: "ms-high-contrast"
      name: "Microsoft: High Contrast Mode"
      url: "https://docs.microsoft.com/en-us/windows/apps/design/accessibility/high-contrast-themes"
      offline_cache: true
    - id: "mdn-forced-colors"
      name: "MDN: forced-colors media feature"
      url: "https://developer.mozilla.org/en-US/docs/Web/CSS/@media/forced-colors"
      offline_cache: true
    - id: "smashing-hcm"
      name: "Smashing Magazine: High Contrast Mode"
      url: "https://www.smashingmagazine.com/2022/06/guide-windows-high-contrast-mode/"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "stylelint"
      purpose: "Check for forced-colors support"
      offline_capable: true

  scripts:
    - id: "find-hcm-support"
      language: "bash"
      purpose: "Find high contrast mode support"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== forced-colors support ==="
        grep -rn "forced-colors" --include="*.css" --include="*.scss" . | head -20
        echo ""
        echo "=== -ms-high-contrast support ==="
        grep -rn "ms-high-contrast" --include="*.css" --include="*.scss" . | head -20
        echo ""
        echo "=== System color keywords ==="
        grep -rn "ButtonText\|Canvas\|CanvasText\|LinkText" --include="*.css" . | head -10

signals:
  critical:
    - id: "A11Y-HCM-CRIT-001"
      signal: "Buttons invisible in High Contrast Mode"
      evidence_pattern: "Button backgrounds with no border fallback"
      explanation: |
        Buttons that rely only on background color become invisible
        in High Contrast Mode, preventing user interaction.
      remediation: "Add transparent borders that become visible in forced-colors mode"
    - id: "A11Y-HCM-CRIT-002"
      signal: "Links indistinguishable from text in High Contrast Mode"
      evidence_pattern: "Links styled without underline and no forced-colors handling"
      explanation: |
        Links must be identifiable in High Contrast Mode through
        underlines or other means.
      remediation: "Ensure links have underlines or use forced-colors media query"

  high:
    - id: "A11Y-HCM-HIGH-001"
      signal: "Focus indicators lost in High Contrast Mode"
      explanation: "Focus indicators using only color/shadow disappear"
      remediation: "Use outline instead of box-shadow for focus, add transparent border fallback"
    - id: "A11Y-HCM-HIGH-002"
      signal: "Form inputs have no visible boundaries"
      explanation: "Input fields need borders to be visible"
      remediation: "Add borders to form elements that persist in forced-colors mode"
    - id: "A11Y-HCM-HIGH-003"
      signal: "Icons disappear in High Contrast Mode"
      explanation: "Icon colors are overridden by system colors"
      remediation: "Use currentColor for icon fills, add forced-colors styles"

  medium:
    - id: "A11Y-HCM-MED-001"
      signal: "No forced-colors media query present"
      remediation: "Add @media (forced-colors: active) { } styles"
    - id: "A11Y-HCM-MED-002"
      signal: "Custom scrollbars invisible in High Contrast Mode"
      remediation: "Allow scrollbars to use system defaults or add forced-colors styles"
    - id: "A11Y-HCM-MED-003"
      signal: "Decorative elements create visual noise"
      remediation: "Hide decorative elements with forced-colors: none or visibility"

  low:
    - id: "A11Y-HCM-LOW-001"
      signal: "Layout slightly affected but usable"

  positive:
    - id: "A11Y-HCM-POS-001"
      signal: "Full forced-colors media query support"
    - id: "A11Y-HCM-POS-002"
      signal: "All interactive elements have border fallbacks"
    - id: "A11Y-HCM-POS-003"
      signal: "Uses system color keywords appropriately"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Check for High Contrast Support"
      description: |
        Search codebase for forced-colors and -ms-high-contrast
        media query support.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find forced-colors media queries"
          command: "grep -rn 'forced-colors\\|-ms-high-contrast' --include='*.css' --include='*.scss' ."
        - purpose: "Find system color keyword usage"
          command: "grep -rn 'ButtonText\\|Canvas\\|CanvasText\\|LinkText\\|HighlightText' --include='*.css' ."
      expected_findings:
        - "Existing High Contrast Mode support"
        - "System color keyword usage"

    - id: "2"
      name: "Test in Windows High Contrast Mode"
      description: |
        Enable Windows High Contrast Mode and test all
        interactive elements and content.
      duration_estimate: "60 min"
      questions:
        - "Are all buttons visible and identifiable?"
        - "Are links distinguishable from regular text?"
        - "Are focus indicators visible?"
        - "Are form input boundaries visible?"
        - "Can all icons be seen?"
        - "Is content readable?"
      expected_findings:
        - "Elements that become invisible"
        - "Boundaries that are lost"

    - id: "3"
      name: "Test with Emulated forced-colors"
      description: |
        Use browser DevTools to emulate forced-colors mode
        for testing without Windows.
      duration_estimate: "30 min"
      commands:
        - purpose: "Chrome DevTools forced-colors emulation"
          command: "DevTools > Rendering > Emulate CSS media feature forced-colors"
      expected_findings:
        - "Cross-browser High Contrast behavior"
        - "Additional issues in emulation"

    - id: "4"
      name: "Identify Border Fallback Needs"
      description: |
        Find elements relying on background color alone
        that need transparent border fallbacks.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find buttons without borders"
          command: "grep -A5 'button\\|btn' --include='*.css' . | grep -v 'border:' | head -30"
      expected_findings:
        - "Elements needing border fallbacks"
        - "Recommended CSS additions"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "High Contrast Testing Results"
        - "Invisible Element Inventory"
        - "CSS Remediation Guide"
        - "Recommendations"

  confidence_guidance:
    high: "Tested on Windows with actual High Contrast Mode"
    medium: "Tested with browser emulation"
    low: "Code analysis only, no runtime testing"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "wcag21-1411"
        priority: "required"
      - source_id: "forced-colors-spec"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires Windows-specific testing"
    full:
      included: true
      priority: 3
    accessibility:
      included: true
      priority: 2

closeout_checklist:
  - id: "high-contrast-001"
    item: "All buttons visible in High Contrast Mode"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Enable Windows High Contrast Mode and verify all buttons"
    expected: "Confirmed by reviewer"

  - id: "high-contrast-002"
    item: "Links distinguishable in High Contrast Mode"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify links have underlines or other distinguishing features"
    expected: "Confirmed by reviewer"

  - id: "high-contrast-003"
    item: "Focus indicators visible in High Contrast Mode"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Tab through interface and verify focus visibility"
    expected: "Confirmed by reviewer"

  - id: "high-contrast-004"
    item: "Form inputs have visible boundaries"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Check all form elements have visible borders"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "WCAG 2.1"
      controls: ["1.4.11"]
    - framework: "Section 508"
      controls: ["1194.21(j)"]
    - framework: "EN 301 549"
      controls: ["9.1.4.11"]

relationships:
  commonly_combined:
    - "accessibility-inclusion.perceivable-visual.color-contrast"
    - "accessibility-inclusion.perceivable-visual.dark-mode-support"
    - "accessibility-inclusion.perceivable-visual.focus-indicator-visibility"
