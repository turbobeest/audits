# ============================================================
# AUDIT: Color Contrast - WCAG 2.1 AA/AAA Compliance
# ============================================================
# Verifies text and UI components meet minimum contrast ratios
# for users with low vision or color vision deficiencies.

audit:
  id: "accessibility-inclusion.perceivable-visual.color-contrast"
  name: "Color Contrast Ratio Compliance"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "accessibility-inclusion"
  category_number: 15
  subcategory: "perceivable-visual"

  tier: "expert"
  estimated_duration: "2-4 hours"  # median: 3h

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "accessibility"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit examines color contrast ratios throughout the application
    to ensure compliance with WCAG 2.1 Success Criteria 1.4.3 (AA) and
    1.4.6 (AAA). It analyzes text-to-background contrast for normal text,
    large text, and UI components/graphical objects.

    The audit covers:
    - Normal text (under 18pt/14pt bold): 4.5:1 minimum (AA), 7:1 (AAA)
    - Large text (18pt+ or 14pt+ bold): 3:1 minimum (AA), 4.5:1 (AAA)
    - UI components and graphical objects: 3:1 minimum (AA)
    - Focus indicators: 3:1 minimum against adjacent colors
    - Disabled states and placeholder text examination

  why_it_matters: |
    Approximately 8% of men and 0.5% of women have some form of color
    vision deficiency. Additionally, contrast sensitivity decreases with
    age, affecting millions of users. Poor contrast:

    - Makes content unreadable for users with low vision
    - Causes eye strain and fatigue for all users
    - Reduces usability in bright light or mobile contexts
    - Violates legal accessibility requirements (ADA, Section 508, EN 301 549)
    - Excludes ~15% of the population with visual impairments

  when_to_run:
    - "During UI/UX design review phases"
    - "Before any visual design is finalized"
    - "After theme or color palette changes"
    - "During accessibility compliance audits"
    - "Before public release or major updates"

prerequisites:
  required_artifacts:
    - type: "codebase"
      description: "Access to CSS, SCSS, design tokens, or styling code"
    - type: "design_system"
      description: "Color palette definitions and usage guidelines"
    - type: "running_application"
      description: "Deployed or local instance for visual verification"

  access_requirements:
    - "Read access to all styling files (CSS, SCSS, styled-components, etc.)"
    - "Access to design system or Figma/Sketch files"
    - "Browser access to running application"
    - "DevTools access for color inspection"

discovery:
  code_patterns:
    - pattern: "color:\\s*#[0-9a-fA-F]{3,8}"
      type: "regex"
      scope: "source"
      purpose: "Identify hex color definitions"
    - pattern: "color:\\s*rgb(a)?\\("
      type: "regex"
      scope: "source"
      purpose: "Identify RGB/RGBA color definitions"
    - pattern: "background(-color)?:\\s*#[0-9a-fA-F]{3,8}"
      type: "regex"
      scope: "source"
      purpose: "Identify background color definitions"
    - pattern: "--[a-z-]+(color|bg|background|text|foreground)"
      type: "regex"
      scope: "source"
      purpose: "Identify CSS custom properties for colors"
    - pattern: "opacity:\\s*0\\.[0-5]"
      type: "regex"
      scope: "source"
      purpose: "Identify low opacity that may affect contrast"

  file_patterns:
    - glob: "**/*.css"
      purpose: "CSS stylesheets"
    - glob: "**/*.scss"
      purpose: "SASS stylesheets"
    - glob: "**/*.less"
      purpose: "LESS stylesheets"
    - glob: "**/theme*.{js,ts,json}"
      purpose: "Theme configuration files"
    - glob: "**/colors*.{js,ts,json}"
      purpose: "Color palette definitions"
    - glob: "**/tokens*.{js,ts,json}"
      purpose: "Design token definitions"

knowledge_sources:
  specifications:
    - id: "wcag-21"
      name: "WCAG 2.1 Quick Reference"
      url: "https://www.w3.org/WAI/WCAG21/quickref/"
      offline_cache: true
      priority: "recommended"
    - id: "wcag-22"
      name: "WCAG 2.2 Specification"
      url: "https://www.w3.org/TR/WCAG22/"
      offline_cache: true
      priority: "recommended"
    - id: "wcag21-143"
      name: "WCAG 2.1 Success Criterion 1.4.3 Contrast (Minimum)"
      url: "https://www.w3.org/WAI/WCAG21/Understanding/contrast-minimum.html"
      offline_cache: true
      priority: "required"
    - id: "wcag21-146"
      name: "WCAG 2.1 Success Criterion 1.4.6 Contrast (Enhanced)"
      url: "https://www.w3.org/WAI/WCAG21/Understanding/contrast-enhanced.html"
      offline_cache: true
      priority: "required"
    - id: "wcag21-1411"
      name: "WCAG 2.1 Success Criterion 1.4.11 Non-text Contrast"
      url: "https://www.w3.org/WAI/WCAG21/Understanding/non-text-contrast.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "webaim-contrast"
      name: "WebAIM Contrast and Color Accessibility"
      url: "https://webaim.org/articles/contrast/"
      offline_cache: true
    - id: "a11y-contrast-guide"
      name: "The A11Y Project - Color Contrast"
      url: "https://www.a11yproject.com/checklist/#color-contrast"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "axe-core"
      purpose: "Automated contrast checking in browser"
      offline_capable: true
    - tool: "lighthouse"
      purpose: "Google's accessibility auditing tool"
      offline_capable: true
    - tool: "color-contrast-analyzer"
      purpose: "Desktop application for color contrast testing"
      offline_capable: true

  scripts:
    - id: "extract-color-pairs"
      language: "bash"
      purpose: "Extract color and background-color pairs from CSS"
      source: "inline"
      code: |
        #!/bin/bash
        # Extract color pairs from CSS files for contrast analysis
        find . \( find . -name "*.css" -o -name "*.scss" \) | xargs grep -E "(^|;)\s*(color|background-color):" | \
          sed 's/.*:\s*//' | sort | uniq -c | sort -rn

signals:
  critical:
    - id: "A11Y-CONTRAST-CRIT-001"
      signal: "Body text contrast ratio below 3:1"
      evidence_pattern: "Text elements with contrast ratio < 3:1"
      explanation: |
        Text with contrast below 3:1 is essentially unreadable for many
        users with visual impairments and fails all WCAG levels.
      remediation: "Adjust text or background color to achieve at least 4.5:1 for AA compliance"
    - id: "A11Y-CONTRAST-CRIT-002"
      signal: "Interactive element completely invisible"
      evidence_pattern: "Buttons or links with < 2:1 contrast"
      explanation: |
        Interactive elements that blend into the background prevent
        users from identifying and activating them.
      remediation: "Ensure all interactive elements have at least 3:1 contrast"

  high:
    - id: "A11Y-CONTRAST-HIGH-001"
      signal: "Normal text fails AA minimum (< 4.5:1)"
      explanation: "Text under 18pt requires 4.5:1 contrast for WCAG AA compliance"
      remediation: "Increase contrast to at least 4.5:1 by adjusting foreground or background"
    - id: "A11Y-CONTRAST-HIGH-002"
      signal: "Large text fails AA minimum (< 3:1)"
      explanation: "Large text (18pt+ or 14pt+ bold) requires 3:1 for AA compliance"
      remediation: "Adjust colors to achieve at least 3:1 contrast ratio"
    - id: "A11Y-CONTRAST-HIGH-003"
      signal: "Focus indicator fails 3:1 contrast"
      explanation: "Focus indicators must be visible against adjacent colors"
      remediation: "Use a focus style with sufficient contrast against both focused element and background"

  medium:
    - id: "A11Y-CONTRAST-MED-001"
      signal: "Normal text fails AAA standard (< 7:1)"
      remediation: "For enhanced accessibility, increase contrast to 7:1"
    - id: "A11Y-CONTRAST-MED-002"
      signal: "Placeholder text has insufficient contrast"
      remediation: "Use placeholder text that meets 4.5:1 or provide alternative labeling"
    - id: "A11Y-CONTRAST-MED-003"
      signal: "UI components fail 3:1 non-text contrast"
      remediation: "Ensure form inputs, icons, and graphics meet 3:1 minimum"

  low:
    - id: "A11Y-CONTRAST-LOW-001"
      signal: "Decorative elements have low contrast"

  positive:
    - id: "A11Y-CONTRAST-POS-001"
      signal: "All text meets AAA contrast standards (7:1)"
    - id: "A11Y-CONTRAST-POS-002"
      signal: "Design system enforces contrast requirements"
    - id: "A11Y-CONTRAST-POS-003"
      signal: "Automated contrast testing in CI pipeline"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Extract Color Palette"
      description: |
        Identify all color definitions in the codebase including CSS
        custom properties, design tokens, and hardcoded values.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find all color definitions"
          command: "grep -rE '(#[0-9a-fA-F]{3,8}|rgb\\(|rgba\\(|hsl\\()' --include='*.css' --include='*.scss' --include='*.json' ."
        - purpose: "List CSS custom properties for colors"
          command: "grep -rE '--[a-z-]*(color|bg|background|text)' --include='*.css' ."
      expected_findings:
        - "Complete inventory of colors used in application"
        - "Identification of color variable naming conventions"

    - id: "2"
      name: "Run Automated Contrast Checks"
      description: |
        Use automated tools to check all visible text and UI
        components against WCAG contrast requirements.
      duration_estimate: "45 min"
      commands:
        - purpose: "Run axe-core accessibility audit"
          command: "npx axe --include 'color-contrast' <URL>"
        - purpose: "Run Lighthouse accessibility audit"
          command: "npx lighthouse <URL> --only-categories=accessibility --output=json"
      expected_findings:
        - "List of all contrast violations"
        - "Specific elements and their current ratios"

    - id: "3"
      name: "Manual Verification of Complex Cases"
      description: |
        Check cases automated tools miss: text over images,
        gradients, translucent overlays, and state-dependent colors.
      duration_estimate: "60 min"
      questions:
        - "Are there text elements over images or gradients?"
        - "Do hover/focus states maintain sufficient contrast?"
        - "Are error messages and validation states accessible?"
        - "Do disabled states maintain 3:1 contrast?"
      expected_findings:
        - "Edge cases not caught by automation"
        - "Dynamic content contrast issues"

    - id: "4"
      name: "Document and Prioritize Findings"
      description: |
        Compile all findings with specific contrast ratios,
        affected elements, and remediation recommendations.
      duration_estimate: "30 min"
      expected_findings:
        - "Prioritized list of contrast issues"
        - "Specific color recommendations for fixes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Contrast Ratio Analysis"
        - "Critical Violations"
        - "Recommendations"
        - "Color Palette Adjustments"

  confidence_guidance:
    high: "Contrast ratios calculated with validated tools, verified visually"
    medium: "Automated tool findings, awaiting manual verification"
    low: "Estimated based on similar color combinations"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "wcag21-143"
        priority: "required"
      - source_id: "wcag21-146"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive analysis of all color combinations"
    full:
      included: true
      priority: 1
    accessibility:
      included: true
      priority: 1

closeout_checklist:
  - id: "color-contrast-001"
    item: "All normal text meets 4.5:1 AA minimum"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Run axe-core and verify no color-contrast violations for text < 18pt"
    expected: "Confirmed by reviewer"

  - id: "color-contrast-002"
    item: "All large text meets 3:1 AA minimum"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify text >= 18pt or 14pt bold meets 3:1 ratio"
    expected: "Confirmed by reviewer"

  - id: "color-contrast-003"
    item: "UI components meet 3:1 non-text contrast"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Check form inputs, buttons, icons against adjacent colors"
    expected: "Confirmed by reviewer"

  - id: "color-contrast-004"
    item: "Focus indicators visible at 3:1 contrast"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Tab through interface and verify all focus states are visible"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "WCAG 2.1"
      controls: ["1.4.3", "1.4.6", "1.4.11"]
    - framework: "Section 508"
      controls: ["1194.22(c)"]
    - framework: "EN 301 549"
      controls: ["9.1.4.3", "9.1.4.6", "9.1.4.11"]
    - framework: "ADA"
      controls: ["Title III Web Accessibility"]

relationships:
  commonly_combined:
    - "accessibility-inclusion.perceivable-visual.color-only-information"
    - "accessibility-inclusion.perceivable-visual.dark-mode-support"
    - "accessibility-inclusion.perceivable-visual.high-contrast-mode"
    - "accessibility-inclusion.perceivable-visual.focus-indicator-visibility"
