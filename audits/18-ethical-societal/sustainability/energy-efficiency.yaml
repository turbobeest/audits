# ============================================================
# AUDIT: Energy Efficiency
# ============================================================
# Evaluates software and infrastructure for energy-efficient
# operation and optimization practices.

audit:
  id: "ethical-societal.sustainability.energy-efficiency"

  name: "Energy Efficiency"

  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "ethical-societal"
  category_number: 18
  subcategory: "sustainability"

  tier: "expert"
  estimated_duration: "3-5 hours"  # median: 4h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "infrastructure"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates energy efficiency of software systems including compute
    utilization, resource provisioning, code efficiency, caching strategies,
    and idle resource management. Assesses both infrastructure efficiency
    (PUE, right-sizing) and software efficiency (algorithmic optimization,
    efficient data structures). Reviews energy-aware scheduling and
    demand shaping.

  why_it_matters: |
    Energy efficiency directly impacts operating costs, carbon emissions,
    and environmental sustainability. Inefficient systems waste energy on
    idle resources, unnecessary computation, and poor utilization. With
    rising energy costs and carbon regulations, efficiency is increasingly
    strategic. Efficient software also performs better, creating win-win
    for sustainability and user experience.

  when_to_run:
    - "During performance optimization"
    - "Before major scaling events"
    - "When energy costs increase significantly"
    - "During sustainability assessments"

prerequisites:
  required_artifacts:
    - type: "infrastructure_metrics"
      description: "CPU, memory, and resource utilization data"
    - type: "application_profiling"
      description: "Performance profiles showing resource consumption"

  access_requirements:
    - "Infrastructure monitoring dashboards"
    - "Application performance metrics"
    - "Code profiling capabilities"

discovery:
  code_patterns:
    - pattern: "(cache|memoize|lazy|defer|batch)"
      type: "regex"
      scope: "source"
      purpose: "Find efficiency patterns"
    - pattern: "(sleep|idle|timeout|poll|spin)"
      type: "regex"
      scope: "source"
      purpose: "Locate potential idle/polling patterns"
    - pattern: "(optimize|efficient|performance)"
      type: "regex"
      scope: "source"
      purpose: "Find optimization code"

  file_patterns:
    - glob: "**/cache/**"
      purpose: "Find caching implementations"
    - glob: "**/performance/**"
      purpose: "Locate performance modules"

  metrics_queries:
    - system: "CloudWatch/Prometheus"
      query: "avg(cpu_utilization)"
      purpose: "Measure compute utilization"
      threshold: "Target >60% for cost instances"
    - system: "CloudWatch"
      query: "ec2_idle_instances"
      purpose: "Identify idle resources"
      threshold: "Zero idle instances"

knowledge_sources:
  guides:
    - id: "green-software-patterns"
      name: "Green Software Patterns"
      url: "https://patterns.greensoftware.foundation/"
      offline_cache: true
    - id: "aws-efficiency"
      name: "AWS Well-Architected - Sustainability Pillar"
      url: "https://docs.aws.amazon.com/wellarchitected/latest/sustainability-pillar/"
      offline_cache: true

  learning_resources:
    - id: "sustainable-software"
      title: "Building Green Software"
      type: "book"
      reference: "O'Reilly, Green Software Foundation"

tooling:
  static_analysis:
    - tool: "eco-ci"
      purpose: "Measure CI pipeline energy consumption"
      offline_capable: true
    - tool: "scaphandre"
      purpose: "Power consumption monitoring for bare metal"
      offline_capable: true

  infrastructure_tools:
    - tool: "AWS Compute Optimizer"
      purpose: "Right-sizing recommendations"
      command: "aws compute-optimizer get-ec2-instance-recommendations"
    - tool: "KEDA"
      purpose: "Kubernetes Event-driven Autoscaling"

  scripts:
    - id: "efficiency-analyzer"
      language: "bash"
      purpose: "Analyze resource utilization patterns"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== CPU Utilization (last 7 days) ==="
        aws cloudwatch get-metric-statistics \
          --namespace AWS/EC2 \
          --metric-name CPUUtilization \
          --start-time $(date -d '7 days ago' +%Y-%m-%dT%H:%M:%S) \
          --end-time $(date +%Y-%m-%dT%H:%M:%S) \
          --period 86400 \
          --statistics Average \
          --output table 2>/dev/null || echo "AWS CLI not configured"

        echo "=== Memory Analysis ==="
        free -h 2>/dev/null || echo "Not available"

signals:
  critical:
    - id: "ENRG-CRIT-001"
      signal: "Resources significantly over-provisioned"
      evidence_threshold: "Average CPU < 20% over sustained period"
      explanation: |
        Chronically under-utilized resources waste energy and cost.
        Right-sizing reduces energy consumption while maintaining performance.
      remediation: "Right-size instances based on actual utilization"

  high:
    - id: "ENRG-HIGH-001"
      signal: "No auto-scaling for variable workloads"
      explanation: "Fixed provisioning for variable workloads wastes energy during low periods"
      remediation: "Implement auto-scaling to match resources to demand"

    - id: "ENRG-HIGH-002"
      signal: "Polling instead of event-driven patterns"
      evidence_pattern: "(while.*true.*sleep|poll|spin)"
      explanation: "Polling wastes CPU cycles; event-driven is more efficient"
      remediation: "Replace polling with event-driven architecture"

  medium:
    - id: "ENRG-MED-001"
      signal: "No caching for repeated computations"
      remediation: "Implement caching for expensive repeated operations"

    - id: "ENRG-MED-002"
      signal: "Non-production resources always running"
      remediation: "Schedule non-production resources to stop during off-hours"

  low:
    - id: "ENRG-LOW-001"
      signal: "Debug/logging overhead in production"
      remediation: "Minimize logging overhead in production"

  positive:
    - id: "ENRG-POS-001"
      signal: "Resources right-sized to actual utilization"
    - id: "ENRG-POS-002"
      signal: "Auto-scaling based on demand"
    - id: "ENRG-POS-003"
      signal: "Effective caching reducing compute"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Measure utilization"
      description: |
        Collect utilization metrics for compute, memory, storage,
        and network resources across all environments.
      duration_estimate: "60 min"
      commands:
        - purpose: "Get CPU utilization"
          command: "aws cloudwatch get-metric-statistics --namespace AWS/EC2 --metric-name CPUUtilization --statistics Average --period 3600 --start-time $(date -d '24 hours ago' +%Y-%m-%dT%H:%M:%S) --end-time $(date +%Y-%m-%dT%H:%M:%S)"
      expected_findings:
        - "Baseline utilization metrics"
        - "Utilization patterns"

    - id: "2"
      name: "Identify waste"
      description: |
        Identify over-provisioned, idle, and zombie resources.
        Quantify potential savings from right-sizing.
      duration_estimate: "45 min"
      expected_findings:
        - "Over-provisioned resources"
        - "Idle resource identification"

    - id: "3"
      name: "Review scaling strategy"
      description: |
        Assess auto-scaling configuration and effectiveness.
        Evaluate scaling triggers and responsiveness.
      duration_estimate: "45 min"
      expected_findings:
        - "Scaling strategy assessment"
        - "Optimization opportunities"

    - id: "4"
      name: "Analyze code efficiency"
      description: |
        Review code patterns for efficiency including caching,
        batching, lazy loading, and algorithmic efficiency.
      duration_estimate: "60 min"
      commands:
        - purpose: "Find caching patterns"
          command: "grep -r -E '(cache|memoize|lazy)' --include='*.py' --include='*.ts' ."
      expected_findings:
        - "Efficiency pattern assessment"
        - "Optimization opportunities"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "efficiency_report"
      format: "structured"
      sections:
        - "Utilization Analysis"
        - "Waste Identification"
        - "Scaling Assessment"
        - "Code Efficiency Review"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Key Findings"
        - "Recommendations"

  confidence_guidance:
    high: "Full utilization data with profiling"
    medium: "Utilization data without code profiling"
    low: "Limited monitoring data"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "green-software-patterns"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed utilization analysis"
    full:
      included: true
      priority: 3

closeout_checklist:
  - id: "enrg-001"
    item: "Resource utilization measured"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Baseline utilization metrics collected"
    expected: "Confirmed by reviewer"

  - id: "enrg-002"
    item: "Over-provisioned resources identified"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Right-sizing opportunities documented"
    expected: "Confirmed by reviewer"

  - id: "enrg-003"
    item: "Auto-scaling appropriately configured"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Scaling matches workload patterns"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "AWS Well-Architected"
      controls: ["Sustainability Pillar"]
    - framework: "Green Software Foundation"
      controls: ["SCI - Software Carbon Intensity"]

relationships:
  commonly_combined:
    - "ethical-societal.sustainability.carbon-footprint"
    - "ethical-societal.sustainability.green-coding-practice"
