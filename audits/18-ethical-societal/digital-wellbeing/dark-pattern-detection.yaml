# ============================================================
# AUDIT: Dark Pattern Detection
# ============================================================
# Identifies manipulative design patterns that deceive or coerce
# users against their best interests.

audit:
  id: "ethical-societal.digital-wellbeing.dark-pattern-detection"

  name: "Dark Pattern Detection"

  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "ethical-societal"
  category_number: 18
  subcategory: "digital-wellbeing"

  tier: "expert"
  estimated_duration: "3-5 hours"  # median: 4h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Identifies and evaluates dark patterns - user interface designs that
    manipulate, deceive, or coerce users into actions against their interests.
    Covers categories including confirmshaming, hidden costs, trick questions,
    forced continuity, roach motel, privacy zuckering, misdirection, bait and
    switch, disguised ads, and friend spam. Assesses both intentional
    manipulation and unintentional harmful patterns.

  why_it_matters: |
    Dark patterns undermine user trust, autonomy, and informed decision-making.
    Regulators increasingly target dark patterns - FTC enforces against deceptive
    practices, EU Digital Services Act prohibits manipulative design, and CCPA
    specifically bans dark patterns in privacy choices. Beyond legal risk, dark
    patterns damage brand reputation and customer relationships.

  when_to_run:
    - "During UX design reviews"
    - "Before major UI releases"
    - "Following user complaints about manipulative design"
    - "During compliance assessments"

prerequisites:
  required_artifacts:
    - type: "ui_designs"
      description: "User interface mockups or live application access"
    - type: "user_flows"
      description: "Documentation of key user journeys"

  access_requirements:
    - "Access to application UI"
    - "Design system documentation"
    - "User flow documentation"

discovery:
  code_patterns:
    - pattern: "(shame|guilt|embarrass|disappoint|miss.?out)"
      type: "regex"
      scope: "source"
      purpose: "Find confirmshaming language"
    - pattern: "(cancel|unsubscribe|delete|remove|opt.?out).*(?:hidden|difficult|obscure)"
      type: "regex"
      scope: "source"
      purpose: "Locate roach motel patterns"
    - pattern: "(countdown|timer|urgent|hurry|limited.?time|last.?chance)"
      type: "regex"
      scope: "source"
      purpose: "Find urgency manipulation"
    - pattern: "(pre.?checked|pre.?selected|default.*true|default.*checked)"
      type: "regex"
      scope: "source"
      purpose: "Locate sneaky defaults"

  file_patterns:
    - glob: "**/components/**"
      purpose: "Find UI components"
    - glob: "**/modals/**"
      purpose: "Locate modal dialogs"
    - glob: "**/checkout/**"
      purpose: "Find checkout flows"

  documents_to_review:
    - type: "UI mockups and designs"
      purpose: "Review visual design for manipulation"
    - type: "Microcopy and UX writing"
      purpose: "Assess language for manipulation"

knowledge_sources:
  specifications:
    - id: "dsa"
      name: "EU Digital Services Act"
      url: "https://eur-lex.europa.eu/legal-content/EN/TXT/?uri=CELEX:32022R2065"
      offline_cache: true
      priority: "required"
    - id: "ccpa-dark-patterns"
      name: "CCPA Dark Pattern Regulations"
      url: "https://oag.ca.gov/privacy/ccpa"
      offline_cache: true
      priority: "required"

  guides:
    - id: "darkpatterns-org"
      name: "Dark Patterns Hall of Shame"
      url: "https://darkpatterns.org/"
      offline_cache: true
    - id: "ftc-dark-patterns"
      name: "FTC Report on Dark Patterns"
      url: "https://www.ftc.gov/reports/bringing-dark-patterns-light"
      offline_cache: true

  papers:
    - id: "dark-patterns-typology"
      title: "Dark Patterns at Scale: Findings from a Crawl of 11K Shopping Websites"
      url: "https://arxiv.org/abs/1907.07032"

tooling:
  assessment_tools:
    - tool: "Dark pattern taxonomy checklist"
      purpose: "Systematic identification of pattern types"
    - tool: "Heuristic evaluation framework"
      purpose: "Expert UX review"

  scripts:
    - id: "dark-pattern-scanner"
      language: "bash"
      purpose: "Find potential dark pattern indicators in code"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Confirmshaming Language ==="
        grep -r -i -E "(no.?thanks|don't|won't|miss|shame|guilt)" \
          --include="*.tsx" --include="*.jsx" --include="*.html" . 2>/dev/null | head -20

        echo "=== Urgency Patterns ==="
        grep -r -i -E "(countdown|timer|limited|hurry|urgent|last.?chance)" \
          --include="*.tsx" --include="*.jsx" --include="*.html" . 2>/dev/null | head -20

        echo "=== Pre-checked Defaults ==="
        grep -r -E "(defaultChecked|checked.*true|selected.*true)" \
          --include="*.tsx" --include="*.jsx" . 2>/dev/null | head -20

signals:
  critical:
    - id: "DARK-CRIT-001"
      signal: "Forced action pattern - required to create account for basic access"
      evidence_indicators:
        - "Cannot view content without registration"
        - "Registration required for unrelated functionality"
      explanation: |
        Forcing unnecessary account creation exploits user sunk cost and
        creates data collection without genuine need. May violate data
        minimization principles and user expectations.
      remediation: "Allow guest access for functionality not requiring account"

    - id: "DARK-CRIT-002"
      signal: "Hidden subscription with recurring charges"
      evidence_indicators:
        - "Subscription cost not clearly disclosed"
        - "Automatic renewal without prominent notice"
        - "Difficult cancellation process"
      explanation: |
        Hidden recurring charges are deceptive practice subject to FTC
        enforcement. Negative option marketing requires clear disclosure
        of all material terms.
      remediation: "Clearly disclose subscription terms before collection of payment"

  high:
    - id: "DARK-HIGH-001"
      signal: "Confirmshaming in opt-out choices"
      evidence_pattern: "(no.?thanks.*miss|don't.*want.*save|decline.*special)"
      explanation: "Using guilt or shame to manipulate privacy/marketing choices"
      remediation: "Use neutral language for all choice options"

    - id: "DARK-HIGH-002"
      signal: "Roach motel - easy sign-up, difficult cancellation"
      explanation: "Making cancellation significantly harder than signup is manipulative"
      remediation: "Cancellation process should be as easy as signup"

  medium:
    - id: "DARK-MED-001"
      signal: "False urgency with countdown timers"
      remediation: "Only use timers for genuine limited-time offers"

    - id: "DARK-MED-002"
      signal: "Misdirection through visual hierarchy"
      remediation: "Give equal visual weight to competing options"

  low:
    - id: "DARK-LOW-001"
      signal: "Privacy-invasive options pre-selected"
      remediation: "Default to privacy-protective settings"

  positive:
    - id: "DARK-POS-001"
      signal: "Neutral language for all user choices"
    - id: "DARK-POS-002"
      signal: "Equal visual prominence for accept/decline options"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Map user decision points"
      description: |
        Identify all points where users make choices - consent dialogs,
        subscription flows, account management, privacy settings.
      duration_estimate: "45 min"
      commands:
        - purpose: "Find modal/dialog components"
          command: "find . -type f \\( -name '*.tsx' -o -name '*.jsx' \\) -exec grep -l -E '(Modal|Dialog|Popup|Overlay)' {} \\;"
      expected_findings:
        - "Inventory of user decision points"
        - "Choice architecture documentation"

    - id: "2"
      name: "Evaluate language and framing"
      description: |
        Review microcopy at decision points for manipulative language
        including confirmshaming, false urgency, and emotional manipulation.
      duration_estimate: "60 min"
      commands:
        - purpose: "Find potentially manipulative copy"
          command: "grep -r -i -E '(shame|guilt|miss|regret|urgent|limited|last)' --include='*.tsx' --include='*.jsx' ."
      expected_findings:
        - "Manipulative language instances"
        - "Framing analysis"

    - id: "3"
      name: "Assess visual design"
      description: |
        Evaluate visual hierarchy, button styling, and layout for
        manipulation through design choices.
      duration_estimate: "60 min"
      questions:
        - "Are accept/decline options given equal visual weight?"
        - "Are unsubscribe/cancel links hidden or de-emphasized?"
        - "Does color coding create false sense of right/wrong choice?"
      expected_findings:
        - "Visual manipulation assessment"
        - "Design bias identification"

    - id: "4"
      name: "Test user flows"
      description: |
        Walk through critical user journeys to identify friction,
        hidden costs, or difficult-to-reverse actions.
      duration_estimate: "60 min"
      expected_findings:
        - "Flow friction analysis"
        - "Hidden cost identification"

    - id: "5"
      name: "Review against taxonomy"
      description: |
        Systematically evaluate findings against dark pattern taxonomy
        and document severity of each identified pattern.
      duration_estimate: "30 min"
      expected_findings:
        - "Categorized dark pattern findings"
        - "Severity classification"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "dark_pattern_report"
      format: "structured"
      sections:
        - "Pattern Inventory"
        - "Severity Assessment"
        - "User Journey Analysis"
        - "Visual Design Evaluation"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Key Findings"
        - "Legal Risk Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Full UI review with user testing"
    medium: "Expert heuristic evaluation"
    low: "Code review only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "dsa"
        priority: "required"
      - source_id: "darkpatterns-org"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive UI review"
    full:
      included: true
      priority: 2

closeout_checklist:
  - id: "dark-001"
    item: "User decision points mapped"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "All choice points inventoried"
    expected: "Confirmed by reviewer"

  - id: "dark-002"
    item: "No confirmshaming language present"
    level: "CRITICAL"
    verification: "grep -r -i -E '(no.?thanks.*miss|don.*want.*save)' --include='*.tsx' --include='*.jsx' . | wc -l | xargs -I{} test {} -eq 0 && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "dark-003"
    item: "Cancel/unsubscribe as easy as signup"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Cancellation flow evaluated"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["consumer-facing", "e-commerce", "subscription"]

  compliance_frameworks:
    - framework: "EU Digital Services Act"
      controls: ["Article 25"]
    - framework: "CCPA"
      controls: ["Dark Pattern Regulations"]
    - framework: "FTC Act"
      controls: ["Section 5 - Unfair and Deceptive Practices"]

relationships:
  commonly_combined:
    - "ethical-societal.digital-wellbeing.user-autonomy-respect"
    - "ethical-societal.privacy-data-ethics.consent-management"
