# ============================================================
# AUDIT: Consent Management
# ============================================================
# Evaluates consent collection, storage, and withdrawal mechanisms
# for compliance with privacy regulations and ethical standards.

audit:
  id: "ethical-societal.privacy-data-ethics.consent-management"

  name: "Consent Management"

  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "ethical-societal"
  category_number: 18
  subcategory: "privacy-data-ethics"

  tier: "expert"
  estimated_duration: "3-5 hours"  # median: 4h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates consent management practices including consent collection
    mechanisms, granularity, record-keeping, withdrawal capabilities, and
    enforcement. Assesses whether consent is freely given, specific, informed,
    and unambiguous as required by GDPR. Reviews consent flows, dark patterns,
    and the ease of consent withdrawal.

  why_it_matters: |
    Valid consent is a primary lawful basis for personal data processing under
    GDPR. Invalid consent makes processing unlawful, exposing organizations to
    enforcement action and fines. Users increasingly expect transparent consent
    practices. Poor consent UX erodes trust and may constitute deceptive practice.
    Dark patterns in consent interfaces face increasing regulatory scrutiny.

  when_to_run:
    - "When implementing consent-based data processing"
    - "Before launching new features requiring consent"
    - "During privacy audits"
    - "Following consent-related complaints"

prerequisites:
  required_artifacts:
    - type: "consent_flows"
      description: "User interface flows for consent collection"
    - type: "consent_records"
      description: "Consent storage and retrieval mechanisms"

  access_requirements:
    - "Access to consent UI implementations"
    - "Consent database or storage system"
    - "Privacy policy and consent language"

discovery:
  code_patterns:
    - pattern: "(consent|permission|opt.?in|agree|accept)"
      type: "regex"
      scope: "source"
      purpose: "Find consent collection points"
    - pattern: "(withdraw|revoke|opt.?out|unsubscribe)"
      type: "regex"
      scope: "source"
      purpose: "Locate consent withdrawal mechanisms"
    - pattern: "(cookie|tracking|analytics|marketing).*consent"
      type: "regex"
      scope: "source"
      purpose: "Find specific consent categories"

  file_patterns:
    - glob: "**/consent/**"
      purpose: "Find consent management modules"
    - glob: "**/privacy/**"
      purpose: "Locate privacy-related code"
    - glob: "**/components/*Cookie*"
      purpose: "Find cookie consent implementations"

knowledge_sources:
  specifications:
    - id: "gdpr-art7"
      name: "GDPR Article 7 - Conditions for Consent"
      url: "https://gdpr-info.eu/art-7-gdpr/"
      offline_cache: true
      priority: "required"
    - id: "gdpr-recital32"
      name: "GDPR Recital 32 - Consent"
      url: "https://gdpr-info.eu/recitals/no-32/"
      offline_cache: true
      priority: "required"
    - id: "eprivacy"
      name: "ePrivacy Directive (Cookie Law)"
      url: "https://eur-lex.europa.eu/legal-content/EN/TXT/?uri=CELEX:32002L0058"
      offline_cache: true
      priority: "required"

  guides:
    - id: "edpb-consent"
      name: "EDPB Guidelines on Consent"
      url: "https://edpb.europa.eu/our-work-tools/our-documents/guidelines/guidelines-052020-consent-under-regulation-2016679_en"
      offline_cache: true
    - id: "ico-consent"
      name: "ICO Consent Guidance"
      url: "https://ico.org.uk/for-organisations/guide-to-data-protection/guide-to-the-general-data-protection-regulation-gdpr/consent/"
      offline_cache: true

tooling:
  assessment_tools:
    - tool: "Consent flow audit checklist"
      purpose: "Structured evaluation of consent mechanisms"

  scripts:
    - id: "consent-finder"
      language: "bash"
      purpose: "Find consent implementation patterns"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Consent Collection Points ==="
        grep -r -E "(consent|opt.?in|accept.*terms)" \
          --include="*.tsx" --include="*.jsx" --include="*.vue" . 2>/dev/null

        echo "=== Consent Withdrawal ==="
        grep -r -E "(withdraw|revoke|opt.?out)" \
          --include="*.py" --include="*.ts" --include="*.java" . 2>/dev/null

        echo "=== Consent Storage ==="
        grep -r -E "(consent.*record|store.*consent|consent.*log)" \
          --include="*.py" --include="*.ts" . 2>/dev/null

signals:
  critical:
    - id: "CON-CRIT-001"
      signal: "Consent bundled with service acceptance"
      evidence_indicators:
        - "Single checkbox for terms and data processing consent"
        - "Cannot use service without consenting to optional processing"
      explanation: |
        GDPR requires consent to be freely given. Bundling consent with terms
        of service or making service conditional on optional consent is invalid.
        Each processing purpose should have separate consent where required.
      remediation: "Separate service terms from data processing consent"

    - id: "CON-CRIT-002"
      signal: "No mechanism to withdraw consent"
      evidence_indicators:
        - "No withdrawal UI or process"
        - "Withdrawal harder than giving consent"
      explanation: |
        GDPR Article 7(3) requires withdrawal of consent to be as easy as giving
        it. Missing or difficult withdrawal mechanism invalidates consent.
      remediation: "Implement easy consent withdrawal mechanism"

    - id: "CON-CRIT-003"
      signal: "Pre-ticked consent boxes"
      evidence_indicators:
        - "Consent checkboxes pre-selected"
        - "Default to opt-in"
      explanation: |
        GDPR requires consent to be unambiguous through clear affirmative action.
        Pre-ticked boxes or opt-out mechanisms do not constitute valid consent.
      remediation: "Remove pre-ticked consent; require affirmative action"

  high:
    - id: "CON-HIGH-001"
      signal: "Consent records incomplete or missing"
      explanation: "Organizations must demonstrate consent was validly obtained"
      remediation: "Implement comprehensive consent logging (who, what, when, how)"

    - id: "CON-HIGH-002"
      signal: "Consent language unclear or jargon-heavy"
      explanation: "Consent must be informed through clear, plain language"
      remediation: "Rewrite consent language in plain, accessible terms"

  medium:
    - id: "CON-MED-001"
      signal: "Consent not granular for different purposes"
      remediation: "Implement granular consent for each processing purpose"

    - id: "CON-MED-002"
      signal: "Consent not refreshed after significant changes"
      remediation: "Re-obtain consent when processing purposes change"

  low:
    - id: "CON-LOW-001"
      signal: "Consent preferences not easily accessible to users"
      remediation: "Provide consent management dashboard for users"

  positive:
    - id: "CON-POS-001"
      signal: "Granular consent with clear purpose explanations"
    - id: "CON-POS-002"
      signal: "Easy withdrawal mechanism prominently accessible"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Map consent collection points"
      description: |
        Identify all points where consent is collected in the application.
        Document consent types, purposes, and collection mechanisms.
      duration_estimate: "45 min"
      commands:
        - purpose: "Find consent UI components"
          command: "grep -r -E '(consent|opt.?in|accept)' --include='*.tsx' --include='*.jsx' --include='*.vue' ."
      expected_findings:
        - "Complete inventory of consent collection points"
        - "Consent purpose mapping"

    - id: "2"
      name: "Evaluate consent validity"
      description: |
        Assess each consent mechanism against GDPR validity requirements:
        freely given, specific, informed, unambiguous.
      duration_estimate: "60 min"
      questions:
        - "Is consent separate from service terms?"
        - "Is consent specific to each processing purpose?"
        - "Is consent language clear and informative?"
        - "Does consent require affirmative action (no pre-ticking)?"
      expected_findings:
        - "Validity assessment for each consent type"
        - "Invalid consent mechanisms identified"

    - id: "3"
      name: "Review consent withdrawal"
      description: |
        Evaluate consent withdrawal mechanisms. Verify withdrawal is as
        easy as giving consent and takes effect promptly.
      duration_estimate: "45 min"
      commands:
        - purpose: "Find withdrawal mechanisms"
          command: "grep -r -E '(withdraw|revoke|opt.?out)' --include='*.py' --include='*.ts' ."
      expected_findings:
        - "Withdrawal mechanism assessment"
        - "Comparison of consent vs withdrawal difficulty"

    - id: "4"
      name: "Verify consent record-keeping"
      description: |
        Review consent logging and storage. Verify records capture
        who consented, to what, when, and how.
      duration_estimate: "45 min"
      expected_findings:
        - "Consent record completeness"
        - "Record retention practices"

    - id: "5"
      name: "Check for dark patterns"
      description: |
        Evaluate consent interfaces for manipulative dark patterns
        that undermine free choice.
      duration_estimate: "30 min"
      questions:
        - "Is the reject option equally prominent as accept?"
        - "Are there misleading visual hierarchies?"
        - "Is there confirmshaming language?"
        - "Are privacy-friendly defaults provided?"
      expected_findings:
        - "Dark pattern identification"
        - "UI manipulation assessment"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "consent_assessment"
      format: "structured"
      sections:
        - "Consent Inventory"
        - "Validity Assessment"
        - "Withdrawal Evaluation"
        - "Record-keeping Review"
        - "Dark Pattern Analysis"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Key Findings"
        - "Recommendations"

  confidence_guidance:
    high: "All consent flows tested and records reviewed"
    medium: "Key consent mechanisms evaluated"
    low: "Limited access to consent systems"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "gdpr-art7"
        priority: "required"
      - source_id: "edpb-consent"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed consent flow analysis"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "con-001"
    item: "All consent collection points identified"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Complete consent inventory exists"
    expected: "Confirmed by reviewer"

  - id: "con-002"
    item: "Consent meets GDPR validity requirements"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Each consent freely given, specific, informed, unambiguous"
    expected: "Confirmed by reviewer"

  - id: "con-003"
    item: "Consent withdrawal mechanism exists and is accessible"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Withdrawal as easy as giving consent"
    expected: "Confirmed by reviewer"

  - id: "con-004"
    item: "No dark patterns in consent interfaces"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Accept/reject equally prominent, no manipulative design"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "GDPR"
      controls: ["Article 7", "Article 4(11)", "Recital 32"]
    - framework: "ePrivacy Directive"
      controls: ["Article 5(3)"]

relationships:
  commonly_combined:
    - "ethical-societal.privacy-data-ethics.data-subject-rights"
    - "ethical-societal.privacy-data-ethics.privacy-by-design"
    - "ethical-societal.digital-wellbeing.dark-pattern-detection"
