# ============================================================
# AUDIT: Third-Party Data Sharing
# ============================================================
# Evaluates data sharing practices with third parties for
# compliance, contractual protections, and ethical standards.

audit:
  id: "ethical-societal.privacy-data-ethics.third-party-data-sharing"

  name: "Third-Party Data Sharing"

  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "ethical-societal"
  category_number: 18
  subcategory: "privacy-data-ethics"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "data"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates data sharing relationships with third parties including
    processors, joint controllers, and data recipients. Assesses lawful
    basis, contractual protections, data transfer mechanisms, user
    transparency, and ongoing oversight of third-party data handling.
    Covers both technical data flows and governance arrangements.

  why_it_matters: |
    Organizations remain accountable for data shared with third parties.
    Inadequate third-party oversight has led to major breaches and regulatory
    enforcement (e.g., Facebook-Cambridge Analytica). GDPR requires processor
    contracts (Article 28) and transfer mechanisms for international transfers.
    Poor third-party governance is one of the most common compliance failures.

  when_to_run:
    - "Before engaging new data processors or recipients"
    - "When renewing third-party contracts"
    - "During annual third-party risk assessments"
    - "After third-party data incidents"

prerequisites:
  required_artifacts:
    - type: "third_party_inventory"
      description: "Registry of third parties receiving data"
    - type: "data_processing_agreements"
      description: "Contracts with data processors"

  access_requirements:
    - "Third-party contracts and agreements"
    - "Data flow documentation"
    - "Technical integration code"

discovery:
  code_patterns:
    - pattern: "(api|sdk|client).*(?:send|push|share|transfer)"
      type: "regex"
      scope: "source"
      purpose: "Find data transmission to external services"
    - pattern: "(analytics|tracking|advertising|marketing).*(?:send|track|pixel)"
      type: "regex"
      scope: "source"
      purpose: "Locate analytics and advertising integrations"
    - pattern: "(third.?party|vendor|partner|external)"
      type: "regex"
      scope: "config"
      purpose: "Find third-party configurations"

  file_patterns:
    - glob: "**/integrations/**"
      purpose: "Find third-party integrations"
    - glob: "**/vendors/**"
      purpose: "Locate vendor-specific code"
    - glob: "**/*sdk*"
      purpose: "Find SDK integrations"

  documents_to_review:
    - type: "Data Processing Agreements"
      purpose: "Review processor contractual protections"
    - type: "Third-party inventory"
      purpose: "Identify all data recipients"
    - type: "Privacy policy"
      purpose: "Verify third-party sharing disclosure"

knowledge_sources:
  specifications:
    - id: "gdpr-art28"
      name: "GDPR Article 28 - Processor"
      url: "https://gdpr-info.eu/art-28-gdpr/"
      offline_cache: true
      priority: "required"
    - id: "gdpr-ch5"
      name: "GDPR Chapter 5 - International Transfers"
      url: "https://gdpr-info.eu/chapter-5/"
      offline_cache: true
      priority: "required"

  guides:
    - id: "edpb-transfers"
      name: "EDPB Guidance on International Transfers"
      url: "https://edpb.europa.eu/our-work-tools/our-documents/recommendations/recommendations-012020-measures-supplement-transfer_en"
      offline_cache: true
    - id: "sccs"
      name: "EU Standard Contractual Clauses"
      url: "https://ec.europa.eu/info/law/law-topic/data-protection/international-dimension-data-protection/standard-contractual-clauses-scc_en"
      offline_cache: true

tooling:
  assessment_tools:
    - tool: "Third-party risk assessment framework"
      purpose: "Structured evaluation of sharing arrangements"

  scripts:
    - id: "third-party-finder"
      language: "bash"
      purpose: "Find third-party data transmissions in code"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== External API Calls ==="
        grep -r -E "(https?://[^/]+\.(com|io|net|org))" \
          --include="*.py" --include="*.ts" --include="*.js" . 2>/dev/null | \
          grep -v "localhost\|127.0.0.1\|example.com" | head -30

        echo "=== Analytics/Tracking ==="
        grep -r -E "(google.?analytics|segment|mixpanel|amplitude|facebook.?pixel)" \
          --include="*.py" --include="*.ts" --include="*.js" --include="*.html" . 2>/dev/null | head -20

        echo "=== SDK Integrations ==="
        grep -r -E "import.*sdk\|require.*sdk" \
          --include="*.py" --include="*.ts" --include="*.js" . 2>/dev/null | head -20

signals:
  critical:
    - id: "3P-CRIT-001"
      signal: "Personal data shared without data processing agreement"
      evidence_indicators:
        - "Third party receives personal data"
        - "No Article 28 compliant DPA in place"
      explanation: |
        GDPR Article 28 requires binding contracts with processors specifying
        subject matter, duration, nature, and purpose of processing. Sharing
        without DPA is a compliance violation.
      remediation: "Execute Article 28 compliant data processing agreement"

    - id: "3P-CRIT-002"
      signal: "International transfer without valid mechanism"
      evidence_indicators:
        - "Data transferred outside EEA"
        - "No adequacy decision, SCCs, or BCRs in place"
      explanation: |
        GDPR Chapter 5 restricts international transfers to countries without
        adequacy decisions unless appropriate safeguards (SCCs, BCRs) are in place.
      remediation: "Implement valid transfer mechanism (SCCs, BCRs, or adequacy)"

  high:
    - id: "3P-HIGH-001"
      signal: "Third-party sharing not disclosed in privacy policy"
      explanation: "Users must be informed about data recipients"
      remediation: "Update privacy policy to disclose all data sharing"

    - id: "3P-HIGH-002"
      signal: "No audit rights over processor"
      explanation: "Controllers must be able to verify processor compliance"
      remediation: "Ensure DPA includes audit rights"

  medium:
    - id: "3P-MED-001"
      signal: "Third-party inventory incomplete or outdated"
      remediation: "Maintain current inventory of all data recipients"

    - id: "3P-MED-002"
      signal: "No regular third-party compliance monitoring"
      remediation: "Implement ongoing third-party oversight program"

  low:
    - id: "3P-LOW-001"
      signal: "Third-party sub-processor changes not monitored"
      remediation: "Monitor and review sub-processor changes"

  positive:
    - id: "3P-POS-001"
      signal: "Comprehensive third-party risk management program"
    - id: "3P-POS-002"
      signal: "Regular third-party audits conducted"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory third-party data sharing"
      description: |
        Create or verify inventory of all third parties receiving
        personal data. Include processors, joint controllers, and other recipients.
      duration_estimate: "60 min"
      commands:
        - purpose: "Find external API integrations"
          command: "grep -r -E 'https?://[^/]+\\.(com|io|net)' --include='*.py' --include='*.ts' . | grep -v 'localhost\\|example' | head -30"
      expected_findings:
        - "Complete third-party inventory"
        - "Data flow documentation"

    - id: "2"
      name: "Review contractual protections"
      description: |
        Examine data processing agreements and other contracts
        for Article 28 compliance and appropriate safeguards.
      duration_estimate: "90 min"
      questions:
        - "Does each processor have a compliant DPA?"
        - "Are all required Article 28 elements present?"
        - "Are audit rights included?"
      expected_findings:
        - "Contract compliance assessment"
        - "Missing or inadequate agreements"

    - id: "3"
      name: "Assess international transfers"
      description: |
        Identify transfers outside EEA and verify appropriate
        transfer mechanisms are in place.
      duration_estimate: "45 min"
      questions:
        - "Where are third parties located?"
        - "What transfer mechanism is used for each?"
        - "Is supplementary measures assessment completed (Schrems II)?"
      expected_findings:
        - "Transfer mechanism inventory"
        - "Compliance gaps for international transfers"

    - id: "4"
      name: "Verify transparency"
      description: |
        Confirm that third-party sharing is adequately disclosed
        in privacy notices and user communications.
      duration_estimate: "30 min"
      expected_findings:
        - "Transparency assessment"
        - "Disclosure completeness"

    - id: "5"
      name: "Review ongoing oversight"
      description: |
        Evaluate processes for ongoing third-party compliance
        monitoring and incident response.
      duration_estimate: "45 min"
      questions:
        - "How is third-party compliance monitored?"
        - "When were third parties last assessed?"
        - "How are third-party incidents handled?"
      expected_findings:
        - "Oversight process assessment"
        - "Monitoring gaps"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "third_party_assessment"
      format: "structured"
      sections:
        - "Third-Party Inventory"
        - "Contract Review"
        - "Transfer Mechanism Analysis"
        - "Transparency Assessment"
        - "Oversight Evaluation"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Key Findings"
        - "Risk Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Complete inventory and contract review"
    medium: "Key third parties assessed"
    low: "Based on code analysis only"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "gdpr-art28"
        priority: "required"
      - source_id: "gdpr-ch5"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive third-party assessment"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "3p-001"
    item: "Third-party inventory complete"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "All data recipients catalogued"
    expected: "Confirmed by reviewer"

  - id: "3p-002"
    item: "DPAs in place for all processors"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Article 28 compliant agreements verified"
    expected: "Confirmed by reviewer"

  - id: "3p-003"
    item: "Valid transfer mechanisms for international transfers"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "SCCs, BCRs, or adequacy for all non-EEA transfers"
    expected: "Confirmed by reviewer"

  - id: "3p-004"
    item: "Third-party sharing disclosed in privacy policy"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Privacy policy lists data recipients"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "GDPR"
      controls: ["Article 28", "Chapter 5"]
    - framework: "CCPA"
      controls: ["1798.140(w)", "1798.115"]

relationships:
  commonly_combined:
    - "ethical-societal.privacy-data-ethics.consent-management"
    - "ethical-societal.privacy-data-ethics.anonymization-effectiveness"
