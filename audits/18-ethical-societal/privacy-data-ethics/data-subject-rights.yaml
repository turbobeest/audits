# ============================================================
# AUDIT: Data Subject Rights
# ============================================================
# Evaluates implementation of data subject rights including
# access, rectification, erasure, portability, and objection.

audit:
  id: "ethical-societal.privacy-data-ethics.data-subject-rights"

  name: "Data Subject Rights"

  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "ethical-societal"
  category_number: 18
  subcategory: "privacy-data-ethics"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "codebase"

  default_profiles:
    - "full"
    - "security"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates implementation of data subject rights under GDPR including the
    right of access (Article 15), rectification (Article 16), erasure/right
    to be forgotten (Article 17), restriction of processing (Article 18),
    data portability (Article 20), and objection (Article 21). Assesses both
    technical capability and operational readiness to fulfill requests.

  why_it_matters: |
    Data subject rights are fundamental to GDPR compliance. Failure to honor
    rights requests within required timeframes (typically 30 days) constitutes
    a violation subject to enforcement action. Beyond compliance, honoring
    privacy rights builds trust and demonstrates respect for users. Organizations
    must be technically capable of fulfilling all applicable rights.

  when_to_run:
    - "When building user-facing data management features"
    - "During privacy compliance assessments"
    - "Before regulatory audits"
    - "After data subject complaints"

prerequisites:
  required_artifacts:
    - type: "data_subject_rights_procedures"
      description: "Documented procedures for handling rights requests"
    - type: "data_inventory"
      description: "Complete inventory of personal data and locations"

  access_requirements:
    - "Data subject rights implementation code"
    - "Rights request handling procedures"
    - "All systems containing personal data"

discovery:
  code_patterns:
    - pattern: "(export|download|portability).*data"
      type: "regex"
      scope: "source"
      purpose: "Find data export functionality"
    - pattern: "(delete|erase|remove|forget).*(?:user|account|data)"
      type: "regex"
      scope: "source"
      purpose: "Find deletion capabilities"
    - pattern: "(access|view|retrieve).*personal.*data"
      type: "regex"
      scope: "source"
      purpose: "Find data access functionality"

  file_patterns:
    - glob: "**/gdpr/**"
      purpose: "Find GDPR-related implementations"
    - glob: "**/privacy/**"
      purpose: "Locate privacy modules"
    - glob: "**/account/**"
      purpose: "Find account management features"

knowledge_sources:
  specifications:
    - id: "gdpr-ch3"
      name: "GDPR Chapter 3 - Rights of the Data Subject"
      url: "https://gdpr-info.eu/chapter-3/"
      offline_cache: true
      priority: "required"
    - id: "gdpr-art15"
      name: "GDPR Article 15 - Right of Access"
      url: "https://gdpr-info.eu/art-15-gdpr/"
      offline_cache: true
      priority: "required"
    - id: "gdpr-art17"
      name: "GDPR Article 17 - Right to Erasure"
      url: "https://gdpr-info.eu/art-17-gdpr/"
      offline_cache: true
      priority: "required"

  guides:
    - id: "ico-individual-rights"
      name: "ICO Guide to Individual Rights"
      url: "https://ico.org.uk/for-organisations/guide-to-data-protection/guide-to-the-general-data-protection-regulation-gdpr/individual-rights/"
      offline_cache: true
    - id: "edpb-transparency"
      name: "EDPB Transparency Guidelines"
      url: "https://edpb.europa.eu/our-work-tools/our-documents/guidelines/guidelines-transparency_en"
      offline_cache: true

tooling:
  assessment_tools:
    - tool: "Rights request simulation"
      purpose: "Test ability to fulfill each right type"

  scripts:
    - id: "dsr-finder"
      language: "bash"
      purpose: "Find data subject rights implementations"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Data Export/Portability ==="
        grep -r -E "(export|download|portability)" \
          --include="*.py" --include="*.ts" . 2>/dev/null | head -20

        echo "=== Data Deletion ==="
        grep -r -E "(delete|erase|remove|forget).*user" \
          --include="*.py" --include="*.ts" . 2>/dev/null | head -20

        echo "=== Data Access ==="
        grep -r -E "(get|retrieve|access).*personal" \
          --include="*.py" --include="*.ts" . 2>/dev/null | head -20

signals:
  critical:
    - id: "DSR-CRIT-001"
      signal: "No mechanism to delete user data on request"
      evidence_indicators:
        - "No deletion API or functionality"
        - "Data retained in backups indefinitely after deletion"
        - "Deletion not propagated to all systems"
      explanation: |
        GDPR Article 17 provides right to erasure (right to be forgotten).
        Inability to delete user data on request is a fundamental compliance
        failure subject to significant fines.
      remediation: "Implement comprehensive data deletion across all systems"

    - id: "DSR-CRIT-002"
      signal: "Cannot provide user's personal data on access request"
      evidence_indicators:
        - "No data export functionality"
        - "Data scattered across systems with no unified access"
      explanation: |
        GDPR Article 15 provides right of access. Users must be able to obtain
        copy of their personal data. Inability to provide this violates rights.
      remediation: "Implement data access/export functionality"

  high:
    - id: "DSR-HIGH-001"
      signal: "Data portability format not machine-readable"
      explanation: "Article 20 requires data in commonly used, machine-readable format"
      remediation: "Export data in JSON, CSV, or other machine-readable format"

    - id: "DSR-HIGH-002"
      signal: "Deletion incomplete - data remains in some systems"
      explanation: "Deletion must be complete across all processing systems"
      remediation: "Audit and ensure deletion propagates to all data stores"

  medium:
    - id: "DSR-MED-001"
      signal: "No self-service rights exercise mechanism"
      remediation: "Implement user-facing privacy dashboard for rights exercise"

    - id: "DSR-MED-002"
      signal: "Rights request workflow not tracked"
      remediation: "Implement request tracking to ensure timely response"

  low:
    - id: "DSR-LOW-001"
      signal: "Rights exercise instructions not easily findable"
      remediation: "Prominently document how to exercise each right"

  positive:
    - id: "DSR-POS-001"
      signal: "Self-service privacy dashboard for all rights"
    - id: "DSR-POS-002"
      signal: "Automated request fulfillment within timeframes"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory applicable rights"
      description: |
        Determine which data subject rights apply based on processing
        activities and lawful basis. Not all rights apply in all circumstances.
      duration_estimate: "30 min"
      questions:
        - "What is the lawful basis for each processing activity?"
        - "Which rights apply given the lawful basis?"
        - "Are there any exemptions (e.g., legal obligations)?"
      expected_findings:
        - "Applicable rights inventory"
        - "Exemption documentation"

    - id: "2"
      name: "Test right of access"
      description: |
        Verify ability to provide data subjects with copy of their
        personal data in response to access request.
      duration_estimate: "60 min"
      commands:
        - purpose: "Find data export functionality"
          command: "grep -r -E '(export|download).*data' --include='*.py' --include='*.ts' ."
      expected_findings:
        - "Access mechanism assessment"
        - "Data completeness verification"

    - id: "3"
      name: "Test right to erasure"
      description: |
        Verify ability to delete user data across all systems.
        Test that deletion is complete and verifiable.
      duration_estimate: "60 min"
      commands:
        - purpose: "Find deletion functionality"
          command: "grep -r -E '(delete|erase|remove).*user' --include='*.py' --include='*.ts' ."
      expected_findings:
        - "Deletion mechanism assessment"
        - "Completeness across systems"

    - id: "4"
      name: "Test data portability"
      description: |
        Verify ability to export user data in machine-readable format
        suitable for transfer to another controller.
      duration_estimate: "45 min"
      expected_findings:
        - "Portability format assessment"
        - "Data completeness for portability"

    - id: "5"
      name: "Review request handling process"
      description: |
        Evaluate operational procedures for receiving, verifying,
        and fulfilling rights requests within required timeframes.
      duration_estimate: "45 min"
      questions:
        - "How are requests received and logged?"
        - "How is identity verified?"
        - "How is timely response ensured?"
      expected_findings:
        - "Process adequacy assessment"
        - "Timeline compliance capability"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "dsr_assessment"
      format: "structured"
      sections:
        - "Rights Applicability"
        - "Access Capability"
        - "Erasure Capability"
        - "Portability Capability"
        - "Process Assessment"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Key Findings"
        - "Compliance Status"
        - "Recommendations"

  confidence_guidance:
    high: "All rights tested with verification"
    medium: "Key rights tested"
    low: "Based on code review only"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "gdpr-ch3"
        priority: "required"
      - source_id: "ico-individual-rights"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive rights testing"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "dsr-001"
    item: "Right of access can be fulfilled"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Data export produces complete user data"
    expected: "Confirmed by reviewer"

  - id: "dsr-002"
    item: "Right to erasure can be fulfilled"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Deletion removes data from all systems"
    expected: "Confirmed by reviewer"

  - id: "dsr-003"
    item: "Data portability in machine-readable format"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Export in JSON, CSV, or equivalent format"
    expected: "Confirmed by reviewer"

  - id: "dsr-004"
    item: "Request handling process documented"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Procedures ensure response within 30 days"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "GDPR"
      controls: ["Articles 15-22"]
    - framework: "CCPA"
      controls: ["1798.100-1798.125"]

relationships:
  commonly_combined:
    - "ethical-societal.privacy-data-ethics.data-minimization"
    - "ethical-societal.privacy-data-ethics.consent-management"
