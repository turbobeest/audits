# ============================================================
# AUDIT: Consistency of Pattern Usage
# ============================================================
# Evaluates whether design patterns are applied consistently
# across the codebase for similar problems.
# ============================================================

audit:
  id: "architecture-design.architectural-patterns.consistency-of-pattern-usage"
  name: "Consistency of Pattern Usage"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "architecture-design"
  category_number: 7
  subcategory: "architectural-patterns"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "codebase"

  default_profiles:
    - "full"
    - "architecture"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit evaluates whether design patterns are applied consistently
    throughout the codebase. It identifies cases where similar problems
    are solved differently in different parts of the code, creating
    confusion and maintenance overhead.

  why_it_matters: |
    Inconsistent pattern usage causes:
    - Cognitive overhead switching between approaches
    - Difficulty establishing team conventions
    - Harder onboarding - no single "right way"
    - Maintenance complexity with multiple solutions
    - Reduced code reusability
    Consistency enables pattern recognition and faster development.

  when_to_run:
    - "During architecture reviews"
    - "When codebase has grown organically"
    - "When multiple teams work on same codebase"
    - "When establishing coding standards"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Complete source code"
    - type: "coding_standards"
      description: "Documented coding standards (optional)"

  access_requirements:
    - "Read access to source code"

discovery:
  code_patterns:
    - pattern: "Factory|Builder|Strategy|Repository|Service|Handler"
      type: "keyword"
      scope: "source"
      purpose: "Find pattern implementations"

    - pattern: "@Autowired|@Inject|new\\s+[A-Z]"
      type: "regex"
      scope: "source"
      purpose: "Find dependency management patterns"

  file_patterns:
    - glob: "**/*Factory*.{java,ts,py}"
      purpose: "Factory implementations"
    - glob: "**/*Repository*.{java,ts,py}"
      purpose: "Repository implementations"
    - glob: "**/*Service*.{java,ts,py}"
      purpose: "Service implementations"

knowledge_sources:
  specifications:
    - id: "pattern-consistency"
      name: "Pattern Consistency in Enterprise Applications"
      url: "https://martinfowler.com/articles/enterprisePatterns.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "style-guides"
      name: "Google Style Guides"
      url: "https://google.github.io/styleguide/"
      offline_cache: true

    - id: "design-patterns-gof"
      name: "Design Patterns - GoF"
      url: "https://refactoring.guru/design-patterns"
      offline_cache: true

    - id: "building-microservices"
      name: "Building Microservices"
      url: "https://samnewman.io/books/building_microservices_2nd_edition/"
      offline_cache: true

  learning_resources:
    - id: "clean-code"
      title: "Clean Code"
      type: "book"
      reference: "Robert C. Martin"

tooling:
  static_analysis:
    - tool: "SonarQube"
      purpose: "Consistency rules and custom checks"
      offline_capable: false

    - tool: "Checkstyle"
      purpose: "Java coding standard enforcement"
      offline_capable: true

    - tool: "ESLint"
      purpose: "JavaScript/TypeScript consistency"
      offline_capable: true

  scripts:
    - id: "consistency-checker"
      language: "bash"
      purpose: "Check pattern naming consistency"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Dependency Injection Patterns ==="
        echo "Field injection:"
        grep -rc "@Autowired\|@Inject" --include="*.java" | grep -v ":0" | wc -l
        echo "Constructor injection:"
        grep -rc "private final.*;" --include="*.java" | grep -v ":0" | wc -l

        echo "=== Naming Conventions ==="
        echo "Services:"
        find . -name "*Service.java" | wc -l
        echo "Managers:"
        find . -name "*Manager.java" | wc -l
        echo "Handlers:"
        find . -name "*Handler.java" | wc -l

signals:
  critical:
    - id: "CONSIST-CRIT-001"
      signal: "Mixed dependency injection patterns (field vs constructor)"
      evidence_pattern: "Some classes use @Autowired on fields, others use constructor"
      explanation: |
        Mixing DI patterns creates confusion about the preferred approach
        and makes testing inconsistent across the codebase.
      remediation: "Standardize on constructor injection; document in style guide"

    - id: "CONSIST-CRIT-002"
      signal: "Multiple competing patterns for same concern"
      evidence_pattern: "Service Locator and DI both used; Repository and DAO both exist"
      explanation: |
        Having two approaches for the same concern means developers must
        learn both, and code mixes styles unpredictably.
      remediation: "Choose one approach; migrate legacy; document decision"

  high:
    - id: "CONSIST-HIGH-001"
      signal: "Inconsistent naming conventions for same pattern"
      evidence_pattern: "UserService, OrderManager, PaymentHandler for equivalent roles"
      explanation: |
        Inconsistent naming makes it hard to find related code and
        understand the role of a class from its name.
      remediation: "Establish naming convention; rename for consistency"

    - id: "CONSIST-HIGH-002"
      signal: "Different error handling patterns across modules"
      evidence_pattern: "Some use exceptions, some use Result types, some return null"
      explanation: |
        Inconsistent error handling confuses developers and leads to
        incomplete error handling at boundaries.
      remediation: "Standardize error handling approach; document exceptions vs results"

  medium:
    - id: "CONSIST-MED-001"
      signal: "Inconsistent async patterns"
      evidence_pattern: "Some code uses callbacks, some uses Promises, some uses async/await"
      remediation: "Standardize on modern async pattern (async/await)"

    - id: "CONSIST-MED-002"
      signal: "Mixed logging approaches"
      evidence_pattern: "Some use logging framework, some use System.out"
      remediation: "Standardize on logging framework; remove console output"

  low:
    - id: "CONSIST-LOW-001"
      signal: "Minor style variations in pattern implementation"
      remediation: "Document preferred style; update over time"

  positive:
    - id: "CONSIST-POS-001"
      signal: "Consistent pattern usage across modules"
    - id: "CONSIST-POS-002"
      signal: "Clear documented conventions"
    - id: "CONSIST-POS-003"
      signal: "Automated enforcement of patterns"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory pattern implementations"
      description: |
        Catalog all pattern implementations and their variations
        across the codebase.
      duration_estimate: "30 min"
      commands:
        - purpose: "Count pattern types"
          command: "for p in Factory Builder Strategy Repository Service Handler; do echo \"$p: $(find . -name \"*$p*.java\" | wc -l)\"; done"
        - purpose: "Find pattern keywords"
          command: "grep -rh 'class.*Factory\\|class.*Builder\\|class.*Strategy' --include='*.java' | head -30"
      expected_findings:
        - "Pattern type distribution"
        - "Implementation variations"

    - id: "2"
      name: "Analyze dependency injection patterns"
      description: |
        Check for consistency in how dependencies are injected
        across the codebase.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find field injection"
          command: "grep -rn '@Autowired\\|@Inject' --include='*.java' | grep -v constructor | head -30"
        - purpose: "Find constructor injection"
          command: "grep -rn 'private final.*Repository\\|private final.*Service' --include='*.java' | head -30"
      expected_findings:
        - "DI pattern distribution"
        - "Inconsistencies"

    - id: "3"
      name: "Check naming conventions"
      description: |
        Verify consistent naming for classes serving similar
        roles.
      duration_estimate: "20 min"
      commands:
        - purpose: "Compare naming patterns"
          command: "find . -name '*Service*.java' -o -name '*Manager*.java' -o -name '*Handler*.java' | cut -d/ -f3- | sort"
        - purpose: "Find similar patterns differently named"
          command: "find . -name '*.java' | xargs grep -l 'Repository\\|Dao\\|DataAccess' | head -20"
      expected_findings:
        - "Naming convention adherence"
        - "Naming inconsistencies"

    - id: "4"
      name: "Evaluate error handling patterns"
      description: |
        Check for consistency in how errors are handled and
        communicated.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find exception usage"
          command: "grep -rn 'throw new' --include='*.java' | cut -d: -f3 | sort | uniq -c | sort -rn | head -15"
        - purpose: "Find result/optional patterns"
          command: "grep -rn 'Optional<\\|Result<\\|Either<' --include='*.java' | head -20"
      expected_findings:
        - "Error handling approaches"
        - "Pattern mixing"

    - id: "5"
      name: "Document standardization recommendations"
      description: |
        Based on findings, recommend which patterns to standardize
        and how to migrate.
      duration_estimate: "25 min"
      questions:
        - "Which pattern variant is most common?"
        - "Which variant is preferred by the team/industry?"
        - "What's the migration path to consistency?"
      expected_findings:
        - "Standardization recommendations"
        - "Migration priority"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "consistency_matrix"
      format: "tabular"
      sections:
        - "Concern"
        - "Pattern Variants Found"
        - "Recommended Standard"
        - "Migration Effort"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Consistency Analysis"
        - "Standardization Recommendations"

  confidence_guidance:
    high: "Clear inconsistency measurable by grep"
    medium: "Pattern variation detected"
    low: "Minor style differences"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "pattern-consistency"
        priority: "required"
      - source_id: "style-guides"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive analysis"
    full:
      included: true
      priority: 2
    architecture:
      included: true
      priority: 2

closeout_checklist:
  - id: "consist-001"
    item: "Dependency injection pattern standardized"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Single DI approach used consistently"
    expected: "Confirmed by reviewer"

  - id: "consist-002"
    item: "Naming conventions documented and followed"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Service/Manager/Handler used consistently"
    expected: "Confirmed by reviewer"

  - id: "consist-003"
    item: "Error handling approach standardized"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Consistent exception vs result pattern"
    expected: "Confirmed by reviewer"

  - id: "consist-004"
    item: "Conventions documented in style guide"
    level: "WARNING"
    verification: "find . -name 'STYLE*' -o -name 'CODING*' -o -name 'CONTRIBUTING*' | wc -l"
    expected: ">0"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Consistency"]

relationships:
  commonly_combined:
    - "architecture-design.architectural-patterns.pattern-appropriateness"
    - "architecture-design.architectural-patterns.pattern-implementation-correctness"
    - "architecture-design.design-principles.single-responsibility"
