# ============================================================
# AUDIT: Aspect Separation Assessment
# ============================================================
# Evaluates how well aspects (cross-cutting concerns) are
# separated from core business logic using AOP or similar.
# ============================================================

audit:
  id: "architecture-design.cross-cutting-concerns.aspect-separation"
  name: "Aspect Separation Assessment"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "architecture-design"
  category_number: 7
  subcategory: "cross-cutting-concerns"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "architecture"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit evaluates aspect separation - the degree to which
    cross-cutting concerns are modularized into aspects, decorators,
    or similar constructs rather than scattered throughout business
    code. It assesses the use of AOP, decorator patterns, and
    metaprogramming for concern separation.

  why_it_matters: |
    Poor aspect separation causes:
    - Business logic obscured by infrastructure code
    - Tangled concerns that are hard to modify independently
    - Duplicated aspect code across multiple components
    - Difficulty testing business logic in isolation
    - High maintenance cost for changing concern behavior
    Clean separation enables focused business logic and reusable aspects.

  when_to_run:
    - "During architecture reviews"
    - "When business code is cluttered with infrastructure"
    - "Before implementing new cross-cutting concerns"
    - "When refactoring for cleaner separation"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Complete source code"

  access_requirements:
    - "Read access to source code"

discovery:
  code_patterns:
    - pattern: "@Aspect|@Before|@After|@Around"
      type: "regex"
      scope: "source"
      purpose: "Find AOP aspect definitions"

    - pattern: "Decorator|Wrapper|Proxy"
      type: "keyword"
      scope: "source"
      purpose: "Find decorator pattern implementations"

    - pattern: "pointcut|joinpoint|advice"
      type: "keyword"
      scope: "source"
      purpose: "Find AOP terminology"

  file_patterns:
    - glob: "**/*Aspect*.{java,ts}"
      purpose: "Aspect implementations"
    - glob: "**/*Decorator*.{java,ts}"
      purpose: "Decorator implementations"
    - glob: "**/aop/**"
      purpose: "AOP configuration"

knowledge_sources:
  specifications:
    - id: "aop-spec"
      name: "Aspect-Oriented Programming"
      url: "https://en.wikipedia.org/wiki/Aspect-oriented_programming"
      offline_cache: true
      priority: "required"

  guides:
    - id: "spring-aop"
      name: "Spring AOP"
      url: "https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#aop"
      offline_cache: true

  learning_resources:
    - id: "aspectj"
      title: "AspectJ in Action"
      type: "book"
      reference: "Ramnivas Laddad"

    - id: "decorator-pattern"
      title: "Design Patterns"
      type: "book"
      reference: "Gang of Four - Decorator Pattern"

tooling:
  static_analysis:
    - tool: "SonarQube"
      purpose: "Detect aspect separation issues"
      offline_capable: false

    - tool: "ajdt"
      purpose: "AspectJ development tools"
      offline_capable: true

  scripts:
    - id: "aspect-analyzer"
      language: "bash"
      purpose: "Analyze aspect separation"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Aspect Definitions ==="
        grep -rn "@Aspect" --include="*.java" | head -20

        echo "=== Pointcut Definitions ==="
        grep -rn "@Pointcut\|pointcut" --include="*.java" | head -20

        echo "=== Advice Definitions ==="
        grep -rn "@Before\|@After\|@Around" --include="*.java" | head -30

        echo "=== Decorator Patterns ==="
        find . \( find . -name "*Decorator*.java" -o -name "*Wrapper*.java" \) | head -15

signals:
  critical:
    - id: "ASPECT-CRIT-001"
      signal: "No aspect separation - concerns mixed everywhere"
      evidence_pattern: "Logging, auth, caching inline in every service method"
      explanation: |
        When aspects are not separated, business methods become cluttered
        with infrastructure code, making them hard to understand, test,
        and maintain.
      remediation: "Extract concerns to aspects; use AOP or decorators"

    - id: "ASPECT-CRIT-002"
      signal: "Inconsistent aspect application"
      evidence_pattern: "Some methods have logging aspect, similar ones don't"
      explanation: |
        Inconsistent aspect application defeats the purpose of centralization.
        Some code paths miss the aspect benefits.
      remediation: "Use consistent pointcuts; document coverage"

  high:
    - id: "ASPECT-HIGH-001"
      signal: "Aspect with too broad pointcut"
      evidence_pattern: "Aspect applies to all methods causing performance issues"
      explanation: |
        Overly broad pointcuts cause aspects to run unnecessarily, creating
        performance overhead and unexpected behavior.
      remediation: "Narrow pointcuts to necessary join points"

    - id: "ASPECT-HIGH-002"
      signal: "Aspects with ordering conflicts"
      evidence_pattern: "Multiple aspects on same join point with unclear order"
      explanation: |
        Aspect ordering conflicts cause unpredictable behavior. The
        execution order may differ from expectations.
      remediation: "Use @Order or explicit precedence; document order"

  medium:
    - id: "ASPECT-MED-001"
      signal: "Aspects doing too much"
      evidence_pattern: "Single aspect handles logging, metrics, and error handling"
      remediation: "Split into focused single-concern aspects"

    - id: "ASPECT-MED-002"
      signal: "Hard to debug aspect behavior"
      evidence_pattern: "Aspects without logging make tracing difficult"
      remediation: "Add tracing to aspects; document aspect effects"

  low:
    - id: "ASPECT-LOW-001"
      signal: "Inconsistent aspect naming"
      remediation: "Standardize naming (LoggingAspect, AuthenticationAspect)"

  positive:
    - id: "ASPECT-POS-001"
      signal: "Clean aspect separation via AOP"
    - id: "ASPECT-POS-002"
      signal: "Focused single-concern aspects"
    - id: "ASPECT-POS-003"
      signal: "Well-documented pointcuts"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory aspects"
      description: |
        Catalog all aspects, decorators, and similar constructs.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find aspects"
          command: "grep -rn '@Aspect' --include='*.java' | head -20"
        - purpose: "Find decorators"
          command: "find . -name '*Decorator*.java' -o -name '*Wrapper*.java' | head -15"
        - purpose: "Find advice"
          command: "grep -rn '@Before\\|@After\\|@Around' --include='*.java' | head -30"
      expected_findings:
        - "Aspect inventory"
        - "Implementation approach"

    - id: "2"
      name: "Analyze pointcuts"
      description: |
        Review pointcut definitions for appropriateness.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find pointcuts"
          command: "grep -rn '@Pointcut\\|execution(' --include='*.java' | head -30"
        - purpose: "Find broad pointcuts"
          command: "grep -rn 'execution.*\\*.*\\*(.*)' --include='*.java' | head -20"
      expected_findings:
        - "Pointcut coverage"
        - "Potential over-broad pointcuts"

    - id: "3"
      name: "Check aspect ordering"
      description: |
        Verify that aspect ordering is explicit when needed.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find order definitions"
          command: "grep -rn '@Order\\|getOrder\\|Ordered' --include='*Aspect*.java' | head -20"
        - purpose: "Find multiple aspects on same target"
          command: "grep -rn '@Aspect' --include='*.java' -A10 | grep 'execution' | sort | uniq -c | head -15"
      expected_findings:
        - "Ordering mechanism"
        - "Potential conflicts"

    - id: "4"
      name: "Assess aspect responsibilities"
      description: |
        Evaluate whether aspects are focused on single concerns.
      duration_estimate: "25 min"
      commands:
        - purpose: "Sample aspect implementation"
          command: "for f in $(find . -name '*Aspect*.java' | head -3); do echo \"=== $f ===\"; grep -c '@Before\\|@After\\|@Around' $f; done"
      expected_findings:
        - "Responsibility focus"
        - "Potential splits"

    - id: "5"
      name: "Identify separation opportunities"
      description: |
        Find business code that could benefit from aspect extraction.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find inline logging in services"
          command: "grep -rn 'log\\.' --include='*Service.java' | wc -l"
        - purpose: "Find inline try-catch"
          command: "grep -rn 'try.*{' --include='*Service.java' | wc -l"
      expected_findings:
        - "Extraction opportunities"
        - "Priority concerns"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "aspect_catalog"
      format: "tabular"
      sections:
        - "Aspect"
        - "Concern"
        - "Pointcut"
        - "Coverage"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Aspect Separation Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Clear separation issue identified"
    medium: "Pattern suggests improvement needed"
    low: "Minor enhancement opportunity"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "aop-spec"
        priority: "required"
      - source_id: "spring-aop"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed analysis"
    full:
      included: true
      priority: 2
    architecture:
      included: true
      priority: 2

closeout_checklist:
  - id: "aspect-001"
    item: "Cross-cutting concerns extracted to aspects"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Logging, auth, caching not inline in business code"
    expected: "Confirmed by reviewer"

  - id: "aspect-002"
    item: "Aspects have focused pointcuts"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Pointcuts not overly broad"
    expected: "Confirmed by reviewer"

  - id: "aspect-003"
    item: "Aspect ordering is explicit"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "@Order on aspects with potential conflicts"
    expected: "Confirmed by reviewer"

  - id: "aspect-004"
    item: "Aspects are single-concern"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Each aspect handles one concern"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Modularity"]

relationships:
  commonly_combined:
    - "architecture-design.cross-cutting-concerns.cross-cutting-concern-handling"
    - "architecture-design.design-principles.single-responsibility"
    - "architecture-design.cohesion.feature-scattering"
