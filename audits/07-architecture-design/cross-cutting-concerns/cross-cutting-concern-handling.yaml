# ============================================================
# AUDIT: Cross-Cutting Concern Handling Assessment
# ============================================================
# Evaluates how cross-cutting concerns like logging, security,
# and caching are implemented across the architecture.
# ============================================================

audit:
  id: "architecture-design.cross-cutting-concerns.cross-cutting-concern-handling"
  name: "Cross-Cutting Concern Handling Assessment"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "architecture-design"
  category_number: 7
  subcategory: "cross-cutting-concerns"

  tier: "expert"
  estimated_duration: "2-4 hours"  # median: 3h

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "architecture"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit evaluates how cross-cutting concerns (logging, security,
    caching, transaction management, error handling) are implemented
    across the architecture. It assesses whether these concerns are
    centralized, consistent, and properly separated from business logic.

  why_it_matters: |
    Poor cross-cutting concern handling causes:
    - Duplicated concern code scattered throughout codebase
    - Inconsistent behavior (some areas log, some don't)
    - Business logic polluted with infrastructure code
    - Difficulty changing concern implementations
    - Testing complexity from intertwined concerns
    Proper separation enables consistent, maintainable concern handling.

  when_to_run:
    - "During architecture reviews"
    - "When cross-cutting behavior is inconsistent"
    - "Before implementing new cross-cutting concerns"
    - "When refactoring for consistency"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Complete source code"
    - type: "architecture_documentation"
      description: "Documentation of concern handling strategies"

  access_requirements:
    - "Read access to source code"

discovery:
  code_patterns:
    - pattern: "log\\.\\w+\\(|logger\\.\\w+\\("
      type: "regex"
      scope: "source"
      purpose: "Find logging calls"

    - pattern: "@Transactional|@Cacheable|@Secured"
      type: "regex"
      scope: "source"
      purpose: "Find declarative concern annotations"

    - pattern: "try.*catch|try.*finally"
      type: "regex"
      scope: "source"
      purpose: "Find error handling patterns"

  file_patterns:
    - glob: "**/logging/**"
      purpose: "Logging configuration"
    - glob: "**/security/**"
      purpose: "Security configuration"
    - glob: "**/cache/**"
      purpose: "Caching configuration"

knowledge_sources:
  specifications:
    - id: "aop"
      name: "Aspect-Oriented Programming"
      url: "https://en.wikipedia.org/wiki/Aspect-oriented_programming"
      offline_cache: true
      priority: "required"

  guides:
    - id: "cross-cutting-patterns"
      name: "Cross-Cutting Concerns in Software Design"
      url: "https://martinfowler.com/articles/injection.html"
      offline_cache: true

  learning_resources:
    - id: "aspectj"
      title: "AspectJ in Action"
      type: "book"
      reference: "Ramnivas Laddad"

    - id: "clean-architecture"
      title: "Clean Architecture"
      type: "book"
      reference: "Robert C. Martin"

tooling:
  static_analysis:
    - tool: "SonarQube"
      purpose: "Detect inconsistent concern handling"
      offline_capable: false

    - tool: "Checkstyle"
      purpose: "Verify logging patterns"
      offline_capable: true

  scripts:
    - id: "concern-analyzer"
      language: "bash"
      purpose: "Analyze cross-cutting concern patterns"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Logging Usage ==="
        grep -rn "log\.\|logger\." --include="*.java" | wc -l

        echo "=== Transaction Annotations ==="
        grep -rn "@Transactional" --include="*.java" | wc -l

        echo "=== Security Annotations ==="
        grep -rn "@Secured\|@PreAuthorize\|@RolesAllowed" --include="*.java" | wc -l

        echo "=== Caching Annotations ==="
        grep -rn "@Cacheable\|@CacheEvict" --include="*.java" | wc -l

signals:
  critical:
    - id: "XCUT-CRIT-001"
      signal: "Cross-cutting concerns mixed into business logic"
      evidence_pattern: "Service method has logging, transaction, caching all inline"
      explanation: |
        When business methods contain inline logging, transaction management,
        and caching code, the business logic becomes obscured and changing
        concern implementations requires modifying business code.
      remediation: "Extract to aspects, interceptors, or decorators"

    - id: "XCUT-CRIT-002"
      signal: "Inconsistent security enforcement"
      evidence_pattern: "Some endpoints protected, similar ones not"
      explanation: |
        Inconsistent security creates vulnerabilities. Some paths are
        secured while similar ones are accidentally left open.
      remediation: "Centralize security rules; use declarative security"

  high:
    - id: "XCUT-HIGH-001"
      signal: "Duplicated error handling code"
      evidence_pattern: "Same try-catch pattern repeated across classes"
      explanation: |
        Duplicated error handling is hard to maintain and often inconsistent.
        Changes must be made in multiple places.
      remediation: "Use exception handlers, aspects, or error handling middleware"

    - id: "XCUT-HIGH-002"
      signal: "Logging without centralized configuration"
      evidence_pattern: "Logger created with different patterns in different classes"
      explanation: |
        Inconsistent logging makes log analysis difficult. Different formats,
        levels, and patterns fragment operational insight.
      remediation: "Standardize logging pattern; use logging framework configuration"

  medium:
    - id: "XCUT-MED-001"
      signal: "Caching logic embedded in services"
      evidence_pattern: "Manual cache get/put calls in business methods"
      remediation: "Use declarative caching (@Cacheable) or caching decorator"

    - id: "XCUT-MED-002"
      signal: "Transaction boundaries unclear"
      evidence_pattern: "Some methods have @Transactional, similar ones don't"
      remediation: "Document transaction strategy; apply consistently"

  low:
    - id: "XCUT-LOW-001"
      signal: "Concern handling strategy not documented"
      remediation: "Document approach for each cross-cutting concern"

  positive:
    - id: "XCUT-POS-001"
      signal: "Concerns handled via aspects or interceptors"
    - id: "XCUT-POS-002"
      signal: "Declarative annotations for concerns"
    - id: "XCUT-POS-003"
      signal: "Consistent concern handling across codebase"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory cross-cutting concerns"
      description: |
        Catalog the cross-cutting concerns present in the system
        and how they're implemented.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find logging usage"
          command: "grep -rn 'log\\.\\|logger\\.' --include='*.java' | wc -l"
        - purpose: "Find AOP annotations"
          command: "grep -rn '@Aspect\\|@Before\\|@After\\|@Around' --include='*.java' | head -30"
        - purpose: "Find concern annotations"
          command: "grep -rn '@Transactional\\|@Cacheable\\|@Secured\\|@Async' --include='*.java' | head -30"
      expected_findings:
        - "Concern inventory"
        - "Implementation approach"

    - id: "2"
      name: "Assess concern separation"
      description: |
        Evaluate whether concerns are properly separated from
        business logic.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find inline concern handling in services"
          command: "grep -rn 'log\\.\\|cache\\.\\|transaction' --include='*Service.java' | head -40"
        - purpose: "Find try-catch patterns"
          command: "grep -rn 'try.*{' --include='*Service.java' | head -30"
      expected_findings:
        - "Inline concern handling"
        - "Separation quality"

    - id: "3"
      name: "Check consistency"
      description: |
        Verify that concerns are handled consistently across
        similar components.
      duration_estimate: "30 min"
      commands:
        - purpose: "Compare Controller logging"
          command: "for f in $(find . -name '*Controller.java' | head -5); do echo \"=== $f ===\"; grep -c 'log\\.' $f; done"
        - purpose: "Compare Service transactions"
          command: "for f in $(find . -name '*Service.java' | head -5); do echo \"=== $f ===\"; grep -c '@Transactional' $f; done"
      expected_findings:
        - "Consistency assessment"
        - "Variation patterns"

    - id: "4"
      name: "Review security enforcement"
      description: |
        Check that security concerns are consistently enforced.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find secured endpoints"
          command: "grep -rn '@Secured\\|@PreAuthorize\\|@RolesAllowed' --include='*Controller.java' | head -30"
        - purpose: "Find security config"
          command: "find . -name '*Security*.java' | head -10"
      expected_findings:
        - "Security coverage"
        - "Potential gaps"

    - id: "5"
      name: "Develop centralization recommendations"
      description: |
        Recommend improvements for better concern centralization.
      duration_estimate: "25 min"
      questions:
        - "Which concerns should be extracted to aspects?"
        - "What interceptors or middleware would help?"
        - "How can consistency be improved?"
      expected_findings:
        - "Centralization opportunities"
        - "Improvement recommendations"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "concern_matrix"
      format: "tabular"
      sections:
        - "Concern"
        - "Implementation Approach"
        - "Consistency Level"
        - "Recommendations"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Concern Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Clear inconsistency or mixing"
    medium: "Pattern suggests improvement needed"
    low: "Minor enhancement opportunity"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "aop"
        priority: "required"
      - source_id: "cross-cutting-patterns"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive analysis"
    full:
      included: true
      priority: 2
    architecture:
      included: true
      priority: 1

closeout_checklist:
  - id: "xcut-001"
    item: "Concerns separated from business logic"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Business methods don't have inline logging/caching/tx code"
    expected: "Confirmed or documented exception"

  - id: "xcut-002"
    item: "Security consistently enforced"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "All endpoints have appropriate security"
    expected: "Confirmed by reviewer"

  - id: "xcut-003"
    item: "Concerns handled consistently across codebase"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Similar components handle concerns similarly"
    expected: "Confirmed by reviewer"

  - id: "xcut-004"
    item: "Concern handling strategy documented"
    level: "WARNING"
    verification: "manual"
    verification_notes: "ADR or documentation exists for concern handling"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Modularity"]

relationships:
  commonly_combined:
    - "architecture-design.cross-cutting-concerns.aspect-separation"
    - "architecture-design.cross-cutting-concerns.middleware-interceptor-design"
    - "architecture-design.design-principles.single-responsibility"
