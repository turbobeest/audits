# ============================================================
# AUDIT: Extension Point Design Assessment
# ============================================================
# Evaluates the design and implementation of extension points
# that allow adding functionality without modifying core code.
# ============================================================

audit:
  id: "architecture-design.extensibility-evolution.extension-point"
  name: "Extension Point Design Assessment"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "architecture-design"
  category_number: 7
  subcategory: "extensibility-evolution"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "architecture"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit evaluates extension point design - the mechanisms that
    allow new functionality to be added without modifying existing code.
    It assesses strategy patterns, plugin architectures, event hooks,
    and middleware pipelines for proper implementation and discoverability.

  why_it_matters: |
    Well-designed extension points enable:
    - Adding features without modifying core code (OCP)
    - Third-party integrations without forking
    - Team autonomy in adding functionality
    - Gradual rollout via feature flags
    Poor extension points force modifications to stable code.

  when_to_run:
    - "When building frameworks or platforms"
    - "When planning for extensibility"
    - "Before external integrations"
    - "During architecture reviews"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Complete source code"
    - type: "architecture_documentation"
      description: "Documentation of extension mechanisms"

  access_requirements:
    - "Read access to source code"

discovery:
  code_patterns:
    - pattern: "Plugin|Extension|Hook|Strategy|Provider"
      type: "keyword"
      scope: "source"
      purpose: "Find extension point implementations"

    - pattern: "ServiceLoader|@SPI|registerExtension"
      type: "regex"
      scope: "source"
      purpose: "Find service loading patterns"

    - pattern: "addEventListener|on\\(|subscribe|hook"
      type: "regex"
      scope: "source"
      purpose: "Find event-based extension points"

  file_patterns:
    - glob: "**/*Plugin*.{java,ts,py}"
      purpose: "Plugin implementations"
    - glob: "**/*Extension*.{java,ts,py}"
      purpose: "Extension implementations"
    - glob: "**/META-INF/services/**"
      purpose: "Java SPI configuration"

knowledge_sources:
  specifications:
    - id: "ocp"
      name: "Open-Closed Principle"
      url: "https://en.wikipedia.org/wiki/Open%E2%80%93closed_principle"
      offline_cache: true
      priority: "required"

  guides:
    - id: "plugin-architecture"
      name: "Plugin Architecture Patterns"
      url: "https://martinfowler.com/articles/plugin.html"
      offline_cache: true

    - id: "refactoring-fowler"
      name: "Refactoring Catalog"
      url: "https://refactoring.com/catalog/"
      offline_cache: true

    - id: "clean-architecture"
      name: "Clean Architecture"
      url: "https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html"
      offline_cache: true

  learning_resources:
    - id: "design-patterns"
      title: "Design Patterns"
      type: "book"
      reference: "Gang of Four - Strategy, Template Method"

    - id: "poeaa"
      title: "Patterns of Enterprise Application Architecture"
      type: "book"
      reference: "Martin Fowler"

tooling:
  static_analysis:
    - tool: "SonarQube"
      purpose: "Detect extensibility patterns"
      offline_capable: false

  scripts:
    - id: "extension-point-finder"
      language: "bash"
      purpose: "Find extension points"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Strategy Patterns ==="
        grep -rn "interface.*Strategy\|implements.*Strategy" --include="*.java" | head -20

        echo "=== Plugin Interfaces ==="
        grep -rn "interface.*Plugin\|implements.*Plugin" --include="*.java" | head -20

        echo "=== Event Hooks ==="
        grep -rn "addEventListener\|on('\|subscribe(" --include="*.java" --include="*.ts" | head -20

        echo "=== SPI Services ==="
        find . -path "*META-INF/services*" -type f | head -10

signals:
  critical:
    - id: "EXT-CRIT-001"
      signal: "Extension point without discovery mechanism"
      evidence_pattern: "Strategy interface exists but extensions must be hardcoded"
      explanation: |
        Extension points that require code changes to register new
        extensions defeat their purpose. Discovery should be automatic
        via classpath scanning, SPI, or configuration.
      remediation: "Add ServiceLoader, plugin registry, or auto-registration"

    - id: "EXT-CRIT-002"
      signal: "Extension point that leaks internal details"
      evidence_pattern: "Plugin interface requires knowledge of internal classes"
      explanation: |
        Extensions coupled to internals break when internals change.
        Extension points must have stable, well-documented contracts.
      remediation: "Define clean interface; use DTOs for data exchange"

  high:
    - id: "EXT-HIGH-001"
      signal: "Missing extension point where needed"
      evidence_pattern: "Switch statement on type requires code change to add type"
      explanation: |
        Code that requires modification to add new variants is missing
        an extension point. This violates OCP and slows feature addition.
      remediation: "Introduce strategy or registry pattern"

    - id: "EXT-HIGH-002"
      signal: "Extension point without lifecycle management"
      evidence_pattern: "Plugin loaded but never unloaded; no cleanup"
      explanation: |
        Extensions without proper lifecycle can leak resources and
        make hot-reload or testing difficult.
      remediation: "Define init/destroy lifecycle; manage extension lifecycle"

  medium:
    - id: "EXT-MED-001"
      signal: "Extension point without validation"
      evidence_pattern: "Extensions registered without verifying they implement contract"
      remediation: "Validate extensions at registration time"

    - id: "EXT-MED-002"
      signal: "Undocumented extension points"
      evidence_pattern: "Extension mechanism exists but not documented"
      remediation: "Document extension points with examples"

  low:
    - id: "EXT-LOW-001"
      signal: "Extension points with inconsistent patterns"
      remediation: "Standardize extension mechanism across codebase"

  positive:
    - id: "EXT-POS-001"
      signal: "Well-documented extension points with examples"
    - id: "EXT-POS-002"
      signal: "Auto-discovery of extensions"
    - id: "EXT-POS-003"
      signal: "Clean extension contracts"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory extension points"
      description: |
        Catalog all extension mechanisms in the codebase.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find strategy interfaces"
          command: "grep -rn 'interface.*Strategy\\|interface.*Plugin\\|interface.*Provider' --include='*.java' | head -30"
        - purpose: "Find event systems"
          command: "grep -rn 'EventEmitter\\|EventBus\\|publish(' --include='*.java' --include='*.ts' | head -20"
        - purpose: "Find SPI services"
          command: "find . -path '*META-INF/services*' -type f | xargs cat 2>/dev/null | head -20"
      expected_findings:
        - "Extension point inventory"
        - "Pattern usage"

    - id: "2"
      name: "Evaluate discovery mechanisms"
      description: |
        Check how extensions are discovered and registered.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find registration patterns"
          command: "grep -rn 'register.*Extension\\|ServiceLoader\\|@Component' --include='*.java' | head -30"
        - purpose: "Find hardcoded extension lists"
          command: "grep -rn 'new.*Strategy\\[\\|List.of.*Strategy' --include='*.java' | head -20"
      expected_findings:
        - "Discovery mechanisms"
        - "Hardcoded registrations"

    - id: "3"
      name: "Check contract stability"
      description: |
        Verify that extension interfaces are stable and don't
        leak internal details.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find extension interface methods"
          command: "grep -rn 'interface.*Plugin' -A20 --include='*.java' | grep 'void\\|public' | head -30"
        - purpose: "Check parameter types"
          command: "grep -rn 'interface.*Extension' -A10 --include='*.java' | head -30"
      expected_findings:
        - "Interface stability"
        - "Internal leakage"

    - id: "4"
      name: "Assess lifecycle management"
      description: |
        Check if extensions have proper lifecycle hooks.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find lifecycle methods"
          command: "grep -rn 'init()\\|destroy()\\|onStart\\|onStop' --include='*.java' | head -20"
        - purpose: "Find cleanup patterns"
          command: "grep -rn 'unregister\\|removeExtension\\|dispose' --include='*.java' | head -20"
      expected_findings:
        - "Lifecycle hooks"
        - "Cleanup mechanisms"

    - id: "5"
      name: "Identify missing extension points"
      description: |
        Find areas where extension points should exist but don't.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find type switches"
          command: "grep -rn 'switch.*Type\\|switch.*Kind' --include='*.java' | head -20"
        - purpose: "Find instanceof chains"
          command: "grep -rn 'instanceof.*else.*instanceof' --include='*.java' | head -20"
      expected_findings:
        - "Missing extension opportunities"
        - "OCP violations"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "extension_catalog"
      format: "tabular"
      sections:
        - "Extension Point"
        - "Discovery Mechanism"
        - "Lifecycle Support"
        - "Documentation"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Extension Point Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Clear extension point design issue"
    medium: "Pattern suggests improvement opportunity"
    low: "Minor enhancement possible"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "ocp"
        priority: "required"
      - source_id: "plugin-architecture"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed pattern analysis"
    full:
      included: true
      priority: 2
    architecture:
      included: true
      priority: 2

closeout_checklist:
  - id: "ext-001"
    item: "Extension points have discovery mechanism"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Extensions auto-discovered, not hardcoded"
    expected: "Confirmed by reviewer"

  - id: "ext-002"
    item: "Extension contracts are stable"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Interfaces don't leak internal types"
    expected: "Confirmed by reviewer"

  - id: "ext-003"
    item: "Extension points are documented"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Each extension point has usage documentation"
    expected: "Confirmed by reviewer"

  - id: "ext-004"
    item: "Extension lifecycle managed"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Extensions can be cleanly loaded/unloaded"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["framework", "platform", "all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Extensibility"]

relationships:
  commonly_combined:
    - "architecture-design.design-principles.open-closed-principle"
    - "architecture-design.extensibility-evolution.plugin-architecture"
    - "architecture-design.architectural-patterns.pattern-appropriateness"
