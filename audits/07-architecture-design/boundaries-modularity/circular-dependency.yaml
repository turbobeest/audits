audit:
  id: architecture-design.boundaries-modularity.circular-dependency
  name: Circular Dependency Audit
  version: 1.0.0
  last_updated: '2026-01-18'
  status: active
  category: architecture-design
  category_number: 7
  subcategory: boundaries-modularity
  tier: expert
  estimated_duration: 45 minutes
  completeness: complete
  requires_runtime: false
  destructive: false
execution:
  automatable: 'yes'
  severity: high
  scope: codebase
  default_profiles:
  - full
  - quality
  - architecture
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Detects circular dependencies between modules, packages, and files in the
    codebase. Circular dependencies occur when module A depends on module B,
    which depends on module C, which depends back on module A (or more directly,
    A depends on B which depends on A).
  why_it_matters: |
    Circular dependencies indicate design problems and create practical issues:
    they prevent independent testing and deployment, cause initialization order
    problems, make the codebase harder to understand, and often indicate that
    modules should be merged or that shared code should be extracted.
  when_to_run:
  - Continuous integration
  - Architecture reviews
  - Before modularization
  - Build failure debugging
prerequisites:
  required_artifacts:
  - type: source_code
    description: Application source code
  access_requirements:
  - Read access to source code repository
discovery:
  code_patterns:
  - pattern: import\s+|from\s+|require\(
    type: regex
    scope: source
    purpose: Detect import statements for dependency analysis
  file_patterns:
  - glob: '**/*.{js,ts,jsx,tsx}'
    purpose: JavaScript/TypeScript files
  - glob: '**/*.py'
    purpose: Python files
  - glob: '**/*.java'
    purpose: Java files
  - glob: '**/*.go'
    purpose: Go files
knowledge_sources:
  guides:
  - id: madge-docs
    name: Madge Documentation
    url: https://github.com/pahen/madge
    offline_cache: true
  - id: ddd-evans
    name: Domain-Driven Design Reference
    url: https://www.domainlanguage.com/ddd/reference/
    offline_cache: true
  - id: pragmatic-programmer
    name: Pragmatic Programmer Tips
    url: https://pragprog.com/tips/
    offline_cache: true
  learning_resources:
  - id: clean-architecture
    title: Clean Architecture
    type: book
    reference: Robert C. Martin - Component Coupling Chapter
tooling:
  static_analysis:
  - tool: madge
    purpose: JavaScript/TypeScript circular dependency detection
    offline_capable: true
  - tool: dependency-cruiser
    purpose: JavaScript/TypeScript dependency analysis
    offline_capable: true
  - tool: pydeps
    purpose: Python dependency visualization
    offline_capable: true
  - tool: deptrac
    purpose: PHP layer/dependency analysis
    offline_capable: true
  - tool: jdeps
    purpose: Java dependency analyzer
    offline_capable: true
  scripts:
  - id: circular-dependency-scan
    language: bash
    purpose: Detect circular dependencies
    source: inline
    code: |
      echo "=== Circular Dependency Detection ==="

      echo "--- JavaScript/TypeScript (madge) ---"
      npx madge --circular src/ 2>/dev/null || echo "madge not available or no src/ directory"

      echo "--- Alternative: dependency-cruiser ---"
      npx depcruise --validate --output-type err-long src/ 2>/dev/null || echo "dependency-cruiser not configured"

      echo "--- Python (pydeps) ---"
      python -m pydeps --show-cycles . 2>/dev/null || echo "pydeps not installed"
signals:
  critical:
  - id: CIRC-CRIT-001
    signal: Circular dependency between core modules
    evidence_pattern: Cycle involving domain, core, or foundation modules
    explanation: |
      Core modules with circular dependencies cannot be independently
      tested or deployed. This is a fundamental architectural flaw.
    remediation: Extract shared code to new module or merge coupled modules
  - id: CIRC-CRIT-002
    signal: Large cycle involving >5 modules
    evidence_pattern: A -> B -> C -> D -> E -> A
    explanation: |
      Large cycles indicate systemic coupling. The entire cycle must
      be deployed and tested together, defeating modularity.
    remediation: Break cycle by extracting interfaces or shared code
  high:
  - id: CIRC-HIGH-001
    signal: Circular dependency between packages/namespaces
    evidence_pattern: Package A imports from Package B and vice versa
    explanation: |
      Package-level circular dependencies prevent clean package boundaries
      and make the dependency graph unclear.
    remediation: Extract interface package or merge related packages
  - id: CIRC-HIGH-002
    signal: Runtime circular import failures
    evidence_pattern: ImportError, ReferenceError at module load time
    explanation: |
      Circular dependencies can cause runtime failures when modules
      try to use each other during initialization.
    remediation: Use dependency injection, lazy imports, or restructure
  medium:
  - id: CIRC-MED-001
    signal: File-level circular dependency
    evidence_pattern: file-a.ts imports file-b.ts imports file-a.ts
    remediation: Merge files, extract shared code, or use dependency injection
  - id: CIRC-MED-002
    signal: Type-only circular dependency
    evidence_pattern: Circular imports for type definitions only
    remediation: Extract types to separate file, use import type
  - id: CIRC-MED-003
    signal: Test files creating circular dependencies
    evidence_pattern: Test imports creating cycles with source
    remediation: Use test utilities, don't import from tests in source
  low:
  - id: CIRC-LOW-001
    signal: Circular dependency tooling not configured
    evidence_pattern: No madge, dependency-cruiser, or equivalent in CI
    remediation: Add circular dependency check to CI pipeline
  positive:
  - id: CIRC-POS-001
    signal: No circular dependencies detected
    evidence_pattern: madge --circular returns empty
  - id: CIRC-POS-002
    signal: Circular dependency check in CI
    evidence_pattern: CI fails on circular dependency introduction
  - id: CIRC-POS-003
    signal: Clean dependency graph
    evidence_pattern: Acyclic dependency visualization
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Run Automated Detection
    description: |
      Use automated tools to detect circular dependencies.
    duration_estimate: 10 min
    commands:
    - purpose: Run madge for JS/TS
      command: |
        npx madge --circular --extensions ts,js,tsx,jsx src/ 2>/dev/null || echo "Run: npm install -g madge"
    - purpose: Run with dependency-cruiser
      command: |
        npx depcruise --validate --output-type err-long src/ 2>/dev/null || echo "No dependency-cruiser config"
    expected_findings:
    - Circular dependency list
    - Cycle members
  - id: '2'
    name: Visualize Dependencies
    description: |
      Create dependency graph visualization to understand structure.
    duration_estimate: 10 min
    commands:
    - purpose: Generate dependency graph
      command: |
        npx madge --image graph.svg src/ 2>/dev/null && echo "Graph saved to graph.svg" || echo "madge visualization failed"
    - purpose: Generate circular-only graph
      command: |
        npx madge --circular --image circular.svg src/ 2>/dev/null && echo "Circular graph saved" || echo "No circular dependencies or madge failed"
    expected_findings:
    - Visual dependency map
    - Cycle visualization
  - id: '3'
    name: Analyze Cycle Impact
    description: |
      Assess the severity and impact of detected cycles.
    duration_estimate: 15 min
    commands:
    - purpose: List files in cycles
      command: |
        npx madge --circular --json src/ 2>/dev/null | head -100
    expected_findings:
    - Cycle severity assessment
    - Affected modules
    - Impact analysis
  - id: '4'
    name: Check CI Integration
    description: |
      Verify that circular dependency checks are in CI.
    duration_estimate: 10 min
    commands:
    - purpose: Check CI config for circular checks
      command: |
        grep -rn "madge\|circular\|depcruise" .github/ .gitlab-ci.yml .circleci/ Jenkinsfile 2>/dev/null | head -10
    expected_findings:
    - CI enforcement status
    - Prevention measures
output:
  deliverables:
  - type: finding_list
    format: structured
    content:
    - circular_dependencies
    - cycle_members
    - severity_assessment
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Detected Cycles
    - Impact Analysis
    - Remediation Plan
  confidence_guidance:
    high: Tool-detected circular dependency
    medium: Potential cycle requiring verification
    low: Structural pattern suggesting risk
offline:
  capability: full
  cache_manifest:
    knowledge:
    - source_id: madge-docs
      priority: recommended
profiles:
  membership:
    quick:
      included: true
      priority: 2
    full:
      included: true
      priority: 1
    architecture:
      included: true
      priority: 1
closeout_checklist:
- id: circ-001
  item: No circular dependencies detected
  level: CRITICAL
  verification: npx madge --circular src/
  expected: Empty result (no cycles)
- id: circ-002
  item: Circular dependency check in CI
  level: HIGH
  verification: CI config includes circular check
  expected: Automated prevention
- id: circ-003
  item: Remediation plan for existing cycles
  level: WARNING
  verification: Each cycle has documented fix plan
  expected: Actionable remediation
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: ISO 25010
    controls:
    - Modularity
    - Maintainability
relationships:
  commonly_combined:
  - architecture-design.boundaries-modularity.module-boundary
  - architecture-design.boundaries-modularity.dependency-direction
  - architecture-design.boundaries-modularity.layer-separation
