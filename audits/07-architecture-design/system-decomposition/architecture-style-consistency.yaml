# ============================================================
# AUDIT: Architecture Style Consistency
# ============================================================
# Evaluates whether architecture diagrams match stated patterns
# (microservices, event-driven, layered, etc.)
# ============================================================

audit:
  id: "architecture-design.system-decomposition.architecture-style-consistency"
  name: "Architecture Style Consistency Audit"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "architecture-design"
  category_number: 7
  subcategory: "system-decomposition"

  tier: "phd"
  estimated_duration: "2-4 hours"  # median: 3h

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "none"
  severity: "high"
  scope: "architecture"

  default_profiles:
    - "full"
    - "architecture"
    - "discovery"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit evaluates whether architecture diagrams accurately represent
    the stated architectural style (microservices, event-driven, layered,
    hexagonal, etc.). It checks for consistency between documented patterns
    and their visual representation, identifying where diagram elements
    contradict or misrepresent the intended architecture.

  why_it_matters: |
    Inconsistent architecture diagrams cause:
    - Misalignment between team mental models and actual design
    - Implementation that drifts from intended architecture
    - Confusion during design reviews and stakeholder discussions
    - Technical debt from building against wrong assumptions
    - Difficulty onboarding new team members

    Early detection prevents costly rework and architectural drift.

  when_to_run:
    - "During Discovery phase when evaluating initial designs"
    - "During PRD phase when validating technical feasibility"
    - "Before major architecture decisions are finalized"
    - "When reviewing architecture proposals"

prerequisites:
  required_artifacts:
    - type: "architecture_diagram"
      description: "System architecture diagrams (C4, UML, informal)"
    - type: "architecture_documentation"
      description: "ADRs or stated architectural style"

  access_requirements:
    - "Access to architecture diagrams"
    - "Access to PRD or architecture decision records"

discovery:
  code_patterns:
    - pattern: "microservice|event-driven|layered|hexagonal|clean architecture|monolith"
      type: "keyword"
      scope: "docs"
      purpose: "Identify stated architectural style"

  file_patterns:
    - glob: "**/architecture*.{png,svg,drawio,pdf,md}"
      purpose: "Architecture diagrams"
    - glob: "**/ADR-*.md"
      purpose: "Architecture Decision Records"
    - glob: "**/PRD*.md"
      purpose: "Product Requirements Documents"

knowledge_sources:
  specifications:
    - id: "c4-model"
      name: "C4 Model for Software Architecture"
      url: "https://c4model.com/"
      offline_cache: true
      priority: "required"

  guides:
    - id: "fowler-microservices"
      name: "Martin Fowler - Microservices"
      url: "https://martinfowler.com/articles/microservices.html"
      offline_cache: true

  learning_resources:
    - id: "fundamentals-architecture"
      title: "Fundamentals of Software Architecture"
      type: "book"
      reference: "Richards & Ford"

    - id: "building-microservices"
      title: "Building Microservices"
      type: "book"
      reference: "Sam Newman"

signals:
  critical:
    - id: "STYLE-CRIT-001"
      signal: "Diagram shows synchronous coupling in stated event-driven architecture"
      evidence_pattern: "Direct request-response arrows between services in 'event-driven' system"
      explanation: |
        Event-driven architectures should show asynchronous message/event flows,
        not synchronous request-response patterns. This inconsistency indicates
        either wrong documentation or wrong design.
      remediation: "Clarify actual communication patterns; update diagram or documentation"

    - id: "STYLE-CRIT-002"
      signal: "Shared database in stated microservices architecture"
      evidence_pattern: "Multiple services pointing to single database in diagram"
      explanation: |
        Microservices should own their data. A shared database indicates either
        a monolith or a data coupling anti-pattern that undermines service autonomy.
      remediation: "Evaluate data ownership strategy; consider data per service or event sourcing"

  high:
    - id: "STYLE-HIGH-001"
      signal: "Layer violations in stated layered architecture"
      evidence_pattern: "Presentation layer directly accessing data layer"
      explanation: |
        Layered architectures require strict layer dependencies. Skip-layer
        access breaks the abstraction and makes changes harder to isolate.
      remediation: "Add missing intermediary layers or reconsider architecture style"

    - id: "STYLE-HIGH-002"
      signal: "Missing event broker in event-driven diagram"
      evidence_pattern: "Services connected directly without message queue/broker"
      explanation: |
        Event-driven systems need an event broker for decoupling. Direct
        connections defeat the purpose of event-driven design.
      remediation: "Add event broker; clarify event routing strategy"

  medium:
    - id: "STYLE-MED-001"
      signal: "Inconsistent naming conventions in diagram"
      evidence_pattern: "Mix of 'Service', 'API', 'Module' without clear distinction"
      remediation: "Establish and apply consistent naming conventions"

    - id: "STYLE-MED-002"
      signal: "Unclear boundary between architectural styles"
      evidence_pattern: "Some components microservices, others tightly coupled"
      remediation: "Document hybrid approach or clarify transition plan"

  low:
    - id: "STYLE-LOW-001"
      signal: "Diagram abstraction level inconsistent"
      remediation: "Use consistent C4 levels; separate containers from components"

  positive:
    - id: "STYLE-POS-001"
      signal: "Diagram clearly matches stated architectural style"
    - id: "STYLE-POS-002"
      signal: "Consistent abstraction levels throughout diagram"
    - id: "STYLE-POS-003"
      signal: "Clear legend explaining architectural conventions"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "architect"

  steps:
    - id: "1"
      name: "Identify stated architectural style"
      description: |
        Review PRD, ADRs, and documentation to understand the
        intended architectural style.
      duration_estimate: "20 min"
      questions:
        - "What architectural style is stated (microservices, layered, etc.)?"
        - "Are there any hybrid approaches documented?"
        - "What were the driving factors for this choice?"
      expected_findings:
        - "Stated architectural style"
        - "Design rationale"

    - id: "2"
      name: "Analyze diagram for style characteristics"
      description: |
        Examine diagram elements against the expected characteristics
        of the stated style.
      duration_estimate: "30 min"
      questions:
        - "For microservices: Are services independently deployable?"
        - "For event-driven: Are there async message flows?"
        - "For layered: Are layer dependencies one-directional?"
      expected_findings:
        - "Style characteristic presence/absence"
        - "Pattern violations"

    - id: "3"
      name: "Check communication patterns"
      description: |
        Verify that communication patterns match the architectural style.
      duration_estimate: "25 min"
      questions:
        - "Are synchronous vs asynchronous patterns consistent with style?"
        - "Are there unexpected direct dependencies?"
        - "Is the data flow consistent with style expectations?"
      expected_findings:
        - "Communication pattern assessment"
        - "Coupling concerns"

    - id: "4"
      name: "Evaluate data ownership"
      description: |
        Assess data storage and ownership patterns against style.
      duration_estimate: "20 min"
      questions:
        - "Does each service/component own its data appropriately?"
        - "Are there shared databases that violate style?"
        - "Is event sourcing needed but missing?"
      expected_findings:
        - "Data ownership assessment"
        - "Storage pattern concerns"

    - id: "5"
      name: "Document inconsistencies and recommendations"
      description: |
        Compile findings and provide actionable recommendations.
      duration_estimate: "25 min"
      expected_findings:
        - "Inconsistency catalog"
        - "Remediation recommendations"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "style_assessment"
      format: "tabular"
      sections:
        - "Stated Style"
        - "Observed Characteristics"
        - "Consistency Score"
        - "Key Deviations"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Style Consistency Analysis"
        - "Risk Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Clear contradiction between stated style and diagram"
    medium: "Ambiguous or partial style implementation"
    low: "Minor inconsistency or naming issue"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires deep architectural analysis"
    full:
      included: true
      priority: 1
    architecture:
      included: true
      priority: 1
    discovery:
      included: true
      priority: 1

closeout_checklist:
  - id: "style-001"
    item: "Stated architectural style is documented"
    level: "CRITICAL"
    verification: "manual"
    expected: "ADR or PRD contains style declaration"

  - id: "style-002"
    item: "Diagram elements match style characteristics"
    level: "CRITICAL"
    verification: "manual"
    expected: "No major style violations"

  - id: "style-003"
    item: "Communication patterns align with style"
    level: "BLOCKING"
    verification: "manual"
    expected: "Sync/async patterns appropriate"

  - id: "style-004"
    item: "Data ownership matches style expectations"
    level: "BLOCKING"
    verification: "manual"
    expected: "No inappropriate data sharing"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Modularity", "Analyzability"]

relationships:
  commonly_combined:
    - "architecture-design.system-decomposition.component-responsibility"
    - "architecture-design.system-decomposition.service-granularity"
    - "architecture-design.system-decomposition.data-flow-completeness"
