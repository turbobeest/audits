# ============================================================
# AUDIT: Data Flow Completeness
# ============================================================
# Evaluates whether all data movements between components
# are documented in architecture diagrams.
# ============================================================

audit:
  id: "architecture-design.system-decomposition.data-flow-completeness"
  name: "Data Flow Completeness Audit"
  version: "1.0.0"
  last_updated: "2026-01-19"
  status: "active"

  category: "architecture-design"
  category_number: 7
  subcategory: "system-decomposition"

  tier: "phd"
  estimated_duration: "2-4 hours"  # median: 3h

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "none"
  severity: "high"
  scope: "architecture"

  default_profiles:
    - "full"
    - "architecture"
    - "discovery"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit evaluates whether architecture diagrams completely document
    all data movements between system components. It checks for missing
    data flows, undocumented integrations, and gaps in data lineage that
    could lead to implementation surprises or security blind spots.

  why_it_matters: |
    Incomplete data flow documentation causes:
    - Implementation surprises when undocumented flows are needed
    - Security blind spots where data moves unexpectedly
    - Compliance risks from undocumented data handling
    - Difficulty understanding system behavior
    - Integration issues during development

    Complete data flow documentation is foundational for architecture review.

  when_to_run:
    - "During Discovery phase when validating architecture diagrams"
    - "During PRD phase when assessing data requirements"
    - "Before implementation to ensure complete picture"
    - "During security or compliance reviews"

prerequisites:
  required_artifacts:
    - type: "architecture_diagram"
      description: "System architecture diagrams showing components"
    - type: "data_requirements"
      description: "PRD data requirements or data models"

  access_requirements:
    - "Access to architecture diagrams"
    - "Access to PRD or data requirements"

discovery:
  code_patterns:
    - pattern: "data.*flow|integration|API|message|event|sync"
      type: "keyword"
      scope: "docs"
      purpose: "Identify data flow documentation"

  file_patterns:
    - glob: "**/architecture*.{png,svg,drawio,pdf,md}"
      purpose: "Architecture diagrams"
    - glob: "**/data-model*.{md,yaml,json}"
      purpose: "Data model documentation"
    - glob: "**/sequence*.{png,svg,puml}"
      purpose: "Sequence diagrams"

knowledge_sources:
  specifications:
    - id: "c4-model"
      name: "C4 Model - Container Diagrams"
      url: "https://c4model.com/#ContainerDiagram"
      offline_cache: true
      priority: "required"

  guides:
    - id: "data-flow-diagramming"
      name: "Data Flow Diagram Best Practices"
      url: "https://www.lucidchart.com/pages/data-flow-diagram"
      offline_cache: true

signals:
  critical:
    - id: "FLOW-CRIT-001"
      signal: "External system integration not shown in diagram"
      evidence_pattern: "PRD mentions third-party API but diagram doesn't show it"
      explanation: |
        Missing external integrations hide critical dependencies and potential
        points of failure. Implementation will be blocked waiting for integration
        details.
      remediation: "Add all external systems to diagram with data flow arrows"

    - id: "FLOW-CRIT-002"
      signal: "User data collection point undocumented"
      evidence_pattern: "Feature requires user data but no flow shows collection"
      explanation: |
        Undocumented user data collection is a GDPR/privacy risk and may
        violate compliance requirements.
      remediation: "Document all user data collection points and purposes"

  high:
    - id: "FLOW-HIGH-001"
      signal: "Database writes without documented source"
      evidence_pattern: "Database shown but no arrows showing what writes to it"
      explanation: |
        Databases that appear to have data with no documented source suggest
        missing data flows or incorrect diagram.
      remediation: "Add data flow arrows showing all write sources"

    - id: "FLOW-HIGH-002"
      signal: "Component with no input or output flows"
      evidence_pattern: "Box in diagram with no connecting arrows"
      explanation: |
        Isolated components are either incorrectly documented or serve no purpose.
        Every component should have at least one input and one output.
      remediation: "Add missing flows or remove orphaned components"

  medium:
    - id: "FLOW-MED-001"
      signal: "Bidirectional flow shown as single arrow"
      evidence_pattern: "Request-response pattern shown as one-way arrow"
      remediation: "Clarify flow direction or use bidirectional notation"

    - id: "FLOW-MED-002"
      signal: "Data transformation not indicated"
      evidence_pattern: "Data format changes between components not shown"
      remediation: "Add transformation notes or intermediate processing steps"

  low:
    - id: "FLOW-LOW-001"
      signal: "Flow labels missing or unclear"
      remediation: "Add descriptive labels to all data flow arrows"

  positive:
    - id: "FLOW-POS-001"
      signal: "All data flows labeled with data types"
    - id: "FLOW-POS-002"
      signal: "External integrations clearly marked"
    - id: "FLOW-POS-003"
      signal: "Error/fallback flows documented"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "architect"

  steps:
    - id: "1"
      name: "Inventory documented data flows"
      description: |
        List all data flows shown in architecture diagrams.
      duration_estimate: "25 min"
      questions:
        - "What data flows are explicitly shown?"
        - "Are flows labeled with data types?"
        - "Are directions (input/output) clear?"
      expected_findings:
        - "Data flow inventory"
        - "Labeling quality assessment"

    - id: "2"
      name: "Compare against PRD requirements"
      description: |
        Cross-reference documented flows against PRD data requirements.
      duration_estimate: "30 min"
      questions:
        - "Does every PRD data requirement have a corresponding flow?"
        - "Are all user data collection points shown?"
        - "Are all external integrations represented?"
      expected_findings:
        - "Coverage gaps"
        - "Missing flows"

    - id: "3"
      name: "Validate component connectivity"
      description: |
        Ensure every component has appropriate inputs and outputs.
      duration_estimate: "20 min"
      questions:
        - "Does every component have at least one input flow?"
        - "Does every component have at least one output flow?"
        - "Are there orphaned components?"
      expected_findings:
        - "Connectivity issues"
        - "Orphaned components"

    - id: "4"
      name: "Check for implicit flows"
      description: |
        Identify data flows that are implied but not shown.
      duration_estimate: "25 min"
      questions:
        - "What authentication/authorization flows are needed?"
        - "What error handling flows exist?"
        - "What caching or optimization flows might exist?"
      expected_findings:
        - "Implicit flow identification"
        - "Infrastructure flows"

    - id: "5"
      name: "Document gaps and recommendations"
      description: |
        Compile missing flows and recommend additions.
      duration_estimate: "20 min"
      expected_findings:
        - "Gap catalog"
        - "Recommended diagram updates"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "flow_coverage_matrix"
      format: "tabular"
      sections:
        - "PRD Requirement"
        - "Documented Flow"
        - "Status"
        - "Notes"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Coverage Analysis"
        - "Missing Flows"
        - "Recommendations"

  confidence_guidance:
    high: "PRD requirement with no corresponding flow"
    medium: "Implicit flow not documented"
    low: "Missing flow label or direction"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive cross-reference"
    full:
      included: true
      priority: 1
    architecture:
      included: true
      priority: 1
    discovery:
      included: true
      priority: 1

closeout_checklist:
  - id: "flow-001"
    item: "All PRD data requirements have corresponding flows"
    level: "CRITICAL"
    verification: "manual"
    expected: "100% coverage"

  - id: "flow-002"
    item: "All external integrations documented"
    level: "CRITICAL"
    verification: "manual"
    expected: "No missing external systems"

  - id: "flow-003"
    item: "Every component has input and output flows"
    level: "BLOCKING"
    verification: "manual"
    expected: "No orphaned components"

  - id: "flow-004"
    item: "User data collection points documented"
    level: "BLOCKING"
    verification: "manual"
    expected: "All collection points shown"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "GDPR"
      controls: ["Data Mapping", "Processing Activities"]
    - framework: "ISO 25010"
      controls: ["Analyzability"]

relationships:
  commonly_combined:
    - "architecture-design.system-decomposition.architecture-style-consistency"
    - "architecture-design.system-decomposition.component-responsibility"
    - "data-state-management.schema-design.data-modeling-quality"
