# ============================================================
# AUDIT: Class Cohesion Analysis
# ============================================================
# Measures how well class members belong together, ensuring
# each class has a single, well-defined responsibility.
# ============================================================

audit:
  id: "architecture-design.cohesion.class-cohesion"
  name: "Class Cohesion Analysis"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "architecture-design"
  category_number: 7
  subcategory: "cohesion"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "architecture"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit measures class-level cohesion using metrics like LCOM
    (Lack of Cohesion in Methods), which quantifies how related the
    methods and fields of a class are. It identifies classes with
    low cohesion that likely violate Single Responsibility Principle
    and could benefit from decomposition.

  why_it_matters: |
    Low cohesion indicates:
    - Classes with multiple unrelated responsibilities
    - Difficulty understanding class purpose
    - Higher likelihood of bugs during changes
    - Reduced reusability of class components
    - Testing complexity due to unrelated behaviors
    High cohesion is a key indicator of well-designed classes.

  when_to_run:
    - "During code reviews of new classes"
    - "When refactoring legacy code"
    - "After merging classes or significant additions"
    - "When identifying candidates for extraction"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Complete source code"

  access_requirements:
    - "Read access to source code"

discovery:
  code_patterns:
    - pattern: "class\\s+[A-Z]\\w+"
      type: "regex"
      scope: "source"
      purpose: "Identify class definitions"

    - pattern: "private\\s+(final\\s+)?\\w+\\s+\\w+;"
      type: "regex"
      scope: "source"
      purpose: "Count instance fields"

    - pattern: "public\\s+\\w+\\s+\\w+\\s*\\("
      type: "regex"
      scope: "source"
      purpose: "Count public methods"

  file_patterns:
    - glob: "**/*.java"
      purpose: "Java source files"
    - glob: "**/*.ts"
      purpose: "TypeScript source files"
    - glob: "**/*.py"
      purpose: "Python source files"
    - glob: "**/*.cs"
      purpose: "C# source files"

knowledge_sources:
  specifications:
    - id: "lcom-metrics"
      name: "Lack of Cohesion in Methods"
      url: "https://www.aivosto.com/project/help/pm-oo-cohesion.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "clean-code"
      name: "Clean Code - Classes Chapter"
      url: "https://www.oreilly.com/library/view/clean-code/9780136083238/"
      offline_cache: true

    - id: "ddd-evans"
      name: "Domain-Driven Design Reference"
      url: "https://www.domainlanguage.com/ddd/reference/"
      offline_cache: true

    - id: "clean-architecture"
      name: "Clean Architecture"
      url: "https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html"
      offline_cache: true

    - id: "pragmatic-programmer"
      name: "Pragmatic Programmer Tips"
      url: "https://pragprog.com/tips/"
      offline_cache: true

  learning_resources:
    - id: "oo-metrics"
      title: "Object-Oriented Design Quality Metrics"
      type: "paper"
      reference: "Chidamber & Kemerer - IEEE TSE 1994"

    - id: "refactoring"
      title: "Refactoring: Improving the Design of Existing Code"
      type: "book"
      reference: "Martin Fowler - Extract Class, Move Method"

tooling:
  static_analysis:
    - tool: "SonarQube"
      purpose: "Calculate LCOM4 metric"
      offline_capable: false

    - tool: "NDepend"
      purpose: "Comprehensive cohesion metrics for .NET"
      offline_capable: true

    - tool: "JaCoCo/Checkstyle"
      purpose: "Java metrics including cohesion"
      offline_capable: true

    - tool: "ck"
      purpose: "Calculate Chidamber-Kemerer metrics for Java"
      offline_capable: true

  scripts:
    - id: "cohesion-estimator"
      language: "bash"
      purpose: "Estimate class cohesion indicators"
      source: "inline"
      code: |
        #!/bin/bash
        # Find large classes (potential low cohesion)
        echo "=== Large Classes (>300 lines) ==="
        find . -name "*.java" -exec wc -l {} \; | sort -rn | awk '$1 > 300' | head -20

        echo "=== Classes with Many Fields ==="
        for f in $(find . -name "*.java"); do
          fields=$(grep -c "private.*;" "$f" 2>/dev/null)
          if [ "$fields" -gt 10 ]; then
            echo "$f: $fields fields"
          fi
        done | sort -t: -k2 -rn | head -20

signals:
  critical:
    - id: "COHESION-CRIT-001"
      signal: "LCOM4 >= 3 indicating severely low cohesion"
      evidence_pattern: "Class has 3+ disconnected method groups"
      explanation: |
        LCOM4 >= 3 means the class contains at least 3 groups of methods
        that operate on completely different sets of fields. This class
        is essentially multiple classes combined improperly.
      remediation: "Apply Extract Class refactoring to split into cohesive units"

    - id: "COHESION-CRIT-002"
      signal: "God class with >20 fields and >30 methods"
      evidence_pattern: "Class exceeds both field and method thresholds"
      explanation: |
        Excessively large classes almost certainly have low cohesion.
        They become unmaintainable and are often the source of most bugs.
      remediation: "Identify responsibilities; extract separate classes for each"

  high:
    - id: "COHESION-HIGH-001"
      signal: "Methods that don't use any instance fields"
      evidence_pattern: "Instance method has no 'this.' references"
      explanation: |
        Methods not using instance state may belong elsewhere or should
        be static. Their presence reduces class cohesion.
      remediation: "Move to utility class or make static if appropriate"

    - id: "COHESION-HIGH-002"
      signal: "Field used by only one method"
      evidence_pattern: "Instance field referenced in single method only"
      explanation: |
        A field used by only one method suggests that method may belong
        in a different class along with the field.
      remediation: "Consider moving field and method to more appropriate class"

  medium:
    - id: "COHESION-MED-001"
      signal: "Class has many public setters suggesting data holder"
      evidence_pattern: ">5 public setters with minimal logic"
      remediation: "Consider splitting into focused value objects or using builder"

    - id: "COHESION-MED-002"
      signal: "Method cliques - groups of methods using separate field subsets"
      evidence_pattern: "Methods naturally partition into independent groups"
      remediation: "Extract each clique into its own class"

  low:
    - id: "COHESION-LOW-001"
      signal: "Utility methods in domain class"
      remediation: "Move utilities to dedicated helper class"

  positive:
    - id: "COHESION-POS-001"
      signal: "High LCOM (LCOM4 = 1) - fully cohesive class"
    - id: "COHESION-POS-002"
      signal: "Small focused class with clear single responsibility"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Run LCOM metrics"
      description: |
        Calculate Lack of Cohesion metrics for all classes
        using static analysis tools.
      duration_estimate: "30 min"
      commands:
        - purpose: "Run ck metrics tool (if available)"
          command: "java -jar ck.jar . 2>/dev/null || echo 'ck tool not installed'"
        - purpose: "Find classes for manual analysis"
          command: "find . -name '*.java' -exec grep -l 'class [A-Z]' {} \\; | head -30"
      expected_findings:
        - "LCOM scores for all classes"
        - "Classes with LCOM > 1"

    - id: "2"
      name: "Identify large classes"
      description: |
        Find classes that are large by line count, field count,
        or method count - indicators of potential low cohesion.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find large files"
          command: "find . -name '*.java' -exec wc -l {} \\; | sort -rn | head -20"
        - purpose: "Count methods per class"
          command: "for f in $(find . -name '*.java' | head -50); do echo \"$f: $(grep -c 'public.*(' $f)\"; done | sort -t: -k2 -rn | head -15"
      expected_findings:
        - "Largest classes by size"
        - "Classes with most methods"

    - id: "3"
      name: "Analyze field usage patterns"
      description: |
        For suspicious classes, analyze which methods use which
        fields to identify potential splits.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find field declarations"
          command: "grep -rn 'private.*[a-z]\\+;' --include='*.java' | head -30"
        - purpose: "Sample field usage"
          command: "grep -rn 'this\\.[a-z]' --include='*.java' | head -30"
      expected_findings:
        - "Field-method relationships"
        - "Isolated field groups"

    - id: "4"
      name: "Identify static method candidates"
      description: |
        Find instance methods that don't use any instance state
        and could be static.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find potential static methods"
          command: "grep -rn 'public [a-zA-Z]\\+ [a-z]' --include='*.java' -A10 | grep -B1 'return ' | grep -v 'this\\.' | head -20"
      expected_findings:
        - "Methods without instance field access"
        - "Utility method candidates"

    - id: "5"
      name: "Review god class candidates"
      description: |
        Deep review of the largest, most complex classes to
        develop refactoring recommendations.
      duration_estimate: "40 min"
      questions:
        - "Can this class be described with a single 'and' in its purpose?"
        - "Do all methods contribute to a single cohesive responsibility?"
        - "Would separate classes improve testability?"
      expected_findings:
        - "Clear decomposition recommendations"
        - "Prioritized refactoring list"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "metrics_report"
      format: "tabular"
      sections:
        - "Class Name"
        - "LCOM Score"
        - "Field Count"
        - "Method Count"
        - "Assessment"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Cohesion Metrics Analysis"
        - "Refactoring Recommendations"

  confidence_guidance:
    high: "LCOM metric directly calculated"
    medium: "Size-based heuristics suggest low cohesion"
    low: "Manual inspection needed to confirm"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "lcom-metrics"
        priority: "required"
      - source_id: "clean-code"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed class analysis"
    full:
      included: true
      priority: 1
    architecture:
      included: true
      priority: 1

closeout_checklist:
  - id: "class-cohesion-001"
    item: "LCOM metrics calculated for major classes"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "LCOM scores documented for classes >200 lines"
    expected: "Confirmed by reviewer"

  - id: "class-cohesion-002"
    item: "No god classes (>20 fields OR >30 methods)"
    level: "CRITICAL"
    verification: "find . -name '*.java' -exec sh -c 'grep -c \"private.*\" \"$1\" | grep -q \"^[2-9][0-9]\\|^[0-9]\\{3\\}\" && echo \"$1\"' _ {} \\;"
    expected: "No output or documented exceptions"

  - id: "class-cohesion-003"
    item: "Low-cohesion classes have refactoring plan"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Classes with LCOM > 2 have documented decomposition strategy"
    expected: "Confirmed by reviewer"

  - id: "class-cohesion-004"
    item: "Static method candidates identified"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Methods not using instance state are documented"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Modularity"]

relationships:
  commonly_combined:
    - "architecture-design.design-principles.single-responsibility"
    - "architecture-design.cohesion.module-cohesion"
    - "architecture-design.coupling.tight-coupling-detection"
