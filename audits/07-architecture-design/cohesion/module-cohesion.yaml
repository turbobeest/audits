# ============================================================
# AUDIT: Module Cohesion Analysis
# ============================================================
# Evaluates whether modules/packages contain related functionality
# that changes together and serves a unified purpose.
# ============================================================

audit:
  id: "architecture-design.cohesion.module-cohesion"
  name: "Module Cohesion Analysis"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "architecture-design"
  category_number: 7
  subcategory: "cohesion"

  tier: "expert"
  estimated_duration: "2-4 hours"  # median: 3h

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "architecture"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit assesses module-level cohesion by analyzing whether
    packages, modules, or directories contain functionally related
    components. It evaluates the Common Closure Principle (classes
    that change together belong together) and Common Reuse Principle
    (classes that are used together belong together).

  why_it_matters: |
    Module cohesion determines:
    - How intuitive the codebase organization is
    - Whether changes require touching multiple modules
    - Deployment unit independence
    - Team ownership clarity
    - Reusability at the module level
    Poor module cohesion leads to scattered changes and tangled dependencies.

  when_to_run:
    - "During architecture reviews"
    - "Before splitting monoliths"
    - "When package structure has grown organically"
    - "When experiencing scattered changes across modules"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Complete source code with module/package structure"
    - type: "version_control"
      description: "Git history for change pattern analysis"

  access_requirements:
    - "Read access to source code"
    - "Read access to version control history"

discovery:
  code_patterns:
    - pattern: "^package\\s+|^namespace\\s+"
      type: "regex"
      scope: "source"
      purpose: "Identify module/package declarations"

    - pattern: "^import\\s+.*\\.internal\\."
      type: "regex"
      scope: "source"
      purpose: "Find cross-module internal imports"

  file_patterns:
    - glob: "**/package.json"
      purpose: "Node.js module boundaries"
    - glob: "**/pom.xml"
      purpose: "Maven module definitions"
    - glob: "**/build.gradle"
      purpose: "Gradle module definitions"
    - glob: "**/go.mod"
      purpose: "Go module definitions"
    - glob: "**/__init__.py"
      purpose: "Python package definitions"

knowledge_sources:
  specifications:
    - id: "package-principles"
      name: "Package Principles - Robert C. Martin"
      url: "https://blog.cleancoder.com/uncle-bob/2014/05/08/SingleReponsibilityPrinciple.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "modular-monolith"
      name: "Modular Monolith Architecture"
      url: "https://www.kamilgrzybek.com/design/modular-monolith-primer/"
      offline_cache: true

    - id: "ddd-evans"
      name: "Domain-Driven Design Reference"
      url: "https://www.domainlanguage.com/ddd/reference/"
      offline_cache: true

    - id: "clean-architecture"
      name: "Clean Architecture"
      url: "https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html"
      offline_cache: true

    - id: "pragmatic-programmer"
      name: "Pragmatic Programmer Tips"
      url: "https://pragprog.com/tips/"
      offline_cache: true

  learning_resources:
    - id: "agile-ppp"
      title: "Agile Software Development: Principles, Patterns, and Practices"
      type: "book"
      reference: "Robert C. Martin - Package Cohesion Principles"

    - id: "building-microservices"
      title: "Building Microservices"
      type: "book"
      reference: "Sam Newman - Chapter on Decomposition"

tooling:
  static_analysis:
    - tool: "Structure101"
      purpose: "Visualize module dependencies and cohesion"
      offline_capable: true

    - tool: "JDepend"
      purpose: "Analyze Java package metrics"
      offline_capable: true

    - tool: "SonarQube"
      purpose: "Package-level metrics and dependency analysis"
      offline_capable: false

    - tool: "dependency-cruiser"
      purpose: "Analyze JavaScript/TypeScript module structure"
      offline_capable: true

  scripts:
    - id: "change-coupling-analyzer"
      language: "bash"
      purpose: "Find files that change together from git history"
      source: "inline"
      code: |
        #!/bin/bash
        # Find files that frequently change together
        echo "=== Files Changed Together ==="
        git log --pretty=format:"%h" --name-only -n 100 | \
          awk '/^$/{if(files)print files;files=""} /^[a-f0-9]+$/{commit=$0} !/^$/{files=files" "$0}' | \
          tr ' ' '\n' | sort | uniq -c | sort -rn | head -20

signals:
  critical:
    - id: "MODULE-COH-CRIT-001"
      signal: "Module with unrelated functionalities (low functional cohesion)"
      evidence_pattern: "Module contains user, billing, and notification classes together"
      explanation: |
        A module containing unrelated domains violates Common Closure Principle.
        Changes to one area unnecessarily affect the entire module.
      remediation: "Split module by domain; create separate modules per bounded context"

    - id: "MODULE-COH-CRIT-002"
      signal: "High change coupling between unrelated modules"
      evidence_pattern: "Files in different modules consistently change together in commits"
      explanation: |
        When changes span multiple modules, either the modules are poorly
        bounded or there's hidden coupling that should be explicit.
      remediation: "Analyze change patterns; refactor to co-locate related code"

  high:
    - id: "MODULE-COH-HIGH-001"
      signal: "Module violates Common Reuse Principle"
      evidence_pattern: "Consumers use only small subset of module's capabilities"
      explanation: |
        Clients importing a module but using only a fraction of its exports
        indicates the module bundles unrelated concerns.
      remediation: "Split into focused modules; consumers import only what they need"

    - id: "MODULE-COH-HIGH-002"
      signal: "Shotgun surgery pattern - changes scattered across modules"
      evidence_pattern: "Single feature requires changes in >4 modules"
      explanation: |
        When implementing a feature requires touching many modules, the
        functionality is likely misallocated across module boundaries.
      remediation: "Re-evaluate module boundaries; consolidate related functionality"

  medium:
    - id: "MODULE-COH-MED-001"
      signal: "Mixed abstraction levels in module"
      evidence_pattern: "Module has both high-level domain logic and low-level utilities"
      remediation: "Separate into layers or create dedicated utility module"

    - id: "MODULE-COH-MED-002"
      signal: "Orphan code in modules"
      evidence_pattern: "Classes in module not imported by any other class in module"
      remediation: "Move orphaned code to appropriate module or remove if unused"

  low:
    - id: "MODULE-COH-LOW-001"
      signal: "Inconsistent module naming conventions"
      remediation: "Establish and enforce naming standards"

  positive:
    - id: "MODULE-COH-POS-001"
      signal: "Modules aligned with business domains"
    - id: "MODULE-COH-POS-002"
      signal: "High intra-module coupling, low inter-module coupling"

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Map module structure"
      description: |
        Create a catalog of all modules/packages and their contents
        to understand the current organization.
      duration_estimate: "25 min"
      commands:
        - purpose: "List module structure"
          command: "find . -name 'package.json' -o -name 'pom.xml' -o -name 'build.gradle' -o -name '__init__.py' | head -30"
        - purpose: "Count files per module"
          command: "find . -type d -name 'src' | while read d; do echo \"$d: $(find $d -name '*.java' -o -name '*.ts' | wc -l)\"; done | head -20"
      expected_findings:
        - "Module inventory"
        - "Size distribution"

    - id: "2"
      name: "Analyze change coupling"
      description: |
        Use git history to find files that frequently change together
        and assess if they're appropriately co-located.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find co-change patterns"
          command: "git log --oneline --name-only -n 200 | grep -E '\\.(java|ts|py)$' | sort | uniq -c | sort -rn | head -30"
        - purpose: "Find cross-module changes"
          command: "git log --oneline --name-only -n 50 | awk '/^[a-f0-9]/{commit++} !/^[a-f0-9]/{print commit,$0}' | sort | head -30"
      expected_findings:
        - "Files that change together"
        - "Cross-module change patterns"

    - id: "3"
      name: "Evaluate module dependencies"
      description: |
        Analyze import patterns to determine if modules have
        appropriate cohesion based on usage.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find cross-module imports"
          command: "grep -rh '^import' --include='*.java' | sed 's/import //' | cut -d. -f1-3 | sort | uniq -c | sort -rn | head -20"
        - purpose: "Analyze module coupling"
          command: "npx dependency-cruiser --output-type text src 2>/dev/null | head -40"
      expected_findings:
        - "Module dependency patterns"
        - "Highly coupled module pairs"

    - id: "4"
      name: "Assess functional cohesion"
      description: |
        Evaluate whether classes within each module share a common
        purpose and belong together functionally.
      duration_estimate: "40 min"
      questions:
        - "Can the module's purpose be described in one sentence?"
        - "Do all classes in the module relate to that purpose?"
        - "Are there obvious misplacements?"
      expected_findings:
        - "Module purpose clarity"
        - "Misplaced classes"

    - id: "5"
      name: "Review Common Reuse Principle"
      description: |
        Check if consumers of each module use most of its functionality
        or just a small subset.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find export usage"
          command: "grep -rh 'export ' --include='*.ts' | cut -d' ' -f2 | sort | uniq -c | sort -rn | head -20"
      expected_findings:
        - "Export utilization"
        - "Over-bundled modules"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "module_map"
      format: "visual"
      sections:
        - "Module Inventory"
        - "Dependency Graph"
        - "Change Coupling Analysis"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Module Cohesion Assessment"
        - "Restructuring Recommendations"

  confidence_guidance:
    high: "Change coupling data supports findings"
    medium: "Structural analysis suggests issues"
    low: "Manual review needed for confirmation"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "package-principles"
        priority: "required"
      - source_id: "modular-monolith"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive analysis"
    full:
      included: true
      priority: 1
    architecture:
      included: true
      priority: 1

closeout_checklist:
  - id: "module-cohesion-001"
    item: "Module inventory documented with purpose descriptions"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Each module has documented single-sentence purpose"
    expected: "Confirmed by reviewer"

  - id: "module-cohesion-002"
    item: "No modules with unrelated functionalities"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Each module serves single domain or purpose"
    expected: "Confirmed by reviewer"

  - id: "module-cohesion-003"
    item: "Change coupling analyzed from git history"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Files changing together are in same module"
    expected: "Confirmed by reviewer"

  - id: "module-cohesion-004"
    item: "Restructuring recommendations provided"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Low-cohesion modules have refactoring plan"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Modularity"]

relationships:
  commonly_combined:
    - "architecture-design.cohesion.class-cohesion"
    - "architecture-design.cohesion.feature-scattering"
    - "architecture-design.coupling.afferent-efferent-coupling"
