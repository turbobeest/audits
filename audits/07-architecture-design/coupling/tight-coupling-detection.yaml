# ============================================================
# AUDIT: Tight Coupling Detection
# ============================================================
# Analyzes codebase for tightly coupled components that create
# maintenance challenges and hinder independent deployment.
# ============================================================

audit:
  id: "architecture-design.coupling.tight-coupling-detection"
  name: "Tight Coupling Detection"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "architecture-design"
  category_number: 7
  subcategory: "coupling"

  tier: "expert"
  estimated_duration: "2-4 hours"  # median: 3h

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "architecture"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit identifies tightly coupled components within the codebase by
    analyzing direct dependencies, shared state, implementation inheritance,
    and concrete class references. It measures coupling metrics such as
    Coupling Between Objects (CBO), Fan-in/Fan-out ratios, and identifies
    components that are difficult to modify independently.

  why_it_matters: |
    Tight coupling creates a ripple effect where changes to one component
    necessitate changes to many others. This dramatically increases:
    - Maintenance cost and cognitive load
    - Risk of introducing bugs during refactoring
    - Time to implement new features
    - Difficulty in testing components in isolation
    - Barriers to parallel development by multiple teams

  when_to_run:
    - "During architecture reviews"
    - "Before major refactoring efforts"
    - "When onboarding new developers to understand dependencies"
    - "When experiencing high bug rates after changes"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Complete source code access"
    - type: "build_configuration"
      description: "Build files to understand module boundaries"

  access_requirements:
    - "Read access to source code repository"
    - "Understanding of project module structure"

discovery:
  code_patterns:
    - pattern: "new\\s+[A-Z][a-zA-Z]+\\("
      type: "regex"
      scope: "source"
      purpose: "Detect direct instantiation of concrete classes"

    - pattern: "extends\\s+[A-Z][a-zA-Z]+"
      type: "regex"
      scope: "source"
      purpose: "Identify implementation inheritance chains"

    - pattern: "import\\s+.*\\.(impl|internal|private)\\."
      type: "regex"
      scope: "source"
      purpose: "Find imports of internal/implementation packages"

    - pattern: "static\\s+(final\\s+)?[A-Z]"
      type: "regex"
      scope: "source"
      purpose: "Detect static dependencies and shared state"

  file_patterns:
    - glob: "**/*.java"
      purpose: "Java source files"
    - glob: "**/*.kt"
      purpose: "Kotlin source files"
    - glob: "**/*.ts"
      purpose: "TypeScript source files"
    - glob: "**/*.py"
      purpose: "Python source files"

knowledge_sources:
  specifications:
    - id: "martin-fowler-coupling"
      name: "Reducing Coupling - Martin Fowler"
      url: "https://martinfowler.com/articles/reducing-coupling.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "clean-code"
      name: "Clean Code: A Handbook of Agile Software Craftsmanship"
      url: "https://www.oreilly.com/library/view/clean-code/9780136083238/"
      offline_cache: true

    - id: "ddd-evans"
      name: "Domain-Driven Design Reference"
      url: "https://www.domainlanguage.com/ddd/reference/"
      offline_cache: true

    - id: "clean-architecture"
      name: "Clean Architecture"
      url: "https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html"
      offline_cache: true

    - id: "pragmatic-programmer"
      name: "Pragmatic Programmer Tips"
      url: "https://pragprog.com/tips/"
      offline_cache: true

  learning_resources:
    - id: "solid-principles"
      title: "SOLID Principles of Object-Oriented Design"
      type: "book"
      reference: "Robert C. Martin - Agile Software Development"

    - id: "refactoring-catalog"
      title: "Refactoring: Improving the Design of Existing Code"
      type: "book"
      reference: "Martin Fowler - ISBN 978-0134757599"

tooling:
  static_analysis:
    - tool: "SonarQube"
      purpose: "Measure coupling metrics (CBO, RFC, afferent/efferent coupling)"
      offline_capable: false

    - tool: "Structure101"
      purpose: "Visualize and analyze architectural dependencies"
      offline_capable: true

    - tool: "NDepend"
      purpose: "Calculate coupling metrics for .NET codebases"
      offline_capable: true

    - tool: "JDepend"
      purpose: "Analyze Java package dependencies"
      offline_capable: true

    - tool: "dependency-cruiser"
      purpose: "Validate and visualize JavaScript/TypeScript dependencies"
      offline_capable: true

  scripts:
    - id: "coupling-analyzer"
      language: "bash"
      purpose: "Quick coupling indicator analysis"
      source: "inline"
      code: |
        #!/bin/bash
        # Count direct instantiations of concrete classes
        echo "=== Direct Instantiation Count ==="
        find . \( find . -name "*.java" -o -name "*.ts" \) | xargs grep -c "new [A-Z]" 2>/dev/null | grep -v ":0$"

signals:
  critical:
    - id: "COUPLING-CRIT-001"
      signal: "Circular dependencies detected between modules"
      evidence_pattern: "Module A imports B, B imports C, C imports A"
      explanation: |
        Circular dependencies create build order problems, prevent
        independent deployment, and make the system impossible to
        understand or test in isolation.
      remediation: "Introduce abstraction layer or dependency inversion to break cycles"

    - id: "COUPLING-CRIT-002"
      signal: "God class with excessive coupling (CBO > 20)"
      evidence_pattern: "Class has imports from >20 different classes/modules"
      explanation: |
        A class coupled to many others becomes a change magnet and
        single point of failure. Any change has cascading effects.
      remediation: "Apply Single Responsibility Principle; decompose into smaller classes"

  high:
    - id: "COUPLING-HIGH-001"
      signal: "Concrete class dependencies instead of interfaces"
      evidence_pattern: "Constructor parameters typed to concrete classes"
      explanation: |
        Depending on concrete implementations prevents substitution
        and makes testing with mocks/stubs difficult.
      remediation: "Introduce interfaces; apply Dependency Injection pattern"

    - id: "COUPLING-HIGH-002"
      signal: "Deep inheritance hierarchies (>3 levels)"
      evidence_pattern: "Class extends chain exceeds 3 levels"
      explanation: |
        Deep inheritance creates fragile base class problems and
        tight coupling between all classes in the hierarchy.
      remediation: "Favor composition over inheritance; extract interfaces"

  medium:
    - id: "COUPLING-MED-001"
      signal: "Feature envy - methods accessing other objects' data excessively"
      evidence_pattern: "Method has multiple getter calls on same foreign object"
      remediation: "Move method to the class whose data it uses"

    - id: "COUPLING-MED-002"
      signal: "Inappropriate intimacy - classes accessing private details"
      evidence_pattern: "Use of reflection or friend access to internals"
      remediation: "Define proper public interfaces; remove reflection hacks"

  low:
    - id: "COUPLING-LOW-001"
      signal: "Minor coupling through utility classes"
      remediation: "Acceptable if utilities are truly stateless and stable"

  positive:
    - id: "COUPLING-POS-001"
      signal: "Clean dependency graph with minimal cycles"
    - id: "COUPLING-POS-002"
      signal: "Interface-based dependencies throughout"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Generate dependency graph"
      description: |
        Create a visual dependency graph of modules/packages to
        identify overall coupling structure and cycles.
      duration_estimate: "30 min"
      commands:
        - purpose: "Generate dependency visualization (JS/TS)"
          command: "npx dependency-cruiser --output-type dot src | dot -Tsvg > dependencies.svg"
        - purpose: "Analyze Java dependencies"
          command: "jdepend -file report.txt ./target/classes"
      expected_findings:
        - "Module dependency structure"
        - "Potential circular dependencies"

    - id: "2"
      name: "Measure coupling metrics"
      description: |
        Calculate CBO (Coupling Between Objects), Fan-in, Fan-out
        for each class/module.
      duration_estimate: "45 min"
      commands:
        - purpose: "Find high fan-out classes"
          command: "grep -r '^import' --include='*.java' | cut -d: -f1 | sort | uniq -c | sort -rn | head -20"
        - purpose: "Count class dependencies in TypeScript"
          command: "grep -r 'from.*import' --include='*.ts' | wc -l"
      expected_findings:
        - "Classes with excessive dependencies"
        - "Hot spots requiring refactoring"

    - id: "3"
      name: "Identify concrete dependencies"
      description: |
        Find instances where code depends on concrete implementations
        rather than abstractions.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find direct instantiation patterns"
          command: "grep -rn 'new [A-Z][a-zA-Z]*(' --include='*.java' | grep -v 'Test.java' | head -50"
        - purpose: "Find concrete constructor parameters"
          command: "grep -rn 'constructor.*: [A-Z][a-z]' --include='*.ts' | head -30"
      expected_findings:
        - "Concrete class instantiations"
        - "Constructor injection of implementations"

    - id: "4"
      name: "Analyze inheritance depth"
      description: |
        Map inheritance hierarchies to identify deep chains that
        indicate tight coupling.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find inheritance declarations"
          command: "grep -rn 'extends [A-Z]' --include='*.java' | grep -v 'Test'"
        - purpose: "Find class hierarchies in TypeScript"
          command: "grep -rn 'extends' --include='*.ts' | grep 'class'"
      expected_findings:
        - "Inheritance hierarchy depth"
        - "Classes with multiple levels of extension"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "dependency_graph"
      format: "visual"
      sections:
        - "Module Dependency Diagram"
        - "Circular Dependency Report"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Coupling Metrics Analysis"
        - "Key Problem Areas"
        - "Refactoring Recommendations"

  confidence_guidance:
    high: "Coupling metrics measured directly, dependencies verified"
    medium: "Pattern-based detection with manual verification needed"
    low: "Inferred from naming or structure only"

offline:
  capability: "full"
  cache_manifest:
    knowledge:
      - source_id: "martin-fowler-coupling"
        priority: "required"
      - source_id: "solid-principles"
        priority: "recommended"

profiles:
  membership:
    quick:
      included: false
      reason: "Deep analysis requires significant time"
    full:
      included: true
      priority: 1
    architecture:
      included: true
      priority: 1

closeout_checklist:
  - id: "tight-coupling-001"
    item: "Dependency graph generated and analyzed"
    level: "CRITICAL"
    verification: "test -f dependencies.svg || test -f dependency-report.* && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "tight-coupling-002"
    item: "No circular dependencies between major modules"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Reviewer confirms no red flags in dependency graph"
    expected: "Confirmed by reviewer"

  - id: "tight-coupling-003"
    item: "Coupling metrics within acceptable thresholds"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "CBO < 15 for most classes, Fan-out < 20"
    expected: "Confirmed by reviewer"

  - id: "tight-coupling-004"
    item: "High-coupling hotspots documented with remediation plan"
    level: "WARNING"
    verification: "manual"
    verification_notes: "All classes with CBO > 15 have documented action items"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Modularity"]

relationships:
  commonly_combined:
    - "architecture-design.coupling.afferent-efferent-coupling"
    - "architecture-design.cohesion.class-cohesion"
    - "architecture-design.design-principles.dependency-inversion"
