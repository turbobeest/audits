# ============================================================
# CORE WEB VITALS AUDIT
# ============================================================
# Evaluates Largest Contentful Paint (LCP), First Input Delay
# (FID)/Interaction to Next Paint (INP), and Cumulative Layout Shift (CLS).
# ============================================================

audit:
  id: "performance-efficiency.frontend-performance.core-web-vitals"
  name: "Core Web Vitals Audit"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "performance-efficiency"
  category_number: 2
  subcategory: "frontend-performance"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "production"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Measures and analyzes the three Core Web Vitals metrics that Google uses
    for ranking: Largest Contentful Paint (LCP) measures loading performance,
    Interaction to Next Paint (INP, replacing FID) measures interactivity,
    and Cumulative Layout Shift (CLS) measures visual stability.

  why_it_matters: |
    Core Web Vitals directly impact SEO rankings and user experience. Poor
    scores lead to lower search visibility and higher bounce rates. Google
    reports that pages meeting all three thresholds have 24% less user
    abandonment. These metrics represent real user experience.

  when_to_run:
    - "Before major releases"
    - "After changing critical rendering path"
    - "When SEO rankings drop unexpectedly"
    - "Monthly as part of performance monitoring"

prerequisites:
  required_artifacts:
    - type: "deployed_application"
      description: "Running web application accessible via HTTP"
    - type: "source_code"
      description: "Frontend source code for analysis"

  access_requirements:
    - "URL of the deployed application"
    - "Access to Chrome DevTools or Lighthouse"
    - "Optionally: Chrome UX Report data"

discovery:
  code_patterns:
    - pattern: "<img(?!.*loading=\"lazy\")"
      type: "regex"
      scope: "source"
      purpose: "Find images without lazy loading that may delay LCP"

    - pattern: "addEventListener.*scroll|addEventListener.*resize"
      type: "regex"
      scope: "source"
      purpose: "Find scroll/resize handlers that may affect CLS"

    - pattern: "document\\.write|innerHTML\\s*="
      type: "regex"
      scope: "source"
      purpose: "Find DOM manipulation that may cause layout shifts"

  file_patterns:
    - glob: "**/*.html"
      purpose: "HTML templates"
    - glob: "**/*.tsx"
      purpose: "React components"
    - glob: "**/*.vue"
      purpose: "Vue components"
    - glob: "**/*.css"
      purpose: "Stylesheets"

knowledge_sources:
  specifications:
    - id: "web-vitals-spec"
      name: "Web Vitals"
      url: "https://web.dev/vitals/"
      offline_cache: true
      priority: "required"

    - id: "lcp-spec"
      name: "Largest Contentful Paint (LCP)"
      url: "https://web.dev/lcp/"
      offline_cache: true
      priority: "required"

    - id: "inp-spec"
      name: "Interaction to Next Paint (INP)"
      url: "https://web.dev/inp/"
      offline_cache: true
      priority: "required"

    - id: "cls-spec"
      name: "Cumulative Layout Shift (CLS)"
      url: "https://web.dev/cls/"
      offline_cache: true
      priority: "required"

  guides:
    - id: "optimize-lcp"
      name: "Optimize Largest Contentful Paint"
      url: "https://web.dev/optimize-lcp/"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "Lighthouse CLI"
      purpose: "Measure Core Web Vitals"
      offline_capable: false

    - tool: "PageSpeed Insights"
      purpose: "Field and lab data for Core Web Vitals"
      offline_capable: false

    - tool: "web-vitals library"
      purpose: "Real user measurement of vitals"
      offline_capable: false

  scripts:
    - id: "lighthouse-audit"
      language: "bash"
      purpose: "Run Lighthouse audit"
      source: "inline"
      code: |
        #!/bin/bash
        lighthouse https://example.com \
          --output=json \
          --output-path=./lighthouse-report.json \
          --chrome-flags="--headless"

signals:
  critical:
    - id: "CWV-CRIT-001"
      signal: "LCP exceeds 4 seconds"
      evidence_threshold: "LCP > 4000ms"
      explanation: |
        LCP above 4 seconds is rated "poor" by Google. This severely impacts
        user experience and SEO. Users perceive the page as slow and are
        likely to abandon it.
      remediation: "Optimize LCP element: preload critical resources, use CDN, optimize images"

    - id: "CWV-CRIT-002"
      signal: "CLS exceeds 0.25"
      evidence_threshold: "CLS > 0.25"
      explanation: |
        CLS above 0.25 is rated "poor." Users experience jarring layout
        shifts that can cause misclicks and frustration. This often happens
        due to images without dimensions or late-loading content.
      remediation: "Add dimensions to images/videos, reserve space for dynamic content, avoid inserting content above existing content"

    - id: "CWV-CRIT-003"
      signal: "INP exceeds 500ms"
      evidence_threshold: "INP > 500ms"
      explanation: |
        INP above 500ms means interactions feel unresponsive. Users clicking
        buttons or typing see significant delays before visual feedback.
      remediation: "Break up long tasks, optimize event handlers, use requestIdleCallback"

  high:
    - id: "CWV-HIGH-001"
      signal: "LCP between 2.5-4 seconds"
      evidence_threshold: "2500ms < LCP <= 4000ms"
      explanation: |
        LCP in this range is rated "needs improvement." The page loads
        noticeably slower than optimal.
      remediation: "Preload LCP image, eliminate render-blocking resources, use efficient formats"

    - id: "CWV-HIGH-002"
      signal: "CLS between 0.1-0.25"
      evidence_threshold: "0.1 < CLS <= 0.25"
      explanation: |
        CLS in this range indicates noticeable but not severe layout shifts.
      remediation: "Identify shift sources with DevTools, add placeholders"

    - id: "CWV-HIGH-003"
      signal: "INP between 200-500ms"
      evidence_threshold: "200ms < INP <= 500ms"
      explanation: |
        INP in this range means some interactions feel sluggish.
      remediation: "Profile interactions, optimize JavaScript execution"

  medium:
    - id: "CWV-MED-001"
      signal: "LCP element not optimized"
      evidence_pattern: "<img.*src=.*(?!.*preload|fetchpriority)"
      remediation: "Add fetchpriority='high' to LCP image, consider preloading"

    - id: "CWV-MED-002"
      signal: "Images without explicit dimensions"
      evidence_pattern: "<img(?!.*width=|height=)"
      remediation: "Add width and height attributes to prevent layout shifts"

  low:
    - id: "CWV-LOW-001"
      signal: "No web-vitals measurement in place"
      evidence_pattern: "(?!.*web-vitals|reportWebVitals)"
      remediation: "Add web-vitals library to monitor real user metrics"

  positive:
    - id: "CWV-POS-001"
      signal: "All Core Web Vitals in good range"
      evidence_threshold: "LCP <= 2.5s, INP <= 200ms, CLS <= 0.1"

    - id: "CWV-POS-002"
      signal: "Real User Monitoring configured"
      evidence_pattern: "web-vitals|reportWebVitals|sendToAnalytics"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Run Lighthouse audit"
      description: |
        Execute Lighthouse against key pages to measure Core Web Vitals.
      duration_estimate: "15 min"
      commands:
        - purpose: "Run Lighthouse audit"
          command: "lighthouse https://example.com --output=json --output-path=./lh.json --chrome-flags='--headless'"
        - purpose: "Extract Core Web Vitals"
          command: "jq '.audits | {lcp: .\"largest-contentful-paint\", cls: .\"cumulative-layout-shift\", tbt: .\"total-blocking-time\"}' lh.json"
      expected_findings:
        - "LCP, CLS, and TBT/INP proxy scores"
        - "Specific recommendations"

    - id: "2"
      name: "Check real user data"
      description: |
        If available, check Chrome UX Report or analytics for field data.
      duration_estimate: "20 min"
      commands:
        - purpose: "Query CrUX API"
          command: "curl 'https://chromeuxreport.googleapis.com/v1/records:queryRecord?key=API_KEY' -d '{\"url\": \"https://example.com\"}'"
      expected_findings:
        - "Real user Core Web Vitals"
        - "Percentile distributions"

    - id: "3"
      name: "Identify LCP element"
      description: |
        Determine what element is the LCP and optimize its loading.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find LCP candidates in HTML"
          command: "grep -rn '<img\\|<video\\|<h1\\|hero' --include='*.html' --include='*.tsx' ."
      expected_findings:
        - "LCP element identification"
        - "Loading optimization opportunities"

    - id: "4"
      name: "Analyze layout shifts"
      description: |
        Identify elements causing CLS using DevTools or Layout Instability API.
      duration_estimate: "25 min"
      questions:
        - "Which elements shift during page load?"
        - "Are images/videos missing dimensions?"
        - "Is dynamic content inserted above fold?"
      expected_findings:
        - "Elements causing layout shifts"
        - "Root causes of CLS"

    - id: "5"
      name: "Profile interactivity"
      description: |
        Identify long tasks blocking main thread using Chrome DevTools Performance panel.
      duration_estimate: "25 min"
      commands:
        - purpose: "Check for long tasks in bundle"
          command: "grep -rn 'addEventListener\\|onClick\\|onInput' --include='*.tsx' --include='*.js' . | head -20"
      expected_findings:
        - "Long tasks affecting INP"
        - "Heavy event handlers"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Core Web Vitals Scores"
        - "LCP Analysis"
        - "CLS Analysis"
        - "INP Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Lighthouse/CrUX data clearly shows metric values"
    medium: "Code patterns suggest likely impact on metrics"
    low: "Potential issue requiring measurement to confirm"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "web-vitals-spec"
        priority: "required"
      - source_id: "lcp-spec"
        priority: "required"

profiles:
  membership:
    quick:
      included: true
      priority: 1
      reason: "Core Web Vitals are critical for all web apps"
    full:
      included: true
      priority: 1
    production:
      included: true
      priority: 1

closeout_checklist:
  - id: "cwv-001"
    item: "LCP under 2.5 seconds on key pages"
    level: "CRITICAL"
    verification: "lighthouse --only-categories=performance URL | grep 'largest-contentful-paint'"
    expected: "< 2500ms"

  - id: "cwv-002"
    item: "CLS under 0.1 on key pages"
    level: "CRITICAL"
    verification: "lighthouse --only-categories=performance URL | grep 'cumulative-layout-shift'"
    expected: "< 0.1"

  - id: "cwv-003"
    item: "INP/TBT acceptable"
    level: "BLOCKING"
    verification: "lighthouse --only-categories=performance URL | grep 'total-blocking-time'"
    expected: "TBT < 300ms (proxy for INP)"

governance:
  applicable_to:
    archetypes: ["webapp", "marketing-site", "ecommerce"]

relationships:
  commonly_combined:
    - "performance-efficiency.frontend-performance.javascript-bundle-size"
    - "performance-efficiency.frontend-performance.critical-rendering-path"
    - "performance-efficiency.frontend-performance.image-optimization"
