# ============================================================
# LAZY LOADING AUDIT
# ============================================================
# Evaluates deferred loading patterns for data, code, and resources
# to optimize initial load time and memory usage.

audit:
  id: "performance-efficiency.algorithmic-efficiency.lazy-loading"
  name: "Lazy Loading Audit"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "performance-efficiency"
  category_number: 2
  subcategory: "algorithmic-efficiency"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "codebase"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Analyzes lazy loading implementation for code splitting, data fetching,
    images, and component rendering. Evaluates whether resources are loaded
    on-demand vs. eagerly, and whether deferred loading improves or harms
    user experience.

  why_it_matters: |
    Loading everything upfront increases initial load time and memory usage.
    Lazy loading defers non-critical resources until needed, improving
    perceived performance. However, excessive lazy loading can cause
    delays when users need resources, creating janky experiences.

  when_to_run:
    - "Frontend performance optimization"
    - "Bundle size analysis"
    - "Initial load time improvement"
    - "Memory optimization"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Application source code"

  access_requirements:
    - "Source code repository access"
    - "Build configuration access"

discovery:
  code_patterns:
    - pattern: "lazy\\(|React\\.lazy|dynamic\\(|loadable\\("
      type: "regex"
      scope: "source"
      purpose: "Find React/framework lazy loading"

    - pattern: "import\\(|require\\.ensure|System\\.import"
      type: "regex"
      scope: "source"
      purpose: "Find dynamic imports"

    - pattern: "loading=['\"]lazy['\"]|IntersectionObserver"
      type: "regex"
      scope: "source"
      purpose: "Find image lazy loading"

    - pattern: "@defer|\\*ngIf|v-if.*lazy"
      type: "regex"
      scope: "source"
      purpose: "Find Angular/Vue lazy patterns"

  file_patterns:
    - glob: "**/webpack*.config.{js,ts}"
      purpose: "Webpack code splitting configuration"
    - glob: "**/routes*.{js,ts,tsx}"
      purpose: "Route-based code splitting"
    - glob: "**/vite.config.{js,ts}"
      purpose: "Vite configuration"

knowledge_sources:
  guides:
    - id: "react-lazy"
      name: "React Lazy Loading"
      url: "https://react.dev/reference/react/lazy"
      offline_cache: true

    - id: "web-dev-lazy"
      name: "Web.dev Lazy Loading Guide"
      url: "https://web.dev/lazy-loading/"
      offline_cache: true

    - id: "webpack-splitting"
      name: "Webpack Code Splitting"
      url: "https://webpack.js.org/guides/code-splitting/"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "grep/ripgrep"
      purpose: "Find lazy loading patterns"
      offline_capable: true

    - tool: "webpack-bundle-analyzer"
      purpose: "Analyze code splitting"
      offline_capable: true

  scripts:
    - id: "lazy-load-finder"
      language: "bash"
      purpose: "Find lazy loading patterns"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Dynamic Imports ==="
        rg -n 'import\\(' --type js --type ts
        echo
        echo "=== React Lazy ==="
        rg -n 'React\\.lazy|lazy\\(' --type js --type ts --type tsx
        echo
        echo "=== Image Lazy Loading ==="
        rg -n 'loading=.lazy' --type html --type tsx --type jsx

signals:
  critical:
    - id: "LAZY-CRIT-001"
      signal: "Large bundle with no code splitting"
      evidence_pattern: "Single bundle > 500KB without dynamic imports"
      explanation: |
        Large monolithic bundles must be fully downloaded before anything
        renders. Code splitting reduces initial bundle size and time-to-
        interactive by loading code on demand.
      remediation: "Implement route-based code splitting at minimum"

    - id: "LAZY-CRIT-002"
      signal: "Critical path blocked by lazy loading"
      evidence_pattern: "Lazy loading of above-the-fold content or critical features"
      explanation: |
        Lazy loading critical content adds latency to what users see first.
        Above-the-fold content and core functionality should load eagerly.
      remediation: "Eagerly load critical path, lazy load non-critical content"

  high:
    - id: "LAZY-HIGH-001"
      signal: "Images without lazy loading"
      evidence_pattern: "<img> tags without loading='lazy' for below-the-fold images"
      explanation: |
        Loading all images upfront wastes bandwidth for images users may
        never scroll to see. Native lazy loading is supported in all
        modern browsers with zero JavaScript required.
      remediation: "Add loading='lazy' to images below the fold"

    - id: "LAZY-HIGH-002"
      signal: "No loading states for lazy components"
      evidence_pattern: "React.lazy without Suspense fallback"
      explanation: |
        Without loading states, lazy components show nothing while loading,
        creating confusing blank spaces or layout shifts.
      remediation: "Wrap lazy components in Suspense with appropriate fallback"

  medium:
    - id: "LAZY-MED-001"
      signal: "Over-fragmented code splitting"
      evidence_pattern: "Too many small chunks causing waterfall requests"
      explanation: |
        Excessive code splitting creates many small files, each requiring
        a separate HTTP request. This can be slower than fewer larger files
        due to connection overhead.
      remediation: "Group related code, aim for meaningful chunk sizes"

    - id: "LAZY-MED-002"
      signal: "No prefetching of likely-needed chunks"
      evidence_pattern: "Lazy loading without prefetch hints"
      explanation: |
        Predictable navigation paths can be prefetched during idle time,
        making lazy loading feel instant.
      remediation: "Add prefetch for predictable navigation targets"

  low:
    - id: "LAZY-LOW-001"
      signal: "Lazy loading not used for optional features"
      evidence_pattern: "Admin/settings features in main bundle"
      remediation: "Move optional features to lazy-loaded chunks"

  positive:
    - id: "LAZY-POS-001"
      signal: "Route-based code splitting implemented"

    - id: "LAZY-POS-002"
      signal: "Images use native lazy loading"

    - id: "LAZY-POS-003"
      signal: "Prefetching configured for common navigation"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Analyze bundle composition"
      description: |
        Review bundle configuration and output to understand current
        code splitting strategy and bundle sizes.
      duration_estimate: "30 min"

      commands:
        - purpose: "Find code splitting config"
          command: "rg -n 'splitChunks|optimization|chunks' webpack.config.* || echo 'No webpack config'"
        - purpose: "Find dynamic imports"
          command: "rg -n 'import\\(' --type js --type ts | grep -v node_modules | head -20"

      expected_findings:
        - "Code splitting configuration"
        - "Bundle composition"

    - id: "2"
      name: "Identify lazy loading patterns"
      description: |
        Catalog all lazy loading implementations for components, routes,
        images, and data.
      duration_estimate: "30 min"

      commands:
        - purpose: "Find lazy components"
          command: "rg -n 'React\\.lazy|lazy\\(|dynamic\\(' --type js --type ts --type tsx"
        - purpose: "Find lazy images"
          command: "rg -n 'loading=.lazy' --type html --type tsx --type jsx || echo 'None found'"

      expected_findings:
        - "Lazy loading inventory"
        - "Coverage assessment"

    - id: "3"
      name: "Verify loading states"
      description: |
        Confirm that lazy-loaded components have appropriate loading states
        and fallback content.
      duration_estimate: "20 min"

      commands:
        - purpose: "Find Suspense boundaries"
          command: "rg -n 'Suspense|fallback=' --type js --type tsx"

      expected_findings:
        - "Loading state coverage"
        - "User experience during loading"

    - id: "4"
      name: "Check prefetching strategy"
      description: |
        Review prefetch and preload hints for predictable resource needs.
      duration_estimate: "20 min"

      commands:
        - purpose: "Find prefetch hints"
          command: "rg -n 'prefetch|preload|webpackPrefetch' --type js --type html"

      expected_findings:
        - "Prefetch implementation"
        - "Optimization opportunities"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Bundle Analysis"
        - "Lazy Loading Inventory"
        - "Recommendations"

  confidence_guidance:
    high: "Bundle analysis with runtime performance testing"
    medium: "Code analysis with bundle size estimates"
    low: "Pattern matching without bundle analysis"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "webpack-splitting"
        priority: "required"

profiles:
  membership:
    quick:
      included: true
      priority: 2
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "lazy-001"
    item: "Route-based code splitting implemented"
    level: "CRITICAL"
    verification: "rg -l 'import\\(|React\\.lazy|dynamic\\(' --type js --type ts | wc -l | awk '{if($1>0)print \"PASS\"; else print \"FAIL\"}'"
    expected: "PASS"

  - id: "lazy-002"
    item: "Images use lazy loading"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Below-the-fold images have loading='lazy'"
    expected: "Confirmed by reviewer"

  - id: "lazy-003"
    item: "Lazy components have loading states"
    level: "WARNING"
    verification: "rg -l 'Suspense' --type js --type tsx | wc -l | awk '{if($1>0)print \"PASS\"; else print \"REVIEW\"}'"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "Web Performance"
      controls: ["Initial Load Time"]

relationships:
  commonly_combined:
    - "performance-efficiency.frontend-performance.bundle-size"
    - "performance-efficiency.algorithmic-efficiency.space-complexity"
    - "performance-efficiency.frontend-performance.time-to-interactive"
