# ============================================================
# AUDIT: Feature Envy Detection
# ============================================================

audit:
  id: "code-quality.code-smells.feature-envy"
  name: "Feature Envy Detection Audit"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "code-smells"

  tier: "expert"
  estimated_duration: "45 minutes"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "codebase"

  default_profiles:
    - "full"
    - "quality"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Identifies methods that use more features (methods, data) of other classes
    than their own class. This occurs when a method seems more interested in
    another class than the one it belongs to, accessing external data more
    than its own state.

  why_it_matters: |
    Feature envy indicates misplaced behavior. The envious method should likely
    be moved to the class it envies, improving cohesion and reducing coupling.
    It violates the "tell, don't ask" principle and often leads to rigid,
    hard-to-change code structures.

  when_to_run:
    - "During code reviews"
    - "When refactoring related classes"
    - "Architecture assessments"
    - "When class responsibilities are unclear"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Object-oriented source code"

  access_requirements:
    - "Read access to source code repository"

discovery:
  code_patterns:
    - pattern: "(\\w+)\\.(\\w+)\\.(\\w+)"
      type: "regex"
      scope: "source"
      purpose: "Detect chained method calls"

    - pattern: "(\\w+)\\.get\\w+\\(\\)"
      type: "regex"
      scope: "source"
      purpose: "Detect getter calls on external objects"

    - pattern: "this\\.\\w+.*other\\.\\w+.*other\\.\\w+"
      type: "regex"
      scope: "source"
      purpose: "Detect methods using external data more than self"

  file_patterns:
    - glob: "**/*.{java,cs,ts,py,rb}"
      purpose: "Object-oriented source files"

knowledge_sources:
  guides:
    - id: "fowler-feature-envy"
      name: "Martin Fowler - Feature Envy"
      url: "https://refactoring.guru/smells/feature-envy"
      offline_cache: true

    - id: "fowler-move-method"
      name: "Martin Fowler - Move Method"
      url: "https://refactoring.com/catalog/moveFunction.html"
      offline_cache: true

    - id: "refactoring-fowler"
      name: "Martin Fowler - Refactoring"
      url: "https://refactoring.com/"
      offline_cache: false

    - id: "refactoring-catalog"
      name: "Refactoring Catalog"
      url: "https://refactoring.com/catalog/"
      offline_cache: false

    - id: "clean-code"
      name: "Robert C. Martin - Clean Code"
      url: "https://www.oreilly.com/library/view/clean-code-a/9780136083238/"
      offline_cache: false

tooling:
  static_analysis:
    - tool: "sonarqube"
      purpose: "Feature envy detection"
      offline_capable: false
    - tool: "jdeodorant"
      purpose: "Java feature envy detection"
      offline_capable: true
    - tool: "designite"
      purpose: ".NET code smell detection"
      offline_capable: true

  scripts:
    - id: "feature-envy-scan"
      language: "bash"
      purpose: "Find methods with excessive external references"
      source: "inline"
      code: |
        # Find methods with many chained calls (potential feature envy)
        grep -rn --include="*.{ts,java}" -E "\w+\.\w+\.\w+\.\w+" . 2>/dev/null | head -50

signals:
  critical:
    - id: "CS-ENVY-CRIT-001"
      signal: "Method accessing 10+ fields/methods from a single external class"
      evidence_pattern: "single_external_class_references > 10"
      explanation: |
        Extreme feature envy where a method primarily operates on another
        class's data. This method almost certainly belongs in the other class.
      remediation: "Move method to the class it envies"

    - id: "CS-ENVY-CRIT-002"
      signal: "Feature envy in business logic methods"
      evidence_pattern: "business_logic.*external_references > self_references"
      explanation: |
        Feature envy in core business logic creates fragile designs where
        changes to data structures ripple through unrelated code.
      remediation: "Apply Move Method refactoring to colocate behavior with data"

  high:
    - id: "CS-ENVY-HIGH-001"
      signal: "Method with 5+ external getter calls"
      evidence_pattern: "external_getter_count > 5"
      explanation: |
        Multiple getter calls indicate procedural thinking where the method
        should delegate to the owning class instead.
      remediation: "Extract method to data-owning class"

    - id: "CS-ENVY-HIGH-002"
      signal: "Long method chains accessing data"
      evidence_pattern: "method_chain_depth > 3"
      explanation: |
        Deep method chains (Law of Demeter violations) combined with
        feature envy create brittle, hard-to-test code.
      remediation: "Apply Extract Method and Move Method"

  medium:
    - id: "CS-ENVY-MED-001"
      signal: "Method accessing multiple external objects"
      evidence_pattern: "external_object_count > 3"
      remediation: "Consider extracting coordination logic to appropriate location"

    - id: "CS-ENVY-MED-002"
      signal: "Utility methods operating on single type"
      evidence_pattern: "util.*method.*single_type_params"
      remediation: "Consider moving to instance method on target type"

  low:
    - id: "CS-ENVY-LOW-001"
      signal: "Minor feature envy in helper methods"
      evidence_pattern: "helper.*external_refs > 2"
      remediation: "Review for potential move opportunities"

  positive:
    - id: "CS-ENVY-POS-001"
      signal: "Methods primarily use own class data"
      evidence_pattern: "self_references > external_references"
    - id: "CS-ENVY-POS-002"
      signal: "Tell-don't-ask pattern followed"
      evidence_pattern: "method_calls > getter_calls"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify External References"
      description: |
        Scan methods for references to external class members
        including getters, fields, and methods.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find getter chains"
          command: |
            grep -rn --include="*.{ts,java}" -E "\.get[A-Z]\w+\(\)\.get[A-Z]\w+\(\)" . 2>/dev/null | head -50
        - purpose: "Find long method chains"
          command: |
            grep -rn --include="*.{ts,java}" -E "\w+\.\w+\.\w+\.\w+" . 2>/dev/null | head -50
      expected_findings:
        - "Methods with excessive external references"
        - "Getter chain patterns"

    - id: "2"
      name: "Analyze Reference Ratios"
      description: |
        For suspect methods, compare external references to self
        references to identify feature envy.
      duration_estimate: "15 min"
      expected_findings:
        - "Self vs external reference ratios"
        - "Methods with inverted ratios"

    - id: "3"
      name: "Identify Target Classes"
      description: |
        For envious methods, identify which class(es) they envy
        to determine move targets.
      duration_estimate: "10 min"
      expected_findings:
        - "Primary envy target per method"
        - "Move recommendations"

    - id: "4"
      name: "Generate Refactoring Plan"
      description: |
        Create prioritized list of methods to move with impact assessment.
      duration_estimate: "5 min"
      expected_findings:
        - "Prioritized refactoring list"
        - "Dependency impacts"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      content:
        - "method_name"
        - "current_class"
        - "envy_target_class"
        - "external_reference_count"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Feature Envy Inventory"
        - "Analysis"
        - "Refactoring Recommendations"

  confidence_guidance:
    high: "Clear envy pattern with single target class"
    medium: "Multiple external references, target unclear"
    low: "Marginal case requiring manual review"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "fowler-feature-envy"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires semantic analysis"
    full:
      included: true
      priority: 2
    quality:
      included: true
      priority: 1

closeout_checklist:
  - id: "feature-envy-001"
    item: "External reference analysis completed"
    level: "BLOCKING"
    verification: |
      grep -rn --include="*.{ts,java}" -E "\.\w+\.\w+\." . 2>/dev/null | wc -l
    expected: "Analysis complete"

  - id: "feature-envy-002"
    item: "Severe feature envy cases documented"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Review methods with 10+ external references"
    expected: "All documented"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Modularity"]

relationships:
  commonly_combined:
    - "code-quality.code-smells.god-class"
    - "code-quality.code-smells.data-clump"
    - "code-quality.code-smells.inappropriate-intimacy"
