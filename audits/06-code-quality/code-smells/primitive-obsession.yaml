# ============================================================
# AUDIT: Primitive Obsession Detection
# ============================================================

audit:
  id: "code-quality.code-smells.primitive-obsession"
  name: "Primitive Obsession Detection Audit"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "code-smells"

  tier: "expert"
  estimated_duration: "40 minutes"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "codebase"

  default_profiles:
    - "full"
    - "quality"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Identifies overuse of primitive types (strings, integers, booleans) where
    domain-specific types would be more appropriate. This includes using strings
    for email addresses, phone numbers, currencies, IDs, and other concepts that
    have specific validation rules and behaviors.

  why_it_matters: |
    Primitive obsession leads to scattered validation logic, type confusion bugs,
    and missed opportunities for encapsulating domain knowledge. Domain primitives
    and value objects provide type safety, centralized validation, and self-
    documenting code. They prevent invalid states by construction.

  when_to_run:
    - "During domain modeling"
    - "Code reviews for new features"
    - "When validation logic is scattered"
    - "Technical debt assessments"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Application source code"

  access_requirements:
    - "Read access to source code repository"

discovery:
  code_patterns:
    - pattern: "email:\\s*string|email:\\s*String"
      type: "regex"
      scope: "source"
      purpose: "Identify email as string"

    - pattern: "(phone|telephone):\\s*string"
      type: "regex"
      scope: "source"
      purpose: "Identify phone as string"

    - pattern: "(price|amount|cost|total):\\s*(number|int|float|double)"
      type: "regex"
      scope: "source"
      purpose: "Identify money as primitive number"

    - pattern: "\\bstring\\s+(id|Id|ID)\\b|\\bId:\\s*string\\b"
      type: "regex"
      scope: "source"
      purpose: "Identify ID as plain string"

    - pattern: "(zip|zipCode|postal):\\s*string"
      type: "regex"
      scope: "source"
      purpose: "Identify postal code as string"

  file_patterns:
    - glob: "**/*.{java,cs,ts,py,rb,go}"
      purpose: "Source code files"

knowledge_sources:
  guides:
    - id: "fowler-primitive-obsession"
      name: "Martin Fowler - Primitive Obsession"
      url: "https://refactoring.guru/smells/primitive-obsession"
      offline_cache: true

    - id: "evans-ddd"
      name: "Eric Evans - Domain-Driven Design (Value Objects)"
      url: "https://www.domainlanguage.com/ddd/"
      offline_cache: false

    - id: "fowler-replace-primitive"
      name: "Martin Fowler - Replace Primitive with Object"
      url: "https://refactoring.com/catalog/replacePrimitiveWithObject.html"
      offline_cache: true

    - id: "refactoring-fowler"
      name: "Martin Fowler - Refactoring"
      url: "https://refactoring.com/"
      offline_cache: false

    - id: "refactoring-catalog"
      name: "Refactoring Catalog"
      url: "https://refactoring.com/catalog/"
      offline_cache: false

    - id: "clean-code"
      name: "Robert C. Martin - Clean Code"
      url: "https://www.oreilly.com/library/view/clean-code-a/9780136083238/"
      offline_cache: false

tooling:
  static_analysis:
    - tool: "sonarqube"
      purpose: "Primitive obsession rules"
      offline_capable: false
    - tool: "custom-lint"
      purpose: "Domain primitive enforcement"
      offline_capable: true

  scripts:
    - id: "primitive-obsession-scan"
      language: "bash"
      purpose: "Find primitive type usage for domain concepts"
      source: "inline"
      code: |
        # Find domain concepts typed as primitives
        grep -rn --include="*.{ts,java}" -iE "(email|phone|currency|price|amount):\s*(string|String|number|int)" . 2>/dev/null | head -50

signals:
  critical:
    - id: "CS-PRIM-CRIT-001"
      signal: "Security-sensitive data as plain strings"
      evidence_pattern: "(password|secret|token|apiKey):\\s*string"
      explanation: |
        Security credentials stored as plain strings may be accidentally
        logged, serialized, or exposed. Wrapper types can prevent this.
      remediation: "Create SecureString or Credential value type"

    - id: "CS-PRIM-CRIT-002"
      signal: "Money values as plain numbers"
      evidence_pattern: "(price|amount|cost|balance):\\s*(number|float|double)"
      explanation: |
        Financial calculations with floating point numbers lead to
        rounding errors. Money should use dedicated types with proper
        precision handling.
      remediation: "Implement Money value object with currency and amount"

  high:
    - id: "CS-PRIM-HIGH-001"
      signal: "IDs typed as plain strings without validation"
      evidence_pattern: "\\bstring\\s+\\w*[iI]d\\b|\\w*[iI]d:\\s*string"
      explanation: |
        String IDs allow invalid values to propagate through the system.
        Typed IDs catch errors at compile time and make code self-documenting.
      remediation: "Create typed ID classes (UserId, OrderId, etc.)"

    - id: "CS-PRIM-HIGH-002"
      signal: "Email addresses as plain strings"
      evidence_pattern: "email:\\s*string"
      explanation: |
        Email validation scattered across codebase leads to inconsistent
        validation and potential security issues.
      remediation: "Create EmailAddress value object with validation"

  medium:
    - id: "CS-PRIM-MED-001"
      signal: "Phone numbers as strings"
      evidence_pattern: "(phone|telephone|mobile):\\s*string"
      remediation: "Create PhoneNumber value object"

    - id: "CS-PRIM-MED-002"
      signal: "URL/URI as plain strings"
      evidence_pattern: "(url|uri|link|href):\\s*string"
      remediation: "Use URL/URI types from standard library or create wrapper"

  low:
    - id: "CS-PRIM-LOW-001"
      signal: "Boolean flags that could be enums"
      evidence_pattern: "(is|has|can|should)\\w+:\\s*boolean"
      remediation: "Consider enum for multi-state scenarios"

  positive:
    - id: "CS-PRIM-POS-001"
      signal: "Domain primitives used for key concepts"
      evidence_pattern: "EmailAddress|Money|PhoneNumber|UserId"
    - id: "CS-PRIM-POS-002"
      signal: "Value objects for data clumps"
      evidence_pattern: "class.*(Address|DateRange|Coordinates)"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Scan for Primitive Domain Concepts"
      description: |
        Search for common domain concepts that are typed as primitives
        rather than domain-specific types.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find email as string"
          command: |
            grep -rn --include="*.{ts,java,cs}" -iE "email\s*:\s*(string|String)" . 2>/dev/null | head -50
        - purpose: "Find money as number"
          command: |
            grep -rn --include="*.{ts,java,cs}" -iE "(price|amount|cost|total)\s*:\s*(number|int|float|double)" . 2>/dev/null | head -50
        - purpose: "Find IDs as string"
          command: |
            grep -rn --include="*.{ts,java,cs}" -E "\w+Id\s*:\s*string" . 2>/dev/null | head -50
      expected_findings:
        - "Domain concepts using primitives"
        - "Scattered validation patterns"

    - id: "2"
      name: "Identify Validation Scattering"
      description: |
        Find validation logic for primitive types that should be
        centralized in value objects.
      duration_estimate: "10 min"
      commands:
        - purpose: "Find email validation"
          command: |
            grep -rn --include="*.{ts,java}" -iE "email.*valid|validate.*email|@.*\\.com" . 2>/dev/null | head -30
      expected_findings:
        - "Scattered validation locations"
        - "Inconsistent validation patterns"

    - id: "3"
      name: "Assess Domain Impact"
      description: |
        Evaluate which primitives are most used and would benefit
        most from value object extraction.
      duration_estimate: "10 min"
      expected_findings:
        - "Usage frequency per concept"
        - "Priority for extraction"

    - id: "4"
      name: "Generate Refactoring Plan"
      description: |
        Create prioritized list of value objects to introduce.
      duration_estimate: "5 min"
      expected_findings:
        - "Value objects to create"
        - "Migration approach"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      content:
        - "primitive_usage"
        - "domain_concept"
        - "occurrence_count"
        - "suggested_type"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Primitive Obsession Inventory"
        - "Domain Analysis"
        - "Value Object Recommendations"

  confidence_guidance:
    high: "Clear domain concept with validation needs"
    medium: "Possible domain concept, review needed"
    low: "May be appropriate as primitive"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "fowler-primitive-obsession"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires domain analysis"
    full:
      included: true
      priority: 2
    quality:
      included: true
      priority: 1

closeout_checklist:
  - id: "primitive-001"
    item: "Primitive concept scan completed"
    level: "BLOCKING"
    verification: |
      grep -rn --include="*.{ts,java}" -iE "(email|phone|price|amount):\s*(string|number)" . 2>/dev/null | wc -l
    expected: "Analysis complete"

  - id: "primitive-002"
    item: "No money as float/double"
    level: "CRITICAL"
    verification: |
      grep -rn --include="*.{ts,java}" -iE "(price|amount|cost):\s*(float|double)" . 2>/dev/null | wc -l
    expected: "0"

  - id: "primitive-003"
    item: "Security credentials not as plain string"
    level: "CRITICAL"
    verification: |
      grep -rn --include="*.{ts,java}" -iE "(password|secret|apiKey):\s*string" . 2>/dev/null | wc -l
    expected: "0"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Reliability"]

relationships:
  commonly_combined:
    - "code-quality.code-smells.data-clump"
    - "code-quality.code-smells.long-parameter-list"
    - "code-quality.maintainability.type-safety"
