# ============================================================
# AUDIT FILE - Visual Regression Testing v1.0
# ============================================================

# ============================================================
# SECTION 1: IDENTITY & METADATA
# ============================================================

audit:
  id: "code-quality.testing.visual-regression"

  name: "Visual Regression Testing"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "testing"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: true
  destructive: false

# ============================================================
# SECTION 2: EXECUTION CLASSIFICATION
# ============================================================

execution:
  automatable: "partial"

  severity: "medium"

  scope: "testing"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

# ============================================================
# SECTION 3: DESCRIPTION & RATIONALE
# ============================================================

description:
  what: |
    Evaluates visual regression testing practices for UI components
    and pages. Assesses screenshot comparison coverage, visual diff
    workflows, component visual testing, and cross-browser visual
    consistency verification.

  why_it_matters: |
    CSS changes can have unintended visual side effects that are hard
    to catch with functional tests. Visual regression testing catches
    layout shifts, styling bugs, and unintended UI changes before they
    reach users.

  when_to_run:
    - "After CSS/styling changes"
    - "Before UI releases"
    - "When updating design system"
    - "Periodic UI quality check"

# ============================================================
# SECTION 4: PREREQUISITES
# ============================================================

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "UI source code"
    - type: "running_system"
      description: "Running application or Storybook"

  access_requirements:
    - "Browser automation tools"
    - "Screenshot storage access"
    - "Visual diff service (optional)"

# ============================================================
# SECTION 5: DISCOVERY SPECIFICATION
# ============================================================

discovery:
  file_patterns:
    - glob: "**/*.stories.*"
      purpose: "Storybook stories"
    - glob: "**/visual/**/*.test.*"
      purpose: "Visual test files"
    - glob: "**/__image_snapshots__/**"
      purpose: "Jest image snapshots"
    - glob: "**/screenshots/**"
      purpose: "Screenshot baselines"

  code_patterns:
    - pattern: "toMatchImageSnapshot|toMatchSnapshot"
      type: "regex"
      scope: "source"
      purpose: "Snapshot testing patterns"
    - pattern: "percy|chromatic|applitools"
      type: "keyword"
      scope: "source"
      purpose: "Visual testing services"

# ============================================================
# SECTION 6: EXTERNAL KNOWLEDGE SOURCES
# ============================================================

knowledge_sources:
  guides:
    - id: "storybook-visual"
      name: "Storybook Visual Testing"
      url: "https://storybook.js.org/docs/react/writing-tests/visual-testing"
      offline_cache: true
    - id: "percy-docs"
      name: "Percy Documentation"
      url: "https://docs.percy.io/"
      offline_cache: true

    - id: "xunit-patterns"
      name: "xUnit Test Patterns: Refactoring Test Code"
      url: "https://www.amazon.com/xUnit-Test-Patterns-Refactoring-Code/dp/0131495054"
      offline_cache: false

    - id: "working-effectively-legacy"
      name: "Working Effectively with Legacy Code"
      url: "https://www.oreilly.com/library/view/working-effectively-with/0131177052/"
      offline_cache: false

# ============================================================
# SECTION 7: TOOLING & AUTOMATION
# ============================================================

tooling:
  static_analysis:
    - tool: "Percy"
      purpose: "Visual review platform"
      offline_capable: false
    - tool: "Chromatic"
      purpose: "Storybook visual testing"
      offline_capable: false
    - tool: "jest-image-snapshot"
      purpose: "Local image snapshot testing"
      offline_capable: true
    - tool: "BackstopJS"
      purpose: "Visual regression testing"
      offline_capable: true
    - tool: "Playwright"
      purpose: "Screenshot comparison"
      offline_capable: true

  scripts:
    - id: "visual-test-run"
      language: "bash"
      purpose: "Run visual tests"
      source: "inline"
      code: |
        #!/bin/bash
        npx jest --testPathPattern=visual 2>/dev/null || npx backstop test 2>/dev/null

# ============================================================
# SECTION 8: SIGNALS & FINDINGS TAXONOMY
# ============================================================

signals:
  critical:
    - id: "VIS-CRIT-001"
      signal: "No visual regression testing for user-facing UI"
      evidence_pattern: "Absence of visual tests for main pages"
      explanation: |
        Without visual regression testing, CSS changes may break
        UI appearance without any automated detection.
      remediation: "Implement visual testing for critical pages and components"

  high:
    - id: "VIS-HIGH-001"
      signal: "Critical user flows lack visual coverage"
      evidence_pattern: "Key pages without visual snapshots"
      explanation: |
        Important pages like checkout, login, and dashboard should
        have visual regression protection.
      remediation: "Add visual tests for critical user journey pages"

    - id: "VIS-HIGH-002"
      signal: "Visual tests not in CI/CD"
      evidence_pattern: "Visual tests run manually only"
      explanation: |
        Manual visual testing is unreliable and often skipped.
      remediation: "Integrate visual tests into CI pipeline"

  medium:
    - id: "VIS-MED-001"
      signal: "Component library lacks visual tests"
      remediation: "Add Storybook visual testing for components"

    - id: "VIS-MED-002"
      signal: "Visual tests only cover single viewport"
      remediation: "Add responsive testing at multiple viewports"

  low:
    - id: "VIS-LOW-001"
      signal: "Visual test baselines outdated"

  positive:
    - id: "VIS-POS-001"
      signal: "Comprehensive visual test coverage"
    - id: "VIS-POS-002"
      signal: "Visual tests integrated in PR workflow"

# ============================================================
# SECTION 9: EXECUTION PROCEDURE
# ============================================================

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory visual test coverage"
      description: |
        Identify all visual tests and the pages/components
        they cover.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find visual test files"
          command: "find . -name '*visual*' -name '*.test.*' -o -path '*/__image_snapshots__/*' 2>/dev/null | head -20"
        - purpose: "Find Storybook stories"
          command: "find . -name '*.stories.*' 2>/dev/null | wc -l"
      expected_findings:
        - "Visual test count"
        - "Coverage scope"

    - id: "2"
      name: "Check for visual testing service"
      description: |
        Determine if a visual testing service like Percy
        or Chromatic is configured.
      duration_estimate: "15 min"
      commands:
        - purpose: "Check for Percy config"
          command: "cat .percy.yml 2>/dev/null || grep -rn 'percy' package.json 2>/dev/null"
        - purpose: "Check for Chromatic config"
          command: "grep -rn 'chromatic' package.json .github/workflows/ 2>/dev/null"
      expected_findings:
        - "Visual service configuration"
        - "Integration status"

    - id: "3"
      name: "Review viewport coverage"
      description: |
        Check if visual tests cover multiple viewports
        for responsive testing.
      duration_estimate: "15 min"
      expected_findings:
        - "Viewport configurations"
        - "Responsive coverage"

    - id: "4"
      name: "Run visual tests"
      description: |
        Execute visual tests to verify they work and
        baselines are current.
      duration_estimate: "25 min"
      commands:
        - purpose: "Run visual tests"
          command: "npm run test:visual 2>&1 | tail -30"
      expected_findings:
        - "Test results"
        - "Diff detection"

    - id: "5"
      name: "Verify CI integration"
      description: |
        Check that visual tests are part of the CI/CD
        pipeline.
      duration_estimate: "15 min"
      commands:
        - purpose: "Check CI for visual testing"
          command: "grep -rn 'percy\\|chromatic\\|visual\\|screenshot' .github/workflows/ 2>/dev/null"
      expected_findings:
        - "CI visual testing configuration"
        - "PR blocking behavior"

# ============================================================
# SECTION 10: OUTPUT SPECIFICATION
# ============================================================

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Visual Test Coverage"
        - "Service Configuration"
        - "Recommendations"

    - type: "metrics"
      format: "table"
      fields:
        - "visual_test_count"
        - "pages_covered"
        - "components_covered"
        - "viewport_configurations"

  confidence_guidance:
    high: "Visual tests executed and verified"
    medium: "Test presence confirmed"
    low: "Estimated from configuration"

# ============================================================
# SECTION 11: OFFLINE SUPPORT
# ============================================================

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "storybook-visual"
        priority: "recommended"

# ============================================================
# SECTION 12: PROFILES
# ============================================================

profiles:
  membership:
    quick:
      included: false
      reason: "Visual testing requires running application"
    full:
      included: true
      priority: 2

# ============================================================
# SECTION 13: DETERMINISTIC VERIFICATION
# ============================================================

closeout_checklist:
  - id: "visual-regression-001"
    item: "Visual tests exist"
    level: "BLOCKING"
    verification: "find . -name '*visual*' -name '*.test.*' 2>/dev/null | head -1 | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "visual-regression-002"
    item: "Critical pages have visual coverage"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Verify key pages have visual tests"
    expected: "Confirmed by reviewer"

  - id: "visual-regression-003"
    item: "Visual tests in CI"
    level: "WARNING"
    verification: "grep -rq 'percy\\|chromatic\\|visual' .github/workflows/ && echo PASS || echo FAIL"
    expected: "PASS"

# ============================================================
# SECTION 14: GOVERNANCE
# ============================================================

governance:
  applicable_to:
    archetypes: ["web-applications", "mobile-applications"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Usability", "Testability"]

# ============================================================
# SECTION 15: RELATIONSHIPS
# ============================================================

relationships:
  commonly_combined:
    - "code-quality.testing.e2e-test-coverage"
    - "code-quality.testing.accessibility-testing"
