# ============================================================
# AUDIT FILE - Mock vs Real Dependency v1.0
# ============================================================

# ============================================================
# SECTION 1: IDENTITY & METADATA
# ============================================================

audit:
  id: "code-quality.testing.mock-vs-real-dependency"

  name: "Mock vs Real Dependency"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "testing"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: false
  destructive: false

# ============================================================
# SECTION 2: EXECUTION CLASSIFICATION
# ============================================================

execution:
  automatable: "partial"

  severity: "medium"

  scope: "testing"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

# ============================================================
# SECTION 3: DESCRIPTION & RATIONALE
# ============================================================

description:
  what: |
    Evaluates the balance between mocked and real dependencies in tests.
    Assesses mock quality, stub accuracy, test double fidelity, and
    whether mocking strategy provides appropriate confidence vs speed
    tradeoffs.

  why_it_matters: |
    Over-mocking leads to tests that pass but don't reflect reality.
    Under-mocking creates slow, brittle tests with external dependencies.
    The right balance ensures tests are fast, reliable, and actually
    verify system behavior.

  when_to_run:
    - "When tests pass but production fails"
    - "After test reliability issues"
    - "When test speed is problematic"
    - "Periodic test strategy review"

# ============================================================
# SECTION 4: PREREQUISITES
# ============================================================

prerequisites:
  required_artifacts:
    - type: "test_suite"
      description: "Complete test suite"

  access_requirements:
    - "Read access to test code"
    - "Understanding of system dependencies"

# ============================================================
# SECTION 5: DISCOVERY SPECIFICATION
# ============================================================

discovery:
  code_patterns:
    - pattern: "jest\\.mock|mock\\(|@patch|MagicMock"
      type: "regex"
      scope: "source"
      purpose: "Mock declarations"
    - pattern: "mockResolvedValue|mockReturnValue|return_value"
      type: "regex"
      scope: "source"
      purpose: "Mock implementations"
    - pattern: "spyOn|spy\\(|create_autospec"
      type: "regex"
      scope: "source"
      purpose: "Spy usage"

# ============================================================
# SECTION 6: EXTERNAL KNOWLEDGE SOURCES
# ============================================================

knowledge_sources:
  guides:
    - id: "jest-mocks"
      name: "Jest Mock Functions"
      url: "https://jestjs.io/docs/mock-functions"
      offline_cache: true
    - id: "mocking-python"
      name: "Python unittest.mock"
      url: "https://docs.python.org/3/library/unittest.mock.html"
      offline_cache: true

    - id: "xunit-patterns"
      name: "xUnit Test Patterns: Refactoring Test Code"
      url: "https://www.amazon.com/xUnit-Test-Patterns-Refactoring-Code/dp/0131495054"
      offline_cache: false

    - id: "working-effectively-legacy"
      name: "Working Effectively with Legacy Code"
      url: "https://www.oreilly.com/library/view/working-effectively-with/0131177052/"
      offline_cache: false

  learning_resources:
    - id: "mocking-book"
      title: "Mocking in Software Testing"
      type: "article"
      reference: "Martin Fowler - Mocks Aren't Stubs"

# ============================================================
# SECTION 7: TOOLING & AUTOMATION
# ============================================================

tooling:
  static_analysis:
    - tool: "jest"
      purpose: "JavaScript mocking framework"
      offline_capable: true
    - tool: "unittest.mock"
      purpose: "Python mocking"
      offline_capable: true
    - tool: "sinon"
      purpose: "JavaScript test doubles"
      offline_capable: true
    - tool: "mockito"
      purpose: "Java mocking framework"
      offline_capable: true

  scripts:
    - id: "mock-inventory"
      language: "bash"
      purpose: "Count mock usage in tests"
      source: "inline"
      code: |
        #!/bin/bash
        echo "Jest mocks:"
        grep -rn 'jest.mock\|mockResolvedValue\|mockReturnValue' . --include='*.test.*' 2>/dev/null | wc -l
        echo "Python mocks:"
        grep -rn '@patch\|MagicMock\|create_autospec' . --include='test_*.py' 2>/dev/null | wc -l

# ============================================================
# SECTION 8: SIGNALS & FINDINGS TAXONOMY
# ============================================================

signals:
  critical:
    - id: "MOCK-CRIT-001"
      signal: "Mocks return different behavior than real dependencies"
      evidence_pattern: "Mock returns success but real dependency fails"
      explanation: |
        Inaccurate mocks create false confidence. Tests pass but
        production breaks because mocks don't reflect reality.
      remediation: "Verify mock behavior matches real dependency contracts"

  high:
    - id: "MOCK-HIGH-001"
      signal: "Critical business logic fully mocked out"
      evidence_pattern: "Core business services mocked in all tests"
      explanation: |
        Mocking critical logic means it's never actually tested,
        creating blind spots in test coverage.
      remediation: "Test critical business logic with real implementations"

    - id: "MOCK-HIGH-002"
      signal: "Mocks not updated when dependency behavior changes"
      evidence_pattern: "Stale mock implementations"
      explanation: |
        Stale mocks diverge from actual behavior, causing tests
        to lose accuracy over time.
      remediation: "Use contract testing; update mocks with dependency changes"

  medium:
    - id: "MOCK-MED-001"
      signal: "Over-mocking leads to testing mock behavior"
      remediation: "Reduce mocks to only external dependencies"

    - id: "MOCK-MED-002"
      signal: "No integration tests to verify mock accuracy"
      remediation: "Add integration tests that use real dependencies"

  low:
    - id: "MOCK-LOW-001"
      signal: "Mock setup code exceeds test assertion code"

  positive:
    - id: "MOCK-POS-001"
      signal: "Appropriate balance of mocks and real dependencies"
    - id: "MOCK-POS-002"
      signal: "Contract tests verify mock fidelity"

# ============================================================
# SECTION 9: EXECUTION PROCEDURE
# ============================================================

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory mock usage"
      description: |
        Identify all mocked dependencies across the test suite.
      duration_estimate: "25 min"
      commands:
        - purpose: "Count Jest mocks"
          command: "grep -rn 'jest.mock\\|jest.fn' . --include='*.test.*' 2>/dev/null | head -30"
        - purpose: "Count Python mocks"
          command: "grep -rn '@patch\\|MagicMock' . --include='test_*.py' 2>/dev/null | head -30"
      expected_findings:
        - "Mocked dependency list"
        - "Mock frequency"

    - id: "2"
      name: "Categorize mocked dependencies"
      description: |
        Classify mocks by type: external services, databases,
        internal modules, etc.
      duration_estimate: "20 min"
      expected_findings:
        - "Mock categories"
        - "Internal vs external mock ratio"

    - id: "3"
      name: "Evaluate mock fidelity"
      description: |
        Review mock implementations to assess whether they
        accurately represent real behavior.
      duration_estimate: "30 min"
      expected_findings:
        - "Mock accuracy assessment"
        - "Stale mock identification"

    - id: "4"
      name: "Check for over-mocking"
      description: |
        Identify tests that mock so much that they only test
        mock wiring.
      duration_estimate: "20 min"
      expected_findings:
        - "Over-mocked tests"
        - "Tests without real behavior"

    - id: "5"
      name: "Verify mock/integration test balance"
      description: |
        Ensure there are integration tests to validate
        mock assumptions.
      duration_estimate: "15 min"
      expected_findings:
        - "Integration test coverage"
        - "Mock verification coverage"

# ============================================================
# SECTION 10: OUTPUT SPECIFICATION
# ============================================================

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Mock Inventory"
        - "Fidelity Analysis"
        - "Recommendations"

    - type: "metrics"
      format: "table"
      fields:
        - "total_mock_count"
        - "external_service_mocks"
        - "internal_module_mocks"
        - "integration_test_coverage"

  confidence_guidance:
    high: "Comprehensive mock analysis with fidelity verification"
    medium: "Mock inventory complete, partial fidelity check"
    low: "Estimated from code patterns"

# ============================================================
# SECTION 11: OFFLINE SUPPORT
# ============================================================

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "jest-mocks"
        priority: "recommended"

# ============================================================
# SECTION 12: PROFILES
# ============================================================

profiles:
  membership:
    quick:
      included: false
      reason: "Detailed mock analysis required"
    full:
      included: true
      priority: 2

# ============================================================
# SECTION 13: DETERMINISTIC VERIFICATION
# ============================================================

closeout_checklist:
  - id: "mock-vs-real-001"
    item: "Mock inventory documented"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Document all mocked dependencies"
    expected: "Confirmed by reviewer"

  - id: "mock-vs-real-002"
    item: "Critical business logic not fully mocked"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Verify core logic has real tests"
    expected: "Confirmed by reviewer"

  - id: "mock-vs-real-003"
    item: "Integration tests verify mock behavior"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Check for integration test coverage"
    expected: "Confirmed by reviewer"

# ============================================================
# SECTION 14: GOVERNANCE
# ============================================================

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Testability"]

# ============================================================
# SECTION 15: RELATIONSHIPS
# ============================================================

relationships:
  commonly_combined:
    - "code-quality.testing.contract-testing"
    - "code-quality.testing.integration-test-coverage"
