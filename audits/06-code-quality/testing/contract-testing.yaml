# ============================================================
# AUDIT FILE - Contract Testing v1.0
# ============================================================

# ============================================================
# SECTION 1: IDENTITY & METADATA
# ============================================================

audit:
  id: "code-quality.testing.contract-testing"

  name: "Contract Testing"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "testing"

  tier: "phd"
  estimated_duration: "3-5 hours"  # median: 4h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

# ============================================================
# SECTION 2: EXECUTION CLASSIFICATION
# ============================================================

execution:
  automatable: "partial"

  severity: "high"

  scope: "testing"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

# ============================================================
# SECTION 3: DESCRIPTION & RATIONALE
# ============================================================

description:
  what: |
    Evaluates contract testing practices between services, including
    consumer-driven contracts, provider verification, schema validation,
    and API compatibility testing. Assesses whether service boundaries
    are properly tested for compatibility.

  why_it_matters: |
    In distributed systems, integration failures are common and costly.
    Contract testing catches breaking changes before deployment by
    verifying that providers meet consumer expectations. Without it,
    teams discover incompatibilities in production.

  when_to_run:
    - "Before deploying service changes"
    - "When adding new service integrations"
    - "After API schema changes"
    - "Periodic integration health check"

# ============================================================
# SECTION 4: PREREQUISITES
# ============================================================

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Service source code"
    - type: "api_specs"
      description: "API specifications or contracts"
    - type: "test_suite"
      description: "Contract test suite"

  access_requirements:
    - "Access to consumer and provider code"
    - "Contract broker or registry access (if used)"
    - "API documentation"

# ============================================================
# SECTION 5: DISCOVERY SPECIFICATION
# ============================================================

discovery:
  file_patterns:
    - glob: "**/*.pact.json"
      purpose: "Pact contract files"
    - glob: "**/pacts/**"
      purpose: "Pact contract directory"
    - glob: "**/contracts/**"
      purpose: "Generic contract directory"
    - glob: "**/*.contract.test.*"
      purpose: "Contract test files"
    - glob: "**/openapi*.yaml"
      purpose: "OpenAPI specifications"
    - glob: "**/swagger*.yaml"
      purpose: "Swagger specifications"

  code_patterns:
    - pattern: "Pact|pact|@PactVerify"
      type: "regex"
      scope: "source"
      purpose: "Pact framework usage"
    - pattern: "contract|Contract"
      type: "keyword"
      scope: "source"
      purpose: "Contract testing patterns"

# ============================================================
# SECTION 6: EXTERNAL KNOWLEDGE SOURCES
# ============================================================

knowledge_sources:
  guides:
    - id: "pact-docs"
      name: "Pact Documentation"
      url: "https://docs.pact.io/"
      offline_cache: true
    - id: "contract-testing"
      name: "Contract Testing - Martin Fowler"
      url: "https://martinfowler.com/bliki/ContractTest.html"
      offline_cache: true

    - id: "xunit-patterns"
      name: "xUnit Test Patterns: Refactoring Test Code"
      url: "https://www.amazon.com/xUnit-Test-Patterns-Refactoring-Code/dp/0131495054"
      offline_cache: false

    - id: "working-effectively-legacy"
      name: "Working Effectively with Legacy Code"
      url: "https://www.oreilly.com/library/view/working-effectively-with/0131177052/"
      offline_cache: false

  learning_resources:
    - id: "microservices-patterns"
      title: "Microservices Patterns"
      type: "book"
      reference: "Chris Richardson, ISBN 978-1617294549"

# ============================================================
# SECTION 7: TOOLING & AUTOMATION
# ============================================================

tooling:
  static_analysis:
    - tool: "Pact"
      purpose: "Consumer-driven contract testing"
      offline_capable: true
    - tool: "Spring Cloud Contract"
      purpose: "Java contract testing"
      offline_capable: true
    - tool: "Dredd"
      purpose: "API blueprint testing"
      offline_capable: true
    - tool: "Prism"
      purpose: "OpenAPI mock and validation"
      offline_capable: true

  scripts:
    - id: "contract-test-run"
      language: "bash"
      purpose: "Run contract tests"
      source: "inline"
      code: |
        #!/bin/bash
        npx pact-broker can-i-deploy --pacticipant Consumer --version $VERSION 2>/dev/null

# ============================================================
# SECTION 8: SIGNALS & FINDINGS TAXONOMY
# ============================================================

signals:
  critical:
    - id: "CONTRACT-CRIT-001"
      signal: "No contract tests for critical service integrations"
      evidence_pattern: "Service calls without contract verification"
      explanation: |
        Without contracts, breaking changes in dependencies are
        discovered in production rather than during testing.
      remediation: "Implement consumer-driven contracts for critical integrations"

  high:
    - id: "CONTRACT-HIGH-001"
      signal: "Contracts not verified on provider side"
      evidence_pattern: "Consumer contracts without provider verification"
      explanation: |
        Unverified contracts may not reflect actual provider
        behavior, creating false confidence.
      remediation: "Add provider verification tests for all contracts"

    - id: "CONTRACT-HIGH-002"
      signal: "API schema changes without contract updates"
      evidence_pattern: "OpenAPI changes not reflected in contracts"
      explanation: |
        Schema and contract drift leads to integration failures.
      remediation: "Keep contracts synchronized with API schemas"

  medium:
    - id: "CONTRACT-MED-001"
      signal: "Contracts not stored in broker"
      remediation: "Publish contracts to central broker for visibility"

    - id: "CONTRACT-MED-002"
      signal: "No can-i-deploy checks in CI"
      remediation: "Add can-i-deploy verification before deployment"

  low:
    - id: "CONTRACT-LOW-001"
      signal: "Contract test coverage could be broader"

  positive:
    - id: "CONTRACT-POS-001"
      signal: "Consumer-driven contracts in place"
    - id: "CONTRACT-POS-002"
      signal: "Can-i-deploy verification in CI"

# ============================================================
# SECTION 9: EXECUTION PROCEDURE
# ============================================================

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify service boundaries"
      description: |
        Map all service-to-service integrations that require
        contract testing.
      duration_estimate: "30 min"
      expected_findings:
        - "Service dependency map"
        - "Integration points"

    - id: "2"
      name: "Inventory existing contracts"
      description: |
        Find all contract definitions and contract tests.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find Pact files"
          command: "find . -name '*.pact.json' -o -path '*/pacts/*' 2>/dev/null | head -20"
        - purpose: "Find OpenAPI specs"
          command: "find . -name 'openapi*.yaml' -o -name 'swagger*.yaml' 2>/dev/null"
      expected_findings:
        - "Contract file locations"
        - "Coverage assessment"

    - id: "3"
      name: "Verify provider tests"
      description: |
        Check that providers verify consumer contracts.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find provider verification tests"
          command: "grep -rn 'verifyProvider\\|PactVerify\\|provider.*test' . --include='*.test.*' --include='*.spec.*' 2>/dev/null | head -20"
      expected_findings:
        - "Provider verification status"
        - "Missing verifications"

    - id: "4"
      name: "Check CI integration"
      description: |
        Verify contract tests run in CI and deployment
        is gated on verification.
      duration_estimate: "20 min"
      commands:
        - purpose: "Check for contract testing in CI"
          command: "grep -rn 'pact\\|contract\\|can-i-deploy' .github/workflows/ 2>/dev/null"
      expected_findings:
        - "CI contract configuration"
        - "Deployment gating"

    - id: "5"
      name: "Assess contract broker usage"
      description: |
        Check if contracts are published to a broker for
        visibility and verification.
      duration_estimate: "15 min"
      expected_findings:
        - "Broker configuration"
        - "Contract versioning"

# ============================================================
# SECTION 10: OUTPUT SPECIFICATION
# ============================================================

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Service Integration Map"
        - "Contract Coverage"
        - "Recommendations"

    - type: "metrics"
      format: "table"
      fields:
        - "service_integrations"
        - "contracts_defined"
        - "contracts_verified"
        - "coverage_percentage"

  confidence_guidance:
    high: "Comprehensive contract analysis with verification"
    medium: "Contracts identified, partial verification"
    low: "Estimated from code patterns"

# ============================================================
# SECTION 11: OFFLINE SUPPORT
# ============================================================

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "pact-docs"
        priority: "required"
      - source_id: "contract-testing"
        priority: "required"

# ============================================================
# SECTION 12: PROFILES
# ============================================================

profiles:
  membership:
    quick:
      included: false
      reason: "Contract testing analysis is detailed"
    full:
      included: true
      priority: 2

# ============================================================
# SECTION 13: DETERMINISTIC VERIFICATION
# ============================================================

closeout_checklist:
  - id: "contract-testing-001"
    item: "Critical integrations have contracts"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Verify contracts exist for critical service calls"
    expected: "Confirmed by reviewer"

  - id: "contract-testing-002"
    item: "Provider verification tests pass"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Run provider verification tests"
    expected: "Confirmed by reviewer"

  - id: "contract-testing-003"
    item: "Contract tests in CI pipeline"
    level: "WARNING"
    verification: "grep -rq 'pact\\|contract' .github/workflows/ && echo PASS || echo FAIL"
    expected: "PASS"

# ============================================================
# SECTION 14: GOVERNANCE
# ============================================================

governance:
  applicable_to:
    archetypes: ["microservices", "distributed-systems"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Compatibility", "Testability"]

# ============================================================
# SECTION 15: RELATIONSHIPS
# ============================================================

relationships:
  commonly_combined:
    - "code-quality.testing.integration-test-coverage"
    - "code-quality.testing.mock-vs-real-dependency"
