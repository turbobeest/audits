# ============================================================
# AUDIT FILE - Test Isolation v1.0
# ============================================================

# ============================================================
# SECTION 1: IDENTITY & METADATA
# ============================================================

audit:
  id: "code-quality.testing.test-isolation"

  name: "Test Isolation"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "testing"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: true
  destructive: false

# ============================================================
# SECTION 2: EXECUTION CLASSIFICATION
# ============================================================

execution:
  automatable: "partial"

  severity: "medium"

  scope: "testing"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

# ============================================================
# SECTION 3: DESCRIPTION & RATIONALE
# ============================================================

description:
  what: |
    Evaluates whether tests are properly isolated from each other,
    meaning each test can run independently without depending on
    other tests' execution or side effects. Checks for shared state,
    proper setup/teardown, and order independence.

  why_it_matters: |
    Poor test isolation causes flaky tests, order-dependent failures,
    and difficulty debugging. Isolated tests can run in parallel,
    be executed individually, and provide reliable results regardless
    of test suite composition.

  when_to_run:
    - "When flaky tests are detected"
    - "Before enabling parallel test execution"
    - "After test infrastructure changes"
    - "Periodic test health assessment"

# ============================================================
# SECTION 4: PREREQUISITES
# ============================================================

prerequisites:
  required_artifacts:
    - type: "test_suite"
      description: "Complete test suite"

  access_requirements:
    - "Ability to run tests in various orders"
    - "Ability to run individual tests"

# ============================================================
# SECTION 5: DISCOVERY SPECIFICATION
# ============================================================

discovery:
  code_patterns:
    - pattern: "beforeAll|afterAll|beforeEach|afterEach"
      type: "regex"
      scope: "source"
      purpose: "Test lifecycle hooks"
    - pattern: "global\\.|window\\.|process\\.env"
      type: "regex"
      scope: "source"
      purpose: "Global state access in tests"
    - pattern: "let\\s+\\w+;.*describe|var\\s+\\w+;.*describe"
      type: "regex"
      scope: "source"
      purpose: "Shared variables in test files"

# ============================================================
# SECTION 6: EXTERNAL KNOWLEDGE SOURCES
# ============================================================

knowledge_sources:
  guides:
    - id: "test-isolation"
      name: "Jest - Setup and Teardown"
      url: "https://jestjs.io/docs/setup-teardown"
      offline_cache: true

    - id: "xunit-patterns"
      name: "xUnit Test Patterns: Refactoring Test Code"
      url: "https://www.amazon.com/xUnit-Test-Patterns-Refactoring-Code/dp/0131495054"
      offline_cache: false

    - id: "working-effectively-legacy"
      name: "Working Effectively with Legacy Code"
      url: "https://www.oreilly.com/library/view/working-effectively-with/0131177052/"
      offline_cache: false

  learning_resources:
    - id: "xunit-patterns"
      title: "xUnit Test Patterns"
      type: "book"
      reference: "Gerard Meszaros, ISBN 978-0131495050"

# ============================================================
# SECTION 7: TOOLING & AUTOMATION
# ============================================================

tooling:
  static_analysis:
    - tool: "jest --runInBand"
      purpose: "Run tests serially to verify isolation"
      offline_capable: true
    - tool: "jest --randomize"
      purpose: "Run tests in random order"
      offline_capable: true
    - tool: "pytest-randomly"
      purpose: "Python random test order"
      offline_capable: true

  scripts:
    - id: "isolation-check"
      language: "bash"
      purpose: "Run tests in random order"
      source: "inline"
      code: |
        #!/bin/bash
        npx jest --randomize 2>&1 | tail -20

# ============================================================
# SECTION 8: SIGNALS & FINDINGS TAXONOMY
# ============================================================

signals:
  critical:
    - id: "ISOL-CRIT-001"
      signal: "Tests fail when run individually"
      evidence_pattern: "Tests pass in suite but fail solo"
      explanation: |
        Tests depending on other tests to set up state are
        fragile and indicate fundamental isolation problems.
      remediation: "Ensure each test sets up its own required state"

  high:
    - id: "ISOL-HIGH-001"
      signal: "Tests fail when order changes"
      evidence_pattern: "Random order execution causes failures"
      explanation: |
        Order-dependent tests indicate shared state pollution
        between test cases.
      remediation: "Add proper setup/teardown; eliminate shared state"

    - id: "ISOL-HIGH-002"
      signal: "Tests modify global state without cleanup"
      evidence_pattern: "Global variables modified without restoration"
      explanation: |
        Global state modifications leak between tests causing
        unpredictable behavior.
      remediation: "Save and restore global state in beforeEach/afterEach"

  medium:
    - id: "ISOL-MED-001"
      signal: "Database not reset between tests"
      remediation: "Use transactions or fresh database per test"

    - id: "ISOL-MED-002"
      signal: "Shared mocks between test cases"
      remediation: "Reset mocks in beforeEach"

  low:
    - id: "ISOL-LOW-001"
      signal: "Heavy beforeAll setup could be beforeEach"

  positive:
    - id: "ISOL-POS-001"
      signal: "Tests pass in any order"
    - id: "ISOL-POS-002"
      signal: "Tests pass when run individually"

# ============================================================
# SECTION 9: EXECUTION PROCEDURE
# ============================================================

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Run tests in random order"
      description: |
        Execute test suite with randomized order to detect
        order dependencies.
      duration_estimate: "20 min"
      commands:
        - purpose: "Run Jest with random order"
          command: "npx jest --randomize 2>&1 | tail -30"
      expected_findings:
        - "Pass/fail results with random order"
        - "Order-dependent failures"

    - id: "2"
      name: "Run tests individually"
      description: |
        Execute selected tests in isolation to verify they
        don't depend on other tests.
      duration_estimate: "25 min"
      commands:
        - purpose: "Run single test file"
          command: "npx jest --testPathPattern='sample.test' 2>&1 | tail -20"
      expected_findings:
        - "Individual test results"
        - "Setup-dependent failures"

    - id: "3"
      name: "Analyze shared state patterns"
      description: |
        Review test code for shared state, global modifications,
        and inadequate cleanup.
      duration_estimate: "30 min"
      commands:
        - purpose: "Find global state usage"
          command: "grep -rn 'global\\.|process\\.env\\[' . --include='*.test.*' --include='*.spec.*' 2>/dev/null | head -20"
      expected_findings:
        - "Shared state patterns"
        - "Global modifications"

    - id: "4"
      name: "Review setup/teardown"
      description: |
        Examine beforeEach/afterEach hooks for proper state
        management.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find lifecycle hooks"
          command: "grep -rn 'beforeEach\\|afterEach\\|beforeAll\\|afterAll' . --include='*.test.*' 2>/dev/null | head -30"
      expected_findings:
        - "Lifecycle hook usage"
        - "Missing cleanup"

    - id: "5"
      name: "Check mock isolation"
      description: |
        Verify mocks are properly reset between tests.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find mock resets"
          command: "grep -rn 'mockReset\\|mockClear\\|jest\\.clearAllMocks' . --include='*.test.*' 2>/dev/null | head -20"
      expected_findings:
        - "Mock reset patterns"
        - "Missing mock cleanup"

# ============================================================
# SECTION 10: OUTPUT SPECIFICATION
# ============================================================

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Isolation Issues"
        - "Shared State Analysis"
        - "Recommendations"

    - type: "metrics"
      format: "table"
      fields:
        - "tests_passing_random_order"
        - "tests_passing_individually"
        - "shared_state_instances"
        - "missing_cleanup_count"

  confidence_guidance:
    high: "Tests run in multiple orders and individually"
    medium: "Partial order testing performed"
    low: "Code analysis only"

# ============================================================
# SECTION 11: OFFLINE SUPPORT
# ============================================================

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "test-isolation"
        priority: "recommended"

# ============================================================
# SECTION 12: PROFILES
# ============================================================

profiles:
  membership:
    quick:
      included: false
      reason: "Isolation testing requires multiple test runs"
    full:
      included: true
      priority: 2

# ============================================================
# SECTION 13: DETERMINISTIC VERIFICATION
# ============================================================

closeout_checklist:
  - id: "test-isolation-001"
    item: "Tests pass in random order"
    level: "BLOCKING"
    verification: "npx jest --randomize 2>&1 | grep -q 'failed' && echo FAIL || echo PASS"
    expected: "PASS"

  - id: "test-isolation-002"
    item: "Mock cleanup in place"
    level: "WARNING"
    verification: "grep -rq 'clearAllMocks\\|mockReset\\|mockClear' . --include='*.test.*' && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "test-isolation-003"
    item: "No global state leakage"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Review tests for proper state isolation"
    expected: "Confirmed by reviewer"

# ============================================================
# SECTION 14: GOVERNANCE
# ============================================================

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Testability"]

# ============================================================
# SECTION 15: RELATIONSHIPS
# ============================================================

relationships:
  commonly_combined:
    - "code-quality.testing.flaky-test"
    - "code-quality.testing.test-execution-time"
