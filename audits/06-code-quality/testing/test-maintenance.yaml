# ============================================================
# AUDIT FILE - Test Maintenance v1.0
# ============================================================

# ============================================================
# SECTION 1: IDENTITY & METADATA
# ============================================================

audit:
  id: "code-quality.testing.test-maintenance"

  name: "Test Maintenance"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "testing"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

# ============================================================
# SECTION 2: EXECUTION CLASSIFICATION
# ============================================================

execution:
  automatable: "partial"

  severity: "medium"

  scope: "testing"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

# ============================================================
# SECTION 3: DESCRIPTION & RATIONALE
# ============================================================

description:
  what: |
    Evaluates test suite maintainability including test code quality,
    duplication, organization, naming conventions, documentation, and
    technical debt. Assesses whether tests are easy to understand,
    modify, and extend.

  why_it_matters: |
    Poorly maintained tests become a burden rather than an asset.
    Unclear tests, excessive duplication, and poor organization slow
    development, reduce confidence in test results, and lead to
    tests being deleted rather than fixed.

  when_to_run:
    - "When tests become hard to modify"
    - "After test suite grows significantly"
    - "When onboarding new team members"
    - "Periodic test health assessment"

# ============================================================
# SECTION 4: PREREQUISITES
# ============================================================

prerequisites:
  required_artifacts:
    - type: "test_suite"
      description: "Complete test suite"

  access_requirements:
    - "Read access to test code"

# ============================================================
# SECTION 5: DISCOVERY SPECIFICATION
# ============================================================

discovery:
  file_patterns:
    - glob: "**/*.test.*"
      purpose: "Test files"
    - glob: "**/*.spec.*"
      purpose: "Spec files"
    - glob: "**/test_*.py"
      purpose: "Python test files"
    - glob: "**/*_test.go"
      purpose: "Go test files"

  code_patterns:
    - pattern: "it\\.skip|describe\\.skip|@pytest\\.mark\\.skip"
      type: "regex"
      scope: "source"
      purpose: "Skipped tests"
    - pattern: "TODO|FIXME|XXX"
      type: "keyword"
      scope: "source"
      purpose: "Technical debt markers in tests"

# ============================================================
# SECTION 6: EXTERNAL KNOWLEDGE SOURCES
# ============================================================

knowledge_sources:
  guides:
    - id: "xunit-patterns"
      name: "xUnit Test Patterns: Refactoring Test Code"
      url: "https://www.amazon.com/xUnit-Test-Patterns-Refactoring-Code/dp/0131495054"
      offline_cache: false

    - id: "working-effectively-legacy"
      name: "Working Effectively with Legacy Code"
      url: "https://www.oreilly.com/library/view/working-effectively-with/0131177052/"
      offline_cache: false

  learning_resources:
    - id: "clean-tests"
      title: "Clean Code - Chapter 9: Unit Tests"
      type: "book"
      reference: "Robert C. Martin"
    - id: "xunit-patterns-book"
      title: "xUnit Test Patterns"
      type: "book"
      reference: "Gerard Meszaros, ISBN 978-0131495050"

# ============================================================
# SECTION 7: TOOLING & AUTOMATION
# ============================================================

tooling:
  static_analysis:
    - tool: "eslint"
      purpose: "Test code linting"
      offline_capable: true
    - tool: "jscpd"
      purpose: "Duplicate code detection in tests"
      offline_capable: true

  scripts:
    - id: "test-maintenance-check"
      language: "bash"
      purpose: "Analyze test maintenance metrics"
      source: "inline"
      code: |
        #!/bin/bash
        echo "Skipped tests:"
        grep -rn 'skip\|Skip' . --include='*.test.*' --include='test_*.py' 2>/dev/null | wc -l
        echo "TODO in tests:"
        grep -rn 'TODO\|FIXME' . --include='*.test.*' --include='test_*.py' 2>/dev/null | wc -l

# ============================================================
# SECTION 8: SIGNALS & FINDINGS TAXONOMY
# ============================================================

signals:
  critical:
    - id: "TMAINT-CRIT-001"
      signal: "Large number of skipped/disabled tests"
      evidence_pattern: ">10% of tests skipped"
      explanation: |
        Skipped tests indicate broken or unmaintained tests that
        have become liabilities rather than assets.
      remediation: "Fix or remove skipped tests; track skip reasons"

  high:
    - id: "TMAINT-HIGH-001"
      signal: "Significant test code duplication"
      evidence_pattern: ">20% duplication in test code"
      explanation: |
        Duplicated test code multiplies maintenance burden and
        creates inconsistency risks.
      remediation: "Extract shared test utilities and fixtures"

    - id: "TMAINT-HIGH-002"
      signal: "Tests lack descriptive names"
      evidence_pattern: "Generic test names like test1, test2"
      explanation: |
        Poor test names make failures hard to diagnose and
        tests hard to understand.
      remediation: "Use descriptive names that explain expected behavior"

  medium:
    - id: "TMAINT-MED-001"
      signal: "Test files exceed 500 lines"
      remediation: "Split large test files by feature or concern"

    - id: "TMAINT-MED-002"
      signal: "Test code not linted"
      remediation: "Apply same linting standards to test code"

  low:
    - id: "TMAINT-LOW-001"
      signal: "Inconsistent test organization"

  positive:
    - id: "TMAINT-POS-001"
      signal: "Well-organized test suite with clear naming"
    - id: "TMAINT-POS-002"
      signal: "No skipped tests"

# ============================================================
# SECTION 9: EXECUTION PROCEDURE
# ============================================================

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Count skipped tests"
      description: |
        Identify all skipped, disabled, or pending tests.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find skipped Jest tests"
          command: "grep -rn '\\.skip\\|xit\\|xdescribe' . --include='*.test.*' 2>/dev/null | head -30"
        - purpose: "Find skipped pytest tests"
          command: "grep -rn '@pytest.mark.skip\\|@unittest.skip' . --include='test_*.py' 2>/dev/null | head -20"
      expected_findings:
        - "Skipped test count"
        - "Skip reasons"

    - id: "2"
      name: "Analyze test code duplication"
      description: |
        Check for duplicated code patterns in tests.
      duration_estimate: "20 min"
      commands:
        - purpose: "Run duplication detection"
          command: "npx jscpd . --pattern '**/*.test.*' --min-lines 5 --reporters console 2>/dev/null | head -50"
      expected_findings:
        - "Duplication percentage"
        - "Common duplicated patterns"

    - id: "3"
      name: "Review test naming"
      description: |
        Analyze test names for clarity and consistency.
      duration_estimate: "20 min"
      commands:
        - purpose: "Sample test names"
          command: "grep -rhn 'it(\\|test(\\|def test_' . --include='*.test.*' --include='test_*.py' 2>/dev/null | head -30"
      expected_findings:
        - "Naming patterns"
        - "Clarity assessment"

    - id: "4"
      name: "Check test file sizes"
      description: |
        Identify overly large test files that may need splitting.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find large test files"
          command: "wc -l **/*.test.* 2>/dev/null | sort -rn | head -20"
      expected_findings:
        - "Largest test files"
        - "Files needing split"

    - id: "5"
      name: "Review technical debt markers"
      description: |
        Find TODO, FIXME, and other debt markers in test code.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find TODO markers"
          command: "grep -rn 'TODO\\|FIXME\\|XXX\\|HACK' . --include='*.test.*' 2>/dev/null | head -20"
      expected_findings:
        - "Debt marker count"
        - "Common issues"

# ============================================================
# SECTION 10: OUTPUT SPECIFICATION
# ============================================================

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Test Health Metrics"
        - "Maintenance Issues"
        - "Recommendations"

    - type: "metrics"
      format: "table"
      fields:
        - "total_tests"
        - "skipped_tests"
        - "duplication_percentage"
        - "largest_test_file_lines"

  confidence_guidance:
    high: "Comprehensive analysis of test code"
    medium: "Metrics collected, partial review"
    low: "Estimated from sampling"

# ============================================================
# SECTION 11: OFFLINE SUPPORT
# ============================================================

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "clean-tests"
        priority: "recommended"

# ============================================================
# SECTION 12: PROFILES
# ============================================================

profiles:
  membership:
    quick:
      included: false
      reason: "Maintenance analysis requires thorough review"
    full:
      included: true
      priority: 3

# ============================================================
# SECTION 13: DETERMINISTIC VERIFICATION
# ============================================================

closeout_checklist:
  - id: "test-maintenance-001"
    item: "Skipped tests below 5%"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Calculate skip percentage from grep count"
    expected: "Confirmed by reviewer"

  - id: "test-maintenance-002"
    item: "Test duplication below 20%"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Check jscpd output for duplication percentage"
    expected: "Confirmed by reviewer"

  - id: "test-maintenance-003"
    item: "Test files under 500 lines"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Review largest test files"
    expected: "Confirmed by reviewer"

# ============================================================
# SECTION 14: GOVERNANCE
# ============================================================

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Testability"]

# ============================================================
# SECTION 15: RELATIONSHIPS
# ============================================================

relationships:
  commonly_combined:
    - "code-quality.testing.test-isolation"
    - "code-quality.testing.unit-test-coverage"
