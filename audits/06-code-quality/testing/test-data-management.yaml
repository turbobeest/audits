# ============================================================
# AUDIT FILE - Test Data Management v1.0
# ============================================================

# ============================================================
# SECTION 1: IDENTITY & METADATA
# ============================================================

audit:
  id: "code-quality.testing.test-data-management"

  name: "Test Data Management"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "testing"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: false
  destructive: false

# ============================================================
# SECTION 2: EXECUTION CLASSIFICATION
# ============================================================

execution:
  automatable: "partial"

  severity: "medium"

  scope: "testing"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

# ============================================================
# SECTION 3: DESCRIPTION & RATIONALE
# ============================================================

description:
  what: |
    Evaluates test data management practices including fixture design,
    factory patterns, data generation strategies, test database handling,
    and sensitive data protection in tests. Assesses how test data is
    created, maintained, and isolated.

  why_it_matters: |
    Poor test data management leads to brittle tests, data coupling,
    and maintenance burden. Hardcoded test data becomes stale,
    sensitive data in tests creates security risks, and shared data
    causes test interference.

  when_to_run:
    - "When tests become hard to maintain"
    - "After test data-related failures"
    - "Before scaling test infrastructure"
    - "Periodic test health assessment"

# ============================================================
# SECTION 4: PREREQUISITES
# ============================================================

prerequisites:
  required_artifacts:
    - type: "test_suite"
      description: "Complete test suite with fixtures"
    - type: "test_data"
      description: "Fixture files and factories"

  access_requirements:
    - "Read access to test code"
    - "Access to fixture definitions"

# ============================================================
# SECTION 5: DISCOVERY SPECIFICATION
# ============================================================

discovery:
  file_patterns:
    - glob: "**/fixtures/**"
      purpose: "Test fixture files"
    - glob: "**/factories/**"
      purpose: "Test factory definitions"
    - glob: "**/__fixtures__/**"
      purpose: "Jest fixture directory"
    - glob: "**/conftest.py"
      purpose: "Pytest fixture definitions"
    - glob: "**/seeds/**"
      purpose: "Database seed files"

  code_patterns:
    - pattern: "@pytest\\.fixture|fixture\\("
      type: "regex"
      scope: "source"
      purpose: "Pytest fixture decorators"
    - pattern: "factory\\.create|Factory\\."
      type: "regex"
      scope: "source"
      purpose: "Factory pattern usage"
    - pattern: "faker\\.|Faker\\("
      type: "regex"
      scope: "source"
      purpose: "Faker library for data generation"

# ============================================================
# SECTION 6: EXTERNAL KNOWLEDGE SOURCES
# ============================================================

knowledge_sources:
  guides:
    - id: "factory-bot"
      name: "Factory Bot Documentation"
      url: "https://github.com/thoughtbot/factory_bot"
      offline_cache: true
    - id: "pytest-fixtures"
      name: "Pytest Fixtures Documentation"
      url: "https://docs.pytest.org/en/latest/how-to/fixtures.html"
      offline_cache: true

    - id: "xunit-patterns"
      name: "xUnit Test Patterns: Refactoring Test Code"
      url: "https://www.amazon.com/xUnit-Test-Patterns-Refactoring-Code/dp/0131495054"
      offline_cache: false

    - id: "working-effectively-legacy"
      name: "Working Effectively with Legacy Code"
      url: "https://www.oreilly.com/library/view/working-effectively-with/0131177052/"
      offline_cache: false

  learning_resources:
    - id: "test-data-patterns"
      title: "xUnit Test Patterns - Fresh Fixture"
      type: "book"
      reference: "Gerard Meszaros"

# ============================================================
# SECTION 7: TOOLING & AUTOMATION
# ============================================================

tooling:
  static_analysis:
    - tool: "faker"
      purpose: "Generate realistic test data"
      offline_capable: true
    - tool: "factory_boy"
      purpose: "Python test factories"
      offline_capable: true
    - tool: "fishery"
      purpose: "TypeScript test factories"
      offline_capable: true

  scripts:
    - id: "fixture-inventory"
      language: "bash"
      purpose: "Find all fixture files"
      source: "inline"
      code: |
        #!/bin/bash
        find . -path '*/fixtures/*' -o -path '*/__fixtures__/*' -o -name 'conftest.py' 2>/dev/null

# ============================================================
# SECTION 8: SIGNALS & FINDINGS TAXONOMY
# ============================================================

signals:
  critical:
    - id: "TDATA-CRIT-001"
      signal: "Production data used in tests"
      evidence_pattern: "Real user emails, passwords, or PII in fixtures"
      explanation: |
        Production data in tests creates privacy violations,
        security risks, and compliance issues.
      remediation: "Replace with generated or anonymized test data"

  high:
    - id: "TDATA-HIGH-001"
      signal: "Hardcoded sensitive data in test files"
      evidence_pattern: "API keys, passwords in test fixtures"
      explanation: |
        Sensitive data in tests can leak through version control
        and CI logs.
      remediation: "Use environment variables or mock credentials"

    - id: "TDATA-HIGH-002"
      signal: "Test data tightly coupled to schema"
      evidence_pattern: "Many test failures after schema changes"
      explanation: |
        Brittle fixtures break with any schema change, creating
        high maintenance burden.
      remediation: "Use factories with minimal required attributes"

  medium:
    - id: "TDATA-MED-001"
      signal: "No factory pattern for test data"
      remediation: "Implement factories for common entities"

    - id: "TDATA-MED-002"
      signal: "Duplicate test data across files"
      remediation: "Centralize fixtures and factories"

  low:
    - id: "TDATA-LOW-001"
      signal: "Test data not self-documenting"

  positive:
    - id: "TDATA-POS-001"
      signal: "Factory pattern in use with minimal coupling"
    - id: "TDATA-POS-002"
      signal: "No sensitive data in test fixtures"

# ============================================================
# SECTION 9: EXECUTION PROCEDURE
# ============================================================

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory test data sources"
      description: |
        Identify all fixture files, factories, and test data
        sources.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find fixture directories"
          command: "find . -type d -name 'fixtures' -o -name '__fixtures__' -o -name 'factories' 2>/dev/null"
        - purpose: "Find conftest files"
          command: "find . -name 'conftest.py' 2>/dev/null"
      expected_findings:
        - "Fixture file locations"
        - "Factory definitions"

    - id: "2"
      name: "Check for sensitive data"
      description: |
        Scan test data for sensitive information that should
        not be in version control.
      duration_estimate: "25 min"
      commands:
        - purpose: "Search for email patterns in fixtures"
          command: "grep -rn '@.*\\.com' . --include='*.json' --include='*.yaml' -path '*/fixtures/*' 2>/dev/null | head -20"
        - purpose: "Search for password patterns"
          command: "grep -rn 'password.*:' . --include='*.json' --include='*.yaml' -path '*/fixtures/*' 2>/dev/null | head -20"
      expected_findings:
        - "Sensitive data in fixtures"
        - "Real email addresses"

    - id: "3"
      name: "Evaluate factory usage"
      description: |
        Review whether tests use factories for data creation
        rather than hardcoded fixtures.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find factory usage"
          command: "grep -rn 'factory\\|Factory' . --include='*.test.*' --include='*.spec.*' 2>/dev/null | head -20"
      expected_findings:
        - "Factory pattern adoption"
        - "Hardcoded data instances"

    - id: "4"
      name: "Assess data coupling"
      description: |
        Evaluate how tightly test data is coupled to schema
        and whether changes cascade failures.
      duration_estimate: "20 min"
      expected_findings:
        - "Coupling level assessment"
        - "Brittleness indicators"

    - id: "5"
      name: "Review data generation strategies"
      description: |
        Check for use of faker or similar libraries for
        dynamic data generation.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find faker usage"
          command: "grep -rn 'faker\\|Faker' . --include='*.test.*' --include='conftest.py' 2>/dev/null | head -20"
      expected_findings:
        - "Data generation patterns"
        - "Randomization usage"

# ============================================================
# SECTION 10: OUTPUT SPECIFICATION
# ============================================================

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Data Source Inventory"
        - "Security Analysis"
        - "Recommendations"

    - type: "metrics"
      format: "table"
      fields:
        - "fixture_file_count"
        - "factory_count"
        - "sensitive_data_instances"
        - "factory_adoption_percentage"

  confidence_guidance:
    high: "Comprehensive fixture analysis completed"
    medium: "Partial fixture review"
    low: "Estimated from code patterns"

# ============================================================
# SECTION 11: OFFLINE SUPPORT
# ============================================================

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "pytest-fixtures"
        priority: "recommended"

# ============================================================
# SECTION 12: PROFILES
# ============================================================

profiles:
  membership:
    quick:
      included: false
      reason: "Detailed analysis required"
    full:
      included: true
      priority: 2

# ============================================================
# SECTION 13: DETERMINISTIC VERIFICATION
# ============================================================

closeout_checklist:
  - id: "test-data-001"
    item: "No production/sensitive data in fixtures"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Review fixtures for PII, real emails, passwords"
    expected: "Confirmed by reviewer"

  - id: "test-data-002"
    item: "Factory pattern implemented"
    level: "WARNING"
    verification: "find . -type d -name 'factories' 2>/dev/null | head -1 | grep -q . && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "test-data-003"
    item: "Test data centralized"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Check for fixture/factory centralization"
    expected: "Confirmed by reviewer"

# ============================================================
# SECTION 14: GOVERNANCE
# ============================================================

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "GDPR"
      controls: ["Data Protection"]
    - framework: "ISO 25010"
      controls: ["Testability"]

# ============================================================
# SECTION 15: RELATIONSHIPS
# ============================================================

relationships:
  commonly_combined:
    - "code-quality.testing.test-isolation"
    - "code-quality.testing.mock-vs-real-dependency"
