audit:
  id: code-quality.code-review.pr-review-coverage
  name: Pull Request Review Coverage Audit
  version: 1.0.0
  last_updated: '2026-01-18'
  status: active
  category: code-quality
  category_number: 6
  subcategory: code-review
  tier: expert
  estimated_duration: 45 minutes
  completeness: complete
  requires_runtime: false
  destructive: false
execution:
  automatable: full
  severity: high
  scope: repository
  default_profiles:
  - full
  - quality
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Analyzes the percentage of code changes that receive peer review before merging.
    Measures review coverage across branches, teams, and time periods. Identifies
    patterns of unreviewed changes including emergency merges, self-approvals, and
    bypass commits that circumvent the review process.
  why_it_matters: |
    Code review is the most effective quality gate for catching defects before
    production. Studies by SmartBear and Cisco show that code review catches 60-70%
    of defects that would otherwise reach production. Microsoft research indicates
    that unreviewed code is 2.3x more likely to contain bugs. Organizations with
    less than 80% review coverage experience 40% more production incidents.
  when_to_run:
  - Weekly quality metrics reporting
  - Before release certifications
  - During process improvement initiatives
  - After team or process changes
prerequisites:
  required_artifacts:
  - type: git_history
    description: Git repository with merge commit history
  - type: pr_metadata
    description: Pull request records with review information
  access_requirements:
  - Read access to git repository
  - Access to PR/MR platform API (GitHub, GitLab, Bitbucket)
discovery:
  code_patterns:
  - pattern: 'Merge pull request #\d+'
    type: regex
    scope: git_log
    purpose: Identify merged pull requests
  - pattern: Merge branch.*without.*review
    type: regex
    scope: git_log
    purpose: Find direct merges bypassing review
  file_patterns:
  - glob: .github/CODEOWNERS
    purpose: Code ownership configuration
  - glob: .github/workflows/*review*.yml
    purpose: Review automation workflows
  - glob: CODEOWNERS
    purpose: GitLab/Bitbucket code owners
knowledge_sources:
  specifications:
  - id: google-eng-practices
    name: Google Engineering Practices - Code Review
    url: https://google.github.io/eng-practices/review/
    offline_cache: true
    priority: required
  guides:
  - id: smartbear-best-practices
    name: SmartBear Code Review Best Practices
    url: https://smartbear.com/learn/code-review/best-practices-for-peer-code-review/
    offline_cache: true
tooling:
  static_analysis:
  - tool: git
    purpose: Analyze commit and merge history
    offline_capable: true
  - tool: gh
    purpose: Query GitHub PR metadata
    offline_capable: false
  scripts:
  - id: review-coverage-calc
    language: bash
    purpose: Calculate PR review coverage percentage
    source: inline
    code: |
      # Count total merges vs reviewed merges
      TOTAL=$(git log --oneline --merges --since="30 days ago" | wc -l)
      REVIEWED=$(git log --oneline --merges --since="30 days ago" --grep="Approved" | wc -l)
      echo "Review coverage: $((REVIEWED * 100 / TOTAL))%"
signals:
  critical:
  - id: PRC-CRIT-001
    signal: Review coverage below 50%
    evidence_pattern: coverage < 50%
    cwe: CWE-710
    explanation: |
      Less than half of code changes receive peer review, indicating a severely
      broken review process. This dramatically increases defect escape rate and
      technical debt accumulation.
    remediation: Implement mandatory PR reviews with branch protection rules
  - id: PRC-CRIT-002
    signal: Self-approval pattern detected
    evidence_pattern: author == approver
    cwe: CWE-710
    explanation: |
      Developers are approving their own code changes, defeating the purpose
      of peer review. This may indicate review fatigue or process bypass.
    remediation: Configure branch protection to require review from different user
  high:
  - id: PRC-HIGH-001
    signal: Review coverage between 50-80%
    evidence_pattern: 50% <= coverage < 80%
    cwe: CWE-710
    explanation: |
      Significant portion of code changes bypass review process, creating
      quality inconsistencies and potential defect injection points.
    remediation: Audit bypass reasons and tighten branch protection
  - id: PRC-HIGH-002
    signal: Emergency merge without review exceeds 5%
    evidence_pattern: emergency_bypass > 5%
    cwe: CWE-710
    explanation: |
      High rate of emergency merges suggests either too many production
      issues or abuse of emergency bypass procedures.
    remediation: Review emergency bypass criteria and post-merge review process
  medium:
  - id: PRC-MED-001
    signal: Inconsistent review coverage across teams
    evidence_pattern: team_coverage_variance > 20%
    remediation: Standardize review requirements across all teams
  low:
  - id: PRC-LOW-001
    signal: Review coverage not tracked
    evidence_pattern: no_metrics_found
    remediation: Implement review coverage metrics collection
  positive:
  - id: PRC-POS-001
    signal: Review coverage above 95%
    evidence_pattern: coverage >= 95%
  - id: PRC-POS-002
    signal: Branch protection rules enforced
    evidence_pattern: branch_protection_enabled
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Collect Merge History
    description: |
      Gather all merge commits and direct pushes to protected branches
      within the analysis period.
    duration_estimate: 10 min
    commands:
    - purpose: List all merges in last 90 days
      command: |
        git log --oneline --merges --since="90 days ago" --format="%H %s" | head -100
    - purpose: Find direct pushes to main
      command: |
        git log --oneline --no-merges --first-parent main --since="90 days ago" | head -50
    expected_findings:
    - Merge commit list with PR references
    - Direct commits that bypassed PR process
  - id: '2'
    name: Query PR Review Status
    description: |
      For each merged PR, determine whether it received review approval
      before merging.
    duration_estimate: 15 min
    commands:
    - purpose: Get PR review status via GitHub CLI
      command: |
        gh pr list --state merged --limit 50 --json number,reviews,mergedAt
    expected_findings:
    - Review approval status per PR
    - Reviewer identities and counts
  - id: '3'
    name: Calculate Coverage Metrics
    description: |
      Compute review coverage percentages and identify patterns in
      unreviewed changes.
    duration_estimate: 10 min
    expected_findings:
    - Overall review coverage percentage
    - Coverage by team/component
    - Bypass reason categorization
  - id: '4'
    name: Analyze Bypass Patterns
    description: |
      Investigate unreviewed changes to understand why they bypassed
      review and whether bypasses were justified.
    duration_estimate: 10 min
    expected_findings:
    - Emergency bypass frequency
    - Self-approval incidents
    - Admin override usage
output:
  deliverables:
  - type: metrics
    format: structured
    content:
    - review_coverage_percentage
    - unreviewed_change_count
    - self_approval_count
    - emergency_bypass_count
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Coverage Metrics
    - Bypass Analysis
    - Recommendations
  confidence_guidance:
    high: Complete PR metadata available with review status
    medium: Partial PR data with some gaps in review history
    low: Limited to git commit analysis without PR platform data
offline:
  capability: partial
  cache_manifest:
    knowledge:
    - source_id: google-eng-practices
      priority: required
profiles:
  membership:
    quick:
      included: true
      priority: 3
    full:
      included: true
      priority: 2
    quality:
      included: true
      priority: 1
closeout_checklist:
- id: prc-001
  item: Review coverage calculated for analysis period
  level: BLOCKING
  verification: Coverage percentage between 0-100%
  expected: Numeric coverage value available
- id: prc-002
  item: Unreviewed changes identified and categorized
  level: WARNING
  verification: List of unreviewed commits with reasons
  expected: All unreviewed changes have assigned category
- id: prc-003
  item: Branch protection status verified
  level: WARNING
  verification: gh api repos/{owner}/{repo}/branches/main/protection
  expected: Protection rules documented
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: SOC 2
    controls:
    - CC8.1
  - framework: ISO 27001
    controls:
    - A.14.2.2
  - framework: DORA Metrics
    controls:
    - Change Failure Rate
relationships:
  commonly_combined:
  - code-quality.code-review.review-depth
  - code-quality.code-review.reviewer-distribution
  - code-quality.code-review.review-turnaround-time
