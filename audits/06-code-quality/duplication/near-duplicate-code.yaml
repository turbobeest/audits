# ============================================================
# AUDIT: Near-Duplicate Code Detection
# ============================================================

audit:
  id: "code-quality.duplication.near-duplicate-code"
  name: "Near-Duplicate Code Detection Audit"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "duplication"

  tier: "expert"
  estimated_duration: "45 minutes"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "quality"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Identifies Type-3 (gapped) and Type-4 (semantic) code clones where
    code blocks are similar but not identical. Detects patterns where
    code has been copied and modified, including added/removed statements,
    changed expressions, or restructured logic that preserves similar
    functionality.

  why_it_matters: |
    Near-duplicates are harder to detect than exact clones but equally
    problematic. They often represent divergent evolution of copied code,
    where bug fixes applied to one copy may not apply correctly to modified
    versions. Studies show 60-70% of clones in mature codebases are
    near-duplicates, and they are responsible for a disproportionate
    number of inconsistency bugs.

  when_to_run:
    - "Deep code quality reviews"
    - "Before major refactoring"
    - "Technical debt assessment"
    - "Security audits"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Application source code"

  access_requirements:
    - "Read access to source code"

discovery:
  code_patterns:
    - pattern: "structural similarity > 70%"
      type: "ast"
      scope: "source"
      purpose: "Type-3 gapped clones"
    - pattern: "semantic equivalence"
      type: "ast"
      scope: "source"
      purpose: "Type-4 semantic clones"

  file_patterns:
    - glob: "**/*.{js,ts,jsx,tsx,py,java,go,rb,cs}"
      purpose: "Source code files"

knowledge_sources:
  specifications:
    - id: "clone-detection"
      name: "Code Clone Detection Techniques"
      url: "https://ieeexplore.ieee.org/document/4288192"
      offline_cache: true
      priority: "recommended"

  guides:
    - id: "refactoring-fowler"
      name: "Martin Fowler - Refactoring"
      url: "https://refactoring.com/"
      offline_cache: false

    - id: "refactoring-catalog"
      name: "Refactoring Catalog"
      url: "https://refactoring.com/catalog/"
      offline_cache: false

    - id: "clean-code"
      name: "Robert C. Martin - Clean Code"
      url: "https://www.oreilly.com/library/view/clean-code-a/9780136083238/"
      offline_cache: false

  papers:
    - id: "semantic-clones"
      title: "Semantic Clone Detection Using Machine Learning"
      url: "https://dl.acm.org/doi/10.1145/3183519.3183525"

tooling:
  static_analysis:
    - tool: "SourcererCC"
      purpose: "Scalable token-based clone detection"
      offline_capable: true
    - tool: "NiCad"
      purpose: "Near-miss clone detection"
      offline_capable: true
    - tool: "CCFinder"
      purpose: "Token-based clone detection"
      offline_capable: true
    - tool: "jscpd"
      purpose: "Configurable clone detection"
      offline_capable: true

  scripts:
    - id: "near-duplicate-scan"
      language: "bash"
      purpose: "Detect near-duplicate patterns"
      source: "inline"
      code: |
        # Find similar function signatures
        grep -roh --include="*.py" "def [a-z_][a-z0-9_]*([^)]*)" . 2>/dev/null | \
          sed 's/self,\s*//' | sort | uniq -c | sort -rn | awk '$1 > 1' | head -20
        # Find similar class definitions
        grep -roh --include="*.py" "class [A-Z][a-zA-Z0-9]*" . 2>/dev/null | sort | uniq -c | sort -rn | head -20

signals:
  critical:
    - id: "NDC-CRIT-001"
      signal: "Near-duplicates in security-critical code with divergent implementations"
      evidence_pattern: "Similar auth/validation with different logic"
      cwe: "CWE-1041"
      explanation: |
        When security code has diverged through independent modifications of
        near-duplicates, security properties may differ between copies.
        One version may have a vulnerability fix that the other lacks.
      remediation: "Consolidate and apply all security fixes uniformly"

    - id: "NDC-CRIT-002"
      signal: "Business logic near-duplicates with inconsistent behavior"
      evidence_pattern: "Similar calculations yielding different results"
      explanation: |
        Near-duplicate business logic that has diverged creates inconsistent
        behavior that confuses users and creates data integrity issues.
        The same input may produce different outputs depending on code path.
      remediation: "Unify into single implementation with parameterization"

  high:
    - id: "NDC-HIGH-001"
      signal: "Functions with 70%+ structural similarity"
      evidence_pattern: "High AST similarity score"
      explanation: |
        Functions that are structurally similar but not identical often
        represent missed abstraction opportunities. They create maintenance
        burden and risk of inconsistent changes.
      remediation: "Extract common logic to shared function"

    - id: "NDC-HIGH-002"
      signal: "Parallel class hierarchies with similar methods"
      evidence_pattern: "Classes with matching method signatures"
      explanation: |
        Parallel hierarchies where classes have similar structure but
        different names often indicate a need for shared base class or
        interface extraction.
      remediation: "Extract common interface or base class"

  medium:
    - id: "NDC-MED-001"
      signal: "Similar algorithms with minor variations"
      evidence_pattern: "Same structure, different operators/constants"
      remediation: "Parameterize differences"

    - id: "NDC-MED-002"
      signal: "Handler functions with similar structure"
      evidence_pattern: "API handlers with parallel patterns"
      remediation: "Extract common handler pattern"

  low:
    - id: "NDC-LOW-001"
      signal: "Test functions with similar setup patterns"
      evidence_pattern: "Repeated test boilerplate"
      remediation: "Create shared fixtures"

  positive:
    - id: "NDC-POS-001"
      signal: "Effective use of base classes for shared behavior"
    - id: "NDC-POS-002"
      signal: "Template method pattern applied for variations"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Run Near-Clone Detection"
      description: |
        Execute detection tools configured for gapped clone detection
        with lower similarity thresholds.
      duration_estimate: "15 min"
      commands:
        - purpose: "Run jscpd with lower threshold"
          command: |
            npx jscpd --min-lines 8 --min-tokens 30 --threshold 5 --reporters console . 2>/dev/null || echo "jscpd not available"
        - purpose: "Find similar function signatures"
          command: |
            grep -roh --include="*.py" "def [a-z_]+\([^)]*\)" . 2>/dev/null | sed 's/self,\?\s*//' | sort | uniq -c | sort -rn | awk '$1 > 1' | head -20
      expected_findings:
        - "Near-clone clusters"
        - "Similarity scores"

    - id: "2"
      name: "Identify Divergent Clones"
      description: |
        Find cases where similar code has diverged through
        independent modifications.
      duration_estimate: "12 min"
      commands:
        - purpose: "Find similarly named functions"
          command: |
            grep -roh --include="*.py" "def [a-z_]*\(process\|handle\|validate\|create\|update\)[a-z_]*" . 2>/dev/null | sort | uniq
        - purpose: "Compare similar function implementations"
          command: |
            for func in $(grep -roh --include="*.py" "def process_[a-z_]*" . 2>/dev/null | sort -u | head -5); do
              echo "=== $func ==="
              grep -rn --include="*.py" "$func" . 2>/dev/null | head -3
            done
      expected_findings:
        - "Divergent implementations"
        - "Evolution patterns"

    - id: "3"
      name: "Analyze Parallel Structures"
      description: |
        Look for parallel class hierarchies and module structures
        that suggest duplication at architecture level.
      duration_estimate: "10 min"
      commands:
        - purpose: "Find similar class patterns"
          command: |
            grep -roh --include="*.py" "class [A-Z][a-zA-Z]*" . 2>/dev/null | sed 's/class //' | sort | uniq -c | sort -rn | awk '$1 > 1' | head -15
        - purpose: "Find parallel method names across classes"
          command: |
            grep -roh --include="*.py" "def \(get_\|set_\|create_\|delete_\|update_\)" . 2>/dev/null | sort | uniq -c | sort -rn | head -20
      expected_findings:
        - "Parallel structures"
        - "Abstraction opportunities"

    - id: "4"
      name: "Assess Consolidation Opportunities"
      description: |
        Evaluate which near-duplicates can be safely consolidated
        and estimate refactoring effort.
      duration_estimate: "8 min"
      questions:
        - "Which near-duplicates have identical expected behavior?"
        - "Which have intentional differences that should be preserved?"
        - "What shared abstraction would capture the common pattern?"
      expected_findings:
        - "Consolidation candidates"
        - "Effort estimates"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      content:
        - "near_clone_clusters"
        - "divergence_analysis"
        - "consolidation_opportunities"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Near-Clone Analysis"
        - "Divergence Risks"
        - "Refactoring Recommendations"

  confidence_guidance:
    high: "Comprehensive tooling with manual verification"
    medium: "Automated detection with limited review"
    low: "Pattern matching only"

offline:
  capability: "full"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires deep analysis"
    full:
      included: true
      priority: 2
    quality:
      included: true
      priority: 1

closeout_checklist:
  - id: "ndc-001"
    item: "Near-duplicate analysis completed"
    level: "BLOCKING"
    verification: |
      echo "Manual verification required" && echo "PASS"
    expected: "PASS"

  - id: "ndc-002"
    item: "Critical divergent clones identified"
    level: "WARNING"
    verification: |
      echo "Review near-clone report for security-critical areas" && echo "PASS"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "CWE"
      controls: ["CWE-1041"]
    - framework: "ISO 25010"
      controls: ["Maintainability"]

relationships:
  commonly_combined:
    - "code-quality.duplication.copy-paste-detection"
    - "code-quality.duplication.abstraction-opportunity"
    - "code-quality.maintainability.code-organization"
