# ============================================================
# AUDIT: Cross-Module Duplication
# ============================================================

audit:
  id: "code-quality.duplication.cross-module-duplication"
  name: "Cross-Module Duplication Audit"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "duplication"

  tier: "expert"
  estimated_duration: "40 minutes"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "quality"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Identifies code duplication that spans module, package, or service
    boundaries. Detects patterns where similar functionality exists in
    multiple independent modules, teams' codebases, or microservices,
    often due to lack of shared libraries or poor code organization.

  why_it_matters: |
    Cross-module duplication is especially costly because it spans team
    boundaries and often goes unnoticed. When the same logic exists in
    multiple services, bug fixes and security patches must be applied
    independently, leading to inconsistent behavior and vulnerabilities.
    This duplication often represents opportunity for shared libraries
    or common service extraction.

  when_to_run:
    - "Architecture reviews"
    - "Microservice consolidation planning"
    - "Shared library design"
    - "Technical debt assessments"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Application source code across modules"
    - type: "module_structure"
      description: "Module/package organization information"

  access_requirements:
    - "Read access to all modules/services"

discovery:
  code_patterns:
    - pattern: "same utility functions in multiple modules"
      type: "ast"
      scope: "source"
      purpose: "Duplicated utilities"
    - pattern: "similar model definitions"
      type: "ast"
      scope: "source"
      purpose: "Duplicated data models"
    - pattern: "common validation logic"
      type: "ast"
      scope: "source"
      purpose: "Duplicated validators"

  file_patterns:
    - glob: "**/utils/**/*.{py,js,ts,java}"
      purpose: "Utility modules"
    - glob: "**/helpers/**/*.{py,js,ts,java}"
      purpose: "Helper modules"
    - glob: "**/common/**/*.{py,js,ts,java}"
      purpose: "Common modules"
    - glob: "**/models/**/*.{py,js,ts,java}"
      purpose: "Model definitions"

knowledge_sources:
  guides:
    - id: "shared-libraries"
      name: "Building Shared Libraries for Microservices"
      url: "https://microservices.io/patterns/decomposition/shared-library.html"
      offline_cache: true

    - id: "dry-architecture"
      name: "DRY at the Architecture Level"
      url: "https://www.oreilly.com/library/view/software-architecture-patterns/9781491971437/"
      offline_cache: true

    - id: "refactoring-fowler"
      name: "Martin Fowler - Refactoring"
      url: "https://refactoring.com/"
      offline_cache: false

    - id: "refactoring-catalog"
      name: "Refactoring Catalog"
      url: "https://refactoring.com/catalog/"
      offline_cache: false

    - id: "clean-code"
      name: "Robert C. Martin - Clean Code"
      url: "https://www.oreilly.com/library/view/clean-code-a/9780136083238/"
      offline_cache: false

  learning_resources:
    - id: "microservices-book"
      title: "Building Microservices"
      type: "book"
      reference: "ISBN: 978-1492034025"

tooling:
  static_analysis:
    - tool: "jscpd"
      purpose: "Cross-directory clone detection"
      offline_capable: true
    - tool: "sonarqube"
      purpose: "Cross-module duplication analysis"
      offline_capable: true

  scripts:
    - id: "cross-module-scan"
      language: "bash"
      purpose: "Detect cross-module duplication"
      source: "inline"
      code: |
        # Find utility functions repeated across modules
        for dir in $(find . -type d -name "utils" -o -name "helpers" -o -name "common" 2>/dev/null | head -10); do
          echo "=== $dir ==="
          grep -roh "def [a-z_][a-z0-9_]*" "$dir" 2>/dev/null | head -10
        done
        # Find repeated helper files
        find . -name "*helper*" -o -name "*util*" 2>/dev/null | head -20

signals:
  critical:
    - id: "CMD-CRIT-001"
      signal: "Security utilities duplicated across services"
      evidence_pattern: "Auth/crypto helpers in multiple modules"
      cwe: "CWE-1041"
      explanation: |
        When security utilities like authentication helpers, encryption
        functions, or input sanitizers are duplicated across services,
        security updates must be applied independently to each copy.
        Forgotten patches create security vulnerabilities.
      remediation: "Extract to shared security library with centralized updates"

    - id: "CMD-CRIT-002"
      signal: "Business rule implementations duplicated across services"
      evidence_pattern: "Same calculations in multiple services"
      explanation: |
        Critical business rules implemented independently in multiple
        services will diverge over time, leading to inconsistent behavior
        for users and data integrity issues.
      remediation: "Create shared business rules library or service"

  high:
    - id: "CMD-HIGH-001"
      signal: "Data model definitions duplicated across modules"
      evidence_pattern: "Same class/struct in multiple packages"
      explanation: |
        Duplicated data models create schema drift where the same concept
        is represented differently in different modules. This leads to
        integration bugs and data conversion issues.
      remediation: "Extract to shared models package"

    - id: "CMD-HIGH-002"
      signal: "Utility functions duplicated in 3+ modules"
      evidence_pattern: "Same helper function name in multiple dirs"
      explanation: |
        Common utilities like string formatting, date handling, or file
        operations duplicated across many modules indicate a need for
        shared utility library.
      remediation: "Create shared utilities package"

  medium:
    - id: "CMD-MED-001"
      signal: "Configuration parsing duplicated"
      evidence_pattern: "Similar config loading in multiple modules"
      remediation: "Create shared configuration library"

    - id: "CMD-MED-002"
      signal: "Logging/monitoring setup duplicated"
      evidence_pattern: "Similar instrumentation code"
      remediation: "Create shared observability library"

  low:
    - id: "CMD-LOW-001"
      signal: "Test utilities duplicated across test suites"
      evidence_pattern: "Similar test helpers in different modules"
      remediation: "Create shared test utilities"

  positive:
    - id: "CMD-POS-001"
      signal: "Shared libraries actively used across modules"
    - id: "CMD-POS-002"
      signal: "Common patterns extracted to framework"
    - id: "CMD-POS-003"
      signal: "Versioned shared packages with clear ownership"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Map Module Structure"
      description: |
        Understand the module/package organization to identify
        boundaries where duplication may occur.
      duration_estimate: "8 min"
      commands:
        - purpose: "Find module directories"
          command: |
            find . -name "__init__.py" -exec dirname {} \; 2>/dev/null | sort -u | head -30
        - purpose: "Find service boundaries"
          command: |
            find . -name "setup.py" -o -name "package.json" -o -name "go.mod" 2>/dev/null | head -20
      expected_findings:
        - "Module structure map"
        - "Service boundaries"

    - id: "2"
      name: "Identify Shared Patterns"
      description: |
        Find utility, helper, and common directories that may
        contain duplicated functionality.
      duration_estimate: "10 min"
      commands:
        - purpose: "Find utility directories"
          command: |
            find . -type d \( -name "utils" -o -name "helpers" -o -name "common" -o -name "shared" -o -name "lib" \) 2>/dev/null | head -20
        - purpose: "List functions in utility modules"
          command: |
            for util in $(find . -type d -name "utils" 2>/dev/null | head -5); do
              echo "=== $util ==="
              grep -roh "def [a-z_][a-z0-9_]*" "$util" 2>/dev/null | sort | uniq
            done
      expected_findings:
        - "Utility module locations"
        - "Function inventories"

    - id: "3"
      name: "Detect Cross-Module Clones"
      description: |
        Run clone detection across module boundaries to find
        duplicated implementations.
      duration_estimate: "12 min"
      commands:
        - purpose: "Run cross-directory clone detection"
          command: |
            npx jscpd --min-lines 10 --reporters console . 2>/dev/null | grep -A5 "Found clones" || echo "Use jscpd for detailed analysis"
        - purpose: "Find repeated function names across modules"
          command: |
            grep -roh --include="*.py" "def [a-z_][a-z0-9_]*" . 2>/dev/null | sort | uniq -c | sort -rn | awk '$1 > 2 {print}' | head -20
      expected_findings:
        - "Cross-module clones"
        - "Shared function candidates"

    - id: "4"
      name: "Assess Consolidation Strategy"
      description: |
        Evaluate options for consolidating duplicated code into
        shared libraries or services.
      duration_estimate: "10 min"
      questions:
        - "Which duplications should become shared libraries?"
        - "Which should become shared services?"
        - "What versioning strategy should be used?"
        - "Who will own the shared code?"
      expected_findings:
        - "Consolidation recommendations"
        - "Ownership assignments"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      content:
        - "cross_module_clones"
        - "shared_library_candidates"
        - "consolidation_plan"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Duplication Map"
        - "Consolidation Options"
        - "Implementation Plan"

  confidence_guidance:
    high: "Comprehensive cross-module analysis"
    medium: "Partial coverage of modules"
    low: "Limited sample analysis"

offline:
  capability: "full"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires architectural analysis"
    full:
      included: true
      priority: 2
    quality:
      included: true
      priority: 1

closeout_checklist:
  - id: "cmd-001"
    item: "Cross-module duplication assessed"
    level: "BLOCKING"
    verification: |
      find . -type d \( -name "utils" -o -name "helpers" \) 2>/dev/null | wc -l | awk '{print ($1 >= 0) ? "PASS" : "FAIL"}'
    expected: "PASS"

  - id: "cmd-002"
    item: "Shared library candidates identified"
    level: "WARNING"
    verification: |
      echo "Manual review of consolidation opportunities required" && echo "PASS"
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "CWE"
      controls: ["CWE-1041"]
    - framework: "ISO 25010"
      controls: ["Maintainability", "Reusability"]

relationships:
  commonly_combined:
    - "code-quality.duplication.copy-paste-detection"
    - "code-quality.maintainability.code-organization"
    - "architecture.modularity.module-cohesion"
