audit:
  id: code-quality.static-analysis.duplicate-code
  name: Duplicate Code Detection
  version: 1.0.0
  last_updated: '2026-01-18'
  status: active
  category: code-quality
  category_number: 6
  subcategory: static-analysis
  tier: expert
  estimated_duration: 1-2 hours  # median: 1h
  completeness: complete
  requires_runtime: false
  destructive: false
execution:
  automatable: 'yes'
  severity: medium
  scope: codebase
  default_profiles:
  - full
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Detects duplicate and near-duplicate code segments (clones) across
    the codebase. Identifies exact copies, parameterized clones, and
    semantically similar code that violates DRY principles.
  why_it_matters: |
    Duplicate code multiplies maintenance effort, as bugs must be fixed
    in multiple locations. It increases codebase size, creates consistency
    risks when clones diverge, and indicates missing abstractions that
    should be refactored into shared components.
  when_to_run:
  - Initial codebase assessment
  - Before refactoring initiatives
  - Code review for large changes
  - Periodic quality monitoring
prerequisites:
  required_artifacts:
  - type: source_code
    description: Complete source code repository
  access_requirements:
  - Read access to source code
discovery:
  file_patterns:
  - glob: '**/*.py'
    purpose: Python source files
  - glob: '**/*.js'
    purpose: JavaScript source files
  - glob: '**/*.ts'
    purpose: TypeScript source files
  - glob: '**/*.java'
    purpose: Java source files
  - glob: '**/*.go'
    purpose: Go source files
knowledge_sources:
  guides:
  - id: jscpd-docs
    name: JSCPD - Copy/Paste Detector
    url: https://github.com/kucherenko/jscpd
    offline_cache: true
  - id: nist-800-218
    name: NIST SP 800-218 - Secure Software Development Framework
    url: https://csrc.nist.gov/publications/detail/sp/800-218/final
    offline_cache: false
  papers:
  - id: clone-detection
    title: Comparison and Evaluation of Code Clone Detection Techniques
    url: https://ieeexplore.ieee.org/document/4556129
  learning_resources:
  - id: dry-principle
    title: The Pragmatic Programmer
    type: book
    reference: Hunt and Thomas, DRY principle
tooling:
  static_analysis:
  - tool: jscpd
    purpose: Multi-language copy/paste detection
    offline_capable: true
  - tool: PMD CPD
    purpose: Java/JavaScript copy-paste detector
    offline_capable: true
  - tool: pylint
    purpose: Python duplicate code detection (similarities)
    offline_capable: true
  - tool: SonarQube
    purpose: Comprehensive duplication analysis
    offline_capable: false
  - tool: simian
    purpose: Similarity analyzer for multiple languages
    offline_capable: true
  scripts:
  - id: duplication-scan
    language: bash
    purpose: Run jscpd for duplication detection
    source: inline
    code: |
      #!/bin/bash
      npx jscpd . --min-lines 5 --min-tokens 50 --reporters console 2>/dev/null
signals:
  critical:
  - id: DUP-CRIT-001
    signal: Security-critical code duplicated with divergent implementations
    evidence_pattern: Duplicated auth/crypto code with differences
    explanation: |
      Duplicated security code that has diverged creates inconsistent
      protection and potential vulnerabilities if one copy is patched
      but not others.
    remediation: Consolidate into single, well-tested security module
  high:
  - id: DUP-HIGH-001
    signal: Large code blocks (>50 lines) duplicated multiple times
    evidence_pattern: Clone groups with >50 lines appearing 3+ times
    explanation: |
      Large duplicated blocks significantly multiply maintenance
      burden and bug risk.
    remediation: Extract into shared function, class, or module
  - id: DUP-HIGH-002
    signal: Duplication percentage above 15% of codebase
    evidence_pattern: jscpd total percentage > 15%
    explanation: |
      High overall duplication indicates systemic abstraction
      problems in the codebase architecture.
    remediation: Architectural review to identify missing abstractions
  medium:
  - id: DUP-MED-001
    signal: Duplicated business logic across modules
    remediation: Consolidate into shared service or utility
  - id: DUP-MED-002
    signal: Copy-pasted test setup code
    remediation: Extract into test fixtures or helper functions
  low:
  - id: DUP-LOW-001
    signal: Minor code patterns duplicated (5-10 lines)
  - id: DUP-LOW-002
    signal: Structural duplication in configuration files
  positive:
  - id: DUP-POS-001
    signal: Duplication below 5% threshold
  - id: DUP-POS-002
    signal: No large clone groups detected
procedure:
  context:
    cognitive_mode: evaluative
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Run duplication detection tools
    description: |
      Execute copy/paste detection tools to identify duplicated
      code segments across the codebase.
    duration_estimate: 15 min
    commands:
    - purpose: Detect duplicates with jscpd
      command: npx jscpd . --min-lines 5 --min-tokens 50 --reporters console 2>/dev/null | head -100
    - purpose: Python similarity check
      command: pylint --disable=all --enable=similarities . 2>/dev/null | head -50
    expected_findings:
    - Clone pairs and groups
    - Duplication percentage
  - id: '2'
    name: Analyze clone distribution
    description: |
      Examine where duplicates are located to understand patterns
      and identify systemic issues.
    duration_estimate: 15 min
    expected_findings:
    - Modules with highest duplication
    - Cross-module vs intra-module clones
  - id: '3'
    name: Categorize clone types
    description: |
      Classify detected clones by type: exact copies, parameterized
      clones, or semantic clones.
    duration_estimate: 15 min
    expected_findings:
    - Clone type breakdown
    - Complexity of required refactoring
  - id: '4'
    name: Assess refactoring opportunities
    description: |
      Evaluate which clones are good candidates for consolidation
      and estimate refactoring effort.
    duration_estimate: 20 min
    expected_findings:
    - Prioritized refactoring targets
    - Effort estimates for consolidation
  - id: '5'
    name: Check for divergent clones
    description: |
      Identify clones that have diverged over time, which may
      indicate inconsistent bug fixes or features.
    duration_estimate: 15 min
    expected_findings:
    - Divergent clone pairs
    - Differences between clones
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Duplication Metrics
    - Major Clone Groups
    - Refactoring Recommendations
  - type: metrics
    format: table
    fields:
    - total_duplication_percentage
    - clone_count
    - largest_clone_size
    - modules_with_highest_duplication
  confidence_guidance:
    high: Tool-detected clones with verified matches
    medium: Near-duplicates with minor variations
    low: Semantic similarity requiring manual review
offline:
  capability: full
  cache_manifest:
    knowledge:
    - source_id: jscpd-docs
      priority: recommended
profiles:
  membership:
    quick:
      included: false
      reason: Detailed analysis requires time for large codebases
    full:
      included: true
      priority: 2
closeout_checklist:
- id: duplicate-code-001
  item: Duplication detection tool executed
  level: BLOCKING
  verification: which jscpd || npm list -g jscpd && echo PASS || echo FAIL
  expected: PASS
- id: duplicate-code-002
  item: Total duplication below 15%
  level: BLOCKING
  verification: manual
  verification_notes: Check jscpd percentage output
  expected: Confirmed by reviewer
- id: duplicate-code-003
  item: No security-critical code duplication
  level: CRITICAL
  verification: manual
  verification_notes: Review auth/crypto code for duplication
  expected: Confirmed by reviewer
governance:
  applicable_to:
    archetypes:
    - all
  compliance_frameworks:
  - framework: ISO 25010
    controls:
    - Maintainability
    - Reusability
relationships:
  commonly_combined:
  - code-quality.static-analysis.code-complexity
  - code-quality.static-analysis.dead-code-detection
