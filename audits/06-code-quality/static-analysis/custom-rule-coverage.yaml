# ============================================================
# AUDIT FILE - Custom Rule Coverage v1.0
# ============================================================

# ============================================================
# SECTION 1: IDENTITY & METADATA
# ============================================================

audit:
  id: "code-quality.static-analysis.custom-rule-coverage"

  name: "Custom Rule Coverage"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "static-analysis"

  tier: "expert"
  estimated_duration: "2-4 hours"  # median: 3h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

# ============================================================
# SECTION 2: EXECUTION CLASSIFICATION
# ============================================================

execution:
  automatable: "partial"

  severity: "medium"

  scope: "codebase"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

# ============================================================
# SECTION 3: DESCRIPTION & RATIONALE
# ============================================================

description:
  what: |
    Evaluates the use of custom static analysis rules specific to the
    project's domain, architecture, and conventions. Assesses whether
    project-specific patterns, anti-patterns, and best practices are
    codified as automated checks.

  why_it_matters: |
    Off-the-shelf rules only catch generic issues. Custom rules encode
    domain expertise, architectural decisions, and team conventions into
    automated checks. They prevent recurring issues and scale knowledge
    across the team.

  when_to_run:
    - "After documenting architectural decisions"
    - "When recurring issues appear in code review"
    - "Periodic review of coding standards"
    - "After major architectural changes"

# ============================================================
# SECTION 4: PREREQUISITES
# ============================================================

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Source code repository"
    - type: "configuration"
      description: "Static analysis configuration with custom rules"
    - type: "documentation"
      description: "Architectural decisions and coding standards (optional)"

  access_requirements:
    - "Read access to source code"
    - "Access to linter configurations"
    - "Knowledge of project-specific patterns"

# ============================================================
# SECTION 5: DISCOVERY SPECIFICATION
# ============================================================

discovery:
  file_patterns:
    - glob: "**/.eslintrc*"
      purpose: "ESLint configuration with custom rules"
    - glob: "**/eslint-rules/**"
      purpose: "Custom ESLint rule implementations"
    - glob: "**/.semgrep/**"
      purpose: "Custom Semgrep rules"
    - glob: "**/semgrep-rules/**"
      purpose: "Custom Semgrep rule files"
    - glob: "**/pylint-plugins/**"
      purpose: "Custom Pylint plugins"

  code_patterns:
    - pattern: "meta:\\s*{|create\\s*\\(context\\)"
      type: "regex"
      scope: "source"
      purpose: "ESLint custom rule implementation patterns"
    - pattern: "rules:\\s*\\n\\s*-\\s*id:"
      type: "regex"
      scope: "config"
      purpose: "Semgrep custom rule definitions"

# ============================================================
# SECTION 6: EXTERNAL KNOWLEDGE SOURCES
# ============================================================

knowledge_sources:
  guides:
    - id: "eslint-custom"
      name: "ESLint Custom Rules"
      url: "https://eslint.org/docs/developer-guide/working-with-rules"
      offline_cache: true
    - id: "semgrep-rules"
      name: "Semgrep Custom Rules"
      url: "https://semgrep.dev/docs/writing-rules/overview/"
      offline_cache: true

    - id: "nist-800-218"
      name: "NIST SP 800-218 - Secure Software Development Framework"
      url: "https://csrc.nist.gov/publications/detail/sp/800-218/final"
      offline_cache: false

# ============================================================
# SECTION 7: TOOLING & AUTOMATION
# ============================================================

tooling:
  static_analysis:
    - tool: "eslint"
      purpose: "JavaScript/TypeScript custom rules"
      offline_capable: true
    - tool: "semgrep"
      purpose: "Custom security and pattern rules"
      offline_capable: true
    - tool: "pylint"
      purpose: "Python custom checker plugins"
      offline_capable: true
    - tool: "ast-grep"
      purpose: "AST-based pattern matching rules"
      offline_capable: true

  scripts:
    - id: "custom-rule-inventory"
      language: "bash"
      purpose: "List custom rules in configuration"
      source: "inline"
      code: |
        #!/bin/bash
        echo "=== Custom ESLint Rules ==="
        find . -name 'eslint-rules' -type d 2>/dev/null
        echo "=== Semgrep Rules ==="
        find . -name '*.yaml' -path '*semgrep*' 2>/dev/null

# ============================================================
# SECTION 8: SIGNALS & FINDINGS TAXONOMY
# ============================================================

signals:
  critical:
    - id: "CUST-CRIT-001"
      signal: "No custom rules despite documented conventions"
      evidence_pattern: "Documented patterns without corresponding automated checks"
      explanation: |
        Documented but unenforced conventions rely on manual review
        and will inevitably be violated.
      remediation: "Implement custom rules for documented architectural decisions"

  high:
    - id: "CUST-HIGH-001"
      signal: "Recurring code review feedback not codified"
      evidence_pattern: "Same feedback appearing in multiple PRs"
      explanation: |
        Repeated manual feedback indicates a pattern that should
        be automated.
      remediation: "Create custom rules for frequently flagged patterns"

    - id: "CUST-HIGH-002"
      signal: "Security-critical patterns not enforced by rules"
      evidence_pattern: "Security guidelines without corresponding checks"
      explanation: |
        Security patterns are too important to rely on manual
        review alone.
      remediation: "Implement security-focused custom rules"

  medium:
    - id: "CUST-MED-001"
      signal: "Custom rules exist but lack documentation"
      remediation: "Document rule purpose and examples"

    - id: "CUST-MED-002"
      signal: "Custom rules not tested"
      remediation: "Add test cases for custom rules"

  low:
    - id: "CUST-LOW-001"
      signal: "Custom rules could be more specific"

  positive:
    - id: "CUST-POS-001"
      signal: "Comprehensive custom rules covering project conventions"
    - id: "CUST-POS-002"
      signal: "Custom rules well-documented and tested"

# ============================================================
# SECTION 9: EXECUTION PROCEDURE
# ============================================================

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory custom rules"
      description: |
        Identify all custom static analysis rules currently
        implemented in the project.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find custom ESLint rules"
          command: "find . -name 'eslint-rules' -type d -o -name '*.eslint.js' 2>/dev/null"
        - purpose: "Find custom Semgrep rules"
          command: "find . -name '*.yaml' -path '*semgrep*' 2>/dev/null | head -20"
      expected_findings:
        - "Custom rule implementations"
        - "Rule categories covered"

    - id: "2"
      name: "Review documented conventions"
      description: |
        Examine documentation for architectural decisions and
        coding conventions that should be automated.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find convention documentation"
          command: "find . -name 'CONVENTIONS.md' -o -name 'ARCHITECTURE.md' -o -name 'CONTRIBUTING.md' 2>/dev/null"
      expected_findings:
        - "Documented patterns and conventions"
        - "Gaps between docs and enforcement"

    - id: "3"
      name: "Analyze code review patterns"
      description: |
        Review recent PRs for recurring feedback that could
        be automated.
      duration_estimate: "30 min"
      questions:
        - "What patterns are frequently flagged in code review?"
        - "Are there common mistakes new developers make?"
      expected_findings:
        - "Common code review feedback themes"
        - "Automation opportunities"

    - id: "4"
      name: "Evaluate rule quality"
      description: |
        Assess existing custom rules for quality, documentation,
        and test coverage.
      duration_estimate: "20 min"
      expected_findings:
        - "Rule documentation status"
        - "Test coverage for rules"

    - id: "5"
      name: "Identify rule opportunities"
      description: |
        Based on conventions, review patterns, and domain
        knowledge, identify new rules that should be created.
      duration_estimate: "25 min"
      expected_findings:
        - "Recommended new rules"
        - "Priority ordering for implementation"

# ============================================================
# SECTION 10: OUTPUT SPECIFICATION
# ============================================================

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Current Custom Rules"
        - "Coverage Gaps"
        - "Recommended New Rules"

    - type: "metrics"
      format: "table"
      fields:
        - "custom_rule_count"
        - "documented_conventions_count"
        - "coverage_percentage"
        - "rules_needing_documentation"

  confidence_guidance:
    high: "Rules inventoried, conventions documented, gaps identified"
    medium: "Partial convention documentation available"
    low: "Estimated based on limited documentation"

# ============================================================
# SECTION 11: OFFLINE SUPPORT
# ============================================================

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "eslint-custom"
        priority: "recommended"
      - source_id: "semgrep-rules"
        priority: "recommended"

# ============================================================
# SECTION 12: PROFILES
# ============================================================

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed analysis of project conventions"
    full:
      included: true
      priority: 3

# ============================================================
# SECTION 13: DETERMINISTIC VERIFICATION
# ============================================================

closeout_checklist:
  - id: "custom-rule-001"
    item: "Custom rules inventory completed"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Document all custom rules currently in use"
    expected: "Confirmed by reviewer"

  - id: "custom-rule-002"
    item: "Major conventions have corresponding rules"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Cross-reference documented conventions with rule coverage"
    expected: "Confirmed by reviewer"

  - id: "custom-rule-003"
    item: "Custom rules are documented"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Check that rules have explanatory comments or docs"
    expected: "Confirmed by reviewer"

# ============================================================
# SECTION 14: GOVERNANCE
# ============================================================

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability"]

# ============================================================
# SECTION 15: RELATIONSHIPS
# ============================================================

relationships:
  commonly_combined:
    - "code-quality.static-analysis.linting-coverage"
    - "code-quality.static-analysis.false-positive-rate"
