# ============================================================
# AUDIT FILE - Null Safety v1.0
# ============================================================

# ============================================================
# SECTION 1: IDENTITY & METADATA
# ============================================================

audit:
  id: "code-quality.static-analysis.null-safety"

  name: "Null Safety"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "static-analysis"

  tier: "expert"
  estimated_duration: "2-3 hours"  # median: 2h

  completeness: "complete"
  requires_runtime: false
  destructive: false

# ============================================================
# SECTION 2: EXECUTION CLASSIFICATION
# ============================================================

execution:
  automatable: "partial"

  severity: "high"

  scope: "codebase"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

# ============================================================
# SECTION 3: DESCRIPTION & RATIONALE
# ============================================================

description:
  what: |
    Evaluates null safety practices including null checking configuration,
    optional type usage, null assertion patterns, and runtime null handling.
    Identifies potential null pointer exceptions and unsafe null operations.

  why_it_matters: |
    Null pointer exceptions are among the most common runtime errors.
    Tony Hoare called null references his "billion-dollar mistake."
    Proper null safety prevents crashes, improves code clarity, and
    forces explicit handling of absent values.

  when_to_run:
    - "Initial codebase assessment"
    - "Before enabling strict null checks"
    - "After TypeScript migration"
    - "Periodic quality monitoring"

# ============================================================
# SECTION 4: PREREQUISITES
# ============================================================

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Complete source code repository"
    - type: "configuration"
      description: "Type checker configuration"

  access_requirements:
    - "Read access to source code"
    - "Type checker tools installed"

# ============================================================
# SECTION 5: DISCOVERY SPECIFICATION
# ============================================================

discovery:
  file_patterns:
    - glob: "**/tsconfig.json"
      purpose: "TypeScript configuration for strictNullChecks"
    - glob: "**/*.ts"
      purpose: "TypeScript source files"
    - glob: "**/*.py"
      purpose: "Python source files for Optional usage"

  code_patterns:
    - pattern: "!\\."
      type: "regex"
      scope: "source"
      purpose: "TypeScript non-null assertions"
    - pattern: "\\?\\."
      type: "regex"
      scope: "source"
      purpose: "Optional chaining usage"
    - pattern: "\\|\\s*null\\b|\\|\\s*undefined\\b"
      type: "regex"
      scope: "source"
      purpose: "Explicit nullable types"
    - pattern: "Optional\\["
      type: "regex"
      scope: "source"
      purpose: "Python Optional type usage"

# ============================================================
# SECTION 6: EXTERNAL KNOWLEDGE SOURCES
# ============================================================

knowledge_sources:
  guides:
    - id: "ts-strictnull"
      name: "TypeScript strictNullChecks"
      url: "https://www.typescriptlang.org/tsconfig#strictNullChecks"
      offline_cache: true

    - id: "nist-800-218"
      name: "NIST SP 800-218 - Secure Software Development Framework"
      url: "https://csrc.nist.gov/publications/detail/sp/800-218/final"
      offline_cache: false

  papers:
    - id: "null-references"
      title: "Null References: The Billion Dollar Mistake"
      url: "https://www.infoq.com/presentations/Null-References-The-Billion-Dollar-Mistake-Tony-Hoare/"

# ============================================================
# SECTION 7: TOOLING & AUTOMATION
# ============================================================

tooling:
  static_analysis:
    - tool: "tsc"
      purpose: "TypeScript strict null checking"
      offline_capable: true
    - tool: "eslint"
      purpose: "ESLint null safety rules"
      offline_capable: true
    - tool: "mypy"
      purpose: "Python None type checking"
      offline_capable: true

  scripts:
    - id: "null-assertion-count"
      language: "bash"
      purpose: "Count non-null assertions"
      source: "inline"
      code: |
        #!/bin/bash
        grep -rn '!\.' . --include='*.ts' --include='*.tsx' 2>/dev/null | wc -l

# ============================================================
# SECTION 8: SIGNALS & FINDINGS TAXONOMY
# ============================================================

signals:
  critical:
    - id: "NULL-CRIT-001"
      signal: "strictNullChecks disabled"
      evidence_pattern: "strictNullChecks: false or absent"
      explanation: |
        Without strict null checks, null and undefined can be
        assigned to any type, hiding potential runtime errors.
      remediation: "Enable strictNullChecks in tsconfig.json"

  high:
    - id: "NULL-HIGH-001"
      signal: "Excessive non-null assertions (!) usage"
      evidence_pattern: "High count of !. or ! patterns"
      explanation: |
        Non-null assertions tell the compiler to trust that a value
        is not null, bypassing safety. Overuse indicates poor null
        handling design.
      remediation: "Use proper null checks, guards, or optional chaining instead"

    - id: "NULL-HIGH-002"
      signal: "Missing null checks before dereferencing"
      evidence_pattern: "Property access on potentially null values"
      explanation: |
        Dereferencing potentially null values without checks leads
        to runtime exceptions.
      remediation: "Add null checks or use optional chaining"

  medium:
    - id: "NULL-MED-001"
      signal: "Inconsistent null handling patterns"
      remediation: "Standardize on optional chaining and nullish coalescing"

    - id: "NULL-MED-002"
      signal: "Functions returning null without documentation"
      remediation: "Document nullable returns; prefer throwing or Option types"

  low:
    - id: "NULL-LOW-001"
      signal: "Legacy null checks that could use optional chaining"

  positive:
    - id: "NULL-POS-001"
      signal: "strictNullChecks enabled with minimal assertions"
    - id: "NULL-POS-002"
      signal: "Consistent use of optional chaining and nullish coalescing"

# ============================================================
# SECTION 9: EXECUTION PROCEDURE
# ============================================================

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Check strict null configuration"
      description: |
        Verify that strict null checking is enabled in the
        type checker configuration.
      duration_estimate: "10 min"
      commands:
        - purpose: "Check TypeScript strictNullChecks"
          command: "grep -n 'strictNullChecks\\|strict' tsconfig.json 2>/dev/null"
      expected_findings:
        - "strictNullChecks setting"
        - "Overall strict mode status"

    - id: "2"
      name: "Count non-null assertions"
      description: |
        Measure the usage of non-null assertions which bypass
        null safety.
      duration_estimate: "15 min"
      commands:
        - purpose: "Count non-null assertions"
          command: "grep -rn '!\\.' . --include='*.ts' --include='*.tsx' 2>/dev/null | wc -l"
        - purpose: "Sample non-null assertion locations"
          command: "grep -rn '!\\.' . --include='*.ts' --include='*.tsx' 2>/dev/null | head -20"
      expected_findings:
        - "Total assertion count"
        - "Files with most assertions"

    - id: "3"
      name: "Analyze optional chaining usage"
      description: |
        Review usage of optional chaining and nullish coalescing
        as positive null safety patterns.
      duration_estimate: "10 min"
      commands:
        - purpose: "Count optional chaining usage"
          command: "grep -rn '\\?\\.' . --include='*.ts' --include='*.tsx' 2>/dev/null | wc -l"
        - purpose: "Count nullish coalescing usage"
          command: "grep -rn '\\?\\?' . --include='*.ts' --include='*.tsx' 2>/dev/null | wc -l"
      expected_findings:
        - "Modern null handling pattern adoption"

    - id: "4"
      name: "Review type errors related to null"
      description: |
        Run type checker and filter for null-related errors.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find null-related type errors"
          command: "npx tsc --noEmit 2>&1 | grep -i 'null\\|undefined' | head -20"
      expected_findings:
        - "Current null safety violations"
        - "Patterns in null errors"

    - id: "5"
      name: "Assess Python None handling"
      description: |
        For Python codebases, review Optional type usage and
        None checking patterns.
      duration_estimate: "15 min"
      commands:
        - purpose: "Count Optional type usage"
          command: "grep -rn 'Optional\\[' . --include='*.py' 2>/dev/null | wc -l"
        - purpose: "Find None checks"
          command: "grep -rn 'is None\\|is not None' . --include='*.py' 2>/dev/null | wc -l"
      expected_findings:
        - "Optional type adoption"
        - "None handling patterns"

# ============================================================
# SECTION 10: OUTPUT SPECIFICATION
# ============================================================

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Null Safety Configuration"
        - "Assertion Analysis"
        - "Recommendations"

    - type: "metrics"
      format: "table"
      fields:
        - "strict_null_checks_enabled"
        - "non_null_assertion_count"
        - "optional_chaining_count"
        - "null_type_errors"

  confidence_guidance:
    high: "Configuration verified, patterns measured via static analysis"
    medium: "Partial analysis, some patterns estimated"
    low: "Manual code review without tooling"

# ============================================================
# SECTION 11: OFFLINE SUPPORT
# ============================================================

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "ts-strictnull"
        priority: "recommended"

# ============================================================
# SECTION 12: PROFILES
# ============================================================

profiles:
  membership:
    quick:
      included: false
      reason: "Detailed null safety analysis requires time"
    full:
      included: true
      priority: 1

# ============================================================
# SECTION 13: DETERMINISTIC VERIFICATION
# ============================================================

closeout_checklist:
  - id: "null-safety-001"
    item: "strictNullChecks enabled"
    level: "CRITICAL"
    verification: "grep -q 'strictNullChecks.*true\\|\"strict\".*true' tsconfig.json && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "null-safety-002"
    item: "Non-null assertions below threshold"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Review assertion count relative to codebase size"
    expected: "Confirmed by reviewer"

  - id: "null-safety-003"
    item: "No null-related type errors"
    level: "BLOCKING"
    verification: "npx tsc --noEmit 2>&1 | grep -ci 'null\\|undefined' | xargs test 0 -eq && echo PASS || echo FAIL"
    expected: "PASS"

# ============================================================
# SECTION 14: GOVERNANCE
# ============================================================

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Reliability"]

# ============================================================
# SECTION 15: RELATIONSHIPS
# ============================================================

relationships:
  commonly_combined:
    - "code-quality.static-analysis.type-safety"
    - "code-quality.testing.unit-test-coverage"
