# ============================================================
# AUDIT FILE - Code Complexity v1.0
# ============================================================

# ============================================================
# SECTION 1: IDENTITY & METADATA
# ============================================================

audit:
  id: "code-quality.static-analysis.code-complexity"

  name: "Code Complexity"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "static-analysis"

  tier: "expert"
  estimated_duration: "2-4 hours"  # median: 3h

  completeness: "complete"
  requires_runtime: false
  destructive: false

# ============================================================
# SECTION 2: EXECUTION CLASSIFICATION
# ============================================================

execution:
  automatable: "yes"

  severity: "high"

  scope: "codebase"

  default_profiles:
    - "full"

  blocks_phase: false
  parallelizable: true

# ============================================================
# SECTION 3: DESCRIPTION & RATIONALE
# ============================================================

description:
  what: |
    Analyzes code complexity metrics across the codebase including cyclomatic
    complexity, cognitive complexity, nesting depth, function length, and
    coupling metrics. Identifies modules and functions that exceed complexity
    thresholds and present maintainability risks.

  why_it_matters: |
    High code complexity directly correlates with increased bug density,
    longer debugging time, and higher maintenance costs. Complex code is
    harder to test, review, and modify safely. Uncontrolled complexity
    growth leads to eventual codebase ossification.

  when_to_run:
    - "Initial codebase assessment"
    - "Before major refactoring efforts"
    - "During code review for complex changes"
    - "Periodic quality monitoring"

# ============================================================
# SECTION 4: PREREQUISITES
# ============================================================

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Complete source code repository"

  access_requirements:
    - "Read access to source code"
    - "Ability to run complexity analysis tools"

# ============================================================
# SECTION 5: DISCOVERY SPECIFICATION
# ============================================================

discovery:
  file_patterns:
    - glob: "**/*.py"
      purpose: "Python source files for complexity analysis"
    - glob: "**/*.js"
      purpose: "JavaScript source files"
    - glob: "**/*.ts"
      purpose: "TypeScript source files"
    - glob: "**/*.java"
      purpose: "Java source files"
    - glob: "**/*.go"
      purpose: "Go source files"
    - glob: "**/*.rb"
      purpose: "Ruby source files"

  code_patterns:
    - pattern: "\\bif\\b.*\\bif\\b.*\\bif\\b"
      type: "regex"
      scope: "source"
      purpose: "Detect deeply nested conditionals"
    - pattern: "def\\s+\\w+\\([^)]{100,}\\)"
      type: "regex"
      scope: "source"
      purpose: "Detect functions with many parameters"

# ============================================================
# SECTION 6: EXTERNAL KNOWLEDGE SOURCES
# ============================================================

knowledge_sources:
  specifications:
    - id: "mccabe-complexity"
      name: "A Complexity Measure (McCabe 1976)"
      url: "https://ieeexplore.ieee.org/document/1702388"
      offline_cache: true
      priority: "required"

  guides:
    - id: "cognitive-complexity"
      name: "Cognitive Complexity - A New Way of Measuring Understandability"
      url: "https://www.sonarsource.com/docs/CognitiveComplexity.pdf"
      offline_cache: true

    - id: "nist-800-218"
      name: "NIST SP 800-218 - Secure Software Development Framework"
      url: "https://csrc.nist.gov/publications/detail/sp/800-218/final"
      offline_cache: false

  papers:
    - id: "complexity-bugs"
      title: "The Relationship Between Class Size and Defects"
      url: "https://ieeexplore.ieee.org/document/4343802"

# ============================================================
# SECTION 7: TOOLING & AUTOMATION
# ============================================================

tooling:
  static_analysis:
    - tool: "radon"
      purpose: "Python cyclomatic complexity and maintainability index"
      offline_capable: true
    - tool: "lizard"
      purpose: "Multi-language complexity analyzer"
      offline_capable: true
    - tool: "eslint-plugin-complexity"
      purpose: "JavaScript/TypeScript complexity checking"
      offline_capable: true
    - tool: "SonarQube"
      purpose: "Comprehensive code quality including cognitive complexity"
      offline_capable: false
    - tool: "gocyclo"
      purpose: "Go cyclomatic complexity"
      offline_capable: true

  scripts:
    - id: "complexity-summary"
      language: "bash"
      purpose: "Generate complexity summary using radon"
      source: "inline"
      code: |
        #!/bin/bash
        radon cc . -a -s --total-average 2>/dev/null || echo "radon not installed"

# ============================================================
# SECTION 8: SIGNALS & FINDINGS TAXONOMY
# ============================================================

signals:
  critical:
    - id: "CMPLX-CRIT-001"
      signal: "Functions with cyclomatic complexity > 30"
      evidence_pattern: "radon cc output showing rank F or complexity > 30"
      explanation: |
        Extreme complexity makes code virtually untestable and nearly
        impossible to maintain safely. These functions are high-risk
        areas for bugs and should be prioritized for refactoring.
      remediation: "Break down into smaller, focused functions; apply extract method refactoring"

  high:
    - id: "CMPLX-HIGH-001"
      signal: "Functions with cyclomatic complexity 15-30"
      evidence_pattern: "radon cc output showing rank D/E"
      explanation: |
        High complexity functions require extensive testing and are
        prone to subtle bugs during modification.
      remediation: "Refactor to reduce branching; consider state pattern or strategy pattern"

    - id: "CMPLX-HIGH-002"
      signal: "Nesting depth exceeding 5 levels"
      evidence_pattern: "Multiple nested if/for/while statements"
      explanation: |
        Deep nesting makes code hard to follow and increases
        cognitive load during review and maintenance.
      remediation: "Use early returns, guard clauses, or extract helper functions"

  medium:
    - id: "CMPLX-MED-001"
      signal: "Functions with cyclomatic complexity 10-15"
      remediation: "Consider simplification during next modification"

    - id: "CMPLX-MED-002"
      signal: "Functions exceeding 50 lines"
      remediation: "Extract logical sections into well-named helper functions"

    - id: "CMPLX-MED-003"
      signal: "Classes with more than 20 methods"
      remediation: "Apply single responsibility principle; consider splitting class"

  low:
    - id: "CMPLX-LOW-001"
      signal: "Functions with more than 5 parameters"

  positive:
    - id: "CMPLX-POS-001"
      signal: "Average complexity below 5 across codebase"
    - id: "CMPLX-POS-002"
      signal: "No functions exceed complexity of 15"

# ============================================================
# SECTION 9: EXECUTION PROCEDURE
# ============================================================

procedure:
  context:
    cognitive_mode: "evaluative"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Run cyclomatic complexity analysis"
      description: |
        Execute complexity analysis tools to measure cyclomatic
        complexity across all source files.
      duration_estimate: "20 min"
      commands:
        - purpose: "Analyze Python complexity with radon"
          command: "radon cc . -a -s --show-complexity 2>/dev/null | head -100"
        - purpose: "Multi-language analysis with lizard"
          command: "lizard . --CCN 15 2>/dev/null | head -50"
      expected_findings:
        - "Complexity scores per function"
        - "Average complexity metrics"

    - id: "2"
      name: "Identify high-complexity hotspots"
      description: |
        Filter results to identify functions and modules that
        exceed recommended complexity thresholds.
      duration_estimate: "15 min"
      commands:
        - purpose: "Find functions with complexity > 15"
          command: "radon cc . -a -nc 2>/dev/null | grep -E '^\\s+[A-F]' | head -30"
      expected_findings:
        - "List of functions exceeding thresholds"
        - "Worst offenders ranked by complexity"

    - id: "3"
      name: "Analyze nesting depth"
      description: |
        Examine code for excessive nesting which contributes
        to cognitive complexity.
      duration_estimate: "15 min"
      expected_findings:
        - "Functions with deep nesting"
        - "Patterns contributing to nesting"

    - id: "4"
      name: "Calculate maintainability index"
      description: |
        Compute maintainability index which combines complexity,
        volume, and other metrics into overall score.
      duration_estimate: "10 min"
      commands:
        - purpose: "Calculate maintainability index"
          command: "radon mi . -s 2>/dev/null | grep -E '^[A-C]' | head -30"
      expected_findings:
        - "Maintainability scores per module"
        - "Modules requiring attention"

    - id: "5"
      name: "Review complexity trends"
      description: |
        If historical data available, analyze complexity trends
        to identify growth patterns.
      duration_estimate: "20 min"
      expected_findings:
        - "Complexity change over time"
        - "Areas of increasing complexity"

# ============================================================
# SECTION 10: OUTPUT SPECIFICATION
# ============================================================

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Complexity Metrics Overview"
        - "High-Risk Functions"
        - "Refactoring Recommendations"

    - type: "metrics"
      format: "table"
      fields:
        - "average_cyclomatic_complexity"
        - "max_cyclomatic_complexity"
        - "functions_above_threshold"
        - "maintainability_index"

  confidence_guidance:
    high: "Complexity calculated with established tools on complete codebase"
    medium: "Partial codebase analyzed or some languages unsupported"
    low: "Manual estimation without tooling"

# ============================================================
# SECTION 11: OFFLINE SUPPORT
# ============================================================

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "cognitive-complexity"
        priority: "recommended"

# ============================================================
# SECTION 12: PROFILES
# ============================================================

profiles:
  membership:
    quick:
      included: false
      reason: "Detailed complexity analysis requires time"
    full:
      included: true
      priority: 1

# ============================================================
# SECTION 13: DETERMINISTIC VERIFICATION
# ============================================================

closeout_checklist:
  - id: "code-complexity-001"
    item: "No functions with cyclomatic complexity > 30"
    level: "CRITICAL"
    verification: "radon cc . -nc 2>/dev/null | grep -c ' F ' | xargs test 0 -eq && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "code-complexity-002"
    item: "Average complexity below 10"
    level: "BLOCKING"
    verification: "manual"
    verification_notes: "Review average complexity from radon output"
    expected: "Confirmed by reviewer"

  - id: "code-complexity-003"
    item: "High-complexity functions documented or scheduled for refactoring"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Check that complex functions have TODO comments or tracking issues"
    expected: "Confirmed by reviewer"

# ============================================================
# SECTION 14: GOVERNANCE
# ============================================================

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Analysability"]

# ============================================================
# SECTION 15: RELATIONSHIPS
# ============================================================

relationships:
  commonly_combined:
    - "code-quality.static-analysis.dead-code-detection"
    - "code-quality.testing.unit-test-coverage"
    - "code-quality.testing.mutation-testing"
