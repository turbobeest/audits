# ============================================================
# AUDIT: Cohesion Analysis
# ============================================================

audit:
  id: "code-quality.maintainability.cohesion"
  name: "Cohesion Analysis Audit"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "maintainability"

  tier: "expert"
  estimated_duration: "1 hour"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "quality"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Measures the cohesion of classes and modules - how closely related the
    internal elements are. Evaluates Lack of Cohesion of Methods (LCOM),
    identifies classes with mixed responsibilities, and finds modules that
    should be split or merged.

  why_it_matters: |
    Low cohesion indicates a class or module is doing too many unrelated things,
    violating the Single Responsibility Principle. Highly cohesive code is easier
    to understand, test, and maintain. Research shows low-cohesion classes have
    6x higher defect probability than high-cohesion classes.

  when_to_run:
    - "Architecture reviews"
    - "Refactoring planning"
    - "Code quality assessments"
    - "Design principle validation"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Application source code"

  access_requirements:
    - "Read access to source code"

discovery:
  code_patterns:
    - pattern: "class\\s+\\w+|interface\\s+\\w+|module\\s+\\w+"
      type: "regex"
      scope: "source"
      purpose: "Identify class and module definitions"

  file_patterns:
    - glob: "**/*.{js,ts,py,java,go,rb,cs}"
      purpose: "Source code files"

knowledge_sources:
  specifications:
    - id: "lcom-metrics"
      name: "LCOM Metrics - Chidamber & Kemerer"
      url: "https://www.aivosto.com/project/help/pm-oo-cohesion.html"
      offline_cache: true
      priority: "required"

  guides:
    - id: "clean-code"
      name: "Robert C. Martin - Clean Code"
      url: "https://www.oreilly.com/library/view/clean-code-a/9780136083238/"
      offline_cache: false

    - id: "pragmatic-programmer"
      name: "The Pragmatic Programmer"
      url: "https://pragprog.com/titles/tpp20/the-pragmatic-programmer-20th-anniversary-edition/"
      offline_cache: false

tooling:
  static_analysis:
    - tool: "ck"
      purpose: "Java cohesion metrics"
      offline_capable: true
    - tool: "sonarqube"
      purpose: "Multi-language cohesion analysis"
      offline_capable: true

  scripts:
    - id: "cohesion-check"
      language: "bash"
      purpose: "Find classes with many methods"
      source: "inline"
      code: |
        grep -rn "^\s*\(public\|private\|protected\)\s.*(" --include="*.java" . | \
          cut -d: -f1 | sort | uniq -c | sort -rn | head -20

signals:
  critical:
    - id: "COH-CRIT-001"
      signal: "Classes with LCOM > 0.9"
      evidence_pattern: "lcom > 0.9"
      explanation: |
        Extremely low cohesion indicates a "god class" that does many
        unrelated things. Such classes are maintenance nightmares and
        defect magnets.
      remediation: "Split into multiple focused classes"

    - id: "COH-CRIT-002"
      signal: "Classes with >30 methods and low cohesion"
      evidence_pattern: "method_count > 30 && lcom > 0.7"
      explanation: |
        Large classes with low cohesion are extremely difficult to
        understand and maintain as a whole.
      remediation: "Identify method clusters and extract to new classes"

  high:
    - id: "COH-HIGH-001"
      signal: "Classes with LCOM between 0.7-0.9"
      evidence_pattern: "0.7 <= lcom <= 0.9"
      explanation: |
        Moderate cohesion issues indicate mixed responsibilities
        that should be separated for clarity.
      remediation: "Review class for responsibility separation"

    - id: "COH-HIGH-002"
      signal: "Utility classes with unrelated static methods"
      evidence_pattern: "utility_class && low_cohesion"
      explanation: |
        Utility classes often become dumping grounds for unrelated
        functions, creating hidden coupling.
      remediation: "Group related utilities into domain-specific classes"

  medium:
    - id: "COH-MED-001"
      signal: "Average LCOM > 0.5 across codebase"
      evidence_pattern: "avg_lcom > 0.5"
      remediation: "Systematic improvement of class design"

  low:
    - id: "COH-LOW-001"
      signal: "No cohesion analysis tooling"
      evidence_pattern: "no_cohesion_tools"
      remediation: "Add cohesion metrics to quality gates"

  positive:
    - id: "COH-POS-001"
      signal: "Average LCOM < 0.3"
      evidence_pattern: "avg_lcom < 0.3"
    - id: "COH-POS-002"
      signal: "Classes follow single responsibility"
      evidence_pattern: "srp_compliance_high"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Calculate Cohesion Metrics"
      description: |
        Compute LCOM and related cohesion metrics for all classes
        and modules in the codebase.
      duration_estimate: "20 min"
      expected_findings:
        - "Per-class LCOM scores"
        - "Method-field relationship analysis"

    - id: "2"
      name: "Identify Low-Cohesion Classes"
      description: |
        Find classes with cohesion issues and analyze their
        internal structure.
      duration_estimate: "20 min"
      expected_findings:
        - "Classes with LCOM > 0.7"
        - "Method clusters within classes"

    - id: "3"
      name: "Analyze Responsibility Distribution"
      description: |
        Examine low-cohesion classes to identify distinct
        responsibilities that could be separated.
      duration_estimate: "15 min"
      expected_findings:
        - "Identified responsibilities per class"
        - "Proposed class splits"

    - id: "4"
      name: "Generate Refactoring Recommendations"
      description: |
        Create actionable recommendations for improving cohesion
        in problematic areas.
      duration_estimate: "5 min"
      expected_findings:
        - "Prioritized refactoring list"
        - "New class structure proposals"

output:
  deliverables:
    - type: "metrics"
      format: "structured"
      content:
        - "class_lcom_scores"
        - "avg_cohesion"
        - "low_cohesion_class_list"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Cohesion Metrics"
        - "Refactoring Recommendations"

  confidence_guidance:
    high: "Full LCOM analysis with tooling"
    medium: "Partial analysis or heuristic assessment"
    low: "Manual review only"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "lcom-metrics"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires detailed class analysis"
    full:
      included: true
      priority: 2
    quality:
      included: true
      priority: 1

closeout_checklist:
  - id: "coh-001"
    item: "Cohesion metrics calculated"
    level: "BLOCKING"
    verification: "LCOM scores available"
    expected: "Per-class cohesion data"

  - id: "coh-002"
    item: "Low-cohesion classes documented"
    level: "WARNING"
    verification: "List of LCOM > 0.7"
    expected: "Refactoring candidates identified"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Modularity"]

relationships:
  commonly_combined:
    - "code-quality.maintainability.coupling"
    - "code-quality.maintainability.function-length"
    - "code-quality.architecture-design.solid-principles"
