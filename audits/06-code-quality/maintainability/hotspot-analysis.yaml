# ============================================================
# AUDIT: Hotspot Analysis
# ============================================================

audit:
  id: "code-quality.maintainability.hotspot-analysis"
  name: "Hotspot Analysis Audit"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "maintainability"

  tier: "expert"
  estimated_duration: "1 hour"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "repository"

  default_profiles:
    - "full"
    - "quality"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Identifies code hotspots by combining complexity metrics with change frequency
    data. Files that are both complex and frequently changed represent the highest
    risk areas for defects and maintenance burden. Uses temporal-structural analysis
    to prioritize refactoring efforts.

  why_it_matters: |
    Hotspots are the 20% of code responsible for 80% of bugs and maintenance effort.
    Research in "Your Code as a Crime Scene" shows that combining complexity with
    change frequency predicts defects better than either metric alone. Focusing
    refactoring efforts on hotspots yields the highest ROI for code quality improvement.

  when_to_run:
    - "Refactoring prioritization"
    - "Technical debt planning"
    - "Resource allocation decisions"
    - "Quarterly quality reviews"

prerequisites:
  required_artifacts:
    - type: "git_history"
      description: "Git repository with commit history"
    - type: "source_code"
      description: "Application source code for complexity analysis"

  access_requirements:
    - "Read access to git repository"
    - "Read access to source code"

discovery:
  file_patterns:
    - glob: "**/*.{js,ts,py,java,go,rb,cs}"
      purpose: "Source code files"

knowledge_sources:
  specifications:
    - id: "code-crime-scene"
      name: "Your Code as a Crime Scene"
      url: "https://pragprog.com/titles/atcrime/your-code-as-a-crime-scene/"
      offline_cache: true
      priority: "required"

  guides:
    - id: "clean-code"
      name: "Robert C. Martin - Clean Code"
      url: "https://www.oreilly.com/library/view/clean-code-a/9780136083238/"
      offline_cache: false

    - id: "pragmatic-programmer"
      name: "The Pragmatic Programmer"
      url: "https://pragprog.com/titles/tpp20/the-pragmatic-programmer-20th-anniversary-edition/"
      offline_cache: false

tooling:
  static_analysis:
    - tool: "code-maat"
      purpose: "Temporal analysis and hotspot detection"
      offline_capable: true
    - tool: "lizard"
      purpose: "Complexity metrics"
      offline_capable: true

  scripts:
    - id: "hotspot-analysis"
      language: "bash"
      purpose: "Identify code hotspots"
      source: "inline"
      code: |
        # Combine change frequency with complexity
        git log --format= --name-only --since="180 days ago" | \
          sort | uniq -c | sort -rn | head -20

signals:
  critical:
    - id: "HS-CRIT-001"
      signal: "Hotspots with complexity > 50 and weekly changes"
      evidence_pattern: "complexity > 50 && changes_per_week > 1"
      explanation: |
        Files with extreme complexity that change frequently are
        critical maintenance and defect risks. They demand immediate
        attention and significant refactoring investment.
      remediation: "Prioritize for immediate refactoring"

    - id: "HS-CRIT-002"
      signal: "Core infrastructure files as hotspots"
      evidence_pattern: "core_file && hotspot_score > 90"
      explanation: |
        When foundational code is also a hotspot, instability
        affects the entire system.
      remediation: "Stabilize core infrastructure as top priority"

  high:
    - id: "HS-HIGH-001"
      signal: "Multiple hotspots in single module"
      evidence_pattern: "module_hotspot_count > 3"
      explanation: |
        Concentration of hotspots indicates a module with systemic
        quality issues that needs comprehensive attention.
      remediation: "Consider module-level refactoring or rewrite"

    - id: "HS-HIGH-002"
      signal: "Growing hotspot intensity over time"
      evidence_pattern: "hotspot_trend_increasing"
      explanation: |
        Hotspots getting worse indicates the code is accumulating
        technical debt faster than it's being addressed.
      remediation: "Allocate dedicated refactoring capacity"

  medium:
    - id: "HS-MED-001"
      signal: "Hotspots with low test coverage"
      evidence_pattern: "hotspot && coverage < 50%"
      remediation: "Add tests before refactoring"

  low:
    - id: "HS-LOW-001"
      signal: "No hotspot analysis performed"
      evidence_pattern: "no_hotspot_tracking"
      remediation: "Add hotspot analysis to quality metrics"

  positive:
    - id: "HS-POS-001"
      signal: "Hotspot count decreasing over time"
      evidence_pattern: "hotspot_count_decreasing"
    - id: "HS-POS-002"
      signal: "Critical hotspots addressed in last quarter"
      evidence_pattern: "critical_hotspots_resolved"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Calculate Change Frequency"
      description: |
        Extract change frequency data from git history for all
        source files.
      duration_estimate: "15 min"
      commands:
        - purpose: "Get change frequency"
          command: |
            git log --format= --name-only --since="180 days ago" | \
              sort | uniq -c | sort -rn > /tmp/change_freq.txt && head -30 /tmp/change_freq.txt
      expected_findings:
        - "Per-file change counts"
        - "Change frequency distribution"

    - id: "2"
      name: "Measure Complexity"
      description: |
        Run complexity analysis on all source files to get
        complexity scores.
      duration_estimate: "15 min"
      commands:
        - purpose: "Run complexity analysis"
          command: |
            lizard -l python -l javascript -l java -l go . 2>/dev/null | head -50
      expected_findings:
        - "Per-file complexity scores"
        - "Complexity distribution"

    - id: "3"
      name: "Calculate Hotspot Scores"
      description: |
        Combine frequency and complexity to compute hotspot
        scores for all files.
      duration_estimate: "15 min"
      expected_findings:
        - "Hotspot score per file"
        - "Ranked hotspot list"

    - id: "4"
      name: "Analyze and Prioritize"
      description: |
        Review top hotspots and create prioritized refactoring
        recommendations.
      duration_estimate: "15 min"
      expected_findings:
        - "Top 10 hotspots"
        - "Refactoring priorities"

output:
  deliverables:
    - type: "metrics"
      format: "structured"
      content:
        - "hotspot_scores"
        - "top_hotspots"
        - "hotspot_trend"
        - "module_concentration"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Hotspot Analysis"
        - "Trend Analysis"
        - "Refactoring Recommendations"

  confidence_guidance:
    high: "Full temporal-structural analysis"
    medium: "Frequency or complexity only"
    low: "Manual assessment"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "code-crime-scene"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires extensive analysis"
    full:
      included: true
      priority: 1
    quality:
      included: true
      priority: 1

closeout_checklist:
  - id: "hs-001"
    item: "Hotspot analysis completed"
    level: "BLOCKING"
    verification: "Scores calculated"
    expected: "Ranked hotspot list"

  - id: "hs-002"
    item: "Refactoring priorities established"
    level: "WARNING"
    verification: "Prioritized action items"
    expected: "Clear next steps"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability"]

relationships:
  commonly_combined:
    - "code-quality.maintainability.cyclomatic-complexity"
    - "code-quality.maintainability.change-frequency"
    - "code-quality.maintainability.code-churn"
    - "code-quality.technical-debt.debt-assessment"
