# ============================================================
# AUDIT: Coupling Analysis
# ============================================================

audit:
  id: "code-quality.maintainability.coupling"
  name: "Coupling Analysis Audit"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "maintainability"

  tier: "expert"
  estimated_duration: "1 hour"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "quality"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Analyzes coupling between modules, classes, and components in the codebase.
    Measures afferent coupling (Ca - incoming dependencies), efferent coupling
    (Ce - outgoing dependencies), and instability (I = Ce / (Ca + Ce)).
    Identifies tightly coupled components that resist change.

  why_it_matters: |
    High coupling is the primary cause of "ripple effect" where changes in
    one module cascade throughout the system. Studies show highly coupled
    systems have 4x higher defect rates and take 3x longer to modify safely.
    Loose coupling is fundamental to maintainable, testable, and evolvable
    software architecture.

  when_to_run:
    - "Architecture reviews"
    - "Before major refactoring"
    - "Monolith decomposition"
    - "Technical debt assessments"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Application source code"
    - type: "dependency_graph"
      description: "Module dependency information"

  access_requirements:
    - "Read access to source code"
    - "Build system access for dependency analysis"

discovery:
  code_patterns:
    - pattern: "import|require|from|include"
      type: "regex"
      scope: "source"
      purpose: "Identify dependency declarations"

  file_patterns:
    - glob: "**/*.{js,ts,py,java,go}"
      purpose: "Source code files"
    - glob: "**/package.json"
      purpose: "Node.js dependencies"
    - glob: "**/go.mod"
      purpose: "Go dependencies"

knowledge_sources:
  specifications:
    - id: "martin-metrics"
      name: "Robert Martin - OO Metrics"
      url: "https://www.oreilly.com/library/view/agile-software-development/0135974445/"
      offline_cache: true
      priority: "required"

  guides:
    - id: "clean-code"
      name: "Robert C. Martin - Clean Code"
      url: "https://www.oreilly.com/library/view/clean-code-a/9780136083238/"
      offline_cache: false

    - id: "pragmatic-programmer"
      name: "The Pragmatic Programmer"
      url: "https://pragprog.com/titles/tpp20/the-pragmatic-programmer-20th-anniversary-edition/"
      offline_cache: false

tooling:
  static_analysis:
    - tool: "dependency-cruiser"
      purpose: "JavaScript/TypeScript dependency analysis"
      offline_capable: true
    - tool: "jdepend"
      purpose: "Java coupling metrics"
      offline_capable: true
    - tool: "structure101"
      purpose: "Multi-language architecture analysis"
      offline_capable: true

  scripts:
    - id: "coupling-analysis"
      language: "bash"
      purpose: "Basic coupling analysis"
      source: "inline"
      code: |
        npx depcruise --output-type text . 2>/dev/null

signals:
  critical:
    - id: "COUP-CRIT-001"
      signal: "Circular dependencies between modules"
      evidence_pattern: "circular_dependency_found"
      cwe: "CWE-1047"
      explanation: |
        Circular dependencies create compile-time issues, runtime initialization
        problems, and make independent testing impossible. They indicate
        architectural boundary violations.
      remediation: "Break cycles by introducing interfaces or restructuring"

    - id: "COUP-CRIT-002"
      signal: "God modules with >50 dependents"
      evidence_pattern: "afferent_coupling > 50"
      explanation: |
        Modules with extreme inbound coupling become change bottlenecks.
        Any modification risks breaking dozens of dependent modules.
      remediation: "Decompose into smaller, focused modules"

  high:
    - id: "COUP-HIGH-001"
      signal: "High coupling between layers"
      evidence_pattern: "cross_layer_coupling_high"
      explanation: |
        Direct dependencies between distant layers (e.g., UI to database)
        violate separation of concerns and create brittleness.
      remediation: "Introduce proper layer abstraction and interfaces"

    - id: "COUP-HIGH-002"
      signal: "Modules with instability near 0 or 1 exclusively"
      evidence_pattern: "instability_extreme"
      explanation: |
        Healthy systems have a mix of stable (low instability) and flexible
        (high instability) modules. All-or-nothing indicates poor design.
      remediation: "Review dependency directions and abstract stable components"

  medium:
    - id: "COUP-MED-001"
      signal: "Average efferent coupling > 10"
      evidence_pattern: "avg_efferent > 10"
      remediation: "Reduce external dependencies in modules"

  low:
    - id: "COUP-LOW-001"
      signal: "No coupling analysis tooling"
      evidence_pattern: "no_coupling_tools"
      remediation: "Add dependency analysis to CI pipeline"

  positive:
    - id: "COUP-POS-001"
      signal: "No circular dependencies"
      evidence_pattern: "circular_count == 0"
    - id: "COUP-POS-002"
      signal: "Clear layer separation maintained"
      evidence_pattern: "layer_violations == 0"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Generate Dependency Graph"
      description: |
        Build a complete dependency graph of the codebase showing
        all inter-module relationships.
      duration_estimate: "15 min"
      commands:
        - purpose: "Generate dependency graph"
          command: |
            npx depcruise --output-type dot src | dot -T svg > deps.svg 2>/dev/null
        - purpose: "Check for violations"
          command: |
            npx depcruise --validate . 2>/dev/null
      expected_findings:
        - "Dependency graph visualization"
        - "Module connection inventory"

    - id: "2"
      name: "Calculate Coupling Metrics"
      description: |
        Compute afferent and efferent coupling for each module
        and derive instability metrics.
      duration_estimate: "15 min"
      expected_findings:
        - "Ca/Ce per module"
        - "Instability scores"

    - id: "3"
      name: "Detect Circular Dependencies"
      description: |
        Identify any cycles in the dependency graph that need
        to be broken.
      duration_estimate: "15 min"
      expected_findings:
        - "Circular dependency list"
        - "Cycle participants"

    - id: "4"
      name: "Analyze Architecture Layers"
      description: |
        Verify that dependencies respect architectural layer
        boundaries.
      duration_estimate: "15 min"
      expected_findings:
        - "Layer violation list"
        - "Coupling patterns"

output:
  deliverables:
    - type: "metrics"
      format: "structured"
      content:
        - "module_coupling_scores"
        - "circular_dependencies"
        - "layer_violations"
        - "instability_distribution"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Coupling Metrics"
        - "Architecture Analysis"
        - "Recommendations"

  confidence_guidance:
    high: "Full dependency graph with metrics"
    medium: "Partial analysis or sampling"
    low: "Manual inspection only"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "martin-metrics"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires extensive analysis"
    full:
      included: true
      priority: 1
    quality:
      included: true
      priority: 1

closeout_checklist:
  - id: "coup-001"
    item: "Dependency graph generated"
    level: "BLOCKING"
    verification: "Graph available for review"
    expected: "Complete module graph"

  - id: "coup-002"
    item: "No critical circular dependencies"
    level: "CRITICAL"
    verification: "Cycle detection run"
    expected: "Zero or documented cycles"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Modularity"]

relationships:
  commonly_combined:
    - "code-quality.maintainability.cohesion"
    - "code-quality.maintainability.dependency-depth"
    - "code-quality.architecture-design.modularity"
