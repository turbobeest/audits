# ============================================================
# AUDIT: Generic and Template Usage Analysis
# ============================================================

audit:
  id: "code-quality.type-safety.generic-template-usage"
  name: "Generic and Template Usage Analysis Audit"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "code-quality"
  category_number: 6
  subcategory: "type-safety"

  tier: "expert"
  estimated_duration: "40 minutes"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "codebase"

  default_profiles:
    - "full"
    - "quality"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the use of generic types, type parameters, and templates
    throughout the codebase. Identifies opportunities to use generics for
    type safety, detects misuse of generics that reduces type safety (raw
    types, Any bounds), and assesses generic constraint appropriateness.

  why_it_matters: |
    Generics enable type-safe code reuse without sacrificing compile-time
    checking. Proper use of generics catches type errors at compile time
    rather than runtime. Misuse of generics (raw types, overly broad
    constraints) undermines type safety. Studies show that proper generic
    usage reduces runtime type errors by 25-40%.

  when_to_run:
    - "Library design reviews"
    - "API design reviews"
    - "Code quality assessments"
    - "Refactoring planning"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Application source code"

  access_requirements:
    - "Read access to source code"

discovery:
  code_patterns:
    - pattern: "Generic\\[|TypeVar\\(|<T>|<T,|<T\\s"
      type: "regex"
      scope: "source"
      purpose: "Generic type definitions"
    - pattern: "List\\[|Dict\\[|Set\\[|Optional\\["
      type: "regex"
      scope: "source"
      purpose: "Parameterized container types"
    - pattern: "List<|Map<|Set<|Array<"
      type: "regex"
      scope: "source"
      purpose: "Java/TypeScript generics"
    - pattern: "Any\\]|object\\]|Object>"
      type: "regex"
      scope: "source"
      purpose: "Overly broad generic parameters"

  file_patterns:
    - glob: "**/*.{py,ts,java,cs,kt,go}"
      purpose: "Languages with generics support"

knowledge_sources:
  specifications:
    - id: "pep484-generics"
      name: "PEP 484 - Generics"
      url: "https://peps.python.org/pep-0484/#generics"
      offline_cache: true
      priority: "recommended"

    - id: "typescript-generics"
      name: "TypeScript Generics"
      url: "https://www.typescriptlang.org/docs/handbook/2/generics.html"
      offline_cache: true
      priority: "recommended"

  guides:
    - id: "effective-java"
      name: "Effective Java - Generics"
      url: "https://www.oreilly.com/library/view/effective-java-3rd/9780134686097/"
      offline_cache: true

  learning_resources:
    - id: "effective-java-book"
      title: "Effective Java, 3rd Edition"
      type: "book"
      reference: "ISBN: 978-0134685991, Chapter 5"

tooling:
  static_analysis:
    - tool: "mypy"
      purpose: "Python generic type checking"
      offline_capable: true
    - tool: "typescript"
      purpose: "TypeScript generic analysis"
      offline_capable: true
    - tool: "errorprone"
      purpose: "Java raw type detection"
      offline_capable: true

  scripts:
    - id: "generic-scan"
      language: "bash"
      purpose: "Analyze generic usage patterns"
      source: "inline"
      code: |
        # Find Python TypeVar definitions
        grep -rn --include="*.py" "TypeVar\|Generic\[" . 2>/dev/null | head -20
        # Find parameterized types
        grep -rn --include="*.py" "List\[\|Dict\[\|Set\[\|Optional\[" . 2>/dev/null | wc -l
        # Find overly broad generics
        grep -rn --include="*.py" "\[Any\]\|\[object\]" . 2>/dev/null | head -15

signals:
  critical:
    - id: "GTU-CRIT-001"
      signal: "Raw types used in security-critical code"
      evidence_pattern: "Unparameterized List/Map in auth code"
      explanation: |
        Raw types (List instead of List[User]) in security code bypass
        type checking entirely. This can lead to type confusion attacks
        and undetected bugs in critical paths.
      remediation: "Add proper type parameters to all generic usages"

    - id: "GTU-CRIT-002"
      signal: "Generic containers with Any type parameter"
      evidence_pattern: "List[Any], Dict[str, Any] in core logic"
      explanation: |
        Using Any as a generic parameter defeats the purpose of generics.
        Any allows any value without type checking, creating holes in
        the type system that bugs can flow through undetected.
      remediation: "Replace Any with specific types or bounded TypeVars"

  high:
    - id: "GTU-HIGH-001"
      signal: "Inconsistent generic usage in similar APIs"
      evidence_pattern: "Some functions typed, others raw"
      explanation: |
        Inconsistent generic usage creates confusion about which code
        is type-safe. Mixing typed and raw APIs leads to type safety
        erosion as raw usage patterns spread.
      remediation: "Standardize on fully typed generic APIs"

    - id: "GTU-HIGH-002"
      signal: "Generic constraints too broad for intended use"
      evidence_pattern: "TypeVar without bounds when bounds needed"
      explanation: |
        Generic types without appropriate bounds allow values that
        don't support needed operations, leading to runtime errors
        that could be caught at type-check time.
      remediation: "Add appropriate bounds to TypeVars"

  medium:
    - id: "GTU-MED-001"
      signal: "Missed opportunity for generic abstraction"
      evidence_pattern: "Duplicate code with different types"
      remediation: "Introduce generic function or class"

    - id: "GTU-MED-002"
      signal: "Complex nested generic types without aliases"
      evidence_pattern: "Dict[str, List[Tuple[int, str]]]"
      remediation: "Create type aliases for complex generics"

  low:
    - id: "GTU-LOW-001"
      signal: "Single-use TypeVar definitions"
      evidence_pattern: "TypeVar used in only one function"
      remediation: "Consider if generic is needed"

  positive:
    - id: "GTU-POS-001"
      signal: "Consistent use of parameterized types"
    - id: "GTU-POS-002"
      signal: "Type aliases for complex generics"
    - id: "GTU-POS-003"
      signal: "Appropriate TypeVar bounds"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Generic Definitions"
      description: |
        Find all TypeVar definitions, generic classes, and
        parameterized type usages.
      duration_estimate: "10 min"
      commands:
        - purpose: "Find TypeVar definitions"
          command: |
            grep -rn --include="*.py" "TypeVar(" . 2>/dev/null | head -15
        - purpose: "Find Generic class usage"
          command: |
            grep -rn --include="*.py" "Generic\[" . 2>/dev/null | head -15
        - purpose: "Count parameterized types"
          command: |
            grep -roh --include="*.py" "List\[\|Dict\[\|Set\[\|Tuple\[" . 2>/dev/null | sort | uniq -c
      expected_findings:
        - "TypeVar definitions"
        - "Generic class usages"
        - "Parameterization patterns"

    - id: "2"
      name: "Detect Raw Types"
      description: |
        Find uses of generic types without type parameters.
      duration_estimate: "8 min"
      commands:
        - purpose: "Find potential raw list usage"
          command: |
            grep -rn --include="*.py" ": list\b\|: dict\b\|: set\b" . 2>/dev/null | grep -v "List\[\|Dict\[\|Set\[" | head -15
        - purpose: "Find Java raw types"
          command: |
            grep -rn --include="*.java" "List \|Map \|Set " . 2>/dev/null | grep -v "List<\|Map<\|Set<" | head -15
      expected_findings:
        - "Raw type locations"
        - "Unparameterized usages"

    - id: "3"
      name: "Analyze Any Usage in Generics"
      description: |
        Find generic types parameterized with Any or object.
      duration_estimate: "10 min"
      commands:
        - purpose: "Find Any in generic parameters"
          command: |
            grep -rn --include="*.py" "\[Any\]\|\[Any,\|, Any\]" . 2>/dev/null | head -20
        - purpose: "Find Dict with Any values"
          command: |
            grep -rn --include="*.py" "Dict\[str,\s*Any\]" . 2>/dev/null | head -15
        - purpose: "Find broad object bounds"
          command: |
            grep -rn --include="*.py" "\[object\]" . 2>/dev/null | head -10
      expected_findings:
        - "Any usage in generics"
        - "Overly broad types"

    - id: "4"
      name: "Review TypeVar Bounds"
      description: |
        Check that TypeVars have appropriate bounds and
        constraints.
      duration_estimate: "12 min"
      commands:
        - purpose: "Find TypeVars with bounds"
          command: |
            grep -rn --include="*.py" "TypeVar(.*bound=" . 2>/dev/null | head -15
        - purpose: "Find TypeVars without bounds"
          command: |
            grep -rn --include="*.py" "TypeVar(" . 2>/dev/null | grep -v "bound=" | head -15
        - purpose: "Find covariant/contravariant TypeVars"
          command: |
            grep -rn --include="*.py" "covariant=\|contravariant=" . 2>/dev/null | head -10
      expected_findings:
        - "Bounded TypeVars"
        - "Unbounded TypeVars"
        - "Variance specifications"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      content:
        - "raw_type_usages"
        - "any_generic_params"
        - "missing_bounds"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Generic Usage Analysis"
        - "Type Safety Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Full type checker analysis"
    medium: "Pattern-based detection"
    low: "Grep sampling only"

offline:
  capability: "full"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires deep analysis"
    full:
      included: true
      priority: 2
    quality:
      included: true
      priority: 1

closeout_checklist:
  - id: "gtu-001"
    item: "Parameterized types used consistently"
    level: "WARNING"
    verification: |
      raw=$(grep -rn --include="*.py" ": list\b\|: dict\b" . 2>/dev/null | grep -v "List\[\|Dict\[" | wc -l)
      typed=$(grep -rn --include="*.py" "List\[\|Dict\[" . 2>/dev/null | wc -l)
      [ "$raw" -lt "$typed" ] && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "gtu-002"
    item: "Limited Any usage in generics"
    level: "WARNING"
    verification: |
      grep -rn --include="*.py" "\[Any\]" . 2>/dev/null | wc -l | awk '{print ($1 < 20) ? "PASS" : "FAIL"}'
    expected: "PASS"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Reliability"]

relationships:
  commonly_combined:
    - "code-quality.type-safety.type-coverage"
    - "code-quality.type-safety.type-coercion-risk"
    - "code-quality.duplication.abstraction-opportunity"
