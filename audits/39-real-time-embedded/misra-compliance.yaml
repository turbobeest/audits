# ============================================================
# AUDIT: MISRA Compliance
# Category: 39 - Real-Time & Embedded Systems
# Subcategory: firmware-quality
# ============================================================

audit:
  id: "real-time-embedded.firmware-quality.misra-compliance"
  name: "MISRA Compliance Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "real-time-embedded"
  category_number: 39
  subcategory: "firmware-quality"

  tier: "expert"
  estimated_duration: "6-10 hours"  # median: 8h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "embedded-systems"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates firmware compliance with MISRA C (Motor Industry Software Reliability
    Association) coding guidelines. Reviews mandatory rules, required rules, and
    advisory rules compliance. Examines deviation documentation, static analysis
    tool configuration, and systematic violation tracking.

  why_it_matters: |
    MISRA C guidelines prevent common C programming errors that lead to undefined
    behavior, security vulnerabilities, and reliability issues. Compliance is
    often mandated for automotive (ISO 26262), aviation (DO-178C), and medical
    device software. MISRA compliance significantly improves code quality and
    reduces bugs in safety-critical embedded systems.

  when_to_run:
    - "Before safety certification"
    - "During code review cycles"
    - "After major code changes"
    - "When establishing coding standards"
    - "For legacy code assessment"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Complete firmware source code"
    - type: "build_configuration"
      description: "Compiler and build settings"
    - type: "coding_standard"
      description: "Project coding standard document"
    - type: "deviation_records"
      description: "Documented MISRA deviations"

  access_requirements:
    - "Access to source code"
    - "MISRA-compliant static analysis tool"
    - "MISRA guidelines document"
    - "Build system access"

discovery:
  file_patterns:
    - glob: "**/*.c"
      purpose: "Find C source files"
    - glob: "**/*.h"
      purpose: "Find header files"
    - glob: "**/misra*.h"
      purpose: "Find MISRA configuration"
    - glob: "**/lint*.lnt"
      purpose: "Find PC-Lint configuration"
    - glob: "**/deviations*.csv"
      purpose: "Find deviation records"

knowledge_sources:
  guides:
    - id: "misra-c-2012"
      name: "MISRA C:2012 Guidelines"
      url: "https://www.misra.org.uk/product/misra-c2012-third-edition-first-revision/"
    - id: "misra-compliance"
      name: "MISRA Compliance Guide"
      url: "https://www.misra.org.uk/"

  standards:
    - id: "misra-c-2012"
      name: "MISRA C:2012"
      relevance: "Primary coding standard"
    - id: "misra-c-2023"
      name: "MISRA C:2023"
      relevance: "Latest revision"
    - id: "iso-26262"
      name: "ISO 26262 Functional Safety"
      relevance: "Requires MISRA for ASIL"

tooling:
  analysis_tools:
    - tool: "pc-lint"
      purpose: "MISRA checking"
    - tool: "polyspace"
      purpose: "MathWorks MISRA checker"
    - tool: "qac"
      purpose: "PRQA MISRA analysis"
    - tool: "cppcheck"
      purpose: "Open source MISRA checking"
    - tool: "clang-tidy"
      purpose: "MISRA-ish rules"

signals:
  critical:
    - id: "MISRA-CRIT-001"
      signal: "Mandatory rule violations without deviation"
      evidence_indicators:
        - "Rule 1.3 undefined behavior present"
        - "Rule 21.x standard library violations"
        - "No deviation documented"
      explanation: |
        Mandatory rules must be followed - they address undefined or
        critical behavior. Violations indicate fundamental code problems.
      remediation: "Fix violations - no deviation permitted for mandatory rules"

    - id: "MISRA-CRIT-002"
      signal: "Pervasive required rule violations"
      evidence_indicators:
        - "Hundreds of unaddressed violations"
        - "Systematic coding pattern issues"
        - "No remediation plan"
      explanation: |
        Widespread violations indicate coding standards not followed.
        Required rules must be followed unless deviation documented.
      remediation: "Implement systematic remediation plan"

  high:
    - id: "MISRA-HIGH-001"
      signal: "Deviations not properly documented"
      evidence_indicators:
        - "Deviation without justification"
        - "Missing risk assessment"
        - "No approval record"
      explanation: |
        MISRA compliance requires documented deviations with technical
        justification and risk assessment for audit trail.
      remediation: "Document all deviations per MISRA guidelines"

    - id: "MISRA-HIGH-002"
      signal: "Static analysis tool not configured for MISRA"
      evidence_indicators:
        - "Tool doesn't check all rules"
        - "MISRA module not enabled"
        - "Configuration incomplete"
      explanation: |
        Partial checking misses violations. Tool must be configured
        to check all applicable MISRA rules.
      remediation: "Properly configure MISRA checking in static analysis tool"

  medium:
    - id: "MISRA-MED-001"
      signal: "Advisory rule violations prevalent"
      evidence_indicators:
        - "Many advisory violations"
        - "No review of advisories"
        - "Potential improvements ignored"
      explanation: |
        Advisory rules are recommendations for better code. While
        deviation is permitted, systematic violation review is valuable.
      remediation: "Review advisory violations for improvement opportunities"

    - id: "MISRA-MED-002"
      signal: "MISRA compliance not integrated in CI"
      evidence_indicators:
        - "Manual MISRA checking only"
        - "Violations introduced between checks"
        - "No enforcement in build"
      explanation: |
        Without CI integration, new violations accumulate between
        manual checks. Continuous checking prevents regression.
      remediation: "Integrate MISRA checking in CI pipeline"

  low:
    - id: "MISRA-LOW-001"
      signal: "MISRA version outdated"
      evidence_indicators:
        - "Using MISRA C:2004 or older"
        - "C99/C11 features not covered"
        - "Missing newer guidelines"
      explanation: |
        Newer MISRA versions address modern C features and incorporate
        lessons learned. Update improves coverage.
      remediation: "Migrate to MISRA C:2012 or C:2023"

  positive:
    - id: "MISRA-POS-001"
      signal: "Full MISRA compliance achieved"
      evidence_indicators:
        - "Zero violations or all properly deviated"
        - "Complete deviation documentation"
        - "CI enforcement in place"

    - id: "MISRA-POS-002"
      signal: "Strong MISRA process established"
      evidence_indicators:
        - "Compliance integrated in development"
        - "Training completed"
        - "Regular compliance review"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Configure Static Analysis"
      description: "Set up MISRA checking tool properly"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Run MISRA Analysis"
      description: "Execute static analysis on codebase"
      duration_estimate: "1-2 hours"

    - id: "3"
      name: "Review Mandatory Violations"
      description: "Analyze all mandatory rule violations"
      duration_estimate: "1-2 hours"

    - id: "4"
      name: "Review Required Violations"
      description: "Analyze required rule violations and deviations"
      duration_estimate: "2-3 hours"

    - id: "5"
      name: "Assess Deviation Documentation"
      description: "Review deviation records for completeness"
      duration_estimate: "1 hour"

    - id: "6"
      name: "Document Findings"
      description: "Compile compliance assessment report"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Compliance Statistics"
        - "Mandatory Rule Violations"
        - "Required Rule Analysis"
        - "Deviation Review"
        - "Recommendations"

closeout_checklist:
  - id: "misra-001"
    item: "Static analysis configured"
    level: "HIGH"
    verification: "manual"
  - id: "misra-002"
    item: "Analysis completed"
    level: "CRITICAL"
    verification: "automated"
  - id: "misra-003"
    item: "Mandatory violations addressed"
    level: "CRITICAL"
    verification: "automated"
  - id: "misra-004"
    item: "Deviations documented"
    level: "HIGH"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["embedded-systems", "safety-critical", "automotive", "avionics", "medical"]

  compliance_mappings:
    - framework: "ISO 26262"
      control: "Part 6, Table 1"
      description: "Coding guidelines recommendation"
    - framework: "DO-178C"
      control: "6.3.1"
      description: "Coding standards"
    - framework: "IEC 62304"
      control: "5.5.3"
      description: "Medical device software coding"

relationships:
  commonly_combined:
    - "real-time-embedded.firmware-quality.static-analysis-coverage"
    - "real-time-embedded.firmware-quality.code-metrics"
  depends_on:
    - "build.static-analysis-tools"
  feeds_into:
    - "certification.coding-standard-compliance"
    - "quality.code-quality-metrics"

# Glossary of domain-specific terms:
glossary:
  "WCET": "Worst-Case Execution Time - maximum possible execution time for a code path"
  "ISR": "Interrupt Service Routine - function executed in response to hardware interrupt"
  "jitter": "Variation in timing between expected and actual execution"
