audit:
  id: real-time-embedded.memory-management.dma-buffer-management
  name: DMA Buffer Management Audit
  version: 1.0.0
  last_updated: '2025-01-22'
  status: active
  category: real-time-embedded
  category_number: 39
  subcategory: memory-management
  tier: expert
  estimated_duration: 4-6 hours  # median: 5h
  completeness: requires_discovery
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: high
  scope: embedded-systems
  default_profiles:
  - full
  - quick
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Reviews Direct Memory Access (DMA) buffer configuration and management in
    embedded systems. Examines buffer allocation, alignment requirements, cache
    coherency handling, and synchronization between CPU and DMA operations.
    Analyzes double-buffering schemes, descriptor management, and error handling.
  why_it_matters: |
    DMA enables high-bandwidth data transfer without CPU intervention, but
    introduces complex memory coherency and synchronization requirements.
    Incorrect cache handling causes data corruption. Improper alignment causes
    DMA failures or performance penalties. Poor buffer management leads to
    data loss or system hangs.
  when_to_run:
  - When implementing DMA transfers
  - After data corruption issues
  - When optimizing throughput
  - During peripheral integration
  - Before production release
prerequisites:
  required_artifacts:
  - type: source_code
    description: DMA driver and buffer management code
  - type: hardware_manual
    description: DMA controller documentation
  - type: memory_map
    description: DMA-accessible memory regions
  - type: cache_configuration
    description: Cache settings and policies
  access_requirements:
  - Access to source code
  - Access to hardware documentation
  - Debug/trace capability
  - Logic analyzer for timing
discovery:
  file_patterns:
  - glob: '**/dma*.c'
    purpose: Find DMA driver code
  - glob: '**/hal_dma*.c'
    purpose: Find DMA HAL layer
  - glob: '**/buffer*.c'
    purpose: Find buffer management
  - glob: '**/cache*.c'
    purpose: Find cache handling code
  - glob: '**/*.ld'
    purpose: Find DMA memory sections
knowledge_sources:
  guides:
  - id: dma-design
    name: DMA Design Best Practices
    url: https://www.embedded.com/dma-best-practices
  - id: cache-coherency
    name: Cache Coherency in DMA Systems
    url: https://developer.arm.com/documentation/ddi0406/latest
  standards:
  - id: arm-amba
    name: ARM AMBA Specification
    relevance: DMA bus protocol
  - id: autosar-mcal
    name: AUTOSAR MCAL DMA
    relevance: Automotive DMA interface
tooling:
  analysis_tools:
  - tool: logic-analyzer
    purpose: DMA timing analysis
  - tool: debugger
    purpose: DMA register inspection
  - tool: memory-checker
    purpose: Alignment verification
signals:
  critical:
  - id: DMA-CRIT-001
    signal: Cache coherency not maintained
    evidence_indicators:
    - CPU reads stale data after DMA
    - DMA writes lost or corrupted
    - No cache invalidate/flush operations
    explanation: |
      Without proper cache handling, CPU and DMA see inconsistent
      memory views. DMA writes to memory cached by CPU get overwritten.
      CPU reads cached data instead of DMA updates.
    remediation: Implement proper cache maintenance for DMA buffers
  - id: DMA-CRIT-002
    signal: Buffer overrun from DMA
    evidence_indicators:
    - DMA transfers beyond buffer end
    - Memory corruption observed
    - Buffer size mismatch with transfer size
    explanation: |
      DMA overruns corrupt memory outside the buffer, causing
      unpredictable failures elsewhere in the system.
    remediation: Verify buffer sizes match DMA transfer sizes
  high:
  - id: DMA-HIGH-001
    signal: DMA buffer alignment incorrect
    evidence_indicators:
    - Buffer not cache-line aligned
    - Alignment attribute missing
    - DMA hard fault or incorrect data
    explanation: |
      Many DMA controllers require specific alignment. Incorrect
      alignment causes faults or transfers wrong memory.
    remediation: Apply required alignment to DMA buffers
  - id: DMA-HIGH-002
    signal: CPU-DMA synchronization missing
    evidence_indicators:
    - No memory barrier before DMA start
    - Buffer accessed during DMA
    - Race between CPU and DMA
    explanation: |
      Accessing a buffer during DMA causes corruption. Memory
      barriers and proper synchronization are essential.
    remediation: Implement proper CPU-DMA synchronization
  medium:
  - id: DMA-MED-001
    signal: No double-buffering for continuous transfers
    evidence_indicators:
    - Data loss during buffer switch
    - Gaps in streaming data
    - Single buffer for continuous DMA
    explanation: |
      Continuous DMA without double-buffering loses data during
      buffer processing. Ping-pong buffers eliminate gaps.
    remediation: Implement double-buffering for continuous transfers
  - id: DMA-MED-002
    signal: DMA error handling incomplete
    evidence_indicators:
    - Transfer errors not checked
    - No recovery from DMA failure
    - Silent data loss
    explanation: |
      DMA errors occur due to bus errors, timeouts, or configuration
      issues. Without handling, data is silently corrupted or lost.
    remediation: Implement comprehensive DMA error handling
  low:
  - id: DMA-LOW-001
    signal: DMA configuration not documented
    evidence_indicators:
    - Channel assignments unclear
    - Priority settings not explained
    - Buffer sizing rationale missing
    explanation: |
      Documentation supports maintenance and helps prevent
      configuration errors during changes.
    remediation: Document DMA configuration and rationale
  positive:
  - id: DMA-POS-001
    signal: Proper cache coherency management
    evidence_indicators:
    - Cache operations at correct points
    - Non-cacheable regions used appropriately
    - No data corruption
  - id: DMA-POS-002
    signal: Robust DMA buffer management
    evidence_indicators:
    - Proper alignment
    - Double-buffering where needed
    - Comprehensive error handling
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Inventory DMA Usage
    description: Document all DMA channels and purposes
    duration_estimate: 1 hour
  - id: '2'
    name: Review Buffer Configuration
    description: Check alignment, sizing, and placement
    duration_estimate: 1 hour
  - id: '3'
    name: Analyze Cache Handling
    description: Verify cache coherency management
    duration_estimate: 1-2 hours
  - id: '4'
    name: Check Synchronization
    description: Review CPU-DMA synchronization points
    duration_estimate: 1 hour
  - id: '5'
    name: Evaluate Error Handling
    description: Assess DMA error detection and recovery
    duration_estimate: 30 minutes
  - id: '6'
    name: Document Findings
    description: Compile analysis results and recommendations
    duration_estimate: 30 minutes
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - DMA Configuration Review
    - Cache Coherency Analysis
    - Synchronization Review
    - Recommendations
closeout_checklist:
- id: dma-001
  item: DMA usage inventoried
  level: HIGH
  verification: manual
- id: dma-002
  item: Buffer configuration verified
  level: HIGH
  verification: automated
- id: dma-003
  item: Cache handling analyzed
  level: CRITICAL
  verification: manual
- id: dma-004
  item: Synchronization reviewed
  level: HIGH
  verification: manual
governance:
  applicable_to:
    archetypes:
    - embedded-systems
    - high-throughput
    - peripheral-intensive
  compliance_mappings:
  - framework: AUTOSAR
    control: MCAL DMA
    description: DMA driver interface
  - framework: DO-178C
    control: 6.3.1
    description: Hardware interface design
relationships:
  commonly_combined:
  - real-time-embedded.memory-management.memory-protection-unit
  - real-time-embedded.interrupt-handling.isr-design-review
  depends_on:
  - hardware.dma-controller
  - architecture.cache-architecture
  feeds_into:
  - performance.throughput-optimization
  - reliability.data-integrity

# Glossary of domain-specific terms:
glossary:
  "WCET": "Worst-Case Execution Time - maximum possible execution time for a code path"
  "ISR": "Interrupt Service Routine - function executed in response to hardware interrupt"
  "jitter": "Variation in timing between expected and actual execution"
