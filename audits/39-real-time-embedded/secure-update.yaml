# ============================================================
# AUDIT: Secure Update
# Category: 39 - Real-Time & Embedded Systems
# Subcategory: bootloader-security
# ============================================================

audit:
  id: "real-time-embedded.bootloader-security.secure-update"
  name: "Secure Update Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "real-time-embedded"
  category_number: 39
  subcategory: "bootloader-security"

  tier: "expert"
  estimated_duration: "6-8 hours"  # median: 7h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "embedded-systems"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates secure firmware update (OTA/FOTA) implementation including update
    package integrity, transport security, installation verification, and
    recovery mechanisms. Reviews update image encryption, authentication,
    download resumption, and atomic update handling.

  why_it_matters: |
    Secure updates enable patching vulnerabilities in deployed devices while
    preventing attackers from installing malicious firmware. Insecure update
    mechanisms are a primary attack vector. Failed updates can brick devices.
    Proper implementation ensures updates are authentic, confidential, and
    reliably installed.

  when_to_run:
    - "When implementing OTA updates"
    - "Before production release"
    - "During security certification"
    - "After update mechanism changes"
    - "For compliance audits"

prerequisites:
  required_artifacts:
    - type: "update_implementation"
      description: "Firmware update source code"
    - type: "update_protocol"
      description: "Update protocol specification"
    - type: "server_architecture"
      description: "Update server documentation"
    - type: "recovery_design"
      description: "Failure recovery documentation"

  access_requirements:
    - "Access to update client source"
    - "Access to update server"
    - "Test update infrastructure"
    - "Device update capability"

discovery:
  file_patterns:
    - glob: "**/ota*.c"
      purpose: "Find OTA implementation"
    - glob: "**/update*.c"
      purpose: "Find update code"
    - glob: "**/fota*.c"
      purpose: "Find FOTA implementation"
    - glob: "**/download*.c"
      purpose: "Find download handlers"
    - glob: "**/flash_write*.c"
      purpose: "Find flash programming"

knowledge_sources:
  guides:
    - id: "secure-ota"
      name: "Secure OTA Update Design"
      url: "https://www.embedded.com/secure-ota"
    - id: "fota-best-practices"
      name: "FOTA Best Practices"
      url: "https://www.embedded.com/fota-best-practices"

  standards:
    - id: "uptane"
      name: "Uptane Framework"
      relevance: "Automotive update security"
    - id: "unece-wp29-r156"
      name: "UN ECE WP.29 R156"
      relevance: "Automotive software updates"

tooling:
  analysis_tools:
    - tool: "wireshark"
      purpose: "Protocol analysis"
    - tool: "burp-suite"
      purpose: "TLS inspection"
    - tool: "binwalk"
      purpose: "Update package analysis"

signals:
  critical:
    - id: "SU-CRIT-001"
      signal: "Update image not authenticated"
      evidence_indicators:
        - "No signature verification"
        - "Only checksum validation"
        - "Unsigned images accepted"
      explanation: |
        Without authentication, attackers can supply malicious updates.
        All update images must be cryptographically signed.
      remediation: "Implement cryptographic signature verification"

    - id: "SU-CRIT-002"
      signal: "Update transport not secured"
      evidence_indicators:
        - "HTTP without TLS"
        - "No server authentication"
        - "Man-in-middle possible"
      explanation: |
        Insecure transport allows update interception and modification.
        Use TLS with proper certificate validation.
      remediation: "Secure transport with TLS and certificate pinning"

  high:
    - id: "SU-HIGH-001"
      signal: "No rollback protection"
      evidence_indicators:
        - "Old versions installable"
        - "No version checking"
        - "Downgrade attack possible"
      explanation: |
        Rollback to vulnerable versions bypasses security patches.
        Version enforcement is essential.
      remediation: "Implement anti-rollback with version checking"

    - id: "SU-HIGH-002"
      signal: "Failed update leaves device inoperable"
      evidence_indicators:
        - "No recovery partition"
        - "Partial write causes brick"
        - "No update verification"
      explanation: |
        Update failures must not brick devices. Recovery mechanism
        is essential for field reliability.
      remediation: "Implement A/B partitions or recovery mode"

  medium:
    - id: "SU-MED-001"
      signal: "Update package not encrypted"
      evidence_indicators:
        - "Firmware in plaintext"
        - "IP readable in package"
        - "No confidentiality"
      explanation: |
        Unencrypted updates expose intellectual property and enable
        reverse engineering. Encryption adds confidentiality.
      remediation: "Encrypt update packages"

    - id: "SU-MED-002"
      signal: "No delta update support"
      evidence_indicators:
        - "Full image required every update"
        - "Large download sizes"
        - "Bandwidth intensive"
      explanation: |
        Delta updates reduce bandwidth and time. Full updates may be
        impractical over constrained networks.
      remediation: "Consider implementing differential updates"

  low:
    - id: "SU-LOW-001"
      signal: "Update process not documented"
      evidence_indicators:
        - "Process unclear"
        - "Error handling undefined"
        - "Recovery steps missing"
      explanation: |
        Documentation supports troubleshooting and ensures correct
        implementation maintenance.
      remediation: "Document complete update process"

  positive:
    - id: "SU-POS-001"
      signal: "Comprehensive secure update implementation"
      evidence_indicators:
        - "Signed and encrypted updates"
        - "Secure transport"
        - "Rollback protection"

    - id: "SU-POS-002"
      signal: "Robust recovery mechanisms"
      evidence_indicators:
        - "A/B partitions implemented"
        - "Recovery mode available"
        - "Update verification"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Review Update Architecture"
      description: "Document update flow and components"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Analyze Transport Security"
      description: "Evaluate network security implementation"
      duration_estimate: "1-2 hours"

    - id: "3"
      name: "Review Image Authentication"
      description: "Assess signature verification implementation"
      duration_estimate: "1-2 hours"

    - id: "4"
      name: "Test Failure Scenarios"
      description: "Verify recovery from update failures"
      duration_estimate: "1-2 hours"

    - id: "5"
      name: "Check Rollback Protection"
      description: "Test version enforcement"
      duration_estimate: "1 hour"

    - id: "6"
      name: "Document Findings"
      description: "Compile assessment report"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Architecture Review"
        - "Security Analysis"
        - "Recovery Testing"
        - "Recommendations"

closeout_checklist:
  - id: "su-001"
    item: "Update architecture reviewed"
    level: "HIGH"
    verification: "manual"
  - id: "su-002"
    item: "Transport security analyzed"
    level: "CRITICAL"
    verification: "automated"
  - id: "su-003"
    item: "Image authentication verified"
    level: "CRITICAL"
    verification: "automated"
  - id: "su-004"
    item: "Failure scenarios tested"
    level: "HIGH"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["embedded-systems", "iot", "automotive", "connected-devices"]

  compliance_mappings:
    - framework: "UN ECE WP.29"
      control: "R156"
      description: "Software update management"
    - framework: "Uptane"
      control: "Standard"
      description: "Automotive update framework"
    - framework: "IEC 62443"
      control: "SR 3.1"
      description: "Communication integrity"

relationships:
  commonly_combined:
    - "real-time-embedded.bootloader-security.firmware-signing"
    - "real-time-embedded.bootloader-security.rollback-protection"
  depends_on:
    - "real-time-embedded.bootloader-security.firmware-signing"
    - "infrastructure.update-server"
  feeds_into:
    - "security.device-security"
    - "operations.update-management"
