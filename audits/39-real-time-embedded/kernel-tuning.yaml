audit:
  id: real-time-embedded.rtos-configuration.kernel-tuning
  name: Kernel Tuning Audit
  version: 1.0.0
  last_updated: '2025-01-22'
  status: active
  category: real-time-embedded
  category_number: 39
  subcategory: rtos-configuration
  tier: expert
  estimated_duration: 4-6 hours  # median: 5h
  completeness: requires_discovery
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: high
  scope: embedded-systems
  default_profiles:
  - full
  - quick
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Reviews RTOS kernel configuration for optimal performance, memory usage,
    and determinism. Examines feature selection to minimize footprint, memory
    pool sizing, queue and timer configurations, and debug/trace settings.
    Evaluates trade-offs between functionality, memory, and performance.
  why_it_matters: |
    RTOS kernels are highly configurable. Incorrect configuration wastes
    memory, reduces performance, or eliminates needed functionality. Over-
    sized queues waste RAM. Under-sized pools cause runtime failures.
    Debug features left enabled in production consume resources. Proper
    tuning optimizes the kernel for the specific application.
  when_to_run:
  - During initial RTOS integration
  - Before memory optimization
  - When reducing code size
  - Before production release
  - After RTOS upgrades
prerequisites:
  required_artifacts:
  - type: rtos_configuration
    description: Complete kernel configuration files
  - type: memory_map
    description: System memory layout
  - type: resource_requirements
    description: Application resource needs
  - type: build_output
    description: Map file and memory report
  access_requirements:
  - Access to kernel configuration
  - Access to build system
  - Memory analysis tools
  - Runtime profiling capability
discovery:
  file_patterns:
  - glob: '**/FreeRTOSConfig.h'
    purpose: Find FreeRTOS kernel config
  - glob: '**/os_cfg*.h'
    purpose: Find OS configuration
  - glob: '**/kernel_cfg.h'
    purpose: Find kernel settings
  - glob: '**/*.map'
    purpose: Find linker map files
  - glob: '**/memory_config.h'
    purpose: Find memory configuration
knowledge_sources:
  guides:
  - id: freertos-memory
    name: FreeRTOS Memory Management
    url: https://www.freertos.org/a00111.html
  - id: rtos-footprint
    name: Minimizing RTOS Footprint
    url: https://www.embedded.com/rtos-footprint-optimization
  standards:
  - id: autosar-os
    name: AUTOSAR OS Specification
    relevance: Automotive kernel requirements
  - id: misra-c
    name: MISRA C Guidelines
    relevance: Memory configuration practices
tooling:
  analysis_tools:
  - tool: map-analyzer
    purpose: Analyze memory usage
  - tool: size
    purpose: Binary size analysis
  - tool: valgrind
    purpose: Memory debugging
  - tool: tracealyzer
    purpose: Runtime resource analysis
signals:
  critical:
  - id: KT-CRIT-001
    signal: Memory pools exhausted at runtime
    evidence_indicators:
    - Allocation failures observed
    - Pool size too small
    - No error handling for exhaustion
    explanation: |
      Exhausted memory pools cause runtime failures. In safety-critical
      systems, this can lead to undefined behavior or system crashes.
    remediation: Increase pool sizes or reduce usage
  - id: KT-CRIT-002
    signal: Debug features enabled in production build
    evidence_indicators:
    - INCLUDE_xTaskGetHandle enabled
    - configASSERT active in release
    - Stack checking overhead present
    explanation: |
      Debug features consume memory and CPU cycles. They may also
      expose system internals creating security vulnerabilities.
    remediation: Disable debug features for production builds
  high:
  - id: KT-HIGH-001
    signal: Excessive memory allocated to kernel
    evidence_indicators:
    - Oversized task stacks
    - Large unused queues
    - Timer pool too big
    explanation: |
      Over-provisioned resources waste limited embedded memory.
      This reduces space available for application data.
    remediation: Right-size kernel allocations based on actual usage
  - id: KT-HIGH-002
    signal: Required kernel feature disabled
    evidence_indicators:
    - Feature used but not configured
    - Runtime error from missing feature
    - Linking fails for kernel function
    explanation: |
      Disabled features that are needed cause build or runtime
      failures. Configuration must match actual usage.
    remediation: Enable required kernel features
  medium:
  - id: KT-MED-001
    signal: Suboptimal memory allocation scheme
    evidence_indicators:
    - Dynamic allocation in real-time paths
    - Fragmentation-prone allocator
    - Heap used instead of pools
    explanation: |
      Memory allocation strategy affects determinism and fragmentation.
      Real-time systems should prefer static or pool allocation.
    remediation: Use appropriate allocation strategy for application
  - id: KT-MED-002
    signal: Kernel statistics collection overhead
    evidence_indicators:
    - Runtime stats enabled
    - CPU time tracking active
    - Overhead added to context switches
    explanation: |
      Statistics collection adds overhead that should be disabled
      in production unless specifically needed.
    remediation: Disable unnecessary statistics in production
  low:
  - id: KT-LOW-001
    signal: Kernel configuration not documented
    evidence_indicators:
    - No configuration rationale
    - Sizing decisions unexplained
    - Default values not reviewed
    explanation: |
      Documentation supports maintenance and helps verify that
      configuration meets application requirements.
    remediation: Document kernel configuration rationale
  positive:
  - id: KT-POS-001
    signal: Kernel optimally configured for application
    evidence_indicators:
    - Feature set minimal but complete
    - Memory usage appropriate
    - Configuration documented
  - id: KT-POS-002
    signal: Memory usage characterized and within budget
    evidence_indicators:
    - Stack high-water marks monitored
    - Pool usage tracked
    - Margin maintained
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Review Feature Configuration
    description: Examine enabled/disabled kernel features
    duration_estimate: 1 hour
  - id: '2'
    name: Analyze Memory Configuration
    description: Review stack sizes, pool sizes, and heap settings
    duration_estimate: 1-2 hours
  - id: '3'
    name: Check Debug Settings
    description: Verify debug features appropriate for build type
    duration_estimate: 30 minutes
  - id: '4'
    name: Measure Runtime Resource Usage
    description: Profile actual kernel resource consumption
    duration_estimate: 1 hour
  - id: '5'
    name: Compare to Requirements
    description: Verify configuration meets application needs
    duration_estimate: 30 minutes
  - id: '6'
    name: Document Findings
    description: Compile analysis results and recommendations
    duration_estimate: 30 minutes
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Feature Configuration
    - Memory Analysis
    - Runtime Usage
    - Recommendations
closeout_checklist:
- id: kt-001
  item: Feature configuration reviewed
  level: HIGH
  verification: manual
- id: kt-002
  item: Memory configuration analyzed
  level: HIGH
  verification: automated
- id: kt-003
  item: Debug settings verified
  level: HIGH
  verification: automated
- id: kt-004
  item: Runtime usage measured
  level: MEDIUM
  verification: automated
governance:
  applicable_to:
    archetypes:
    - embedded-systems
    - resource-constrained
    - safety-critical
  compliance_mappings:
  - framework: DO-178C
    control: 6.3.1
    description: Software architecture
  - framework: ISO 26262
    control: Part 6
    description: Software design
  - framework: MISRA C
    control: Dir 4.12
    description: Dynamic memory
relationships:
  commonly_combined:
  - real-time-embedded.memory-management.static-allocation-analysis
  - real-time-embedded.rtos-configuration.scheduler-configuration
  depends_on:
  - requirements.memory-requirements
  - architecture.system-design
  feeds_into:
  - performance.memory-optimization
  - build.release-configuration

# Glossary of domain-specific terms:
glossary:
  "WCET": "Worst-Case Execution Time - maximum possible execution time for a code path"
  "ISR": "Interrupt Service Routine - function executed in response to hardware interrupt"
  "jitter": "Variation in timing between expected and actual execution"
