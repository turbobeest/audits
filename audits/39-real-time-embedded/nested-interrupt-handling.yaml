# ============================================================
# AUDIT: Nested Interrupt Handling
# Category: 39 - Real-Time & Embedded Systems
# Subcategory: interrupt-handling
# ============================================================

audit:
  id: "real-time-embedded.interrupt-handling.nested-interrupt-handling"
  name: "Nested Interrupt Handling Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "real-time-embedded"
  category_number: 39
  subcategory: "interrupt-handling"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "embedded-systems"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Examines the design and implementation of nested interrupt handling where
    ISRs can be preempted by higher-priority interrupts. Reviews stack sizing
    for nested interrupt contexts, re-entrancy concerns, interrupt enable/disable
    sequences, and worst-case interrupt nesting depth.

  why_it_matters: |
    Nested interrupts improve responsiveness by allowing critical interrupts to
    preempt less critical ones. However, nesting adds complexity including
    increased stack usage, potential re-entrancy issues, and more complex timing
    analysis. Improper nesting can cause stack overflow, data corruption, or
    unpredictable latency.

  when_to_run:
    - "When enabling nested interrupts"
    - "During interrupt architecture review"
    - "After stack overflow issues"
    - "Before safety certification"
    - "When debugging interrupt issues"

prerequisites:
  required_artifacts:
    - type: "interrupt_architecture"
      description: "Nested interrupt design"
    - type: "priority_configuration"
      description: "Interrupt priority settings"
    - type: "stack_configuration"
      description: "ISR stack allocation"
    - type: "source_code"
      description: "ISR implementations"

  access_requirements:
    - "Access to source code"
    - "Access to priority configuration"
    - "Stack analysis tools"
    - "Debug/trace capability"

discovery:
  file_patterns:
    - glob: "**/isr*.c"
      purpose: "Find ISR implementations"
    - glob: "**/interrupt*.c"
      purpose: "Find interrupt handling code"
    - glob: "**/stack*.h"
      purpose: "Find stack definitions"
    - glob: "**/nvic*.c"
      purpose: "Find NVIC configuration"
    - glob: "**/exception*.c"
      purpose: "Find exception handling"

knowledge_sources:
  guides:
    - id: "nested-interrupts"
      name: "Nested Interrupt Design"
      url: "https://www.embedded.com/nested-interrupts"
    - id: "arm-exception"
      name: "ARM Exception Handling"
      url: "https://developer.arm.com/documentation/ddi0403/latest"

  standards:
    - id: "arm-cortex-m"
      name: "ARM Cortex-M Technical Reference"
      relevance: "Nested interrupt behavior"
    - id: "do-178c"
      name: "DO-178C Software Considerations"
      relevance: "Interrupt stack analysis"

tooling:
  analysis_tools:
    - tool: "stack-analyzer"
      purpose: "Worst-case stack analysis"
    - tool: "tracealyzer"
      purpose: "Nesting visualization"
    - tool: "debugger"
      purpose: "Stack depth monitoring"

signals:
  critical:
    - id: "NIH-CRIT-001"
      signal: "Stack overflow from interrupt nesting"
      evidence_indicators:
        - "Stack corruption detected"
        - "Maximum nesting exceeds stack allocation"
        - "System crash during nested interrupt"
      explanation: |
        Each nested interrupt consumes stack space. If nesting depth
        exceeds allocation, stack overflow corrupts adjacent memory.
      remediation: "Increase stack or limit nesting depth"

    - id: "NIH-CRIT-002"
      signal: "Re-entrancy issue in nested ISR"
      evidence_indicators:
        - "Shared state corrupted"
        - "Non-reentrant code called from nested ISR"
        - "Data corruption during nesting"
      explanation: |
        Nested interrupts can re-enter shared code or access shared
        state, causing corruption if not designed for re-entrancy.
      remediation: "Make shared code reentrant or prevent nesting"

  high:
    - id: "NIH-HIGH-001"
      signal: "Nesting depth not bounded"
      evidence_indicators:
        - "Maximum depth unknown"
        - "Depends on timing"
        - "Stack sizing not justified"
      explanation: |
        Without bounded nesting depth, stack requirements cannot be
        determined and overflow prevention is uncertain.
      remediation: "Analyze and bound maximum nesting depth"

    - id: "NIH-HIGH-002"
      signal: "Interrupt enable timing incorrect"
      evidence_indicators:
        - "Interrupts enabled before context save complete"
        - "Enable sequence has race window"
        - "Context corruption possible"
      explanation: |
        Enabling interrupts before context save completes can cause
        corruption if higher priority interrupt arrives.
      remediation: "Complete context save before enabling interrupts"

  medium:
    - id: "NIH-MED-001"
      signal: "Inconsistent nesting policy"
      evidence_indicators:
        - "Some ISRs allow nesting, others don't"
        - "No clear nesting strategy"
        - "Policy not documented"
      explanation: |
        Inconsistent nesting policy makes analysis difficult and
        increases risk of errors.
      remediation: "Establish and document consistent nesting policy"

    - id: "NIH-MED-002"
      signal: "Nesting depth varies with load"
      evidence_indicators:
        - "Depth depends on interrupt timing"
        - "Statistical stack margin only"
        - "Worst case not achieved in testing"
      explanation: |
        Variable depth complicates analysis. Worst-case may only
        occur under specific timing conditions.
      remediation: "Analyze worst-case nesting scenario"

  low:
    - id: "NIH-LOW-001"
      signal: "Nesting design not documented"
      evidence_indicators:
        - "Nesting policy unclear"
        - "Stack sizing rationale missing"
        - "Analysis not recorded"
      explanation: |
        Documentation supports maintenance and certification evidence.
      remediation: "Document nesting design and analysis"

  positive:
    - id: "NIH-POS-001"
      signal: "Bounded nesting with adequate stack"
      evidence_indicators:
        - "Maximum depth known"
        - "Stack sized for worst case"
        - "Analysis documented"

    - id: "NIH-POS-002"
      signal: "Reentrant ISR design"
      evidence_indicators:
        - "No shared state issues"
        - "All code paths reentrant"
        - "Safe nesting enabled"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Document Nesting Policy"
      description: "Understand intended nesting design"
      duration_estimate: "30 minutes"

    - id: "2"
      name: "Analyze Priority Configuration"
      description: "Map which interrupts can preempt which"
      duration_estimate: "1 hour"

    - id: "3"
      name: "Calculate Maximum Nesting Depth"
      description: "Determine worst-case nesting scenario"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Verify Stack Sizing"
      description: "Check stack allocation vs worst-case usage"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Check Re-entrancy"
      description: "Verify ISR code is safe for nesting"
      duration_estimate: "1-2 hours"

    - id: "6"
      name: "Document Findings"
      description: "Compile analysis results and recommendations"
      duration_estimate: "30 minutes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Nesting Policy Review"
        - "Depth Analysis"
        - "Stack Verification"
        - "Recommendations"

closeout_checklist:
  - id: "nih-001"
    item: "Nesting policy documented"
    level: "HIGH"
    verification: "manual"
  - id: "nih-002"
    item: "Maximum depth analyzed"
    level: "CRITICAL"
    verification: "manual"
  - id: "nih-003"
    item: "Stack sizing verified"
    level: "CRITICAL"
    verification: "automated"
  - id: "nih-004"
    item: "Re-entrancy checked"
    level: "HIGH"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["embedded-systems", "safety-critical", "real-time"]

  compliance_mappings:
    - framework: "DO-178C"
      control: "6.3.3"
      description: "Stack requirements"
    - framework: "ISO 26262"
      control: "Part 6"
      description: "Memory protection"
    - framework: "MISRA C"
      control: "Rule 17.2"
      description: "Re-entrancy"

relationships:
  commonly_combined:
    - "real-time-embedded.interrupt-handling.interrupt-priority-configuration"
    - "real-time-embedded.memory-management.stack-overflow-protection"
  depends_on:
    - "real-time-embedded.interrupt-handling.interrupt-priority-configuration"
  feeds_into:
    - "real-time-embedded.interrupt-handling.isr-latency-analysis"
    - "safety.interrupt-safety"

# Glossary of domain-specific terms:
glossary:
  "WCET": "Worst-Case Execution Time - maximum possible execution time for a code path"
  "ISR": "Interrupt Service Routine - function executed in response to hardware interrupt"
  "jitter": "Variation in timing between expected and actual execution"
