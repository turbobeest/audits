audit:
  id: real-time-embedded.memory-management.fragmentation-prevention
  name: Fragmentation Prevention Audit
  version: 1.0.0
  last_updated: '2025-01-22'
  status: active
  category: real-time-embedded
  category_number: 39
  subcategory: memory-management
  tier: expert
  estimated_duration: 4-6 hours  # median: 5h
  completeness: requires_discovery
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: high
  scope: embedded-systems
  default_profiles:
  - full
  - quick
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Evaluates memory fragmentation risks in embedded systems where heap usage
    is permitted. Reviews memory allocator selection, allocation patterns,
    and pool-based approaches. Analyzes heap usage over time to detect
    fragmentation buildup. Examines mitigation strategies such as fixed-size
    pools and memory compaction where applicable.
  why_it_matters: |
    Fragmentation causes allocation failures even when total free memory is
    sufficient. In long-running embedded systems, fragmentation accumulates
    over time leading to eventual system failure. Unlike desktop systems,
    embedded devices cannot simply restart. Proper allocation strategies
    prevent fragmentation from causing field failures.
  when_to_run:
  - After implementing dynamic allocation
  - During long-duration testing
  - When debugging allocation failures
  - Before production release
  - During memory optimization
prerequisites:
  required_artifacts:
  - type: source_code
    description: Memory management source code
  - type: allocator_implementation
    description: Heap allocator documentation
  - type: allocation_patterns
    description: Analysis of allocation/free patterns
  - type: runtime_data
    description: Long-term heap monitoring data
  access_requirements:
  - Access to source code
  - Heap instrumentation capability
  - Long-duration test environment
  - Memory debugging tools
discovery:
  file_patterns:
  - glob: '**/heap*.c'
    purpose: Find heap implementations
  - glob: '**/malloc*.c'
    purpose: Find allocator code
  - glob: '**/memory_pool*.c'
    purpose: Find pool implementations
  - glob: '**/FreeRTOSConfig.h'
    purpose: Find heap configuration
  - glob: '**/tlsf*.c'
    purpose: Find TLSF allocator
knowledge_sources:
  guides:
  - id: heap-fragmentation
    name: Understanding Heap Fragmentation
    url: https://www.embedded.com/heap-fragmentation
  - id: memory-pools
    name: Fixed-Size Memory Pool Design
    url: https://www.embedded.com/memory-pools
  - id: tlsf
    name: TLSF Allocator Design
    url: http://www.gii.upv.es/tlsf/
  standards:
  - id: misra-c
    name: MISRA C Guidelines
    relevance: Dynamic memory rules
  - id: do-178c
    name: DO-178C Software Considerations
    relevance: Memory determinism
tooling:
  analysis_tools:
  - tool: valgrind-massif
    purpose: Heap profiling
  - tool: tracealyzer
    purpose: Memory visualization
  - tool: heap-analyzer
    purpose: Fragmentation analysis
  - tool: custom-instrumentation
    purpose: Heap monitoring
signals:
  critical:
  - id: FP-CRIT-001
    signal: Allocation failure from fragmentation
    evidence_indicators:
    - Allocation fails with free memory available
    - Largest free block too small
    - System failure from allocation error
    explanation: |
      Fragmentation-induced allocation failures cause system crashes
      or degraded operation when memory appears available.
    remediation: Implement fragmentation-resistant allocation strategy
  - id: FP-CRIT-002
    signal: Unbounded heap growth detected
    evidence_indicators:
    - Heap size increases over time
    - Memory not returned to system
    - Eventual exhaustion inevitable
    explanation: |
      Unbounded growth will eventually exhaust all memory. This may
      be a leak combined with fragmentation preventing reuse.
    remediation: Fix leaks and implement bounded allocation
  high:
  - id: FP-HIGH-001
    signal: High fragmentation rate observed
    evidence_indicators:
    - Free memory highly fragmented
    - Many small free blocks
    - Efficiency below 50%
    explanation: |
      High fragmentation indicates allocation patterns that will
      eventually cause failures. Proactive mitigation needed.
    remediation: Restructure allocation patterns or use pools
  - id: FP-HIGH-002
    signal: Variable-size allocations in critical paths
    evidence_indicators:
    - Message buffers of varying sizes
    - Protocol data with dynamic length
    - Frequent alloc/free of different sizes
    explanation: |
      Variable-size allocations are primary fragmentation cause.
      Critical paths should use fixed-size pools.
    remediation: Use fixed-size pools for variable-size data
  medium:
  - id: FP-MED-001
    signal: Allocator not suited for embedded use
    evidence_indicators:
    - Standard library malloc used
    - Non-deterministic allocation time
    - Poor fragmentation resistance
    explanation: |
      Standard allocators are optimized for general-purpose use,
      not embedded longevity. Specialized allocators perform better.
    remediation: Use embedded-appropriate allocator like TLSF
  - id: FP-MED-002
    signal: No heap monitoring in place
    evidence_indicators:
    - Heap state unknown at runtime
    - No fragmentation metrics
    - Problems only found after failure
    explanation: |
      Without monitoring, fragmentation problems go undetected
      until they cause field failures.
    remediation: Implement heap monitoring and alerting
  low:
  - id: FP-LOW-001
    signal: Allocation strategy not documented
    evidence_indicators:
    - Design rationale missing
    - Expected patterns not described
    - Pool sizing not justified
    explanation: |
      Documentation supports maintenance and helps prevent
      allocation pattern changes that increase fragmentation.
    remediation: Document allocation strategy and constraints
  positive:
  - id: FP-POS-001
    signal: Pool-based allocation eliminates fragmentation
    evidence_indicators:
    - All allocations from fixed-size pools
    - No heap fragmentation possible
    - Deterministic allocation
  - id: FP-POS-002
    signal: Heap stable over long-term operation
    evidence_indicators:
    - No fragmentation growth
    - Consistent allocation success
    - Monitoring shows stable state
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Review Allocation Strategy
    description: Analyze allocator selection and configuration
    duration_estimate: 1 hour
  - id: '2'
    name: Map Allocation Patterns
    description: Document allocation/free patterns and sizes
    duration_estimate: 1-2 hours
  - id: '3'
    name: Conduct Long-Term Monitoring
    description: Observe heap behavior over extended operation
    duration_estimate: 1-2 hours
  - id: '4'
    name: Analyze Fragmentation Metrics
    description: Calculate fragmentation levels and trends
    duration_estimate: 30 minutes
  - id: '5'
    name: Evaluate Pool-Based Alternatives
    description: Assess feasibility of fixed-size pools
    duration_estimate: 30 minutes
  - id: '6'
    name: Document Findings
    description: Compile analysis results and recommendations
    duration_estimate: 30 minutes
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Allocation Strategy Review
    - Pattern Analysis
    - Fragmentation Metrics
    - Recommendations
closeout_checklist:
- id: fp-001
  item: Allocation strategy reviewed
  level: HIGH
  verification: manual
- id: fp-002
  item: Allocation patterns mapped
  level: HIGH
  verification: automated
- id: fp-003
  item: Long-term monitoring completed
  level: HIGH
  verification: automated
- id: fp-004
  item: Fragmentation metrics analyzed
  level: HIGH
  verification: automated
governance:
  applicable_to:
    archetypes:
    - embedded-systems
    - long-running
    - safety-critical
  compliance_mappings:
  - framework: DO-178C
    control: 6.3.3
    description: Memory management
  - framework: MISRA C
    control: Dir 4.12
    description: Dynamic memory
  - framework: IEC 61508
    control: 7.4.4
    description: Memory verification
relationships:
  commonly_combined:
  - real-time-embedded.memory-management.static-allocation-analysis
  - real-time-embedded.memory-management.heap-usage-analysis
  depends_on:
  - architecture.memory-architecture
  feeds_into:
  - reliability.memory-reliability
  - longevity.long-term-stability

# Glossary of domain-specific terms:
glossary:
  "WCET": "Worst-Case Execution Time - maximum possible execution time for a code path"
  "ISR": "Interrupt Service Routine - function executed in response to hardware interrupt"
  "jitter": "Variation in timing between expected and actual execution"
