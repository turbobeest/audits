# ============================================================
# AUDIT: Memory Protection Unit Configuration
# Category: 39 - Real-Time & Embedded Systems
# Subcategory: memory-management
# ============================================================

audit:
  id: "real-time-embedded.memory-management.memory-protection-unit"
  name: "Memory Protection Unit Configuration Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "real-time-embedded"
  category_number: 39
  subcategory: "memory-management"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "embedded-systems"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Reviews Memory Protection Unit (MPU) configuration for embedded systems.
    Examines region definitions, access permissions, and alignment requirements.
    Evaluates protection of critical data, code execution prevention, and task
    isolation. Analyzes MPU usage for stack protection and peripheral access
    control.

  why_it_matters: |
    MPU provides hardware-enforced memory protection preventing accidental
    corruption and containing errors. In safety-critical systems, MPU isolates
    different ASIL levels and prevents lower-integrity code from corrupting
    higher-integrity regions. MPU configuration errors can leave critical
    areas unprotected or cause unexpected faults.

  when_to_run:
    - "During initial MPU setup"
    - "After memory layout changes"
    - "Before safety certification"
    - "When adding protection requirements"
    - "After RTOS integration"

prerequisites:
  required_artifacts:
    - type: "mpu_configuration"
      description: "MPU region definitions and settings"
    - type: "memory_map"
      description: "Complete system memory layout"
    - type: "processor_manual"
      description: "MPU capability documentation"
    - type: "protection_requirements"
      description: "Memory protection requirements"

  access_requirements:
    - "Access to MPU configuration code"
    - "Access to linker script"
    - "Debug probe with MPU access"
    - "Processor documentation"

discovery:
  file_patterns:
    - glob: "**/mpu*.c"
      purpose: "Find MPU configuration"
    - glob: "**/port.c"
      purpose: "Find RTOS port with MPU code"
    - glob: "**/mpu_wrappers*.c"
      purpose: "Find MPU wrapper functions"
    - glob: "**/*_region*.h"
      purpose: "Find region definitions"
    - glob: "**/*.ld"
      purpose: "Find linker scripts for alignment"

knowledge_sources:
  guides:
    - id: "arm-mpu"
      name: "ARM MPU Configuration Guide"
      url: "https://developer.arm.com/documentation/dui0553/latest"
    - id: "freertos-mpu"
      name: "FreeRTOS MPU Support"
      url: "https://www.freertos.org/FreeRTOS-MPU-memory-protection-unit.html"

  standards:
    - id: "iso-26262"
      name: "ISO 26262 Functional Safety"
      relevance: "Freedom from interference"
    - id: "do-178c"
      name: "DO-178C Software Considerations"
      relevance: "Partitioning requirements"
    - id: "iec-61508"
      name: "IEC 61508 Functional Safety"
      relevance: "Independence requirements"

tooling:
  analysis_tools:
    - tool: "debugger"
      purpose: "MPU register inspection"
    - tool: "segger-ozone"
      purpose: "MPU visualization"
    - tool: "lauterbach"
      purpose: "MPU debug support"

signals:
  critical:
    - id: "MPU-CRIT-001"
      signal: "Critical data region unprotected"
      evidence_indicators:
        - "Safety-critical data writable by all"
        - "No MPU region for sensitive data"
        - "ASIL isolation not enforced"
      explanation: |
        Unprotected critical data can be corrupted by any code.
        This violates freedom from interference requirements.
      remediation: "Configure MPU region to protect critical data"

    - id: "MPU-CRIT-002"
      signal: "Execute permission on data regions"
      evidence_indicators:
        - "Data regions marked executable"
        - "Stack executable"
        - "Code injection possible"
      explanation: |
        Executable data regions enable code injection attacks and
        execution of corrupted data as code.
      remediation: "Remove execute permission from data regions"

  high:
    - id: "MPU-HIGH-001"
      signal: "Task stack not MPU protected"
      evidence_indicators:
        - "Stack overflow can corrupt other memory"
        - "No stack guard region"
        - "Adjacent memory vulnerable"
      explanation: |
        Without MPU stack protection, overflow corrupts adjacent
        memory silently rather than generating a fault.
      remediation: "Add MPU guard region around task stacks"

    - id: "MPU-HIGH-002"
      signal: "Insufficient regions for protection needs"
      evidence_indicators:
        - "More regions needed than available"
        - "Protection requirements not met"
        - "Regions combined inappropriately"
      explanation: |
        Limited MPU regions require careful allocation. Insufficient
        regions may leave areas unprotected.
      remediation: "Optimize region usage or adjust memory layout"

  medium:
    - id: "MPU-MED-001"
      signal: "MPU regions not aligned optimally"
      evidence_indicators:
        - "Regions larger than necessary"
        - "Power-of-two alignment wasted"
        - "Memory overhead from alignment"
      explanation: |
        MPU alignment requirements can waste memory if not considered
        in memory layout design.
      remediation: "Adjust linker script for optimal MPU alignment"

    - id: "MPU-MED-002"
      signal: "Peripheral access not controlled by MPU"
      evidence_indicators:
        - "All tasks can access all peripherals"
        - "Privileged peripherals accessible"
        - "Device driver isolation missing"
      explanation: |
        Uncontrolled peripheral access allows tasks to affect
        hardware outside their intended scope.
      remediation: "Configure peripheral access regions per task"

  low:
    - id: "MPU-LOW-001"
      signal: "MPU configuration not documented"
      evidence_indicators:
        - "Region purposes unclear"
        - "Access permissions not justified"
        - "Protection rationale missing"
      explanation: |
        Documentation supports maintenance and certification evidence.
      remediation: "Document MPU region design and rationale"

  positive:
    - id: "MPU-POS-001"
      signal: "Comprehensive MPU protection configured"
      evidence_indicators:
        - "All critical regions protected"
        - "Task isolation enforced"
        - "Stack guards in place"

    - id: "MPU-POS-002"
      signal: "MPU configuration aligns with safety requirements"
      evidence_indicators:
        - "ASIL regions properly isolated"
        - "Freedom from interference demonstrated"
        - "Protection documented"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Review MPU Capability"
      description: "Understand processor MPU features and limitations"
      duration_estimate: "30 minutes"

    - id: "2"
      name: "Map Protection Requirements"
      description: "Document required protection regions and permissions"
      duration_estimate: "1 hour"

    - id: "3"
      name: "Analyze Region Configuration"
      description: "Review all MPU region settings"
      duration_estimate: "1-2 hours"

    - id: "4"
      name: "Verify Access Permissions"
      description: "Confirm permissions match requirements"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Test Protection Enforcement"
      description: "Verify MPU faults occur as expected"
      duration_estimate: "1 hour"

    - id: "6"
      name: "Document Findings"
      description: "Compile analysis results and recommendations"
      duration_estimate: "30 minutes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "MPU Capability Summary"
        - "Region Configuration"
        - "Protection Analysis"
        - "Recommendations"

closeout_checklist:
  - id: "mpu-001"
    item: "Protection requirements mapped"
    level: "CRITICAL"
    verification: "manual"
  - id: "mpu-002"
    item: "Region configuration reviewed"
    level: "CRITICAL"
    verification: "automated"
  - id: "mpu-003"
    item: "Access permissions verified"
    level: "CRITICAL"
    verification: "manual"
  - id: "mpu-004"
    item: "Protection enforcement tested"
    level: "HIGH"
    verification: "automated"

governance:
  applicable_to:
    archetypes: ["embedded-systems", "safety-critical", "automotive", "avionics"]

  compliance_mappings:
    - framework: "ISO 26262"
      control: "Part 6, Annex D"
      description: "Freedom from interference"
    - framework: "DO-178C"
      control: "6.3.3"
      description: "Partitioning"
    - framework: "IEC 61508"
      control: "7.4.2.9"
      description: "Independence of software elements"

relationships:
  commonly_combined:
    - "real-time-embedded.memory-management.stack-overflow-protection"
    - "security.memory-isolation"
  depends_on:
    - "hardware.processor-features"
    - "architecture.memory-layout"
  feeds_into:
    - "safety.freedom-from-interference"
    - "security.isolation-enforcement"
