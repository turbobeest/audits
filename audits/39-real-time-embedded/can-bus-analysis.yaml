audit:
  id: real-time-embedded.communication-protocols.can-bus-analysis
  name: CAN Bus Analysis Audit
  version: 1.0.0
  last_updated: '2025-01-22'
  status: active
  category: real-time-embedded
  category_number: 39
  subcategory: communication-protocols
  tier: expert
  estimated_duration: 4-6 hours  # median: 5h
  completeness: requires_discovery
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: high
  scope: embedded-systems
  default_profiles:
  - full
  - quick
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Reviews Controller Area Network (CAN) implementation including message
    prioritization, bus timing configuration, error handling, and message
    database compliance. Examines CAN driver configuration, buffer management,
    and higher-layer protocol integration (CANopen, J1939, UDS).
  why_it_matters: |
    CAN is ubiquitous in automotive, industrial, and medical embedded systems.
    Incorrect configuration causes communication failures, bus errors, or
    priority inversions. CAN's deterministic timing properties depend on
    proper setup. Bus off conditions and error handling are critical for
    system reliability.
  when_to_run:
  - During CAN integration
  - After communication issues
  - Before vehicle production
  - When adding CAN nodes
  - For protocol compliance
prerequisites:
  required_artifacts:
  - type: can_driver
    description: CAN driver source code
  - type: dbc_file
    description: CAN database definition
  - type: bus_design
    description: CAN network architecture
  - type: hardware_config
    description: CAN controller configuration
  access_requirements:
  - Access to source code
  - Access to CAN bus
  - CAN analyzer tool
  - DBC files
discovery:
  file_patterns:
  - glob: '**/can*.c'
    purpose: Find CAN driver code
  - glob: '**/canopen*.c'
    purpose: Find CANopen stack
  - glob: '**/j1939*.c'
    purpose: Find J1939 stack
  - glob: '**/*.dbc'
    purpose: Find CAN database
  - glob: '**/hal_can*.c'
    purpose: Find CAN HAL
knowledge_sources:
  guides:
  - id: can-spec
    name: CAN Specification 2.0
    url: https://www.bosch.com/can
  - id: canopen
    name: CANopen Specification
    url: https://www.can-cia.org/canopen
  standards:
  - id: iso-11898
    name: ISO 11898 CAN Standard
    relevance: CAN physical and data link
  - id: sae-j1939
    name: SAE J1939
    relevance: Heavy duty vehicle CAN
  - id: iso-15765
    name: ISO 15765 ISO-TP
    relevance: CAN transport protocol
tooling:
  analysis_tools:
  - tool: can-analyzer
    purpose: Bus monitoring
  - tool: vector-canape
    purpose: CAN analysis
  - tool: pcan-view
    purpose: CAN monitoring
  - tool: busmaster
    purpose: Open source CAN tool
signals:
  critical:
  - id: CAN-CRIT-001
    signal: CAN bus timing misconfigured
    evidence_indicators:
    - Bit timing errors
    - Communication failures
    - Nodes cannot sync
    explanation: |
      Incorrect bit timing causes communication failures. All nodes
      must use compatible timing parameters for reliable communication.
    remediation: Configure bit timing correctly for bus speed
  - id: CAN-CRIT-002
    signal: Bus off condition not handled
    evidence_indicators:
    - No bus-off recovery
    - Node stays offline
    - Communication lost permanently
    explanation: |
      Bus-off occurs from too many errors. Without recovery, the node
      is permanently disconnected.
    remediation: Implement automatic bus-off recovery
  high:
  - id: CAN-HIGH-001
    signal: Message priority inversion
    evidence_indicators:
    - Low priority message blocks high
    - Incorrect ID assignment
    - Timing requirements violated
    explanation: |
      CAN ID determines priority (lower = higher priority). Wrong ID
      assignment causes priority inversion.
    remediation: Assign CAN IDs based on message priority requirements
  - id: CAN-HIGH-002
    signal: Receive buffer overflow
    evidence_indicators:
    - Messages lost
    - Buffer overrun detected
    - Insufficient buffering
    explanation: |
      Message loss from buffer overflow causes data gaps. Buffer size
      must handle worst-case burst.
    remediation: Increase buffer size or improve processing rate
  medium:
  - id: CAN-MED-001
    signal: Error frame rate high
    evidence_indicators:
    - Frequent error frames
    - Bus quality degraded
    - Approaching bus-off
    explanation: |
      High error rate indicates bus problems - electrical, timing,
      or node malfunction. Investigation needed.
    remediation: Investigate and resolve error source
  - id: CAN-MED-002
    signal: DBC database mismatch
    evidence_indicators:
    - Message format differs
    - Signal scaling wrong
    - DBC not matching implementation
    explanation: |
      DBC mismatch causes incorrect data interpretation. Database
      must match actual implementation.
    remediation: Synchronize DBC with implementation
  low:
  - id: CAN-LOW-001
    signal: CAN configuration not documented
    evidence_indicators:
    - Bit timing not recorded
    - Filter configuration unclear
    - Message list incomplete
    explanation: |
      Documentation supports debugging and integration.
    remediation: Document CAN configuration and message definitions
  positive:
  - id: CAN-POS-001
    signal: Robust CAN implementation
    evidence_indicators:
    - Correct timing
    - Bus-off recovery
    - Low error rate
  - id: CAN-POS-002
    signal: Complete CAN documentation
    evidence_indicators:
    - DBC up to date
    - Configuration documented
    - Error handling specified
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Review CAN Configuration
    description: Examine bit timing and filter configuration
    duration_estimate: 1 hour
  - id: '2'
    name: Analyze Message Priority
    description: Review ID assignment and priority scheme
    duration_estimate: 1 hour
  - id: '3'
    name: Verify Error Handling
    description: Check bus-off and error recovery
    duration_estimate: 1 hour
  - id: '4'
    name: Monitor Bus Traffic
    description: Capture and analyze actual bus traffic
    duration_estimate: 1-2 hours
  - id: '5'
    name: Validate DBC Compliance
    description: Verify message format matches database
    duration_estimate: 30 minutes
  - id: '6'
    name: Document Findings
    description: Compile assessment report
    duration_estimate: 30 minutes
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Configuration Review
    - Priority Analysis
    - Bus Traffic Analysis
    - Recommendations
closeout_checklist:
- id: can-001
  item: CAN configuration reviewed
  level: CRITICAL
  verification: manual
- id: can-002
  item: Message priority analyzed
  level: HIGH
  verification: manual
- id: can-003
  item: Error handling verified
  level: HIGH
  verification: automated
- id: can-004
  item: Bus traffic monitored
  level: HIGH
  verification: automated
governance:
  applicable_to:
    archetypes:
    - automotive
    - industrial
    - medical-devices
  compliance_mappings:
  - framework: ISO 11898
    control: CAN Standard
    description: CAN compliance
  - framework: SAE J1939
    control: Transport
    description: Heavy duty vehicle
  - framework: AUTOSAR
    control: COM
    description: Communication stack
relationships:
  commonly_combined:
  - real-time-embedded.communication-protocols.protocol-timing
  - real-time-embedded.communication-protocols.message-integrity
  depends_on:
  - hardware.can-controller
  feeds_into:
  - communication.bus-reliability
  - diagnostics.can-diagnostics
