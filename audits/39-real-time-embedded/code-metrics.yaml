audit:
  id: real-time-embedded.firmware-quality.code-metrics
  name: Code Metrics Audit
  version: 1.0.0
  last_updated: '2025-01-22'
  status: active
  category: real-time-embedded
  category_number: 39
  subcategory: firmware-quality
  tier: expert
  estimated_duration: 3-5 hours  # median: 4h
  completeness: requires_discovery
  requires_runtime: false
  destructive: false
execution:
  automatable: full
  severity: medium
  scope: embedded-systems
  default_profiles:
  - full
  - quick
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Measures and analyzes code complexity metrics for embedded firmware including
    cyclomatic complexity, nesting depth, function length, coupling metrics,
    and code duplication. Evaluates metrics against industry thresholds and
    identifies high-risk modules requiring additional review or refactoring.
  why_it_matters: |
    Code complexity correlates with defect density and maintenance difficulty.
    Complex functions are harder to test, understand, and verify. Safety
    standards recommend complexity limits - DO-178C discourages complexity
    exceeding 10-15. Identifying high-complexity code enables targeted testing
    and refactoring to improve quality and reduce risk.
  when_to_run:
  - During code review
  - Before safety certification
  - When assessing technical debt
  - After major development phases
  - For legacy code assessment
prerequisites:
  required_artifacts:
  - type: source_code
    description: Complete firmware source code
  - type: build_configuration
    description: Build files for accurate parsing
  - type: metric_thresholds
    description: Project metric standards
  access_requirements:
  - Access to source code
  - Code metrics tool
  - Build system access
discovery:
  file_patterns:
  - glob: '**/*.c'
    purpose: Find C source files
  - glob: '**/*.h'
    purpose: Find header files
  - glob: '**/Makefile'
    purpose: Find build configuration
  - glob: '**/CMakeLists.txt'
    purpose: Find CMake configuration
knowledge_sources:
  guides:
  - id: code-complexity
    name: Understanding Code Complexity
    url: https://www.embedded.com/code-complexity
  - id: mccabe-complexity
    name: McCabe Cyclomatic Complexity
    url: https://www.mccabe.com/
  standards:
  - id: do-178c
    name: DO-178C Software Considerations
    relevance: Complexity guidance
  - id: iec-61508
    name: IEC 61508 Functional Safety
    relevance: Complexity recommendations
tooling:
  analysis_tools:
  - tool: lizard
    purpose: Open source complexity analyzer
  - tool: understand
    purpose: SciTools Understand
  - tool: cppcheck
    purpose: Basic metrics
  - tool: sonarqube
    purpose: Metrics and quality gates
signals:
  critical:
  - id: CM-CRIT-001
    signal: Safety-critical function exceeds complexity limit
    evidence_indicators:
    - Cyclomatic complexity > 50
    - Function in safety-critical path
    - Untestable complexity
    explanation: |
      Extreme complexity in safety-critical code is unacceptable.
      The code cannot be adequately tested or verified.
    remediation: Refactor to reduce complexity below threshold
  high:
  - id: CM-HIGH-001
    signal: Multiple functions exceed complexity threshold
    evidence_indicators:
    - Cyclomatic complexity > 15
    - Pattern of complex functions
    - Testing coverage difficult
    explanation: |
      High complexity indicates code that is difficult to test
      and maintain, increasing defect risk.
    remediation: Refactor complex functions
  - id: CM-HIGH-002
    signal: Excessive nesting depth
    evidence_indicators:
    - Nesting depth > 5
    - Complex conditional logic
    - Hard to follow control flow
    explanation: |
      Deep nesting makes code hard to understand and increases
      likelihood of logic errors.
    remediation: Reduce nesting through early returns or extraction
  medium:
  - id: CM-MED-001
    signal: Large functions prevalent
    evidence_indicators:
    - Functions > 200 lines
    - Multiple responsibilities
    - Difficult to unit test
    explanation: |
      Large functions often do too much and are hard to test
      in isolation. Single responsibility improves quality.
    remediation: Break large functions into smaller units
  - id: CM-MED-002
    signal: High code duplication
    evidence_indicators:
    - Duplicate code blocks
    - Copy-paste patterns
    - Maintenance burden
    explanation: |
      Duplicated code must be maintained in multiple places.
      Bugs fixed in one copy may not be fixed in others.
    remediation: Extract common code into shared functions
  low:
  - id: CM-LOW-001
    signal: Metrics not tracked over time
    evidence_indicators:
    - No trend analysis
    - One-time measurement only
    - Regression undetected
    explanation: |
      Tracking metrics over time shows quality trends and
      catches degradation early.
    remediation: Implement continuous metric tracking
  positive:
  - id: CM-POS-001
    signal: All functions within complexity limits
    evidence_indicators:
    - Cyclomatic complexity < 10
    - Clean, maintainable code
    - Good testability
  - id: CM-POS-002
    signal: Metrics integrated in quality gates
    evidence_indicators:
    - CI enforces thresholds
    - Trends tracked
    - Regression prevented
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Configure Metrics Tool
    description: Set up tool with project configuration
    duration_estimate: 30 minutes
  - id: '2'
    name: Run Metrics Analysis
    description: Execute metrics collection on codebase
    duration_estimate: 30 minutes
  - id: '3'
    name: Analyze Complexity Metrics
    description: Review cyclomatic complexity distribution
    duration_estimate: 1 hour
  - id: '4'
    name: Review Size Metrics
    description: Analyze function and file sizes
    duration_estimate: 30 minutes
  - id: '5'
    name: Identify High-Risk Modules
    description: Flag modules exceeding thresholds
    duration_estimate: 30 minutes
  - id: '6'
    name: Document Findings
    description: Compile metrics report with recommendations
    duration_estimate: 1 hour
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Complexity Analysis
    - Size Metrics
    - Duplication Analysis
    - High-Risk Module List
    - Recommendations
closeout_checklist:
- id: cm-001
  item: Metrics analysis completed
  level: HIGH
  verification: automated
- id: cm-002
  item: Complexity reviewed
  level: HIGH
  verification: automated
- id: cm-003
  item: High-risk modules identified
  level: HIGH
  verification: automated
- id: cm-004
  item: Recommendations documented
  level: MEDIUM
  verification: manual
governance:
  applicable_to:
    archetypes:
    - embedded-systems
    - safety-critical
    - maintainable
  compliance_mappings:
  - framework: DO-178C
    control: 6.3.1
    description: Complexity guidance
  - framework: IEC 61508
    control: Table B.1
    description: Complexity metrics
  - framework: ISO 26262
    control: Part 6
    description: Software design principles
relationships:
  commonly_combined:
  - real-time-embedded.firmware-quality.misra-compliance
  - real-time-embedded.firmware-quality.static-analysis-coverage
  depends_on:
  - build.source-configuration
  feeds_into:
  - quality.maintainability-assessment
  - testing.coverage-planning

# Glossary of domain-specific terms:
glossary:
  "WCET": "Worst-Case Execution Time - maximum possible execution time for a code path"
  "ISR": "Interrupt Service Routine - function executed in response to hardware interrupt"
  "jitter": "Variation in timing between expected and actual execution"
