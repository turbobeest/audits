audit:
  id: real-time-embedded.interrupt-handling.isr-design-review
  name: ISR Design Review Audit
  version: 1.0.0
  last_updated: '2025-01-22'
  status: active
  category: real-time-embedded
  category_number: 39
  subcategory: interrupt-handling
  tier: expert
  estimated_duration: 4-6 hours  # median: 5h
  completeness: requires_discovery
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: high
  scope: embedded-systems
  default_profiles:
  - full
  - quick
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Examines interrupt service routine (ISR) implementations for proper design
    patterns and best practices. Reviews ISR length, API usage restrictions,
    shared data protection, and interaction with RTOS kernel. Evaluates deferred
    processing approaches and ISR-task communication mechanisms.
  why_it_matters: |
    ISRs execute in constrained contexts with strict rules about what operations
    are safe. Long ISRs block other interrupts and delay task processing.
    Improper API usage in ISR context causes system crashes or deadlocks.
    Poor ISR design degrades system responsiveness and determinism. Correct
    ISR design is fundamental to reliable real-time systems.
  when_to_run:
  - During interrupt implementation
  - After adding new peripherals
  - When debugging interrupt issues
  - Before safety certification
  - During code review
prerequisites:
  required_artifacts:
  - type: source_code
    description: ISR implementations
  - type: interrupt_architecture
    description: Interrupt handling design
  - type: rtos_api
    description: RTOS ISR-safe API documentation
  - type: timing_requirements
    description: Interrupt response requirements
  access_requirements:
  - Access to source code
  - Access to RTOS documentation
  - Timing measurement tools
  - Debug/trace capability
discovery:
  file_patterns:
  - glob: '**/isr*.c'
    purpose: Find ISR implementations
  - glob: '**/irq*.c'
    purpose: Find interrupt handlers
  - glob: '**/handler*.c'
    purpose: Find handler implementations
  - glob: '**/interrupt*.c'
    purpose: Find interrupt code
  - glob: '**/vector*.c'
    purpose: Find vector table
knowledge_sources:
  guides:
  - id: isr-design
    name: ISR Design Best Practices
    url: https://www.embedded.com/isr-design
  - id: freertos-isr
    name: FreeRTOS Interrupt Management
    url: https://www.freertos.org/a00016.html
  standards:
  - id: misra-c
    name: MISRA C Guidelines
    relevance: ISR rules
  - id: autosar
    name: AUTOSAR OS Specification
    relevance: Category 1 and 2 ISRs
  - id: cert-c
    name: CERT C Coding Standard
    relevance: Signal handling rules
tooling:
  analysis_tools:
  - tool: pc-lint
    purpose: ISR API analysis
  - tool: tracealyzer
    purpose: ISR timing visualization
  - tool: oscilloscope
    purpose: ISR latency measurement
  - tool: profiler
    purpose: ISR execution time
signals:
  critical:
  - id: ISR-CRIT-001
    signal: Blocking API called from ISR
    evidence_indicators:
    - Mutex taken in ISR
    - Non-FromISR API used
    - System deadlock observed
    explanation: |
      Blocking calls in ISR context cause deadlock or undefined behavior.
      ISRs cannot wait for resources held by interrupted code.
    remediation: Use only ISR-safe, non-blocking API calls
  - id: ISR-CRIT-002
    signal: Excessive ISR execution time
    evidence_indicators:
    - ISR longer than requirements allow
    - Other interrupts blocked
    - Task starvation observed
    explanation: |
      Long ISRs delay other interrupt processing and starve task
      execution. ISRs should be as short as possible.
    remediation: Defer processing to task via ISR-task communication
  high:
  - id: ISR-HIGH-001
    signal: Shared data access without protection
    evidence_indicators:
    - ISR accesses non-atomic shared data
    - No interrupt disable in task
    - Race condition possible
    explanation: |
      ISR can interrupt task at any point. Shared data requires
      proper protection (atomic types or interrupt disable).
    remediation: Protect shared data with appropriate mechanism
  - id: ISR-HIGH-002
    signal: Printf or logging in ISR
    evidence_indicators:
    - Console output from ISR
    - File system access in ISR
    - Complex formatting in ISR
    explanation: |
      Printf and logging are not ISR-safe and take excessive time.
      They can cause crashes or data corruption.
    remediation: Remove logging from ISR or use simple ISR-safe trace
  medium:
  - id: ISR-MED-001
    signal: Memory allocation in ISR
    evidence_indicators:
    - Malloc called from ISR
    - Dynamic buffer allocation
    - Non-deterministic ISR timing
    explanation: |
      Memory allocation is non-deterministic and often not ISR-safe.
      Pre-allocate buffers or use fixed pools.
    remediation: Pre-allocate all ISR buffers statically
  - id: ISR-MED-002
    signal: Complex logic in ISR
    evidence_indicators:
    - Heavy computation in ISR
    - Nested loops
    - Protocol processing
    explanation: |
      Complex processing in ISR increases latency and blocking time.
      Defer to task for better system behavior.
    remediation: Move complex processing to deferred task
  low:
  - id: ISR-LOW-001
    signal: ISR design not documented
    evidence_indicators:
    - ISR purpose unclear
    - Timing requirements not specified
    - Interface not documented
    explanation: |
      Documentation supports maintenance and helps prevent
      introduction of unsafe patterns.
    remediation: Document ISR design and constraints
  positive:
  - id: ISR-POS-001
    signal: Minimal ISR with proper deferred processing
    evidence_indicators:
    - ISR does minimum necessary
    - Proper ISR-task handoff
    - Short execution time
  - id: ISR-POS-002
    signal: ISR-safe API used throughout
    evidence_indicators:
    - Only FromISR variants called
    - No blocking operations
    - Proper yield handling
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Inventory All ISRs
    description: Document all interrupt service routines
    duration_estimate: 30 minutes
  - id: '2'
    name: Review API Usage
    description: Check all API calls for ISR safety
    duration_estimate: 1-2 hours
  - id: '3'
    name: Analyze Shared Data
    description: Identify and verify shared data protection
    duration_estimate: 1 hour
  - id: '4'
    name: Measure Execution Times
    description: Profile ISR execution duration
    duration_estimate: 1 hour
  - id: '5'
    name: Review Deferred Processing
    description: Evaluate ISR-task communication patterns
    duration_estimate: 30 minutes
  - id: '6'
    name: Document Findings
    description: Compile analysis results and recommendations
    duration_estimate: 30 minutes
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - ISR Inventory
    - API Safety Analysis
    - Timing Analysis
    - Recommendations
closeout_checklist:
- id: isr-001
  item: All ISRs inventoried
  level: HIGH
  verification: manual
- id: isr-002
  item: API usage verified
  level: CRITICAL
  verification: automated
- id: isr-003
  item: Shared data protection checked
  level: HIGH
  verification: manual
- id: isr-004
  item: Execution times measured
  level: HIGH
  verification: automated
governance:
  applicable_to:
    archetypes:
    - embedded-systems
    - safety-critical
    - real-time
  compliance_mappings:
  - framework: MISRA C
    control: Rule 21.2
    description: ISR restrictions
  - framework: AUTOSAR
    control: OS ISR
    description: ISR categories
  - framework: DO-178C
    control: 6.3.1
    description: Interrupt handling
relationships:
  commonly_combined:
  - real-time-embedded.interrupt-handling.isr-latency-analysis
  - real-time-embedded.interrupt-handling.interrupt-priority-configuration
  depends_on:
  - architecture.interrupt-architecture
  feeds_into:
  - real-time-embedded.timing-analysis.deadline-verification
  - reliability.interrupt-reliability

# Glossary of domain-specific terms:
glossary:
  "WCET": "Worst-Case Execution Time - maximum possible execution time for a code path"
  "ISR": "Interrupt Service Routine - function executed in response to hardware interrupt"
  "jitter": "Variation in timing between expected and actual execution"
