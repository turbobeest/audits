# ============================================================
# AUDIT: Firmware Signing
# Category: 39 - Real-Time & Embedded Systems
# Subcategory: bootloader-security
# ============================================================

audit:
  id: "real-time-embedded.bootloader-security.firmware-signing"
  name: "Firmware Signing Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "real-time-embedded"
  category_number: 39
  subcategory: "bootloader-security"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "embedded-systems"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the firmware signing infrastructure and process including signing
    key management, signature generation workflow, build integration, and
    certificate handling. Reviews the cryptographic algorithms used, key
    protection mechanisms, and signature verification robustness.

  why_it_matters: |
    Firmware signing ensures only authorized code runs on devices. Compromised
    signing keys enable attackers to create malicious firmware that passes
    verification. The signing process must be secure end-to-end, from key
    generation through build integration to verification on device.

  when_to_run:
    - "When establishing signing infrastructure"
    - "During security architecture review"
    - "Before security certification"
    - "After key management changes"
    - "For compliance audits"

prerequisites:
  required_artifacts:
    - type: "signing_infrastructure"
      description: "Signing server and process documentation"
    - type: "key_management"
      description: "Key storage and access controls"
    - type: "build_system"
      description: "Build pipeline with signing integration"
    - type: "certificate_chain"
      description: "Certificate hierarchy documentation"

  access_requirements:
    - "Access to signing infrastructure"
    - "Access to key management documentation"
    - "Build system access"
    - "Certificate authority documentation"

discovery:
  file_patterns:
    - glob: "**/sign*.py"
      purpose: "Find signing scripts"
    - glob: "**/sign*.sh"
      purpose: "Find signing shell scripts"
    - glob: "**/*.pem"
      purpose: "Find certificates and keys"
    - glob: "**/Makefile"
      purpose: "Find build integration"
    - glob: "**/signing_config*"
      purpose: "Find signing configuration"

knowledge_sources:
  guides:
    - id: "code-signing"
      name: "Code Signing Best Practices"
      url: "https://www.embedded.com/code-signing"
    - id: "hsm-integration"
      name: "HSM Integration for Signing"
      url: "https://www.embedded.com/hsm-signing"

  standards:
    - id: "nist-key-management"
      name: "NIST SP 800-57"
      relevance: "Key management recommendations"
    - id: "common-criteria"
      name: "Common Criteria"
      relevance: "Security evaluation"

tooling:
  analysis_tools:
    - tool: "openssl"
      purpose: "Certificate analysis"
    - tool: "hsm-tools"
      purpose: "HSM interaction"
    - tool: "signtool"
      purpose: "Signature verification"

signals:
  critical:
    - id: "FS-CRIT-001"
      signal: "Signing keys stored unprotected"
      evidence_indicators:
        - "Keys in file system"
        - "No HSM or secure element"
        - "Keys accessible to developers"
      explanation: |
        Unprotected signing keys can be stolen, allowing attackers to
        sign malicious firmware. Keys must be hardware-protected.
      remediation: "Store signing keys in HSM with strict access controls"

    - id: "FS-CRIT-002"
      signal: "Signing process can be bypassed"
      evidence_indicators:
        - "Unsigned builds possible"
        - "No build enforcement"
        - "Manual signing optional"
      explanation: |
        If unsigned firmware can be released, the signing protection
        is ineffective. Signing must be mandatory for releases.
      remediation: "Enforce signing in build pipeline with no bypass"

  high:
    - id: "FS-HIGH-001"
      signal: "Weak signing algorithms used"
      evidence_indicators:
        - "SHA-1 signatures"
        - "RSA-1024 or smaller"
        - "MD5 hashing"
      explanation: |
        Weak algorithms can be compromised, enabling signature forgery.
        Use current cryptographic standards.
      remediation: "Upgrade to SHA-256+ and RSA-2048+ or ECDSA P-256+"

    - id: "FS-HIGH-002"
      signal: "No key rotation plan"
      evidence_indicators:
        - "Keys never expire"
        - "No rotation procedure"
        - "No key revocation mechanism"
      explanation: |
        Keys should be rotated periodically and revocable if compromised.
        Without rotation, compromise impact is unlimited.
      remediation: "Implement key rotation and revocation procedures"

  medium:
    - id: "FS-MED-001"
      signal: "Certificate chain validation incomplete"
      evidence_indicators:
        - "Self-signed certificates only"
        - "Incomplete chain"
        - "No root certificate protection"
      explanation: |
        Proper certificate chain provides revocation capability and
        hierarchical trust. Single certificates lack flexibility.
      remediation: "Implement full certificate chain with proper CA"

    - id: "FS-MED-002"
      signal: "Signing audit trail incomplete"
      evidence_indicators:
        - "No signing logs"
        - "Who signed unknown"
        - "What was signed unclear"
      explanation: |
        Audit trail is essential for security monitoring and incident
        investigation. All signing must be logged.
      remediation: "Implement comprehensive signing audit logging"

  low:
    - id: "FS-LOW-001"
      signal: "Signing process not documented"
      evidence_indicators:
        - "Process unclear"
        - "Key procedures missing"
        - "Emergency procedures undefined"
      explanation: |
        Documentation ensures process can be followed correctly and
        supports incident response.
      remediation: "Document complete signing process and procedures"

  positive:
    - id: "FS-POS-001"
      signal: "Robust signing infrastructure"
      evidence_indicators:
        - "HSM-protected keys"
        - "Mandatory signing in build"
        - "Strong algorithms"

    - id: "FS-POS-002"
      signal: "Comprehensive key management"
      evidence_indicators:
        - "Key rotation implemented"
        - "Revocation capability"
        - "Full audit trail"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Review Signing Infrastructure"
      description: "Examine signing server and tools"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Analyze Key Protection"
      description: "Assess key storage and access controls"
      duration_estimate: "1-2 hours"

    - id: "3"
      name: "Review Cryptographic Choices"
      description: "Evaluate algorithms and key sizes"
      duration_estimate: "30 minutes"

    - id: "4"
      name: "Examine Build Integration"
      description: "Verify signing is mandatory in build"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Check Key Management Procedures"
      description: "Review rotation and revocation"
      duration_estimate: "30 minutes"

    - id: "6"
      name: "Document Findings"
      description: "Compile assessment report"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Infrastructure Review"
        - "Key Management Assessment"
        - "Cryptographic Analysis"
        - "Recommendations"

closeout_checklist:
  - id: "fs-001"
    item: "Signing infrastructure reviewed"
    level: "CRITICAL"
    verification: "manual"
  - id: "fs-002"
    item: "Key protection assessed"
    level: "CRITICAL"
    verification: "manual"
  - id: "fs-003"
    item: "Build integration verified"
    level: "HIGH"
    verification: "automated"
  - id: "fs-004"
    item: "Key management reviewed"
    level: "HIGH"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["embedded-systems", "security-critical", "iot", "automotive"]

  compliance_mappings:
    - framework: "IEC 62443"
      control: "SR 3.1"
      description: "Communication integrity"
    - framework: "UN ECE WP.29"
      control: "R156"
      description: "Software updates"
    - framework: "NIST SP 800-57"
      control: "Part 1"
      description: "Key management"

relationships:
  commonly_combined:
    - "real-time-embedded.bootloader-security.secure-boot-chain"
    - "real-time-embedded.bootloader-security.secure-update"
  depends_on:
    - "cryptography.key-management"
    - "infrastructure.hsm"
  feeds_into:
    - "security.supply-chain-security"
    - "certification.security-certification"
