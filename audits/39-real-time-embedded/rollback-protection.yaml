# ============================================================
# AUDIT: Rollback Protection
# Category: 39 - Real-Time & Embedded Systems
# Subcategory: bootloader-security
# ============================================================

audit:
  id: "real-time-embedded.bootloader-security.rollback-protection"
  name: "Rollback Protection Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "real-time-embedded"
  category_number: 39
  subcategory: "bootloader-security"

  tier: "expert"
  estimated_duration: "3-5 hours"  # median: 4h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "embedded-systems"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates anti-rollback mechanisms that prevent installation of older
    firmware versions. Reviews monotonic counter implementation, version
    comparison logic, secure storage of version information, and handling
    of legitimate rollback scenarios.

  why_it_matters: |
    Rollback attacks reinstall older vulnerable firmware to exploit known
    security flaws that were patched in newer versions. Anti-rollback
    protection ensures security improvements cannot be undone. The mechanism
    must be robust against both accidental and malicious downgrade attempts.

  when_to_run:
    - "When implementing version control"
    - "During security architecture review"
    - "Before security certification"
    - "After bootloader changes"
    - "For compliance verification"

prerequisites:
  required_artifacts:
    - type: "bootloader_source"
      description: "Bootloader version checking code"
    - type: "version_storage"
      description: "Version counter implementation"
    - type: "update_mechanism"
      description: "Update version handling"
    - type: "hardware_docs"
      description: "Secure storage documentation"

  access_requirements:
    - "Access to bootloader source"
    - "Access to secure storage"
    - "Hardware debug capability"
    - "Test firmware versions"

discovery:
  file_patterns:
    - glob: "**/version*.c"
      purpose: "Find version handling"
    - glob: "**/rollback*.c"
      purpose: "Find rollback protection"
    - glob: "**/otp*.c"
      purpose: "Find OTP/fuse handling"
    - glob: "**/counter*.c"
      purpose: "Find monotonic counters"
    - glob: "**/bootloader*.c"
      purpose: "Find bootloader code"

knowledge_sources:
  guides:
    - id: "anti-rollback"
      name: "Anti-Rollback Design"
      url: "https://www.embedded.com/anti-rollback"
    - id: "secure-counter"
      name: "Secure Monotonic Counters"
      url: "https://developer.arm.com/documentation"

  standards:
    - id: "arm-psa"
      name: "ARM Platform Security Architecture"
      relevance: "Rollback protection guidance"
    - id: "uptane"
      name: "Uptane Framework"
      relevance: "Automotive anti-rollback"

tooling:
  analysis_tools:
    - tool: "debugger"
      purpose: "Counter inspection"
    - tool: "flash-programmer"
      purpose: "Version modification testing"
    - tool: "custom-test-tools"
      purpose: "Rollback attempt testing"

signals:
  critical:
    - id: "RP-CRIT-001"
      signal: "No rollback protection implemented"
      evidence_indicators:
        - "Any firmware version installable"
        - "No version checking"
        - "Downgrade freely possible"
      explanation: |
        Without rollback protection, attackers can reinstall vulnerable
        versions to exploit patched vulnerabilities.
      remediation: "Implement monotonic counter-based version enforcement"

    - id: "RP-CRIT-002"
      signal: "Rollback counter can be reset"
      evidence_indicators:
        - "Counter stored in erasable flash"
        - "Counter can be cleared"
        - "Reset attack possible"
      explanation: |
        Resettable counters provide no protection. Counter must be
        stored in one-time-programmable (OTP) or secure element.
      remediation: "Store counter in OTP fuses or secure hardware"

  high:
    - id: "RP-HIGH-001"
      signal: "Version comparison logic flawed"
      evidence_indicators:
        - "Comparison can be bypassed"
        - "Integer overflow possible"
        - "Logic error in check"
      explanation: |
        Flawed comparison logic may allow rollback despite counter.
        The check must be robust against all bypass attempts.
      remediation: "Fix version comparison logic"

    - id: "RP-HIGH-002"
      signal: "Limited counter space"
      evidence_indicators:
        - "Few counter bits available"
        - "Will exhaust in product lifetime"
        - "No counter extension mechanism"
      explanation: |
        Counter exhaustion prevents further updates. Sufficient counter
        space must be available for product lifetime.
      remediation: "Ensure adequate counter capacity or implement extension"

  medium:
    - id: "RP-MED-001"
      signal: "Counter increment on every update"
      evidence_indicators:
        - "Minor updates consume counter"
        - "Rapid counter consumption"
        - "Inefficient counter use"
      explanation: |
        Incrementing for every update wastes limited counter space.
        Consider security-only counter increments.
      remediation: "Increment counter only for security-relevant updates"

    - id: "RP-MED-002"
      signal: "No emergency rollback procedure"
      evidence_indicators:
        - "No way to recover from bad update"
        - "Field brick if update buggy"
        - "No authorized rollback"
      explanation: |
        Some rollback capability may be needed for emergency recovery.
        This must be secured and controlled.
      remediation: "Implement secured emergency rollback with authorization"

  low:
    - id: "RP-LOW-001"
      signal: "Rollback protection not documented"
      evidence_indicators:
        - "Mechanism unclear"
        - "Counter management undefined"
        - "Policy not specified"
      explanation: |
        Documentation supports correct implementation and maintenance.
      remediation: "Document rollback protection design and policy"

  positive:
    - id: "RP-POS-001"
      signal: "Robust anti-rollback implementation"
      evidence_indicators:
        - "OTP-based counter"
        - "Secure comparison logic"
        - "Adequate capacity"

    - id: "RP-POS-002"
      signal: "Well-designed version policy"
      evidence_indicators:
        - "Efficient counter usage"
        - "Emergency provisions"
        - "Policy documented"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Review Counter Implementation"
      description: "Examine monotonic counter storage and increment"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Analyze Comparison Logic"
      description: "Review version checking implementation"
      duration_estimate: "1 hour"

    - id: "3"
      name: "Test Rollback Attempts"
      description: "Attempt to install older firmware"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Evaluate Counter Capacity"
      description: "Assess counter lifetime adequacy"
      duration_estimate: "30 minutes"

    - id: "5"
      name: "Review Emergency Procedures"
      description: "Assess authorized rollback capability"
      duration_estimate: "30 minutes"

    - id: "6"
      name: "Document Findings"
      description: "Compile assessment report"
      duration_estimate: "30 minutes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Counter Implementation Review"
        - "Version Logic Analysis"
        - "Attack Testing Results"
        - "Recommendations"

closeout_checklist:
  - id: "rp-001"
    item: "Counter implementation reviewed"
    level: "CRITICAL"
    verification: "manual"
  - id: "rp-002"
    item: "Comparison logic analyzed"
    level: "CRITICAL"
    verification: "manual"
  - id: "rp-003"
    item: "Rollback attempts tested"
    level: "CRITICAL"
    verification: "automated"
  - id: "rp-004"
    item: "Counter capacity evaluated"
    level: "HIGH"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["embedded-systems", "security-critical", "automotive", "iot"]

  compliance_mappings:
    - framework: "ARM PSA"
      control: "Anti-Rollback"
      description: "Platform security requirement"
    - framework: "Uptane"
      control: "Version Tracking"
      description: "Automotive update security"
    - framework: "IEC 62443"
      control: "SR 7.6"
      description: "Rollback protection"

relationships:
  commonly_combined:
    - "real-time-embedded.bootloader-security.secure-boot-chain"
    - "real-time-embedded.bootloader-security.secure-update"
  depends_on:
    - "hardware.otp-fuses"
    - "real-time-embedded.bootloader-security.secure-boot-chain"
  feeds_into:
    - "security.version-control"
    - "operations.update-policy"
