# ============================================================
# AUDIT: ISR Latency Analysis
# Category: 39 - Real-Time & Embedded Systems
# Subcategory: interrupt-handling
# ============================================================

audit:
  id: "real-time-embedded.interrupt-handling.isr-latency-analysis"
  name: "ISR Latency Analysis Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "real-time-embedded"
  category_number: 39
  subcategory: "interrupt-handling"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  requires_physical_access: true
  severity: "critical"
  scope: "embedded-systems"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Measures and analyzes interrupt latency to ensure hardware events are
    serviced within required time bounds. Examines interrupt disable durations,
    higher-priority interrupt blocking, and kernel/task blocking factors.
    Calculates worst-case interrupt latency for critical interrupts.

  why_it_matters: |
    Interrupt latency directly affects system responsiveness to external events.
    Excessive latency causes missed hardware deadlines, data overruns, and
    lost events. In safety-critical systems, delayed interrupt response can
    lead to hazardous conditions. Understanding and bounding latency is
    essential for deterministic real-time behavior.

  when_to_run:
    - "During timing characterization"
    - "After interrupt changes"
    - "When debugging missed events"
    - "Before safety certification"
    - "After RTOS changes"

prerequisites:
  required_artifacts:
    - type: "interrupt_architecture"
      description: "Interrupt priority and configuration"
    - type: "timing_requirements"
      description: "Latency requirements per interrupt"
    - type: "source_code"
      description: "ISR and critical section code"
    - type: "rtos_configuration"
      description: "Kernel interrupt handling settings"

  access_requirements:
    - "Access to source code"
    - "Hardware timing measurement capability"
    - "Logic analyzer or oscilloscope"
    - "Debug trace capability"

discovery:
  file_patterns:
    - glob: "**/critical_section*.c"
      purpose: "Find critical sections"
    - glob: "**/isr*.c"
      purpose: "Find ISR implementations"
    - glob: "**/port*.c"
      purpose: "Find RTOS port code"
    - glob: "**/portmacro.h"
      purpose: "Find port critical macros"
    - glob: "**/nvic*.c"
      purpose: "Find interrupt controller code"

knowledge_sources:
  guides:
    - id: "interrupt-latency"
      name: "Understanding Interrupt Latency"
      url: "https://www.embedded.com/interrupt-latency"
    - id: "arm-nvic"
      name: "ARM NVIC and Latency"
      url: "https://developer.arm.com/documentation/ddi0439/latest"

  standards:
    - id: "do-178c"
      name: "DO-178C Software Considerations"
      relevance: "Interrupt timing requirements"
    - id: "iso-26262"
      name: "ISO 26262 Functional Safety"
      relevance: "Response time requirements"

tooling:
  analysis_tools:
    - tool: "oscilloscope"
      purpose: "Measure actual latency"
    - tool: "logic-analyzer"
      purpose: "Event timing capture"
    - tool: "tracealyzer"
      purpose: "Interrupt visualization"
    - tool: "segger-systemview"
      purpose: "Real-time analysis"

signals:
  critical:
    - id: "LAT-CRIT-001"
      signal: "Interrupt latency exceeds hardware deadline"
      evidence_indicators:
        - "Measured latency > requirement"
        - "Data buffer overrun"
        - "Hardware event missed"
      explanation: |
        When latency exceeds the time available, hardware events are
        missed or data is lost. This is a fundamental timing failure.
      remediation: "Reduce interrupt disable time and blocking factors"

    - id: "LAT-CRIT-002"
      signal: "Unbounded interrupt disable duration"
      evidence_indicators:
        - "Long critical sections"
        - "Nested disables without analysis"
        - "Variable disable time"
      explanation: |
        Unbounded interrupt disable makes latency unpredictable and
        potentially unlimited. All paths must be bounded.
      remediation: "Analyze and bound all interrupt disable durations"

  high:
    - id: "LAT-HIGH-001"
      signal: "Lower priority interrupt masks higher priority"
      evidence_indicators:
        - "Global interrupt disable"
        - "Priority ceiling raised excessively"
        - "Unnecessary masking"
      explanation: |
        Global disable or excessive ceiling raises block even higher
        priority interrupts that should be serviced.
      remediation: "Use selective masking instead of global disable"

    - id: "LAT-HIGH-002"
      signal: "Kernel critical section too long"
      evidence_indicators:
        - "RTOS calls with interrupt disabled"
        - "Long scheduler critical sections"
        - "Latency from kernel operations"
      explanation: |
        Kernel critical sections contribute to worst-case latency.
        Long sections bound system responsiveness.
      remediation: "Minimize kernel critical section time or split"

  medium:
    - id: "LAT-MED-001"
      signal: "Latency variation exceeds jitter budget"
      evidence_indicators:
        - "Wide latency distribution"
        - "Occasional long latencies"
        - "Inconsistent response time"
      explanation: |
        Variable latency causes jitter in event handling. Some
        applications require consistent response time.
      remediation: "Reduce sources of latency variation"

    - id: "LAT-MED-002"
      signal: "Interrupt priority inversion"
      evidence_indicators:
        - "Higher priority delayed by lower priority"
        - "Shared resource blocking"
        - "Priority mask inheritance missing"
      explanation: |
        When lower priority code blocks higher priority interrupts,
        priority inversion increases latency.
      remediation: "Implement priority inheritance for interrupt masking"

  low:
    - id: "LAT-LOW-001"
      signal: "Latency requirements not documented"
      evidence_indicators:
        - "Requirements not specified"
        - "No latency budget"
        - "Measurement criteria unclear"
      explanation: |
        Without documented requirements, latency adequacy cannot be
        verified. Requirements enable systematic analysis.
      remediation: "Document interrupt latency requirements"

  positive:
    - id: "LAT-POS-001"
      signal: "Interrupt latency meets requirements with margin"
      evidence_indicators:
        - "Measured latency < 80% of limit"
        - "Consistent measurements"
        - "Analysis bounds verified"

    - id: "LAT-POS-002"
      signal: "Latency sources fully characterized"
      evidence_indicators:
        - "All blocking factors identified"
        - "Worst-case calculated"
        - "Results documented"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Document Latency Requirements"
      description: "Gather latency requirements for each critical interrupt"
      duration_estimate: "30 minutes"

    - id: "2"
      name: "Identify Blocking Factors"
      description: "Find all sources of interrupt blocking"
      duration_estimate: "1-2 hours"

    - id: "3"
      name: "Analyze Critical Sections"
      description: "Measure interrupt disable durations"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Measure Actual Latencies"
      description: "Capture latency measurements under load"
      duration_estimate: "1-2 hours"

    - id: "5"
      name: "Calculate Worst-Case"
      description: "Determine worst-case latency from analysis"
      duration_estimate: "30 minutes"

    - id: "6"
      name: "Document Findings"
      description: "Compile analysis results and recommendations"
      duration_estimate: "30 minutes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Requirements Summary"
        - "Blocking Factor Analysis"
        - "Measurement Results"
        - "Recommendations"

closeout_checklist:
  - id: "lat-001"
    item: "Latency requirements documented"
    level: "CRITICAL"
    verification: "manual"
  - id: "lat-002"
    item: "Blocking factors identified"
    level: "CRITICAL"
    verification: "manual"
  - id: "lat-003"
    item: "Critical sections analyzed"
    level: "HIGH"
    verification: "automated"
  - id: "lat-004"
    item: "Measurements completed"
    level: "CRITICAL"
    verification: "automated"

governance:
  applicable_to:
    archetypes: ["embedded-systems", "safety-critical", "real-time"]

  compliance_mappings:
    - framework: "DO-178C"
      control: "6.3.4"
      description: "Timing analysis"
    - framework: "ISO 26262"
      control: "Part 6"
      description: "Response time requirements"
    - framework: "IEC 61508"
      control: "7.4.3"
      description: "Timing verification"

relationships:
  commonly_combined:
    - "real-time-embedded.interrupt-handling.isr-design-review"
    - "real-time-embedded.timing-analysis.jitter-measurement"
  depends_on:
    - "real-time-embedded.interrupt-handling.interrupt-priority-configuration"
  feeds_into:
    - "real-time-embedded.timing-analysis.deadline-verification"
    - "reliability.response-time-guarantee"

# Glossary of domain-specific terms:
glossary:
  "WCET": "Worst-Case Execution Time - maximum possible execution time for a code path"
  "ISR": "Interrupt Service Routine - function executed in response to hardware interrupt"
  "jitter": "Variation in timing between expected and actual execution"
