audit:
  id: real-time-embedded.communication-protocols.modbus-implementation
  name: Modbus Implementation Audit
  version: 1.0.0
  last_updated: '2025-01-22'
  status: active
  category: real-time-embedded
  category_number: 39
  subcategory: communication-protocols
  tier: expert
  estimated_duration: 4-6 hours  # median: 5h
  completeness: requires_discovery
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: high
  scope: embedded-systems
  default_profiles:
  - full
  - quick
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Reviews Modbus protocol implementation including RTU/ASCII/TCP variants,
    function code handling, register mapping, exception response generation,
    and timing compliance. Examines security considerations for Modbus
    deployments.
  why_it_matters: |
    Modbus is widely used in industrial control systems (ICS) and building
    automation. Incorrect implementation causes communication failures,
    data corruption, or security vulnerabilities. Modbus has no built-in
    security, making implementation quality critical in sensitive environments.
  when_to_run:
  - During Modbus integration
  - For ICS security assessment
  - Before industrial deployment
  - After communication issues
  - For protocol compliance
prerequisites:
  required_artifacts:
  - type: modbus_implementation
    description: Modbus stack source code
  - type: register_map
    description: Modbus register definitions
  - type: protocol_config
    description: Protocol configuration
  - type: network_design
    description: Modbus network architecture
  access_requirements:
  - Access to source code
  - Access to Modbus network
  - Modbus testing tools
  - Protocol analyzer
discovery:
  file_patterns:
  - glob: '**/modbus*.c'
    purpose: Find Modbus implementation
  - glob: '**/mb_*.c'
    purpose: Find Modbus code
  - glob: '**/register_map*.h'
    purpose: Find register definitions
  - glob: '**/serial*.c'
    purpose: Find serial port code
  - glob: '**/tcp_server*.c'
    purpose: Find TCP server
knowledge_sources:
  guides:
  - id: modbus-spec
    name: Modbus Protocol Specification
    url: https://modbus.org/specs.php
  - id: modbus-security
    name: Modbus Security Guide
    url: https://www.embedded.com/modbus-security
  standards:
  - id: modbus-protocol
    name: Modbus Protocol Specification
    relevance: Protocol compliance
  - id: iec-62443
    name: IEC 62443
    relevance: Industrial security
tooling:
  analysis_tools:
  - tool: modbus-poll
    purpose: Modbus master testing
  - tool: modbus-slave
    purpose: Slave simulation
  - tool: wireshark
    purpose: Modbus TCP analysis
  - tool: serial-monitor
    purpose: RTU monitoring
signals:
  critical:
  - id: MB-CRIT-001
    signal: Write access to critical registers unrestricted
    evidence_indicators:
    - Safety registers writable by any master
    - No access control
    - Remote command execution possible
    explanation: |
      Modbus lacks authentication. Unrestricted write access to
      critical registers enables unauthorized control.
    remediation: Implement access control or network segmentation
  - id: MB-CRIT-002
    signal: Buffer overflow in function code handler
    evidence_indicators:
    - Input length not validated
    - Array overflow possible
    - Memory corruption from malformed request
    explanation: |
      Malformed Modbus requests can cause buffer overflows if input
      validation is insufficient.
    remediation: Validate all input lengths against buffer sizes
  high:
  - id: MB-HIGH-001
    signal: Exception responses reveal information
    evidence_indicators:
    - Different responses for valid/invalid addresses
    - Register map discoverable
    - Information leakage
    explanation: |
      Distinct exception codes enable attackers to map valid
      registers and understand system structure.
    remediation: Return consistent exception codes
  - id: MB-HIGH-002
    signal: Timing violations in RTU mode
    evidence_indicators:
    - Inter-character delays wrong
    - Frame timing not compliant
    - Framing errors frequent
    explanation: |
      Modbus RTU timing is critical. Violations cause framing errors
      and communication failures.
    remediation: Ensure RTU timing compliance
  medium:
  - id: MB-MED-001
    signal: CRC/LRC validation incomplete
    evidence_indicators:
    - Checksum not verified
    - Corrupted data accepted
    - Data integrity not assured
    explanation: |
      Checksum validation catches transmission errors. Skipping
      verification risks accepting corrupted data.
    remediation: Always validate checksum before processing
  - id: MB-MED-002
    signal: No rate limiting on requests
    evidence_indicators:
    - DoS attack possible
    - Resource exhaustion
    - Unlimited request rate
    explanation: |
      Without rate limiting, attackers can overwhelm the slave
      with requests, causing denial of service.
    remediation: Implement request rate limiting
  low:
  - id: MB-LOW-001
    signal: Register map not documented
    evidence_indicators:
    - Register purpose unclear
    - Data types not specified
    - Scale factors missing
    explanation: |
      Documentation supports integration and troubleshooting.
    remediation: Document complete register map
  positive:
  - id: MB-POS-001
    signal: Robust Modbus implementation
    evidence_indicators:
    - Input validation complete
    - Timing compliant
    - Checksums verified
  - id: MB-POS-002
    signal: Security measures implemented
    evidence_indicators:
    - Access control in place
    - Network segmented
    - Rate limiting active
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Review Protocol Implementation
    description: Examine function code handling and timing
    duration_estimate: 1-2 hours
  - id: '2'
    name: Analyze Register Map
    description: Review register definitions and access control
    duration_estimate: 1 hour
  - id: '3'
    name: Test Input Validation
    description: Send malformed requests to test validation
    duration_estimate: 1-2 hours
  - id: '4'
    name: Verify Timing Compliance
    description: Measure RTU timing parameters
    duration_estimate: 30 minutes
  - id: '5'
    name: Security Assessment
    description: Evaluate security posture
    duration_estimate: 30 minutes
  - id: '6'
    name: Document Findings
    description: Compile assessment report
    duration_estimate: 30 minutes
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Implementation Review
    - Register Analysis
    - Security Assessment
    - Recommendations
closeout_checklist:
- id: mb-001
  item: Protocol implementation reviewed
  level: HIGH
  verification: manual
- id: mb-002
  item: Input validation tested
  level: CRITICAL
  verification: automated
- id: mb-003
  item: Timing compliance verified
  level: HIGH
  verification: automated
- id: mb-004
  item: Security assessed
  level: HIGH
  verification: manual
governance:
  applicable_to:
    archetypes:
    - industrial-control
    - building-automation
    - scada
  compliance_mappings:
  - framework: IEC 62443
    control: SR 3.1
    description: Communication integrity
  - framework: Modbus
    control: Protocol Spec
    description: Protocol compliance
relationships:
  commonly_combined:
  - real-time-embedded.communication-protocols.protocol-security
  - real-time-embedded.communication-protocols.industrial-protocol-safety
  depends_on:
  - hardware.serial-interface
  - network.tcp-ip-stack
  feeds_into:
  - security.ics-security
  - communication.protocol-reliability
