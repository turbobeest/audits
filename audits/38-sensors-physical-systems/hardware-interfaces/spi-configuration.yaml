audit:
  id: sensors-physical-systems.hardware-interfaces.spi-configuration
  name: SPI Configuration Audit
  version: 1.0.0
  last_updated: '2025-01-22'
  status: active
  category: sensors-physical-systems
  category_number: 38
  subcategory: hardware-interfaces
  tier: expert
  estimated_duration: 3-4 hours  # median: 3h
  completeness: requires_discovery
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: medium
  scope: physical-systems
  default_profiles:
  - full
  - quick
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Reviews SPI bus configuration including clock mode (CPOL/CPHA), clock frequency,
    chip select management, data ordering, signal integrity, and multi-device
    arbitration. Assesses driver implementation, timing margins, and electrical
    characteristics.
  why_it_matters: |
    Incorrect SPI configuration causes data corruption, communication failures,
    or intermittent errors that are difficult to diagnose. Proper configuration
    ensures reliable high-speed communication with sensors and peripherals.
  when_to_run:
  - During SPI interface design
  - When communication errors occur
  - After adding SPI devices
  - Before production release
  - When changing clock speeds
prerequisites:
  required_artifacts:
  - type: schematic
    description: SPI bus schematic
  - type: driver_source
    description: SPI driver source code
  - type: device_specs
    description: SPI device datasheets
  access_requirements:
  - Access to SPI signals
  - Logic analyzer access
  - Oscilloscope for signal quality
  - Driver source code access
discovery:
  file_patterns:
  - glob: '**/*spi*.c'
    purpose: Find SPI driver code
  - glob: '**/drivers/spi/**'
    purpose: Find SPI driver directory
  - glob: '**/config/*spi*.yaml'
    purpose: Find SPI configuration
  - glob: '**/*chipselect*.c'
    purpose: Find chip select handling
knowledge_sources:
  guides:
  - id: spi-basics
    name: SPI Protocol Basics
    url: https://www.analog.com/
  - id: spi-design
    name: SPI Design Guidelines
    url: https://www.ti.com/
  standards:
  - id: iec-61158
    name: IEC 61158 Fieldbus
    relevance: Industrial communication standards
  - id: motorola-spi
    name: Motorola SPI Specification
    relevance: Original SPI specification
tooling:
  analysis_tools:
  - tool: logic-analyzer
    purpose: Protocol and timing analysis
  - tool: oscilloscope
    purpose: Signal quality measurement
  - tool: spi-debugger
    purpose: Protocol debugging
  - tool: termination-analyzer
    purpose: Transmission line analysis
signals:
  critical:
  - id: SPS-SPI-CRIT-001
    signal: SPI clock mode mismatch causing data corruption
    evidence_indicators:
    - CPOL/CPHA mismatch with device
    - Data shifted incorrectly
    - Intermittent bit errors
    explanation: |
      SPI devices require specific clock polarity (CPOL) and phase (CPHA)
      settings. Mismatches cause data to be sampled at wrong times, resulting
      in consistent or intermittent data corruption.
    remediation: Verify and correct clock mode settings for each device
  - id: SPS-SPI-CRIT-002
    signal: Chip select timing violations
    evidence_indicators:
    - CS not meeting setup/hold times
    - CS glitches during transaction
    - Multiple devices selected
    explanation: |
      Chip select timing violations can cause devices to miss transactions,
      corrupt data, or create bus contention when multiple devices respond.
    remediation: Correct chip select timing and management
  high:
  - id: SPS-SPI-HIGH-001
    signal: SPI clock speed exceeds device capability
    evidence_indicators:
    - Clock faster than device maximum
    - Intermittent errors at speed
    - Works at lower speed only
    remediation: Reduce clock speed to within device specifications
  - id: SPS-SPI-HIGH-002
    signal: Signal integrity issues at high speed
    evidence_indicators:
    - Ringing on clock/data lines
    - Setup/hold time violations
    - Eye diagram closure
    remediation: Improve signal integrity through termination or speed reduction
  medium:
  - id: SPS-SPI-MED-001
    signal: No error detection on SPI transfers
    evidence_indicators:
    - No CRC or checksum verification
    - Corrupted data not detected
    - Silent failures possible
    remediation: Implement application-level error detection
  - id: SPS-SPI-MED-002
    signal: SPI bus not shared safely
    evidence_indicators:
    - No mutex protection
    - Race conditions possible
    - Interleaved transactions
    remediation: Implement proper bus sharing with mutual exclusion
  low:
  - id: SPS-SPI-LOW-001
    signal: SPI configuration not documented
    evidence_indicators:
    - Clock mode not recorded
    - Speed settings not documented
    - Pin assignments unclear
    remediation: Document SPI configuration for all devices
  - id: SPS-SPI-LOW-002
    signal: No SPI transaction logging
    evidence_indicators:
    - Unable to debug failures
    - No transaction history
    - Error investigation difficult
    remediation: Implement optional SPI transaction logging
  positive:
  - id: SPS-SPI-POS-001
    signal: SPI configuration verified for all devices
    evidence_indicators:
    - Clock modes confirmed
    - Timing margins verified
    - Signal quality measured
  - id: SPS-SPI-POS-002
    signal: Robust SPI driver with error handling
    evidence_indicators:
    - Timeout handling implemented
    - Bus sharing protected
    - Error recovery in place
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Inventory SPI Devices
    description: Catalog all SPI devices and requirements
    duration_estimate: 20 min
  - id: '2'
    name: Verify Configuration
    description: Check clock mode and speed for each device
    duration_estimate: 30 min
  - id: '3'
    name: Measure Signal Quality
    description: Verify signal integrity at operating speed
    duration_estimate: 45 min
  - id: '4'
    name: Test Chip Select Timing
    description: Verify CS timing meets requirements
    duration_estimate: 30 min
  - id: '5'
    name: Review Driver Implementation
    description: Assess driver code quality
    duration_estimate: 30 min
  - id: '6'
    name: Test Multi-device Scenarios
    description: Verify bus sharing behavior
    duration_estimate: 30 min
  - id: '7'
    name: Document Findings
    description: Compile findings and recommendations
    duration_estimate: 15 min
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Configuration Review
    - Signal Quality Analysis
    - Driver Assessment
    - Recommendations
closeout_checklist:
- id: sps-spi-001
  item: Clock modes verified for all devices
  level: WARNING
  verification: manual
- id: sps-spi-002
  item: Signal integrity verified
  level: WARNING
  verification: manual
- id: sps-spi-003
  item: Chip select timing verified
  level: INFO
  verification: manual
governance:
  applicable_to:
    archetypes:
    - embedded-systems
    - iot-systems
    - industrial-automation
    - consumer-electronics
  compliance_mappings:
  - framework: IEC 61508
    control: 7.4.5
    description: Communication reliability
  - framework: Automotive SPICE
    control: SWE.4
    description: Software unit verification
  - framework: DO-178C
    control: Section 6
    description: Software verification
relationships:
  commonly_combined:
  - sensors-physical-systems.hardware-interfaces.i2c-reliability
  - sensors-physical-systems.sensor-integration.sensor-protocol-compliance
  depends_on:
  - hardware.pcb-design
  feeds_into:
  - sensors-physical-systems.sensor-integration.sensor-health-monitoring
  - reliability.communication-reliability
