# ============================================================
# AUDIT: CAN Bus Implementation
# Category: 38 - Sensors & Physical Systems
# Subcategory: hardware-interfaces
# ============================================================

audit:
  id: "sensors-physical-systems.hardware-interfaces.can-bus-implementation"
  name: "CAN Bus Implementation Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "sensors-physical-systems"
  category_number: 38
  subcategory: "hardware-interfaces"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "physical-systems"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates Controller Area Network (CAN) bus implementation including bit
    timing configuration, message prioritization, error handling, bus-off
    recovery, termination, and network topology. Reviews higher-layer protocol
    implementation (CANopen, J1939, DeviceNet) where applicable.

  why_it_matters: |
    CAN bus is widely used in automotive, industrial, and medical applications
    for reliable real-time communication. Improper implementation can cause
    message loss, bus errors, or complete communication failure, potentially
    affecting safety-critical systems.

  when_to_run:
    - "During CAN network design"
    - "When bus errors occur"
    - "After adding CAN nodes"
    - "Before safety certification"
    - "During network troubleshooting"

prerequisites:
  required_artifacts:
    - type: "network_design"
      description: "CAN network design documentation"
    - type: "dbc_file"
      description: "CAN database file"
    - type: "driver_source"
      description: "CAN driver source code"

  access_requirements:
    - "Access to CAN bus signals"
    - "CAN analyzer access"
    - "Oscilloscope for signal quality"
    - "Driver source code access"

discovery:
  file_patterns:
    - glob: "**/*can*.c"
      purpose: "Find CAN driver code"
    - glob: "**/drivers/can/**"
      purpose: "Find CAN driver directory"
    - glob: "**/*.dbc"
      purpose: "Find CAN database files"
    - glob: "**/config/*can*.yaml"
      purpose: "Find CAN configuration"

knowledge_sources:
  guides:
    - id: "can-spec"
      name: "CAN Specification 2.0"
      url: "https://www.bosch-semiconductors.com/"
    - id: "canopen"
      name: "CANopen Standards"
      url: "https://www.can-cia.org/"

  standards:
    - id: "iso-11898"
      name: "ISO 11898 CAN Protocol"
      relevance: "CAN physical and data link layer"
    - id: "sae-j1939"
      name: "SAE J1939 Heavy Vehicles"
      relevance: "Commercial vehicle CAN"
    - id: "iec-62026"
      name: "IEC 62026 DeviceNet"
      relevance: "Industrial CAN protocol"

tooling:
  analysis_tools:
    - tool: "can-analyzer"
      purpose: "Protocol analysis"
    - tool: "oscilloscope"
      purpose: "Signal quality measurement"
    - tool: "bus-load-analyzer"
      purpose: "Network utilization"
    - tool: "can-fault-injector"
      purpose: "Error testing"

signals:
  critical:
    - id: "SPS-CAN-CRIT-001"
      signal: "CAN node enters bus-off without recovery"
      evidence_indicators:
        - "Node goes bus-off and stays offline"
        - "No automatic recovery implemented"
        - "Communication lost with node"
      explanation: |
        The CAN protocol puts nodes into bus-off state after excessive errors.
        Without proper recovery, the node is permanently disconnected from the
        network until manually reset.
      remediation: "Implement automatic bus-off recovery with appropriate delay"

    - id: "SPS-CAN-CRIT-002"
      signal: "Safety-critical messages lost or corrupted"
      evidence_indicators:
        - "Message timeout on safety data"
        - "CRC errors on critical messages"
        - "Message priority conflicts"
      explanation: |
        Safety-critical CAN messages must be reliably delivered. Lost or
        corrupted messages can cause safety functions to fail or operate
        on stale data.
      remediation: "Ensure proper prioritization and error handling for safety messages"

  high:
    - id: "SPS-CAN-HIGH-001"
      signal: "Bit timing configuration incorrect"
      evidence_indicators:
        - "Bit rate mismatch between nodes"
        - "Sample point not optimal"
        - "Marginal timing margins"
      remediation: "Configure consistent and optimal bit timing across network"

    - id: "SPS-CAN-HIGH-002"
      signal: "Bus termination incorrect"
      evidence_indicators:
        - "Signal reflections observed"
        - "Termination resistors missing/incorrect"
        - "Ringing on bus signals"
      remediation: "Correct bus termination per ISO 11898"

  medium:
    - id: "SPS-CAN-MED-001"
      signal: "Bus load exceeds recommendations"
      evidence_indicators:
        - "Bus utilization above 70%"
        - "Message latency increases"
        - "Lower priority messages delayed"
      remediation: "Optimize message scheduling or increase bus speed"

    - id: "SPS-CAN-MED-002"
      signal: "Message identifier conflicts"
      evidence_indicators:
        - "Duplicate message IDs"
        - "Arbitration issues"
        - "Priority inversion"
      remediation: "Resolve identifier conflicts and review priority assignment"

  low:
    - id: "SPS-CAN-LOW-001"
      signal: "CAN database not maintained"
      evidence_indicators:
        - "DBC file outdated"
        - "Signal definitions incomplete"
        - "Documentation mismatch"
      remediation: "Update and maintain CAN database"

    - id: "SPS-CAN-LOW-002"
      signal: "No CAN bus statistics collection"
      evidence_indicators:
        - "Error counts not tracked"
        - "Bus load not monitored"
        - "No performance metrics"
      remediation: "Implement CAN bus monitoring and statistics"

  positive:
    - id: "SPS-CAN-POS-001"
      signal: "Robust CAN implementation with full error handling"
      evidence_indicators:
        - "Bus-off recovery implemented"
        - "Error statistics collected"
        - "Timeout handling in place"

    - id: "SPS-CAN-POS-002"
      signal: "CAN network properly documented and monitored"
      evidence_indicators:
        - "Complete DBC database"
        - "Network topology documented"
        - "Real-time monitoring available"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Review Network Design"
      description: "Assess CAN network topology and configuration"
      duration_estimate: "30 min"

    - id: "2"
      name: "Verify Bit Timing"
      description: "Check bit timing consistency across nodes"
      duration_estimate: "45 min"

    - id: "3"
      name: "Check Signal Quality"
      description: "Measure CAN signal characteristics"
      duration_estimate: "45 min"

    - id: "4"
      name: "Test Error Handling"
      description: "Verify error detection and recovery"
      duration_estimate: "45 min"

    - id: "5"
      name: "Analyze Bus Load"
      description: "Measure and analyze bus utilization"
      duration_estimate: "30 min"

    - id: "6"
      name: "Review Message Priority"
      description: "Verify message prioritization"
      duration_estimate: "30 min"

    - id: "7"
      name: "Document Findings"
      description: "Compile findings and recommendations"
      duration_estimate: "30 min"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Network Analysis"
        - "Signal Quality"
        - "Error Handling Assessment"
        - "Recommendations"

closeout_checklist:
  - id: "sps-can-001"
    item: "Bus-off recovery implemented"
    level: "CRITICAL"
    verification: "manual"

  - id: "sps-can-002"
    item: "Bit timing verified consistent"
    level: "WARNING"
    verification: "manual"

  - id: "sps-can-003"
    item: "Signal quality verified"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["automotive-systems", "industrial-automation", "medical-devices", "heavy-machinery"]

  compliance_mappings:
    - framework: "ISO 11898"
      control: "CAN Protocol"
      description: "CAN physical and data link"
    - framework: "ISO 26262"
      control: "Part 5"
      description: "Hardware design requirements"
    - framework: "SAE J1939"
      control: "Network Layer"
      description: "Heavy vehicle CAN"

relationships:
  commonly_combined:
    - "sensors-physical-systems.sensor-integration.sensor-protocol-compliance"
    - "sensors-physical-systems.safety-systems.safety-communication"
  depends_on:
    - "hardware.can-transceiver"
  feeds_into:
    - "sensors-physical-systems.sensor-integration.sensor-network-topology"
    - "reliability.communication-reliability"
