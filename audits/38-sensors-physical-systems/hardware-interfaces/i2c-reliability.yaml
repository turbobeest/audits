audit:
  id: sensors-physical-systems.hardware-interfaces.i2c-reliability
  name: I2C Reliability Audit
  version: 1.0.0
  last_updated: '2025-01-22'
  status: active
  category: sensors-physical-systems
  category_number: 38
  subcategory: hardware-interfaces
  tier: expert
  estimated_duration: 3-5 hours  # median: 4h
  completeness: requires_discovery
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: medium
  scope: physical-systems
  default_profiles:
  - full
  - quick
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Evaluates I2C bus implementation reliability including clock stretching
    handling, arbitration, bus recovery mechanisms, pull-up resistor sizing,
    capacitive loading, timing compliance, and error handling. Reviews driver
    implementation robustness and multi-master scenarios.
  why_it_matters: |
    I2C bus issues can cause intermittent communication failures, hung buses,
    or data corruption. Proper implementation ensures reliable sensor communication
    even in electrically noisy environments or with devices that exhibit
    non-standard behavior.
  when_to_run:
  - During I2C interface design
  - When communication errors occur
  - After adding new I2C devices
  - Before production release
  - During hardware qualification
prerequisites:
  required_artifacts:
  - type: schematic
    description: I2C bus schematic
  - type: driver_source
    description: I2C driver source code
  - type: device_specs
    description: I2C device datasheets
  access_requirements:
  - Access to I2C signals
  - Logic analyzer access
  - Ability to inject errors
  - Driver source code access
discovery:
  file_patterns:
  - glob: '**/*i2c*.c'
    purpose: Find I2C driver code
  - glob: '**/drivers/i2c/**'
    purpose: Find I2C driver directory
  - glob: '**/*twi*.c'
    purpose: Find TWI implementations
  - glob: '**/config/*i2c*.yaml'
    purpose: Find I2C configuration
knowledge_sources:
  guides:
  - id: i2c-spec
    name: I2C-bus Specification
    url: https://www.nxp.com/docs/en/user-guide/UM10204.pdf
  - id: i2c-design
    name: I2C Design Guidelines
    url: https://www.ti.com/
  standards:
  - id: i2c-um10204
    name: NXP UM10204 I2C Specification
    relevance: I2C protocol specification
  - id: smbus
    name: SMBus Specification
    relevance: System Management Bus
tooling:
  analysis_tools:
  - tool: logic-analyzer
    purpose: Protocol timing analysis
  - tool: oscilloscope
    purpose: Signal quality measurement
  - tool: i2c-detector
    purpose: Device scanning
  - tool: bus-pirate
    purpose: Protocol testing
signals:
  critical:
  - id: SPS-I2C-CRIT-001
    signal: I2C bus hangs without recovery
    evidence_indicators:
    - SDA stuck low
    - No bus recovery mechanism
    - System requires reset after hang
    explanation: |
      A hung I2C bus stops all communication with devices on that bus. Without
      automatic recovery, system intervention or reset is required, potentially
      causing extended downtime or missed sensor data.
    remediation: Implement bus recovery with clock cycling and timeout handling
  - id: SPS-I2C-CRIT-002
    signal: Clock stretching causes timeouts or data loss
    evidence_indicators:
    - Devices stretch clock beyond timeout
    - Master times out during stretch
    - Data lost after stretch
    explanation: |
      Some I2C devices stretch the clock while processing. If the master
      doesn't properly handle stretching, communication fails or data is
      corrupted.
    remediation: Implement proper clock stretching handling with appropriate timeouts
  high:
  - id: SPS-I2C-HIGH-001
    signal: Pull-up resistors incorrectly sized
    evidence_indicators:
    - Rise times exceed specification
    - Signal levels incorrect
    - Bus current excessive
    remediation: Calculate and implement correct pull-up values
  - id: SPS-I2C-HIGH-002
    signal: Bus capacitance exceeds specification
    evidence_indicators:
    - Rise times too slow
    - Cannot achieve target speed
    - Communication errors at higher speeds
    remediation: Reduce bus capacitance or use bus buffer/repeater
  medium:
  - id: SPS-I2C-MED-001
    signal: No transaction retry mechanism
    evidence_indicators:
    - Single NACK fails operation
    - Transient errors not recovered
    - No retry with backoff
    remediation: Implement transaction retry with exponential backoff
  - id: SPS-I2C-MED-002
    signal: Address conflicts possible
    evidence_indicators:
    - Duplicate addresses on bus
    - Address selection pins not documented
    - Conflict detection missing
    remediation: Verify address uniqueness and document configuration
  low:
  - id: SPS-I2C-LOW-001
    signal: I2C error statistics not collected
    evidence_indicators:
    - NACK counts not tracked
    - Timeout counts unknown
    - No error trending
    remediation: Implement I2C error statistics collection
  - id: SPS-I2C-LOW-002
    signal: I2C bus configuration not documented
    evidence_indicators:
    - Speed settings not recorded
    - Device addresses not listed
    - Pull-up values not documented
    remediation: Document complete I2C bus configuration
  positive:
  - id: SPS-I2C-POS-001
    signal: Robust I2C implementation with full recovery
    evidence_indicators:
    - Bus recovery implemented
    - Retry with backoff
    - Error statistics collected
  - id: SPS-I2C-POS-002
    signal: I2C timing verified compliant
    evidence_indicators:
    - All timing parameters verified
    - Rise/fall times measured
    - Speed grades confirmed
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Review Bus Design
    description: Assess I2C hardware design
    duration_estimate: 30 min
  - id: '2'
    name: Verify Signal Quality
    description: Measure I2C signal characteristics
    duration_estimate: 45 min
  - id: '3'
    name: Test Protocol Compliance
    description: Verify timing and protocol compliance
    duration_estimate: 45 min
  - id: '4'
    name: Evaluate Error Handling
    description: Test error detection and recovery
    duration_estimate: 30 min
  - id: '5'
    name: Test Bus Recovery
    description: Verify bus recovery mechanism
    duration_estimate: 30 min
  - id: '6'
    name: Review Driver Code
    description: Assess driver implementation quality
    duration_estimate: 30 min
  - id: '7'
    name: Document Findings
    description: Compile findings and recommendations
    duration_estimate: 20 min
output:
  deliverables:
  - type: finding_list
    format: structured
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Hardware Analysis
    - Protocol Compliance
    - Reliability Assessment
    - Recommendations
closeout_checklist:
- id: sps-i2c-001
  item: Bus recovery mechanism implemented
  level: WARNING
  verification: manual
- id: sps-i2c-002
  item: Signal timing verified
  level: WARNING
  verification: manual
- id: sps-i2c-003
  item: Error handling tested
  level: INFO
  verification: manual
governance:
  applicable_to:
    archetypes:
    - embedded-systems
    - iot-systems
    - consumer-electronics
    - industrial-automation
  compliance_mappings:
  - framework: NXP UM10204
    control: I2C Specification
    description: I2C protocol compliance
  - framework: SMBus
    control: System Management Bus
    description: SMBus requirements
  - framework: IEC 61508
    control: 7.4.5
    description: Communication reliability
relationships:
  commonly_combined:
  - sensors-physical-systems.sensor-integration.sensor-protocol-compliance
  - sensors-physical-systems.hardware-interfaces.spi-configuration
  depends_on:
  - hardware.pcb-design
  feeds_into:
  - sensors-physical-systems.sensor-integration.sensor-health-monitoring
  - reliability.communication-reliability
