# ============================================================
# AUDIT: Sensor Protocol Compliance
# Category: 38 - Sensors & Physical Systems
# Subcategory: sensor-integration
# ============================================================

audit:
  id: "sensors-physical-systems.sensor-integration.sensor-protocol-compliance"
  name: "Sensor Protocol Compliance Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "sensors-physical-systems"
  category_number: 38
  subcategory: "sensor-integration"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  requires_physical_access: true
  severity: "medium"
  scope: "physical-systems"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Verifies that sensor communication protocols are correctly implemented
    according to specifications. Reviews protocol implementations for common
    sensor interfaces including I2C, SPI, UART, CAN, HART, Modbus, IO-Link,
    and industrial Ethernet protocols. Checks timing, error handling, and
    compliance with protocol standards.

  why_it_matters: |
    Protocol violations can cause intermittent communication failures, data
    corruption, or complete sensor failures. Proper protocol compliance ensures
    reliable sensor communication, interoperability with replacement sensors,
    and reduces debugging time for communication issues.

  when_to_run:
    - "During sensor driver development"
    - "When integrating new sensors"
    - "After communication errors occur"
    - "Before hardware qualification"
    - "When changing communication parameters"

prerequisites:
  required_artifacts:
    - type: "protocol_specs"
      description: "Protocol specification documents"
    - type: "driver_source"
      description: "Sensor driver source code"
    - type: "sensor_datasheets"
      description: "Sensor communication specifications"

  access_requirements:
    - "Access to driver source code"
    - "Protocol analyzer access"
    - "Physical signal access"
    - "Test equipment availability"

discovery:
  file_patterns:
    - glob: "**/drivers/**/*.c"
      purpose: "Find driver implementation code"
    - glob: "**/*i2c*.c"
      purpose: "Find I2C driver code"
    - glob: "**/*spi*.c"
      purpose: "Find SPI driver code"
    - glob: "**/*modbus*.c"
      purpose: "Find Modbus implementation"

knowledge_sources:
  guides:
    - id: "i2c-specification"
      name: "I2C-bus Specification"
      url: "https://www.nxp.com/docs/en/user-guide/UM10204.pdf"
    - id: "modbus-specification"
      name: "Modbus Protocol Specification"
      url: "https://modbus.org/specs.php"

  standards:
    - id: "ieee-1451"
      name: "IEEE 1451 Smart Transducer Interface"
      relevance: "Sensor interface standards"
    - id: "iec-61158"
      name: "IEC 61158 Fieldbus Standards"
      relevance: "Industrial communication protocols"

tooling:
  analysis_tools:
    - tool: "logic-analyzer"
      purpose: "Protocol timing analysis"
    - tool: "protocol-analyzer"
      purpose: "Protocol decode and verification"
    - tool: "oscilloscope"
      purpose: "Signal quality measurement"
    - tool: "bus-pirate"
      purpose: "Protocol probing and testing"

signals:
  critical:
    - id: "SPS-PRT-CRIT-001"
      signal: "Protocol timing violations causing data corruption"
      evidence_indicators:
        - "Setup/hold time violations"
        - "Clock frequency exceeds specification"
        - "Bus turnaround time insufficient"
      explanation: |
        Timing violations can cause intermittent data corruption that is
        difficult to diagnose. The system may appear to work but produce
        occasional incorrect readings.
      remediation: "Correct timing parameters to meet protocol specifications"

    - id: "SPS-PRT-CRIT-002"
      signal: "Protocol errors not detected or handled"
      evidence_indicators:
        - "CRC/checksum not verified"
        - "NAK conditions ignored"
        - "Timeout conditions not handled"
      explanation: |
        Undetected protocol errors lead to incorrect data being used as valid
        sensor readings, potentially causing incorrect system behavior.
      remediation: "Implement comprehensive error detection and handling"

  high:
    - id: "SPS-PRT-HIGH-001"
      signal: "Bus contention or arbitration failures"
      evidence_indicators:
        - "Multi-master arbitration issues"
        - "Unexpected bus resets"
        - "Collision detection failures"
      remediation: "Review bus arbitration implementation and timing"

    - id: "SPS-PRT-HIGH-002"
      signal: "Protocol implementation deviates from specification"
      evidence_indicators:
        - "Non-standard message formats"
        - "Required features not implemented"
        - "Incompatible with standard devices"
      remediation: "Update implementation to match protocol specification"

  medium:
    - id: "SPS-PRT-MED-001"
      signal: "Suboptimal protocol configuration"
      evidence_indicators:
        - "Bus speed lower than capability"
        - "Unnecessary polling frequency"
        - "Inefficient message sequencing"
      remediation: "Optimize protocol configuration for performance"

    - id: "SPS-PRT-MED-002"
      signal: "No protocol-level diagnostics"
      evidence_indicators:
        - "Communication errors not logged"
        - "Protocol statistics not collected"
        - "Unable to diagnose issues"
      remediation: "Implement protocol diagnostic logging and statistics"

  low:
    - id: "SPS-PRT-LOW-001"
      signal: "Protocol implementation not documented"
      evidence_indicators:
        - "Configuration choices not explained"
        - "Deviations not documented"
        - "Integration guide incomplete"
      remediation: "Document protocol implementation details"

    - id: "SPS-PRT-LOW-002"
      signal: "Protocol test coverage incomplete"
      evidence_indicators:
        - "Error paths not tested"
        - "Edge cases not covered"
        - "No conformance testing"
      remediation: "Expand protocol test coverage"

  positive:
    - id: "SPS-PRT-POS-001"
      signal: "Protocol implementation fully compliant"
      evidence_indicators:
        - "Conformance testing passed"
        - "All timing requirements met"
        - "Error handling comprehensive"

    - id: "SPS-PRT-POS-002"
      signal: "Robust retry and recovery mechanisms"
      evidence_indicators:
        - "Automatic retry on transient errors"
        - "Bus recovery procedures implemented"
        - "Graceful degradation on persistent failures"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify Protocols Used"
      description: "Catalog all sensor communication protocols in use"
      duration_estimate: "30 min"

    - id: "2"
      name: "Review Driver Implementation"
      description: "Analyze protocol driver code for correctness"
      duration_estimate: "60 min"

    - id: "3"
      name: "Verify Timing Compliance"
      description: "Measure protocol timing with analyzer"
      duration_estimate: "45 min"

    - id: "4"
      name: "Test Error Handling"
      description: "Inject errors and verify handling"
      duration_estimate: "45 min"

    - id: "5"
      name: "Check Signal Integrity"
      description: "Verify signal quality meets requirements"
      duration_estimate: "30 min"

    - id: "6"
      name: "Review Configuration"
      description: "Assess protocol configuration optimization"
      duration_estimate: "20 min"

    - id: "7"
      name: "Document Findings"
      description: "Compile findings and recommendations"
      duration_estimate: "30 min"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Protocol Inventory"
        - "Compliance Assessment"
        - "Timing Analysis"
        - "Recommendations"

closeout_checklist:
  - id: "sps-prt-001"
    item: "All protocol timing verified compliant"
    level: "WARNING"
    verification: "manual"

  - id: "sps-prt-002"
    item: "Error handling tested and verified"
    level: "WARNING"
    verification: "manual"

  - id: "sps-prt-003"
    item: "Signal integrity verified"
    level: "INFO"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["iot-systems", "industrial-automation", "embedded-systems", "medical-devices"]

  compliance_mappings:
    - framework: "IEC 61158"
      control: "Protocol Conformance"
      description: "Fieldbus protocol compliance"
    - framework: "IEEE 1451"
      control: "TEDS Compliance"
      description: "Smart transducer interface"
    - framework: "IEC 62443"
      control: "SR 3.1"
      description: "Communication integrity"

relationships:
  commonly_combined:
    - "sensors-physical-systems.hardware-interfaces.i2c-reliability"
    - "sensors-physical-systems.hardware-interfaces.spi-configuration"
  depends_on:
    - "hardware.signal-integrity"
  feeds_into:
    - "sensors-physical-systems.sensor-integration.sensor-health-monitoring"
    - "reliability.communication-reliability"
