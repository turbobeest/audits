# ============================================================
# AUDIT: Servo Systems
# Category: 38 - Sensors & Physical Systems
# Subcategory: actuator-control
# ============================================================

audit:
  id: "sensors-physical-systems.actuator-control.servo-systems"
  name: "Servo Systems Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "sensors-physical-systems"
  category_number: 38
  subcategory: "actuator-control"

  tier: "expert"
  estimated_duration: "5-7 hours"  # median: 6h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "physical-systems"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates servo motor and drive systems including axis configuration, motion
    profiles, tuning parameters, encoder feedback, position accuracy, and safety
    functions. Reviews servo loop tuning, electronic gearing, homing procedures,
    and safe torque off implementation.

  why_it_matters: |
    Servo systems provide precise motion control for robotics, CNC machines, and
    automation. Improper configuration can cause inaccurate positioning, machine
    damage, product defects, or safety hazards from unexpected motion. Proper
    servo setup ensures accurate, safe, and reliable operation.

  when_to_run:
    - "During machine commissioning"
    - "After servo replacement"
    - "When positioning errors occur"
    - "During machine qualification"
    - "After mechanical changes"

prerequisites:
  required_artifacts:
    - type: "servo_specs"
      description: "Servo motor and drive specifications"
    - type: "motion_config"
      description: "Motion controller configuration"
    - type: "mechanical_specs"
      description: "Mechanical system specifications"

  access_requirements:
    - "Motion controller access"
    - "Servo drive parameter access"
    - "Physical access for testing"
    - "Position measurement equipment"

discovery:
  file_patterns:
    - glob: "**/*servo*.c"
      purpose: "Find servo code"
    - glob: "**/*motion*.c"
      purpose: "Find motion code"
    - glob: "**/*axis*.c"
      purpose: "Find axis code"
    - glob: "**/config/*motion*.yaml"
      purpose: "Find motion configuration"

knowledge_sources:
  guides:
    - id: "servo-tuning"
      name: "Servo Tuning Guide"
      url: "https://www.rockwellautomation.com/"
    - id: "motion-control"
      name: "Motion Control Handbook"
      url: "https://www.siemens.com/"

  standards:
    - id: "iec-61800"
      name: "IEC 61800 Adjustable Speed Drives"
      relevance: "Drive requirements"
    - id: "iec-61131-3"
      name: "IEC 61131-3 Motion Control"
      relevance: "Motion programming"
    - id: "iso-13849"
      name: "ISO 13849 Safety of Machinery"
      relevance: "Safety functions"

tooling:
  analysis_tools:
    - tool: "servo-scope"
      purpose: "Servo tuning and analysis"
    - tool: "position-sensor"
      purpose: "Position verification"
    - tool: "dial-indicator"
      purpose: "Mechanical verification"
    - tool: "oscilloscope"
      purpose: "Signal analysis"

signals:
  critical:
    - id: "SPS-SRV-CRIT-001"
      signal: "Safe torque off (STO) not implemented"
      evidence_indicators:
        - "No STO function on safety-critical axis"
        - "STO not tested"
        - "Safety relay wiring incorrect"
      explanation: |
        Safe torque off is a fundamental safety function that prevents unexpected
        motion during maintenance. Missing or faulty STO can result in serious
        injury when personnel are in the machine's movement zone.
      remediation: "Implement and verify STO per safety requirements"

    - id: "SPS-SRV-CRIT-002"
      signal: "Position following error not monitored"
      evidence_indicators:
        - "No following error fault"
        - "Fault limits too wide"
        - "Axis continues despite large error"
      explanation: |
        Following error indicates the motor cannot keep up with commanded
        position. Undetected following errors can indicate mechanical problems
        or result in crashes and equipment damage.
      remediation: "Configure appropriate following error monitoring and faults"

  high:
    - id: "SPS-SRV-HIGH-001"
      signal: "Servo tuning unstable or marginal"
      evidence_indicators:
        - "Oscillation during motion"
        - "Position overshoot excessive"
        - "Settling time too long"
      remediation: "Retune servo for stable, optimal performance"

    - id: "SPS-SRV-HIGH-002"
      signal: "Homing procedure unreliable"
      evidence_indicators:
        - "Inconsistent home position"
        - "Homing sensor issues"
        - "Home position drifts"
      remediation: "Improve homing reliability through procedure or sensor changes"

  medium:
    - id: "SPS-SRV-MED-001"
      signal: "Motion profiles not optimized"
      evidence_indicators:
        - "Jerk causing vibration"
        - "Acceleration too aggressive"
        - "Cycle time not optimized"
      remediation: "Optimize motion profiles for application"

    - id: "SPS-SRV-MED-002"
      signal: "Encoder resolution inadequate"
      evidence_indicators:
        - "Position resolution too coarse"
        - "Velocity loop noisy at low speed"
        - "Cannot achieve accuracy requirement"
      remediation: "Upgrade to higher resolution encoder"

  low:
    - id: "SPS-SRV-LOW-001"
      signal: "Servo configuration not backed up"
      evidence_indicators:
        - "Parameters not saved"
        - "Recovery from failure slow"
        - "Configuration not documented"
      remediation: "Back up and document servo configuration"

    - id: "SPS-SRV-LOW-002"
      signal: "No servo diagnostic trending"
      evidence_indicators:
        - "Following error not trended"
        - "Motor temperature not logged"
        - "No early warning capability"
      remediation: "Implement servo diagnostic trending"

  positive:
    - id: "SPS-SRV-POS-001"
      signal: "Servo system properly tuned and verified"
      evidence_indicators:
        - "Stable response verified"
        - "Position accuracy confirmed"
        - "Tuning documented"

    - id: "SPS-SRV-POS-002"
      signal: "Comprehensive safety functions"
      evidence_indicators:
        - "STO verified"
        - "Safe limited speed if required"
        - "Safety functions tested"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Servo Axes"
      description: "Catalog all servo systems"
      duration_estimate: "30 min"

    - id: "2"
      name: "Review Configuration"
      description: "Verify servo drive parameters"
      duration_estimate: "60 min"

    - id: "3"
      name: "Test Tuning Stability"
      description: "Verify servo loop tuning"
      duration_estimate: "60 min"

    - id: "4"
      name: "Verify Position Accuracy"
      description: "Measure positioning performance"
      duration_estimate: "45 min"

    - id: "5"
      name: "Test Safety Functions"
      description: "Verify STO and other safety functions"
      duration_estimate: "45 min"

    - id: "6"
      name: "Test Homing Procedure"
      description: "Verify homing reliability"
      duration_estimate: "30 min"

    - id: "7"
      name: "Document Findings"
      description: "Compile findings and recommendations"
      duration_estimate: "30 min"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Servo System Inventory"
        - "Tuning Assessment"
        - "Safety Function Review"
        - "Recommendations"

closeout_checklist:
  - id: "sps-srv-001"
    item: "Safety functions verified"
    level: "CRITICAL"
    verification: "manual"

  - id: "sps-srv-002"
    item: "Servo tuning stable"
    level: "WARNING"
    verification: "manual"

  - id: "sps-srv-003"
    item: "Position accuracy verified"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["cnc-machines", "robotics", "packaging-machines", "semiconductor-equipment"]

  compliance_mappings:
    - framework: "IEC 61800-5-2"
      control: "Functional Safety"
      description: "Drive safety functions"
    - framework: "ISO 13849"
      control: "Safety Functions"
      description: "Machinery safety"
    - framework: "IEC 62443"
      control: "SR 2.5"
      description: "Session lock"

relationships:
  commonly_combined:
    - "sensors-physical-systems.actuator-control.feedback-loop-tuning"
    - "sensors-physical-systems.safety-systems.safe-limited-functions"
  depends_on:
    - "sensors-physical-systems.hardware-interfaces.can-bus-implementation"
  feeds_into:
    - "quality.positioning-accuracy"
    - "productivity.cycle-time-optimization"
