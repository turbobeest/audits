# ============================================================
# AUDIT: Feedback Loop Tuning
# Category: 38 - Sensors & Physical Systems
# Subcategory: actuator-control
# ============================================================

audit:
  id: "sensors-physical-systems.actuator-control.feedback-loop-tuning"
  name: "Feedback Loop Tuning Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "sensors-physical-systems"
  category_number: 38
  subcategory: "actuator-control"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "physical-systems"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates control loop tuning including PID parameters, cascade configurations,
    feedforward compensation, and adaptive tuning. Reviews loop stability, response
    characteristics, disturbance rejection, and performance under varying conditions.

  why_it_matters: |
    Properly tuned control loops ensure stable, accurate process control with good
    disturbance rejection. Poorly tuned loops cause oscillation, sluggish response,
    excessive overshoot, or instability that affects product quality, energy
    efficiency, and equipment life.

  when_to_run:
    - "During control system commissioning"
    - "When control problems arise"
    - "After process changes"
    - "During performance optimization"
    - "After actuator replacement"

prerequisites:
  required_artifacts:
    - type: "control_config"
      description: "Control loop configuration"
    - type: "process_specs"
      description: "Process dynamics information"
    - type: "tuning_docs"
      description: "Tuning procedure documentation"

  access_requirements:
    - "Control system access"
    - "Historian access for trends"
    - "Ability to perform step tests"
    - "Process disturbance capability"

discovery:
  file_patterns:
    - glob: "**/*pid*.c"
      purpose: "Find PID code"
    - glob: "**/*control*.c"
      purpose: "Find control code"
    - glob: "**/*loop*.c"
      purpose: "Find loop code"
    - glob: "**/config/*controller*.yaml"
      purpose: "Find controller configuration"

knowledge_sources:
  guides:
    - id: "pid-tuning"
      name: "PID Tuning Guide"
      url: "https://www.controleng.com/"
    - id: "process-control"
      name: "Process Control Fundamentals"
      url: "https://www.isa.org/"

  standards:
    - id: "isa-5"
      name: "ISA-5 Control Systems"
      relevance: "Control system documentation"
    - id: "iec-61131-3"
      name: "IEC 61131-3 PLC Programming"
      relevance: "Control programming"
    - id: "isa-88"
      name: "ISA-88 Batch Control"
      relevance: "Batch control requirements"

tooling:
  analysis_tools:
    - tool: "control-tuning-software"
      purpose: "Loop analysis and tuning"
    - tool: "historian"
      purpose: "Trend analysis"
    - tool: "data-recorder"
      purpose: "Step test recording"
    - tool: "loop-analyzer"
      purpose: "Loop performance metrics"

signals:
  critical:
    - id: "SPS-FBK-CRIT-001"
      signal: "Control loop oscillating or unstable"
      evidence_indicators:
        - "Sustained oscillation"
        - "Growing amplitude"
        - "Loop fighting actuator limits"
      explanation: |
        Unstable control loops can cause equipment damage, process upsets,
        safety incidents, or product quality issues. Oscillation wastes energy
        and accelerates wear on actuators.
      remediation: "Retune loop or implement detuning for stability"

    - id: "SPS-FBK-CRIT-002"
      signal: "Safety-critical loop not performing"
      evidence_indicators:
        - "Cannot maintain safe conditions"
        - "Response too slow for safety"
        - "Excessive deviation from setpoint"
      explanation: |
        Safety-critical loops must maintain process variables within safe
        limits. Poor performance can allow dangerous conditions to develop
        or prevent timely response to upsets.
      remediation: "Optimize tuning for safety-critical response"

  high:
    - id: "SPS-FBK-HIGH-001"
      signal: "Loop response too sluggish"
      evidence_indicators:
        - "Long settling time"
        - "Cannot track setpoint changes"
        - "Poor disturbance rejection"
      remediation: "Increase loop aggressiveness through tuning"

    - id: "SPS-FBK-HIGH-002"
      signal: "Excessive overshoot"
      evidence_indicators:
        - "Large overshoot on setpoint change"
        - "Quality issues from excursions"
        - "Equipment stress from overshoots"
      remediation: "Reduce overshoot through tuning adjustment"

  medium:
    - id: "SPS-FBK-MED-001"
      signal: "Loop performance varies with conditions"
      evidence_indicators:
        - "Tuning works in one range only"
        - "Nonlinear process behavior"
        - "No gain scheduling"
      remediation: "Implement adaptive tuning or gain scheduling"

    - id: "SPS-FBK-MED-002"
      signal: "Feedforward not implemented"
      evidence_indicators:
        - "Known disturbances not compensated"
        - "Feedback-only control limited"
        - "Could benefit from feedforward"
      remediation: "Implement feedforward for measurable disturbances"

  low:
    - id: "SPS-FBK-LOW-001"
      signal: "Loop tuning not documented"
      evidence_indicators:
        - "Tuning parameters not recorded"
        - "Tuning rationale unknown"
        - "History not maintained"
      remediation: "Document loop tuning and rationale"

    - id: "SPS-FBK-LOW-002"
      signal: "No loop performance metrics"
      evidence_indicators:
        - "Performance not measured"
        - "Degradation not detected"
        - "No KPIs for control"
      remediation: "Implement loop performance monitoring"

  positive:
    - id: "SPS-FBK-POS-001"
      signal: "Well-tuned stable control"
      evidence_indicators:
        - "Good stability margins"
        - "Fast response without overshoot"
        - "Good disturbance rejection"

    - id: "SPS-FBK-POS-002"
      signal: "Loop performance monitored and maintained"
      evidence_indicators:
        - "Performance metrics tracked"
        - "Degradation detected early"
        - "Periodic tuning reviews"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Control Loops"
      description: "Catalog all feedback control loops"
      duration_estimate: "30 min"

    - id: "2"
      name: "Review Current Tuning"
      description: "Document current parameters"
      duration_estimate: "30 min"

    - id: "3"
      name: "Analyze Loop Stability"
      description: "Assess stability from trends"
      duration_estimate: "45 min"

    - id: "4"
      name: "Test Loop Response"
      description: "Perform step tests if possible"
      duration_estimate: "60 min"

    - id: "5"
      name: "Evaluate Disturbance Rejection"
      description: "Analyze response to disturbances"
      duration_estimate: "30 min"

    - id: "6"
      name: "Review Cascade and Advanced"
      description: "Check cascade and feedforward"
      duration_estimate: "30 min"

    - id: "7"
      name: "Document Findings"
      description: "Compile findings and recommendations"
      duration_estimate: "30 min"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Loop Inventory"
        - "Tuning Assessment"
        - "Performance Analysis"
        - "Recommendations"

closeout_checklist:
  - id: "sps-fbk-001"
    item: "All loops stable"
    level: "CRITICAL"
    verification: "manual"

  - id: "sps-fbk-002"
    item: "Safety loops meet requirements"
    level: "CRITICAL"
    verification: "manual"

  - id: "sps-fbk-003"
    item: "Tuning documented"
    level: "INFO"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["process-control", "industrial-automation", "hvac-systems", "manufacturing"]

  compliance_mappings:
    - framework: "ISA-5"
      control: "Control Documentation"
      description: "Control system documentation"
    - framework: "IEC 61511"
      control: "SIS Requirements"
      description: "Safety loop requirements"
    - framework: "FDA 21 CFR Part 211"
      control: "211.68"
      description: "Process control"

relationships:
  commonly_combined:
    - "sensors-physical-systems.actuator-control.motor-control"
    - "sensors-physical-systems.actuator-control.valve-control"
  depends_on:
    - "sensors-physical-systems.sensor-integration.sensor-calibration"
  feeds_into:
    - "quality.process-capability"
    - "energy.control-optimization"
