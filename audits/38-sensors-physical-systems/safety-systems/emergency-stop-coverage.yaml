# ============================================================
# AUDIT: Emergency Stop Coverage
# Category: 38 - Sensors & Physical Systems
# Subcategory: safety-systems
# ============================================================

audit:
  id: "sensors-physical-systems.safety-systems.emergency-stop-coverage"
  name: "Emergency Stop Coverage Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "sensors-physical-systems"
  category_number: 38
  subcategory: "safety-systems"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  requires_physical_access: true
  severity: "critical"
  scope: "physical-systems"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates emergency stop (E-stop) systems including device placement, wiring,
    circuit architecture, stop categories (0, 1, 2), and reset procedures. Reviews
    compliance with ISO 13850, zone coverage, and integration with machine control
    systems.

  why_it_matters: |
    Emergency stops are the last line of defense against serious injury. Inadequate
    coverage leaves personnel unprotected, improper wiring can prevent operation,
    and incorrect stop category may not adequately address the hazard. Lives
    depend on properly designed E-stop systems.

  when_to_run:
    - "During machine design review"
    - "Before commissioning"
    - "After E-stop modifications"
    - "During safety audits"
    - "After incidents or near-misses"

prerequisites:
  required_artifacts:
    - type: "safety_circuit_diagram"
      description: "E-stop circuit schematics"
    - type: "risk_assessment"
      description: "Machine risk assessment"
    - type: "layout_drawings"
      description: "Machine layout with E-stop locations"

  access_requirements:
    - "Physical access to all E-stops"
    - "Control system access"
    - "Safety relay configuration"
    - "Ability to perform E-stop tests"

discovery:
  file_patterns:
    - glob: "**/*estop*.c"
      purpose: "Find E-stop code"
    - glob: "**/*emergency*.c"
      purpose: "Find emergency stop code"
    - glob: "**/*safety*.c"
      purpose: "Find safety code"
    - glob: "**/config/*safety*.yaml"
      purpose: "Find safety configuration"

knowledge_sources:
  guides:
    - id: "iso-13850"
      name: "ISO 13850 Emergency Stop"
      url: "https://www.iso.org/"
    - id: "nfpa-79"
      name: "NFPA 79 Emergency Stop"
      url: "https://www.nfpa.org/"

  standards:
    - id: "iso-13850"
      name: "ISO 13850 Emergency Stop"
      relevance: "E-stop design requirements"
    - id: "iso-13849"
      name: "ISO 13849 Safety of Machinery"
      relevance: "Safety-related control systems"
    - id: "iec-60204"
      name: "IEC 60204 Electrical Equipment"
      relevance: "Machine electrical safety"

tooling:
  analysis_tools:
    - tool: "safety-relay-diagnostic"
      purpose: "Safety relay testing"
    - tool: "continuity-tester"
      purpose: "Circuit verification"
    - tool: "timing-analyzer"
      purpose: "Stop time measurement"
    - tool: "force-gauge"
      purpose: "Actuating force measurement"

signals:
  critical:
    - id: "SPS-EST-CRIT-001"
      signal: "E-stop device inoperable"
      evidence_indicators:
        - "E-stop does not function"
        - "Wiring disconnected"
        - "Device mechanically failed"
      explanation: |
        An inoperable emergency stop device leaves personnel completely
        unprotected. This is an immediate life-safety hazard that requires
        immediate correction.
      remediation: "Repair or replace E-stop device immediately"

    - id: "SPS-EST-CRIT-002"
      signal: "E-stop circuit can be bypassed"
      evidence_indicators:
        - "Jumper installed in circuit"
        - "Bypass switch accessible"
        - "Circuit defeated during operation"
      explanation: |
        Bypassed E-stop circuits provide no protection. This violation of
        fundamental safety principles creates immediate risk of serious
        injury.
      remediation: "Remove bypass and implement tamper prevention"

  high:
    - id: "SPS-EST-HIGH-001"
      signal: "Inadequate E-stop coverage"
      evidence_indicators:
        - "Work areas without nearby E-stop"
        - "E-stop not accessible"
        - "Distance exceeds standards"
      remediation: "Add E-stop devices to provide complete coverage"

    - id: "SPS-EST-HIGH-002"
      signal: "Stop category inappropriate for hazard"
      evidence_indicators:
        - "Category 0 where controlled stop needed"
        - "Category 2 where Category 0/1 required"
        - "Stop time insufficient for hazard"
      remediation: "Implement appropriate stop category per risk assessment"

  medium:
    - id: "SPS-EST-MED-001"
      signal: "E-stop reset procedure unsafe"
      evidence_indicators:
        - "Auto-reset enabled"
        - "Reset possible from outside hazard zone"
        - "No restart warning"
      remediation: "Implement proper supervised reset procedure"

    - id: "SPS-EST-MED-002"
      signal: "E-stop devices not standardized"
      evidence_indicators:
        - "Non-standard colors used"
        - "Inconsistent device types"
        - "Confusing identification"
      remediation: "Standardize E-stop devices per ISO 13850"

  low:
    - id: "SPS-EST-LOW-001"
      signal: "E-stop system not documented"
      evidence_indicators:
        - "Circuit diagrams missing"
        - "Device locations not mapped"
        - "Zone assignment not documented"
      remediation: "Document E-stop system completely"

    - id: "SPS-EST-LOW-002"
      signal: "E-stop test records incomplete"
      evidence_indicators:
        - "Test frequency inadequate"
        - "Test results not recorded"
        - "No periodic verification"
      remediation: "Implement regular E-stop testing program"

  positive:
    - id: "SPS-EST-POS-001"
      signal: "Comprehensive E-stop coverage"
      evidence_indicators:
        - "All work areas covered"
        - "Appropriate stop categories"
        - "Devices easily accessible"

    - id: "SPS-EST-POS-002"
      signal: "E-stop system properly maintained"
      evidence_indicators:
        - "Regular testing performed"
        - "All devices functional"
        - "Documentation current"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Review E-stop Design"
      description: "Assess circuit architecture and device selection"
      duration_estimate: "30 min"

    - id: "2"
      name: "Verify Device Locations"
      description: "Check coverage against hazard zones"
      duration_estimate: "45 min"

    - id: "3"
      name: "Test Each E-stop"
      description: "Functionally test all E-stop devices"
      duration_estimate: "60 min"

    - id: "4"
      name: "Verify Stop Category"
      description: "Confirm appropriate stop category implementation"
      duration_estimate: "30 min"

    - id: "5"
      name: "Test Reset Procedure"
      description: "Verify supervised reset operation"
      duration_estimate: "20 min"

    - id: "6"
      name: "Check for Bypasses"
      description: "Inspect for unauthorized modifications"
      duration_estimate: "30 min"

    - id: "7"
      name: "Document Findings"
      description: "Compile findings and recommendations"
      duration_estimate: "30 min"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Coverage Assessment"
        - "Functional Test Results"
        - "Stop Category Review"
        - "Recommendations"

closeout_checklist:
  - id: "sps-est-001"
    item: "All E-stops functional"
    level: "CRITICAL"
    verification: "manual"

  - id: "sps-est-002"
    item: "Coverage adequate for all hazard zones"
    level: "CRITICAL"
    verification: "manual"

  - id: "sps-est-003"
    item: "No bypasses found"
    level: "CRITICAL"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["manufacturing", "industrial-machinery", "robotics", "process-industries"]

  compliance_mappings:
    - framework: "ISO 13850"
      control: "Emergency Stop"
      description: "E-stop design requirements"
    - framework: "IEC 60204-1"
      control: "Emergency Operations"
      description: "Electrical equipment of machines"
    - framework: "OSHA 1910"
      control: "Machine Guarding"
      description: "Emergency stop requirements"

relationships:
  commonly_combined:
    - "sensors-physical-systems.safety-systems.interlock-verification"
    - "sensors-physical-systems.safety-systems.fail-safe-modes"
  depends_on:
    - "safety.risk-assessment"
  feeds_into:
    - "compliance.machine-safety"
    - "safety.safety-certification"
