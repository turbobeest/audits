# ============================================================
# AUDIT: Safety PLC Configuration
# Category: 38 - Sensors & Physical Systems
# Subcategory: safety-systems
# ============================================================

audit:
  id: "sensors-physical-systems.safety-systems.safety-plc-configuration"
  name: "Safety PLC Configuration Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "sensors-physical-systems"
  category_number: 38
  subcategory: "safety-systems"

  tier: "expert"
  estimated_duration: "5-7 hours"  # median: 6h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "physical-systems"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates safety PLC/controller configuration including hardware setup, safety
    program logic, diagnostic configuration, and network parameters. Reviews
    separation of safety and standard logic, access control, change management,
    and compliance with safety manual requirements.

  why_it_matters: |
    Safety PLCs are the logic solvers for safety functions. Incorrect configuration
    can compromise the entire safety system, affecting multiple safety functions.
    Proper configuration ensures the safety PLC meets SIL requirements and
    functions reliably.

  when_to_run:
    - "During safety system design"
    - "Before commissioning"
    - "After program changes"
    - "During periodic audits"
    - "After firmware updates"

prerequisites:
  required_artifacts:
    - type: "safety_program"
      description: "Safety PLC program"
    - type: "safety_manual"
      description: "Controller safety manual"
    - type: "configuration_docs"
      description: "Hardware configuration documentation"

  access_requirements:
    - "Safety PLC programming access"
    - "Hardware access for verification"
    - "Configuration tools"
    - "Change management records"

discovery:
  file_patterns:
    - glob: "**/*safety_plc*.c"
      purpose: "Find safety PLC code"
    - glob: "**/*safe_logic*.c"
      purpose: "Find safety logic code"
    - glob: "**/plc_config/**"
      purpose: "Find PLC configuration"
    - glob: "**/safety_program/**"
      purpose: "Find safety program"

knowledge_sources:
  guides:
    - id: "iec-61131-6"
      name: "IEC 61131-6 Safety PLCs"
      url: "https://www.iec.ch/"
    - id: "safety-plc-guide"
      name: "Safety PLC Programming Guide"
      url: "https://www.rockwellautomation.com/"

  standards:
    - id: "iec-61508"
      name: "IEC 61508 Functional Safety"
      relevance: "Safety system requirements"
    - id: "iec-61131-6"
      name: "IEC 61131-6 Safety Requirements"
      relevance: "Safety PLC programming"
    - id: "iec-62443"
      name: "IEC 62443 Security"
      relevance: "Safety system security"

tooling:
  analysis_tools:
    - tool: "safety-plc-software"
      purpose: "Program review and verification"
    - tool: "diagnostic-tool"
      purpose: "System diagnostics"
    - tool: "version-compare"
      purpose: "Program comparison"
    - tool: "access-audit"
      purpose: "Access control verification"

signals:
  critical:
    - id: "SPS-SPL-CRIT-001"
      signal: "Safety program contains errors"
      evidence_indicators:
        - "Logic errors identified"
        - "Diagnostic functions incorrect"
        - "Test coverage gaps"
      explanation: |
        Errors in safety programs can prevent proper safety function operation,
        potentially allowing hazardous conditions to develop despite the
        safety system being active.
      remediation: "Correct program errors and revalidate"

    - id: "SPS-SPL-CRIT-002"
      signal: "Safety manual requirements not followed"
      evidence_indicators:
        - "Hardware constraints violated"
        - "Prohibited instructions used"
        - "Configuration limits exceeded"
      explanation: |
        Safety manuals define requirements for achieving SIL certification.
        Violating these requirements invalidates the SIL claim and may
        create dangerous failure modes.
      remediation: "Correct configuration to comply with safety manual"

  high:
    - id: "SPS-SPL-HIGH-001"
      signal: "Access control inadequate"
      evidence_indicators:
        - "Unauthorized access possible"
        - "No password protection"
        - "Access logging disabled"
      remediation: "Implement proper access control"

    - id: "SPS-SPL-HIGH-002"
      signal: "Standard and safety logic not separated"
      evidence_indicators:
        - "Safety function in standard task"
        - "Standard logic affects safety outputs"
        - "Improper data exchange"
      remediation: "Properly separate safety and standard logic"

  medium:
    - id: "SPS-SPL-MED-001"
      signal: "Diagnostic coverage not optimized"
      evidence_indicators:
        - "Available diagnostics not enabled"
        - "Diagnostic test interval too long"
        - "Not using channel-level diagnostics"
      remediation: "Optimize diagnostic configuration"

    - id: "SPS-SPL-MED-002"
      signal: "Program backup/recovery procedures inadequate"
      evidence_indicators:
        - "No current backup"
        - "Recovery not tested"
        - "Backup not secure"
      remediation: "Implement proper backup procedures"

  low:
    - id: "SPS-SPL-LOW-001"
      signal: "Safety program not documented"
      evidence_indicators:
        - "No program comments"
        - "Logic not explained"
        - "Design rationale missing"
      remediation: "Document safety program"

    - id: "SPS-SPL-LOW-002"
      signal: "Change history incomplete"
      evidence_indicators:
        - "Changes not recorded"
        - "Version history missing"
        - "Unable to audit changes"
      remediation: "Implement change tracking"

  positive:
    - id: "SPS-SPL-POS-001"
      signal: "Safety program complies with safety manual"
      evidence_indicators:
        - "All requirements followed"
        - "Constraints verified"
        - "Approved instructions only"

    - id: "SPS-SPL-POS-002"
      signal: "Comprehensive access control and change management"
      evidence_indicators:
        - "Strong access control"
        - "Changes documented"
        - "Audit trail maintained"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Review Hardware Configuration"
      description: "Verify hardware setup against safety manual"
      duration_estimate: "45 min"

    - id: "2"
      name: "Analyze Safety Program"
      description: "Review safety logic for correctness"
      duration_estimate: "90 min"

    - id: "3"
      name: "Verify Diagnostics"
      description: "Check diagnostic configuration"
      duration_estimate: "30 min"

    - id: "4"
      name: "Test Access Control"
      description: "Verify access restrictions"
      duration_estimate: "30 min"

    - id: "5"
      name: "Review Change Management"
      description: "Assess change procedures and history"
      duration_estimate: "30 min"

    - id: "6"
      name: "Verify Network Configuration"
      description: "Check safety network settings"
      duration_estimate: "30 min"

    - id: "7"
      name: "Document Findings"
      description: "Compile findings and recommendations"
      duration_estimate: "30 min"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Hardware Configuration Review"
        - "Program Analysis"
        - "Security Assessment"
        - "Recommendations"

closeout_checklist:
  - id: "sps-spl-001"
    item: "Safety manual compliance verified"
    level: "CRITICAL"
    verification: "manual"

  - id: "sps-spl-002"
    item: "Program logic verified correct"
    level: "CRITICAL"
    verification: "manual"

  - id: "sps-spl-003"
    item: "Access control adequate"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["industrial-automation", "process-control", "manufacturing", "critical-infrastructure"]

  compliance_mappings:
    - framework: "IEC 61508"
      control: "E/E/PE Safety"
      description: "Functional safety requirements"
    - framework: "IEC 61131-6"
      control: "Safety Programming"
      description: "Safety PLC requirements"
    - framework: "IEC 62443"
      control: "SR 2.4"
      description: "Mobile code protection"

relationships:
  commonly_combined:
    - "sensors-physical-systems.safety-systems.safety-instrumented-functions"
    - "sensors-physical-systems.safety-systems.interlock-verification"
  depends_on:
    - "safety.safety-requirements"
  feeds_into:
    - "compliance.functional-safety"
    - "security.control-system-security"
