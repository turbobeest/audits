# ============================================================
# AUDIT: Event Handler Reliability
# Category: 34 - Business Logic & Domain
# Subcategory: event-handling
# ============================================================

audit:
  id: "business-logic-domain.event-handling.event-handler-reliability"
  name: "Event Handler Reliability Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "event-handling"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the reliability of event handlers including error handling,
    retry mechanisms, idempotency, dead letter handling, and handler ordering.
    This audit ensures event handlers process events reliably without data
    loss or corruption, even in failure scenarios.

  why_it_matters: |
    Event handlers are critical integration points. Unreliable handlers cause
    lost events, inconsistent state, and business process failures. In event-
    driven systems, handler reliability directly determines system reliability.

  when_to_run:
    - "When implementing event handlers"
    - "After handler failures in production"
    - "During reliability assessments"
    - "Before increasing event volume"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Event handler implementations"
    - type: "infrastructure_config"
      description: "Message broker configuration"
    - type: "monitoring_config"
      description: "Handler monitoring setup"

  access_requirements:
    - "Read access to handler code"
    - "Access to message broker"
    - "Access to handler metrics"

discovery:
  file_patterns:
    - glob: "**/*Handler*.{ts,java,cs,py}"
      purpose: "Find event handlers"
    - glob: "**/*Consumer*.{ts,java,cs,py}"
      purpose: "Find event consumers"
    - glob: "**/*Listener*.{ts,java,cs,py}"
      purpose: "Find event listeners"
    - glob: "**/*Subscriber*.{ts,java,cs,py}"
      purpose: "Find event subscribers"

  interview_questions:
    - role: "Lead Developer"
      questions:
        - "How do handlers handle failures?"
        - "Are handlers idempotent?"
        - "How is event ordering guaranteed?"
    - role: "Operations"
      questions:
        - "How do you monitor handler health?"
        - "What happens to failed events?"
        - "How do you replay failed events?"

knowledge_sources:
  guides:
    - id: "reliable-messaging"
      name: "Reliable Messaging Patterns"
      url: "https://www.enterpriseintegrationpatterns.com/"
    - id: "kafka-consumers"
      name: "Kafka Consumer Best Practices"
      url: "https://docs.confluent.io/platform/current/clients/consumer.html"

  standards:
    - id: "at-least-once-delivery"
      name: "At-Least-Once Delivery"
      relevance: "Message delivery guarantees"

tooling:
  analysis_tools:
    - tool: "Message broker metrics"
      purpose: "Monitor handler lag and failures"
    - tool: "Dead letter queue analysis"
      purpose: "Analyze failed events"
    - tool: "Distributed tracing"
      purpose: "Track event processing"

signals:
  critical:
    - id: "EHR-CRIT-001"
      signal: "Events silently dropped on handler failure"
      evidence_indicators:
        - "No retry on failure"
        - "Events acknowledged before processing"
        - "Missing dead letter handling"
      explanation: |
        When events are silently dropped, data is lost without any indication.
        This leads to inconsistent state and missing business actions.
      remediation: "Acknowledge after processing; implement retry and DLQ"

    - id: "EHR-CRIT-002"
      signal: "Handlers not idempotent causing duplicate effects"
      evidence_indicators:
        - "Duplicate charges or notifications"
        - "Double-counting on replay"
        - "Side effects on retry"
      explanation: |
        In at-least-once delivery systems, handlers may receive the same
        event multiple times. Non-idempotent handlers cause corruption.
      remediation: "Make handlers idempotent; track processed event IDs"

  high:
    - id: "EHR-HIGH-001"
      signal: "No retry mechanism for transient failures"
      evidence_indicators:
        - "Single attempt per event"
        - "Network errors cause permanent failure"
        - "No exponential backoff"
      remediation: "Implement retry with exponential backoff"

    - id: "EHR-HIGH-002"
      signal: "Dead letter queue not monitored"
      evidence_indicators:
        - "Events accumulating in DLQ"
        - "No alerting on DLQ growth"
        - "No process to handle dead letters"
      remediation: "Monitor DLQ; implement dead letter processing"

  medium:
    - id: "EHR-MED-001"
      signal: "Event ordering not guaranteed where required"
      evidence_indicators:
        - "Out-of-order processing visible"
        - "No partition key strategy"
        - "Concurrent handlers for ordered events"
      remediation: "Use partition keys; ensure single consumer for ordered events"

    - id: "EHR-MED-002"
      signal: "Handler timeouts not configured"
      evidence_indicators:
        - "Handlers block indefinitely"
        - "No processing time limits"
        - "Stuck handlers consuming capacity"
      remediation: "Configure handler timeouts; implement circuit breakers"

  low:
    - id: "EHR-LOW-001"
      signal: "Handler performance metrics not collected"
      evidence_indicators:
        - "No processing time metrics"
        - "Cannot identify slow handlers"
      remediation: "Add handler performance instrumentation"

  positive:
    - id: "EHR-POS-001"
      signal: "Idempotent handlers with retry and DLQ"
    - id: "EHR-POS-002"
      signal: "Comprehensive handler monitoring and alerting"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Event Handlers"
      description: "Map all event handlers and their responsibilities"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Analyze Error Handling"
      description: "Review handler error handling and retry logic"
      duration_estimate: "1-2 hours"

    - id: "3"
      name: "Check Idempotency"
      description: "Verify handlers are idempotent"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Review Dead Letter Handling"
      description: "Assess DLQ configuration and monitoring"
      duration_estimate: "30 minutes"

    - id: "5"
      name: "Test Failure Scenarios"
      description: "Test handler behavior under failure"
      duration_estimate: "1 hour"

    - id: "6"
      name: "Document Findings"
      description: "Compile event handler reliability findings"
      duration_estimate: "30 minutes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of handler reliability issues"

    - type: "handler_inventory"
      format: "structured"
      description: "Inventory of event handlers"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Handler Inventory"
        - "Reliability Analysis"
        - "Failure Handling Review"
        - "Recommendations"

closeout_checklist:
  - id: "ehr-001"
    item: "All handlers inventoried"
    level: "REQUIRED"
    verification: "manual"
  - id: "ehr-002"
    item: "Idempotency verified"
    level: "REQUIRED"
    verification: "manual"
  - id: "ehr-003"
    item: "DLQ handling reviewed"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["event-driven-systems", "microservices", "message-based-systems"]

  compliance_mappings:
    - framework: "SOC 2"
      control: "Processing Integrity"
      description: "Reliable event processing"

relationships:
  commonly_combined:
    - "business-logic-domain.event-handling.domain-event-design"
    - "reliability.message-reliability"
  depends_on:
    - "infrastructure.message-broker"
  feeds_into:
    - "operations-monitoring.event-monitoring"
