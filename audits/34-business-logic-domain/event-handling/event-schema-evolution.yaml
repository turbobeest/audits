# ============================================================
# AUDIT: Event Schema Evolution
# Category: 34 - Business Logic & Domain
# Subcategory: event-handling
# ============================================================

audit:
  id: "business-logic-domain.event-handling.event-schema-evolution"
  name: "Event Schema Evolution Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "event-handling"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates strategies for evolving event schemas over time. This audit
    examines schema versioning, backward/forward compatibility, schema
    registry usage, and migration strategies. It ensures event schemas can
    evolve without breaking existing producers or consumers.

  why_it_matters: |
    Event schemas must evolve as business needs change. Without proper evolution
    strategies, schema changes break integration, cause data loss, and require
    coordinated deployments. Good schema evolution enables independent team
    velocity while maintaining compatibility.

  when_to_run:
    - "Before making event schema changes"
    - "When designing schema governance"
    - "After schema-related integration failures"
    - "During API governance reviews"

prerequisites:
  required_artifacts:
    - type: "event_schemas"
      description: "Event schema definitions"
    - type: "schema_registry"
      description: "Schema registry configuration"
    - type: "evolution_history"
      description: "History of schema changes"

  access_requirements:
    - "Read access to event schemas"
    - "Access to schema registry"
    - "Access to schema change history"

discovery:
  file_patterns:
    - glob: "**/*.avsc"
      purpose: "Find Avro schemas"
    - glob: "**/*.proto"
      purpose: "Find Protocol Buffer schemas"
    - glob: "**/schemas/**/*.{json,yaml}"
      purpose: "Find JSON schemas"
    - glob: "**/*Event*.{ts,java,cs}"
      purpose: "Find event class definitions"

  interview_questions:
    - role: "Architect"
      questions:
        - "What is your schema evolution strategy?"
        - "How do you ensure backward compatibility?"
        - "Do you use a schema registry?"
    - role: "Lead Developer"
      questions:
        - "How do you handle schema changes?"
        - "Have schema changes caused issues?"
        - "How do you test schema compatibility?"

knowledge_sources:
  guides:
    - id: "avro-schema-evolution"
      name: "Avro Schema Evolution"
      url: "https://avro.apache.org/docs/current/spec.html#Schema+Evolution"
    - id: "schema-registry"
      name: "Confluent Schema Registry"
      url: "https://docs.confluent.io/platform/current/schema-registry/"

  standards:
    - id: "schema-compatibility"
      name: "Schema Compatibility Levels"
      relevance: "Backward/forward compatibility rules"

tooling:
  analysis_tools:
    - tool: "Confluent Schema Registry"
      purpose: "Schema management and compatibility checking"
    - tool: "Avro tools"
      purpose: "Schema compatibility validation"
    - tool: "Protobuf linter"
      purpose: "Protocol Buffer validation"

signals:
  critical:
    - id: "ESE-CRIT-001"
      signal: "Breaking schema changes deployed"
      evidence_indicators:
        - "Field removed or renamed"
        - "Required field added without default"
        - "Type changed incompatibly"
      explanation: |
        Breaking schema changes cause consumer failures. Old consumers cannot
        parse new events, and old events cannot be processed by new consumers.
      remediation: "Only make backward-compatible changes; use schema registry enforcement"

    - id: "ESE-CRIT-002"
      signal: "No schema registry or version control"
      evidence_indicators:
        - "Schemas only in code"
        - "No central schema management"
        - "Schema changes not tracked"
      explanation: |
        Without centralized schema management, teams cannot coordinate
        changes and compatibility cannot be enforced.
      remediation: "Implement schema registry; track all schema versions"

  high:
    - id: "ESE-HIGH-001"
      signal: "No compatibility mode enforced"
      evidence_indicators:
        - "Registry allows breaking changes"
        - "No compatibility checking in CI"
        - "Manual compatibility review"
      remediation: "Enable compatibility mode in registry; automate checking"

    - id: "ESE-HIGH-002"
      signal: "Old schema versions not retained"
      evidence_indicators:
        - "Historical schemas deleted"
        - "Cannot replay old events"
        - "Cannot downgrade consumers"
      remediation: "Retain all schema versions; never delete schemas"

  medium:
    - id: "ESE-MED-001"
      signal: "No deprecation process for fields"
      evidence_indicators:
        - "Fields removed without notice"
        - "No deprecated field marking"
        - "Consumers surprised by removals"
      remediation: "Implement field deprecation process; mark fields as deprecated before removal"

    - id: "ESE-MED-002"
      signal: "Schema documentation not maintained"
      evidence_indicators:
        - "No field descriptions"
        - "No change history"
        - "Schema purpose unclear"
      remediation: "Document all schemas; include field descriptions and change history"

  low:
    - id: "ESE-LOW-001"
      signal: "Schema naming conventions inconsistent"
      evidence_indicators:
        - "Mixed naming patterns"
        - "No versioning in schema names"
      remediation: "Establish and enforce schema naming conventions"

  positive:
    - id: "ESE-POS-001"
      signal: "Schema registry with compatibility enforcement"
    - id: "ESE-POS-002"
      signal: "Clear deprecation and evolution process"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Review Schema Management"
      description: "Assess schema storage and versioning"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Analyze Compatibility Rules"
      description: "Review compatibility mode configuration"
      duration_estimate: "1 hour"

    - id: "3"
      name: "Check Evolution History"
      description: "Review historical schema changes"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Test Compatibility"
      description: "Verify current schemas are compatible"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Document Findings"
      description: "Compile schema evolution findings"
      duration_estimate: "30 minutes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of schema evolution issues"

    - type: "schema_inventory"
      format: "structured"
      description: "Inventory of event schemas"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Schema Management Review"
        - "Compatibility Analysis"
        - "Evolution History"
        - "Recommendations"

closeout_checklist:
  - id: "ese-001"
    item: "Schema management assessed"
    level: "REQUIRED"
    verification: "manual"
  - id: "ese-002"
    item: "Compatibility rules reviewed"
    level: "REQUIRED"
    verification: "automated"
  - id: "ese-003"
    item: "Evolution history documented"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["event-driven-systems", "microservices", "data-platforms"]

  compliance_mappings:
    - framework: "API Governance"
      control: "Schema Management"
      description: "Event schema governance"

relationships:
  commonly_combined:
    - "business-logic-domain.event-handling.domain-event-design"
    - "api-design.versioning"
  depends_on:
    - "infrastructure.schema-registry"
  feeds_into:
    - "integration.backward-compatibility"
