# ============================================================
# AUDIT: Domain Event Design
# Category: 34 - Business Logic & Domain
# Subcategory: event-handling
# ============================================================

audit:
  id: "business-logic-domain.event-handling.domain-event-design"
  name: "Domain Event Design Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "event-handling"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the design of domain events in event-driven systems. This audit
    examines event naming, payload design, versioning, immutability, and whether
    events properly represent business facts. It ensures domain events are
    well-designed for current and future consumption needs.

  why_it_matters: |
    Domain events are the contract between producers and consumers in event-driven
    systems. Poorly designed events lead to tight coupling, versioning nightmares,
    and integration failures. Good event design enables system evolution while
    maintaining backward compatibility.

  when_to_run:
    - "When designing event-driven architecture"
    - "Before publishing new event types"
    - "During event contract reviews"
    - "When experiencing integration issues"

prerequisites:
  required_artifacts:
    - type: "event_definitions"
      description: "Domain event schemas/classes"
    - type: "source_code"
      description: "Event producer implementations"
    - type: "event_catalog"
      description: "Event catalog documentation"

  access_requirements:
    - "Read access to event definitions"
    - "Access to event producer code"
    - "Access to event documentation"

discovery:
  file_patterns:
    - glob: "**/*Event*.{ts,java,cs,py}"
      purpose: "Find event definitions"
    - glob: "**/events/**/*.{ts,java,cs,py}"
      purpose: "Find event code"
    - glob: "**/domain/events/**/*"
      purpose: "Find domain events"
    - glob: "**/*.avsc"
      purpose: "Find Avro event schemas"
    - glob: "**/*.proto"
      purpose: "Find Protocol Buffer definitions"

  interview_questions:
    - role: "Architect"
      questions:
        - "What principles guide event design?"
        - "How do you handle event versioning?"
        - "What information should events contain?"
    - role: "Lead Developer"
      questions:
        - "How are domain events defined?"
        - "Are there event naming conventions?"
        - "How do you ensure backward compatibility?"

knowledge_sources:
  guides:
    - id: "domain-events"
      name: "Domain Events"
      url: "https://martinfowler.com/eaaDev/DomainEvent.html"
    - id: "event-design"
      name: "Designing Events"
      url: "https://cloudevents.io/"

  standards:
    - id: "cloudevents"
      name: "CloudEvents Specification"
      relevance: "Event format standard"

tooling:
  analysis_tools:
    - tool: "Schema Registry"
      purpose: "Event schema management"
    - tool: "AsyncAPI"
      purpose: "Event API documentation"
    - tool: "Avro"
      purpose: "Event serialization and schema evolution"

signals:
  critical:
    - id: "DED-CRIT-001"
      signal: "Events contain mutable or derived state"
      evidence_indicators:
        - "Events include current entity state"
        - "Calculated fields that may change"
        - "References to other entities that may update"
      explanation: |
        Events should represent facts that happened, not current state.
        Including mutable state makes events unreliable for replay and
        creates inconsistencies.
      remediation: "Events should contain only the fact of what changed, not current state"

    - id: "DED-CRIT-002"
      signal: "Events missing critical business context"
      evidence_indicators:
        - "No correlation ID"
        - "Missing causation chain"
        - "No timestamp or actor information"
      explanation: |
        Events without proper context cannot be traced, audited, or
        properly processed. Missing context makes debugging and
        compliance difficult.
      remediation: "Include correlation ID, timestamp, actor, and causation in all events"

  high:
    - id: "DED-HIGH-001"
      signal: "Event naming not following business language"
      evidence_indicators:
        - "Technical event names"
        - "CRUD-style event names (Created, Updated)"
        - "Names not understood by domain experts"
      remediation: "Use past-tense business terminology (OrderPlaced, PaymentReceived)"

    - id: "DED-HIGH-002"
      signal: "Events too fine-grained or coarse-grained"
      evidence_indicators:
        - "Multiple events always processed together"
        - "Single event requiring complex parsing"
        - "Event granularity mismatch with business concepts"
      remediation: "Align event granularity with business operations"

  medium:
    - id: "DED-MED-001"
      signal: "No event versioning strategy"
      evidence_indicators:
        - "No version field in events"
        - "Breaking changes to event structure"
        - "No schema evolution plan"
      remediation: "Implement event versioning; plan for schema evolution"

    - id: "DED-MED-002"
      signal: "Events not self-describing"
      evidence_indicators:
        - "Type information not in event"
        - "Schema required for all processing"
        - "Cannot determine event type from payload"
      remediation: "Include type information in event; make events self-describing"

  low:
    - id: "DED-LOW-001"
      signal: "Event documentation incomplete"
      evidence_indicators:
        - "No event catalog"
        - "Undocumented event fields"
      remediation: "Create comprehensive event documentation"

  positive:
    - id: "DED-POS-001"
      signal: "Well-named events expressing business facts"
    - id: "DED-POS-002"
      signal: "Clear versioning strategy with backward compatibility"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Domain Events"
      description: "Catalog all domain event types"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Review Event Structure"
      description: "Analyze event payload design"
      duration_estimate: "1-2 hours"

    - id: "3"
      name: "Assess Naming Conventions"
      description: "Review event naming against business language"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Check Versioning"
      description: "Verify versioning strategy exists"
      duration_estimate: "30 minutes"

    - id: "5"
      name: "Document Findings"
      description: "Compile domain event design findings"
      duration_estimate: "30 minutes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of event design issues"

    - type: "event_catalog"
      format: "structured"
      description: "Catalog of domain events"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Event Inventory"
        - "Design Analysis"
        - "Versioning Assessment"
        - "Recommendations"

closeout_checklist:
  - id: "ded-001"
    item: "All domain events cataloged"
    level: "REQUIRED"
    verification: "manual"
  - id: "ded-002"
    item: "Event structure reviewed"
    level: "REQUIRED"
    verification: "manual"
  - id: "ded-003"
    item: "Versioning strategy assessed"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["event-driven-systems", "microservices", "enterprise-applications"]

  compliance_mappings:
    - framework: "API Governance"
      control: "Event Contracts"
      description: "Domain event design standards"

relationships:
  commonly_combined:
    - "business-logic-domain.event-handling.event-sourcing-implementation"
    - "architecture-design.event-driven-architecture"
  depends_on:
    - "requirements-specification.event-requirements"
  feeds_into:
    - "integration.event-integration"
