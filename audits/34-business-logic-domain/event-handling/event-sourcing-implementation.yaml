# ============================================================
# AUDIT: Event Sourcing Implementation
# Category: 34 - Business Logic & Domain
# Subcategory: event-handling
# ============================================================

audit:
  id: "business-logic-domain.event-handling.event-sourcing-implementation"
  name: "Event Sourcing Implementation Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "event-handling"

  tier: "expert"
  estimated_duration: "6-10 hours"  # median: 8h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates event sourcing implementations including event store design,
    aggregate reconstruction, snapshot strategies, event versioning, and
    projection maintenance. This audit ensures event sourcing is implemented
    correctly for reliable state reconstruction and temporal queries.

  why_it_matters: |
    Event sourcing provides powerful audit capabilities and temporal flexibility
    but is complex to implement correctly. Incorrect implementations lead to
    data loss, inconsistent state, performance problems, and inability to
    reproduce historical states. Proper implementation is essential.

  when_to_run:
    - "When implementing event sourcing"
    - "After event replay issues"
    - "During event store reviews"
    - "Before major event schema changes"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Event sourcing implementations"
    - type: "event_store"
      description: "Event store configuration"
    - type: "projection_code"
      description: "Event projection implementations"

  access_requirements:
    - "Read access to event sourcing code"
    - "Access to event store"
    - "Access to projection infrastructure"

discovery:
  file_patterns:
    - glob: "**/*EventStore*.{ts,java,cs,py}"
      purpose: "Find event store implementations"
    - glob: "**/*Aggregate*.{ts,java,cs,py}"
      purpose: "Find event-sourced aggregates"
    - glob: "**/*Projection*.{ts,java,cs,py}"
      purpose: "Find projection implementations"
    - glob: "**/*Snapshot*.{ts,java,cs,py}"
      purpose: "Find snapshot code"

  interview_questions:
    - role: "Architect"
      questions:
        - "Why was event sourcing chosen?"
        - "How are aggregates reconstructed?"
        - "What is the snapshot strategy?"
    - role: "Lead Developer"
      questions:
        - "How do you handle event versioning?"
        - "How are projections maintained?"
        - "What happens when events need to change?"

knowledge_sources:
  guides:
    - id: "event-sourcing"
      name: "Event Sourcing"
      url: "https://martinfowler.com/eaaDev/EventSourcing.html"
    - id: "eventstore-db"
      name: "EventStoreDB Documentation"
      url: "https://www.eventstore.com/docs/"

  standards:
    - id: "cqrs-event-sourcing"
      name: "CQRS and Event Sourcing"
      relevance: "Event sourcing patterns"

tooling:
  analysis_tools:
    - tool: "EventStoreDB"
      purpose: "Purpose-built event store"
    - tool: "Axon Framework"
      purpose: "Java event sourcing framework"
    - tool: "Marten"
      purpose: ".NET event sourcing library"
    - tool: "Event Store benchmarking"
      purpose: "Performance testing"

signals:
  critical:
    - id: "ESI-CRIT-001"
      signal: "Events modified after storage"
      evidence_indicators:
        - "Event updates in event store"
        - "Missing events in sequence"
        - "Event hashes don't match"
      explanation: |
        Events must be immutable once stored. Modifying events destroys
        the audit trail and makes state reconstruction unreliable.
      remediation: "Ensure events are append-only; use compensating events for corrections"

    - id: "ESI-CRIT-002"
      signal: "Aggregate state cannot be reconstructed from events"
      evidence_indicators:
        - "Replay produces different state"
        - "Missing event handlers"
        - "Non-deterministic event application"
      explanation: |
        The fundamental promise of event sourcing is that state can be
        reconstructed from events. If this fails, the system is unreliable.
      remediation: "Fix event handlers; ensure deterministic event application"

  high:
    - id: "ESI-HIGH-001"
      signal: "No snapshot strategy for long event streams"
      evidence_indicators:
        - "Slow aggregate loading"
        - "Thousands of events per aggregate"
        - "Memory issues during replay"
      remediation: "Implement snapshot strategy; create snapshots at intervals"

    - id: "ESI-HIGH-002"
      signal: "Event version migrations not handled"
      evidence_indicators:
        - "Old event formats fail to load"
        - "No upcasting for old events"
        - "Schema changes break replay"
      remediation: "Implement event upcasting; version events properly"

  medium:
    - id: "ESI-MED-001"
      signal: "Projections not eventually consistent"
      evidence_indicators:
        - "Projections miss events"
        - "No replay capability for projections"
        - "Projection gaps not detected"
      remediation: "Implement projection rebuild capability; monitor consistency"

    - id: "ESI-MED-002"
      signal: "No idempotency in event handlers"
      evidence_indicators:
        - "Replay produces side effects"
        - "Duplicate event handling"
        - "Non-repeatable projections"
      remediation: "Make event handlers idempotent; track processed events"

  low:
    - id: "ESI-LOW-001"
      signal: "Event store not optimized for read patterns"
      evidence_indicators:
        - "Slow queries for projections"
        - "Missing indexes"
      remediation: "Optimize event store for read patterns; add appropriate indexes"

  positive:
    - id: "ESI-POS-001"
      signal: "Clean separation of event storage and projections"
    - id: "ESI-POS-002"
      signal: "Reliable state reconstruction from events"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Review Event Store Design"
      description: "Analyze event storage implementation"
      duration_estimate: "1-2 hours"

    - id: "2"
      name: "Test State Reconstruction"
      description: "Verify aggregates can be rebuilt from events"
      duration_estimate: "2 hours"

    - id: "3"
      name: "Assess Versioning Strategy"
      description: "Review event versioning and upcasting"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Check Projection Consistency"
      description: "Verify projections maintain consistency"
      duration_estimate: "1-2 hours"

    - id: "5"
      name: "Review Snapshot Strategy"
      description: "Assess snapshot implementation"
      duration_estimate: "1 hour"

    - id: "6"
      name: "Document Findings"
      description: "Compile event sourcing findings"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of event sourcing issues"

    - type: "architecture_diagram"
      format: "diagram"
      description: "Event sourcing architecture diagram"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Event Store Analysis"
        - "Reconstruction Testing"
        - "Projection Assessment"
        - "Recommendations"

closeout_checklist:
  - id: "esi-001"
    item: "Event store design reviewed"
    level: "REQUIRED"
    verification: "manual"
  - id: "esi-002"
    item: "State reconstruction verified"
    level: "REQUIRED"
    verification: "automated"
  - id: "esi-003"
    item: "Projection consistency checked"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["event-sourced-systems", "fintech", "audit-heavy-systems"]

  compliance_mappings:
    - framework: "SOX"
      control: "Audit Trail"
      description: "Immutable event history for audit"

relationships:
  commonly_combined:
    - "business-logic-domain.event-handling.domain-event-design"
    - "architecture-design.cqrs-implementation"
  depends_on:
    - "architecture-design.event-sourcing-decision"
  feeds_into:
    - "data-management.audit-trail"
