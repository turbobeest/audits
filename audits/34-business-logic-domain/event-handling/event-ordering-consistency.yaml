# ============================================================
# AUDIT: Event Ordering Consistency
# Category: 34 - Business Logic & Domain
# Subcategory: event-handling
# ============================================================

audit:
  id: "business-logic-domain.event-handling.event-ordering-consistency"
  name: "Event Ordering Consistency Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "event-handling"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates event ordering guarantees and consistency in event-driven systems.
    This audit examines partition strategies, ordering requirements, timestamp
    handling, and causality preservation. It ensures events are processed in
    the correct order when business logic depends on sequence.

  why_it_matters: |
    Many business processes depend on event ordering. Processing events out of
    order can cause incorrect state, violated invariants, and business logic
    failures. Understanding and enforcing ordering requirements is critical for
    event-driven system correctness.

  when_to_run:
    - "When designing event-driven systems"
    - "After ordering-related bugs"
    - "When scaling event consumers"
    - "During consistency reviews"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Event production and consumption code"
    - type: "broker_config"
      description: "Message broker configuration"
    - type: "event_schemas"
      description: "Event definitions"

  access_requirements:
    - "Read access to event code"
    - "Access to message broker configuration"
    - "Access to event flow documentation"

discovery:
  file_patterns:
    - glob: "**/*Producer*.{ts,java,cs,py}"
      purpose: "Find event producers"
    - glob: "**/*Consumer*.{ts,java,cs,py}"
      purpose: "Find event consumers"
    - glob: "**/*Partition*.{ts,java,cs,py}"
      purpose: "Find partitioning code"
    - glob: "**/kafka/**/*.{yaml,properties}"
      purpose: "Find Kafka configuration"

  interview_questions:
    - role: "Architect"
      questions:
        - "Which events require ordering guarantees?"
        - "How is ordering achieved?"
        - "What happens if events arrive out of order?"
    - role: "Lead Developer"
      questions:
        - "How are partition keys chosen?"
        - "How do you handle concurrent consumers?"
        - "Are there known ordering issues?"

knowledge_sources:
  guides:
    - id: "kafka-ordering"
      name: "Kafka Message Ordering"
      url: "https://docs.confluent.io/platform/current/clients/consumer.html"
    - id: "event-ordering"
      name: "Event Ordering Patterns"
      url: "https://microservices.io/patterns/data/event-sourcing.html"

  standards:
    - id: "causal-consistency"
      name: "Causal Consistency"
      relevance: "Event ordering guarantees"

tooling:
  analysis_tools:
    - tool: "Kafka partition analyzers"
      purpose: "Analyze partition distribution"
    - tool: "Distributed tracing"
      purpose: "Track event causality"
    - tool: "Event sequence analysis"
      purpose: "Detect ordering violations"

signals:
  critical:
    - id: "EOC-CRIT-001"
      signal: "Order-dependent events processed out of order"
      evidence_indicators:
        - "Cancellation processed before creation"
        - "Updates processed before initial event"
        - "State corruption from ordering issues"
      explanation: |
        When events that require ordering are processed out of sequence,
        business logic fails and data becomes inconsistent.
      remediation: "Ensure partition key groups related events; use single consumer per partition"

    - id: "EOC-CRIT-002"
      signal: "Partition strategy breaks business ordering requirements"
      evidence_indicators:
        - "Related events on different partitions"
        - "Random partition assignment"
        - "Ordering requirement not analyzed"
      explanation: |
        Without proper partitioning, related events may be processed
        concurrently by different consumers, breaking ordering.
      remediation: "Design partition keys to maintain ordering for related events"

  high:
    - id: "EOC-HIGH-001"
      signal: "Timestamps not reliable for ordering"
      evidence_indicators:
        - "Clock skew between producers"
        - "Events with older timestamps arrive later"
        - "No sequence numbers for ordering"
      remediation: "Use sequence numbers within partitions; don't rely solely on timestamps"

    - id: "EOC-HIGH-002"
      signal: "Consumer parallelism breaks ordering"
      evidence_indicators:
        - "Multiple consumers per partition"
        - "Thread pool processing single partition"
        - "Concurrent handler invocations"
      remediation: "Ensure single-threaded processing within partition"

  medium:
    - id: "EOC-MED-001"
      signal: "No handling for late-arriving events"
      evidence_indicators:
        - "Events arriving after window closed"
        - "No out-of-order event detection"
        - "Silent ordering violations"
      remediation: "Implement late event handling; detect ordering violations"

    - id: "EOC-MED-002"
      signal: "Causality not tracked in events"
      evidence_indicators:
        - "No causation ID in events"
        - "Cannot determine event dependencies"
        - "Root cause analysis difficult"
      remediation: "Add causation/correlation IDs; track event chains"

  low:
    - id: "EOC-LOW-001"
      signal: "Ordering requirements not documented"
      evidence_indicators:
        - "No documentation of which events need ordering"
        - "Assumptions only in code"
      remediation: "Document ordering requirements explicitly"

  positive:
    - id: "EOC-POS-001"
      signal: "Clear partition strategy maintaining ordering"
    - id: "EOC-POS-002"
      signal: "Ordering requirements documented and enforced"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify Ordering Requirements"
      description: "Document which events require ordering"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Analyze Partition Strategy"
      description: "Review how events are partitioned"
      duration_estimate: "1-2 hours"

    - id: "3"
      name: "Review Consumer Configuration"
      description: "Verify consumer maintains ordering"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Test Ordering Scenarios"
      description: "Test event processing order"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Document Findings"
      description: "Compile ordering consistency findings"
      duration_estimate: "30 minutes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of ordering issues"

    - type: "ordering_matrix"
      format: "structured"
      description: "Matrix of events and ordering requirements"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Ordering Requirements"
        - "Partition Analysis"
        - "Consumer Review"
        - "Recommendations"

closeout_checklist:
  - id: "eoc-001"
    item: "Ordering requirements documented"
    level: "REQUIRED"
    verification: "manual"
  - id: "eoc-002"
    item: "Partition strategy reviewed"
    level: "REQUIRED"
    verification: "manual"
  - id: "eoc-003"
    item: "Consumer configuration verified"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["event-driven-systems", "microservices", "stream-processing"]

  compliance_mappings:
    - framework: "Data Consistency"
      control: "Event Processing"
      description: "Event ordering for data consistency"

relationships:
  commonly_combined:
    - "business-logic-domain.event-handling.event-handler-reliability"
    - "architecture-design.event-driven-architecture"
  depends_on:
    - "infrastructure.message-broker"
  feeds_into:
    - "data-management.consistency"
