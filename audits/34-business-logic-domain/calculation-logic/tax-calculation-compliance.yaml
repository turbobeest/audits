# ============================================================
# AUDIT: Tax Calculation Compliance
# Category: 34 - Business Logic & Domain
# Subcategory: calculation-logic
# ============================================================

audit:
  id: "business-logic-domain.calculation-logic.tax-calculation-compliance"
  name: "Tax Calculation Compliance Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "calculation-logic"

  tier: "expert"
  estimated_duration: "6-10 hours"  # median: 8h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates tax calculation logic for compliance with applicable tax regulations.
    This audit examines sales tax, VAT, GST, withholding tax, and other tax
    calculations for correctness, jurisdiction handling, rate application, and
    exemption handling. It ensures tax calculations comply with regulatory
    requirements and produce accurate tax amounts.

  why_it_matters: |
    Incorrect tax calculations create legal liability, regulatory penalties, and
    audit findings. Both under-collection and over-collection cause problems.
    Tax compliance is non-negotiable for businesses operating in jurisdictions
    with tax obligations.

  when_to_run:
    - "Before launching in new tax jurisdictions"
    - "When tax rates or rules change"
    - "During regulatory compliance audits"
    - "After tax-related customer complaints"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Tax calculation implementations"
    - type: "tax_requirements"
      description: "Applicable tax regulations"
    - type: "tax_rate_data"
      description: "Tax rates and jurisdiction data"

  access_requirements:
    - "Read access to tax calculation code"
    - "Access to tax rate configurations"
    - "Access to tax regulation documentation"

discovery:
  file_patterns:
    - glob: "**/*Tax*.{ts,java,cs,py}"
      purpose: "Find tax calculation code"
    - glob: "**/*VAT*.{ts,java,cs,py}"
      purpose: "Find VAT calculation code"
    - glob: "**/*GST*.{ts,java,cs,py}"
      purpose: "Find GST calculation code"
    - glob: "**/tax/**/*.{ts,java,cs,py}"
      purpose: "Find tax module code"

  interview_questions:
    - role: "Tax/Finance Team"
      questions:
        - "What tax types apply to your business?"
        - "How are tax rates determined for each transaction?"
        - "How are tax exemptions handled?"
    - role: "Lead Developer"
      questions:
        - "How is tax calculation implemented?"
        - "How are jurisdiction-specific rules handled?"
        - "How are tax rates kept up to date?"

knowledge_sources:
  guides:
    - id: "sales-tax-guide"
      name: "Sales Tax Compliance Guide"
      url: "https://www.avalara.com/us/en/learn/tax-compliance.html"
    - id: "vat-regulations"
      name: "EU VAT Regulations"
      url: "https://ec.europa.eu/taxation_customs/business/vat/"

  standards:
    - id: "tax-jurisdiction-rules"
      name: "Tax Jurisdiction Rules"
      relevance: "Multi-jurisdiction tax compliance"

tooling:
  analysis_tools:
    - tool: "Avalara"
      purpose: "Tax calculation and compliance service"
    - tool: "TaxJar"
      purpose: "Sales tax API"
    - tool: "Vertex"
      purpose: "Enterprise tax calculation"
    - tool: "Custom tax validators"
      purpose: "Verify tax calculation accuracy"

signals:
  critical:
    - id: "TCC-CRIT-001"
      signal: "Tax calculated incorrectly for jurisdiction"
      evidence_indicators:
        - "Wrong tax rate applied"
        - "Tax calculated when exempt"
        - "Taxable amount incorrect"
      explanation: |
        Incorrect tax calculation creates legal liability and regulatory risk.
        Both under-collection (requiring you to pay the difference) and
        over-collection (requiring refunds) are serious issues.
      remediation: "Fix tax calculation logic; verify against jurisdiction requirements"

    - id: "TCC-CRIT-002"
      signal: "Tax jurisdiction determination incorrect"
      evidence_indicators:
        - "Wrong jurisdiction selected for transaction"
        - "Ship-to vs. origin rules not applied correctly"
        - "Nexus not properly considered"
      explanation: |
        Applying the wrong jurisdiction's tax rules causes compliance
        violations in multiple jurisdictions simultaneously.
      remediation: "Implement proper jurisdiction determination logic"

  high:
    - id: "TCC-HIGH-001"
      signal: "Tax rates not kept current"
      evidence_indicators:
        - "Hardcoded tax rates"
        - "No rate update mechanism"
        - "Stale rates in production"
      remediation: "Implement rate update process; use tax service provider if appropriate"

    - id: "TCC-HIGH-002"
      signal: "Tax exemptions not properly validated"
      evidence_indicators:
        - "Exemption certificates not verified"
        - "Expired exemptions still honored"
        - "No exemption audit trail"
      remediation: "Implement exemption validation; track exemption certificates"

  medium:
    - id: "TCC-MED-001"
      signal: "Tax rounding not compliant with jurisdiction rules"
      evidence_indicators:
        - "Rounding mode differs from jurisdiction requirement"
        - "Line-item vs. invoice-level rounding incorrect"
        - "Penny differences accumulating"
      remediation: "Apply jurisdiction-specific rounding rules"

    - id: "TCC-MED-002"
      signal: "Product taxability not properly classified"
      evidence_indicators:
        - "All products taxed the same"
        - "Tax categories not assigned"
        - "Exempt products being taxed"
      remediation: "Implement product tax classification; assign tax categories"

  low:
    - id: "TCC-LOW-001"
      signal: "Tax calculation not auditable"
      evidence_indicators:
        - "No breakdown of tax calculation"
        - "Cannot reproduce historical tax calculation"
      remediation: "Store tax calculation details; maintain calculation audit trail"

  positive:
    - id: "TCC-POS-001"
      signal: "Tax calculations verified against external tax service"
    - id: "TCC-POS-002"
      signal: "Complete audit trail for all tax calculations"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Map Tax Calculations"
      description: "Identify all tax calculation logic"
      duration_estimate: "1-2 hours"

    - id: "2"
      name: "Review Jurisdiction Handling"
      description: "Analyze how jurisdictions are determined"
      duration_estimate: "1-2 hours"

    - id: "3"
      name: "Verify Rate Application"
      description: "Check that correct rates are applied"
      duration_estimate: "2 hours"

    - id: "4"
      name: "Test Exemptions"
      description: "Verify exemption handling"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Validate Against Requirements"
      description: "Compare implementation to regulations"
      duration_estimate: "2 hours"

    - id: "6"
      name: "Document Findings"
      description: "Compile tax compliance findings"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of tax calculation compliance issues"

    - type: "tax_matrix"
      format: "structured"
      description: "Matrix of jurisdictions and tax handling"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Tax Calculation Inventory"
        - "Jurisdiction Analysis"
        - "Compliance Assessment"
        - "Recommendations"

closeout_checklist:
  - id: "tcc-001"
    item: "All tax calculations identified"
    level: "REQUIRED"
    verification: "manual"
  - id: "tcc-002"
    item: "Jurisdiction handling verified"
    level: "REQUIRED"
    verification: "manual"
  - id: "tcc-003"
    item: "Rate accuracy confirmed"
    level: "REQUIRED"
    verification: "automated"

governance:
  applicable_to:
    archetypes: ["e-commerce", "fintech", "retail", "saas"]

  compliance_mappings:
    - framework: "Sales Tax Regulations"
      control: "Tax Collection"
      description: "Sales tax compliance"
    - framework: "VAT Regulations"
      control: "VAT Collection"
      description: "VAT compliance"

relationships:
  commonly_combined:
    - "business-logic-domain.calculation-logic.financial-accuracy"
    - "compliance-legal.tax-compliance"
  depends_on:
    - "requirements-specification.tax-requirements"
  feeds_into:
    - "compliance-legal.regulatory-compliance"
