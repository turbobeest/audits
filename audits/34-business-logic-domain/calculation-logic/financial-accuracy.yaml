# ============================================================
# AUDIT: Financial Accuracy
# Category: 34 - Business Logic & Domain
# Subcategory: calculation-logic
# ============================================================

audit:
  id: "business-logic-domain.calculation-logic.financial-accuracy"
  name: "Financial Accuracy Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "calculation-logic"

  tier: "expert"
  estimated_duration: "6-10 hours"  # median: 8h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the accuracy of financial calculations including pricing, billing,
    taxes, interest, and monetary computations. This audit examines calculation
    algorithms, decimal handling, rounding modes, precision maintenance, and
    verification against known-correct results. It ensures financial calculations
    produce accurate results that match business specifications.

  why_it_matters: |
    Financial calculation errors directly impact revenue, customer trust, and
    regulatory compliance. Even small calculation errors compound over volume
    to create significant discrepancies. Accurate financial calculations are
    non-negotiable for fintech, e-commerce, and any system handling money.

  when_to_run:
    - "Before launching financial features"
    - "After changes to pricing or billing logic"
    - "During compliance audits"
    - "After customer complaints about billing"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Financial calculation implementations"
    - type: "business_requirements"
      description: "Financial calculation specifications"
    - type: "test_cases"
      description: "Known-correct calculation examples"

  access_requirements:
    - "Read access to financial calculation code"
    - "Access to calculation specifications"
    - "Access to test data with verified results"

discovery:
  file_patterns:
    - glob: "**/pricing/**/*.{ts,java,cs,py}"
      purpose: "Find pricing logic"
    - glob: "**/billing/**/*.{ts,java,cs,py}"
      purpose: "Find billing calculations"
    - glob: "**/*Calculator*.{ts,java,cs,py}"
      purpose: "Find calculator classes"
    - glob: "**/*Tax*.{ts,java,cs,py}"
      purpose: "Find tax calculation code"
    - glob: "**/*Interest*.{ts,java,cs,py}"
      purpose: "Find interest calculation code"

  interview_questions:
    - role: "Finance Team"
      questions:
        - "What financial calculations are critical to the business?"
        - "How do you verify calculation accuracy?"
        - "Have there been known calculation errors?"
    - role: "Lead Developer"
      questions:
        - "What numeric types are used for financial calculations?"
        - "How is rounding handled?"
        - "Are calculations verified against external systems?"

knowledge_sources:
  guides:
    - id: "financial-calculation-best-practices"
      name: "Financial Calculation Best Practices"
      url: "https://martinfowler.com/eaaCatalog/money.html"
    - id: "decimal-arithmetic"
      name: "IEEE 754 Decimal Arithmetic"
      url: "https://speleotrove.com/decimal/"

  standards:
    - id: "gaap"
      name: "Generally Accepted Accounting Principles"
      relevance: "Financial calculation standards"
    - id: "ifrs"
      name: "International Financial Reporting Standards"
      relevance: "Financial reporting accuracy"

tooling:
  analysis_tools:
    - tool: "Property-based testing"
      purpose: "Generate calculation test cases"
    - tool: "Excel/Spreadsheet verification"
      purpose: "Manual calculation verification"
    - tool: "Financial calculation libraries"
      purpose: "dinero.js, JSR-354, NodaMoney"
    - tool: "SonarQube"
      purpose: "Detect floating-point comparison issues"

signals:
  critical:
    - id: "FAC-CRIT-001"
      signal: "Floating-point types used for monetary values"
      evidence_indicators:
        - "double/float used for money"
        - "Currency stored as floating-point"
        - "Comparison of money using float equality"
      explanation: |
        Floating-point types cannot accurately represent all decimal values,
        leading to cumulative errors. Financial calculations must use decimal
        or integer types to maintain precision.
      remediation: "Use decimal types or integer cents/minor units for all money"

    - id: "FAC-CRIT-002"
      signal: "Calculation produces incorrect results"
      evidence_indicators:
        - "Discrepancy between calculated and expected values"
        - "Algorithm does not match specification"
        - "Test failures against known-correct values"
      explanation: |
        Incorrect financial calculations directly cause revenue loss or
        overcharging. Both are serious business and compliance issues.
      remediation: "Fix calculation algorithm; verify against specification"

  high:
    - id: "FAC-HIGH-001"
      signal: "Inconsistent rounding across calculations"
      evidence_indicators:
        - "Different rounding modes in different places"
        - "Banker's rounding vs. half-up inconsistently applied"
        - "Line items don't sum to total due to rounding"
      remediation: "Standardize rounding mode; document and apply consistently"

    - id: "FAC-HIGH-002"
      signal: "Precision loss during intermediate calculations"
      evidence_indicators:
        - "Division before multiplication causing precision loss"
        - "Truncation in intermediate steps"
        - "Final result depends on calculation order"
      remediation: "Restructure calculations to preserve precision; round only at end"

  medium:
    - id: "FAC-MED-001"
      signal: "No validation against known-correct results"
      evidence_indicators:
        - "No golden test cases with verified results"
        - "Calculations not compared to external sources"
        - "No regression tests for calculations"
      remediation: "Create test suite with verified calculation results"

    - id: "FAC-MED-002"
      signal: "Edge cases not tested for calculations"
      evidence_indicators:
        - "Zero values not tested"
        - "Maximum/minimum values not tested"
        - "Negative amounts not handled"
      remediation: "Add edge case tests for all financial calculations"

  low:
    - id: "FAC-LOW-001"
      signal: "Financial calculation logic not centralized"
      evidence_indicators:
        - "Duplicate calculation code"
        - "Calculations scattered across codebase"
      remediation: "Centralize financial calculations in dedicated modules"

  positive:
    - id: "FAC-POS-001"
      signal: "All financial calculations use decimal types"
    - id: "FAC-POS-002"
      signal: "Comprehensive test suite with verified results"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify Financial Calculations"
      description: "Map all financial calculation code"
      duration_estimate: "1-2 hours"

    - id: "2"
      name: "Review Numeric Types"
      description: "Verify appropriate types used for money"
      duration_estimate: "1 hour"
      tools:
        - name: "SonarQube"
          action: "Run floating-point money detection rules"

    - id: "3"
      name: "Analyze Algorithms"
      description: "Review calculation algorithms against specifications"
      duration_estimate: "2-3 hours"

    - id: "4"
      name: "Verify Results"
      description: "Test calculations against known-correct values"
      duration_estimate: "2 hours"

    - id: "5"
      name: "Document Findings"
      description: "Compile financial accuracy findings"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of financial accuracy issues"

    - type: "calculation_inventory"
      format: "structured"
      description: "Inventory of financial calculations"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Calculation Inventory"
        - "Type Analysis"
        - "Algorithm Review"
        - "Verification Results"
        - "Recommendations"

closeout_checklist:
  - id: "fac-001"
    item: "All financial calculations identified"
    level: "REQUIRED"
    verification: "manual"
  - id: "fac-002"
    item: "Numeric types verified"
    level: "REQUIRED"
    verification: "automated"
  - id: "fac-003"
    item: "Calculations verified against known-correct values"
    level: "REQUIRED"
    verification: "automated"

governance:
  applicable_to:
    archetypes: ["fintech", "e-commerce", "insurance", "banking"]

  compliance_mappings:
    - framework: "SOX"
      control: "Financial Reporting"
      description: "Financial calculation accuracy"
    - framework: "PCI-DSS"
      control: "Transaction Processing"
      description: "Payment calculation accuracy"

relationships:
  commonly_combined:
    - "business-logic-domain.calculation-logic.rounding-precision"
    - "business-logic-domain.calculation-logic.currency-handling"
  depends_on:
    - "requirements-specification.financial-requirements"
  feeds_into:
    - "compliance-legal.financial-compliance"
