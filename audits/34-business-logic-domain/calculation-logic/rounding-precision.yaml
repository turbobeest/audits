# ============================================================
# AUDIT: Rounding Precision
# Category: 34 - Business Logic & Domain
# Subcategory: calculation-logic
# ============================================================

audit:
  id: "business-logic-domain.calculation-logic.rounding-precision"
  name: "Rounding Precision Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "calculation-logic"

  tier: "expert"
  estimated_duration: "3-5 hours"  # median: 4h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates rounding strategies and precision handling in business calculations.
    This audit examines rounding modes (half-up, banker's rounding, truncation),
    precision levels, when rounding is applied, and consistency of rounding across
    the system. It ensures rounding behavior is intentional, consistent, and
    compliant with business requirements.

  why_it_matters: |
    Incorrect or inconsistent rounding causes discrepancies that compound over
    volume. When line items don't sum to totals, or prices differ between displays,
    user trust erodes. Rounding strategies must be explicit and consistent for
    financial accuracy and regulatory compliance.

  when_to_run:
    - "When implementing financial calculations"
    - "After rounding-related discrepancies reported"
    - "During pricing system reviews"
    - "Before multi-currency implementations"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Calculation implementations with rounding"
    - type: "business_requirements"
      description: "Rounding rules documentation"

  access_requirements:
    - "Read access to calculation code"
    - "Access to rounding specifications"

discovery:
  file_patterns:
    - glob: "**/*Round*.{ts,java,cs,py}"
      purpose: "Find rounding code"
    - glob: "**/*Precision*.{ts,java,cs,py}"
      purpose: "Find precision handling code"
    - glob: "**/pricing/**/*.{ts,java,cs,py}"
      purpose: "Find pricing calculations"
    - glob: "**/utils/**/math*.{ts,java,cs,py}"
      purpose: "Find math utility functions"

  interview_questions:
    - role: "Finance Team"
      questions:
        - "What rounding rules apply to your calculations?"
        - "How should line items sum to totals?"
        - "Are there regulatory rounding requirements?"
    - role: "Lead Developer"
      questions:
        - "What rounding mode is used?"
        - "When is rounding applied - at each step or only at the end?"
        - "How are rounding differences reconciled?"

knowledge_sources:
  guides:
    - id: "rounding-modes"
      name: "Rounding Modes in Financial Computing"
      url: "https://en.wikipedia.org/wiki/Rounding#Rounding_to_the_nearest_integer"
    - id: "bankers-rounding"
      name: "Banker's Rounding"
      url: "https://en.wikipedia.org/wiki/Rounding#Round_half_to_even"

  standards:
    - id: "ieee-754"
      name: "IEEE 754 Rounding"
      relevance: "Floating-point rounding standards"

tooling:
  analysis_tools:
    - tool: "Static analysis rules"
      purpose: "Detect inconsistent rounding"
    - tool: "Test generation"
      purpose: "Generate rounding edge cases"
    - tool: "BigDecimal analysis"
      purpose: "Analyze decimal precision usage"

signals:
  critical:
    - id: "RPR-CRIT-001"
      signal: "Implicit rounding losing precision"
      evidence_indicators:
        - "Division causing implicit truncation"
        - "No explicit rounding mode specified"
        - "Platform-dependent rounding behavior"
      explanation: |
        Implicit rounding depends on platform/language defaults and can
        produce unexpected results. All rounding must be explicit with
        specified modes.
      remediation: "Make all rounding explicit; specify rounding mode"

    - id: "RPR-CRIT-002"
      signal: "Line items do not sum to displayed totals"
      evidence_indicators:
        - "Penny discrepancies in invoices"
        - "Subtotals don't add up"
        - "User-visible rounding errors"
      explanation: |
        When rounded line items don't sum to the displayed total, it creates
        confusion and distrust. Rounding strategies must ensure consistent
        summation.
      remediation: "Implement allocation strategies; distribute rounding differences"

  high:
    - id: "RPR-HIGH-001"
      signal: "Different rounding modes used inconsistently"
      evidence_indicators:
        - "Half-up in some places, banker's in others"
        - "No standard rounding mode documented"
        - "Different teams use different approaches"
      remediation: "Standardize rounding mode across system; document and enforce"

    - id: "RPR-HIGH-002"
      signal: "Rounding applied at intermediate steps"
      evidence_indicators:
        - "Each calculation step rounds separately"
        - "Precision loss compounds through calculations"
        - "Final result differs based on calculation path"
      remediation: "Maintain full precision through calculation; round only at final output"

  medium:
    - id: "RPR-MED-001"
      signal: "Currency-specific rounding not handled"
      evidence_indicators:
        - "All currencies rounded to 2 decimals"
        - "JPY/KRW with decimal cents"
        - "Currencies with 3 decimal places truncated"
      remediation: "Implement currency-aware rounding; use currency metadata"

    - id: "RPR-MED-002"
      signal: "Rounding behavior not tested"
      evidence_indicators:
        - "No tests for rounding edge cases"
        - "0.5 boundary cases not tested"
        - "Negative value rounding not tested"
      remediation: "Add comprehensive rounding tests including boundary cases"

  low:
    - id: "RPR-LOW-001"
      signal: "Rounding rules not documented"
      evidence_indicators:
        - "No documentation of rounding approach"
        - "Rounding mode only visible in code"
      remediation: "Document rounding rules in business specifications"

  positive:
    - id: "RPR-POS-001"
      signal: "Consistent rounding strategy applied throughout"
    - id: "RPR-POS-002"
      signal: "Allocation algorithm ensures line items sum correctly"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify Rounding Points"
      description: "Map all locations where rounding occurs"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Analyze Rounding Modes"
      description: "Review rounding mode usage and consistency"
      duration_estimate: "1 hour"

    - id: "3"
      name: "Test Boundary Cases"
      description: "Verify rounding at critical boundaries"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Check Summation"
      description: "Verify line items sum correctly"
      duration_estimate: "30 minutes"

    - id: "5"
      name: "Document Findings"
      description: "Compile rounding precision findings"
      duration_estimate: "30 minutes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of rounding precision issues"

    - type: "rounding_inventory"
      format: "structured"
      description: "Inventory of rounding points"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Rounding Strategy Analysis"
        - "Consistency Review"
        - "Boundary Testing Results"
        - "Recommendations"

closeout_checklist:
  - id: "rpr-001"
    item: "All rounding points identified"
    level: "REQUIRED"
    verification: "manual"
  - id: "rpr-002"
    item: "Rounding mode consistency verified"
    level: "REQUIRED"
    verification: "manual"
  - id: "rpr-003"
    item: "Summation correctness tested"
    level: "WARNING"
    verification: "automated"

governance:
  applicable_to:
    archetypes: ["fintech", "e-commerce", "accounting-systems"]

  compliance_mappings:
    - framework: "SOX"
      control: "Financial Accuracy"
      description: "Rounding consistency for financial reporting"

relationships:
  commonly_combined:
    - "business-logic-domain.calculation-logic.financial-accuracy"
    - "business-logic-domain.calculation-logic.currency-handling"
  depends_on:
    - "requirements-specification.financial-requirements"
  feeds_into:
    - "testing-quality-assurance.calculation-testing"
