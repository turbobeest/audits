# ============================================================
# AUDIT: Currency Handling
# Category: 34 - Business Logic & Domain
# Subcategory: calculation-logic
# ============================================================

audit:
  id: "business-logic-domain.calculation-logic.currency-handling"
  name: "Currency Handling Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "calculation-logic"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates multi-currency handling including currency storage, conversion,
    exchange rate application, mixed-currency operations, and presentation.
    This audit examines whether currencies are properly tracked with amounts,
    conversions are applied correctly, and currency-related edge cases are
    handled.

  why_it_matters: |
    Incorrect currency handling leads to significant financial losses,
    especially in international operations. Adding amounts in different
    currencies, applying wrong exchange rates, or displaying incorrect
    currency symbols causes customer confusion and financial errors.

  when_to_run:
    - "When adding multi-currency support"
    - "Before international expansion"
    - "After currency-related incidents"
    - "During fintech compliance audits"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Currency handling implementations"
    - type: "business_requirements"
      description: "Currency handling specifications"
    - type: "test_cases"
      description: "Multi-currency test scenarios"

  access_requirements:
    - "Read access to currency handling code"
    - "Access to exchange rate configurations"
    - "Access to currency test data"

discovery:
  file_patterns:
    - glob: "**/*Currency*.{ts,java,cs,py}"
      purpose: "Find currency handling code"
    - glob: "**/*Money*.{ts,java,cs,py}"
      purpose: "Find money handling code"
    - glob: "**/*Exchange*.{ts,java,cs,py}"
      purpose: "Find exchange rate code"
    - glob: "**/*Fx*.{ts,java,cs,py}"
      purpose: "Find forex handling code"

  interview_questions:
    - role: "Finance Team"
      questions:
        - "What currencies does the system support?"
        - "How are exchange rates sourced and updated?"
        - "How are multi-currency reports generated?"
    - role: "Lead Developer"
      questions:
        - "How is currency stored with amounts?"
        - "How are mixed-currency operations handled?"
        - "How are exchange rates applied?"

knowledge_sources:
  guides:
    - id: "money-pattern"
      name: "Money Pattern"
      url: "https://martinfowler.com/eaaCatalog/money.html"
    - id: "jsr-354"
      name: "JSR 354 Money and Currency API"
      url: "https://jcp.org/en/jsr/detail?id=354"

  standards:
    - id: "iso-4217"
      name: "ISO 4217 Currency Codes"
      relevance: "Standard currency code representation"

tooling:
  analysis_tools:
    - tool: "dinero.js"
      purpose: "JavaScript money library"
    - tool: "JSR-354"
      purpose: "Java Money API"
    - tool: "NodaMoney"
      purpose: ".NET money library"
    - tool: "money-rails"
      purpose: "Ruby money handling"

signals:
  critical:
    - id: "CHD-CRIT-001"
      signal: "Currency not stored with monetary amounts"
      evidence_indicators:
        - "Amount field without currency field"
        - "Implicit currency assumptions"
        - "Currency stored separately from amount"
      explanation: |
        Amounts without explicit currency are dangerous. Implicit currency
        assumptions break when expanding internationally and lead to
        incorrect calculations.
      remediation: "Always store currency with amount; use money value objects"

    - id: "CHD-CRIT-002"
      signal: "Operations performed on different currencies without conversion"
      evidence_indicators:
        - "Addition of amounts in different currencies"
        - "No currency matching validation"
        - "Mixed currency calculations"
      explanation: |
        Adding or comparing amounts in different currencies without proper
        conversion produces meaningless results and financial errors.
      remediation: "Validate currency match; require explicit conversion for mixed operations"

  high:
    - id: "CHD-HIGH-001"
      signal: "Exchange rates not timestamped or versioned"
      evidence_indicators:
        - "Single exchange rate without effective date"
        - "Cannot determine historical rates"
        - "Rates overwritten without history"
      remediation: "Store exchange rates with effective timestamps; maintain history"

    - id: "CHD-HIGH-002"
      signal: "Currency minor units not respected"
      evidence_indicators:
        - "JPY/KRW stored with decimal places"
        - "All currencies assumed 2 decimal places"
        - "Currency-specific formatting ignored"
      remediation: "Use currency metadata for minor units; format per ISO 4217"

  medium:
    - id: "CHD-MED-001"
      signal: "Inconsistent currency display formatting"
      evidence_indicators:
        - "Currency symbol placement varies"
        - "Decimal separator inconsistent"
        - "Currency code vs symbol inconsistent"
      remediation: "Use locale-aware formatting; standardize currency display"

    - id: "CHD-MED-002"
      signal: "Exchange rate source not validated"
      evidence_indicators:
        - "Manual rate entry without audit"
        - "Rates accepted without sanity checks"
        - "No rate staleness detection"
      remediation: "Validate exchange rates; detect stale or suspicious rates"

  low:
    - id: "CHD-LOW-001"
      signal: "Currency handling not centralized"
      evidence_indicators:
        - "Currency logic scattered across codebase"
        - "Multiple currency implementations"
      remediation: "Centralize currency handling in money module"

  positive:
    - id: "CHD-POS-001"
      signal: "Proper money value objects with currency"
    - id: "CHD-POS-002"
      signal: "Complete exchange rate history maintained"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Map Currency Handling"
      description: "Identify all currency handling code"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Review Data Models"
      description: "Verify currency is stored with amounts"
      duration_estimate: "1 hour"

    - id: "3"
      name: "Analyze Currency Operations"
      description: "Review how multi-currency operations are handled"
      duration_estimate: "1-2 hours"

    - id: "4"
      name: "Check Exchange Rates"
      description: "Verify exchange rate handling and history"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Document Findings"
      description: "Compile currency handling findings"
      duration_estimate: "30 minutes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of currency handling issues"

    - type: "currency_inventory"
      format: "structured"
      description: "Inventory of currency handling locations"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Currency Model Analysis"
        - "Operation Review"
        - "Exchange Rate Assessment"
        - "Recommendations"

closeout_checklist:
  - id: "chd-001"
    item: "All currency handling locations identified"
    level: "REQUIRED"
    verification: "manual"
  - id: "chd-002"
    item: "Currency-amount pairing verified"
    level: "REQUIRED"
    verification: "automated"
  - id: "chd-003"
    item: "Exchange rate handling reviewed"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["fintech", "e-commerce", "banking", "international-business"]

  compliance_mappings:
    - framework: "PCI-DSS"
      control: "Transaction Processing"
      description: "Multi-currency payment handling"
    - framework: "SOX"
      control: "Financial Reporting"
      description: "Currency conversion accuracy"

relationships:
  commonly_combined:
    - "business-logic-domain.calculation-logic.financial-accuracy"
    - "business-logic-domain.calculation-logic.rounding-precision"
  depends_on:
    - "data-management.data-modeling"
  feeds_into:
    - "internationalization.multi-currency"
