audit:
  id: business-logic-domain.calculation-logic.discount-promotion-logic
  name: Discount Promotion Logic Audit
  version: 1.0.0
  last_updated: '2025-01-22'
  status: active
  category: business-logic-domain
  category_number: 34
  subcategory: calculation-logic
  tier: expert
  estimated_duration: 4-6 hours  # median: 5h
  completeness: requires_discovery
  requires_runtime: true
  destructive: false
execution:
  automatable: partial
  severity: high
  scope: business-logic
  default_profiles:
  - full
  - quick
  blocks_phase: false
  parallelizable: true
description:
  what: |
    Evaluates discount and promotion calculation logic including percentage
    discounts, fixed discounts, tiered pricing, buy-one-get-one offers, and
    promotional campaigns. This audit examines discount stacking rules,
    application order, eligibility validation, and abuse prevention.
  why_it_matters: |
    Incorrect discount logic directly impacts revenue and margin. Stacking
    discounts incorrectly can lead to excessive discounts or products being
    sold at a loss. Conversely, failing to apply valid discounts frustrates
    customers. Promotion logic must be both accurate and abuse-resistant.
  when_to_run:
  - When implementing promotion systems
  - Before major promotional campaigns
  - After revenue anomalies
  - When simplifying discount complexity
prerequisites:
  required_artifacts:
  - type: source_code
    description: Discount calculation implementations
  - type: promotion_rules
    description: Promotion and discount specifications
  - type: test_cases
    description: Discount calculation test scenarios
  access_requirements:
  - Read access to pricing/discount code
  - Access to promotion configurations
  - Access to order data
discovery:
  file_patterns:
  - glob: '**/*Discount*.{ts,java,cs,py}'
    purpose: Find discount calculation code
  - glob: '**/*Promotion*.{ts,java,cs,py}'
    purpose: Find promotion logic
  - glob: '**/*Coupon*.{ts,java,cs,py}'
    purpose: Find coupon handling code
  - glob: '**/pricing/**/*.{ts,java,cs,py}'
    purpose: Find pricing calculations
  interview_questions:
  - role: Product/Marketing
    questions:
    - What types of discounts and promotions do you run?
    - How should multiple discounts stack?
    - What abuse patterns have you seen?
  - role: Lead Developer
    questions:
    - How is discount application order determined?
    - How are eligibility rules enforced?
    - Are there discount caps or limits?
knowledge_sources:
  guides:
  - id: promotion-engine-design
    name: Promotion Engine Design
    url: https://martinfowler.com/articles/discountEngine.html
  - id: pricing-strategies
    name: Dynamic Pricing Strategies
    url: https://www.shopify.com/blog/pricing-strategies
  standards:
  - id: price-accuracy
    name: Price Accuracy Requirements
    relevance: Retail pricing regulations
tooling:
  analysis_tools:
  - tool: Promotion rules engine
    purpose: Validate promotion configurations
  - tool: Order simulation
    purpose: Test discount scenarios
  - tool: Fraud detection
    purpose: Identify promotion abuse
signals:
  critical:
  - id: DPL-CRIT-001
    signal: Discount stacking allows excessive discounts
    evidence_indicators:
    - Multiple discounts reduce price below cost
    - Unlimited discount stacking
    - Orders with >100% discount possible
    explanation: |
      Excessive discount stacking causes direct financial loss. Bad actors
      can exploit stacking to get products for free or at significant loss.
    remediation: Implement discount caps; define stacking rules; add floor price
  - id: DPL-CRIT-002
    signal: Discount eligibility not validated
    evidence_indicators:
    - Expired coupons accepted
    - Usage limits not enforced
    - Ineligible items receive discounts
    explanation: |
      Without proper eligibility validation, discounts are applied
      inappropriately, causing revenue loss and promotion abuse.
    remediation: Implement strict eligibility validation; check at application time
  high:
  - id: DPL-HIGH-001
    signal: Discount application order produces wrong results
    evidence_indicators:
    - Different results for same discounts in different order
    - No defined application order
    - Percentage before/after fixed discount matters
    remediation: Define and enforce discount application order
  - id: DPL-HIGH-002
    signal: Promotion abuse not detected
    evidence_indicators:
    - Same coupon used repeatedly
    - Fake accounts to get new-user discounts
    - Split orders to maximize promotions
    remediation: Implement abuse detection; track promotion usage patterns
  medium:
  - id: DPL-MED-001
    signal: Promotion rules scattered across codebase
    evidence_indicators:
    - Rules hardcoded in multiple places
    - Inconsistent rule application
    - Difficult to add new promotions
    remediation: Centralize promotion rules; use rules engine
  - id: DPL-MED-002
    signal: No audit trail for applied discounts
    evidence_indicators:
    - Cannot determine which discounts applied
    - Discount reasons not stored
    - Cannot analyze promotion effectiveness
    remediation: Log all applied discounts with details
  low:
  - id: DPL-LOW-001
    signal: Promotion naming/codes inconsistent
    evidence_indicators:
    - No naming convention
    - Confusing promotion codes
    remediation: Establish naming conventions; make codes meaningful
  positive:
  - id: DPL-POS-001
    signal: Comprehensive discount rules engine with clear precedence
  - id: DPL-POS-002
    signal: Proactive abuse prevention and detection
procedure:
  context:
    cognitive_mode: analytical
    ensemble_role: auditor
  steps:
  - id: '1'
    name: Inventory Discount Types
    description: Map all discount and promotion types
    duration_estimate: 1 hour
  - id: '2'
    name: Review Application Logic
    description: Analyze how discounts are calculated and applied
    duration_estimate: 1-2 hours
  - id: '3'
    name: Test Stacking Scenarios
    description: Test discount combinations
    duration_estimate: 1 hour
  - id: '4'
    name: Verify Eligibility Checks
    description: Test eligibility validation
    duration_estimate: 1 hour
  - id: '5'
    name: Document Findings
    description: Compile discount logic findings
    duration_estimate: 30 minutes
output:
  deliverables:
  - type: finding_list
    format: structured
    description: List of discount logic issues
  - type: discount_matrix
    format: structured
    description: Matrix of discount types and rules
  - type: summary
    format: prose
    sections:
    - Executive Summary
    - Discount Inventory
    - Stacking Analysis
    - Eligibility Review
    - Recommendations
closeout_checklist:
- id: dpl-001
  item: All discount types documented
  level: REQUIRED
  verification: manual
- id: dpl-002
  item: Stacking rules verified
  level: REQUIRED
  verification: automated
- id: dpl-003
  item: Abuse scenarios tested
  level: WARNING
  verification: manual
governance:
  applicable_to:
    archetypes:
    - e-commerce
    - retail
    - saas
    - subscription
  compliance_mappings:
  - framework: Consumer Protection
    control: Price Accuracy
    description: Accurate discount display
relationships:
  commonly_combined:
  - business-logic-domain.calculation-logic.financial-accuracy
  - security.business-logic-security
  depends_on:
  - requirements-specification.pricing-requirements
  feeds_into:
  - revenue-assurance.pricing-accuracy
