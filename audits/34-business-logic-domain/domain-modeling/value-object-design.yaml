# ============================================================
# AUDIT: Value Object Design
# Category: 34 - Business Logic & Domain
# Subcategory: domain-modeling
# ============================================================

audit:
  id: "business-logic-domain.domain-modeling.value-object-design"
  name: "Value Object Design Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "domain-modeling"

  tier: "expert"
  estimated_duration: "3-5 hours"  # median: 4h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the design and implementation of value objects in the domain model.
    This audit examines whether value objects are properly immutable, implement
    value equality correctly, encapsulate related attributes appropriately, and
    contain domain-specific validation and behavior. It identifies primitive
    obsession and opportunities to introduce meaningful value objects.

  why_it_matters: |
    Well-designed value objects encapsulate domain concepts, making code more
    expressive and self-documenting. They prevent invalid states through
    construction validation and reduce bugs through immutability. Missing value
    objects lead to primitive obsession, duplicated validation, and scattered
    business logic.

  when_to_run:
    - "During domain model design reviews"
    - "When refactoring to improve domain expressiveness"
    - "After identifying primitive obsession patterns"
    - "Before implementing complex business logic"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Domain model implementations"
    - type: "business_requirements"
      description: "Domain concept definitions"

  access_requirements:
    - "Read access to domain layer source code"
    - "Access to domain model documentation"

discovery:
  file_patterns:
    - glob: "**/domain/**/valueobjects/**/*.{ts,java,cs,py}"
      purpose: "Find value object implementations"
    - glob: "**/valueObjects/**/*.{ts,java,cs,py}"
      purpose: "Find value objects by convention"
    - glob: "**/*VO.{ts,java,cs,py}"
      purpose: "Find value objects by suffix"
    - glob: "**/domain/**/*.{ts,java,cs,py}"
      purpose: "Find domain layer code to identify primitive obsession"

  interview_questions:
    - role: "Domain Expert"
      questions:
        - "What domain concepts have specific rules or formats?"
        - "Which values have specific validation requirements?"
        - "What measurements or quantities are used in the domain?"
    - role: "Lead Developer"
      questions:
        - "How are domain concepts like money, addresses, or dates handled?"
        - "Where is validation for primitive values performed?"
        - "Are there any known issues with value handling?"

knowledge_sources:
  guides:
    - id: "ddd-reference"
      name: "Domain-Driven Design Reference"
      url: "https://www.domainlanguage.com/ddd/reference/"
    - id: "value-objects-patterns"
      name: "Value Objects Implementation Patterns"
      url: "https://martinfowler.com/bliki/ValueObject.html"

  standards:
    - id: "ddd-tactical-patterns"
      name: "DDD Tactical Patterns"
      relevance: "Value object design principles"

tooling:
  analysis_tools:
    - tool: "SonarQube"
      purpose: "Detect primitive obsession code smells"
    - tool: "NDepend"
      purpose: "Analyze value object usage patterns"
    - tool: "ArchUnit"
      purpose: "Enforce value object immutability rules"
    - tool: "ErrorProne"
      purpose: "Detect mutable value objects in Java"

signals:
  critical:
    - id: "VOD-CRIT-001"
      signal: "Value objects are mutable allowing state corruption"
      evidence_indicators:
        - "Setter methods on value object classes"
        - "Mutable fields in value objects"
        - "Value objects modified after construction"
      explanation: |
        Mutable value objects can lead to unexpected state changes and bugs that
        are extremely difficult to track down. Value objects must be immutable
        by design to be used safely.
      remediation: "Make all value object fields final/readonly and remove setters"

    - id: "VOD-CRIT-002"
      signal: "Value object equality based on identity instead of value"
      evidence_indicators:
        - "Missing equals/hashCode implementations"
        - "Reference equality used for value comparisons"
        - "Incorrect behavior in collections and comparisons"
      explanation: |
        Value objects must be compared by their component values, not by reference.
        Without proper equality implementation, value objects behave incorrectly
        in collections, caches, and business logic comparisons.
      remediation: "Implement equals and hashCode based on all component values"

  high:
    - id: "VOD-HIGH-001"
      signal: "Primitive obsession - domain concepts represented as primitives"
      evidence_indicators:
        - "Money represented as decimal/double"
        - "Email addresses as plain strings"
        - "Phone numbers as strings without validation"
        - "Duplicated validation across codebase"
      remediation: "Introduce value objects for domain concepts with specific rules"

    - id: "VOD-HIGH-002"
      signal: "Value object validation only at boundaries, not at construction"
      evidence_indicators:
        - "Invalid value objects can be constructed"
        - "Validation performed by callers, not the value object"
        - "Null or invalid state possible in value objects"
      remediation: "Move validation into value object constructor; throw on invalid input"

  medium:
    - id: "VOD-MED-001"
      signal: "Value objects missing domain behavior"
      evidence_indicators:
        - "Value objects are pure data containers"
        - "Domain operations on values performed externally"
        - "Missing comparison, formatting, or calculation methods"
      remediation: "Add domain-specific behavior to value objects (e.g., Money.add())"

    - id: "VOD-MED-002"
      signal: "Related attributes not grouped into value objects"
      evidence_indicators:
        - "Multiple related fields passed together repeatedly"
        - "Address components as separate fields"
        - "Date ranges as separate start/end fields"
      remediation: "Group related attributes into cohesive value objects"

  low:
    - id: "VOD-LOW-001"
      signal: "Value objects not using domain terminology"
      evidence_indicators:
        - "Generic names like 'Amount' instead of domain-specific names"
        - "Technical naming conventions instead of ubiquitous language"
      remediation: "Rename value objects to reflect domain terminology"

  positive:
    - id: "VOD-POS-001"
      signal: "Value objects are immutable and enforce valid construction"
    - id: "VOD-POS-002"
      signal: "Rich value objects with appropriate domain behavior"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Value Objects"
      description: "Identify all existing value objects in the domain model"
      duration_estimate: "30 minutes"

    - id: "2"
      name: "Check Immutability"
      description: "Verify all value objects are properly immutable"
      duration_estimate: "1 hour"
      tools:
        - name: "ArchUnit"
          action: "Run immutability validation rules"

    - id: "3"
      name: "Validate Equality Implementation"
      description: "Check equals/hashCode implementations on all value objects"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Identify Primitive Obsession"
      description: "Find domain concepts represented as primitives"
      duration_estimate: "1 hour"
      tools:
        - name: "SonarQube"
          action: "Run primitive obsession detection rules"

    - id: "5"
      name: "Document Findings"
      description: "Compile value object design findings and recommendations"
      duration_estimate: "30 minutes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of value object design issues"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Value Object Inventory"
        - "Immutability Analysis"
        - "Primitive Obsession Findings"
        - "Recommendations"

closeout_checklist:
  - id: "vod-001"
    item: "All value objects verified as immutable"
    level: "REQUIRED"
    verification: "automated"
  - id: "vod-002"
    item: "Equality implementations reviewed"
    level: "REQUIRED"
    verification: "manual"
  - id: "vod-003"
    item: "Primitive obsession opportunities documented"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["enterprise-applications", "fintech", "e-commerce"]

  compliance_mappings:
    - framework: "Clean Code"
      control: "Object Design"
      description: "Value object design best practices"

relationships:
  commonly_combined:
    - "business-logic-domain.domain-modeling.aggregate-boundary-analysis"
    - "code-quality.code-review"
  depends_on:
    - "requirements-specification.business-requirements"
  feeds_into:
    - "code-quality.maintainability"
