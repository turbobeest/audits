# ============================================================
# AUDIT: Aggregate Boundary Analysis
# Category: 34 - Business Logic & Domain
# Subcategory: domain-modeling
# ============================================================

audit:
  id: "business-logic-domain.domain-modeling.aggregate-boundary-analysis"
  name: "Aggregate Boundary Analysis Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "domain-modeling"

  tier: "expert"
  estimated_duration: "4-8 hours"  # median: 6h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Examines the definition and enforcement of aggregate boundaries in domain-driven
    design implementations. This audit verifies that aggregates are properly sized,
    maintain transactional consistency, and enforce invariants correctly. It analyzes
    whether aggregate roots properly control access to child entities and whether
    aggregate boundaries align with business transaction requirements.

  why_it_matters: |
    Poorly defined aggregate boundaries lead to data inconsistency, performance
    problems, and complex transaction management. Oversized aggregates cause
    contention and scalability issues, while undersized aggregates fail to
    maintain business invariants. Correct aggregate design is fundamental to
    building maintainable and scalable domain models.

  when_to_run:
    - "During initial domain model design reviews"
    - "When experiencing consistency or performance issues"
    - "After significant domain model changes"
    - "Before major scaling initiatives"

prerequisites:
  required_artifacts:
    - type: "domain_model"
      description: "Domain model documentation or diagrams"
    - type: "source_code"
      description: "Aggregate and entity implementations"
    - type: "business_requirements"
      description: "Business invariant specifications"

  access_requirements:
    - "Read access to domain layer source code"
    - "Access to domain model documentation"
    - "Access to transaction logs for analysis"

discovery:
  file_patterns:
    - glob: "**/domain/**/aggregates/**/*.{ts,java,cs,py}"
      purpose: "Find aggregate root implementations"
    - glob: "**/domain/**/entities/**/*.{ts,java,cs,py}"
      purpose: "Find entity implementations"
    - glob: "**/domain/**/valueobjects/**/*.{ts,java,cs,py}"
      purpose: "Find value object implementations"
    - glob: "**/*Aggregate*.{ts,java,cs,py}"
      purpose: "Find aggregate classes by naming convention"
    - glob: "**/*Root*.{ts,java,cs,py}"
      purpose: "Find aggregate root classes"

  interview_questions:
    - role: "Domain Expert"
      questions:
        - "What are the main business transactions and their consistency requirements?"
        - "Which data must always be consistent together?"
        - "What are the key business invariants that must never be violated?"
    - role: "Lead Developer"
      questions:
        - "How are aggregate boundaries currently defined?"
        - "Are there any known issues with data consistency?"
        - "How do you handle cross-aggregate operations?"

knowledge_sources:
  guides:
    - id: "ddd-reference"
      name: "Domain-Driven Design Reference"
      url: "https://www.domainlanguage.com/ddd/reference/"
    - id: "effective-aggregate-design"
      name: "Effective Aggregate Design"
      url: "https://www.dddcommunity.org/library/vernon_2011/"

  standards:
    - id: "ddd-tactical-patterns"
      name: "DDD Tactical Patterns"
      relevance: "Aggregate design principles and best practices"

tooling:
  analysis_tools:
    - tool: "ArchUnit"
      purpose: "Enforce aggregate boundary rules in Java"
    - tool: "NDepend"
      purpose: "Analyze dependency graphs and coupling"
    - tool: "Context Mapper"
      purpose: "Domain model visualization and validation"
    - tool: "Event Storming Miro Templates"
      purpose: "Collaborative aggregate discovery"

signals:
  critical:
    - id: "ABA-CRIT-001"
      signal: "Aggregate allows direct modification of child entities bypassing root"
      evidence_indicators:
        - "Public setters on child entities"
        - "Direct repository access to non-root entities"
        - "Missing encapsulation of aggregate internals"
      explanation: |
        When child entities can be modified without going through the aggregate
        root, business invariants cannot be enforced. This leads to data
        corruption and inconsistent state across the domain.
      remediation: "Ensure all modifications go through aggregate root methods that enforce invariants"

    - id: "ABA-CRIT-002"
      signal: "Cross-aggregate transactions without eventual consistency handling"
      evidence_indicators:
        - "Multiple aggregates modified in single transaction"
        - "No saga or process manager for cross-aggregate operations"
        - "Missing compensation logic for failures"
      explanation: |
        Modifying multiple aggregates in a single transaction violates aggregate
        boundaries and creates tight coupling, making the system brittle and
        difficult to scale.
      remediation: "Implement eventual consistency patterns like sagas or process managers"

  high:
    - id: "ABA-HIGH-001"
      signal: "Aggregate contains too many entities causing performance issues"
      evidence_indicators:
        - "Aggregate loads hundreds of child entities"
        - "Long transaction times for aggregate operations"
        - "High memory consumption during aggregate loading"
      remediation: "Split large aggregates along natural boundaries; consider separate aggregates with eventual consistency"

    - id: "ABA-HIGH-002"
      signal: "Aggregate root does not enforce all required invariants"
      evidence_indicators:
        - "Business rules documented but not implemented in aggregate"
        - "Invariant violations found in production data"
        - "Missing validation in aggregate methods"
      remediation: "Implement all documented business invariants as guard clauses in aggregate methods"

  medium:
    - id: "ABA-MED-001"
      signal: "Aggregate boundary unclear or inconsistent"
      evidence_indicators:
        - "Different team members have different understanding of aggregate scope"
        - "Inconsistent entity groupings across similar use cases"
        - "Missing documentation of aggregate boundaries"
      remediation: "Document aggregate boundaries explicitly; use event storming to clarify boundaries"

    - id: "ABA-MED-002"
      signal: "Value objects used where entities should be"
      evidence_indicators:
        - "Objects with identity treated as value objects"
        - "Missing lifecycle management for important domain concepts"
      remediation: "Review object classifications and convert to entities where identity is meaningful"

  low:
    - id: "ABA-LOW-001"
      signal: "Aggregate naming does not reflect ubiquitous language"
      evidence_indicators:
        - "Technical names instead of business terms"
        - "Names not used by domain experts"
      remediation: "Rename aggregates to match ubiquitous language from domain experts"

  positive:
    - id: "ABA-POS-001"
      signal: "Aggregate boundaries align well with transactional consistency requirements"
    - id: "ABA-POS-002"
      signal: "All aggregate invariants are explicitly documented and enforced"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Map Aggregate Boundaries"
      description: "Identify all aggregates and their constituent entities and value objects"
      duration_estimate: "1-2 hours"
      tools:
        - name: "Context Mapper"
          action: "Generate domain model visualization"
        - name: "ArchUnit"
          action: "Run aggregate boundary tests"

    - id: "2"
      name: "Analyze Invariant Enforcement"
      description: "Verify that all business invariants are enforced by aggregate roots"
      duration_estimate: "1-2 hours"

    - id: "3"
      name: "Review Transaction Boundaries"
      description: "Analyze transaction scope to ensure single aggregate per transaction"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Evaluate Aggregate Size"
      description: "Assess aggregate size for performance and scalability implications"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Document Findings"
      description: "Compile findings and recommendations for aggregate boundary improvements"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of aggregate boundary violations and concerns"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Aggregate Inventory"
        - "Boundary Analysis Results"
        - "Invariant Coverage"
        - "Recommendations"

closeout_checklist:
  - id: "aba-001"
    item: "All aggregates identified and documented"
    level: "REQUIRED"
    verification: "manual"
  - id: "aba-002"
    item: "Aggregate invariants mapped to code implementations"
    level: "REQUIRED"
    verification: "manual"
  - id: "aba-003"
    item: "Cross-aggregate operations reviewed for consistency"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["enterprise-applications", "fintech", "e-commerce", "healthcare"]

  compliance_mappings:
    - framework: "SOX"
      control: "ITGCs"
      description: "Data integrity controls through proper aggregate design"

relationships:
  commonly_combined:
    - "business-logic-domain.domain-modeling.entity-relationship-validation"
    - "business-logic-domain.business-rules.rule-completeness"
  depends_on:
    - "requirements-specification.business-requirements"
  feeds_into:
    - "architecture-design.domain-layer-architecture"
