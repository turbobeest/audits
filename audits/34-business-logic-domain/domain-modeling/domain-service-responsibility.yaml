# ============================================================
# AUDIT: Domain Service Responsibility
# Category: 34 - Business Logic & Domain
# Subcategory: domain-modeling
# ============================================================

audit:
  id: "business-logic-domain.domain-modeling.domain-service-responsibility"
  name: "Domain Service Responsibility Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "domain-modeling"

  tier: "expert"
  estimated_duration: "3-6 hours"  # median: 4h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the appropriate use of domain services in the domain model. This
    audit examines whether domain services encapsulate operations that naturally
    do not belong to any entity or value object, are stateless, express domain
    concepts in the ubiquitous language, and maintain proper separation from
    application and infrastructure services.

  why_it_matters: |
    Misuse of domain services leads to anemic domain models where entities become
    mere data containers. Overuse creates procedural code disguised as OOP, while
    underuse forces unnatural behavior onto entities. Proper domain service design
    keeps the domain model clean and expressive.

  when_to_run:
    - "During domain model design reviews"
    - "When identifying anemic domain model patterns"
    - "After major feature implementations"
    - "When refactoring service layers"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Domain service implementations"
    - type: "source_code"
      description: "Entity and aggregate implementations"
    - type: "business_requirements"
      description: "Business operation definitions"

  access_requirements:
    - "Read access to domain layer source code"
    - "Access to service layer code"
    - "Access to domain model documentation"

discovery:
  file_patterns:
    - glob: "**/domain/**/services/**/*.{ts,java,cs,py}"
      purpose: "Find domain service implementations"
    - glob: "**/*DomainService*.{ts,java,cs,py}"
      purpose: "Find domain services by naming convention"
    - glob: "**/services/**/*Service*.{ts,java,cs,py}"
      purpose: "Find service implementations"
    - glob: "**/domain/**/*.{ts,java,cs,py}"
      purpose: "Find domain layer code"

  interview_questions:
    - role: "Domain Expert"
      questions:
        - "What business operations span multiple entities?"
        - "What calculations or processes are core to the business?"
        - "Are there operations that do not naturally belong to any single entity?"
    - role: "Lead Developer"
      questions:
        - "How do you decide between entity methods and domain services?"
        - "Are there services that maintain state between calls?"
        - "How are domain services distinguished from application services?"

knowledge_sources:
  guides:
    - id: "ddd-reference"
      name: "Domain-Driven Design Reference"
      url: "https://www.domainlanguage.com/ddd/reference/"
    - id: "domain-services-patterns"
      name: "Domain Services Patterns"
      url: "https://martinfowler.com/bliki/EvansClassification.html"

  standards:
    - id: "ddd-tactical-patterns"
      name: "DDD Tactical Patterns"
      relevance: "Domain service design principles"

tooling:
  analysis_tools:
    - tool: "SonarQube"
      purpose: "Detect service layer code smells"
    - tool: "NDepend"
      purpose: "Analyze service dependencies"
    - tool: "ArchUnit"
      purpose: "Enforce service layer architecture rules"

signals:
  critical:
    - id: "DSR-CRIT-001"
      signal: "Domain services contain infrastructure concerns"
      evidence_indicators:
        - "Database access code in domain services"
        - "HTTP calls or external API access"
        - "File system or messaging operations"
      explanation: |
        Domain services should contain only domain logic. Infrastructure concerns
        in domain services create tight coupling and make the domain model
        dependent on specific technologies.
      remediation: "Extract infrastructure concerns to infrastructure services or repositories"

    - id: "DSR-CRIT-002"
      signal: "Stateful domain services causing concurrency issues"
      evidence_indicators:
        - "Instance fields storing state between calls"
        - "Race conditions in service operations"
        - "Inconsistent behavior based on call order"
      explanation: |
        Domain services must be stateless. Stateful services cause hard-to-debug
        concurrency issues and make the system unpredictable.
      remediation: "Remove state from domain services; pass all required data as parameters"

  high:
    - id: "DSR-HIGH-001"
      signal: "Anemic domain model with business logic in services"
      evidence_indicators:
        - "Entities with only getters and setters"
        - "Services performing operations that belong on entities"
        - "Domain logic duplicated across services"
      remediation: "Move behavior to entities where it naturally belongs; use services only for cross-entity operations"

    - id: "DSR-HIGH-002"
      signal: "Domain services mixed with application services"
      evidence_indicators:
        - "Same service layer handling domain logic and orchestration"
        - "No clear separation between domain and application concerns"
        - "Transaction management mixed with business rules"
      remediation: "Separate domain services from application services; domain services should be pure domain logic"

  medium:
    - id: "DSR-MED-001"
      signal: "Domain services not using ubiquitous language"
      evidence_indicators:
        - "Technical method names instead of business terms"
        - "Service names not recognized by domain experts"
        - "Operation names do not match business processes"
      remediation: "Rename services and methods to reflect ubiquitous language"

    - id: "DSR-MED-002"
      signal: "Over-engineered services for simple operations"
      evidence_indicators:
        - "Services created for operations that belong on entities"
        - "Unnecessary abstraction layers"
        - "Single-method services that could be entity methods"
      remediation: "Consolidate or move simple operations to appropriate entities"

  low:
    - id: "DSR-LOW-001"
      signal: "Missing documentation for domain service responsibilities"
      evidence_indicators:
        - "No explanation of why service exists vs entity method"
        - "Unclear when to use each service"
      remediation: "Document the purpose and responsibility of each domain service"

  positive:
    - id: "DSR-POS-001"
      signal: "Domain services properly encapsulate cross-entity operations"
    - id: "DSR-POS-002"
      signal: "Clear separation between domain and application services"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Domain Services"
      description: "Identify all domain services and their responsibilities"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Analyze Service Responsibilities"
      description: "Verify services handle appropriate domain operations"
      duration_estimate: "1-2 hours"

    - id: "3"
      name: "Check Statelessness"
      description: "Verify all domain services are stateless"
      duration_estimate: "1 hour"
      tools:
        - name: "ArchUnit"
          action: "Run statelessness validation rules"

    - id: "4"
      name: "Review Layer Separation"
      description: "Ensure proper separation from application and infrastructure"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Document Findings"
      description: "Compile domain service responsibility findings"
      duration_estimate: "30 minutes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of domain service responsibility issues"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Service Inventory"
        - "Responsibility Analysis"
        - "Layer Separation Review"
        - "Recommendations"

closeout_checklist:
  - id: "dsr-001"
    item: "All domain services identified and documented"
    level: "REQUIRED"
    verification: "manual"
  - id: "dsr-002"
    item: "Service statelessness verified"
    level: "REQUIRED"
    verification: "automated"
  - id: "dsr-003"
    item: "Layer separation reviewed"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["enterprise-applications", "fintech", "e-commerce"]

  compliance_mappings:
    - framework: "Clean Architecture"
      control: "Domain Layer"
      description: "Domain service design principles"

relationships:
  commonly_combined:
    - "business-logic-domain.domain-modeling.aggregate-boundary-analysis"
    - "architecture-design.layer-separation"
  depends_on:
    - "requirements-specification.business-requirements"
  feeds_into:
    - "architecture-design.domain-layer-architecture"
