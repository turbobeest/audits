# ============================================================
# AUDIT: Repository Pattern Adherence
# Category: 34 - Business Logic & Domain
# Subcategory: domain-modeling
# ============================================================

audit:
  id: "business-logic-domain.domain-modeling.repository-pattern-adherence"
  name: "Repository Pattern Adherence Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "domain-modeling"

  tier: "expert"
  estimated_duration: "3-5 hours"  # median: 4h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "medium"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the implementation and usage of the repository pattern in the domain
    model. This audit examines whether repositories properly abstract persistence
    concerns, expose collection-like interfaces for aggregates only, and maintain
    the illusion of in-memory collections. It verifies that repositories do not
    leak persistence implementation details into the domain layer.

  why_it_matters: |
    Properly implemented repositories keep the domain model persistence-agnostic
    and testable. When repositories leak implementation details or expose non-
    aggregate entities, the domain becomes coupled to infrastructure and harder
    to maintain. Clean repository design enables technology migration and
    simplifies testing.

  when_to_run:
    - "During domain model design reviews"
    - "When experiencing persistence-related issues"
    - "Before major persistence layer changes"
    - "When evaluating testability improvements"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Repository implementations"
    - type: "source_code"
      description: "Aggregate and entity implementations"
    - type: "architecture_docs"
      description: "Persistence layer architecture documentation"

  access_requirements:
    - "Read access to domain layer source code"
    - "Access to repository implementations"
    - "Access to persistence configuration"

discovery:
  file_patterns:
    - glob: "**/repositories/**/*.{ts,java,cs,py}"
      purpose: "Find repository implementations"
    - glob: "**/*Repository*.{ts,java,cs,py}"
      purpose: "Find repositories by naming convention"
    - glob: "**/infrastructure/**/persistence/**/*.{ts,java,cs,py}"
      purpose: "Find persistence layer code"
    - glob: "**/domain/**/*.{ts,java,cs,py}"
      purpose: "Find domain layer for repository interfaces"

  interview_questions:
    - role: "Lead Developer"
      questions:
        - "How are repositories organized in the codebase?"
        - "Are there repositories for non-aggregate entities?"
        - "How do you handle complex queries that span aggregates?"
    - role: "Database Administrator"
      questions:
        - "Are there performance issues with repository queries?"
        - "How are complex joins handled?"

knowledge_sources:
  guides:
    - id: "ddd-reference"
      name: "Domain-Driven Design Reference"
      url: "https://www.domainlanguage.com/ddd/reference/"
    - id: "repository-pattern"
      name: "Repository Pattern"
      url: "https://martinfowler.com/eaaCatalog/repository.html"

  standards:
    - id: "ddd-tactical-patterns"
      name: "DDD Tactical Patterns"
      relevance: "Repository pattern principles"

tooling:
  analysis_tools:
    - tool: "ArchUnit"
      purpose: "Enforce repository architecture rules"
    - tool: "NDepend"
      purpose: "Analyze repository dependencies"
    - tool: "SonarQube"
      purpose: "Detect repository anti-patterns"

signals:
  critical:
    - id: "RPA-CRIT-001"
      signal: "Repositories expose persistence implementation details to domain"
      evidence_indicators:
        - "SQL or ORM-specific types in repository interfaces"
        - "Database connection handling exposed in interfaces"
        - "Query builders returned from repository methods"
      explanation: |
        When repository interfaces expose persistence details, the domain layer
        becomes coupled to specific technologies. This makes the domain untestable
        without the database and prevents technology migration.
      remediation: "Define repository interfaces in domain layer with domain types only"

    - id: "RPA-CRIT-002"
      signal: "Repositories created for non-aggregate entities"
      evidence_indicators:
        - "Repositories for value objects"
        - "Repositories for child entities within aggregates"
        - "Direct persistence of non-root entities"
      explanation: |
        Only aggregate roots should have repositories. Repositories for child
        entities bypass the aggregate root's control and can break invariants.
      remediation: "Remove non-aggregate repositories; access children through aggregate roots"

  high:
    - id: "RPA-HIGH-001"
      signal: "Repository methods do not follow collection semantics"
      evidence_indicators:
        - "Methods named 'insert' or 'update' instead of 'add' or 'save'"
        - "Repository methods that expose persistence operations directly"
        - "Non-domain terminology in repository methods"
      remediation: "Rename repository methods to follow collection-like semantics"

    - id: "RPA-HIGH-002"
      signal: "Repository implementations in domain layer"
      evidence_indicators:
        - "Concrete repository classes in domain packages"
        - "Database access code in domain layer"
        - "ORM configurations in domain layer"
      remediation: "Move repository implementations to infrastructure layer; keep only interfaces in domain"

  medium:
    - id: "RPA-MED-001"
      signal: "Generic repository anti-pattern"
      evidence_indicators:
        - "Single generic repository for all aggregates"
        - "Generic CRUD methods without domain-specific operations"
        - "Missing aggregate-specific query methods"
      remediation: "Create aggregate-specific repositories with domain-meaningful methods"

    - id: "RPA-MED-002"
      signal: "Repositories performing business logic"
      evidence_indicators:
        - "Validation logic in repositories"
        - "Business rules applied during persistence"
        - "Domain calculations in repository methods"
      remediation: "Move business logic to domain layer; repositories should only handle persistence"

  low:
    - id: "RPA-LOW-001"
      signal: "Inconsistent repository naming conventions"
      evidence_indicators:
        - "Mixed naming patterns across repositories"
        - "Repository names not matching aggregate names"
      remediation: "Standardize repository naming to match aggregate names"

  positive:
    - id: "RPA-POS-001"
      signal: "Clean separation between repository interface and implementation"
    - id: "RPA-POS-002"
      signal: "Repository methods express domain concepts"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Repositories"
      description: "Identify all repositories and their associated aggregates"
      duration_estimate: "30 minutes"

    - id: "2"
      name: "Analyze Interface Definitions"
      description: "Review repository interfaces for domain purity"
      duration_estimate: "1 hour"
      tools:
        - name: "ArchUnit"
          action: "Validate repository interface rules"

    - id: "3"
      name: "Check Aggregate Alignment"
      description: "Verify repositories exist only for aggregate roots"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Review Layer Separation"
      description: "Ensure implementations are in infrastructure layer"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Document Findings"
      description: "Compile repository pattern adherence findings"
      duration_estimate: "30 minutes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of repository pattern violations"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Repository Inventory"
        - "Pattern Adherence Analysis"
        - "Layer Separation Review"
        - "Recommendations"

closeout_checklist:
  - id: "rpa-001"
    item: "All repositories identified and mapped to aggregates"
    level: "REQUIRED"
    verification: "manual"
  - id: "rpa-002"
    item: "Interface purity verified"
    level: "REQUIRED"
    verification: "automated"
  - id: "rpa-003"
    item: "Layer separation confirmed"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["enterprise-applications", "fintech", "e-commerce"]

  compliance_mappings:
    - framework: "Clean Architecture"
      control: "Infrastructure Layer"
      description: "Repository pattern implementation"

relationships:
  commonly_combined:
    - "business-logic-domain.domain-modeling.aggregate-boundary-analysis"
    - "architecture-design.layer-separation"
  depends_on:
    - "architecture-design.persistence-strategy"
  feeds_into:
    - "testing-quality-assurance.testability"
