# ============================================================
# AUDIT: Entity Relationship Validation
# Category: 34 - Business Logic & Domain
# Subcategory: domain-modeling
# ============================================================

audit:
  id: "business-logic-domain.domain-modeling.entity-relationship-validation"
  name: "Entity Relationship Validation Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "domain-modeling"

  tier: "expert"
  estimated_duration: "3-6 hours"  # median: 4h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Validates the correctness and completeness of entity relationships within the
    domain model. This audit examines cardinality constraints, referential integrity,
    bidirectional relationship consistency, and whether relationships accurately
    reflect business requirements. It ensures that entity associations support
    required business operations without introducing unnecessary coupling.

  why_it_matters: |
    Incorrect entity relationships lead to data integrity issues, broken business
    processes, and maintenance nightmares. Missing relationships force workarounds,
    while incorrect cardinality causes data loss or orphaned records. Proper
    relationship modeling is essential for a functioning domain model.

  when_to_run:
    - "During domain model design reviews"
    - "When data integrity issues are discovered"
    - "After adding new entities or relationships"
    - "Before major data migrations"

prerequisites:
  required_artifacts:
    - type: "domain_model"
      description: "Entity relationship diagrams or model documentation"
    - type: "source_code"
      description: "Entity class implementations"
    - type: "database_schema"
      description: "Database schema definitions"

  access_requirements:
    - "Read access to domain layer source code"
    - "Access to database schema"
    - "Access to domain model documentation"

discovery:
  file_patterns:
    - glob: "**/domain/**/entities/**/*.{ts,java,cs,py}"
      purpose: "Find entity implementations"
    - glob: "**/models/**/*.{ts,java,cs,py}"
      purpose: "Find model definitions"
    - glob: "**/*Entity*.{ts,java,cs,py}"
      purpose: "Find entity classes by naming convention"
    - glob: "**/migrations/**/*.{sql,ts,js}"
      purpose: "Find database migration files"
    - glob: "**/*.prisma"
      purpose: "Find Prisma schema files"

  interview_questions:
    - role: "Domain Expert"
      questions:
        - "What are the main entities in your domain?"
        - "How do entities relate to each other?"
        - "Are there any relationships that are optional vs required?"
    - role: "Database Administrator"
      questions:
        - "Are there known referential integrity issues?"
        - "How are cascading operations handled?"
        - "Are there circular dependencies in the schema?"

knowledge_sources:
  guides:
    - id: "ddd-reference"
      name: "Domain-Driven Design Reference"
      url: "https://www.domainlanguage.com/ddd/reference/"
    - id: "entity-framework-relationships"
      name: "Entity Framework Relationships"
      url: "https://docs.microsoft.com/en-us/ef/core/modeling/relationships"

  standards:
    - id: "data-modeling-standards"
      name: "Data Modeling Standards"
      relevance: "Entity relationship modeling best practices"

tooling:
  analysis_tools:
    - tool: "Entity Framework Core Power Tools"
      purpose: "Visualize and analyze entity relationships"
    - tool: "dbdiagram.io"
      purpose: "Database diagram generation and analysis"
    - tool: "SchemaSpy"
      purpose: "Database schema documentation and relationship analysis"
    - tool: "Hibernate Tools"
      purpose: "Entity relationship mapping validation for Java"

signals:
  critical:
    - id: "ERV-CRIT-001"
      signal: "Missing foreign key constraints allowing orphaned records"
      evidence_indicators:
        - "Orphaned records found in database"
        - "No foreign key constraints defined"
        - "Delete operations leaving dangling references"
      explanation: |
        Without foreign key constraints, the database cannot enforce referential
        integrity. This leads to orphaned records, broken relationships, and
        data corruption over time.
      remediation: "Add foreign key constraints and clean up existing orphaned records"

    - id: "ERV-CRIT-002"
      signal: "Bidirectional relationship inconsistency"
      evidence_indicators:
        - "Parent has reference to child but child lacks back-reference"
        - "Inconsistent state between related entities"
        - "Manual synchronization of both sides frequently missed"
      explanation: |
        Inconsistent bidirectional relationships lead to navigation failures
        and incorrect business logic execution depending on which side is queried.
      remediation: "Implement proper bidirectional relationship management with synchronization methods"

  high:
    - id: "ERV-HIGH-001"
      signal: "Incorrect cardinality constraints"
      evidence_indicators:
        - "One-to-many modeled as many-to-many or vice versa"
        - "Business rules violated by relationship structure"
        - "Data anomalies from incorrect cardinality"
      remediation: "Review business requirements and correct cardinality definitions"

    - id: "ERV-HIGH-002"
      signal: "Missing required relationships"
      evidence_indicators:
        - "Business operations require data joins not supported by model"
        - "Workaround queries to establish relationships"
        - "Business processes failing due to missing associations"
      remediation: "Add missing relationships based on business requirement analysis"

  medium:
    - id: "ERV-MED-001"
      signal: "Circular dependencies between entities"
      evidence_indicators:
        - "Entity A references B which references A"
        - "Complex initialization order requirements"
        - "Serialization issues from circular references"
      remediation: "Break circular dependencies using intermediate entities or event-based coupling"

    - id: "ERV-MED-002"
      signal: "Overloaded relationships carrying multiple meanings"
      evidence_indicators:
        - "Single relationship used for different business purposes"
        - "Conditional logic based on relationship context"
        - "Unclear relationship semantics"
      remediation: "Split into distinct relationships with clear semantics"

  low:
    - id: "ERV-LOW-001"
      signal: "Relationship names do not reflect business meaning"
      evidence_indicators:
        - "Generic names like 'related' or 'linked'"
        - "Technical rather than business terminology"
      remediation: "Rename relationships to reflect business semantics"

  positive:
    - id: "ERV-POS-001"
      signal: "Entity relationships clearly documented and match implementation"
    - id: "ERV-POS-002"
      signal: "All relationships have appropriate cascading behavior defined"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Entity Relationships"
      description: "Document all entities and their relationships"
      duration_estimate: "1 hour"
      tools:
        - name: "SchemaSpy"
          action: "Generate entity relationship diagrams"

    - id: "2"
      name: "Validate Against Business Requirements"
      description: "Compare relationships against documented business requirements"
      duration_estimate: "1-2 hours"

    - id: "3"
      name: "Check Referential Integrity"
      description: "Verify foreign key constraints and cascading behaviors"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Analyze Relationship Consistency"
      description: "Verify bidirectional relationships maintain consistency"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Document Findings"
      description: "Compile relationship issues and recommendations"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of relationship validation issues"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Entity Inventory"
        - "Relationship Analysis"
        - "Integrity Findings"
        - "Recommendations"

closeout_checklist:
  - id: "erv-001"
    item: "All entity relationships documented"
    level: "REQUIRED"
    verification: "manual"
  - id: "erv-002"
    item: "Cardinality constraints validated"
    level: "REQUIRED"
    verification: "manual"
  - id: "erv-003"
    item: "Referential integrity verified"
    level: "WARNING"
    verification: "automated"

governance:
  applicable_to:
    archetypes: ["enterprise-applications", "e-commerce", "fintech", "healthcare"]

  compliance_mappings:
    - framework: "GDPR"
      control: "Data Integrity"
      description: "Ensuring data relationships maintain integrity"

relationships:
  commonly_combined:
    - "business-logic-domain.domain-modeling.aggregate-boundary-analysis"
    - "data-management.data-integrity"
  depends_on:
    - "requirements-specification.business-requirements"
  feeds_into:
    - "data-management.database-design"
