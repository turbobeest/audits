# ============================================================
# AUDIT: Business Constraint Enforcement
# Category: 34 - Business Logic & Domain
# Subcategory: validation-rules
# ============================================================

audit:
  id: "business-logic-domain.validation-rules.business-constraint-enforcement"
  name: "Business Constraint Enforcement Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "validation-rules"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the enforcement of business constraints that go beyond basic input
    validation. This audit examines business rules like uniqueness constraints,
    cross-field validations, entity state constraints, and complex business
    invariants. It ensures that domain-specific constraints are properly enforced
    at both application and database levels.

  why_it_matters: |
    Business constraints protect data integrity and ensure correct business
    operations. Without proper enforcement, the system can enter invalid states
    that violate business rules, causing incorrect calculations, compliance
    issues, and operational problems.

  when_to_run:
    - "During domain model reviews"
    - "After data integrity issues"
    - "When implementing complex business rules"
    - "Before production deployments"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Domain model implementations"
    - type: "business_requirements"
      description: "Business constraint specifications"
    - type: "database_schema"
      description: "Database constraint definitions"

  access_requirements:
    - "Read access to domain layer code"
    - "Access to database schema"
    - "Access to business requirements"

discovery:
  file_patterns:
    - glob: "**/domain/**/*.{ts,java,cs,py}"
      purpose: "Find domain logic"
    - glob: "**/validators/**/*.{ts,java,cs,py}"
      purpose: "Find business validators"
    - glob: "**/constraints/**/*.{ts,java,cs,py}"
      purpose: "Find constraint implementations"
    - glob: "**/migrations/**/*.sql"
      purpose: "Find database constraints"

  interview_questions:
    - role: "Business Analyst"
      questions:
        - "What business constraints must always be true?"
        - "What combinations of data are invalid?"
        - "What state transitions are not allowed?"
    - role: "Lead Developer"
      questions:
        - "How are business constraints enforced?"
        - "Are constraints at application or database level?"
        - "Have there been constraint violations?"

knowledge_sources:
  guides:
    - id: "ddd-invariants"
      name: "DDD Invariants and Constraints"
      url: "https://www.domainlanguage.com/ddd/"
    - id: "database-constraints"
      name: "Database Constraint Design"
      url: "https://www.postgresql.org/docs/current/ddl-constraints.html"

  standards:
    - id: "data-integrity"
      name: "Data Integrity Standards"
      relevance: "Constraint enforcement best practices"

tooling:
  analysis_tools:
    - tool: "ArchUnit"
      purpose: "Verify constraint architecture"
    - tool: "Database schema analyzers"
      purpose: "Check database constraints"
    - tool: "Fluent Validation"
      purpose: ".NET validation framework"
    - tool: "Hibernate Validator"
      purpose: "Java validation"

signals:
  critical:
    - id: "BCE-CRIT-001"
      signal: "Critical business constraint not enforced anywhere"
      evidence_indicators:
        - "Constraint in requirements but not in code"
        - "Invalid data found in production"
        - "Business invariant violations"
      explanation: |
        Unenforced business constraints allow invalid states that can
        cause incorrect business operations, compliance violations, and
        data corruption.
      remediation: "Implement constraint enforcement at appropriate level"

    - id: "BCE-CRIT-002"
      signal: "Constraint enforced only at application level, not database"
      evidence_indicators:
        - "Database allows invalid data"
        - "Constraints bypassed through direct SQL"
        - "No foreign key or check constraints"
      explanation: |
        Application-only constraints can be bypassed through database
        tools, migrations, or bugs. Database constraints provide last
        line of defense.
      remediation: "Add database-level constraints where appropriate"

  high:
    - id: "BCE-HIGH-001"
      signal: "Cross-field validation missing"
      evidence_indicators:
        - "End date before start date"
        - "Percentage fields not summing to 100"
        - "Mutually exclusive options selected"
      remediation: "Implement cross-field validation rules"

    - id: "BCE-HIGH-002"
      signal: "State transition constraints not enforced"
      evidence_indicators:
        - "Invalid state transitions possible"
        - "No state machine validation"
        - "Entities in impossible states"
      remediation: "Implement state transition validation"

  medium:
    - id: "BCE-MED-001"
      signal: "Uniqueness constraints inconsistent"
      evidence_indicators:
        - "Unique constraint at DB but not app"
        - "Duplicate detection timing issues"
        - "Race conditions in uniqueness checks"
      remediation: "Enforce uniqueness at database level; handle conflicts gracefully"

    - id: "BCE-MED-002"
      signal: "Soft constraints not clearly distinguished"
      evidence_indicators:
        - "Warnings treated as errors or vice versa"
        - "No clear policy on soft constraints"
        - "Business rules with varying enforcement levels"
      remediation: "Clearly separate hard and soft constraints; document policy"

  low:
    - id: "BCE-LOW-001"
      signal: "Constraint violation messages not business-friendly"
      evidence_indicators:
        - "Database constraint error exposed to users"
        - "Technical validation messages"
      remediation: "Map technical errors to business-friendly messages"

  positive:
    - id: "BCE-POS-001"
      signal: "Business constraints enforced at multiple levels"
    - id: "BCE-POS-002"
      signal: "Clear documentation of all business constraints"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Business Constraints"
      description: "List all documented business constraints"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Map to Implementations"
      description: "Locate where each constraint is enforced"
      duration_estimate: "1-2 hours"

    - id: "3"
      name: "Verify Database Constraints"
      description: "Check database-level constraint definitions"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Test Constraint Enforcement"
      description: "Verify constraints prevent invalid data"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Document Findings"
      description: "Compile constraint enforcement findings"
      duration_estimate: "30 minutes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of constraint enforcement gaps"

    - type: "constraint_matrix"
      format: "structured"
      description: "Matrix of constraints and enforcement levels"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Constraint Inventory"
        - "Enforcement Analysis"
        - "Gap Analysis"
        - "Recommendations"

closeout_checklist:
  - id: "bce-001"
    item: "All business constraints documented"
    level: "REQUIRED"
    verification: "manual"
  - id: "bce-002"
    item: "Enforcement locations mapped"
    level: "REQUIRED"
    verification: "manual"
  - id: "bce-003"
    item: "Database constraints verified"
    level: "WARNING"
    verification: "automated"

governance:
  applicable_to:
    archetypes: ["enterprise-applications", "fintech", "healthcare"]

  compliance_mappings:
    - framework: "SOX"
      control: "Data Integrity"
      description: "Business data constraint enforcement"

relationships:
  commonly_combined:
    - "business-logic-domain.validation-rules.input-validation-completeness"
    - "data-management.data-integrity"
  depends_on:
    - "requirements-specification.business-requirements"
  feeds_into:
    - "data-management.data-quality"
