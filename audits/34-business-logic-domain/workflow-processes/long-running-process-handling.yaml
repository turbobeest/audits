# ============================================================
# AUDIT: Long-Running Process Handling
# Category: 34 - Business Logic & Domain
# Subcategory: workflow-processes
# ============================================================

audit:
  id: "business-logic-domain.workflow-processes.long-running-process-handling"
  name: "Long-Running Process Handling Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "workflow-processes"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates how the system handles long-running business processes that span
    hours, days, or longer. This audit examines process state persistence, resume
    capabilities, timeout handling, progress tracking, and user notification
    mechanisms. It ensures that long-running processes survive system restarts
    and provide appropriate visibility.

  why_it_matters: |
    Many business processes like loan approvals, background checks, or batch
    processing can take extended periods. Poor handling of long-running processes
    leads to lost work, duplicate processing, timeout failures, and user
    frustration. Robust handling ensures business continuity and reliability.

  when_to_run:
    - "When implementing batch or async processes"
    - "After timeout-related incidents"
    - "Before scaling long-running operations"
    - "During reliability assessments"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Long-running process implementations"
    - type: "architecture_docs"
      description: "Async processing architecture"
    - type: "operations_docs"
      description: "Process monitoring documentation"

  access_requirements:
    - "Read access to async processing code"
    - "Access to job queue configurations"
    - "Access to process monitoring tools"

discovery:
  file_patterns:
    - glob: "**/*Job*.{ts,java,cs,py}"
      purpose: "Find background job implementations"
    - glob: "**/*Task*.{ts,java,cs,py}"
      purpose: "Find async task implementations"
    - glob: "**/*Worker*.{ts,java,cs,py}"
      purpose: "Find worker implementations"
    - glob: "**/*Batch*.{ts,java,cs,py}"
      purpose: "Find batch processing code"
    - glob: "**/*Queue*.{ts,java,cs,py}"
      purpose: "Find queue handling code"

  interview_questions:
    - role: "Lead Developer"
      questions:
        - "How long can processes run in the system?"
        - "What happens to running processes during deployment?"
        - "How do you track progress of long operations?"
    - role: "Operations"
      questions:
        - "Are there jobs that frequently timeout or fail?"
        - "How do you monitor long-running processes?"
        - "Can you restart failed processes from where they left off?"

knowledge_sources:
  guides:
    - id: "temporal-long-running"
      name: "Temporal Long-Running Workflows"
      url: "https://docs.temporal.io/concepts/what-is-a-workflow-execution"
    - id: "batch-processing"
      name: "Enterprise Batch Processing"
      url: "https://docs.spring.io/spring-batch/docs/current/reference/html/"

  standards:
    - id: "jsr-352"
      name: "JSR 352 Batch Processing"
      relevance: "Java batch processing standard"

tooling:
  analysis_tools:
    - tool: "Temporal"
      purpose: "Workflow orchestration for long-running processes"
    - tool: "Spring Batch"
      purpose: "Java batch processing framework"
    - tool: "Sidekiq"
      purpose: "Ruby background job processing"
    - tool: "Celery"
      purpose: "Python distributed task queue"

signals:
  critical:
    - id: "LRP-CRIT-001"
      signal: "Process state lost on system restart"
      evidence_indicators:
        - "In-memory only process tracking"
        - "Jobs restart from beginning after crash"
        - "No checkpointing for long operations"
      explanation: |
        When process state is not persisted, system restarts cause loss of
        in-flight work. This leads to duplicate processing, missed SLAs, and
        data inconsistencies.
      remediation: "Implement durable process state; add checkpointing"

    - id: "LRP-CRIT-002"
      signal: "No timeout handling for external waits"
      evidence_indicators:
        - "Processes wait indefinitely for callbacks"
        - "No deadline enforcement"
        - "Stuck processes accumulate"
      explanation: |
        Long-running processes waiting indefinitely for external responses
        consume resources and create operational burden. Without timeouts,
        stuck processes never complete.
      remediation: "Implement timeouts for all external waits; add timeout handlers"

  high:
    - id: "LRP-HIGH-001"
      signal: "No progress tracking for long operations"
      evidence_indicators:
        - "Cannot determine how far along a process is"
        - "No ETA for completion"
        - "Users have no visibility into progress"
      remediation: "Implement progress reporting; provide user-facing status"

    - id: "LRP-HIGH-002"
      signal: "Duplicate processing on retry"
      evidence_indicators:
        - "Items processed multiple times on restart"
        - "No idempotency in process steps"
        - "Duplicate side effects observed"
      remediation: "Make process steps idempotent; track processed items"

  medium:
    - id: "LRP-MED-001"
      signal: "No graceful shutdown for long processes"
      evidence_indicators:
        - "Processes killed mid-operation during deployment"
        - "No drain mechanism for in-flight work"
        - "Data corruption from hard stops"
      remediation: "Implement graceful shutdown; honor completion of current items"

    - id: "LRP-MED-002"
      signal: "No user notification for long operations"
      evidence_indicators:
        - "Users unaware of completion status"
        - "No email/notification on completion"
        - "Users must poll for status"
      remediation: "Implement push notifications for process completion"

  low:
    - id: "LRP-LOW-001"
      signal: "Long-running process metrics not collected"
      evidence_indicators:
        - "No duration metrics"
        - "Cannot identify slow processes"
      remediation: "Add metrics for process duration and progress"

  positive:
    - id: "LRP-POS-001"
      signal: "Durable workflow with checkpoint/resume capability"
    - id: "LRP-POS-002"
      signal: "Real-time progress tracking and notifications"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify Long-Running Processes"
      description: "Map all processes that can run for extended periods"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Analyze State Persistence"
      description: "Review process state storage and checkpointing"
      duration_estimate: "1-2 hours"

    - id: "3"
      name: "Review Timeout Handling"
      description: "Verify timeout configurations and handlers"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Test Restart Scenarios"
      description: "Verify process behavior across restarts"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Document Findings"
      description: "Compile long-running process findings"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of long-running process handling issues"

    - type: "process_inventory"
      format: "structured"
      description: "Inventory of long-running processes"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Process Inventory"
        - "State Management Analysis"
        - "Timeout Review"
        - "Recommendations"

closeout_checklist:
  - id: "lrp-001"
    item: "Long-running processes identified"
    level: "REQUIRED"
    verification: "manual"
  - id: "lrp-002"
    item: "State persistence verified"
    level: "REQUIRED"
    verification: "manual"
  - id: "lrp-003"
    item: "Timeout handling reviewed"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["enterprise-applications", "batch-processing", "fintech"]

  compliance_mappings:
    - framework: "SOC 2"
      control: "Availability"
      description: "Process reliability controls"

relationships:
  commonly_combined:
    - "business-logic-domain.workflow-processes.process-orchestration"
    - "reliability.job-queue-reliability"
  depends_on:
    - "infrastructure.job-scheduling"
  feeds_into:
    - "operations-monitoring.batch-monitoring"
