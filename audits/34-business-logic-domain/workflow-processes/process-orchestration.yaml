# ============================================================
# AUDIT: Process Orchestration
# Category: 34 - Business Logic & Domain
# Subcategory: workflow-processes
# ============================================================

audit:
  id: "business-logic-domain.workflow-processes.process-orchestration"
  name: "Process Orchestration Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "workflow-processes"

  tier: "expert"
  estimated_duration: "4-8 hours"  # median: 6h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates business process orchestration including saga patterns, process
    managers, and workflow engines. This audit examines how multi-step business
    processes coordinate across services, handle failures, manage compensating
    transactions, and maintain process state. It ensures orchestration patterns
    are correctly implemented for reliability and consistency.

  why_it_matters: |
    Business processes spanning multiple services require careful orchestration
    to maintain consistency. Poorly orchestrated processes lead to partial
    completions, orphaned data, and failed business transactions. Proper
    orchestration ensures business processes complete reliably even when
    individual steps fail.

  when_to_run:
    - "When designing multi-service workflows"
    - "After distributed transaction failures"
    - "Before major orchestration changes"
    - "During reliability assessments"

prerequisites:
  required_artifacts:
    - type: "process_definitions"
      description: "Business process definitions"
    - type: "source_code"
      description: "Orchestration implementation"
    - type: "architecture_docs"
      description: "Service integration documentation"

  access_requirements:
    - "Read access to orchestration code"
    - "Access to workflow engine administration"
    - "Access to process monitoring dashboards"

discovery:
  file_patterns:
    - glob: "**/*Saga*.{ts,java,cs,py}"
      purpose: "Find saga implementations"
    - glob: "**/*Orchestrator*.{ts,java,cs,py}"
      purpose: "Find orchestrator code"
    - glob: "**/*ProcessManager*.{ts,java,cs,py}"
      purpose: "Find process managers"
    - glob: "**/*.bpmn"
      purpose: "Find BPMN process definitions"
    - glob: "**/workflows/**/*.{yaml,json}"
      purpose: "Find workflow definitions"

  interview_questions:
    - role: "Architect"
      questions:
        - "What orchestration patterns are used?"
        - "How are distributed transactions handled?"
        - "What happens when a process step fails?"
    - role: "Operations"
      questions:
        - "Are there processes that frequently get stuck?"
        - "How do you handle failed orchestrations?"
        - "Can you replay or retry failed processes?"

knowledge_sources:
  guides:
    - id: "saga-pattern"
      name: "Saga Pattern"
      url: "https://microservices.io/patterns/data/saga.html"
    - id: "temporal-io"
      name: "Temporal.io Documentation"
      url: "https://docs.temporal.io/"

  standards:
    - id: "bpmn"
      name: "BPMN 2.0"
      relevance: "Business process modeling standard"

tooling:
  analysis_tools:
    - tool: "Camunda"
      purpose: "BPMN workflow engine"
    - tool: "Temporal"
      purpose: "Workflow orchestration platform"
    - tool: "AWS Step Functions"
      purpose: "Serverless orchestration"
    - tool: "Zeebe"
      purpose: "Cloud-native workflow engine"

signals:
  critical:
    - id: "POR-CRIT-001"
      signal: "No compensation logic for failed steps"
      evidence_indicators:
        - "Partial completions left in inconsistent state"
        - "No rollback for failed distributed transactions"
        - "Manual cleanup required for failures"
      explanation: |
        Without compensation logic, failed orchestrations leave the system in
        inconsistent states. This causes data integrity issues, customer
        complaints, and manual remediation burden.
      remediation: "Implement compensating transactions for all steps; use saga pattern"

    - id: "POR-CRIT-002"
      signal: "Process state not persisted durably"
      evidence_indicators:
        - "In-memory only process state"
        - "Process state lost on restart"
        - "No way to resume interrupted processes"
      explanation: |
        Non-durable process state means system restarts lose in-flight
        processes. This causes lost transactions and requires manual recovery.
      remediation: "Persist process state durably; implement checkpoint/resume"

  high:
    - id: "POR-HIGH-001"
      signal: "No timeout handling for process steps"
      evidence_indicators:
        - "Processes wait indefinitely for external responses"
        - "Stuck processes accumulate over time"
        - "No deadline enforcement"
      remediation: "Implement timeouts for all external calls; add timeout handlers"

    - id: "POR-HIGH-002"
      signal: "Orchestration tightly coupled to services"
      evidence_indicators:
        - "Synchronous calls to all services"
        - "Direct service dependencies in orchestrator"
        - "Cannot update services independently"
      remediation: "Use event-driven choreography or message-based orchestration"

  medium:
    - id: "POR-MED-001"
      signal: "No visibility into process execution"
      evidence_indicators:
        - "Cannot determine current step of a process"
        - "No process execution history"
        - "Debugging requires log analysis"
      remediation: "Implement process visibility dashboard; log step completions"

    - id: "POR-MED-002"
      signal: "Manual intervention required for common failures"
      evidence_indicators:
        - "Frequent support tickets for stuck processes"
        - "No automated retry mechanisms"
        - "Recovery requires developer involvement"
      remediation: "Implement automated retry with exponential backoff; add self-healing"

  low:
    - id: "POR-LOW-001"
      signal: "Process definitions not version controlled"
      evidence_indicators:
        - "Cannot track process definition changes"
        - "No audit trail for orchestration changes"
      remediation: "Store process definitions in version control"

  positive:
    - id: "POR-POS-001"
      signal: "Robust saga pattern with full compensation"
    - id: "POR-POS-002"
      signal: "Self-healing processes with automatic retry"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Map Business Processes"
      description: "Identify all orchestrated business processes"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Analyze Orchestration Patterns"
      description: "Review orchestration implementation patterns"
      duration_estimate: "2 hours"

    - id: "3"
      name: "Review Failure Handling"
      description: "Verify compensation and error handling"
      duration_estimate: "1-2 hours"

    - id: "4"
      name: "Check State Durability"
      description: "Verify process state persistence"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Document Findings"
      description: "Compile orchestration findings"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of orchestration issues"

    - type: "process_inventory"
      format: "structured"
      description: "Inventory of orchestrated processes"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Process Inventory"
        - "Orchestration Analysis"
        - "Failure Handling Review"
        - "Recommendations"

closeout_checklist:
  - id: "por-001"
    item: "All orchestrated processes mapped"
    level: "REQUIRED"
    verification: "manual"
  - id: "por-002"
    item: "Compensation logic verified"
    level: "REQUIRED"
    verification: "manual"
  - id: "por-003"
    item: "State durability confirmed"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["microservices", "enterprise-applications", "fintech"]

  compliance_mappings:
    - framework: "SOX"
      control: "Transaction Processing"
      description: "Business process reliability controls"

relationships:
  commonly_combined:
    - "business-logic-domain.workflow-processes.state-machine-integrity"
    - "reliability.distributed-transactions"
  depends_on:
    - "architecture-design.service-integration"
  feeds_into:
    - "operations-monitoring.process-monitoring"
