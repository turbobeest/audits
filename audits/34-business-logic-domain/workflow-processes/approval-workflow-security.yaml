# ============================================================
# AUDIT: Approval Workflow Security
# Category: 34 - Business Logic & Domain
# Subcategory: workflow-processes
# ============================================================

audit:
  id: "business-logic-domain.workflow-processes.approval-workflow-security"
  name: "Approval Workflow Security Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "workflow-processes"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the security of approval workflows including authorization checks,
    segregation of duties, approval chains, delegation rules, and audit trails.
    This audit ensures that approval processes cannot be bypassed, self-approvals
    are prevented where required, and approval authority is properly validated.

  why_it_matters: |
    Approval workflows are critical controls for preventing fraud and ensuring
    compliance. Weak approval workflows allow unauthorized transactions, bypass
    of financial controls, and compliance violations. Secure approval workflows
    are essential for SOX compliance and fraud prevention.

  when_to_run:
    - "During compliance audits"
    - "When implementing new approval workflows"
    - "After security incidents"
    - "Before regulatory examinations"

prerequisites:
  required_artifacts:
    - type: "workflow_definitions"
      description: "Approval workflow specifications"
    - type: "source_code"
      description: "Approval workflow implementations"
    - type: "access_control_matrix"
      description: "Role and permission definitions"

  access_requirements:
    - "Read access to workflow code"
    - "Access to authorization configurations"
    - "Access to approval audit logs"

discovery:
  file_patterns:
    - glob: "**/*Approval*.{ts,java,cs,py}"
      purpose: "Find approval workflow code"
    - glob: "**/*Authorize*.{ts,java,cs,py}"
      purpose: "Find authorization logic"
    - glob: "**/*Workflow*.{ts,java,cs,py}"
      purpose: "Find workflow implementations"
    - glob: "**/policies/**/*.{yaml,json}"
      purpose: "Find approval policy configurations"

  interview_questions:
    - role: "Compliance Officer"
      questions:
        - "What are the approval requirements for different transaction types?"
        - "How is segregation of duties enforced?"
        - "Are there known gaps in approval controls?"
    - role: "Lead Developer"
      questions:
        - "How are approval authorities validated?"
        - "Can users approve their own requests?"
        - "How is the approval chain enforced?"

knowledge_sources:
  guides:
    - id: "sox-compliance"
      name: "SOX Compliance Guide"
      url: "https://www.soxlaw.com/"
    - id: "segregation-of-duties"
      name: "Segregation of Duties Best Practices"
      url: "https://www.isaca.org/"

  standards:
    - id: "sox"
      name: "Sarbanes-Oxley Act"
      relevance: "Financial controls and approval requirements"
    - id: "cobit"
      name: "COBIT Framework"
      relevance: "IT governance and approval controls"

tooling:
  analysis_tools:
    - tool: "SonarQube Security Rules"
      purpose: "Detect authorization bypasses"
    - tool: "Checkmarx"
      purpose: "Security code analysis"
    - tool: "Custom approval validators"
      purpose: "Verify approval chain integrity"

signals:
  critical:
    - id: "AWS-CRIT-001"
      signal: "Self-approval possible for controlled transactions"
      evidence_indicators:
        - "Submitter can approve their own requests"
        - "No check for requester != approver"
        - "Audit logs showing self-approvals"
      explanation: |
        Self-approval violates segregation of duties, a fundamental control
        principle. It enables fraud and is a significant compliance violation
        in regulated industries.
      remediation: "Enforce submitter cannot be approver; add technical controls"

    - id: "AWS-CRIT-002"
      signal: "Approval chain can be bypassed"
      evidence_indicators:
        - "Direct database modifications to approval status"
        - "API endpoints without proper authorization"
        - "Transactions completed without required approvals"
      explanation: |
        Bypassing approval chains defeats the purpose of controls. This creates
        significant fraud risk and compliance violations.
      remediation: "Enforce approval chain at database level; audit all status changes"

  high:
    - id: "AWS-HIGH-001"
      signal: "Approval authority not validated at time of approval"
      evidence_indicators:
        - "Approver authority checked only at submission"
        - "Role changes not reflected in pending approvals"
        - "Approvals honored after role revocation"
      remediation: "Validate authority at approval time; check current permissions"

    - id: "AWS-HIGH-002"
      signal: "No approval audit trail"
      evidence_indicators:
        - "Approvals not logged"
        - "Cannot determine who approved what"
        - "Approval timestamps not recorded"
      remediation: "Implement comprehensive approval logging with timestamp and actor"

  medium:
    - id: "AWS-MED-001"
      signal: "Delegation rules too permissive"
      evidence_indicators:
        - "Unlimited delegation chains"
        - "No restrictions on delegate authority"
        - "Delegates can re-delegate without limits"
      remediation: "Implement delegation limits; restrict delegate authority appropriately"

    - id: "AWS-MED-002"
      signal: "Approval thresholds not enforced"
      evidence_indicators:
        - "Transactions exceeding limits without additional approval"
        - "Threshold checks easily circumvented"
        - "Split transactions to avoid thresholds"
      remediation: "Enforce thresholds server-side; detect split transactions"

  low:
    - id: "AWS-LOW-001"
      signal: "Approval workflow not documented"
      evidence_indicators:
        - "No documentation of approval requirements"
        - "Approval rules only in code"
      remediation: "Document approval workflows and authority matrices"

  positive:
    - id: "AWS-POS-001"
      signal: "Strong segregation of duties enforced technically"
    - id: "AWS-POS-002"
      signal: "Complete audit trail for all approvals"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Approval Workflows"
      description: "Map all approval workflows and their requirements"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Review Authorization Logic"
      description: "Analyze approval authority validation"
      duration_estimate: "1-2 hours"

    - id: "3"
      name: "Test Bypass Scenarios"
      description: "Attempt to bypass approval controls"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Review Audit Trail"
      description: "Verify approval audit logging"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Document Findings"
      description: "Compile approval workflow security findings"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of approval workflow security issues"

    - type: "control_matrix"
      format: "structured"
      description: "Approval control matrix"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Workflow Inventory"
        - "Security Analysis"
        - "Compliance Review"
        - "Recommendations"

closeout_checklist:
  - id: "aws-001"
    item: "All approval workflows documented"
    level: "REQUIRED"
    verification: "manual"
  - id: "aws-002"
    item: "Segregation of duties verified"
    level: "REQUIRED"
    verification: "manual"
  - id: "aws-003"
    item: "Audit trail completeness confirmed"
    level: "WARNING"
    verification: "automated"

governance:
  applicable_to:
    archetypes: ["enterprise-applications", "fintech", "healthcare", "regulated-industry"]

  compliance_mappings:
    - framework: "SOX"
      control: "ITGC-Access Controls"
      description: "Approval workflow controls"
    - framework: "PCI-DSS"
      control: "7.1"
      description: "Access control requirements"

relationships:
  commonly_combined:
    - "business-logic-domain.authorization-logic.role-based-access"
    - "security.access-control"
  depends_on:
    - "security.authentication"
  feeds_into:
    - "compliance-legal.sox-compliance"
