# ============================================================
# AUDIT: Parallel Execution Correctness
# Category: 34 - Business Logic & Domain
# Subcategory: workflow-processes
# ============================================================

audit:
  id: "business-logic-domain.workflow-processes.parallel-execution-correctness"
  name: "Parallel Execution Correctness Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "workflow-processes"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the correctness of parallel execution patterns in business workflows.
    This audit examines fork/join constructs, parallel branch handling, race
    condition prevention, synchronization points, and partial failure handling.
    It ensures that parallel workflow execution maintains data consistency and
    handles all branch completion scenarios correctly.

  why_it_matters: |
    Parallel execution improves workflow performance but introduces complexity.
    Incorrect parallel handling leads to data races, lost updates, incomplete
    aggregations, and inconsistent results. Proper parallel execution is critical
    for workflows that must be both fast and reliable.

  when_to_run:
    - "When implementing parallel workflow patterns"
    - "After concurrency-related bugs"
    - "During performance optimization reviews"
    - "Before scaling parallel execution"

prerequisites:
  required_artifacts:
    - type: "workflow_definitions"
      description: "Workflow definitions with parallel constructs"
    - type: "source_code"
      description: "Parallel execution implementations"
    - type: "test_cases"
      description: "Concurrency test scenarios"

  access_requirements:
    - "Read access to workflow code"
    - "Access to workflow engine configuration"
    - "Access to execution logs"

discovery:
  file_patterns:
    - glob: "**/*Parallel*.{ts,java,cs,py}"
      purpose: "Find parallel execution code"
    - glob: "**/*Fork*.{ts,java,cs,py}"
      purpose: "Find fork/join patterns"
    - glob: "**/*Concurrent*.{ts,java,cs,py}"
      purpose: "Find concurrent execution code"
    - glob: "**/*Async*.{ts,java,cs,py}"
      purpose: "Find async execution patterns"

  interview_questions:
    - role: "Lead Developer"
      questions:
        - "What parallel execution patterns are used in workflows?"
        - "How do you handle partial failures in parallel branches?"
        - "Are there known race conditions?"
    - role: "QA Engineer"
      questions:
        - "How do you test parallel execution scenarios?"
        - "Have you found timing-dependent bugs?"

knowledge_sources:
  guides:
    - id: "parallel-gateway"
      name: "BPMN Parallel Gateway"
      url: "https://docs.camunda.org/manual/latest/reference/bpmn20/gateways/parallel-gateway/"
    - id: "temporal-parallel"
      name: "Temporal Parallel Execution"
      url: "https://docs.temporal.io/activities#parallel-execution"

  standards:
    - id: "bpmn-parallel"
      name: "BPMN Parallel Constructs"
      relevance: "Parallel workflow patterns"

tooling:
  analysis_tools:
    - tool: "ThreadSanitizer"
      purpose: "Detect race conditions"
    - tool: "Concurrency testing frameworks"
      purpose: "Test parallel scenarios"
    - tool: "Workflow engine monitoring"
      purpose: "Track parallel execution"

signals:
  critical:
    - id: "PEC-CRIT-001"
      signal: "Data race between parallel branches"
      evidence_indicators:
        - "Concurrent modifications to shared state"
        - "Lost updates in aggregation"
        - "Non-deterministic results"
      explanation: |
        Data races in parallel execution cause unpredictable results and data
        corruption. When parallel branches modify shared state without
        synchronization, outcomes depend on timing.
      remediation: "Eliminate shared mutable state; use proper synchronization"

    - id: "PEC-CRIT-002"
      signal: "Join does not wait for all branches"
      evidence_indicators:
        - "Workflow continues before branches complete"
        - "Missing branch results in aggregation"
        - "Incomplete data in downstream steps"
      explanation: |
        When joins do not wait for all parallel branches, the workflow
        proceeds with incomplete data, causing incorrect business outcomes.
      remediation: "Ensure joins wait for all branches; verify join semantics"

  high:
    - id: "PEC-HIGH-001"
      signal: "Partial failure handling missing"
      evidence_indicators:
        - "One branch failure doesn't affect others"
        - "Completed branches not rolled back on failure"
        - "Inconsistent state after partial failure"
      remediation: "Implement compensation for partial failures; define failure semantics"

    - id: "PEC-HIGH-002"
      signal: "No timeout for parallel branch completion"
      evidence_indicators:
        - "Slow branches block entire workflow"
        - "No branch-level timeout"
        - "Join waits indefinitely"
      remediation: "Add timeouts to parallel branches; handle slow branches"

  medium:
    - id: "PEC-MED-001"
      signal: "Parallel branch order affects results"
      evidence_indicators:
        - "Non-commutative operations in parallel"
        - "Results depend on completion order"
        - "Different outcomes on repeated execution"
      remediation: "Ensure parallel operations are order-independent"

    - id: "PEC-MED-002"
      signal: "Excessive parallelism causing resource exhaustion"
      evidence_indicators:
        - "Too many parallel branches"
        - "Resource limits exceeded"
        - "Cascading failures from overload"
      remediation: "Limit parallel branch count; implement backpressure"

  low:
    - id: "PEC-LOW-001"
      signal: "Parallel execution not visible in monitoring"
      evidence_indicators:
        - "Cannot see individual branch status"
        - "No branch-level metrics"
      remediation: "Add visibility for parallel branch execution"

  positive:
    - id: "PEC-POS-001"
      signal: "Proper synchronization in all parallel patterns"
    - id: "PEC-POS-002"
      signal: "Comprehensive partial failure handling"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify Parallel Patterns"
      description: "Map all parallel execution constructs"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Analyze Synchronization"
      description: "Review synchronization points and shared state"
      duration_estimate: "1-2 hours"
      tools:
        - name: "ThreadSanitizer"
          action: "Run race condition detection"

    - id: "3"
      name: "Review Join Semantics"
      description: "Verify all joins wait for correct branches"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Test Failure Scenarios"
      description: "Test partial failure handling"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Document Findings"
      description: "Compile parallel execution findings"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of parallel execution issues"

    - type: "parallel_pattern_inventory"
      format: "structured"
      description: "Inventory of parallel patterns"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Parallel Pattern Analysis"
        - "Synchronization Review"
        - "Failure Handling Assessment"
        - "Recommendations"

closeout_checklist:
  - id: "pec-001"
    item: "All parallel patterns documented"
    level: "REQUIRED"
    verification: "manual"
  - id: "pec-002"
    item: "Synchronization reviewed"
    level: "REQUIRED"
    verification: "manual"
  - id: "pec-003"
    item: "Race condition detection run"
    level: "WARNING"
    verification: "automated"

governance:
  applicable_to:
    archetypes: ["enterprise-applications", "high-performance-systems"]

  compliance_mappings:
    - framework: "SOC 2"
      control: "Processing Integrity"
      description: "Parallel processing correctness"

relationships:
  commonly_combined:
    - "business-logic-domain.workflow-processes.process-orchestration"
    - "concurrency.thread-safety"
  depends_on:
    - "architecture-design.concurrency-strategy"
  feeds_into:
    - "testing-quality-assurance.concurrency-testing"
