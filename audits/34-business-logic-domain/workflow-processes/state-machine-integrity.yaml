# ============================================================
# AUDIT: State Machine Integrity
# Category: 34 - Business Logic & Domain
# Subcategory: workflow-processes
# ============================================================

audit:
  id: "business-logic-domain.workflow-processes.state-machine-integrity"
  name: "State Machine Integrity Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "workflow-processes"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the design and implementation of state machines in business workflows.
    This audit examines state definitions, transition rules, guard conditions, and
    invariants. It ensures that state machines are complete (all valid transitions
    defined), deterministic (no ambiguous transitions), and prevent invalid state
    transitions.

  why_it_matters: |
    State machines are critical for managing complex business processes like order
    fulfillment, loan processing, and approval workflows. Invalid state transitions
    cause business process failures, data corruption, and compliance violations.
    Robust state machine design ensures predictable workflow behavior.

  when_to_run:
    - "During workflow design reviews"
    - "When adding new states or transitions"
    - "After workflow-related bugs"
    - "Before deploying workflow changes"

prerequisites:
  required_artifacts:
    - type: "workflow_diagrams"
      description: "State machine diagrams"
    - type: "source_code"
      description: "State machine implementations"
    - type: "business_requirements"
      description: "Workflow specifications"

  access_requirements:
    - "Read access to workflow code"
    - "Access to workflow documentation"
    - "Access to state transition logs"

discovery:
knowledge_sources:
  guides:
    - id: "state-machine-patterns"
      name: "State Machine Design Patterns"
      url: "https://refactoring.guru/design-patterns/state"
    - id: "xstate-documentation"
      name: "XState Documentation"
      url: "https://xstate.js.org/docs/"

  standards:
    - id: "uml-state-diagrams"
      name: "UML State Diagrams"
      relevance: "State machine modeling standards"

tooling:
  analysis_tools:
    - tool: "XState"
      purpose: "JavaScript state machine library with visualization"
    - tool: "Spring State Machine"
      purpose: "Java state machine framework"
    - tool: "Stateless"
      purpose: ".NET state machine library"
    - tool: "PlantUML"
      purpose: "State diagram generation and validation"

signals:
  critical:
    - id: "SMI-CRIT-001"
      signal: "Invalid state transitions possible"
      evidence_indicators:
        - "Direct state field modifications bypassing machine"
        - "No validation on state changes"
        - "Database records with invalid state sequences"
      explanation: |
        When state transitions can bypass the state machine, business invariants
        are violated. Orders may ship before payment, loans may fund before
        approval, causing significant business and compliance issues.
      remediation: "Enforce all state changes through state machine; add integrity constraints"

    - id: "SMI-CRIT-002"
      signal: "Missing terminal states causing stuck workflows"
      evidence_indicators:
        - "Workflows that cannot reach completion"
        - "No error or cancellation states"
        - "Dead-end states with no transitions"
      explanation: |
        Workflows without proper terminal states accumulate stuck items that
        require manual intervention, creating operational burden and data
        integrity issues.
      remediation: "Define proper terminal states; ensure all paths lead to completion"

  high:
    - id: "SMI-HIGH-001"
      signal: "Non-deterministic transitions from same state"
      evidence_indicators:
        - "Multiple transitions possible for same event"
        - "Ambiguous guard conditions"
        - "Race conditions in transition evaluation"
      remediation: "Make guard conditions mutually exclusive; add priority to transitions"

    - id: "SMI-HIGH-002"
      signal: "State machine not handling concurrent events"
      evidence_indicators:
        - "No locking on state transitions"
        - "Race conditions between parallel requests"
        - "Lost updates to state"
      remediation: "Implement optimistic or pessimistic locking; serialize state transitions"

  medium:
    - id: "SMI-MED-001"
      signal: "Missing state transition audit trail"
      evidence_indicators:
        - "No history of state changes"
        - "Cannot determine when state changed"
        - "No user attribution for transitions"
      remediation: "Log all state transitions with timestamp and actor"

    - id: "SMI-MED-002"
      signal: "State machine not matching business documentation"
      evidence_indicators:
        - "Code has states not in requirements"
        - "Missing transitions from specification"
        - "State names differ from business terminology"
      remediation: "Align state machine with business documentation; update both to match"

  low:
    - id: "SMI-LOW-001"
      signal: "State machine visualization not maintained"
      evidence_indicators:
        - "Diagrams out of date"
        - "No automated diagram generation"
      remediation: "Generate diagrams from code; maintain visual documentation"

  positive:
    - id: "SMI-POS-001"
      signal: "State machine enforces all business invariants"
    - id: "SMI-POS-002"
      signal: "Complete audit trail of all state transitions"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Map State Machines"
      description: "Identify all state machines and their states"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Verify Completeness"
      description: "Check that all valid transitions are defined"
      duration_estimate: "1 hour"

    - id: "3"
      name: "Analyze Guard Conditions"
      description: "Review transition guards for completeness and exclusivity"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Check Concurrency Handling"
      description: "Verify concurrent transition handling"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Document Findings"
      description: "Compile state machine integrity findings"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of state machine integrity issues"

    - type: "state_diagrams"
      format: "diagram"
      description: "Generated state machine diagrams"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "State Machine Inventory"
        - "Transition Analysis"
        - "Concurrency Review"
        - "Recommendations"

closeout_checklist:
  - id: "smi-001"
    item: "All state machines documented"
    level: "REQUIRED"
    verification: "manual"
  - id: "smi-002"
    item: "Transition completeness verified"
    level: "REQUIRED"
    verification: "manual"
  - id: "smi-003"
    item: "Concurrency handling reviewed"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["enterprise-applications", "fintech", "e-commerce", "healthcare"]

  compliance_mappings:
    - framework: "SOX"
      control: "Process Controls"
      description: "Business process integrity controls"

relationships:
  commonly_combined:
    - "business-logic-domain.workflow-processes.process-orchestration"
    - "concurrency.state-management"
  depends_on:
    - "requirements-specification.workflow-requirements"
  feeds_into:
    - "operations-monitoring.workflow-monitoring"
