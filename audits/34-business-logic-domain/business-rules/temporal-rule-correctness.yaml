# ============================================================
# AUDIT: Temporal Rule Correctness
# Category: 34 - Business Logic & Domain
# Subcategory: business-rules
# ============================================================

audit:
  id: "business-logic-domain.business-rules.temporal-rule-correctness"
  name: "Temporal Rule Correctness Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "business-rules"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the correctness of time-dependent business rules. This audit
    examines date range validations, temporal state transitions, time-sensitive
    calculations, effective dating, and historical data handling. It ensures
    that business rules correctly handle time zones, daylight saving transitions,
    and temporal boundaries.

  why_it_matters: |
    Time-related bugs are notoriously difficult to detect and can cause significant
    business impact. Incorrect temporal rules lead to premature or missed
    expirations, wrong calculations for billing periods, and compliance violations
    for time-sensitive regulations. Temporal correctness is essential for accurate
    business operations.

  when_to_run:
    - "During implementation of time-sensitive features"
    - "Before year-end or time-related transitions"
    - "When expanding to new time zones"
    - "After daylight saving time issues"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Business rule implementations with temporal logic"
    - type: "business_requirements"
      description: "Time-related business rules"
    - type: "test_cases"
      description: "Tests covering temporal scenarios"

  access_requirements:
    - "Read access to business logic code"
    - "Access to date/time handling utilities"
    - "Access to temporal test suites"

discovery:
  file_patterns:
    - glob: "**/domain/**/*.{ts,java,cs,py}"
      purpose: "Find domain logic with date handling"
    - glob: "**/*Date*.*"
      purpose: "Find date-related code"
    - glob: "**/*Time*.*"
      purpose: "Find time-related code"
    - glob: "**/*Period*.*"
      purpose: "Find period calculation code"
    - glob: "**/*Schedule*.*"
      purpose: "Find scheduling logic"

  interview_questions:
    - role: "Lead Developer"
      questions:
        - "How do you handle time zones in the application?"
        - "Have there been issues around daylight saving transitions?"
        - "How is effective dating implemented?"
    - role: "Business Analyst"
      questions:
        - "What time-sensitive rules exist in the business?"
        - "How are billing periods defined?"
        - "Are there rules that change based on dates?"

knowledge_sources:
  guides:
    - id: "java-time"
      name: "Java Time API"
      url: "https://docs.oracle.com/javase/8/docs/api/java/time/package-summary.html"
    - id: "temporal-patterns"
      name: "Temporal Patterns"
      url: "https://martinfowler.com/eaaDev/timePoint.html"

  standards:
    - id: "iso-8601"
      name: "ISO 8601 Date/Time"
      relevance: "Date and time representation standards"

tooling:
  analysis_tools:
    - tool: "Error Prone temporal checks"
      purpose: "Detect common temporal bugs in Java"
    - tool: "DateCheck linter"
      purpose: "JavaScript date handling analysis"
    - tool: "NodaTime"
      purpose: ".NET time handling library"
    - tool: "Custom temporal rules"
      purpose: "Project-specific temporal validation"

signals:
  critical:
    - id: "TRC-CRIT-001"
      signal: "Time zone handling causes incorrect results"
      evidence_indicators:
        - "Dates shift by hours across time zones"
        - "Local time used where UTC expected"
        - "Time zone conversion not applied consistently"
      explanation: |
        Incorrect time zone handling can cause payments to apply to wrong
        periods, appointments to be scheduled at wrong times, and reports
        to show incorrect data.
      remediation: "Standardize on UTC storage; apply time zone conversion at boundaries"

    - id: "TRC-CRIT-002"
      signal: "Date comparisons use wrong boundaries"
      evidence_indicators:
        - "Off-by-one errors at month/year end"
        - "Inclusive vs exclusive boundaries inconsistent"
        - "End of day calculations incorrect"
      explanation: |
        Incorrect date boundary handling causes records to fall into wrong
        periods, affecting billing, reporting, and compliance.
      remediation: "Standardize date boundary conventions; use half-open intervals"

  high:
    - id: "TRC-HIGH-001"
      signal: "Daylight saving transitions not handled"
      evidence_indicators:
        - "Duration calculations wrong during DST transitions"
        - "Scheduled tasks skip or double-execute"
        - "2 AM events during spring forward"
      remediation: "Use time zone aware date/time types; test DST transitions"

    - id: "TRC-HIGH-002"
      signal: "Effective dating allows invalid temporal states"
      evidence_indicators:
        - "Overlapping effective date ranges"
        - "Gaps in effective coverage"
        - "No validation of temporal constraints"
      remediation: "Implement temporal constraint validation; prevent overlaps and gaps"

  medium:
    - id: "TRC-MED-001"
      signal: "Date calculations not using proper libraries"
      evidence_indicators:
        - "Manual day/month arithmetic"
        - "Leap year not handled correctly"
        - "Month length assumptions"
      remediation: "Use standard date/time libraries for all calculations"

    - id: "TRC-MED-002"
      signal: "Historical data changes not preserved"
      evidence_indicators:
        - "Point-in-time queries return current data"
        - "No audit of temporal changes"
        - "Cannot recreate historical state"
      remediation: "Implement temporal versioning; preserve historical states"

  low:
    - id: "TRC-LOW-001"
      signal: "Inconsistent date formats across system"
      evidence_indicators:
        - "Different date parsing formats"
        - "No standard date format"
      remediation: "Standardize on ISO 8601 format; use consistent parsing"

  positive:
    - id: "TRC-POS-001"
      signal: "All temporal logic uses time zone aware types"
    - id: "TRC-POS-002"
      signal: "Comprehensive tests for DST and edge cases"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Temporal Rules"
      description: "Identify all time-dependent business rules"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Analyze Time Zone Handling"
      description: "Review time zone conversion and storage"
      duration_estimate: "1 hour"

    - id: "3"
      name: "Check Date Calculations"
      description: "Verify date arithmetic and boundary handling"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Review DST Handling"
      description: "Check daylight saving transition handling"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Document Findings"
      description: "Compile temporal rule findings"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of temporal rule issues"

    - type: "temporal_inventory"
      format: "structured"
      description: "Inventory of time-dependent rules"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Temporal Rule Inventory"
        - "Time Zone Analysis"
        - "Date Calculation Review"
        - "Recommendations"

closeout_checklist:
  - id: "trc-001"
    item: "Temporal rules inventoried"
    level: "REQUIRED"
    verification: "manual"
  - id: "trc-002"
    item: "Time zone handling reviewed"
    level: "REQUIRED"
    verification: "manual"
  - id: "trc-003"
    item: "DST scenarios verified"
    level: "WARNING"
    verification: "automated"

governance:
  applicable_to:
    archetypes: ["enterprise-applications", "fintech", "scheduling-systems"]

  compliance_mappings:
    - framework: "SOX"
      control: "Financial Reporting"
      description: "Period-end calculations accuracy"

relationships:
  commonly_combined:
    - "business-logic-domain.business-rules.edge-case-coverage"
    - "business-logic-domain.calculation-logic.financial-accuracy"
  depends_on:
    - "architecture-design.date-time-strategy"
  feeds_into:
    - "testing-quality-assurance.temporal-testing"
