# ============================================================
# AUDIT: Rule Consistency
# Category: 34 - Business Logic & Domain
# Subcategory: business-rules
# ============================================================

audit:
  id: "business-logic-domain.business-rules.rule-consistency"
  name: "Rule Consistency Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "business-rules"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the consistency of business rule implementations across the codebase.
    This audit identifies conflicting rules, duplicate rule implementations with
    different behaviors, and inconsistencies between similar rules in different
    modules. It ensures that the same business concept is handled uniformly
    throughout the system.

  why_it_matters: |
    Inconsistent business rules cause unpredictable system behavior and user
    confusion. When the same rule produces different results depending on code
    path, debugging becomes difficult and users lose trust. Rule consistency is
    essential for system reliability and maintainability.

  when_to_run:
    - "During code reviews for new business rules"
    - "When integrating code from different teams"
    - "After merging feature branches with rule changes"
    - "Before major releases"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Business rule implementations"
    - type: "business_requirements"
      description: "Business rule specifications"
    - type: "test_cases"
      description: "Test coverage for rules"

  access_requirements:
    - "Read access to all business logic code"
    - "Access to business requirements"
    - "Access to test suites"

discovery:
  file_patterns:
    - glob: "**/rules/**/*.{ts,java,cs,py}"
      purpose: "Find business rule implementations"
    - glob: "**/validators/**/*.{ts,java,cs,py}"
      purpose: "Find validation logic"
    - glob: "**/policies/**/*.{ts,java,cs,py}"
      purpose: "Find business policies"
    - glob: "**/domain/**/*.{ts,java,cs,py}"
      purpose: "Find domain logic"

  interview_questions:
    - role: "Lead Developer"
      questions:
        - "How do you ensure consistent rule implementation across modules?"
        - "Are there known duplications of business rules?"
        - "How are shared rules managed?"
    - role: "QA Engineer"
      questions:
        - "Have you found inconsistent behavior for similar operations?"
        - "Are there scenarios that produce different results unexpectedly?"

knowledge_sources:
  guides:
    - id: "dry-principle"
      name: "DRY Principle"
      url: "https://en.wikipedia.org/wiki/Don%27t_repeat_yourself"

  standards:
    - id: "business-rules-approach"
      name: "Business Rules Approach"
      relevance: "Centralized rule management"

tooling:
  analysis_tools:
    - tool: "SonarQube"
      purpose: "Detect code duplication"
    - tool: "PMD CPD"
      purpose: "Copy-paste detection"
    - tool: "Simian"
      purpose: "Similarity analyzer"
    - tool: "NDepend"
      purpose: "Dependency and duplication analysis"

signals:
  critical:
    - id: "RCS-CRIT-001"
      signal: "Conflicting rules produce different outcomes for same input"
      evidence_indicators:
        - "Same condition evaluated differently in different modules"
        - "Contradictory business logic found"
        - "Tests showing conflicting behavior"
      explanation: |
        Conflicting rules create unpredictable behavior and make the system
        unreliable. Users cannot trust system outputs when the same input
        can produce different results.
      remediation: "Identify authoritative rule and remove or update conflicting implementations"

    - id: "RCS-CRIT-002"
      signal: "Critical rule duplicated with different thresholds"
      evidence_indicators:
        - "Same rule in multiple places with different values"
        - "Hardcoded thresholds vary across implementations"
        - "No single source of truth for rule parameters"
      explanation: |
        When critical rules like credit limits or compliance thresholds vary,
        it creates compliance risks and inconsistent customer treatment.
      remediation: "Centralize rule parameters in configuration; use single source of truth"

  high:
    - id: "RCS-HIGH-001"
      signal: "Business rule duplicated across multiple modules"
      evidence_indicators:
        - "Same validation logic in multiple files"
        - "Similar rule patterns with slight variations"
        - "Copy-pasted business logic"
      remediation: "Extract common rules into shared components; eliminate duplication"

    - id: "RCS-HIGH-002"
      signal: "Rules applied inconsistently at different entry points"
      evidence_indicators:
        - "API applies rules differently than UI"
        - "Batch processing skips rules applied in real-time"
        - "Different validation for same entity through different paths"
      remediation: "Ensure rules are applied at domain layer regardless of entry point"

  medium:
    - id: "RCS-MED-001"
      signal: "Rule implementations use different algorithms for same logic"
      evidence_indicators:
        - "Same calculation performed differently"
        - "Different rounding strategies for same purpose"
        - "Inconsistent precision handling"
      remediation: "Standardize algorithms and extract into shared utility"

    - id: "RCS-MED-002"
      signal: "Error handling for rules varies across implementations"
      evidence_indicators:
        - "Same rule violation produces different errors"
        - "Inconsistent error messages for same condition"
        - "Different exception types for same scenario"
      remediation: "Standardize error handling and messages for rule violations"

  low:
    - id: "RCS-LOW-001"
      signal: "Rule naming inconsistent across modules"
      evidence_indicators:
        - "Same rule known by different names"
        - "No standard naming convention for rules"
      remediation: "Establish naming convention and rename for consistency"

  positive:
    - id: "RCS-POS-001"
      signal: "Business rules centralized in rule engine or shared module"
    - id: "RCS-POS-002"
      signal: "Consistent rule behavior verified through integration tests"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify Rule Implementations"
      description: "Locate all business rule implementations in codebase"
      duration_estimate: "1 hour"
      tools:
        - name: "PMD CPD"
          action: "Run copy-paste detection on rule code"

    - id: "2"
      name: "Group Related Rules"
      description: "Identify rules that address the same business concept"
      duration_estimate: "1 hour"

    - id: "3"
      name: "Compare Implementations"
      description: "Analyze differences between related rule implementations"
      duration_estimate: "1-2 hours"

    - id: "4"
      name: "Verify Consistency"
      description: "Test that related rules produce consistent results"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Document Findings"
      description: "Compile inconsistency findings and recommendations"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of rule inconsistencies"

    - type: "duplication_report"
      format: "structured"
      description: "Report of duplicate rule implementations"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Consistency Analysis"
        - "Duplication Findings"
        - "Conflict Resolution"
        - "Recommendations"

closeout_checklist:
  - id: "rcs-001"
    item: "All rule implementations compared"
    level: "REQUIRED"
    verification: "manual"
  - id: "rcs-002"
    item: "Conflicts identified and documented"
    level: "REQUIRED"
    verification: "manual"
  - id: "rcs-003"
    item: "Duplication report generated"
    level: "WARNING"
    verification: "automated"

governance:
  applicable_to:
    archetypes: ["enterprise-applications", "fintech", "e-commerce"]

  compliance_mappings:
    - framework: "SOX"
      control: "ITGCs"
      description: "Consistent business rule enforcement"

relationships:
  commonly_combined:
    - "business-logic-domain.business-rules.rule-completeness"
    - "code-quality.code-duplication"
  depends_on:
    - "requirements-specification.business-requirements"
  feeds_into:
    - "code-quality.maintainability"
