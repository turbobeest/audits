# ============================================================
# AUDIT: Multi-Tenant Isolation
# Category: 34 - Business Logic & Domain
# Subcategory: authorization-logic
# ============================================================

audit:
  id: "business-logic-domain.authorization-logic.multi-tenant-isolation"
  name: "Multi-Tenant Isolation Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "authorization-logic"

  tier: "expert"
  estimated_duration: "6-10 hours"  # median: 8h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates tenant isolation in multi-tenant systems. This audit examines
    data isolation, query scoping, tenant context handling, cross-tenant
    operations, and isolation testing. It ensures tenants cannot access,
    view, or modify other tenants' data under any circumstances.

  why_it_matters: |
    Multi-tenant isolation failures are catastrophic. Data leakage between
    tenants destroys trust, causes compliance violations, and can end
    businesses. Perfect tenant isolation is non-negotiable for SaaS and
    shared-infrastructure platforms.

  when_to_run:
    - "During security architecture reviews"
    - "Before onboarding new tenants"
    - "After tenant isolation incidents"
    - "During compliance audits"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Tenant isolation implementation"
    - type: "data_model"
      description: "Multi-tenant data model"
    - type: "test_environment"
      description: "Multi-tenant test setup"

  access_requirements:
    - "Read access to tenant isolation code"
    - "Access to multiple test tenants"
    - "Database access for isolation verification"

discovery:
  file_patterns:
    - glob: "**/*Tenant*.{ts,java,cs,py}"
      purpose: "Find tenant handling code"
    - glob: "**/middleware/**/*.{ts,java,cs,py}"
      purpose: "Find tenant context middleware"
    - glob: "**/repositories/**/*.{ts,java,cs,py}"
      purpose: "Find data access with tenant scoping"
    - glob: "**/filters/**/*.{ts,java,cs,py}"
      purpose: "Find tenant query filters"

  interview_questions:
    - role: "Architect"
      questions:
        - "What is the multi-tenancy architecture?"
        - "How is tenant isolation enforced?"
        - "Have there been cross-tenant issues?"
    - role: "Database Administrator"
      questions:
        - "Is there database-level isolation?"
        - "How are tenant queries scoped?"
        - "Can you query across tenants?"

knowledge_sources:
  guides:
    - id: "multi-tenancy-patterns"
      name: "Multi-Tenancy Patterns"
      url: "https://docs.microsoft.com/en-us/azure/architecture/isv/application-tenancy"
    - id: "saas-isolation"
      name: "SaaS Tenant Isolation"
      url: "https://d1.awsstatic.com/whitepapers/Multi_Tenant_SaaS_Storage_Strategies.pdf"

  standards:
    - id: "soc2-isolation"
      name: "SOC 2 Isolation Requirements"
      relevance: "Multi-tenant security requirements"

tooling:
  analysis_tools:
    - tool: "Custom isolation tests"
      purpose: "Test cross-tenant access"
    - tool: "Database query analysis"
      purpose: "Verify tenant scoping in queries"
    - tool: "Row Level Security"
      purpose: "Database-level isolation"

signals:
  critical:
    - id: "MTI-CRIT-001"
      signal: "Cross-tenant data access possible"
      evidence_indicators:
        - "Tenant A can see Tenant B's data"
        - "Queries not scoped to tenant"
        - "Tenant context not enforced"
      explanation: |
        Cross-tenant data leakage is the worst-case scenario for SaaS
        applications. It causes immediate loss of customer trust and
        potential legal liability.
      remediation: "Enforce tenant scoping at all data access points; add defense in depth"

    - id: "MTI-CRIT-002"
      signal: "Tenant context can be spoofed"
      evidence_indicators:
        - "Tenant ID from client-controlled input"
        - "Tenant switching without validation"
        - "JWT tenant claim not verified"
      explanation: |
        If attackers can control tenant context, they can access any
        tenant's data by simply specifying a different tenant ID.
      remediation: "Derive tenant from authenticated identity; never trust client tenant claims"

  high:
    - id: "MTI-HIGH-001"
      signal: "No defense-in-depth for isolation"
      evidence_indicators:
        - "Single layer of isolation"
        - "Application-only isolation without DB support"
        - "No isolation verification"
      remediation: "Implement multiple isolation layers; use row-level security"

    - id: "MTI-HIGH-002"
      signal: "Shared resources leak tenant information"
      evidence_indicators:
        - "Cache keys not tenant-scoped"
        - "Shared file storage without isolation"
        - "Background jobs process wrong tenant"
      remediation: "Ensure all shared resources are tenant-scoped"

  medium:
    - id: "MTI-MED-001"
      signal: "Tenant isolation not tested automatically"
      evidence_indicators:
        - "No automated cross-tenant tests"
        - "Manual isolation verification"
        - "Isolation testing gaps"
      remediation: "Implement automated tenant isolation test suite"

    - id: "MTI-MED-002"
      signal: "Admin operations can affect wrong tenant"
      evidence_indicators:
        - "Admin actions not tenant-scoped"
        - "Super-admin can access all tenants without audit"
        - "Bulk operations cross tenant boundaries"
      remediation: "Scope admin operations; audit cross-tenant access"

  low:
    - id: "MTI-LOW-001"
      signal: "Tenant isolation not documented"
      evidence_indicators:
        - "No documentation of isolation architecture"
        - "Isolation approach only in code"
      remediation: "Document tenant isolation architecture and verification"

  positive:
    - id: "MTI-POS-001"
      signal: "Database-level row security enforced"
    - id: "MTI-POS-002"
      signal: "Comprehensive automated isolation testing"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Understand Tenant Architecture"
      description: "Document multi-tenancy implementation"
      duration_estimate: "1-2 hours"

    - id: "2"
      name: "Review Isolation Enforcement"
      description: "Analyze tenant scoping in code"
      duration_estimate: "2 hours"

    - id: "3"
      name: "Test Cross-Tenant Access"
      description: "Attempt to access other tenants' data"
      duration_estimate: "2-3 hours"

    - id: "4"
      name: "Verify Database Isolation"
      description: "Check database-level tenant scoping"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Review Shared Resources"
      description: "Check isolation in caches, queues, storage"
      duration_estimate: "1 hour"

    - id: "6"
      name: "Document Findings"
      description: "Compile tenant isolation findings"
      duration_estimate: "1 hour"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of isolation issues"

    - type: "isolation_matrix"
      format: "structured"
      description: "Tenant isolation matrix by component"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Architecture Overview"
        - "Isolation Analysis"
        - "Cross-Tenant Testing"
        - "Recommendations"

closeout_checklist:
  - id: "mti-001"
    item: "Tenant architecture documented"
    level: "REQUIRED"
    verification: "manual"
  - id: "mti-002"
    item: "Cross-tenant testing completed"
    level: "REQUIRED"
    verification: "manual"
  - id: "mti-003"
    item: "Database isolation verified"
    level: "WARNING"
    verification: "automated"

governance:
  applicable_to:
    archetypes: ["saas", "multi-tenant-platforms", "enterprise-saas"]

  compliance_mappings:
    - framework: "SOC 2"
      control: "CC6.1"
      description: "Logical and physical access controls"
    - framework: "GDPR"
      control: "Data Segregation"
      description: "Data controller separation"

relationships:
  commonly_combined:
    - "business-logic-domain.authorization-logic.permission-enforcement"
    - "security.data-isolation"
  depends_on:
    - "architecture-design.multi-tenancy-architecture"
  feeds_into:
    - "compliance-legal.tenant-compliance"
