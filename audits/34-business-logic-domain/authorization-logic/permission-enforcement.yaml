# ============================================================
# AUDIT: Permission Enforcement
# Category: 34 - Business Logic & Domain
# Subcategory: authorization-logic
# ============================================================

audit:
  id: "business-logic-domain.authorization-logic.permission-enforcement"
  name: "Permission Enforcement Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "authorization-logic"

  tier: "expert"
  estimated_duration: "4-8 hours"  # median: 6h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates how permissions are enforced throughout the application. This audit
    examines permission checks at API endpoints, service methods, data access
    layers, and UI components. It ensures permissions are consistently enforced
    at all entry points and cannot be bypassed.

  why_it_matters: |
    Permissions that are defined but not enforced provide no security. Inconsistent
    enforcement creates vulnerabilities where attackers can find unprotected paths.
    Complete, consistent permission enforcement is essential for application security.

  when_to_run:
    - "During security testing"
    - "After adding new endpoints or features"
    - "Before security audits"
    - "After authorization-related bugs"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Authorization enforcement code"
    - type: "api_endpoints"
      description: "API endpoint inventory"
    - type: "permission_definitions"
      description: "Permission requirements"

  access_requirements:
    - "Read access to all application code"
    - "Access to API documentation"
    - "Test environment access"

discovery:
  file_patterns:
    - glob: "**/controllers/**/*.{ts,java,cs,py}"
      purpose: "Find controller code with auth checks"
    - glob: "**/*authorize*/**/*.{ts,java,cs,py}"
      purpose: "Find authorization decorators/attributes"
    - glob: "**/guards/**/*.{ts,java,cs,py}"
      purpose: "Find authorization guards"
    - glob: "**/policies/**/*.{ts,java,cs,py}"
      purpose: "Find policy implementations"

  interview_questions:
    - role: "Security Engineer"
      questions:
        - "How are permissions enforced?"
        - "What is the authorization architecture?"
        - "How do you ensure all endpoints are protected?"
    - role: "Lead Developer"
      questions:
        - "Are there default-deny or default-allow policies?"
        - "How do you test permission enforcement?"
        - "Have there been authorization bypass issues?"

knowledge_sources:
  guides:
    - id: "owasp-access-control"
      name: "OWASP Access Control Cheat Sheet"
      url: "https://cheatsheetseries.owasp.org/cheatsheets/Access_Control_Cheat_Sheet.html"
    - id: "authorization-patterns"
      name: "Authorization Patterns"
      url: "https://www.osohq.com/learn/authorization-patterns"

  standards:
    - id: "owasp-asvs"
      name: "OWASP ASVS"
      relevance: "Access control verification requirements"

tooling:
  analysis_tools:
    - tool: "OWASP ZAP"
      purpose: "Test authorization bypass"
    - tool: "Burp Suite"
      purpose: "Authorization testing"
    - tool: "AuthMatrix"
      purpose: "Burp extension for auth testing"
    - tool: "Custom scripts"
      purpose: "Endpoint permission mapping"

signals:
  critical:
    - id: "PEN-CRIT-001"
      signal: "Endpoints without permission checks"
      evidence_indicators:
        - "API endpoints with no auth decorators"
        - "Missing authorization middleware"
        - "Direct access to protected resources"
      explanation: |
        Unprotected endpoints allow unauthorized access to sensitive
        functionality and data. Every endpoint must explicitly check
        permissions.
      remediation: "Add permission checks to all endpoints; use default-deny"

    - id: "PEN-CRIT-002"
      signal: "Permission checks only at UI level"
      evidence_indicators:
        - "API accepts requests hidden from UI"
        - "Permission checks only in frontend"
        - "Backend accessible without auth"
      explanation: |
        UI-only permission checks are trivially bypassed by calling
        APIs directly. Enforcement must be at the server level.
      remediation: "Implement server-side permission checks for all operations"

  high:
    - id: "PEN-HIGH-001"
      signal: "Inconsistent permission enforcement across layers"
      evidence_indicators:
        - "Controller checks but service doesn't"
        - "Different permissions at different layers"
        - "Authorization logic duplicated inconsistently"
      remediation: "Centralize authorization; enforce at appropriate layer"

    - id: "PEN-HIGH-002"
      signal: "Permission bypass through parameter manipulation"
      evidence_indicators:
        - "Changing user ID in request accesses other users"
        - "Object-level authorization not checked"
        - "IDOR vulnerabilities"
      remediation: "Verify ownership/access for every object access"

  medium:
    - id: "PEN-MED-001"
      signal: "Insufficient logging of authorization decisions"
      evidence_indicators:
        - "Authorization failures not logged"
        - "Cannot audit access attempts"
        - "No visibility into auth decisions"
      remediation: "Log all authorization decisions with context"

    - id: "PEN-MED-002"
      signal: "Hardcoded permissions in code"
      evidence_indicators:
        - "Permission names scattered in code"
        - "Magic strings for permissions"
        - "Cannot easily change permissions"
      remediation: "Use constants/enums for permissions; centralize definitions"

  low:
    - id: "PEN-LOW-001"
      signal: "Permission check performance not optimized"
      evidence_indicators:
        - "Database query per permission check"
        - "No caching of permissions"
        - "Slow authorization affecting latency"
      remediation: "Cache permissions; optimize authorization lookup"

  positive:
    - id: "PEN-POS-001"
      signal: "Default-deny with explicit permission grants"
    - id: "PEN-POS-002"
      signal: "Consistent enforcement at service layer"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Endpoints"
      description: "Map all API endpoints and their permissions"
      duration_estimate: "1-2 hours"

    - id: "2"
      name: "Analyze Enforcement Points"
      description: "Review where permissions are checked"
      duration_estimate: "2 hours"

    - id: "3"
      name: "Test Bypass Scenarios"
      description: "Attempt to bypass permission checks"
      duration_estimate: "2 hours"
      tools:
        - name: "OWASP ZAP"
          action: "Run authorization bypass tests"

    - id: "4"
      name: "Review Logging"
      description: "Verify authorization logging"
      duration_estimate: "30 minutes"

    - id: "5"
      name: "Document Findings"
      description: "Compile permission enforcement findings"
      duration_estimate: "30 minutes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of enforcement issues"

    - type: "endpoint_matrix"
      format: "structured"
      description: "Endpoint permission enforcement matrix"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Endpoint Inventory"
        - "Enforcement Analysis"
        - "Bypass Testing Results"
        - "Recommendations"

closeout_checklist:
  - id: "pen-001"
    item: "All endpoints mapped with permissions"
    level: "REQUIRED"
    verification: "automated"
  - id: "pen-002"
    item: "Enforcement points verified"
    level: "REQUIRED"
    verification: "manual"
  - id: "pen-003"
    item: "Bypass testing completed"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["all-applications"]

  compliance_mappings:
    - framework: "OWASP ASVS"
      control: "V4 Access Control"
      description: "Access control verification"
    - framework: "PCI-DSS"
      control: "7.1"
      description: "Access control requirements"

relationships:
  commonly_combined:
    - "business-logic-domain.authorization-logic.role-based-access-design"
    - "security.api-security"
  depends_on:
    - "security.authentication"
  feeds_into:
    - "security.vulnerability-assessment"
