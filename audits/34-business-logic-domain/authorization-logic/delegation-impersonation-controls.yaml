# ============================================================
# AUDIT: Delegation Impersonation Controls
# Category: 34 - Business Logic & Domain
# Subcategory: authorization-logic
# ============================================================

audit:
  id: "business-logic-domain.authorization-logic.delegation-impersonation-controls"
  name: "Delegation Impersonation Controls Audit"
  version: "1.0.0"
  last_updated: "2025-01-22"
  status: "active"

  category: "business-logic-domain"
  category_number: 34
  subcategory: "authorization-logic"

  tier: "expert"
  estimated_duration: "4-6 hours"  # median: 5h

  completeness: "requires_discovery"
  requires_runtime: true
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "business-logic"

  default_profiles:
    - "full"
    - "quick"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates controls around delegation and impersonation features. This audit
    examines how users delegate authority to others, how admins impersonate
    users for support, and what restrictions and audit trails exist. It ensures
    delegation and impersonation cannot be abused.

  why_it_matters: |
    Delegation and impersonation features are powerful and risky. Without proper
    controls, they enable privilege escalation, unauthorized access, and audit
    trail pollution. Proper controls ensure these features support business
    needs without creating security holes.

  when_to_run:
    - "When implementing delegation features"
    - "After impersonation abuse incidents"
    - "During security reviews"
    - "Before compliance audits"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Delegation and impersonation code"
    - type: "authorization_config"
      description: "Delegation rules and limits"
    - type: "audit_logs"
      description: "Delegation and impersonation logs"

  access_requirements:
    - "Read access to delegation code"
    - "Access to impersonation configuration"
    - "Access to audit logs"

discovery:
  file_patterns:
    - glob: "**/*Delegation*.{ts,java,cs,py}"
      purpose: "Find delegation code"
    - glob: "**/*Impersonate*.{ts,java,cs,py}"
      purpose: "Find impersonation code"
    - glob: "**/*Proxy*.{ts,java,cs,py}"
      purpose: "Find proxy access code"
    - glob: "**/*ActAs*.{ts,java,cs,py}"
      purpose: "Find act-as functionality"

  interview_questions:
    - role: "Security Engineer"
      questions:
        - "What delegation/impersonation features exist?"
        - "How are these features controlled?"
        - "What audit trail exists?"
    - role: "Support Team"
      questions:
        - "How do you access user accounts for support?"
        - "What restrictions exist on impersonation?"
        - "How is impersonation tracked?"

knowledge_sources:
  guides:
    - id: "impersonation-security"
      name: "Impersonation Security Patterns"
      url: "https://www.owasp.org/index.php/Impersonation"
    - id: "delegation-patterns"
      name: "Delegation Authorization Patterns"
      url: "https://oauth.net/2/grant-types/"

  standards:
    - id: "oauth-delegation"
      name: "OAuth Token Delegation"
      relevance: "Delegation standards"

tooling:
  analysis_tools:
    - tool: "Audit log analyzers"
      purpose: "Analyze delegation/impersonation usage"
    - tool: "Security monitoring"
      purpose: "Alert on suspicious patterns"

signals:
  critical:
    - id: "DIC-CRIT-001"
      signal: "Impersonation without audit trail"
      evidence_indicators:
        - "Impersonated actions logged as original user"
        - "No record of who impersonated"
        - "Cannot distinguish real vs impersonated actions"
      explanation: |
        Without audit trails, impersonation abuse cannot be detected or
        investigated. This creates accountability gaps and compliance issues.
      remediation: "Log impersonation start/end; attribute actions to both users"

    - id: "DIC-CRIT-002"
      signal: "Unlimited delegation scope"
      evidence_indicators:
        - "Delegate can do anything delegator can"
        - "No permission restrictions on delegation"
        - "Delegation can be re-delegated indefinitely"
      explanation: |
        Unrestricted delegation allows privilege amplification and
        uncontrolled access propagation.
      remediation: "Limit delegatable permissions; restrict delegation depth"

  high:
    - id: "DIC-HIGH-001"
      signal: "No time limits on delegation"
      evidence_indicators:
        - "Delegations never expire"
        - "No periodic review required"
        - "Orphaned delegations from departed users"
      remediation: "Require expiration on delegations; periodic review"

    - id: "DIC-HIGH-002"
      signal: "Impersonation available to too many users"
      evidence_indicators:
        - "Many users can impersonate"
        - "No justification required"
        - "Impersonation for convenience not support"
      remediation: "Restrict impersonation to necessary roles; require justification"

  medium:
    - id: "DIC-MED-001"
      signal: "No notification to delegated user"
      evidence_indicators:
        - "User unaware of actions on their behalf"
        - "No email when delegation used"
        - "No visibility into delegate actions"
      remediation: "Notify users of delegate actions"

    - id: "DIC-MED-002"
      signal: "Delegation/impersonation patterns not monitored"
      evidence_indicators:
        - "No alerting on unusual patterns"
        - "No review of impersonation usage"
        - "Cannot detect abuse"
      remediation: "Monitor and alert on unusual delegation/impersonation patterns"

  low:
    - id: "DIC-LOW-001"
      signal: "Delegation UI confusing"
      evidence_indicators:
        - "Unclear what is being delegated"
        - "Easy to over-delegate"
      remediation: "Improve delegation UI clarity"

  positive:
    - id: "DIC-POS-001"
      signal: "Complete audit trail for delegation and impersonation"
    - id: "DIC-POS-002"
      signal: "Scoped, time-limited delegations"

procedure:
  context:
    cognitive_mode: "analytical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Inventory Delegation Features"
      description: "Document all delegation/impersonation capabilities"
      duration_estimate: "1 hour"

    - id: "2"
      name: "Review Control Configuration"
      description: "Analyze restrictions and limits"
      duration_estimate: "1-2 hours"

    - id: "3"
      name: "Verify Audit Trail"
      description: "Check logging of delegation actions"
      duration_estimate: "1 hour"

    - id: "4"
      name: "Test Abuse Scenarios"
      description: "Attempt to abuse delegation features"
      duration_estimate: "1 hour"

    - id: "5"
      name: "Document Findings"
      description: "Compile delegation control findings"
      duration_estimate: "30 minutes"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      description: "List of delegation control issues"

    - type: "feature_inventory"
      format: "structured"
      description: "Inventory of delegation/impersonation features"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Feature Inventory"
        - "Control Analysis"
        - "Audit Trail Review"
        - "Recommendations"

closeout_checklist:
  - id: "dic-001"
    item: "Delegation features inventoried"
    level: "REQUIRED"
    verification: "manual"
  - id: "dic-002"
    item: "Audit trail verified"
    level: "REQUIRED"
    verification: "manual"
  - id: "dic-003"
    item: "Abuse scenarios tested"
    level: "WARNING"
    verification: "manual"

governance:
  applicable_to:
    archetypes: ["enterprise-applications", "support-systems", "multi-user-platforms"]

  compliance_mappings:
    - framework: "SOX"
      control: "Access Controls"
      description: "Delegation and impersonation controls"
    - framework: "SOC 2"
      control: "CC6.1"
      description: "Logical access controls"

relationships:
  commonly_combined:
    - "business-logic-domain.authorization-logic.role-based-access-design"
    - "security.audit-logging"
  depends_on:
    - "security.authentication"
  feeds_into:
    - "compliance-legal.access-controls"
