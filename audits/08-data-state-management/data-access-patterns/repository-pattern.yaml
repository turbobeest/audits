# ============================================================
# AUDIT: Repository Pattern
# ============================================================

audit:
  id: "data-state-management.data-access-patterns.repository-pattern"
  name: "Repository Pattern Audit"
  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "data-state-management"
  category_number: 8
  subcategory: "data-access-patterns"

  tier: "expert"
  estimated_duration: "90 minutes"

  completeness: "complete"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "high"
  scope: "codebase"

  default_profiles:
    - "full"
    - "architecture"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    Evaluates the implementation of the Repository pattern for data access,
    examining abstraction quality, interface design, separation of concerns,
    and testability. Analyzes whether repositories properly encapsulate
    data access logic and provide clean domain-oriented interfaces.

  why_it_matters: |
    The Repository pattern mediates between domain and data mapping layers,
    providing a collection-like interface for accessing domain objects.
    Poor implementation leads to leaked abstractions, untestable code,
    and tight coupling between domain logic and persistence details.

  when_to_run:
    - "Architecture reviews"
    - "Code quality audits"
    - "Before major refactoring"
    - "Testing strategy reviews"

prerequisites:
  required_artifacts:
    - type: "source_code"
      description: "Application source code including data access layer"

  access_requirements:
    - "Read access to application source code"

discovery:
  code_patterns:
    - pattern: "Repository|Repo|DataAccess|DAO"
      type: "regex"
      scope: "source"
      purpose: "Detect repository implementations"

    - pattern: "interface.*Repository|Repository.*interface"
      type: "regex"
      scope: "source"
      purpose: "Detect repository interfaces"

    - pattern: "findBy|getBy|save|delete|update"
      type: "regex"
      scope: "source"
      purpose: "Detect repository methods"

  file_patterns:
    - glob: "**/repositories/**"
      purpose: "Repository implementations"
    - glob: "**/repos/**"
      purpose: "Repository modules"
    - glob: "**/data/**"
      purpose: "Data access layer"

knowledge_sources:
  learning_resources:
    - id: "poea"
      title: "Patterns of Enterprise Application Architecture"
      type: "book"
      reference: "Martin Fowler, ISBN: 978-0321127426"

    - id: "ddd-blue"
      title: "Domain-Driven Design"
      type: "book"
      reference: "Eric Evans, ISBN: 978-0321125217"

  guides:
    - id: "repository-pattern"
      name: "Repository Pattern"
      url: "https://martinfowler.com/eaaCatalog/repository.html"
      offline_cache: true

tooling:
  static_analysis:
    - tool: "custom-pattern-analyzer"
      purpose: "Detect repository pattern implementation"
      offline_capable: true

  scripts:
    - id: "repository-scan"
      language: "bash"
      purpose: "Analyze repository pattern implementation"
      source: "inline"
      code: |
        echo "=== Repository Pattern Analysis ==="
        echo "--- Repository files ---"
        find . -type f \( -name "*Repository*" -o -name "*Repo*" \) \
          -not -path "*/node_modules/*" 2>/dev/null | head -30

        echo "--- Repository interfaces ---"
        grep -rn "interface.*Repository\|Repository.*interface" \
          --include="*.ts" --include="*.java" --include="*.cs" . 2>/dev/null | head -20

        echo "--- Repository methods ---"
        grep -rn "findBy\|getBy\|findAll\|save\|create\|update\|delete" \
          --include="*.ts" --include="*.java" --include="*.py" . 2>/dev/null | \
          grep -i "repo" | head -30

signals:
  critical:
    - id: "RP-CRIT-001"
      signal: "Data access logic scattered throughout codebase"
      evidence_pattern: "SQL/ORM queries in controllers, services, and handlers"
      explanation: |
        When data access is scattered, the same query may be implemented
        multiple times with subtle differences. Changes to data structure
        require hunting through the entire codebase. Repositories centralize
        this logic.
      remediation: "Extract all data access to repository classes"

    - id: "RP-CRIT-002"
      signal: "No abstraction between domain and persistence"
      evidence_pattern: "Domain entities directly coupled to ORM annotations"
      explanation: |
        Without repository abstraction, domain logic becomes tightly coupled
        to persistence technology. Switching databases or ORMs requires
        rewriting domain code. Testing requires database instances.
      remediation: "Create repository interfaces consumed by domain; implement with ORM"

  high:
    - id: "RP-HIGH-001"
      signal: "Repository leaks persistence details"
      evidence_pattern: "Repository returns QueryBuilder or database-specific types"
      explanation: |
        Repositories should return domain objects, not ORM entities or query
        builders. Leaked persistence details force callers to understand
        the underlying technology.
      remediation: "Return domain objects from repositories; map internally"

    - id: "RP-HIGH-002"
      signal: "Business logic in repository methods"
      evidence_pattern: "Repository contains conditional logic beyond data access"
      explanation: |
        Repositories should contain only data access logic. Business rules
        in repositories cannot be tested without database and violate
        single responsibility.
      remediation: "Move business logic to domain services or entities"

    - id: "RP-HIGH-003"
      signal: "No repository interface (only concrete implementation)"
      evidence_pattern: "Services depend on concrete repository classes"
      explanation: |
        Without interfaces, repositories cannot be mocked for testing.
        Services become untestable without database, and alternative
        implementations cannot be substituted.
      remediation: "Define repository interface; depend on interface, not implementation"

  medium:
    - id: "RP-MED-001"
      signal: "Generic repository used for all entities"
      evidence_pattern: "Repository<T> with no entity-specific methods"
      remediation: "Create entity-specific repositories with domain-meaningful methods"

    - id: "RP-MED-002"
      signal: "Repository methods return persistence entities"
      evidence_pattern: "Returning JPA entities instead of domain objects"
      remediation: "Map persistence entities to domain objects in repository"

    - id: "RP-MED-003"
      signal: "Inconsistent repository naming conventions"
      evidence_pattern: "UserRepository, ProductRepo, OrderDAO mixed"
      remediation: "Standardize repository naming convention"

  low:
    - id: "RP-LOW-001"
      signal: "Missing repository documentation"
      evidence_pattern: "No documentation of repository method contracts"
      remediation: "Document expected behavior, null handling, ordering"

    - id: "RP-LOW-002"
      signal: "Repository methods not tested"
      evidence_pattern: "No integration tests for repository methods"
      remediation: "Add integration tests for repository implementations"

  positive:
    - id: "RP-POS-001"
      signal: "Clean repository interfaces with domain language"
      evidence_pattern: "Methods like findActiveUsersInRegion() not findByStatusAndRegion()"

    - id: "RP-POS-002"
      signal: "Repositories return domain objects"
      evidence_pattern: "Clear mapping from persistence to domain"

    - id: "RP-POS-003"
      signal: "Dependency injection of repository interfaces"
      evidence_pattern: "Services receive interface, not concrete class"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Identify Repository Implementations"
      description: |
        Find all repository classes and interfaces.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find repository files"
          command: |
            find . -type f \( -name "*Repository*" -o -name "*Repo*" -o -name "*DAO*" \) \
              -not -path "*/node_modules/*" -not -path "*/.git/*" 2>/dev/null
        - purpose: "Find repository patterns in code"
          command: |
            grep -rn "class.*Repository\|interface.*Repository" \
              --include="*.ts" --include="*.java" --include="*.py" --include="*.cs" . 2>/dev/null | \
              grep -v node_modules | head -30

      expected_findings:
        - "Repository inventory"
        - "Interface vs implementation ratio"

    - id: "2"
      name: "Analyze Repository Interfaces"
      description: |
        Review repository interface design.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find repository methods"
          command: |
            grep -rn "async\|function\|def\|public.*(" \
              --include="*Repository*" --include="*Repo*" . 2>/dev/null | \
              grep -v node_modules | head -40

      expected_findings:
        - "Interface quality assessment"
        - "Method naming patterns"

    - id: "3"
      name: "Check for Leaked Abstractions"
      description: |
        Verify repositories don't leak persistence details.
      duration_estimate: "20 min"
      commands:
        - purpose: "Find ORM leakage"
          command: |
            grep -rn "QueryBuilder\|EntityManager\|Session\|Connection" \
              --include="*.ts" --include="*.java" . 2>/dev/null | \
              grep -v "Repository\|repo" | grep -v node_modules | head -30

      expected_findings:
        - "Abstraction leakage instances"
        - "Return type analysis"

    - id: "4"
      name: "Review Data Access Distribution"
      description: |
        Check if data access is properly centralized.
      duration_estimate: "25 min"
      commands:
        - purpose: "Find data access outside repositories"
          command: |
            grep -rn "\.find(\|\.findOne(\|\.query(\|\.execute(" \
              --include="*.ts" --include="*.java" --include="*.py" . 2>/dev/null | \
              grep -v "Repository\|repo\|Repo" | grep -v node_modules | grep -v test | head -30

      expected_findings:
        - "Scattered data access"
        - "Centralization status"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"
      content:
        - "repository_inventory"
        - "abstraction_issues"
        - "distribution_analysis"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Repository Inventory"
        - "Interface Quality"
        - "Abstraction Assessment"
        - "Recommendations"

  confidence_guidance:
    high: "Clear violation of repository pattern principles"
    medium: "Pattern implemented but with some leakage"
    low: "Framework patterns may differ from classical repository"

offline:
  capability: "full"

  cache_manifest:
    knowledge:
      - source_id: "poea"
        priority: "required"
      - source_id: "repository-pattern"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires architectural analysis"
    full:
      included: true
      priority: 1
    architecture:
      included: true
      priority: 1

closeout_checklist:
  - id: "rp-001"
    item: "Repository interfaces defined"
    level: "CRITICAL"
    verification: |
      grep -rn "interface.*Repository" --include="*.ts" --include="*.java" . 2>/dev/null | \
        wc -l | xargs -I {} test {} -gt 0 && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "rp-002"
    item: "Data access centralized in repositories"
    level: "BLOCKING"
    verification: |
      grep -rn "\.find(\|\.query(" --include="*.ts" --include="*.java" . 2>/dev/null | \
        grep -v "Repository\|repo" | grep -v node_modules | grep -v test | wc -l | \
        xargs -I {} test {} -lt 10 && echo "PASS" || echo "FAIL"
    expected: "PASS"

  - id: "rp-003"
    item: "Repositories return domain objects"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Review repository return types for domain vs persistence entities"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "ISO 25010"
      controls: ["Maintainability", "Testability"]

relationships:
  commonly_combined:
    - "data-state-management.data-access-patterns.orm-usage"
    - "architecture-design.design-principles.dependency-inversion"
    - "code-quality.testability.unit-test-coverage"
