# ============================================================
# AUDIT: Data Retention Policy
# ============================================================
# Evaluates data retention policies including definition, enforcement,
# compliance alignment, and implementation correctness.
# ============================================================

audit:
  id: "data-state-management.data-lifecycle.data-retention-policy"

  name: "Data Retention Policy"

  version: "1.0.0"
  last_updated: "2026-01-18"
  status: "active"

  category: "data-state-management"
  category_number: 8
  subcategory: "data-lifecycle"

  tier: "expert"
  estimated_duration: "2 hours"

  completeness: "requires_discovery"
  requires_runtime: false
  destructive: false

execution:
  automatable: "partial"
  severity: "critical"
  scope: "data"

  default_profiles:
    - "full"
    - "security"
    - "production"

  blocks_phase: false
  parallelizable: true

description:
  what: |
    This audit evaluates data retention policies to ensure they are properly
    defined, documented, and enforced. It examines retention period definitions
    for different data types, automated enforcement mechanisms, compliance
    alignment, and the ability to demonstrate retention compliance.

  why_it_matters: |
    Data retention policies are critical for regulatory compliance (GDPR, CCPA,
    HIPAA), cost management, and risk mitigation. Retaining data too long
    increases breach exposure and storage costs. Deleting data too soon
    violates legal holds or business requirements. Proper retention policies
    balance these concerns with automated enforcement.

  when_to_run:
    - "During compliance audits"
    - "When defining new data types"
    - "After regulatory changes"
    - "Before entering new markets with different requirements"

prerequisites:
  required_artifacts:
    - type: "retention-policy-doc"
      description: "Data retention policy documentation"
    - type: "data-catalog"
      description: "Inventory of data types and their classifications"

  access_requirements:
    - "Access to retention policy documentation"
    - "Access to data deletion/archival jobs"
    - "Compliance team access for policy verification"

discovery:
  code_patterns:
    - pattern: "retention|ttl|expire|purge|cleanup"
      type: "regex"
      scope: "source"
      purpose: "Identify retention-related code"
    - pattern: "DELETE.*WHERE.*created_at|DELETE.*WHERE.*date"
      type: "regex"
      scope: "source"
      purpose: "Identify time-based deletion"
    - pattern: "@Scheduled|cron|setInterval"
      type: "regex"
      scope: "source"
      purpose: "Identify scheduled retention jobs"

  file_patterns:
    - glob: "**/retention/**/*"
      purpose: "Retention policy implementation"
    - glob: "**/cleanup/**/*"
      purpose: "Data cleanup scripts"
    - glob: "**/policies/**/*.md"
      purpose: "Policy documentation"

  documents_to_review:
    - type: "Data Retention Policy"
      purpose: "Verify documented retention periods for data types"
    - type: "Compliance Documentation"
      purpose: "Verify alignment with regulatory requirements"

knowledge_sources:
  specifications:
    - id: "gdpr-retention"
      name: "GDPR Data Retention Requirements"
      url: "https://gdpr.eu/article-5-how-long-can-personal-data-be-kept/"
      offline_cache: true
      priority: "required"

    - id: "ccpa-retention"
      name: "CCPA Data Retention"
      url: "https://oag.ca.gov/privacy/ccpa"
      offline_cache: true
      priority: "recommended"

  guides:
    - id: "retention-best-practices"
      name: "Data Retention Best Practices"
      url: "https://www.varonis.com/blog/data-retention-policy"
      offline_cache: true

tooling:
  infrastructure_tools:
    - tool: "database-scheduler"
      purpose: "Schedule retention enforcement jobs"
      command: "crontab -l | grep -i retention"

signals:
  critical:
    - id: "RETAIN-CRIT-001"
      signal: "No documented retention policy for personal data"
      evidence_indicators:
        - "Missing retention periods in data classification"
        - "No policy document for PII retention"
      explanation: |
        Without documented retention policies for personal data, the
        organization cannot demonstrate GDPR/CCPA compliance. Regulators
        require documented justification for retention periods.
      remediation: "Define and document retention periods for all personal data categories"

    - id: "RETAIN-CRIT-002"
      signal: "Retention policy exists but not enforced"
      evidence_pattern: "Documented policy but no automated deletion/archival"
      explanation: |
        A policy without enforcement is mere documentation. Data continues
        accumulating indefinitely, increasing breach risk and potentially
        violating user rights to data deletion.
      remediation: "Implement automated retention enforcement with scheduled deletion/archival jobs"

  high:
    - id: "RETAIN-HIGH-001"
      signal: "Inconsistent retention periods for same data type"
      evidence_indicators:
        - "Different retention periods in code vs documentation"
        - "Multiple systems with different retention for same data"
      explanation: |
        Inconsistent retention creates compliance gaps where some copies
        of data persist longer than allowed. Users may believe data is
        deleted when copies remain elsewhere.
      remediation: "Standardize retention periods across all systems; implement central policy management"

    - id: "RETAIN-HIGH-002"
      signal: "No retention policy for derived data or backups"
      evidence_pattern: "Retention defined for primary data but not backups, analytics, logs"
      explanation: |
        Derived data and backups often contain personal information but
        may be overlooked in retention policies. These copies persist
        indefinitely, violating retention requirements.
      remediation: "Extend retention policies to all data copies including backups, logs, and analytics"

  medium:
    - id: "RETAIN-MED-001"
      signal: "Retention jobs without monitoring or alerting"
      evidence_pattern: "Scheduled jobs without failure notifications"
      remediation: "Add monitoring and alerting for retention enforcement jobs"

    - id: "RETAIN-MED-002"
      signal: "No audit trail for retention enforcement"
      evidence_pattern: "Missing logs of what data was deleted and when"
      remediation: "Log all retention enforcement actions for compliance audit trail"

  low:
    - id: "RETAIN-LOW-001"
      signal: "Manual retention enforcement requiring human intervention"

  positive:
    - id: "RETAIN-POS-001"
      signal: "Comprehensive retention policy with automated enforcement"
    - id: "RETAIN-POS-002"
      signal: "Clear retention audit trail with compliance reporting"

procedure:
  context:
    cognitive_mode: "critical"
    ensemble_role: "auditor"

  steps:
    - id: "1"
      name: "Policy Documentation Review"
      description: |
        Review data retention policy documentation for completeness
        and regulatory alignment.
      duration_estimate: "30 min"

      commands:
        - purpose: "Find retention policy documents"
          command: "find . -name '*.md' -o -name '*.pdf' 2>/dev/null | xargs grep -l -iE 'retention|data.*policy' 2>/dev/null | head -20"
        - purpose: "Find retention-related code comments"
          command: "grep -riE 'retention|TTL|expire.*day|days.*old' --include='*.ts' --include='*.py' --include='*.java' --include='*.sql' . 2>/dev/null | head -30"

      expected_findings:
        - "Policy documentation location"
        - "Documented retention periods"

    - id: "2"
      name: "Enforcement Mechanism Analysis"
      description: |
        Identify and evaluate automated enforcement mechanisms
        for retention policies.
      duration_estimate: "30 min"

      commands:
        - purpose: "Find scheduled cleanup jobs"
          command: "grep -riE '@Scheduled|cron|schedule|purge|cleanup|retention' --include='*.ts' --include='*.py' --include='*.java' --include='*.yml' . 2>/dev/null | head -40"
        - purpose: "Find time-based deletion queries"
          command: "grep -riE 'DELETE.*WHERE.*(created|updated|date).*<|TRUNCATE PARTITION' --include='*.sql' --include='*.ts' --include='*.py' . 2>/dev/null | head -30"
        - purpose: "Find TTL configurations"
          command: "grep -riE 'TTL|expir|maxAge|retention' --include='*.yml' --include='*.yaml' --include='*.json' --include='*.conf' . 2>/dev/null | head -30"

      expected_findings:
        - "Retention enforcement jobs"
        - "TTL configurations"

    - id: "3"
      name: "Coverage Analysis"
      description: |
        Verify retention policies cover all data types including
        backups, logs, and derived data.
      duration_estimate: "30 min"

      commands:
        - purpose: "Find backup retention settings"
          command: "grep -riE 'backup.*retention|retain.*backup|backup.*days' --include='*.yml' --include='*.yaml' --include='*.tf' --include='*.json' . 2>/dev/null | head -20"
        - purpose: "Find log retention settings"
          command: "grep -riE 'log.*retention|cloudwatch.*retention|days.*log' --include='*.yml' --include='*.yaml' --include='*.tf' . 2>/dev/null | head -20"
        - purpose: "Find analytics data retention"
          command: "grep -riE 'analytics.*retention|event.*ttl|metrics.*retention' --include='*.yml' --include='*.yaml' . 2>/dev/null | head -20"

      expected_findings:
        - "Backup retention coverage"
        - "Log retention coverage"
        - "Analytics retention coverage"

    - id: "4"
      name: "Audit Trail Analysis"
      description: |
        Verify retention enforcement creates an audit trail
        for compliance demonstration.
      duration_estimate: "20 min"

      commands:
        - purpose: "Find retention logging"
          command: "grep -riE 'log.*delet|audit.*retention|retention.*log' --include='*.ts' --include='*.py' --include='*.java' . 2>/dev/null | head -20"

      expected_findings:
        - "Audit trail mechanisms"
        - "Compliance reporting capability"

output:
  deliverables:
    - type: "finding_list"
      format: "structured"

    - type: "summary"
      format: "prose"
      sections:
        - "Executive Summary"
        - "Policy Assessment"
        - "Enforcement Analysis"
        - "Coverage Gaps"
        - "Compliance Recommendations"

  confidence_guidance:
    high: "Clear evidence of missing policy or enforcement"
    medium: "Policy exists but enforcement uncertain"
    low: "Policy and enforcement appear adequate but verification needed"

offline:
  capability: "partial"

  cache_manifest:
    knowledge:
      - source_id: "gdpr-retention"
        priority: "required"

profiles:
  membership:
    quick:
      included: false
      reason: "Requires comprehensive policy and enforcement review"
    full:
      included: true
      priority: 1

closeout_checklist:
  - id: "retain-001"
    item: "Retention policy documented for all data types"
    level: "CRITICAL"
    verification: "manual"
    verification_notes: "Reviewer should verify documented retention for all data categories"
    expected: "Confirmed by reviewer"

  - id: "retain-002"
    item: "Automated enforcement mechanisms exist"
    level: "BLOCKING"
    verification: "grep -riE '@Scheduled|cron|cleanup|purge' --include='*.ts' --include='*.py' --include='*.java' . 2>/dev/null | wc -l | xargs -I{} test {} -gt 0 && echo PASS || echo FAIL"
    expected: "PASS"

  - id: "retain-003"
    item: "Retention covers backups and derived data"
    level: "WARNING"
    verification: "manual"
    verification_notes: "Reviewer should verify backup and log retention is defined"
    expected: "Confirmed by reviewer"

governance:
  applicable_to:
    archetypes: ["all"]

  compliance_frameworks:
    - framework: "GDPR"
      controls: ["Art-5", "Art-17"]
    - framework: "CCPA"
      controls: ["1798.105"]

relationships:
  commonly_combined:
    - "data-state-management.data-lifecycle.data-deletion-implementation"
    - "data-state-management.data-lifecycle.archival-strategy"
